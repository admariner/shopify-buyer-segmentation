2018-04-17 13:42:32,897: Tracking: tracking
2018-04-17 13:42:32,904: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106a97f60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106a97fd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106a97e48>]}
2018-04-17 13:42:33,708: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-04-17 13:42:33,730: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/growth-engines/dbt_modules
2018-04-17 13:42:33,736: Parsing get_column_values.sql
2018-04-17 13:42:33,757: Parsing get_url_parameter.sql
2018-04-17 13:42:33,764: Parsing split_part.sql
2018-04-17 13:42:33,772: Parsing table_exists.sql
2018-04-17 13:42:33,783: Parsing core.sql
2018-04-17 13:42:33,798: Parsing adapters/bigquery.sql
2018-04-17 13:42:33,806: Parsing adapters/common.sql
2018-04-17 13:42:33,825: Parsing adapters/postgres.sql
2018-04-17 13:42:33,832: Parsing adapters/redshift.sql
2018-04-17 13:42:33,854: Parsing etc/get_custom_schema.sql
2018-04-17 13:42:33,861: Parsing materializations/archive.sql
2018-04-17 13:42:33,912: Parsing materializations/bigquery.sql
2018-04-17 13:42:33,946: Parsing materializations/helpers.sql
2018-04-17 13:42:33,973: Parsing materializations/incremental.sql
2018-04-17 13:42:34,038: Parsing materializations/table.sql
2018-04-17 13:42:34,094: Parsing materializations/view.sql
2018-04-17 13:42:34,119: Parsing materializations/wrapper.sql
2018-04-17 13:42:34,129: Parsing schema_tests/accepted_values.sql
2018-04-17 13:42:34,141: Parsing schema_tests/not_null.sql
2018-04-17 13:42:34,146: Parsing schema_tests/relationships.sql
2018-04-17 13:42:34,152: Parsing schema_tests/unique.sql
2018-04-17 13:42:34,249: Parsing model.agency_data_pipeline.accounts_proc
2018-04-17 13:42:34,251: Parsing model.agency_data_pipeline.all_dates
2018-04-17 13:42:34,252: Parsing model.agency_data_pipeline.carts_proc
2018-04-17 13:42:34,255: Parsing model.agency_data_pipeline.clients_proc
2018-04-17 13:42:34,258: Parsing model.agency_data_pipeline.conversion_goals_proc
2018-04-17 13:42:34,260: Parsing model.agency_data_pipeline.mappings_ga_proc
2018-04-17 13:42:34,262: Acquiring new bigquery connection "master".
2018-04-17 13:42:34,262: Opening a new connection (0 currently allocated)
2018-04-17 13:42:34,269: Parsing model.agency_data_pipeline.monthend_dates
2018-04-17 13:42:34,272: Parsing model.agency_data_pipeline.adwords_ads
2018-04-17 13:42:34,277: Parsing model.agency_data_pipeline.adwords_campaigns
2018-04-17 13:42:34,279: Parsing model.agency_data_pipeline.adwords_conversions
2018-04-17 13:42:34,281: Parsing model.agency_data_pipeline.adwords_impression_share
2018-04-17 13:42:34,284: Parsing model.agency_data_pipeline.adwords_join
2018-04-17 13:42:34,287: Parsing model.agency_data_pipeline.adwords_stats
2018-04-17 13:42:34,289: Parsing model.agency_data_pipeline.adwords_urls
2018-04-17 13:42:34,291: Parsing model.agency_data_pipeline.bing_ads_ads
2018-04-17 13:42:34,296: Parsing model.agency_data_pipeline.bing_ads_conversions
2018-04-17 13:42:34,298: Parsing model.agency_data_pipeline.bing_ads_impression_share
2018-04-17 13:42:34,301: Parsing model.agency_data_pipeline.bing_ads_stats
2018-04-17 13:42:34,306: Parsing model.agency_data_pipeline.fb_adcreative
2018-04-17 13:42:34,316: Parsing model.agency_data_pipeline.fb_ads
2018-04-17 13:42:34,326: Parsing model.agency_data_pipeline.fb_ads_insights
2018-04-17 13:42:34,333: Parsing model.agency_data_pipeline.fb_ads_insights_conversions
2018-04-17 13:42:34,390: Parsing model.agency_data_pipeline.fb_ads_stats
2018-04-17 13:42:34,396: Parsing model.agency_data_pipeline.ga_conversions
2018-04-17 13:42:34,401: Parsing model.agency_data_pipeline.ga_traffic
2018-04-17 13:42:34,438: Parsing model.agency_data_pipeline.ga_transactions
2018-04-17 13:42:34,502: Parsing model.agency_data_pipeline.ga_mcf_proc
2018-04-17 13:42:34,511: Parsing model.agency_data_pipeline.ga_mcf_stats
2018-04-17 13:42:34,521: Parsing model.agency_data_pipeline.shopify_customers_proc
2018-04-17 13:42:34,529: Parsing model.agency_data_pipeline.shopify_orders_proc
2018-04-17 13:42:34,538: Parsing model.agency_data_pipeline.shopify_products_proc
2018-04-17 13:42:34,544: Parsing model.agency_data_pipeline.shopify_refunds_proc
2018-04-17 13:42:34,553: Parsing model.agency_data_pipeline.agg_campaign
2018-04-17 13:42:34,558: Parsing model.agency_data_pipeline.agg_customers_union
2018-04-17 13:42:34,560: Parsing model.agency_data_pipeline.agg_ga_campaign
2018-04-17 13:42:34,563: Parsing model.agency_data_pipeline.agg_ga_campaign_by_type
2018-04-17 13:42:34,565: Parsing model.agency_data_pipeline.agg_ga_transaction
2018-04-17 13:42:34,568: Parsing model.agency_data_pipeline.agg_ga_transaction_order_number
2018-04-17 13:42:34,571: Parsing model.agency_data_pipeline.agg_orders_union
2018-04-17 13:42:34,573: Parsing model.agency_data_pipeline.agg_platform_monthly
2018-04-17 13:42:34,574: Parsing model.agency_data_pipeline.agg_platforms_client
2018-04-17 13:42:34,576: Parsing model.agency_data_pipeline.agg_platforms_union
2018-04-17 13:42:34,579: Parsing model.agency_data_pipeline.agg_products
2018-04-17 13:42:34,581: Parsing model.agency_data_pipeline.agg_transaction
2018-04-17 13:42:34,583: Parsing model.agency_data_pipeline.agg_transaction_daily
2018-04-17 13:42:34,585: Parsing model.agency_data_pipeline.agg_transaction_line_item
2018-04-17 13:42:34,587: Parsing model.agency_data_pipeline.agg_transaction_line_item_type
2018-04-17 13:42:34,589: Parsing model.agency_data_pipeline.agg_transaction_order_number
2018-04-17 13:42:34,591: Parsing model.agency_data_pipeline.agg_transaction_product_type
2018-04-17 13:42:34,592: Parsing model.agency_data_pipeline.customers_by_transaction
2018-04-17 13:42:34,595: Parsing model.agency_data_pipeline.growth_customer_0_365
2018-04-17 13:42:34,597: Parsing model.agency_data_pipeline.growth_customer_0_365_segment
2018-04-17 13:42:34,599: Parsing model.agency_data_pipeline.growth_date_union
2018-04-17 13:42:34,603: Parsing model.agency_data_pipeline.growth_stats
2018-04-17 13:42:34,610: Parsing model.agency_data_pipeline.retention_0_365
2018-04-17 13:42:34,614: Parsing model.agency_data_pipeline.retention_0_365_new
2018-04-17 13:42:34,617: Parsing model.agency_data_pipeline.retention_0_365_reactivated
2018-04-17 13:42:34,619: Parsing model.agency_data_pipeline.retention_0_365_rebuy
2018-04-17 13:42:34,621: Parsing model.agency_data_pipeline.retention_365_730
2018-04-17 13:42:34,624: Parsing model.agency_data_pipeline.retention_730_plus
2018-04-17 13:42:34,625: Parsing model.agency_data_pipeline.retention_stats
2018-04-17 13:42:34,631: Parsing model.agency_data_pipeline.retention_stats_rebuy_rate
2018-04-17 13:42:34,633: Parsing model.agency_data_pipeline.retention_0_30
2018-04-17 13:42:34,635: Parsing model.agency_data_pipeline.retention_0_30_new
2018-04-17 13:42:34,638: Parsing model.agency_data_pipeline.retention_0_30_reactivated
2018-04-17 13:42:34,640: Parsing model.agency_data_pipeline.retention_0_30_rebuy
2018-04-17 13:42:34,642: Parsing model.agency_data_pipeline.retention_30_60
2018-04-17 13:42:34,644: Parsing model.agency_data_pipeline.retention_60_plus
2018-04-17 13:42:34,647: Parsing model.agency_data_pipeline.retention_stats_month
2018-04-17 13:42:34,652: Parsing model.agency_data_pipeline.retention_stats_rebuy_rate_month
2018-04-17 13:42:34,654: Parsing model.agency_data_pipeline.customers_first_purchase_proc
2018-04-17 13:42:34,657: Parsing model.agency_data_pipeline.customers_proc
2018-04-17 13:42:34,660: Parsing model.agency_data_pipeline.segment_list_customers
2018-04-17 13:42:34,662: Parsing model.agency_data_pipeline.segment_proc_customers
2018-04-17 13:42:34,665: Parsing model.agency_data_pipeline.segment_stats_customers
2018-04-17 13:42:34,667: Parsing model.agency_data_pipeline.segment_stats_customers_agg
2018-04-17 13:42:34,670: Parsing model.agency_data_pipeline.customers_first_purchase_product_type_proc
2018-04-17 13:42:34,672: Parsing model.agency_data_pipeline.customers_products_proc
2018-04-17 13:42:34,675: Parsing model.agency_data_pipeline.segment_list_customers_products
2018-04-17 13:42:34,677: Parsing model.agency_data_pipeline.segment_proc_customers_products
2018-04-17 13:42:34,680: Parsing model.agency_data_pipeline.segment_stats_customers_products
2018-04-17 13:42:34,682: Parsing model.agency_data_pipeline.segment_stats_customers_products_agg
2018-04-17 13:42:34,685: Parsing model.agency_data_pipeline.frequency_proc
2018-04-17 13:42:34,688: Parsing model.agency_data_pipeline.frequency_stats
2018-04-17 13:42:34,689: Parsing model.agency_data_pipeline.order_paths_agg
2018-04-17 13:42:34,691: Parsing model.agency_data_pipeline.order_paths_proc
2018-04-17 13:42:34,693: Parsing model.agency_data_pipeline.order_paths_stats
2018-04-17 13:42:34,696: Parsing model.agency_data_pipeline.products_proc
2018-04-17 13:42:34,699: Parsing model.agency_data_pipeline.segment_proc_sku
2018-04-17 13:42:34,701: Parsing model.agency_data_pipeline.segment_stats_category
2018-04-17 13:42:34,703: Parsing model.agency_data_pipeline.segment_stats_sku
2018-04-17 13:42:34,732: Found 91 models, 0 tests, 0 archives, 0 analyses, 46 macros, 0 operations
2018-04-17 13:42:34,792: 
2018-04-17 13:42:36,343: 13:42:36 | Concurrency: 4 threads (target='prod')
2018-04-17 13:42:36,344: 13:42:36 | 
2018-04-17 13:42:37,228: 13:42:37 | 1 of 91 START table model agency_data_pipeline.bing_ads_ads.......... [RUN]
2018-04-17 13:42:37,228: Compiling model.agency_data_pipeline.bing_ads_ads
2018-04-17 13:42:37,234: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_ads"
2018-04-17 13:42:37,228: 13:42:37 | 2 of 91 START table model agency_data_pipeline.adwords_urls.......... [RUN]
2018-04-17 13:42:37,234: Compiling model.agency_data_pipeline.adwords_urls
2018-04-17 13:42:37,239: Writing injected SQL for node "model.agency_data_pipeline.adwords_urls"
2018-04-17 13:42:37,228: 13:42:37 | 3 of 91 START table model agency_data_pipeline.ga_conversions........ [RUN]
2018-04-17 13:42:37,239: Compiling model.agency_data_pipeline.ga_conversions
2018-04-17 13:42:37,228: 13:42:37 | 4 of 91 START table model agency_data_pipeline.monthend_dates........ [RUN]
2018-04-17 13:42:37,243: Writing injected SQL for node "model.agency_data_pipeline.ga_conversions"
2018-04-17 13:42:37,244: Compiling model.agency_data_pipeline.monthend_dates
2018-04-17 13:42:37,245: Acquiring new bigquery connection "adwords_urls".
2018-04-17 13:42:37,249: Writing injected SQL for node "model.agency_data_pipeline.monthend_dates"
2018-04-17 13:42:37,250: Opening a new connection (1 currently allocated)
2018-04-17 13:42:37,250: Acquiring new bigquery connection "bing_ads_ads".
2018-04-17 13:42:37,253: Acquiring new bigquery connection "ga_conversions".
2018-04-17 13:42:37,254: Opening a new connection (2 currently allocated)
2018-04-17 13:42:37,255: Acquiring new bigquery connection "monthend_dates".
2018-04-17 13:42:37,315: Opening a new connection (3 currently allocated)
2018-04-17 13:42:37,370: Opening a new connection (4 currently allocated)
2018-04-17 13:42:38,986: Model SQL (monthend_dates):
SELECT
date_in_range,
date_in_range_bom,
date_in_range_bom_mom,
unix_date_in_range,
unix_date_in_range_bom,
unix_date(date_in_range_bom_mom) unix_date_in_range_bom_mom,
yyyymm,
date_in_range_yoy,
unix_date(date_in_range_yoy) unix_date_in_range_yoy

FROM
(
	SELECT 
	date_in_range,
	date_in_range_bom,
	date_sub(date_in_range_bom, INTERVAL 1 MONTH) date_in_range_bom_mom,
  date_sub(date_in_range, INTERVAL 1 YEAR) date_in_range_yoy,
	unix_date_in_range,
	unix_date(date_in_range_bom) unix_date_in_range_bom,
	yyyymm,
	first_value(date_in_range) over (partition by yyyymm order by date_in_range desc) monthend_date_in_range
	FROM
	( 
		SELECT 
		date_in_range,
		date_trunc( date_in_range, MONTH) date_in_range_bom,
		unix_date(date_in_range) unix_date_in_range,
		format_date("%Y-%m", date_in_range) AS yyyymm
		FROM UNNEST(
		    GENERATE_DATE_ARRAY(DATE('2016-01-31'), CURRENT_DATE(), INTERVAL 1 DAY)
		) AS date_in_range
	)
)
where date_in_range = monthend_date_in_range
2018-04-17 13:42:38,998: Model SQL (adwords_urls):
SELECT
campaignid,
lower(trim(regexp_replace(replace(replace(replace(replace(finalurl,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url

FROM (

SELECT  
campaignid,
finalurl,
first_value(finalurl) OVER (PARTITION BY campaignid ORDER BY day DESC) lv
FROM `growth-engines-pipeline.adwords_2.FINAL_URL_REPORT`
)

WHERE lv = finalurl
group by campaignid, url
order by campaignid asc
2018-04-17 13:42:39,059: Model SQL (bing_ads_ads):
select
date, 
account, 
channel,
platform,
campaignid,
campaignname,
max(lower(trim(replace(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$','' ),'.html',''),'/'))) as url,
utm_campaign,
sum(cost) as cost,
sum(impressions) as impressions,
sum(clicks) as clicks,
sum(conversions) as conversions
from 
  ( 
SELECT  
cast(gregoriandate as date) date,
replace(accountname,',','') account,
'Paid' as channel,
'Bing Ads' as platform,
adid,
adtype,
campaignid, 
campaignname,
finalurl url,
case when regexp_contains(destinationurl, 'utm_campaign')
	then replace(lower(nullif(
  

    split(
        
  

    split(
        destinationurl,
        'utm_campaign='
        )[offset(1)]


,
        '&'
        )[offset(0)]


,'')),'+',' ') 
	else null end as utm_campaign,
spend cost, 
impressions, 
clicks, 
conversions,
_sdc_sequence,
first_value(_sdc_sequence) OVER (PARTITION BY adid, gregoriandate ORDER BY _sdc_sequence DESC) lv
FROM `growth-engines-pipeline.bing_ads.ad_performance_report` 
  )

where lv = _sdc_sequence
group by date, account, channel, platform, campaignid, campaignname, utm_campaign
2018-04-17 13:42:39,080: Model SQL (ga_conversions):
select 
client,
client_name,
platform,
goal_name,
goal_type,
account,
time_of_entry
from  ( 

SELECT  
client,
client_name,
platform,
trim(goal_name) goal_name,
goal_type,
account,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform, goal_name ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.conversion_goals` 
WHERE platform = 'Google Analytics'

) 

WHERE lv = time_of_entry
2018-04-17 13:42:40,137: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5a487de4-5eb7-4fb5-835f-0babe80bb98d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106d59cf8>]}
2018-04-17 13:42:40,377: 13:42:40 | 4 of 91 OK created table model agency_data_pipeline.monthend_dates... [CREATE TABLE in 2.89s]
2018-04-17 13:42:40,377: 13:42:40 | 5 of 91 START table model agency_data_pipeline.clients_proc.......... [RUN]
2018-04-17 13:42:40,378: Compiling model.agency_data_pipeline.clients_proc
2018-04-17 13:42:40,384: Writing injected SQL for node "model.agency_data_pipeline.clients_proc"
2018-04-17 13:42:40,386: Acquiring new bigquery connection "clients_proc".
2018-04-17 13:42:40,386: Re-using an available connection from the pool.
2018-04-17 13:42:41,283: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5a487de4-5eb7-4fb5-835f-0babe80bb98d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106cf5710>]}
2018-04-17 13:42:41,345: Model SQL (clients_proc):
select 
client,
client_name,
account,
platform
from  ( 

SELECT  
client,
client_name,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.accounts`
where client_name != ''
) 

WHERE lv = time_of_entry
2018-04-17 13:42:41,356: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5a487de4-5eb7-4fb5-835f-0babe80bb98d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106d59940>]}
2018-04-17 13:42:41,518: 13:42:41 | 2 of 91 OK created table model agency_data_pipeline.adwords_urls..... [CREATE TABLE in 4.05s]
2018-04-17 13:42:41,523: 13:42:41 | 6 of 91 START table model agency_data_pipeline.carts_proc............ [RUN]
2018-04-17 13:42:41,525: Compiling model.agency_data_pipeline.carts_proc
2018-04-17 13:42:41,530: Writing injected SQL for node "model.agency_data_pipeline.carts_proc"
2018-04-17 13:42:41,532: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5a487de4-5eb7-4fb5-835f-0babe80bb98d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106d595c0>]}
2018-04-17 13:42:41,533: Acquiring new bigquery connection "carts_proc".
2018-04-17 13:42:41,533: Re-using an available connection from the pool.
2018-04-17 13:42:41,759: 13:42:41 | 1 of 91 OK created table model agency_data_pipeline.bing_ads_ads..... [CREATE TABLE in 4.13s]
2018-04-17 13:42:41,760: 13:42:41 | 7 of 91 START table model agency_data_pipeline.conversion_goals_proc. [RUN]
2018-04-17 13:42:41,761: Compiling model.agency_data_pipeline.conversion_goals_proc
2018-04-17 13:42:41,766: Writing injected SQL for node "model.agency_data_pipeline.conversion_goals_proc"
2018-04-17 13:42:41,770: Acquiring new bigquery connection "conversion_goals_proc".
2018-04-17 13:42:41,771: Re-using an available connection from the pool.
2018-04-17 13:42:41,996: 13:42:41 | 3 of 91 OK created table model agency_data_pipeline.ga_conversions... [CREATE TABLE in 4.29s]
2018-04-17 13:42:41,997: 13:42:41 | 8 of 91 START table model agency_data_pipeline.bing_ads_impression_share [RUN]
2018-04-17 13:42:41,997: Compiling model.agency_data_pipeline.bing_ads_impression_share
2018-04-17 13:42:42,004: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_impression_share"
2018-04-17 13:42:42,005: Acquiring new bigquery connection "bing_ads_impression_share".
2018-04-17 13:42:42,005: Re-using an available connection from the pool.
2018-04-17 13:42:42,431: Model SQL (carts_proc):
select 
client,
client_name,
account,
platform
from  ( 

SELECT  
client,
client_name,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.accounts`
WHERE platform in ('Shopify', 'Custom cart')

) 

WHERE lv = time_of_entry
2018-04-17 13:42:42,497: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5a487de4-5eb7-4fb5-835f-0babe80bb98d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106d59cf8>]}
2018-04-17 13:42:42,680: Model SQL (conversion_goals_proc):
select 
client,
platform,
goal_name,
max(goal_type) goal_type,
account,
max(time_of_entry) time_of_entry
from  ( 

SELECT  
client,
platform,
trim(replace(replace(lower(goal_name),',',''),' ','')) goal_name,
goal_type,
account,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY platform ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.conversion_goals` 

) 

WHERE lv = time_of_entry
group by client, platform, account, goal_name
2018-04-17 13:42:42,731: 13:42:42 | 5 of 91 OK created table model agency_data_pipeline.clients_proc..... [CREATE TABLE in 2.12s]
2018-04-17 13:42:42,731: 13:42:42 | 9 of 91 START table model agency_data_pipeline.adwords_conversions... [RUN]
2018-04-17 13:42:42,732: Compiling model.agency_data_pipeline.adwords_conversions
2018-04-17 13:42:42,741: Writing injected SQL for node "model.agency_data_pipeline.adwords_conversions"
2018-04-17 13:42:42,742: Acquiring new bigquery connection "adwords_conversions".
2018-04-17 13:42:42,742: Re-using an available connection from the pool.
2018-04-17 13:42:43,094: Model SQL (bing_ads_impression_share):
SELECT 
date, 
account,
channel,
platform,
sum(impressions) impressions,
sum(available_impressions) available_impressions
FROM

(

SELECT  
cast(gregoriandate as date) date,
replace(accountname,',','') account,  
'Paid' as channel,
'Bing Ads' as platform,
case when impressionsharepercent is null then 0 else impressions end as impressions,
cast(round(case when ( impressionsharepercent is not null and impressionsharepercent > 0 ) then (impressions*100)/impressionsharepercent else 0 end) as int64) as available_impressions,
_sdc_sequence,
first_value(_sdc_sequence) OVER (PARTITION BY campaignid, gregoriandate ORDER BY _sdc_sequence DESC) lv
FROM `growth-engines-pipeline.bing_ads.campaign_performance_report` 

)

where lv = _sdc_sequence
group by date, account, channel, platform
2018-04-17 13:42:43,535: Model SQL (adwords_conversions):
select 
client,
client_name,
platform,
goal_name,
goal_type,
account,
time_of_entry
from  ( 

SELECT  
client,
client_name,
platform,
trim(lower(goal_name)) goal_name,
goal_type,
account,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform, goal_name ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.conversion_goals` 
WHERE platform = 'Adwords'

) 

WHERE lv = time_of_entry
2018-04-17 13:42:43,823: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5a487de4-5eb7-4fb5-835f-0babe80bb98d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106d59940>]}
2018-04-17 13:42:44,054: 13:42:44 | 7 of 91 OK created table model agency_data_pipeline.conversion_goals_proc [CREATE TABLE in 2.06s]
2018-04-17 13:42:44,054: 13:42:44 | 10 of 91 START table model agency_data_pipeline.all_dates............ [RUN]
2018-04-17 13:42:44,054: Compiling model.agency_data_pipeline.all_dates
2018-04-17 13:42:44,058: Writing injected SQL for node "model.agency_data_pipeline.all_dates"
2018-04-17 13:42:44,059: Acquiring new bigquery connection "all_dates".
2018-04-17 13:42:44,059: Re-using an available connection from the pool.
2018-04-17 13:42:44,721: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5a487de4-5eb7-4fb5-835f-0babe80bb98d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106cf5710>]}
2018-04-17 13:42:44,804: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5a487de4-5eb7-4fb5-835f-0babe80bb98d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106d59cf8>]}
2018-04-17 13:42:44,861: Model SQL (all_dates):
SELECT 
date_in_range,
unix_date(date_in_range) unix_date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-04-17 13:42:44,974: 13:42:44 | 6 of 91 OK created table model agency_data_pipeline.carts_proc....... [CREATE TABLE in 3.20s]
2018-04-17 13:42:44,974: 13:42:44 | 11 of 91 START table model agency_data_pipeline.accounts_proc........ [RUN]
2018-04-17 13:42:44,975: Compiling model.agency_data_pipeline.accounts_proc
2018-04-17 13:42:44,985: Writing injected SQL for node "model.agency_data_pipeline.accounts_proc"
2018-04-17 13:42:44,989: Acquiring new bigquery connection "accounts_proc".
2018-04-17 13:42:44,990: Re-using an available connection from the pool.
2018-04-17 13:42:45,266: 13:42:45 | 9 of 91 OK created table model agency_data_pipeline.adwords_conversions [CREATE TABLE in 2.07s]
2018-04-17 13:42:45,267: 13:42:45 | 12 of 91 START table model agency_data_pipeline.adwords_campaigns.... [RUN]
2018-04-17 13:42:45,267: Compiling model.agency_data_pipeline.adwords_campaigns
2018-04-17 13:42:45,276: Writing injected SQL for node "model.agency_data_pipeline.adwords_campaigns"
2018-04-17 13:42:45,277: Acquiring new bigquery connection "adwords_campaigns".
2018-04-17 13:42:45,277: Re-using an available connection from the pool.
2018-04-17 13:42:45,334: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5a487de4-5eb7-4fb5-835f-0babe80bb98d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106d595c0>]}
2018-04-17 13:42:45,583: 13:42:45 | 8 of 91 OK created table model agency_data_pipeline.bing_ads_impression_share [CREATE TABLE in 3.34s]
2018-04-17 13:42:45,924: Model SQL (accounts_proc):
select 
client,
account,
platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.accounts` 

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-04-17 13:42:46,249: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5a487de4-5eb7-4fb5-835f-0babe80bb98d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106d59940>]}
2018-04-17 13:42:46,249: Model SQL (adwords_campaigns):
select
day,
campaignid, 
campaign,
account, 
channel,
platform,
sum(cost) cost,
sum(impressions) impressions,
sum(clicks) clicks,
sum(impression_share_num) impression_share_num,
sum(impression_share_den) impression_share_den
from 
  ( 
	SELECT  
	day,
	campaignid,
	campaign,
	account as account,
	'Paid' as channel,
	'Adwords' as platform,
	cost/1000000 cost, 
	impressions as impressions, 
	clicks, 
	case when searchimprshare is not null then impressions end as impression_share_num,
	case when searchimprshare is not null then impressions/(searchimprshare/100) end as impression_share_den,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY campaignid, day ORDER BY _sdc_sequence DESC) lv
	FROM `growth-engines-pipeline.adwords_2.CAMPAIGN_PERFORMANCE_REPORT`
  )
where lv = _sdc_sequence
group by day, campaignid, account, channel, platform, campaign
2018-04-17 13:42:46,496: 13:42:46 | 10 of 91 OK created table model agency_data_pipeline.all_dates....... [CREATE TABLE in 2.19s]
2018-04-17 13:42:47,039: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5a487de4-5eb7-4fb5-835f-0babe80bb98d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106cf5710>]}
2018-04-17 13:42:47,317: 13:42:47 | 11 of 91 OK created table model agency_data_pipeline.accounts_proc... [CREATE TABLE in 2.06s]
2018-04-17 13:42:50,765: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5a487de4-5eb7-4fb5-835f-0babe80bb98d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106d59cf8>]}
2018-04-17 13:42:51,002: 13:42:51 | 12 of 91 OK created table model agency_data_pipeline.adwords_campaigns [CREATE TABLE in 5.50s]
2018-04-17 13:42:51,003: 13:42:51 | 13 of 91 START table model agency_data_pipeline.mappings_ga_proc..... [RUN]
2018-04-17 13:42:51,004: Compiling model.agency_data_pipeline.mappings_ga_proc
2018-04-17 13:42:51,003: 13:42:51 | 14 of 91 START table model agency_data_pipeline.fb_ads_insights_conversions [RUN]
2018-04-17 13:42:51,014: Writing injected SQL for node "model.agency_data_pipeline.mappings_ga_proc"
2018-04-17 13:42:51,004: 13:42:51 | 15 of 91 START table model agency_data_pipeline.fb_adcreative........ [RUN]
2018-04-17 13:42:51,015: Compiling model.agency_data_pipeline.fb_ads_insights_conversions
2018-04-17 13:42:51,004: 13:42:51 | 16 of 91 START table model agency_data_pipeline.bing_ads_conversions. [RUN]
2018-04-17 13:42:51,015: Compiling model.agency_data_pipeline.fb_adcreative
2018-04-17 13:42:51,023: Acquiring new bigquery connection "fb_ads_insights_conversions".
2018-04-17 13:42:51,023: Compiling model.agency_data_pipeline.bing_ads_conversions
2018-04-17 13:42:51,024: Acquiring new bigquery connection "mappings_ga_proc".
2018-04-17 13:42:51,032: Acquiring new bigquery connection "fb_adcreative".
2018-04-17 13:42:51,032: Re-using an available connection from the pool.
2018-04-17 13:42:51,053: Fetching data for query fb_ads_insights_conversions:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 13:42:51,052: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_conversions"
2018-04-17 13:42:51,056: Re-using an available connection from the pool.
2018-04-17 13:42:51,058: Acquiring new bigquery connection "bing_ads_conversions".
2018-04-17 13:42:51,059: Re-using an available connection from the pool.
2018-04-17 13:42:51,060: Fetching data for query fb_adcreative:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 13:42:51,061: Re-using an available connection from the pool.
2018-04-17 13:42:52,002: Model SQL (bing_ads_conversions):
SELECT
date, 
a.account account, 
a.channel channel,
a.platform platform,
campaignid,
campaignname,
sum( case when b.goal_type = 'Transactions' then conversions else 0 end ) as transactions
FROM

  ( 
SELECT  
cast(gregoriandate as date) date,
replace(accountname,',','') account,
'Paid' as channel,
'Bing Ads' as platform,
trim(replace(replace(lower(goal),',',''),' ','')) goal,
goalid,
campaignid,
campaignname,
conversions,
_sdc_sequence,
first_value(_sdc_sequence) OVER (PARTITION BY campaignid, goalid, gregoriandate ORDER BY _sdc_sequence DESC) lv
FROM `growth-engines-pipeline.bing_ads.goals_and_funnels_report` 

  ) a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`conversion_goals_proc` b
ON (
	a.account = b.account AND
	a.platform = b.platform AND
	a.goal = b.goal_name
)
where a.lv = a._sdc_sequence
group by date, account, channel, platform, campaignid, campaignname
2018-04-17 13:42:52,302: Model SQL (mappings_ga_proc):
select 
client,
account,
client_name,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
account,
client_name,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.mappings_ga` 

) 

WHERE lv = time_of_entry
and client in (select client from `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc` )
group by client, account, client_name, source, medium, platform_n, channel_n, time_of_entry
2018-04-17 13:42:52,330: Writing injected SQL for node "model.agency_data_pipeline.fb_adcreative"
2018-04-17 13:42:52,545: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_insights_conversions"
2018-04-17 13:42:53,154: Model SQL (fb_adcreative):




with fb_adcreative as (


	    
		   	SELECT 
			id,
			object_url,
			url_tags,
			_sdc_sequence
			FROM `growth-engines-pipeline.fb_ads_luca_danni.adcreative`
		    
	   
)

select creative_id, max(url) url
from (
  select
  id creative_id,
  lower(trim(regexp_replace(replace(replace(replace(replace(object_url,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
  first_value(_sdc_sequence) OVER (PARTITION BY id ORDER BY _sdc_sequence DESC) lv,
  _sdc_sequence
  from fb_adcreative
  )
where lv = _sdc_sequence
group by creative_id


2018-04-17 13:42:53,428: Model SQL (fb_ads_insights_conversions):




with fb_ads_insights_conversions as (

	    
		   	SELECT 
			date_start,
			campaign_id,
			campaign_name,
			ad_id,
			account_name,
			spend,
			reach,
			inline_link_clicks,
			_sdc_sequence,
			action_type,
			value
			FROM `growth-engines-pipeline.fb_ads_luca_danni.ads_insights`
			cross join unnest(actions)
		    
	   

)

SELECT * 
FROM 
	(
    SELECT
    date_start date,
    campaign_id,
    campaign_name campaign,
    ad_id,
    account_name account,
    action_type,
    value conversions,
    first_value(_sdc_sequence) OVER (PARTITION BY ad_id, date_start ORDER BY _sdc_sequence DESC) lv,
    _sdc_sequence
    FROM fb_ads_insights_conversions
   	)
where lv = _sdc_sequence
and action_type like '%purchase%'


2018-04-17 13:42:53,460: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5a487de4-5eb7-4fb5-835f-0babe80bb98d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106d44fd0>]}
2018-04-17 13:42:53,682: 13:42:53 | 13 of 91 OK created table model agency_data_pipeline.mappings_ga_proc [CREATE TABLE in 2.46s]
2018-04-17 13:42:53,682: 13:42:53 | 17 of 91 START table model agency_data_pipeline.adwords_ads.......... [RUN]
2018-04-17 13:42:53,682: Compiling model.agency_data_pipeline.adwords_ads
2018-04-17 13:42:53,692: Writing injected SQL for node "model.agency_data_pipeline.adwords_ads"
2018-04-17 13:42:53,694: Acquiring new bigquery connection "adwords_ads".
2018-04-17 13:42:53,694: Re-using an available connection from the pool.
2018-04-17 13:42:54,347: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5a487de4-5eb7-4fb5-835f-0babe80bb98d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106d44198>]}
2018-04-17 13:42:54,583: Model SQL (adwords_ads):
SELECT  
day,
campaignid,
a.account as account,
utm_campaign,
sum( case when b.goal_type = 'Transaction' then conversions else 0 end ) as transactions
FROM (

	SELECT  
	day,
	adid,
	campaignid,
	account,
	lower(conversionname) conversionname,
	conversions,
	lower(campaign) utm_campaign,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY campaignid, day ORDER BY _sdc_sequence DESC) lv
	FROM
	`growth-engines-pipeline.adwords_2.AD_PERFORMANCE_REPORT`

) a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_conversions` b
ON ( a.conversionname = b.goal_name
	AND a.account = b.account )
WHERE lv = _sdc_sequence
group by day, campaignid, account, utm_campaign
2018-04-17 13:42:54,602: 13:42:54 | 16 of 91 OK created table model agency_data_pipeline.bing_ads_conversions [CREATE TABLE in 3.32s]
2018-04-17 13:42:54,602: 13:42:54 | 18 of 91 START table model agency_data_pipeline.fb_ads_insights...... [RUN]
2018-04-17 13:42:54,603: Compiling model.agency_data_pipeline.fb_ads_insights
2018-04-17 13:42:54,611: Acquiring new bigquery connection "fb_ads_insights".
2018-04-17 13:42:54,611: Re-using an available connection from the pool.
2018-04-17 13:42:54,612: Fetching data for query fb_ads_insights:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 13:42:55,047: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_insights"
2018-04-17 13:42:55,438: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5a487de4-5eb7-4fb5-835f-0babe80bb98d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106b603c8>]}
2018-04-17 13:42:55,672: 13:42:55 | 15 of 91 OK created table model agency_data_pipeline.fb_adcreative... [CREATE TABLE in 4.42s]
2018-04-17 13:42:55,673: 13:42:55 | 19 of 91 START table model agency_data_pipeline.ga_mcf_proc.......... [RUN]
2018-04-17 13:42:55,673: Compiling model.agency_data_pipeline.ga_mcf_proc
2018-04-17 13:42:55,684: Writing injected SQL for node "model.agency_data_pipeline.ga_mcf_proc"
2018-04-17 13:42:55,685: Acquiring new bigquery connection "ga_mcf_proc".
2018-04-17 13:42:55,686: Re-using an available connection from the pool.
2018-04-17 13:42:56,082: Model SQL (fb_ads_insights):




with fb_ads_insights as (

	    
		   	SELECT 
			date_start,
			campaign_id,
			campaign_name,
			ad_id,
			account_name,
			spend,
			reach,
			inline_link_clicks,
			_sdc_sequence,
			first_value(_sdc_sequence) OVER (PARTITION BY date_start, ad_id, campaign_id ORDER BY _sdc_sequence DESC) lv
			FROM `growth-engines-pipeline.fb_ads_luca_danni.ads_insights`
		    
	   

)

select
date_start date,
campaign_id,
campaign_name campaign,
ad_id,
account_name account,
max(spend) cost,
max(reach) impressions,
max(inline_link_clicks) clicks
from fb_ads_insights
where lv = _sdc_sequence
group by date, campaign_id, ad_id, account, campaign


2018-04-17 13:42:56,585: Model SQL (ga_mcf_proc):
SELECT 
date,
account,
'Google Analytics' as lookup_platform,
source_medium_path,
trim(lower(split(split(source_medium_path,'->')[SAFE_ORDINAL(1)],'/')[SAFE_ORDINAL(1)])) as source,
trim(lower(split(split(source_medium_path,'->')[SAFE_ORDINAL(1)],'/')[SAFE_ORDINAL(2)])) as medium,
first_interaction_campaign campaign,
cast(regexp_replace(transaction_id, r'#', '') as int64) transactionid,
max(first_interaction_conversions) transactions,
max(first_interaction_conversion_value) revenue
FROM `growth-engines-pipeline.agency_data_pipeline.ga_mcf`
where account in (select account from `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc` where platform = 'Google Analytics')
group by date, account, source, medium, campaign, source_medium_path, lookup_platform, transactionid
2018-04-17 13:42:56,957: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5a487de4-5eb7-4fb5-835f-0babe80bb98d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106d44fd0>]}
2018-04-17 13:42:57,199: 13:42:57 | 17 of 91 OK created table model agency_data_pipeline.adwords_ads..... [CREATE TABLE in 3.27s]
2018-04-17 13:42:57,200: 13:42:57 | 20 of 91 START table model agency_data_pipeline.shopify_refunds_proc. [RUN]
2018-04-17 13:42:57,200: Compiling model.agency_data_pipeline.shopify_refunds_proc
2018-04-17 13:42:57,207: Acquiring new bigquery connection "shopify_refunds_proc".
2018-04-17 13:42:57,207: Re-using an available connection from the pool.
2018-04-17 13:42:57,207: Fetching data for query shopify_refunds_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 13:42:58,327: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5a487de4-5eb7-4fb5-835f-0babe80bb98d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106d44198>]}
2018-04-17 13:42:58,567: 13:42:58 | 18 of 91 OK created table model agency_data_pipeline.fb_ads_insights. [CREATE TABLE in 3.72s]
2018-04-17 13:42:58,687: Writing injected SQL for node "model.agency_data_pipeline.shopify_refunds_proc"
2018-04-17 13:42:59,180: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5a487de4-5eb7-4fb5-835f-0babe80bb98d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106d3b2e8>]}
2018-04-17 13:42:59,408: 13:42:59 | 14 of 91 OK created table model agency_data_pipeline.fb_ads_insights_conversions [CREATE TABLE in 8.16s]
2018-04-17 13:42:59,647: Model SQL (shopify_refunds_proc):




with refunds as (

	
	SELECT
	order_number,
	checkout_id,
	financial_status,
	line_item_id,
	quantity,
	subtotal,
	line_item.variant_id variant_id,
	line_item.id refund_id,
 	_sdc_sequence
	FROM `growth-engines-pipeline.shopify_lucadanni.orders` 
	cross join unnest(refunds), unnest(refund_line_items)
  	where financial_status like '%refund%'
	
	

)

SELECT * 
FROM 
	(
    SELECT
	order_number,
	checkout_id,
	financial_status,
	line_item_id,
	quantity,
	subtotal refund_amount,
	variant_id,
	refund_id,
 	_sdc_sequence,
    first_value(_sdc_sequence) OVER (PARTITION BY order_number, line_item_id ORDER BY _sdc_sequence DESC) lv
    FROM refunds
   	) 
WHERE lv = _sdc_sequence


2018-04-17 13:42:59,978: 13:42:59 | The bigquery adapter does not support query cancellation. Some queries may still be running!
2018-04-17 13:42:59,978: Connection 'master' was left open.
2018-04-17 13:42:59,979: ctrl-c
2018-04-17 13:44:40,481: Tracking: tracking
2018-04-17 13:44:40,482: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10acb1cc0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10acb1eb8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10acb1f60>]}
2018-04-17 13:44:41,191: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-04-17 13:44:41,215: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/growth-engines/dbt_modules
2018-04-17 13:44:41,222: Parsing get_column_values.sql
2018-04-17 13:44:41,244: Parsing get_url_parameter.sql
2018-04-17 13:44:41,248: Parsing split_part.sql
2018-04-17 13:44:41,259: Parsing table_exists.sql
2018-04-17 13:44:41,275: Parsing core.sql
2018-04-17 13:44:41,297: Parsing adapters/bigquery.sql
2018-04-17 13:44:41,313: Parsing adapters/common.sql
2018-04-17 13:44:41,380: Parsing adapters/postgres.sql
2018-04-17 13:44:41,389: Parsing adapters/redshift.sql
2018-04-17 13:44:41,425: Parsing etc/get_custom_schema.sql
2018-04-17 13:44:41,437: Parsing materializations/archive.sql
2018-04-17 13:44:41,477: Parsing materializations/bigquery.sql
2018-04-17 13:44:41,498: Parsing materializations/helpers.sql
2018-04-17 13:44:41,531: Parsing materializations/incremental.sql
2018-04-17 13:44:41,616: Parsing materializations/table.sql
2018-04-17 13:44:41,648: Parsing materializations/view.sql
2018-04-17 13:44:41,670: Parsing materializations/wrapper.sql
2018-04-17 13:44:41,680: Parsing schema_tests/accepted_values.sql
2018-04-17 13:44:41,686: Parsing schema_tests/not_null.sql
2018-04-17 13:44:41,690: Parsing schema_tests/relationships.sql
2018-04-17 13:44:41,693: Parsing schema_tests/unique.sql
2018-04-17 13:44:41,756: Parsing model.agency_data_pipeline.accounts_proc
2018-04-17 13:44:41,758: Parsing model.agency_data_pipeline.all_dates
2018-04-17 13:44:41,760: Parsing model.agency_data_pipeline.carts_proc
2018-04-17 13:44:41,762: Parsing model.agency_data_pipeline.clients_proc
2018-04-17 13:44:41,765: Parsing model.agency_data_pipeline.conversion_goals_proc
2018-04-17 13:44:41,767: Parsing model.agency_data_pipeline.mappings_ga_proc
2018-04-17 13:44:41,770: Acquiring new bigquery connection "master".
2018-04-17 13:44:41,770: Opening a new connection (0 currently allocated)
2018-04-17 13:44:41,773: Parsing model.agency_data_pipeline.monthend_dates
2018-04-17 13:44:41,775: Parsing model.agency_data_pipeline.adwords_ads
2018-04-17 13:44:41,777: Parsing model.agency_data_pipeline.adwords_campaigns
2018-04-17 13:44:41,779: Parsing model.agency_data_pipeline.adwords_conversions
2018-04-17 13:44:41,782: Parsing model.agency_data_pipeline.adwords_impression_share
2018-04-17 13:44:41,785: Parsing model.agency_data_pipeline.adwords_join
2018-04-17 13:44:41,788: Parsing model.agency_data_pipeline.adwords_stats
2018-04-17 13:44:41,790: Parsing model.agency_data_pipeline.adwords_urls
2018-04-17 13:44:41,792: Parsing model.agency_data_pipeline.bing_ads_ads
2018-04-17 13:44:41,795: Parsing model.agency_data_pipeline.bing_ads_conversions
2018-04-17 13:44:41,798: Parsing model.agency_data_pipeline.bing_ads_impression_share
2018-04-17 13:44:41,800: Parsing model.agency_data_pipeline.bing_ads_stats
2018-04-17 13:44:41,804: Parsing model.agency_data_pipeline.fb_adcreative
2018-04-17 13:44:41,810: Parsing model.agency_data_pipeline.fb_ads
2018-04-17 13:44:41,819: Parsing model.agency_data_pipeline.fb_ads_insights
2018-04-17 13:44:41,826: Parsing model.agency_data_pipeline.fb_ads_insights_conversions
2018-04-17 13:44:41,832: Parsing model.agency_data_pipeline.fb_ads_stats
2018-04-17 13:44:41,836: Parsing model.agency_data_pipeline.ga_conversions
2018-04-17 13:44:41,838: Parsing model.agency_data_pipeline.ga_traffic
2018-04-17 13:44:41,852: Parsing model.agency_data_pipeline.ga_transactions
2018-04-17 13:44:41,862: Parsing model.agency_data_pipeline.ga_mcf_proc
2018-04-17 13:44:41,865: Parsing model.agency_data_pipeline.ga_mcf_stats
2018-04-17 13:44:41,869: Parsing model.agency_data_pipeline.shopify_customers_proc
2018-04-17 13:44:41,875: Parsing model.agency_data_pipeline.shopify_orders_proc
2018-04-17 13:44:41,885: Parsing model.agency_data_pipeline.shopify_products_proc
2018-04-17 13:44:41,893: Parsing model.agency_data_pipeline.shopify_refunds_proc
2018-04-17 13:44:41,898: Parsing model.agency_data_pipeline.agg_campaign
2018-04-17 13:44:41,902: Parsing model.agency_data_pipeline.agg_customers_union
2018-04-17 13:44:41,904: Parsing model.agency_data_pipeline.agg_ga_campaign
2018-04-17 13:44:41,907: Parsing model.agency_data_pipeline.agg_ga_campaign_by_type
2018-04-17 13:44:41,910: Parsing model.agency_data_pipeline.agg_ga_transaction
2018-04-17 13:44:41,913: Parsing model.agency_data_pipeline.agg_ga_transaction_order_number
2018-04-17 13:44:41,917: Parsing model.agency_data_pipeline.agg_orders_union
2018-04-17 13:44:41,920: Parsing model.agency_data_pipeline.agg_platform_monthly
2018-04-17 13:44:41,922: Parsing model.agency_data_pipeline.agg_platforms_client
2018-04-17 13:44:41,924: Parsing model.agency_data_pipeline.agg_platforms_union
2018-04-17 13:44:41,927: Parsing model.agency_data_pipeline.agg_products
2018-04-17 13:44:41,929: Parsing model.agency_data_pipeline.agg_transaction
2018-04-17 13:44:41,932: Parsing model.agency_data_pipeline.agg_transaction_daily
2018-04-17 13:44:41,934: Parsing model.agency_data_pipeline.agg_transaction_line_item
2018-04-17 13:44:41,936: Parsing model.agency_data_pipeline.agg_transaction_line_item_type
2018-04-17 13:44:41,939: Parsing model.agency_data_pipeline.agg_transaction_order_number
2018-04-17 13:44:41,941: Parsing model.agency_data_pipeline.agg_transaction_product_type
2018-04-17 13:44:41,943: Parsing model.agency_data_pipeline.customers_by_transaction
2018-04-17 13:44:41,945: Parsing model.agency_data_pipeline.growth_customer_0_365
2018-04-17 13:44:41,948: Parsing model.agency_data_pipeline.growth_customer_0_365_segment
2018-04-17 13:44:41,952: Parsing model.agency_data_pipeline.growth_date_union
2018-04-17 13:44:41,955: Parsing model.agency_data_pipeline.growth_stats
2018-04-17 13:44:41,961: Parsing model.agency_data_pipeline.retention_0_365
2018-04-17 13:44:41,964: Parsing model.agency_data_pipeline.retention_0_365_new
2018-04-17 13:44:41,967: Parsing model.agency_data_pipeline.retention_0_365_reactivated
2018-04-17 13:44:41,970: Parsing model.agency_data_pipeline.retention_0_365_rebuy
2018-04-17 13:44:41,973: Parsing model.agency_data_pipeline.retention_365_730
2018-04-17 13:44:41,976: Parsing model.agency_data_pipeline.retention_730_plus
2018-04-17 13:44:41,979: Parsing model.agency_data_pipeline.retention_stats
2018-04-17 13:44:41,986: Parsing model.agency_data_pipeline.retention_stats_rebuy_rate
2018-04-17 13:44:41,989: Parsing model.agency_data_pipeline.retention_0_30
2018-04-17 13:44:41,991: Parsing model.agency_data_pipeline.retention_0_30_new
2018-04-17 13:44:41,994: Parsing model.agency_data_pipeline.retention_0_30_reactivated
2018-04-17 13:44:41,997: Parsing model.agency_data_pipeline.retention_0_30_rebuy
2018-04-17 13:44:42,000: Parsing model.agency_data_pipeline.retention_30_60
2018-04-17 13:44:42,002: Parsing model.agency_data_pipeline.retention_60_plus
2018-04-17 13:44:42,005: Parsing model.agency_data_pipeline.retention_stats_month
2018-04-17 13:44:42,011: Parsing model.agency_data_pipeline.retention_stats_rebuy_rate_month
2018-04-17 13:44:42,014: Parsing model.agency_data_pipeline.customers_first_purchase_proc
2018-04-17 13:44:42,016: Parsing model.agency_data_pipeline.customers_proc
2018-04-17 13:44:42,019: Parsing model.agency_data_pipeline.segment_list_customers
2018-04-17 13:44:42,022: Parsing model.agency_data_pipeline.segment_proc_customers
2018-04-17 13:44:42,024: Parsing model.agency_data_pipeline.segment_stats_customers
2018-04-17 13:44:42,027: Parsing model.agency_data_pipeline.segment_stats_customers_agg
2018-04-17 13:44:42,030: Parsing model.agency_data_pipeline.customers_first_purchase_product_type_proc
2018-04-17 13:44:42,032: Parsing model.agency_data_pipeline.customers_products_proc
2018-04-17 13:44:42,036: Parsing model.agency_data_pipeline.segment_list_customers_products
2018-04-17 13:44:42,038: Parsing model.agency_data_pipeline.segment_proc_customers_products
2018-04-17 13:44:42,041: Parsing model.agency_data_pipeline.segment_stats_customers_products
2018-04-17 13:44:42,044: Parsing model.agency_data_pipeline.segment_stats_customers_products_agg
2018-04-17 13:44:42,047: Parsing model.agency_data_pipeline.frequency_proc
2018-04-17 13:44:42,050: Parsing model.agency_data_pipeline.frequency_stats
2018-04-17 13:44:42,053: Parsing model.agency_data_pipeline.order_paths_agg
2018-04-17 13:44:42,058: Parsing model.agency_data_pipeline.order_paths_proc
2018-04-17 13:44:42,064: Parsing model.agency_data_pipeline.order_paths_stats
2018-04-17 13:44:42,068: Parsing model.agency_data_pipeline.products_proc
2018-04-17 13:44:42,070: Parsing model.agency_data_pipeline.segment_proc_sku
2018-04-17 13:44:42,073: Parsing model.agency_data_pipeline.segment_stats_category
2018-04-17 13:44:42,076: Parsing model.agency_data_pipeline.segment_stats_sku
2018-04-17 13:44:42,110: Found 91 models, 0 tests, 0 archives, 0 analyses, 46 macros, 0 operations
2018-04-17 13:44:42,197: 
2018-04-17 13:44:42,969: 13:44:42 | Concurrency: 4 threads (target='prod')
2018-04-17 13:44:42,969: 13:44:42 | 
2018-04-17 13:44:43,848: 13:44:43 | 1 of 91 START table model agency_data_pipeline.adwords_conversions... [RUN]
2018-04-17 13:44:43,849: Compiling model.agency_data_pipeline.adwords_conversions
2018-04-17 13:44:43,854: Writing injected SQL for node "model.agency_data_pipeline.adwords_conversions"
2018-04-17 13:44:43,848: 13:44:43 | 2 of 91 START table model agency_data_pipeline.conversion_goals_proc. [RUN]
2018-04-17 13:44:43,854: Compiling model.agency_data_pipeline.conversion_goals_proc
2018-04-17 13:44:43,848: 13:44:43 | 3 of 91 START table model agency_data_pipeline.accounts_proc......... [RUN]
2018-04-17 13:44:43,860: Writing injected SQL for node "model.agency_data_pipeline.conversion_goals_proc"
2018-04-17 13:44:43,848: 13:44:43 | 4 of 91 START table model agency_data_pipeline.carts_proc............ [RUN]
2018-04-17 13:44:43,860: Compiling model.agency_data_pipeline.accounts_proc
2018-04-17 13:44:43,861: Acquiring new bigquery connection "adwords_conversions".
2018-04-17 13:44:43,861: Compiling model.agency_data_pipeline.carts_proc
2018-04-17 13:44:43,867: Writing injected SQL for node "model.agency_data_pipeline.accounts_proc"
2018-04-17 13:44:43,867: Opening a new connection (1 currently allocated)
2018-04-17 13:44:43,868: Acquiring new bigquery connection "conversion_goals_proc".
2018-04-17 13:44:43,875: Writing injected SQL for node "model.agency_data_pipeline.carts_proc"
2018-04-17 13:44:43,881: Acquiring new bigquery connection "accounts_proc".
2018-04-17 13:44:43,881: Opening a new connection (2 currently allocated)
2018-04-17 13:44:43,939: Acquiring new bigquery connection "carts_proc".
2018-04-17 13:44:43,944: Opening a new connection (3 currently allocated)
2018-04-17 13:44:43,948: Opening a new connection (4 currently allocated)
2018-04-17 13:44:45,594: Model SQL (conversion_goals_proc):
select 
client,
platform,
goal_name,
max(goal_type) goal_type,
account,
max(time_of_entry) time_of_entry
from  ( 

SELECT  
client,
platform,
trim(replace(replace(lower(goal_name),',',''),' ','')) goal_name,
goal_type,
account,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY platform ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.conversion_goals` 

) 

WHERE lv = time_of_entry
group by client, platform, account, goal_name
2018-04-17 13:44:45,669: Model SQL (adwords_conversions):
select 
client,
client_name,
platform,
goal_name,
goal_type,
account,
time_of_entry
from  ( 

SELECT  
client,
client_name,
platform,
trim(lower(goal_name)) goal_name,
goal_type,
account,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform, goal_name ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.conversion_goals` 
WHERE platform = 'Adwords'

) 

WHERE lv = time_of_entry
2018-04-17 13:44:45,703: Model SQL (carts_proc):
select 
client,
client_name,
account,
platform
from  ( 

SELECT  
client,
client_name,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.accounts`
WHERE platform in ('Shopify', 'Custom cart')

) 

WHERE lv = time_of_entry
2018-04-17 13:44:45,715: Model SQL (accounts_proc):
select 
client,
account,
platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.accounts` 

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-04-17 13:44:46,703: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2effd47e-fd7e-44de-bdf9-6237101ffa23', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ae69d68>]}
2018-04-17 13:44:46,933: 13:44:46 | 2 of 91 OK created table model agency_data_pipeline.conversion_goals_proc [CREATE TABLE in 2.85s]
2018-04-17 13:44:46,934: 13:44:46 | 5 of 91 START table model agency_data_pipeline.monthend_dates........ [RUN]
2018-04-17 13:44:46,934: Compiling model.agency_data_pipeline.monthend_dates
2018-04-17 13:44:46,939: Writing injected SQL for node "model.agency_data_pipeline.monthend_dates"
2018-04-17 13:44:46,942: Acquiring new bigquery connection "monthend_dates".
2018-04-17 13:44:46,942: Re-using an available connection from the pool.
2018-04-17 13:44:47,828: Model SQL (monthend_dates):
SELECT
date_in_range,
date_in_range_bom,
date_in_range_bom_mom,
unix_date_in_range,
unix_date_in_range_bom,
unix_date(date_in_range_bom_mom) unix_date_in_range_bom_mom,
yyyymm,
date_in_range_yoy,
unix_date(date_in_range_yoy) unix_date_in_range_yoy

FROM
(
	SELECT 
	date_in_range,
	date_in_range_bom,
	date_sub(date_in_range_bom, INTERVAL 1 MONTH) date_in_range_bom_mom,
  date_sub(date_in_range, INTERVAL 1 YEAR) date_in_range_yoy,
	unix_date_in_range,
	unix_date(date_in_range_bom) unix_date_in_range_bom,
	yyyymm,
	first_value(date_in_range) over (partition by yyyymm order by date_in_range desc) monthend_date_in_range
	FROM
	( 
		SELECT 
		date_in_range,
		date_trunc( date_in_range, MONTH) date_in_range_bom,
		unix_date(date_in_range) unix_date_in_range,
		format_date("%Y-%m", date_in_range) AS yyyymm
		FROM UNNEST(
		    GENERATE_DATE_ARRAY(DATE('2016-01-31'), CURRENT_DATE(), INTERVAL 1 DAY)
		) AS date_in_range
	)
)
where date_in_range = monthend_date_in_range
2018-04-17 13:44:47,938: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2effd47e-fd7e-44de-bdf9-6237101ffa23', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10aec0a90>]}
2018-04-17 13:44:47,973: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2effd47e-fd7e-44de-bdf9-6237101ffa23', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10aec0470>]}
2018-04-17 13:44:47,994: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2effd47e-fd7e-44de-bdf9-6237101ffa23', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10adf2e80>]}
2018-04-17 13:44:48,179: 13:44:48 | 1 of 91 OK created table model agency_data_pipeline.adwords_conversions [CREATE TABLE in 4.09s]
2018-04-17 13:44:48,180: 13:44:48 | 6 of 91 START table model agency_data_pipeline.adwords_campaigns..... [RUN]
2018-04-17 13:44:48,183: Compiling model.agency_data_pipeline.adwords_campaigns
2018-04-17 13:44:48,190: Writing injected SQL for node "model.agency_data_pipeline.adwords_campaigns"
2018-04-17 13:44:48,192: Acquiring new bigquery connection "adwords_campaigns".
2018-04-17 13:44:48,192: Re-using an available connection from the pool.
2018-04-17 13:44:48,419: 13:44:48 | 3 of 91 OK created table model agency_data_pipeline.accounts_proc.... [CREATE TABLE in 4.11s]
2018-04-17 13:44:48,420: 13:44:48 | 7 of 91 START table model agency_data_pipeline.adwords_urls.......... [RUN]
2018-04-17 13:44:48,422: Compiling model.agency_data_pipeline.adwords_urls
2018-04-17 13:44:48,426: Writing injected SQL for node "model.agency_data_pipeline.adwords_urls"
2018-04-17 13:44:48,428: Acquiring new bigquery connection "adwords_urls".
2018-04-17 13:44:48,428: Re-using an available connection from the pool.
2018-04-17 13:44:48,672: 13:44:48 | 4 of 91 OK created table model agency_data_pipeline.carts_proc....... [CREATE TABLE in 4.13s]
2018-04-17 13:44:48,673: 13:44:48 | 8 of 91 START table model agency_data_pipeline.all_dates............. [RUN]
2018-04-17 13:44:48,674: Compiling model.agency_data_pipeline.all_dates
2018-04-17 13:44:48,678: Writing injected SQL for node "model.agency_data_pipeline.all_dates"
2018-04-17 13:44:48,679: Acquiring new bigquery connection "all_dates".
2018-04-17 13:44:48,679: Re-using an available connection from the pool.
2018-04-17 13:44:48,957: Model SQL (adwords_campaigns):
select
day,
campaignid, 
campaign,
account, 
channel,
platform,
sum(cost) cost,
sum(impressions) impressions,
sum(clicks) clicks,
sum(impression_share_num) impression_share_num,
sum(impression_share_den) impression_share_den
from 
  ( 
	SELECT  
	day,
	campaignid,
	campaign,
	account as account,
	'Paid' as channel,
	'Adwords' as platform,
	cost/1000000 cost, 
	impressions as impressions, 
	clicks, 
	case when searchimprshare is not null then impressions end as impression_share_num,
	case when searchimprshare is not null then impressions/(searchimprshare/100) end as impression_share_den,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY campaignid, day ORDER BY _sdc_sequence DESC) lv
	FROM `growth-engines-pipeline.adwords_2.CAMPAIGN_PERFORMANCE_REPORT`
  )
where lv = _sdc_sequence
group by day, campaignid, account, channel, platform, campaign
2018-04-17 13:44:49,120: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2effd47e-fd7e-44de-bdf9-6237101ffa23', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ae69d68>]}
2018-04-17 13:44:49,245: Model SQL (adwords_urls):
SELECT
campaignid,
lower(trim(regexp_replace(replace(replace(replace(replace(finalurl,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url

FROM (

SELECT  
campaignid,
finalurl,
first_value(finalurl) OVER (PARTITION BY campaignid ORDER BY day DESC) lv
FROM `growth-engines-pipeline.adwords_2.FINAL_URL_REPORT`
)

WHERE lv = finalurl
group by campaignid, url
order by campaignid asc
2018-04-17 13:44:49,396: 13:44:49 | 5 of 91 OK created table model agency_data_pipeline.monthend_dates... [CREATE TABLE in 2.19s]
2018-04-17 13:44:49,397: 13:44:49 | 9 of 91 START table model agency_data_pipeline.ga_conversions........ [RUN]
2018-04-17 13:44:49,397: Compiling model.agency_data_pipeline.ga_conversions
2018-04-17 13:44:49,404: Writing injected SQL for node "model.agency_data_pipeline.ga_conversions"
2018-04-17 13:44:49,407: Acquiring new bigquery connection "ga_conversions".
2018-04-17 13:44:49,407: Re-using an available connection from the pool.
2018-04-17 13:44:49,492: Model SQL (all_dates):
SELECT 
date_in_range,
unix_date(date_in_range) unix_date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-04-17 13:44:50,242: Model SQL (ga_conversions):
select 
client,
client_name,
platform,
goal_name,
goal_type,
account,
time_of_entry
from  ( 

SELECT  
client,
client_name,
platform,
trim(goal_name) goal_name,
goal_type,
account,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform, goal_name ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.conversion_goals` 
WHERE platform = 'Google Analytics'

) 

WHERE lv = time_of_entry
2018-04-17 13:44:50,609: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2effd47e-fd7e-44de-bdf9-6237101ffa23', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10adf2e80>]}
2018-04-17 13:44:50,968: 13:44:50 | 8 of 91 OK created table model agency_data_pipeline.all_dates........ [CREATE TABLE in 1.94s]
2018-04-17 13:44:50,968: 13:44:50 | 10 of 91 START table model agency_data_pipeline.bing_ads_impression_share [RUN]
2018-04-17 13:44:50,968: Compiling model.agency_data_pipeline.bing_ads_impression_share
2018-04-17 13:44:50,974: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_impression_share"
2018-04-17 13:44:50,977: Acquiring new bigquery connection "bing_ads_impression_share".
2018-04-17 13:44:50,977: Re-using an available connection from the pool.
2018-04-17 13:44:51,536: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2effd47e-fd7e-44de-bdf9-6237101ffa23', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ae69d68>]}
2018-04-17 13:44:51,653: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2effd47e-fd7e-44de-bdf9-6237101ffa23', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10aeab080>]}
2018-04-17 13:44:51,768: 13:44:51 | 9 of 91 OK created table model agency_data_pipeline.ga_conversions... [CREATE TABLE in 2.14s]
2018-04-17 13:44:51,770: 13:44:51 | 11 of 91 START table model agency_data_pipeline.bing_ads_ads......... [RUN]
2018-04-17 13:44:51,771: Compiling model.agency_data_pipeline.bing_ads_ads
2018-04-17 13:44:51,780: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_ads"
2018-04-17 13:44:51,781: Model SQL (bing_ads_impression_share):
SELECT 
date, 
account,
channel,
platform,
sum(impressions) impressions,
sum(available_impressions) available_impressions
FROM

(

SELECT  
cast(gregoriandate as date) date,
replace(accountname,',','') account,  
'Paid' as channel,
'Bing Ads' as platform,
case when impressionsharepercent is null then 0 else impressions end as impressions,
cast(round(case when ( impressionsharepercent is not null and impressionsharepercent > 0 ) then (impressions*100)/impressionsharepercent else 0 end) as int64) as available_impressions,
_sdc_sequence,
first_value(_sdc_sequence) OVER (PARTITION BY campaignid, gregoriandate ORDER BY _sdc_sequence DESC) lv
FROM `growth-engines-pipeline.bing_ads.campaign_performance_report` 

)

where lv = _sdc_sequence
group by date, account, channel, platform
2018-04-17 13:44:51,782: Acquiring new bigquery connection "bing_ads_ads".
2018-04-17 13:44:51,782: Re-using an available connection from the pool.
2018-04-17 13:44:52,007: 13:44:52 | 7 of 91 OK created table model agency_data_pipeline.adwords_urls..... [CREATE TABLE in 3.23s]
2018-04-17 13:44:52,008: 13:44:52 | 12 of 91 START table model agency_data_pipeline.clients_proc......... [RUN]
2018-04-17 13:44:52,009: Compiling model.agency_data_pipeline.clients_proc
2018-04-17 13:44:52,017: Writing injected SQL for node "model.agency_data_pipeline.clients_proc"
2018-04-17 13:44:52,019: Acquiring new bigquery connection "clients_proc".
2018-04-17 13:44:52,019: Re-using an available connection from the pool.
2018-04-17 13:44:52,792: Model SQL (bing_ads_ads):
select
date, 
account, 
channel,
platform,
campaignid,
campaignname,
max(lower(trim(replace(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$','' ),'.html',''),'/'))) as url,
utm_campaign,
sum(cost) as cost,
sum(impressions) as impressions,
sum(clicks) as clicks,
sum(conversions) as conversions
from 
  ( 
SELECT  
cast(gregoriandate as date) date,
replace(accountname,',','') account,
'Paid' as channel,
'Bing Ads' as platform,
adid,
adtype,
campaignid, 
campaignname,
finalurl url,
case when regexp_contains(destinationurl, 'utm_campaign')
	then replace(lower(nullif(
  

    split(
        
  

    split(
        destinationurl,
        'utm_campaign='
        )[offset(1)]


,
        '&'
        )[offset(0)]


,'')),'+',' ') 
	else null end as utm_campaign,
spend cost, 
impressions, 
clicks, 
conversions,
_sdc_sequence,
first_value(_sdc_sequence) OVER (PARTITION BY adid, gregoriandate ORDER BY _sdc_sequence DESC) lv
FROM `growth-engines-pipeline.bing_ads.ad_performance_report` 
  )

where lv = _sdc_sequence
group by date, account, channel, platform, campaignid, campaignname, utm_campaign
2018-04-17 13:44:52,838: Model SQL (clients_proc):
select 
client,
client_name,
account,
platform
from  ( 

SELECT  
client,
client_name,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.accounts`
where client_name != ''
) 

WHERE lv = time_of_entry
2018-04-17 13:44:53,951: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2effd47e-fd7e-44de-bdf9-6237101ffa23', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10aeab080>]}
2018-04-17 13:44:54,079: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2effd47e-fd7e-44de-bdf9-6237101ffa23', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10adf2e80>]}
2018-04-17 13:44:54,244: 13:44:54 | 12 of 91 OK created table model agency_data_pipeline.clients_proc.... [CREATE TABLE in 1.94s]
2018-04-17 13:44:54,475: 13:44:54 | 10 of 91 OK created table model agency_data_pipeline.bing_ads_impression_share [CREATE TABLE in 3.11s]
2018-04-17 13:44:54,654: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2effd47e-fd7e-44de-bdf9-6237101ffa23', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ae01588>]}
2018-04-17 13:44:54,904: 13:44:54 | 6 of 91 OK created table model agency_data_pipeline.adwords_campaigns [CREATE TABLE in 6.47s]
2018-04-17 13:44:55,067: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2effd47e-fd7e-44de-bdf9-6237101ffa23', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ae69d68>]}
2018-04-17 13:44:55,305: 13:44:55 | 11 of 91 OK created table model agency_data_pipeline.bing_ads_ads.... [CREATE TABLE in 3.30s]
2018-04-17 13:44:55,306: 13:44:55 | 13 of 91 START table model agency_data_pipeline.adwords_ads.......... [RUN]
2018-04-17 13:44:55,307: Compiling model.agency_data_pipeline.adwords_ads
2018-04-17 13:44:55,306: 13:44:55 | 14 of 91 START table model agency_data_pipeline.fb_adcreative........ [RUN]
2018-04-17 13:44:55,312: Compiling model.agency_data_pipeline.fb_adcreative
2018-04-17 13:44:55,324: Writing injected SQL for node "model.agency_data_pipeline.adwords_ads"
2018-04-17 13:44:55,306: 13:44:55 | 15 of 91 START table model agency_data_pipeline.fb_ads_insights...... [RUN]
2018-04-17 13:44:55,325: Compiling model.agency_data_pipeline.fb_ads_insights
2018-04-17 13:44:55,333: Acquiring new bigquery connection "fb_adcreative".
2018-04-17 13:44:55,333: Re-using an available connection from the pool.
2018-04-17 13:44:55,333: Fetching data for query fb_adcreative:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 13:44:55,336: Acquiring new bigquery connection "fb_ads_insights".
2018-04-17 13:44:55,336: Re-using an available connection from the pool.
2018-04-17 13:44:55,336: Fetching data for query fb_ads_insights:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 13:44:55,307: 13:44:55 | 16 of 91 START table model agency_data_pipeline.bing_ads_conversions. [RUN]
2018-04-17 13:44:55,341: Compiling model.agency_data_pipeline.bing_ads_conversions
2018-04-17 13:44:55,342: Acquiring new bigquery connection "adwords_ads".
2018-04-17 13:44:55,353: Re-using an available connection from the pool.
2018-04-17 13:44:55,355: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_conversions"
2018-04-17 13:44:55,359: Acquiring new bigquery connection "bing_ads_conversions".
2018-04-17 13:44:55,360: Re-using an available connection from the pool.
2018-04-17 13:44:56,396: Model SQL (bing_ads_conversions):
SELECT
date, 
a.account account, 
a.channel channel,
a.platform platform,
campaignid,
campaignname,
sum( case when b.goal_type = 'Transactions' then conversions else 0 end ) as transactions
FROM

  ( 
SELECT  
cast(gregoriandate as date) date,
replace(accountname,',','') account,
'Paid' as channel,
'Bing Ads' as platform,
trim(replace(replace(lower(goal),',',''),' ','')) goal,
goalid,
campaignid,
campaignname,
conversions,
_sdc_sequence,
first_value(_sdc_sequence) OVER (PARTITION BY campaignid, goalid, gregoriandate ORDER BY _sdc_sequence DESC) lv
FROM `growth-engines-pipeline.bing_ads.goals_and_funnels_report` 

  ) a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`conversion_goals_proc` b
ON (
	a.account = b.account AND
	a.platform = b.platform AND
	a.goal = b.goal_name
)
where a.lv = a._sdc_sequence
group by date, account, channel, platform, campaignid, campaignname
2018-04-17 13:44:56,413: Model SQL (adwords_ads):
SELECT  
day,
campaignid,
a.account as account,
utm_campaign,
sum( case when b.goal_type = 'Transaction' then conversions else 0 end ) as transactions
FROM (

	SELECT  
	day,
	adid,
	campaignid,
	account,
	lower(conversionname) conversionname,
	conversions,
	lower(campaign) utm_campaign,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY campaignid, day ORDER BY _sdc_sequence DESC) lv
	FROM
	`growth-engines-pipeline.adwords_2.AD_PERFORMANCE_REPORT`

) a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_conversions` b
ON ( a.conversionname = b.goal_name
	AND a.account = b.account )
WHERE lv = _sdc_sequence
group by day, campaignid, account, utm_campaign
2018-04-17 13:44:56,506: Writing injected SQL for node "model.agency_data_pipeline.fb_adcreative"
2018-04-17 13:44:56,625: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_insights"
2018-04-17 13:44:57,302: Model SQL (fb_adcreative):




with fb_adcreative as (


	    
		   	SELECT 
			id,
			object_url,
			url_tags,
			_sdc_sequence
			FROM `growth-engines-pipeline.fb_ads_luca_danni.adcreative`
		    
	   
)

select creative_id, max(url) url
from (
  select
  id creative_id,
  lower(trim(regexp_replace(replace(replace(replace(replace(object_url,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
  first_value(_sdc_sequence) OVER (PARTITION BY id ORDER BY _sdc_sequence DESC) lv,
  _sdc_sequence
  from fb_adcreative
  )
where lv = _sdc_sequence
group by creative_id


2018-04-17 13:44:57,462: Model SQL (fb_ads_insights):




with fb_ads_insights as (

	    
		   	SELECT 
			date_start,
			campaign_id,
			campaign_name,
			ad_id,
			account_name,
			spend,
			reach,
			inline_link_clicks,
			_sdc_sequence,
			first_value(_sdc_sequence) OVER (PARTITION BY date_start, ad_id, campaign_id ORDER BY _sdc_sequence DESC) lv
			FROM `growth-engines-pipeline.fb_ads_luca_danni.ads_insights`
		    
	   

)

select
date_start date,
campaign_id,
campaign_name campaign,
ad_id,
account_name account,
max(spend) cost,
max(reach) impressions,
max(inline_link_clicks) clicks
from fb_ads_insights
where lv = _sdc_sequence
group by date, campaign_id, ad_id, account, campaign


2018-04-17 13:44:58,663: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2effd47e-fd7e-44de-bdf9-6237101ffa23', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d286080>]}
2018-04-17 13:44:58,699: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2effd47e-fd7e-44de-bdf9-6237101ffa23', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10af10a90>]}
2018-04-17 13:44:58,894: 13:44:58 | 16 of 91 OK created table model agency_data_pipeline.bing_ads_conversions [CREATE TABLE in 3.32s]
2018-04-17 13:44:58,896: 13:44:58 | 17 of 91 START table model agency_data_pipeline.shopify_refunds_proc. [RUN]
2018-04-17 13:44:58,899: Compiling model.agency_data_pipeline.shopify_refunds_proc
2018-04-17 13:44:58,913: Acquiring new bigquery connection "shopify_refunds_proc".
2018-04-17 13:44:58,914: Re-using an available connection from the pool.
2018-04-17 13:44:58,914: Fetching data for query shopify_refunds_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 13:44:59,283: 13:44:59 | 13 of 91 OK created table model agency_data_pipeline.adwords_ads..... [CREATE TABLE in 3.39s]
2018-04-17 13:44:59,284: 13:44:59 | 18 of 91 START table model agency_data_pipeline.mappings_ga_proc..... [RUN]
2018-04-17 13:44:59,285: Compiling model.agency_data_pipeline.mappings_ga_proc
2018-04-17 13:44:59,292: Writing injected SQL for node "model.agency_data_pipeline.mappings_ga_proc"
2018-04-17 13:44:59,292: Acquiring new bigquery connection "mappings_ga_proc".
2018-04-17 13:44:59,293: Re-using an available connection from the pool.
2018-04-17 13:44:59,708: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2effd47e-fd7e-44de-bdf9-6237101ffa23', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d23d630>]}
2018-04-17 13:44:59,746: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2effd47e-fd7e-44de-bdf9-6237101ffa23', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10aef35c0>]}
2018-04-17 13:45:00,117: Model SQL (mappings_ga_proc):
select 
client,
account,
client_name,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
account,
client_name,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.mappings_ga` 

) 

WHERE lv = time_of_entry
and client in (select client from `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc` )
group by client, account, client_name, source, medium, platform_n, channel_n, time_of_entry
2018-04-17 13:45:00,243: 13:45:00 | 14 of 91 OK created table model agency_data_pipeline.fb_adcreative... [CREATE TABLE in 4.40s]
2018-04-17 13:45:00,245: 13:45:00 | 19 of 91 START table model agency_data_pipeline.ga_mcf_proc.......... [RUN]
2018-04-17 13:45:00,248: Compiling model.agency_data_pipeline.ga_mcf_proc
2018-04-17 13:45:00,261: Writing injected SQL for node "model.agency_data_pipeline.ga_mcf_proc"
2018-04-17 13:45:00,269: Writing injected SQL for node "model.agency_data_pipeline.shopify_refunds_proc"
2018-04-17 13:45:00,274: Acquiring new bigquery connection "ga_mcf_proc".
2018-04-17 13:45:00,274: Re-using an available connection from the pool.
2018-04-17 13:45:00,749: 13:45:00 | 15 of 91 OK created table model agency_data_pipeline.fb_ads_insights. [CREATE TABLE in 4.42s]
2018-04-17 13:45:00,750: 13:45:00 | 20 of 91 START table model agency_data_pipeline.fb_ads_insights_conversions [RUN]
2018-04-17 13:45:00,750: Compiling model.agency_data_pipeline.fb_ads_insights_conversions
2018-04-17 13:45:00,760: Acquiring new bigquery connection "fb_ads_insights_conversions".
2018-04-17 13:45:00,761: Re-using an available connection from the pool.
2018-04-17 13:45:00,761: Fetching data for query fb_ads_insights_conversions:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 13:45:01,134: Model SQL (ga_mcf_proc):
SELECT 
date,
account,
'Google Analytics' as lookup_platform,
source_medium_path,
trim(lower(split(split(source_medium_path,'->')[SAFE_ORDINAL(1)],'/')[SAFE_ORDINAL(1)])) as source,
trim(lower(split(split(source_medium_path,'->')[SAFE_ORDINAL(1)],'/')[SAFE_ORDINAL(2)])) as medium,
first_interaction_campaign campaign,
cast(regexp_replace(transaction_id, r'#', '') as int64) transactionid,
max(first_interaction_conversions) transactions,
max(first_interaction_conversion_value) revenue
FROM `growth-engines-pipeline.agency_data_pipeline.ga_mcf`
where account in (select account from `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc` where platform = 'Google Analytics')
group by date, account, source, medium, campaign, source_medium_path, lookup_platform, transactionid
2018-04-17 13:45:01,158: Model SQL (shopify_refunds_proc):




with refunds as (

	
	SELECT
	order_number,
	checkout_id,
	financial_status,
	line_item_id,
	quantity,
	subtotal,
	line_item.variant_id variant_id,
	line_item.id refund_id,
 	_sdc_sequence
	FROM `growth-engines-pipeline.shopify_lucadanni.orders` 
	cross join unnest(refunds), unnest(refund_line_items)
  	where financial_status like '%refund%'
	
	

)

SELECT * 
FROM 
	(
    SELECT
	order_number,
	checkout_id,
	financial_status,
	line_item_id,
	quantity,
	subtotal refund_amount,
	variant_id,
	refund_id,
 	_sdc_sequence,
    first_value(_sdc_sequence) OVER (PARTITION BY order_number, line_item_id ORDER BY _sdc_sequence DESC) lv
    FROM refunds
   	) 
WHERE lv = _sdc_sequence


2018-04-17 13:45:01,247: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_insights_conversions"
2018-04-17 13:45:02,273: Model SQL (fb_ads_insights_conversions):




with fb_ads_insights_conversions as (

	    
		   	SELECT 
			date_start,
			campaign_id,
			campaign_name,
			ad_id,
			account_name,
			spend,
			reach,
			inline_link_clicks,
			_sdc_sequence,
			action_type,
			value
			FROM `growth-engines-pipeline.fb_ads_luca_danni.ads_insights`
			cross join unnest(actions)
		    
	   

)

SELECT * 
FROM 
	(
    SELECT
    date_start date,
    campaign_id,
    campaign_name campaign,
    ad_id,
    account_name account,
    action_type,
    value conversions,
    first_value(_sdc_sequence) OVER (PARTITION BY ad_id, date_start ORDER BY _sdc_sequence DESC) lv,
    _sdc_sequence
    FROM fb_ads_insights_conversions
   	)
where lv = _sdc_sequence
and action_type like '%purchase%'


2018-04-17 13:45:02,393: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2effd47e-fd7e-44de-bdf9-6237101ffa23', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10af10a90>]}
2018-04-17 13:45:02,660: 13:45:02 | 18 of 91 OK created table model agency_data_pipeline.mappings_ga_proc [CREATE TABLE in 3.11s]
2018-04-17 13:45:03,503: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2effd47e-fd7e-44de-bdf9-6237101ffa23', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10aea3550>]}
2018-04-17 13:45:03,765: 13:45:03 | 17 of 91 OK created table model agency_data_pipeline.shopify_refunds_proc [CREATE TABLE in 4.60s]
2018-04-17 13:45:05,649: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2effd47e-fd7e-44de-bdf9-6237101ffa23', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d29b6a0>]}
2018-04-17 13:45:05,883: 13:45:05 | 19 of 91 OK created table model agency_data_pipeline.ga_mcf_proc..... [CREATE TABLE in 5.40s]
2018-04-17 13:45:07,010: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2effd47e-fd7e-44de-bdf9-6237101ffa23', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10aef35c0>]}
2018-04-17 13:45:07,317: 13:45:07 | 20 of 91 OK created table model agency_data_pipeline.fb_ads_insights_conversions [CREATE TABLE in 6.26s]
2018-04-17 13:45:07,318: 13:45:07 | 21 of 91 START table model agency_data_pipeline.fb_ads............... [RUN]
2018-04-17 13:45:07,319: Compiling model.agency_data_pipeline.fb_ads
2018-04-17 13:45:07,319: 13:45:07 | 22 of 91 START table model agency_data_pipeline.shopify_customers_proc [RUN]
2018-04-17 13:45:07,332: Compiling model.agency_data_pipeline.shopify_customers_proc
2018-04-17 13:45:07,341: Acquiring new bigquery connection "fb_ads".
2018-04-17 13:45:07,346: Acquiring new bigquery connection "shopify_customers_proc".
2018-04-17 13:45:07,346: Re-using an available connection from the pool.
2018-04-17 13:45:07,347: Fetching data for query fb_ads:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 13:45:07,347: Re-using an available connection from the pool.
2018-04-17 13:45:07,347: Fetching data for query shopify_customers_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 13:45:07,765: Writing injected SQL for node "model.agency_data_pipeline.fb_ads"
2018-04-17 13:45:07,813: Writing injected SQL for node "model.agency_data_pipeline.shopify_customers_proc"
2018-04-17 13:45:08,789: Model SQL (shopify_customers_proc):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc`





with customers as (

	
	SELECT
	'lucadanni' client_name,
	'Shopify' as lookup_platform,
	cast(created_at as date) created_at,
	id,
	first_name,
	last_name,
	email,
	_sdc_sequence,
	first_value(_sdc_sequence) over (partition by id, _sdc_sequence order by _sdc_sequence desc) lv
	FROM `growth-engines-pipeline.shopify_lucadanni.customers` 
	
	

)

SELECT
account,
client,
platform,
id,
min(created_at) created_at,
max(first_name) first_name,
max(last_name) last_name,
max(email) email
FROM (
	SELECT
	b.account,
	b.client,
	b.platform,
	created_at,
	id,
	first_name,
	last_name,
	email
	FROM customers a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
	ON ( a.client_name = b.client_name
	  AND a.lookup_platform = b.platform )
	where a.lv = a._sdc_sequence
)
group by account, client, platform, id

2018-04-17 13:45:08,823: Model SQL (fb_ads):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`fb_adcreative`





with fb_ads as (

	    
		   	SELECT 
			id ad_id,
			creative.creative_id creative_id,
			_sdc_sequence
			FROM `growth-engines-pipeline.fb_ads_luca_danni.ads`
		     
	   

)

SELECT
a.ad_id,
b.creative_id,
b.url
FROM (
    SELECT
    ad_id,
    creative_id,
    first_value(_sdc_sequence) OVER (PARTITION BY ad_id ORDER BY _sdc_sequence DESC) lv,
    _sdc_sequence
    FROM fb_ads
    ) a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`fb_adcreative` b
ON (
	a.creative_id = b.creative_id 
)
WHERE a.lv = a._sdc_sequence


2018-04-17 13:45:11,088: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2effd47e-fd7e-44de-bdf9-6237101ffa23', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ae69d68>]}
2018-04-17 13:45:11,433: 13:45:11 | 21 of 91 OK created table model agency_data_pipeline.fb_ads.......... [CREATE TABLE in 3.77s]
2018-04-17 13:45:14,422: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2effd47e-fd7e-44de-bdf9-6237101ffa23', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10aea3550>]}
2018-04-17 13:45:14,656: 13:45:14 | 22 of 91 OK created table model agency_data_pipeline.shopify_customers_proc [CREATE TABLE in 7.09s]
2018-04-17 13:45:14,657: 13:45:14 | 23 of 91 START table model agency_data_pipeline.shopify_orders_proc.. [RUN]
2018-04-17 13:45:14,658: Compiling model.agency_data_pipeline.shopify_orders_proc
2018-04-17 13:45:14,657: 13:45:14 | 24 of 91 START table model agency_data_pipeline.ga_mcf_stats......... [RUN]
2018-04-17 13:45:14,668: Acquiring new bigquery connection "shopify_orders_proc".
2018-04-17 13:45:14,668: Compiling model.agency_data_pipeline.ga_mcf_stats
2018-04-17 13:45:14,658: 13:45:14 | 25 of 91 START table model agency_data_pipeline.shopify_products_proc [RUN]
2018-04-17 13:45:14,658: 13:45:14 | 26 of 91 START table model agency_data_pipeline.agg_customers_union.. [RUN]
2018-04-17 13:45:14,669: Re-using an available connection from the pool.
2018-04-17 13:45:14,676: Writing injected SQL for node "model.agency_data_pipeline.ga_mcf_stats"
2018-04-17 13:45:14,676: Compiling model.agency_data_pipeline.shopify_products_proc
2018-04-17 13:45:14,676: Compiling model.agency_data_pipeline.agg_customers_union
2018-04-17 13:45:14,676: Fetching data for query shopify_orders_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 13:45:14,684: Acquiring new bigquery connection "shopify_products_proc".
2018-04-17 13:45:14,692: Writing injected SQL for node "model.agency_data_pipeline.agg_customers_union"
2018-04-17 13:45:14,693: Acquiring new bigquery connection "ga_mcf_stats".
2018-04-17 13:45:14,693: Re-using an available connection from the pool.
2018-04-17 13:45:14,696: Fetching data for query shopify_products_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 13:45:14,702: Re-using an available connection from the pool.
2018-04-17 13:45:14,710: Acquiring new bigquery connection "agg_customers_union".
2018-04-17 13:45:14,711: Re-using an available connection from the pool.
2018-04-17 13:45:15,117: Writing injected SQL for node "model.agency_data_pipeline.shopify_products_proc"
2018-04-17 13:45:15,126: Writing injected SQL for node "model.agency_data_pipeline.shopify_orders_proc"
2018-04-17 13:45:15,373: Unhandled error while executing None
404 GET https://www.googleapis.com/bigquery/v2/projects/growth-engines-pipeline/datasets/agency_data_pipeline/tables?pageToken=ga_mcf_stats: Not found: Token ga_mcf_stats
2018-04-17 13:45:15,375: 13:45:15 | 27 of 91 START table model agency_data_pipeline.bing_ads_stats....... [RUN]
2018-04-17 13:45:15,375: Compiling model.agency_data_pipeline.bing_ads_stats
2018-04-17 13:45:15,385: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_stats"
2018-04-17 13:45:15,385: Unhandled error while executing None
404 GET https://www.googleapis.com/bigquery/v2/projects/growth-engines-pipeline/datasets/agency_data_pipeline/tables?pageToken=ga_mcf_stats: Not found: Token ga_mcf_stats
2018-04-17 13:45:15,386: Connection 'master' was left open.
2018-04-17 13:45:15,386: Connection 'ga_mcf_stats' was left open.
2018-04-17 13:45:15,386: Connection 'agg_customers_union' was left open.
2018-04-17 13:45:15,387: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d25fc50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d259208>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ade9048>]}
2018-04-17 13:45:15,391: Acquiring new bigquery connection "bing_ads_stats".
2018-04-17 13:45:15,391: Opening a new connection (0 currently allocated)
2018-04-17 13:45:15,623: Encountered an error:
2018-04-17 13:45:15,623: 404 GET https://www.googleapis.com/bigquery/v2/projects/growth-engines-pipeline/datasets/agency_data_pipeline/tables?pageToken=ga_mcf_stats: Not found: Token ga_mcf_stats
2018-04-17 13:45:15,643: Traceback (most recent call last):
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/main.py", line 40, in main
    results, succeeded = handle_and_check(args)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/main.py", line 84, in handle_and_check
    task, res = run_from_args(parsed)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/main.py", line 138, in run_from_args
    results = run_from_task(task, proj, parsed)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/main.py", line 146, in run_from_task
    result = task.run()
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/task/run.py", line 26, in run
    results = runner.run(query, ModelRunner)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/runner.py", line 221, in run
    return self.run_from_graph(Selector, Runner, query)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/runner.py", line 208, in run_from_graph
    res = self.execute_nodes(linker, Runner, flat_graph, dep_list)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/runner.py", line 133, in execute_nodes
    for result in pool.imap_unordered(self.call_runner, args_list):
  File "/usr/local/opt/python3/Frameworks/Python.framework/Versions/3.6/lib/python3.6/multiprocessing/pool.py", line 735, in next
    raise value
  File "/usr/local/opt/python3/Frameworks/Python.framework/Versions/3.6/lib/python3.6/multiprocessing/pool.py", line 119, in worker
    result = (True, func(*args, **kwds))
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/runner.py", line 82, in call_runner
    result = runner.safe_run(flat_graph, existing)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/node_runners.py", line 139, in safe_run
    raise e
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/node_runners.py", line 108, in safe_run
    result = self.run(compiled_node, existing, flat_graph)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/node_runners.py", line 155, in run
    return self.execute(compiled_node, existing, flat_graph)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/node_runners.py", line 389, in execute
    materialization_macro.get('generator')(context)()
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/clients/jinja.py", line 51, in call
    return macro(*args, **kwargs)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/runtime.py", line 549, in __call__
    return self._invoke(arguments, autoescape)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/asyncsupport.py", line 110, in _invoke
    return original_invoke(self, arguments, autoescape)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/runtime.py", line 553, in _invoke
    rv = self._func(*arguments)
  File "<template>", line 55, in macro
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/sandbox.py", line 427, in call
    return __context.call(__obj, *args, **kwargs)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/runtime.py", line 260, in call
    return __obj(*args, **kwargs)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/context/common.py", line 48, in wrapped
    return getattr(self.adapter, fn)(*args, **kwargs)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/adapters/bigquery.py", line 154, in query_for_existing
    all_tables.extend(dataset.list_tables())
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/google/cloud/iterator.py", line 218, in _items_iter
    for page in self._page_iter(increment=False):
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/google/cloud/iterator.py", line 254, in _page_iter
    page = self._next_page()
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/google/cloud/iterator.py", line 348, in _next_page
    response = self._get_next_page_response()
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/google/cloud/iterator.py", line 399, in _get_next_page_response
    query_params=params)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/google/cloud/_http.py", line 293, in api_request
    raise exceptions.from_http_response(response)
google.cloud.exceptions.NotFound: 404 GET https://www.googleapis.com/bigquery/v2/projects/growth-engines-pipeline/datasets/agency_data_pipeline/tables?pageToken=ga_mcf_stats: Not found: Token ga_mcf_stats

2018-04-17 13:46:30,424: Tracking: tracking
2018-04-17 13:46:30,427: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f521588>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f521828>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f521ba8>]}
2018-04-17 13:46:31,225: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-04-17 13:46:31,249: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/growth-engines/dbt_modules
2018-04-17 13:46:31,255: Parsing get_column_values.sql
2018-04-17 13:46:31,283: Parsing get_url_parameter.sql
2018-04-17 13:46:31,291: Parsing split_part.sql
2018-04-17 13:46:31,300: Parsing table_exists.sql
2018-04-17 13:46:31,328: Parsing core.sql
2018-04-17 13:46:31,349: Parsing adapters/bigquery.sql
2018-04-17 13:46:31,354: Parsing adapters/common.sql
2018-04-17 13:46:31,371: Parsing adapters/postgres.sql
2018-04-17 13:46:31,380: Parsing adapters/redshift.sql
2018-04-17 13:46:31,458: Parsing etc/get_custom_schema.sql
2018-04-17 13:46:31,475: Parsing materializations/archive.sql
2018-04-17 13:46:31,538: Parsing materializations/bigquery.sql
2018-04-17 13:46:31,562: Parsing materializations/helpers.sql
2018-04-17 13:46:31,586: Parsing materializations/incremental.sql
2018-04-17 13:46:31,659: Parsing materializations/table.sql
2018-04-17 13:46:31,689: Parsing materializations/view.sql
2018-04-17 13:46:31,715: Parsing materializations/wrapper.sql
2018-04-17 13:46:31,722: Parsing schema_tests/accepted_values.sql
2018-04-17 13:46:31,727: Parsing schema_tests/not_null.sql
2018-04-17 13:46:31,732: Parsing schema_tests/relationships.sql
2018-04-17 13:46:31,740: Parsing schema_tests/unique.sql
2018-04-17 13:46:31,832: Parsing model.agency_data_pipeline.accounts_proc
2018-04-17 13:46:31,834: Parsing model.agency_data_pipeline.all_dates
2018-04-17 13:46:31,836: Parsing model.agency_data_pipeline.carts_proc
2018-04-17 13:46:31,837: Parsing model.agency_data_pipeline.clients_proc
2018-04-17 13:46:31,839: Parsing model.agency_data_pipeline.conversion_goals_proc
2018-04-17 13:46:31,841: Parsing model.agency_data_pipeline.mappings_ga_proc
2018-04-17 13:46:31,843: Acquiring new bigquery connection "master".
2018-04-17 13:46:31,843: Opening a new connection (0 currently allocated)
2018-04-17 13:46:31,848: Parsing model.agency_data_pipeline.monthend_dates
2018-04-17 13:46:31,851: Parsing model.agency_data_pipeline.adwords_ads
2018-04-17 13:46:31,853: Parsing model.agency_data_pipeline.adwords_campaigns
2018-04-17 13:46:31,855: Parsing model.agency_data_pipeline.adwords_conversions
2018-04-17 13:46:31,857: Parsing model.agency_data_pipeline.adwords_impression_share
2018-04-17 13:46:31,859: Parsing model.agency_data_pipeline.adwords_join
2018-04-17 13:46:31,861: Parsing model.agency_data_pipeline.adwords_stats
2018-04-17 13:46:31,864: Parsing model.agency_data_pipeline.adwords_urls
2018-04-17 13:46:31,866: Parsing model.agency_data_pipeline.bing_ads_ads
2018-04-17 13:46:31,870: Parsing model.agency_data_pipeline.bing_ads_conversions
2018-04-17 13:46:31,872: Parsing model.agency_data_pipeline.bing_ads_impression_share
2018-04-17 13:46:31,874: Parsing model.agency_data_pipeline.bing_ads_stats
2018-04-17 13:46:31,876: Parsing model.agency_data_pipeline.fb_adcreative
2018-04-17 13:46:31,882: Parsing model.agency_data_pipeline.fb_ads
2018-04-17 13:46:31,889: Parsing model.agency_data_pipeline.fb_ads_insights
2018-04-17 13:46:31,894: Parsing model.agency_data_pipeline.fb_ads_insights_conversions
2018-04-17 13:46:31,901: Parsing model.agency_data_pipeline.fb_ads_stats
2018-04-17 13:46:31,905: Parsing model.agency_data_pipeline.ga_conversions
2018-04-17 13:46:31,906: Parsing model.agency_data_pipeline.ga_traffic
2018-04-17 13:46:31,920: Parsing model.agency_data_pipeline.ga_transactions
2018-04-17 13:46:31,930: Parsing model.agency_data_pipeline.ga_mcf_proc
2018-04-17 13:46:31,933: Parsing model.agency_data_pipeline.ga_mcf_stats
2018-04-17 13:46:31,937: Parsing model.agency_data_pipeline.shopify_customers_proc
2018-04-17 13:46:31,943: Parsing model.agency_data_pipeline.shopify_orders_proc
2018-04-17 13:46:31,954: Parsing model.agency_data_pipeline.shopify_products_proc
2018-04-17 13:46:31,963: Parsing model.agency_data_pipeline.shopify_refunds_proc
2018-04-17 13:46:31,971: Parsing model.agency_data_pipeline.agg_campaign
2018-04-17 13:46:31,975: Parsing model.agency_data_pipeline.agg_customers_union
2018-04-17 13:46:31,977: Parsing model.agency_data_pipeline.agg_ga_campaign
2018-04-17 13:46:31,981: Parsing model.agency_data_pipeline.agg_ga_campaign_by_type
2018-04-17 13:46:31,987: Parsing model.agency_data_pipeline.agg_ga_transaction
2018-04-17 13:46:31,990: Parsing model.agency_data_pipeline.agg_ga_transaction_order_number
2018-04-17 13:46:31,994: Parsing model.agency_data_pipeline.agg_orders_union
2018-04-17 13:46:31,997: Parsing model.agency_data_pipeline.agg_platform_monthly
2018-04-17 13:46:32,000: Parsing model.agency_data_pipeline.agg_platforms_client
2018-04-17 13:46:32,003: Parsing model.agency_data_pipeline.agg_platforms_union
2018-04-17 13:46:32,006: Parsing model.agency_data_pipeline.agg_products
2018-04-17 13:46:32,008: Parsing model.agency_data_pipeline.agg_transaction
2018-04-17 13:46:32,012: Parsing model.agency_data_pipeline.agg_transaction_daily
2018-04-17 13:46:32,014: Parsing model.agency_data_pipeline.agg_transaction_line_item
2018-04-17 13:46:32,017: Parsing model.agency_data_pipeline.agg_transaction_line_item_type
2018-04-17 13:46:32,020: Parsing model.agency_data_pipeline.agg_transaction_order_number
2018-04-17 13:46:32,022: Parsing model.agency_data_pipeline.agg_transaction_product_type
2018-04-17 13:46:32,024: Parsing model.agency_data_pipeline.customers_by_transaction
2018-04-17 13:46:32,027: Parsing model.agency_data_pipeline.growth_customer_0_365
2018-04-17 13:46:32,030: Parsing model.agency_data_pipeline.growth_customer_0_365_segment
2018-04-17 13:46:32,035: Parsing model.agency_data_pipeline.growth_date_union
2018-04-17 13:46:32,038: Parsing model.agency_data_pipeline.growth_stats
2018-04-17 13:46:32,043: Parsing model.agency_data_pipeline.retention_0_365
2018-04-17 13:46:32,046: Parsing model.agency_data_pipeline.retention_0_365_new
2018-04-17 13:46:32,049: Parsing model.agency_data_pipeline.retention_0_365_reactivated
2018-04-17 13:46:32,052: Parsing model.agency_data_pipeline.retention_0_365_rebuy
2018-04-17 13:46:32,055: Parsing model.agency_data_pipeline.retention_365_730
2018-04-17 13:46:32,057: Parsing model.agency_data_pipeline.retention_730_plus
2018-04-17 13:46:32,060: Parsing model.agency_data_pipeline.retention_stats
2018-04-17 13:46:32,070: Parsing model.agency_data_pipeline.retention_stats_rebuy_rate
2018-04-17 13:46:32,073: Parsing model.agency_data_pipeline.retention_0_30
2018-04-17 13:46:32,077: Parsing model.agency_data_pipeline.retention_0_30_new
2018-04-17 13:46:32,080: Parsing model.agency_data_pipeline.retention_0_30_reactivated
2018-04-17 13:46:32,083: Parsing model.agency_data_pipeline.retention_0_30_rebuy
2018-04-17 13:46:32,086: Parsing model.agency_data_pipeline.retention_30_60
2018-04-17 13:46:32,088: Parsing model.agency_data_pipeline.retention_60_plus
2018-04-17 13:46:32,091: Parsing model.agency_data_pipeline.retention_stats_month
2018-04-17 13:46:32,097: Parsing model.agency_data_pipeline.retention_stats_rebuy_rate_month
2018-04-17 13:46:32,101: Parsing model.agency_data_pipeline.customers_first_purchase_proc
2018-04-17 13:46:32,103: Parsing model.agency_data_pipeline.customers_proc
2018-04-17 13:46:32,106: Parsing model.agency_data_pipeline.segment_list_customers
2018-04-17 13:46:32,108: Parsing model.agency_data_pipeline.segment_proc_customers
2018-04-17 13:46:32,111: Parsing model.agency_data_pipeline.segment_stats_customers
2018-04-17 13:46:32,114: Parsing model.agency_data_pipeline.segment_stats_customers_agg
2018-04-17 13:46:32,118: Parsing model.agency_data_pipeline.customers_first_purchase_product_type_proc
2018-04-17 13:46:32,120: Parsing model.agency_data_pipeline.customers_products_proc
2018-04-17 13:46:32,124: Parsing model.agency_data_pipeline.segment_list_customers_products
2018-04-17 13:46:32,126: Parsing model.agency_data_pipeline.segment_proc_customers_products
2018-04-17 13:46:32,130: Parsing model.agency_data_pipeline.segment_stats_customers_products
2018-04-17 13:46:32,132: Parsing model.agency_data_pipeline.segment_stats_customers_products_agg
2018-04-17 13:46:32,136: Parsing model.agency_data_pipeline.frequency_proc
2018-04-17 13:46:32,138: Parsing model.agency_data_pipeline.frequency_stats
2018-04-17 13:46:32,140: Parsing model.agency_data_pipeline.order_paths_agg
2018-04-17 13:46:32,142: Parsing model.agency_data_pipeline.order_paths_proc
2018-04-17 13:46:32,145: Parsing model.agency_data_pipeline.order_paths_stats
2018-04-17 13:46:32,148: Parsing model.agency_data_pipeline.products_proc
2018-04-17 13:46:32,151: Parsing model.agency_data_pipeline.segment_proc_sku
2018-04-17 13:46:32,154: Parsing model.agency_data_pipeline.segment_stats_category
2018-04-17 13:46:32,156: Parsing model.agency_data_pipeline.segment_stats_sku
2018-04-17 13:46:32,189: Found 91 models, 0 tests, 0 archives, 0 analyses, 46 macros, 0 operations
2018-04-17 13:46:32,254: 
2018-04-17 13:46:33,777: 13:46:33 | Concurrency: 4 threads (target='prod')
2018-04-17 13:46:33,777: 13:46:33 | 
2018-04-17 13:46:34,498: 13:46:34 | 1 of 91 START table model agency_data_pipeline.adwords_urls.......... [RUN]
2018-04-17 13:46:34,499: Compiling model.agency_data_pipeline.adwords_urls
2018-04-17 13:46:34,504: Writing injected SQL for node "model.agency_data_pipeline.adwords_urls"
2018-04-17 13:46:34,498: 13:46:34 | 2 of 91 START table model agency_data_pipeline.monthend_dates........ [RUN]
2018-04-17 13:46:34,505: Compiling model.agency_data_pipeline.monthend_dates
2018-04-17 13:46:34,509: Writing injected SQL for node "model.agency_data_pipeline.monthend_dates"
2018-04-17 13:46:34,498: 13:46:34 | 3 of 91 START table model agency_data_pipeline.conversion_goals_proc. [RUN]
2018-04-17 13:46:34,509: Compiling model.agency_data_pipeline.conversion_goals_proc
2018-04-17 13:46:34,499: 13:46:34 | 4 of 91 START table model agency_data_pipeline.bing_ads_ads.......... [RUN]
2018-04-17 13:46:34,514: Writing injected SQL for node "model.agency_data_pipeline.conversion_goals_proc"
2018-04-17 13:46:34,514: Compiling model.agency_data_pipeline.bing_ads_ads
2018-04-17 13:46:34,520: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_ads"
2018-04-17 13:46:34,521: Acquiring new bigquery connection "adwords_urls".
2018-04-17 13:46:34,521: Opening a new connection (1 currently allocated)
2018-04-17 13:46:34,523: Acquiring new bigquery connection "conversion_goals_proc".
2018-04-17 13:46:34,524: Acquiring new bigquery connection "monthend_dates".
2018-04-17 13:46:34,524: Acquiring new bigquery connection "bing_ads_ads".
2018-04-17 13:46:34,526: Opening a new connection (2 currently allocated)
2018-04-17 13:46:34,528: Opening a new connection (3 currently allocated)
2018-04-17 13:46:34,648: Opening a new connection (4 currently allocated)
2018-04-17 13:46:36,238: Model SQL (monthend_dates):
SELECT
date_in_range,
date_in_range_bom,
date_in_range_bom_mom,
unix_date_in_range,
unix_date_in_range_bom,
unix_date(date_in_range_bom_mom) unix_date_in_range_bom_mom,
yyyymm,
date_in_range_yoy,
unix_date(date_in_range_yoy) unix_date_in_range_yoy

FROM
(
	SELECT 
	date_in_range,
	date_in_range_bom,
	date_sub(date_in_range_bom, INTERVAL 1 MONTH) date_in_range_bom_mom,
  date_sub(date_in_range, INTERVAL 1 YEAR) date_in_range_yoy,
	unix_date_in_range,
	unix_date(date_in_range_bom) unix_date_in_range_bom,
	yyyymm,
	first_value(date_in_range) over (partition by yyyymm order by date_in_range desc) monthend_date_in_range
	FROM
	( 
		SELECT 
		date_in_range,
		date_trunc( date_in_range, MONTH) date_in_range_bom,
		unix_date(date_in_range) unix_date_in_range,
		format_date("%Y-%m", date_in_range) AS yyyymm
		FROM UNNEST(
		    GENERATE_DATE_ARRAY(DATE('2016-01-31'), CURRENT_DATE(), INTERVAL 1 DAY)
		) AS date_in_range
	)
)
where date_in_range = monthend_date_in_range
2018-04-17 13:46:36,239: Model SQL (bing_ads_ads):
select
date, 
account, 
channel,
platform,
campaignid,
campaignname,
max(lower(trim(replace(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$','' ),'.html',''),'/'))) as url,
utm_campaign,
sum(cost) as cost,
sum(impressions) as impressions,
sum(clicks) as clicks,
sum(conversions) as conversions
from 
  ( 
SELECT  
cast(gregoriandate as date) date,
replace(accountname,',','') account,
'Paid' as channel,
'Bing Ads' as platform,
adid,
adtype,
campaignid, 
campaignname,
finalurl url,
case when regexp_contains(destinationurl, 'utm_campaign')
	then replace(lower(nullif(
  

    split(
        
  

    split(
        destinationurl,
        'utm_campaign='
        )[offset(1)]


,
        '&'
        )[offset(0)]


,'')),'+',' ') 
	else null end as utm_campaign,
spend cost, 
impressions, 
clicks, 
conversions,
_sdc_sequence,
first_value(_sdc_sequence) OVER (PARTITION BY adid, gregoriandate ORDER BY _sdc_sequence DESC) lv
FROM `growth-engines-pipeline.bing_ads.ad_performance_report` 
  )

where lv = _sdc_sequence
group by date, account, channel, platform, campaignid, campaignname, utm_campaign
2018-04-17 13:46:36,248: Model SQL (conversion_goals_proc):
select 
client,
platform,
goal_name,
max(goal_type) goal_type,
account,
max(time_of_entry) time_of_entry
from  ( 

SELECT  
client,
platform,
trim(replace(replace(lower(goal_name),',',''),' ','')) goal_name,
goal_type,
account,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY platform ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.conversion_goals` 

) 

WHERE lv = time_of_entry
group by client, platform, account, goal_name
2018-04-17 13:46:36,251: Model SQL (adwords_urls):
SELECT
campaignid,
lower(trim(regexp_replace(replace(replace(replace(replace(finalurl,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url

FROM (

SELECT  
campaignid,
finalurl,
first_value(finalurl) OVER (PARTITION BY campaignid ORDER BY day DESC) lv
FROM `growth-engines-pipeline.adwords_2.FINAL_URL_REPORT`
)

WHERE lv = finalurl
group by campaignid, url
order by campaignid asc
2018-04-17 13:46:37,394: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b33f5cb4-8e9a-4bd2-ad74-8f0bca84dd17', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f5fbeb8>]}
2018-04-17 13:46:37,663: 13:46:37 | 2 of 91 OK created table model agency_data_pipeline.monthend_dates... [CREATE TABLE in 2.89s]
2018-04-17 13:46:37,664: 13:46:37 | 5 of 91 START table model agency_data_pipeline.accounts_proc......... [RUN]
2018-04-17 13:46:37,664: Compiling model.agency_data_pipeline.accounts_proc
2018-04-17 13:46:37,670: Writing injected SQL for node "model.agency_data_pipeline.accounts_proc"
2018-04-17 13:46:37,671: Acquiring new bigquery connection "accounts_proc".
2018-04-17 13:46:37,671: Re-using an available connection from the pool.
2018-04-17 13:46:38,435: Model SQL (accounts_proc):
select 
client,
account,
platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.accounts` 

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-04-17 13:46:38,473: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b33f5cb4-8e9a-4bd2-ad74-8f0bca84dd17', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111a9bf28>]}
2018-04-17 13:46:38,550: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b33f5cb4-8e9a-4bd2-ad74-8f0bca84dd17', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f6cb9e8>]}
2018-04-17 13:46:38,670: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b33f5cb4-8e9a-4bd2-ad74-8f0bca84dd17', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111a62630>]}
2018-04-17 13:46:38,744: 13:46:38 | 4 of 91 OK created table model agency_data_pipeline.bing_ads_ads..... [CREATE TABLE in 3.96s]
2018-04-17 13:46:38,745: 13:46:38 | 6 of 91 START table model agency_data_pipeline.adwords_campaigns..... [RUN]
2018-04-17 13:46:38,745: Compiling model.agency_data_pipeline.adwords_campaigns
2018-04-17 13:46:38,752: Writing injected SQL for node "model.agency_data_pipeline.adwords_campaigns"
2018-04-17 13:46:38,755: Acquiring new bigquery connection "adwords_campaigns".
2018-04-17 13:46:38,756: Re-using an available connection from the pool.
2018-04-17 13:46:38,986: 13:46:38 | 3 of 91 OK created table model agency_data_pipeline.conversion_goals_proc [CREATE TABLE in 4.04s]
2018-04-17 13:46:38,987: 13:46:38 | 7 of 91 START table model agency_data_pipeline.ga_conversions........ [RUN]
2018-04-17 13:46:38,988: Compiling model.agency_data_pipeline.ga_conversions
2018-04-17 13:46:38,993: Writing injected SQL for node "model.agency_data_pipeline.ga_conversions"
2018-04-17 13:46:39,000: Acquiring new bigquery connection "ga_conversions".
2018-04-17 13:46:39,001: Re-using an available connection from the pool.
2018-04-17 13:46:39,252: 13:46:39 | 1 of 91 OK created table model agency_data_pipeline.adwords_urls..... [CREATE TABLE in 4.17s]
2018-04-17 13:46:39,253: 13:46:39 | 8 of 91 START table model agency_data_pipeline.all_dates............. [RUN]
2018-04-17 13:46:39,254: Compiling model.agency_data_pipeline.all_dates
2018-04-17 13:46:39,261: Writing injected SQL for node "model.agency_data_pipeline.all_dates"
2018-04-17 13:46:39,263: Acquiring new bigquery connection "all_dates".
2018-04-17 13:46:39,263: Re-using an available connection from the pool.
2018-04-17 13:46:39,545: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b33f5cb4-8e9a-4bd2-ad74-8f0bca84dd17', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f5fbeb8>]}
2018-04-17 13:46:39,722: Model SQL (adwords_campaigns):
select
day,
campaignid, 
campaign,
account, 
channel,
platform,
sum(cost) cost,
sum(impressions) impressions,
sum(clicks) clicks,
sum(impression_share_num) impression_share_num,
sum(impression_share_den) impression_share_den
from 
  ( 
	SELECT  
	day,
	campaignid,
	campaign,
	account as account,
	'Paid' as channel,
	'Adwords' as platform,
	cost/1000000 cost, 
	impressions as impressions, 
	clicks, 
	case when searchimprshare is not null then impressions end as impression_share_num,
	case when searchimprshare is not null then impressions/(searchimprshare/100) end as impression_share_den,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY campaignid, day ORDER BY _sdc_sequence DESC) lv
	FROM `growth-engines-pipeline.adwords_2.CAMPAIGN_PERFORMANCE_REPORT`
  )
where lv = _sdc_sequence
group by day, campaignid, account, channel, platform, campaign
2018-04-17 13:46:39,773: Model SQL (ga_conversions):
select 
client,
client_name,
platform,
goal_name,
goal_type,
account,
time_of_entry
from  ( 

SELECT  
client,
client_name,
platform,
trim(goal_name) goal_name,
goal_type,
account,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform, goal_name ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.conversion_goals` 
WHERE platform = 'Google Analytics'

) 

WHERE lv = time_of_entry
2018-04-17 13:46:39,778: 13:46:39 | 5 of 91 OK created table model agency_data_pipeline.accounts_proc.... [CREATE TABLE in 1.88s]
2018-04-17 13:46:39,779: 13:46:39 | 9 of 91 START table model agency_data_pipeline.adwords_conversions... [RUN]
2018-04-17 13:46:39,779: Compiling model.agency_data_pipeline.adwords_conversions
2018-04-17 13:46:39,787: Writing injected SQL for node "model.agency_data_pipeline.adwords_conversions"
2018-04-17 13:46:39,793: Acquiring new bigquery connection "adwords_conversions".
2018-04-17 13:46:39,793: Re-using an available connection from the pool.
2018-04-17 13:46:40,207: Model SQL (all_dates):
SELECT 
date_in_range,
unix_date(date_in_range) unix_date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-04-17 13:46:40,599: Model SQL (adwords_conversions):
select 
client,
client_name,
platform,
goal_name,
goal_type,
account,
time_of_entry
from  ( 

SELECT  
client,
client_name,
platform,
trim(lower(goal_name)) goal_name,
goal_type,
account,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform, goal_name ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.conversion_goals` 
WHERE platform = 'Adwords'

) 

WHERE lv = time_of_entry
2018-04-17 13:46:41,323: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b33f5cb4-8e9a-4bd2-ad74-8f0bca84dd17', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111a62630>]}
2018-04-17 13:46:41,569: 13:46:41 | 8 of 91 OK created table model agency_data_pipeline.all_dates........ [CREATE TABLE in 2.07s]
2018-04-17 13:46:41,569: 13:46:41 | 10 of 91 START table model agency_data_pipeline.bing_ads_impression_share [RUN]
2018-04-17 13:46:41,570: Compiling model.agency_data_pipeline.bing_ads_impression_share
2018-04-17 13:46:41,577: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_impression_share"
2018-04-17 13:46:41,578: Acquiring new bigquery connection "bing_ads_impression_share".
2018-04-17 13:46:41,578: Re-using an available connection from the pool.
2018-04-17 13:46:41,846: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b33f5cb4-8e9a-4bd2-ad74-8f0bca84dd17', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f5fbeb8>]}
2018-04-17 13:46:42,021: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b33f5cb4-8e9a-4bd2-ad74-8f0bca84dd17', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111a9bd30>]}
2018-04-17 13:46:42,080: 13:46:42 | 9 of 91 OK created table model agency_data_pipeline.adwords_conversions [CREATE TABLE in 2.07s]
2018-04-17 13:46:42,081: 13:46:42 | 11 of 91 START table model agency_data_pipeline.clients_proc......... [RUN]
2018-04-17 13:46:42,081: Compiling model.agency_data_pipeline.clients_proc
2018-04-17 13:46:42,090: Writing injected SQL for node "model.agency_data_pipeline.clients_proc"
2018-04-17 13:46:42,094: Acquiring new bigquery connection "clients_proc".
2018-04-17 13:46:42,094: Re-using an available connection from the pool.
2018-04-17 13:46:42,307: Model SQL (bing_ads_impression_share):
SELECT 
date, 
account,
channel,
platform,
sum(impressions) impressions,
sum(available_impressions) available_impressions
FROM

(

SELECT  
cast(gregoriandate as date) date,
replace(accountname,',','') account,  
'Paid' as channel,
'Bing Ads' as platform,
case when impressionsharepercent is null then 0 else impressions end as impressions,
cast(round(case when ( impressionsharepercent is not null and impressionsharepercent > 0 ) then (impressions*100)/impressionsharepercent else 0 end) as int64) as available_impressions,
_sdc_sequence,
first_value(_sdc_sequence) OVER (PARTITION BY campaignid, gregoriandate ORDER BY _sdc_sequence DESC) lv
FROM `growth-engines-pipeline.bing_ads.campaign_performance_report` 

)

where lv = _sdc_sequence
group by date, account, channel, platform
2018-04-17 13:46:42,349: 13:46:42 | 7 of 91 OK created table model agency_data_pipeline.ga_conversions... [CREATE TABLE in 3.03s]
2018-04-17 13:46:42,350: 13:46:42 | 12 of 91 START table model agency_data_pipeline.carts_proc........... [RUN]
2018-04-17 13:46:42,350: Compiling model.agency_data_pipeline.carts_proc
2018-04-17 13:46:42,358: Writing injected SQL for node "model.agency_data_pipeline.carts_proc"
2018-04-17 13:46:42,360: Acquiring new bigquery connection "carts_proc".
2018-04-17 13:46:42,360: Re-using an available connection from the pool.
2018-04-17 13:46:42,961: Model SQL (clients_proc):
select 
client,
client_name,
account,
platform
from  ( 

SELECT  
client,
client_name,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.accounts`
where client_name != ''
) 

WHERE lv = time_of_entry
2018-04-17 13:46:43,096: Model SQL (carts_proc):
select 
client,
client_name,
account,
platform
from  ( 

SELECT  
client,
client_name,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.accounts`
WHERE platform in ('Shopify', 'Custom cart')

) 

WHERE lv = time_of_entry
2018-04-17 13:46:43,439: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b33f5cb4-8e9a-4bd2-ad74-8f0bca84dd17', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111a62630>]}
2018-04-17 13:46:43,703: 13:46:43 | 10 of 91 OK created table model agency_data_pipeline.bing_ads_impression_share [CREATE TABLE in 1.87s]
2018-04-17 13:46:44,098: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b33f5cb4-8e9a-4bd2-ad74-8f0bca84dd17', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f5fbeb8>]}
2018-04-17 13:46:44,237: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b33f5cb4-8e9a-4bd2-ad74-8f0bca84dd17', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111a9bd30>]}
2018-04-17 13:46:44,746: 13:46:44 | 11 of 91 OK created table model agency_data_pipeline.clients_proc.... [CREATE TABLE in 2.02s]
2018-04-17 13:46:44,985: 13:46:44 | 12 of 91 OK created table model agency_data_pipeline.carts_proc...... [CREATE TABLE in 1.89s]
2018-04-17 13:46:45,406: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b33f5cb4-8e9a-4bd2-ad74-8f0bca84dd17', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f6cbc18>]}
2018-04-17 13:46:45,653: 13:46:45 | 6 of 91 OK created table model agency_data_pipeline.adwords_campaigns [CREATE TABLE in 6.66s]
2018-04-17 13:46:45,654: 13:46:45 | 13 of 91 START table model agency_data_pipeline.fb_adcreative........ [RUN]
2018-04-17 13:46:45,655: Compiling model.agency_data_pipeline.fb_adcreative
2018-04-17 13:46:45,654: 13:46:45 | 14 of 91 START table model agency_data_pipeline.mappings_ga_proc..... [RUN]
2018-04-17 13:46:45,661: Compiling model.agency_data_pipeline.mappings_ga_proc
2018-04-17 13:46:45,667: Acquiring new bigquery connection "fb_adcreative".
2018-04-17 13:46:45,667: Re-using an available connection from the pool.
2018-04-17 13:46:45,668: Fetching data for query fb_adcreative:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 13:46:45,654: 13:46:45 | 15 of 91 START table model agency_data_pipeline.shopify_refunds_proc. [RUN]
2018-04-17 13:46:45,668: Compiling model.agency_data_pipeline.shopify_refunds_proc
2018-04-17 13:46:45,654: 13:46:45 | 16 of 91 START table model agency_data_pipeline.fb_ads_insights_conversions [RUN]
2018-04-17 13:46:45,676: Writing injected SQL for node "model.agency_data_pipeline.mappings_ga_proc"
2018-04-17 13:46:45,677: Acquiring new bigquery connection "shopify_refunds_proc".
2018-04-17 13:46:45,677: Compiling model.agency_data_pipeline.fb_ads_insights_conversions
2018-04-17 13:46:45,679: Re-using an available connection from the pool.
2018-04-17 13:46:45,686: Acquiring new bigquery connection "fb_ads_insights_conversions".
2018-04-17 13:46:45,687: Fetching data for query shopify_refunds_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 13:46:45,687: Re-using an available connection from the pool.
2018-04-17 13:46:45,688: Acquiring new bigquery connection "mappings_ga_proc".
2018-04-17 13:46:45,693: Re-using an available connection from the pool.
2018-04-17 13:46:45,692: Fetching data for query fb_ads_insights_conversions:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 13:46:46,681: Model SQL (mappings_ga_proc):
select 
client,
account,
client_name,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
account,
client_name,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.mappings_ga` 

) 

WHERE lv = time_of_entry
and client in (select client from `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc` )
group by client, account, client_name, source, medium, platform_n, channel_n, time_of_entry
2018-04-17 13:46:46,845: Writing injected SQL for node "model.agency_data_pipeline.fb_adcreative"
2018-04-17 13:46:47,017: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_insights_conversions"
2018-04-17 13:46:47,142: Writing injected SQL for node "model.agency_data_pipeline.shopify_refunds_proc"
2018-04-17 13:46:47,690: Model SQL (fb_adcreative):




with fb_adcreative as (


	    
		   	SELECT 
			id,
			object_url,
			url_tags,
			_sdc_sequence
			FROM `growth-engines-pipeline.fb_ads_luca_danni.adcreative`
		    
	   
)

select creative_id, max(url) url
from (
  select
  id creative_id,
  lower(trim(regexp_replace(replace(replace(replace(replace(object_url,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
  first_value(_sdc_sequence) OVER (PARTITION BY id ORDER BY _sdc_sequence DESC) lv,
  _sdc_sequence
  from fb_adcreative
  )
where lv = _sdc_sequence
group by creative_id


2018-04-17 13:46:47,987: Model SQL (fb_ads_insights_conversions):




with fb_ads_insights_conversions as (

	    
		   	SELECT 
			date_start,
			campaign_id,
			campaign_name,
			ad_id,
			account_name,
			spend,
			reach,
			inline_link_clicks,
			_sdc_sequence,
			action_type,
			value
			FROM `growth-engines-pipeline.fb_ads_luca_danni.ads_insights`
			cross join unnest(actions)
		    
	   

)

SELECT * 
FROM 
	(
    SELECT
    date_start date,
    campaign_id,
    campaign_name campaign,
    ad_id,
    account_name account,
    action_type,
    value conversions,
    first_value(_sdc_sequence) OVER (PARTITION BY ad_id, date_start ORDER BY _sdc_sequence DESC) lv,
    _sdc_sequence
    FROM fb_ads_insights_conversions
   	)
where lv = _sdc_sequence
and action_type like '%purchase%'


2018-04-17 13:46:48,067: Model SQL (shopify_refunds_proc):




with refunds as (

	
	SELECT
	order_number,
	checkout_id,
	financial_status,
	line_item_id,
	quantity,
	subtotal,
	line_item.variant_id variant_id,
	line_item.id refund_id,
 	_sdc_sequence
	FROM `growth-engines-pipeline.shopify_lucadanni.orders` 
	cross join unnest(refunds), unnest(refund_line_items)
  	where financial_status like '%refund%'
	
	

)

SELECT * 
FROM 
	(
    SELECT
	order_number,
	checkout_id,
	financial_status,
	line_item_id,
	quantity,
	subtotal refund_amount,
	variant_id,
	refund_id,
 	_sdc_sequence,
    first_value(_sdc_sequence) OVER (PARTITION BY order_number, line_item_id ORDER BY _sdc_sequence DESC) lv
    FROM refunds
   	) 
WHERE lv = _sdc_sequence


2018-04-17 13:46:48,920: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b33f5cb4-8e9a-4bd2-ad74-8f0bca84dd17', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111a9ada0>]}
2018-04-17 13:46:49,164: 13:46:49 | 14 of 91 OK created table model agency_data_pipeline.mappings_ga_proc [CREATE TABLE in 3.26s]
2018-04-17 13:46:49,164: 13:46:49 | 17 of 91 START table model agency_data_pipeline.ga_mcf_proc.......... [RUN]
2018-04-17 13:46:49,165: Compiling model.agency_data_pipeline.ga_mcf_proc
2018-04-17 13:46:49,175: Writing injected SQL for node "model.agency_data_pipeline.ga_mcf_proc"
2018-04-17 13:46:49,176: Acquiring new bigquery connection "ga_mcf_proc".
2018-04-17 13:46:49,176: Re-using an available connection from the pool.
2018-04-17 13:46:49,926: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b33f5cb4-8e9a-4bd2-ad74-8f0bca84dd17', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111a9aba8>]}
2018-04-17 13:46:50,163: 13:46:50 | 13 of 91 OK created table model agency_data_pipeline.fb_adcreative... [CREATE TABLE in 4.27s]
2018-04-17 13:46:50,163: 13:46:50 | 18 of 91 START table model agency_data_pipeline.fb_ads_insights...... [RUN]
2018-04-17 13:46:50,164: Compiling model.agency_data_pipeline.fb_ads_insights
2018-04-17 13:46:50,176: Acquiring new bigquery connection "fb_ads_insights".
2018-04-17 13:46:50,176: Re-using an available connection from the pool.
2018-04-17 13:46:50,176: Fetching data for query fb_ads_insights:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 13:46:50,291: Model SQL (ga_mcf_proc):
SELECT 
date,
account,
'Google Analytics' as lookup_platform,
source_medium_path,
trim(lower(split(split(source_medium_path,'->')[SAFE_ORDINAL(1)],'/')[SAFE_ORDINAL(1)])) as source,
trim(lower(split(split(source_medium_path,'->')[SAFE_ORDINAL(1)],'/')[SAFE_ORDINAL(2)])) as medium,
first_interaction_campaign campaign,
cast(regexp_replace(transaction_id, r'#', '') as int64) transactionid,
max(first_interaction_conversions) transactions,
max(first_interaction_conversion_value) revenue
FROM `growth-engines-pipeline.agency_data_pipeline.ga_mcf`
where account in (select account from `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc` where platform = 'Google Analytics')
group by date, account, source, medium, campaign, source_medium_path, lookup_platform, transactionid
2018-04-17 13:46:50,317: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b33f5cb4-8e9a-4bd2-ad74-8f0bca84dd17', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111aa96a0>]}
2018-04-17 13:46:50,560: 13:46:50 | 15 of 91 OK created table model agency_data_pipeline.shopify_refunds_proc [CREATE TABLE in 4.65s]
2018-04-17 13:46:50,561: 13:46:50 | 19 of 91 START table model agency_data_pipeline.adwords_ads.......... [RUN]
2018-04-17 13:46:50,561: Compiling model.agency_data_pipeline.adwords_ads
2018-04-17 13:46:50,572: Writing injected SQL for node "model.agency_data_pipeline.adwords_ads"
2018-04-17 13:46:50,573: Acquiring new bigquery connection "adwords_ads".
2018-04-17 13:46:50,574: Re-using an available connection from the pool.
2018-04-17 13:46:50,584: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_insights"
2018-04-17 13:46:51,417: Model SQL (adwords_ads):
SELECT  
day,
campaignid,
a.account as account,
utm_campaign,
sum( case when b.goal_type = 'Transaction' then conversions else 0 end ) as transactions
FROM (

	SELECT  
	day,
	adid,
	campaignid,
	account,
	lower(conversionname) conversionname,
	conversions,
	lower(campaign) utm_campaign,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY campaignid, day ORDER BY _sdc_sequence DESC) lv
	FROM
	`growth-engines-pipeline.adwords_2.AD_PERFORMANCE_REPORT`

) a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_conversions` b
ON ( a.conversionname = b.goal_name
	AND a.account = b.account )
WHERE lv = _sdc_sequence
group by day, campaignid, account, utm_campaign
2018-04-17 13:46:51,475: Model SQL (fb_ads_insights):




with fb_ads_insights as (

	    
		   	SELECT 
			date_start,
			campaign_id,
			campaign_name,
			ad_id,
			account_name,
			spend,
			reach,
			inline_link_clicks,
			_sdc_sequence,
			first_value(_sdc_sequence) OVER (PARTITION BY date_start, ad_id, campaign_id ORDER BY _sdc_sequence DESC) lv
			FROM `growth-engines-pipeline.fb_ads_luca_danni.ads_insights`
		    
	   

)

select
date_start date,
campaign_id,
campaign_name campaign,
ad_id,
account_name account,
max(spend) cost,
max(reach) impressions,
max(inline_link_clicks) clicks
from fb_ads_insights
where lv = _sdc_sequence
group by date, campaign_id, ad_id, account, campaign


2018-04-17 13:46:52,448: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b33f5cb4-8e9a-4bd2-ad74-8f0bca84dd17', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111a94be0>]}
2018-04-17 13:46:52,727: 13:46:52 | 16 of 91 OK created table model agency_data_pipeline.fb_ads_insights_conversions [CREATE TABLE in 6.77s]
2018-04-17 13:46:52,727: 13:46:52 | 20 of 91 START table model agency_data_pipeline.bing_ads_conversions. [RUN]
2018-04-17 13:46:52,727: Compiling model.agency_data_pipeline.bing_ads_conversions
2018-04-17 13:46:52,738: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_conversions"
2018-04-17 13:46:52,739: Acquiring new bigquery connection "bing_ads_conversions".
2018-04-17 13:46:52,739: Re-using an available connection from the pool.
2018-04-17 13:46:53,552: Model SQL (bing_ads_conversions):
SELECT
date, 
a.account account, 
a.channel channel,
a.platform platform,
campaignid,
campaignname,
sum( case when b.goal_type = 'Transactions' then conversions else 0 end ) as transactions
FROM

  ( 
SELECT  
cast(gregoriandate as date) date,
replace(accountname,',','') account,
'Paid' as channel,
'Bing Ads' as platform,
trim(replace(replace(lower(goal),',',''),' ','')) goal,
goalid,
campaignid,
campaignname,
conversions,
_sdc_sequence,
first_value(_sdc_sequence) OVER (PARTITION BY campaignid, goalid, gregoriandate ORDER BY _sdc_sequence DESC) lv
FROM `growth-engines-pipeline.bing_ads.goals_and_funnels_report` 

  ) a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`conversion_goals_proc` b
ON (
	a.account = b.account AND
	a.platform = b.platform AND
	a.goal = b.goal_name
)
where a.lv = a._sdc_sequence
group by date, account, channel, platform, campaignid, campaignname
2018-04-17 13:46:53,693: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b33f5cb4-8e9a-4bd2-ad74-8f0bca84dd17', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111a7c6a0>]}
2018-04-17 13:46:53,932: 13:46:53 | 19 of 91 OK created table model agency_data_pipeline.adwords_ads..... [CREATE TABLE in 3.13s]
2018-04-17 13:46:54,798: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b33f5cb4-8e9a-4bd2-ad74-8f0bca84dd17', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111afaba8>]}
2018-04-17 13:46:54,803: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b33f5cb4-8e9a-4bd2-ad74-8f0bca84dd17', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111a9ada0>]}
2018-04-17 13:46:55,475: 13:46:55 | 18 of 91 OK created table model agency_data_pipeline.fb_ads_insights. [CREATE TABLE in 4.63s]
2018-04-17 13:46:55,719: 13:46:55 | 17 of 91 OK created table model agency_data_pipeline.ga_mcf_proc..... [CREATE TABLE in 5.64s]
2018-04-17 13:46:55,833: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b33f5cb4-8e9a-4bd2-ad74-8f0bca84dd17', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111a73240>]}
2018-04-17 13:46:56,072: 13:46:56 | 20 of 91 OK created table model agency_data_pipeline.bing_ads_conversions [CREATE TABLE in 3.11s]
2018-04-17 13:46:56,072: 13:46:56 | 21 of 91 START table model agency_data_pipeline.shopify_customers_proc [RUN]
2018-04-17 13:46:56,073: Compiling model.agency_data_pipeline.shopify_customers_proc
2018-04-17 13:46:56,073: 13:46:56 | 22 of 91 START table model agency_data_pipeline.fb_ads............... [RUN]
2018-04-17 13:46:56,086: Compiling model.agency_data_pipeline.fb_ads
2018-04-17 13:46:56,097: Acquiring new bigquery connection "shopify_customers_proc".
2018-04-17 13:46:56,097: Re-using an available connection from the pool.
2018-04-17 13:46:56,098: Fetching data for query shopify_customers_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 13:46:56,106: Acquiring new bigquery connection "fb_ads".
2018-04-17 13:46:56,106: Re-using an available connection from the pool.
2018-04-17 13:46:56,107: Fetching data for query fb_ads:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 13:46:56,535: Writing injected SQL for node "model.agency_data_pipeline.shopify_customers_proc"
2018-04-17 13:46:56,643: Writing injected SQL for node "model.agency_data_pipeline.fb_ads"
2018-04-17 13:46:57,563: Model SQL (fb_ads):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`fb_adcreative`





with fb_ads as (

	    
		   	SELECT 
			id ad_id,
			creative.creative_id creative_id,
			_sdc_sequence
			FROM `growth-engines-pipeline.fb_ads_luca_danni.ads`
		     
	   

)

SELECT
a.ad_id,
b.creative_id,
b.url
FROM (
    SELECT
    ad_id,
    creative_id,
    first_value(_sdc_sequence) OVER (PARTITION BY ad_id ORDER BY _sdc_sequence DESC) lv,
    _sdc_sequence
    FROM fb_ads
    ) a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`fb_adcreative` b
ON (
	a.creative_id = b.creative_id 
)
WHERE a.lv = a._sdc_sequence


2018-04-17 13:46:57,563: Model SQL (shopify_customers_proc):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc`





with customers as (

	
	SELECT
	'lucadanni' client_name,
	'Shopify' as lookup_platform,
	cast(created_at as date) created_at,
	id,
	first_name,
	last_name,
	email,
	_sdc_sequence,
	first_value(_sdc_sequence) over (partition by id, _sdc_sequence order by _sdc_sequence desc) lv
	FROM `growth-engines-pipeline.shopify_lucadanni.customers` 
	
	

)

SELECT
account,
client,
platform,
id,
min(created_at) created_at,
max(first_name) first_name,
max(last_name) last_name,
max(email) email
FROM (
	SELECT
	b.account,
	b.client,
	b.platform,
	created_at,
	id,
	first_name,
	last_name,
	email
	FROM customers a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
	ON ( a.client_name = b.client_name
	  AND a.lookup_platform = b.platform )
	where a.lv = a._sdc_sequence
)
group by account, client, platform, id

2018-04-17 13:46:59,794: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b33f5cb4-8e9a-4bd2-ad74-8f0bca84dd17', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111aae748>]}
2018-04-17 13:47:00,022: 13:47:00 | 22 of 91 OK created table model agency_data_pipeline.fb_ads.......... [CREATE TABLE in 3.71s]
2018-04-17 13:47:02,018: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b33f5cb4-8e9a-4bd2-ad74-8f0bca84dd17', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111a737b8>]}
2018-04-17 13:47:02,298: 13:47:02 | 21 of 91 OK created table model agency_data_pipeline.shopify_customers_proc [CREATE TABLE in 5.95s]
2018-04-17 13:47:02,298: 13:47:02 | 23 of 91 START table model agency_data_pipeline.agg_customers_union.. [RUN]
2018-04-17 13:47:02,299: Compiling model.agency_data_pipeline.agg_customers_union
2018-04-17 13:47:02,311: Writing injected SQL for node "model.agency_data_pipeline.agg_customers_union"
2018-04-17 13:47:02,313: Acquiring new bigquery connection "agg_customers_union".
2018-04-17 13:47:02,313: Re-using an available connection from the pool.
2018-04-17 13:47:02,333: 13:47:02 | 24 of 91 START table model agency_data_pipeline.ga_mcf_stats......... [RUN]
2018-04-17 13:47:02,336: Compiling model.agency_data_pipeline.ga_mcf_stats
2018-04-17 13:47:02,356: Writing injected SQL for node "model.agency_data_pipeline.ga_mcf_stats"
2018-04-17 13:47:02,358: Acquiring new bigquery connection "ga_mcf_stats".
2018-04-17 13:47:02,359: Re-using an available connection from the pool.
2018-04-17 13:47:02,368: 13:47:02 | 25 of 91 START table model agency_data_pipeline.bing_ads_stats....... [RUN]
2018-04-17 13:47:02,369: Compiling model.agency_data_pipeline.bing_ads_stats
2018-04-17 13:47:02,389: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_stats"
2018-04-17 13:47:02,391: Acquiring new bigquery connection "bing_ads_stats".
2018-04-17 13:47:02,391: Re-using an available connection from the pool.
2018-04-17 13:47:02,395: 13:47:02 | 26 of 91 START table model agency_data_pipeline.shopify_products_proc [RUN]
2018-04-17 13:47:02,396: Compiling model.agency_data_pipeline.shopify_products_proc
2018-04-17 13:47:02,516: Acquiring new bigquery connection "shopify_products_proc".
2018-04-17 13:47:02,516: Re-using an available connection from the pool.
2018-04-17 13:47:02,517: Fetching data for query shopify_products_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 13:47:02,904: Writing injected SQL for node "model.agency_data_pipeline.shopify_products_proc"
2018-04-17 13:47:03,219: Unhandled error while executing None
404 GET https://www.googleapis.com/bigquery/v2/projects/growth-engines-pipeline/datasets/agency_data_pipeline/tables?pageToken=ga_mcf_stats: Not found: Token ga_mcf_stats
2018-04-17 13:47:03,220: 13:47:03 | 27 of 91 START table model agency_data_pipeline.shopify_orders_proc.. [RUN]
2018-04-17 13:47:03,221: Connection 'master' was left open.
2018-04-17 13:47:03,221: Compiling model.agency_data_pipeline.shopify_orders_proc
2018-04-17 13:47:03,221: Connection 'agg_customers_union' was left open.
2018-04-17 13:47:03,230: Acquiring new bigquery connection "shopify_orders_proc".
2018-04-17 13:47:03,230: Connection 'ga_mcf_stats' was left open.
2018-04-17 13:47:03,230: Connection 'bing_ads_stats' was left open.
2018-04-17 13:47:03,230: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f6cb908>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111aa9860>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111aa9d68>]}
2018-04-17 13:47:03,231: Opening a new connection (0 currently allocated)
2018-04-17 13:47:03,240: Fetching data for query shopify_orders_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 13:47:03,376: Model SQL (agg_customers_union):
SELECT *
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`shopify_customers_proc`
2018-04-17 13:47:03,448: Model SQL (bing_ads_stats):
select
a.date, 
a.account, 
a.channel,
a.platform,
url,
a.campaignname campaign,
utm_campaign,
cost,
clicks,
impressions,
transactions
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`bing_ads_ads` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`bing_ads_conversions` b
ON (
	a.date = b.date AND
	a.account = b.account AND
	a.campaignid = b.campaignid

)
2018-04-17 13:47:03,450: Model SQL (ga_mcf_stats):
SELECT  
date,
a.account account,
b.client client,
case when c.platform is null then "Unmapped" else c.platform end as platform,
case when c.channel is null then "Unmapped" else c.channel end as channel,
lower(a.source) source,
lower(a.medium) medium,
lower(campaign) campaign,
transactionid,
sum(transactions) first_touch_transactions,
sum(revenue) first_touch_revenue
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`ga_mcf_proc` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc` b 
ON ( a.account = b.account and
	a.lookup_platform = b.platform )
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc` c
ON ( lower(a.source) = c.source
  AND lower(a.medium) = c.medium 
  and a.account = c.account )
group by date, account, client, source, medium, campaign, platform, channel, transactionid
2018-04-17 13:47:03,490: Encountered an error:
2018-04-17 13:47:03,490: 404 GET https://www.googleapis.com/bigquery/v2/projects/growth-engines-pipeline/datasets/agency_data_pipeline/tables?pageToken=ga_mcf_stats: Not found: Token ga_mcf_stats
2018-04-17 13:47:03,506: Traceback (most recent call last):
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/main.py", line 40, in main
    results, succeeded = handle_and_check(args)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/main.py", line 84, in handle_and_check
    task, res = run_from_args(parsed)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/main.py", line 138, in run_from_args
    results = run_from_task(task, proj, parsed)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/main.py", line 146, in run_from_task
    result = task.run()
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/task/run.py", line 26, in run
    results = runner.run(query, ModelRunner)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/runner.py", line 221, in run
    return self.run_from_graph(Selector, Runner, query)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/runner.py", line 208, in run_from_graph
    res = self.execute_nodes(linker, Runner, flat_graph, dep_list)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/runner.py", line 133, in execute_nodes
    for result in pool.imap_unordered(self.call_runner, args_list):
  File "/usr/local/opt/python3/Frameworks/Python.framework/Versions/3.6/lib/python3.6/multiprocessing/pool.py", line 735, in next
    raise value
  File "/usr/local/opt/python3/Frameworks/Python.framework/Versions/3.6/lib/python3.6/multiprocessing/pool.py", line 119, in worker
    result = (True, func(*args, **kwds))
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/runner.py", line 82, in call_runner
    result = runner.safe_run(flat_graph, existing)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/node_runners.py", line 139, in safe_run
    raise e
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/node_runners.py", line 108, in safe_run
    result = self.run(compiled_node, existing, flat_graph)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/node_runners.py", line 155, in run
    return self.execute(compiled_node, existing, flat_graph)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/node_runners.py", line 389, in execute
    materialization_macro.get('generator')(context)()
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/clients/jinja.py", line 51, in call
    return macro(*args, **kwargs)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/runtime.py", line 549, in __call__
    return self._invoke(arguments, autoescape)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/asyncsupport.py", line 110, in _invoke
    return original_invoke(self, arguments, autoescape)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/runtime.py", line 553, in _invoke
    rv = self._func(*arguments)
  File "<template>", line 55, in macro
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/sandbox.py", line 427, in call
    return __context.call(__obj, *args, **kwargs)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/runtime.py", line 260, in call
    return __obj(*args, **kwargs)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/context/common.py", line 48, in wrapped
    return getattr(self.adapter, fn)(*args, **kwargs)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/adapters/bigquery.py", line 154, in query_for_existing
    all_tables.extend(dataset.list_tables())
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/google/cloud/iterator.py", line 218, in _items_iter
    for page in self._page_iter(increment=False):
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/google/cloud/iterator.py", line 254, in _page_iter
    page = self._next_page()
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/google/cloud/iterator.py", line 348, in _next_page
    response = self._get_next_page_response()
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/google/cloud/iterator.py", line 399, in _get_next_page_response
    query_params=params)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/google/cloud/_http.py", line 293, in api_request
    raise exceptions.from_http_response(response)
google.cloud.exceptions.NotFound: 404 GET https://www.googleapis.com/bigquery/v2/projects/growth-engines-pipeline/datasets/agency_data_pipeline/tables?pageToken=ga_mcf_stats: Not found: Token ga_mcf_stats

2018-04-17 13:53:49,941: Tracking: tracking
2018-04-17 13:53:49,944: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d593588>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d593828>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d593ba8>]}
2018-04-17 13:53:50,674: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-04-17 13:53:50,694: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/growth-engines/dbt_modules
2018-04-17 13:53:50,703: Parsing get_column_values.sql
2018-04-17 13:53:50,727: Parsing get_url_parameter.sql
2018-04-17 13:53:50,734: Parsing split_part.sql
2018-04-17 13:53:50,742: Parsing table_exists.sql
2018-04-17 13:53:50,753: Parsing core.sql
2018-04-17 13:53:50,775: Parsing adapters/bigquery.sql
2018-04-17 13:53:50,787: Parsing adapters/common.sql
2018-04-17 13:53:50,809: Parsing adapters/postgres.sql
2018-04-17 13:53:50,815: Parsing adapters/redshift.sql
2018-04-17 13:53:50,841: Parsing etc/get_custom_schema.sql
2018-04-17 13:53:50,849: Parsing materializations/archive.sql
2018-04-17 13:53:50,884: Parsing materializations/bigquery.sql
2018-04-17 13:53:50,910: Parsing materializations/helpers.sql
2018-04-17 13:53:50,937: Parsing materializations/incremental.sql
2018-04-17 13:53:50,966: Parsing materializations/table.sql
2018-04-17 13:53:50,987: Parsing materializations/view.sql
2018-04-17 13:53:51,009: Parsing materializations/wrapper.sql
2018-04-17 13:53:51,015: Parsing schema_tests/accepted_values.sql
2018-04-17 13:53:51,023: Parsing schema_tests/not_null.sql
2018-04-17 13:53:51,028: Parsing schema_tests/relationships.sql
2018-04-17 13:53:51,034: Parsing schema_tests/unique.sql
2018-04-17 13:53:51,110: Parsing model.agency_data_pipeline.accounts_proc
2018-04-17 13:53:51,112: Parsing model.agency_data_pipeline.all_dates
2018-04-17 13:53:51,113: Parsing model.agency_data_pipeline.carts_proc
2018-04-17 13:53:51,115: Parsing model.agency_data_pipeline.clients_proc
2018-04-17 13:53:51,117: Parsing model.agency_data_pipeline.conversion_goals_proc
2018-04-17 13:53:51,118: Parsing model.agency_data_pipeline.mappings_ga_proc
2018-04-17 13:53:51,120: Acquiring new bigquery connection "master".
2018-04-17 13:53:51,120: Opening a new connection (0 currently allocated)
2018-04-17 13:53:51,126: Parsing model.agency_data_pipeline.monthend_dates
2018-04-17 13:53:51,130: Parsing model.agency_data_pipeline.adwords_ads
2018-04-17 13:53:51,134: Parsing model.agency_data_pipeline.adwords_campaigns
2018-04-17 13:53:51,136: Parsing model.agency_data_pipeline.adwords_conversions
2018-04-17 13:53:51,139: Parsing model.agency_data_pipeline.adwords_impression_share
2018-04-17 13:53:51,140: Parsing model.agency_data_pipeline.adwords_join
2018-04-17 13:53:51,142: Parsing model.agency_data_pipeline.adwords_stats
2018-04-17 13:53:51,144: Parsing model.agency_data_pipeline.adwords_urls
2018-04-17 13:53:51,148: Parsing model.agency_data_pipeline.bing_ads_ads
2018-04-17 13:53:51,153: Parsing model.agency_data_pipeline.bing_ads_conversions
2018-04-17 13:53:51,156: Parsing model.agency_data_pipeline.bing_ads_impression_share
2018-04-17 13:53:51,158: Parsing model.agency_data_pipeline.bing_ads_stats
2018-04-17 13:53:51,160: Parsing model.agency_data_pipeline.fb_adcreative
2018-04-17 13:53:51,166: Parsing model.agency_data_pipeline.fb_ads
2018-04-17 13:53:51,171: Parsing model.agency_data_pipeline.fb_ads_insights
2018-04-17 13:53:51,176: Parsing model.agency_data_pipeline.fb_ads_insights_conversions
2018-04-17 13:53:51,183: Parsing model.agency_data_pipeline.fb_ads_stats
2018-04-17 13:53:51,187: Parsing model.agency_data_pipeline.ga_conversions
2018-04-17 13:53:51,189: Parsing model.agency_data_pipeline.ga_traffic
2018-04-17 13:53:51,202: Parsing model.agency_data_pipeline.ga_transactions
2018-04-17 13:53:51,212: Parsing model.agency_data_pipeline.ga_mcf_proc
2018-04-17 13:53:51,216: Parsing model.agency_data_pipeline.ga_mcf_stats
2018-04-17 13:53:51,221: Parsing model.agency_data_pipeline.shopify_customers_proc
2018-04-17 13:53:51,232: Parsing model.agency_data_pipeline.shopify_orders_proc
2018-04-17 13:53:51,242: Parsing model.agency_data_pipeline.shopify_products_proc
2018-04-17 13:53:51,249: Parsing model.agency_data_pipeline.shopify_refunds_proc
2018-04-17 13:53:51,254: Parsing model.agency_data_pipeline.agg_campaign
2018-04-17 13:53:51,257: Parsing model.agency_data_pipeline.agg_customers_union
2018-04-17 13:53:51,258: Parsing model.agency_data_pipeline.agg_ga_campaign
2018-04-17 13:53:51,261: Parsing model.agency_data_pipeline.agg_ga_campaign_by_type
2018-04-17 13:53:51,264: Parsing model.agency_data_pipeline.agg_ga_transaction
2018-04-17 13:53:51,267: Parsing model.agency_data_pipeline.agg_ga_transaction_order_number
2018-04-17 13:53:51,270: Parsing model.agency_data_pipeline.agg_orders_union
2018-04-17 13:53:51,271: Parsing model.agency_data_pipeline.agg_platform_monthly
2018-04-17 13:53:51,273: Parsing model.agency_data_pipeline.agg_platforms_client
2018-04-17 13:53:51,275: Parsing model.agency_data_pipeline.agg_platforms_union
2018-04-17 13:53:51,277: Parsing model.agency_data_pipeline.agg_products
2018-04-17 13:53:51,279: Parsing model.agency_data_pipeline.agg_transaction
2018-04-17 13:53:51,281: Parsing model.agency_data_pipeline.agg_transaction_daily
2018-04-17 13:53:51,283: Parsing model.agency_data_pipeline.agg_transaction_line_item
2018-04-17 13:53:51,285: Parsing model.agency_data_pipeline.agg_transaction_line_item_type
2018-04-17 13:53:51,287: Parsing model.agency_data_pipeline.agg_transaction_order_number
2018-04-17 13:53:51,289: Parsing model.agency_data_pipeline.agg_transaction_product_type
2018-04-17 13:53:51,291: Parsing model.agency_data_pipeline.customers_by_transaction
2018-04-17 13:53:51,293: Parsing model.agency_data_pipeline.growth_customer_0_365
2018-04-17 13:53:51,296: Parsing model.agency_data_pipeline.growth_customer_0_365_segment
2018-04-17 13:53:51,299: Parsing model.agency_data_pipeline.growth_date_union
2018-04-17 13:53:51,301: Parsing model.agency_data_pipeline.growth_stats
2018-04-17 13:53:51,306: Parsing model.agency_data_pipeline.retention_0_365
2018-04-17 13:53:51,308: Parsing model.agency_data_pipeline.retention_0_365_new
2018-04-17 13:53:51,311: Parsing model.agency_data_pipeline.retention_0_365_reactivated
2018-04-17 13:53:51,314: Parsing model.agency_data_pipeline.retention_0_365_rebuy
2018-04-17 13:53:51,316: Parsing model.agency_data_pipeline.retention_365_730
2018-04-17 13:53:51,318: Parsing model.agency_data_pipeline.retention_730_plus
2018-04-17 13:53:51,320: Parsing model.agency_data_pipeline.retention_stats
2018-04-17 13:53:51,325: Parsing model.agency_data_pipeline.retention_stats_rebuy_rate
2018-04-17 13:53:51,328: Parsing model.agency_data_pipeline.retention_0_30
2018-04-17 13:53:51,330: Parsing model.agency_data_pipeline.retention_0_30_new
2018-04-17 13:53:51,333: Parsing model.agency_data_pipeline.retention_0_30_reactivated
2018-04-17 13:53:51,336: Parsing model.agency_data_pipeline.retention_0_30_rebuy
2018-04-17 13:53:51,338: Parsing model.agency_data_pipeline.retention_30_60
2018-04-17 13:53:51,340: Parsing model.agency_data_pipeline.retention_60_plus
2018-04-17 13:53:51,342: Parsing model.agency_data_pipeline.retention_stats_month
2018-04-17 13:53:51,347: Parsing model.agency_data_pipeline.retention_stats_rebuy_rate_month
2018-04-17 13:53:51,349: Parsing model.agency_data_pipeline.customers_first_purchase_proc
2018-04-17 13:53:51,351: Parsing model.agency_data_pipeline.customers_proc
2018-04-17 13:53:51,354: Parsing model.agency_data_pipeline.segment_list_customers
2018-04-17 13:53:51,355: Parsing model.agency_data_pipeline.segment_proc_customers
2018-04-17 13:53:51,358: Parsing model.agency_data_pipeline.segment_stats_customers
2018-04-17 13:53:51,360: Parsing model.agency_data_pipeline.segment_stats_customers_agg
2018-04-17 13:53:51,363: Parsing model.agency_data_pipeline.customers_first_purchase_product_type_proc
2018-04-17 13:53:51,364: Parsing model.agency_data_pipeline.customers_products_proc
2018-04-17 13:53:51,367: Parsing model.agency_data_pipeline.segment_list_customers_products
2018-04-17 13:53:51,369: Parsing model.agency_data_pipeline.segment_proc_customers_products
2018-04-17 13:53:51,372: Parsing model.agency_data_pipeline.segment_stats_customers_products
2018-04-17 13:53:51,373: Parsing model.agency_data_pipeline.segment_stats_customers_products_agg
2018-04-17 13:53:51,376: Parsing model.agency_data_pipeline.frequency_proc
2018-04-17 13:53:51,379: Parsing model.agency_data_pipeline.frequency_stats
2018-04-17 13:53:51,380: Parsing model.agency_data_pipeline.order_paths_agg
2018-04-17 13:53:51,382: Parsing model.agency_data_pipeline.order_paths_proc
2018-04-17 13:53:51,384: Parsing model.agency_data_pipeline.order_paths_stats
2018-04-17 13:53:51,387: Parsing model.agency_data_pipeline.products_proc
2018-04-17 13:53:51,389: Parsing model.agency_data_pipeline.segment_proc_sku
2018-04-17 13:53:51,391: Parsing model.agency_data_pipeline.segment_stats_category
2018-04-17 13:53:51,393: Parsing model.agency_data_pipeline.segment_stats_sku
2018-04-17 13:53:51,427: Found 91 models, 0 tests, 0 archives, 0 analyses, 46 macros, 0 operations
2018-04-17 13:53:51,500: 
2018-04-17 13:53:52,979: 13:53:52 | Concurrency: 4 threads (target='prod')
2018-04-17 13:53:52,979: 13:53:52 | 
2018-04-17 13:53:53,795: 13:53:53 | 1 of 91 START table model agency_data_pipeline.adwords_conversions... [RUN]
2018-04-17 13:53:53,795: Compiling model.agency_data_pipeline.adwords_conversions
2018-04-17 13:53:53,800: Writing injected SQL for node "model.agency_data_pipeline.adwords_conversions"
2018-04-17 13:53:53,795: 13:53:53 | 2 of 91 START table model agency_data_pipeline.adwords_urls.......... [RUN]
2018-04-17 13:53:53,795: 13:53:53 | 3 of 91 START table model agency_data_pipeline.conversion_goals_proc. [RUN]
2018-04-17 13:53:53,801: Compiling model.agency_data_pipeline.adwords_urls
2018-04-17 13:53:53,795: 13:53:53 | 4 of 91 START table model agency_data_pipeline.accounts_proc......... [RUN]
2018-04-17 13:53:53,801: Compiling model.agency_data_pipeline.conversion_goals_proc
2018-04-17 13:53:53,805: Writing injected SQL for node "model.agency_data_pipeline.adwords_urls"
2018-04-17 13:53:53,805: Compiling model.agency_data_pipeline.accounts_proc
2018-04-17 13:53:53,810: Writing injected SQL for node "model.agency_data_pipeline.conversion_goals_proc"
2018-04-17 13:53:53,811: Acquiring new bigquery connection "adwords_conversions".
2018-04-17 13:53:53,817: Writing injected SQL for node "model.agency_data_pipeline.accounts_proc"
2018-04-17 13:53:53,817: Opening a new connection (1 currently allocated)
2018-04-17 13:53:53,818: Acquiring new bigquery connection "conversion_goals_proc".
2018-04-17 13:53:53,819: Acquiring new bigquery connection "adwords_urls".
2018-04-17 13:53:53,826: Acquiring new bigquery connection "accounts_proc".
2018-04-17 13:53:53,892: Opening a new connection (2 currently allocated)
2018-04-17 13:53:53,899: Opening a new connection (3 currently allocated)
2018-04-17 13:53:53,902: Opening a new connection (4 currently allocated)
2018-04-17 13:53:55,538: Model SQL (conversion_goals_proc):
select 
client,
platform,
goal_name,
max(goal_type) goal_type,
account,
max(time_of_entry) time_of_entry
from  ( 

SELECT  
client,
platform,
trim(replace(replace(lower(goal_name),',',''),' ','')) goal_name,
goal_type,
account,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY platform ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.conversion_goals` 

) 

WHERE lv = time_of_entry
group by client, platform, account, goal_name
2018-04-17 13:53:55,539: Model SQL (adwords_urls):
SELECT
campaignid,
lower(trim(regexp_replace(replace(replace(replace(replace(finalurl,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url

FROM (

SELECT  
campaignid,
finalurl,
first_value(finalurl) OVER (PARTITION BY campaignid ORDER BY day DESC) lv
FROM `growth-engines-pipeline.adwords_2.FINAL_URL_REPORT`
)

WHERE lv = finalurl
group by campaignid, url
order by campaignid asc
2018-04-17 13:53:55,543: Model SQL (adwords_conversions):
select 
client,
client_name,
platform,
goal_name,
goal_type,
account,
time_of_entry
from  ( 

SELECT  
client,
client_name,
platform,
trim(lower(goal_name)) goal_name,
goal_type,
account,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform, goal_name ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.conversion_goals` 
WHERE platform = 'Adwords'

) 

WHERE lv = time_of_entry
2018-04-17 13:53:55,603: Model SQL (accounts_proc):
select 
client,
account,
platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.accounts` 

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-04-17 13:53:57,779: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d7c0780>]}
2018-04-17 13:53:57,792: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d7c0e80>]}
2018-04-17 13:53:57,827: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d7c09b0>]}
2018-04-17 13:53:57,832: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d7c0b00>]}
2018-04-17 13:53:58,011: 13:53:58 | 3 of 91 OK created table model agency_data_pipeline.conversion_goals_proc [CREATE TABLE in 3.98s]
2018-04-17 13:53:58,011: 13:53:58 | 5 of 91 START table model agency_data_pipeline.adwords_campaigns..... [RUN]
2018-04-17 13:53:58,011: Compiling model.agency_data_pipeline.adwords_campaigns
2018-04-17 13:53:58,020: Writing injected SQL for node "model.agency_data_pipeline.adwords_campaigns"
2018-04-17 13:53:58,027: Acquiring new bigquery connection "adwords_campaigns".
2018-04-17 13:53:58,027: Re-using an available connection from the pool.
2018-04-17 13:53:58,356: 13:53:58 | 2 of 91 OK created table model agency_data_pipeline.adwords_urls..... [CREATE TABLE in 3.99s]
2018-04-17 13:53:58,358: 13:53:58 | 6 of 91 START table model agency_data_pipeline.bing_ads_impression_share [RUN]
2018-04-17 13:53:58,362: Compiling model.agency_data_pipeline.bing_ads_impression_share
2018-04-17 13:53:58,376: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_impression_share"
2018-04-17 13:53:58,382: Acquiring new bigquery connection "bing_ads_impression_share".
2018-04-17 13:53:58,383: Re-using an available connection from the pool.
2018-04-17 13:53:58,609: 13:53:58 | 1 of 91 OK created table model agency_data_pipeline.adwords_conversions [CREATE TABLE in 4.03s]
2018-04-17 13:53:58,611: 13:53:58 | 7 of 91 START table model agency_data_pipeline.bing_ads_ads.......... [RUN]
2018-04-17 13:53:58,613: Compiling model.agency_data_pipeline.bing_ads_ads
2018-04-17 13:53:58,620: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_ads"
2018-04-17 13:53:58,621: Acquiring new bigquery connection "bing_ads_ads".
2018-04-17 13:53:58,621: Re-using an available connection from the pool.
2018-04-17 13:53:58,867: 13:53:58 | 4 of 91 OK created table model agency_data_pipeline.accounts_proc.... [CREATE TABLE in 4.03s]
2018-04-17 13:53:58,868: 13:53:58 | 8 of 91 START table model agency_data_pipeline.ga_conversions........ [RUN]
2018-04-17 13:53:58,868: Compiling model.agency_data_pipeline.ga_conversions
2018-04-17 13:53:58,875: Writing injected SQL for node "model.agency_data_pipeline.ga_conversions"
2018-04-17 13:53:58,878: Acquiring new bigquery connection "ga_conversions".
2018-04-17 13:53:58,878: Re-using an available connection from the pool.
2018-04-17 13:53:59,128: Model SQL (adwords_campaigns):
select
day,
campaignid, 
campaign,
account, 
channel,
platform,
sum(cost) cost,
sum(impressions) impressions,
sum(clicks) clicks,
sum(impression_share_num) impression_share_num,
sum(impression_share_den) impression_share_den
from 
  ( 
	SELECT  
	day,
	campaignid,
	campaign,
	account as account,
	'Paid' as channel,
	'Adwords' as platform,
	cost/1000000 cost, 
	impressions as impressions, 
	clicks, 
	case when searchimprshare is not null then impressions end as impression_share_num,
	case when searchimprshare is not null then impressions/(searchimprshare/100) end as impression_share_den,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY campaignid, day ORDER BY _sdc_sequence DESC) lv
	FROM `growth-engines-pipeline.adwords_2.CAMPAIGN_PERFORMANCE_REPORT`
  )
where lv = _sdc_sequence
group by day, campaignid, account, channel, platform, campaign
2018-04-17 13:53:59,490: Model SQL (bing_ads_ads):
select
date, 
account, 
channel,
platform,
campaignid,
campaignname,
max(lower(trim(replace(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$','' ),'.html',''),'/'))) as url,
utm_campaign,
sum(cost) as cost,
sum(impressions) as impressions,
sum(clicks) as clicks,
sum(conversions) as conversions
from 
  ( 
SELECT  
cast(gregoriandate as date) date,
replace(accountname,',','') account,
'Paid' as channel,
'Bing Ads' as platform,
adid,
adtype,
campaignid, 
campaignname,
finalurl url,
case when regexp_contains(destinationurl, 'utm_campaign')
	then replace(lower(nullif(
  

    split(
        
  

    split(
        destinationurl,
        'utm_campaign='
        )[offset(1)]


,
        '&'
        )[offset(0)]


,'')),'+',' ') 
	else null end as utm_campaign,
spend cost, 
impressions, 
clicks, 
conversions,
_sdc_sequence,
first_value(_sdc_sequence) OVER (PARTITION BY adid, gregoriandate ORDER BY _sdc_sequence DESC) lv
FROM `growth-engines-pipeline.bing_ads.ad_performance_report` 
  )

where lv = _sdc_sequence
group by date, account, channel, platform, campaignid, campaignname, utm_campaign
2018-04-17 13:53:59,554: Model SQL (bing_ads_impression_share):
SELECT 
date, 
account,
channel,
platform,
sum(impressions) impressions,
sum(available_impressions) available_impressions
FROM

(

SELECT  
cast(gregoriandate as date) date,
replace(accountname,',','') account,  
'Paid' as channel,
'Bing Ads' as platform,
case when impressionsharepercent is null then 0 else impressions end as impressions,
cast(round(case when ( impressionsharepercent is not null and impressionsharepercent > 0 ) then (impressions*100)/impressionsharepercent else 0 end) as int64) as available_impressions,
_sdc_sequence,
first_value(_sdc_sequence) OVER (PARTITION BY campaignid, gregoriandate ORDER BY _sdc_sequence DESC) lv
FROM `growth-engines-pipeline.bing_ads.campaign_performance_report` 

)

where lv = _sdc_sequence
group by date, account, channel, platform
2018-04-17 13:53:59,718: Model SQL (ga_conversions):
select 
client,
client_name,
platform,
goal_name,
goal_type,
account,
time_of_entry
from  ( 

SELECT  
client,
client_name,
platform,
trim(goal_name) goal_name,
goal_type,
account,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform, goal_name ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.conversion_goals` 
WHERE platform = 'Google Analytics'

) 

WHERE lv = time_of_entry
2018-04-17 13:54:01,828: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fb66630>]}
2018-04-17 13:54:01,980: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d7c0b00>]}
2018-04-17 13:54:02,510: 13:54:02 | 6 of 91 OK created table model agency_data_pipeline.bing_ads_impression_share [CREATE TABLE in 3.47s]
2018-04-17 13:54:02,511: 13:54:02 | 9 of 91 START table model agency_data_pipeline.monthend_dates........ [RUN]
2018-04-17 13:54:02,512: Compiling model.agency_data_pipeline.monthend_dates
2018-04-17 13:54:02,522: Writing injected SQL for node "model.agency_data_pipeline.monthend_dates"
2018-04-17 13:54:02,525: Acquiring new bigquery connection "monthend_dates".
2018-04-17 13:54:02,525: Re-using an available connection from the pool.
2018-04-17 13:54:02,751: 13:54:02 | 8 of 91 OK created table model agency_data_pipeline.ga_conversions... [CREATE TABLE in 3.11s]
2018-04-17 13:54:02,751: 13:54:02 | 10 of 91 START table model agency_data_pipeline.carts_proc........... [RUN]
2018-04-17 13:54:02,751: Compiling model.agency_data_pipeline.carts_proc
2018-04-17 13:54:02,756: Writing injected SQL for node "model.agency_data_pipeline.carts_proc"
2018-04-17 13:54:02,757: Acquiring new bigquery connection "carts_proc".
2018-04-17 13:54:02,757: Re-using an available connection from the pool.
2018-04-17 13:54:02,899: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d7c09b0>]}
2018-04-17 13:54:03,127: 13:54:03 | 7 of 91 OK created table model agency_data_pipeline.bing_ads_ads..... [CREATE TABLE in 4.29s]
2018-04-17 13:54:03,128: 13:54:03 | 11 of 91 START table model agency_data_pipeline.all_dates............ [RUN]
2018-04-17 13:54:03,128: Compiling model.agency_data_pipeline.all_dates
2018-04-17 13:54:03,136: Writing injected SQL for node "model.agency_data_pipeline.all_dates"
2018-04-17 13:54:03,137: Acquiring new bigquery connection "all_dates".
2018-04-17 13:54:03,137: Re-using an available connection from the pool.
2018-04-17 13:54:03,352: Model SQL (monthend_dates):
SELECT
date_in_range,
date_in_range_bom,
date_in_range_bom_mom,
unix_date_in_range,
unix_date_in_range_bom,
unix_date(date_in_range_bom_mom) unix_date_in_range_bom_mom,
yyyymm,
date_in_range_yoy,
unix_date(date_in_range_yoy) unix_date_in_range_yoy

FROM
(
	SELECT 
	date_in_range,
	date_in_range_bom,
	date_sub(date_in_range_bom, INTERVAL 1 MONTH) date_in_range_bom_mom,
  date_sub(date_in_range, INTERVAL 1 YEAR) date_in_range_yoy,
	unix_date_in_range,
	unix_date(date_in_range_bom) unix_date_in_range_bom,
	yyyymm,
	first_value(date_in_range) over (partition by yyyymm order by date_in_range desc) monthend_date_in_range
	FROM
	( 
		SELECT 
		date_in_range,
		date_trunc( date_in_range, MONTH) date_in_range_bom,
		unix_date(date_in_range) unix_date_in_range,
		format_date("%Y-%m", date_in_range) AS yyyymm
		FROM UNNEST(
		    GENERATE_DATE_ARRAY(DATE('2016-01-31'), CURRENT_DATE(), INTERVAL 1 DAY)
		) AS date_in_range
	)
)
where date_in_range = monthend_date_in_range
2018-04-17 13:54:03,532: Model SQL (carts_proc):
select 
client,
client_name,
account,
platform
from  ( 

SELECT  
client,
client_name,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.accounts`
WHERE platform in ('Shopify', 'Custom cart')

) 

WHERE lv = time_of_entry
2018-04-17 13:54:03,897: Model SQL (all_dates):
SELECT 
date_in_range,
unix_date(date_in_range) unix_date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-04-17 13:54:04,673: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d7c0b00>]}
2018-04-17 13:54:04,833: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fb82240>]}
2018-04-17 13:54:04,907: 13:54:04 | 10 of 91 OK created table model agency_data_pipeline.carts_proc...... [CREATE TABLE in 1.92s]
2018-04-17 13:54:04,909: 13:54:04 | 12 of 91 START table model agency_data_pipeline.clients_proc......... [RUN]
2018-04-17 13:54:04,909: Compiling model.agency_data_pipeline.clients_proc
2018-04-17 13:54:04,921: Writing injected SQL for node "model.agency_data_pipeline.clients_proc"
2018-04-17 13:54:04,923: Acquiring new bigquery connection "clients_proc".
2018-04-17 13:54:04,924: Re-using an available connection from the pool.
2018-04-17 13:54:05,151: 13:54:05 | 5 of 91 OK created table model agency_data_pipeline.adwords_campaigns [CREATE TABLE in 6.82s]
2018-04-17 13:54:05,612: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d822c50>]}
2018-04-17 13:54:05,847: 13:54:05 | 9 of 91 OK created table model agency_data_pipeline.monthend_dates... [CREATE TABLE in 3.10s]
2018-04-17 13:54:06,117: Model SQL (clients_proc):
select 
client,
client_name,
account,
platform
from  ( 

SELECT  
client,
client_name,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.accounts`
where client_name != ''
) 

WHERE lv = time_of_entry
2018-04-17 13:54:06,141: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d7c09b0>]}
2018-04-17 13:54:06,395: 13:54:06 | 11 of 91 OK created table model agency_data_pipeline.all_dates....... [CREATE TABLE in 3.01s]
2018-04-17 13:54:07,253: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fb665c0>]}
2018-04-17 13:54:07,503: 13:54:07 | 12 of 91 OK created table model agency_data_pipeline.clients_proc.... [CREATE TABLE in 2.34s]
2018-04-17 13:54:07,504: 13:54:07 | 13 of 91 START table model agency_data_pipeline.fb_adcreative........ [RUN]
2018-04-17 13:54:07,505: Compiling model.agency_data_pipeline.fb_adcreative
2018-04-17 13:54:07,514: Acquiring new bigquery connection "fb_adcreative".
2018-04-17 13:54:07,514: Re-using an available connection from the pool.
2018-04-17 13:54:07,514: Fetching data for query fb_adcreative:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 13:54:07,505: 13:54:07 | 14 of 91 START table model agency_data_pipeline.mappings_ga_proc..... [RUN]
2018-04-17 13:54:07,515: Compiling model.agency_data_pipeline.mappings_ga_proc
2018-04-17 13:54:07,520: Writing injected SQL for node "model.agency_data_pipeline.mappings_ga_proc"
2018-04-17 13:54:07,505: 13:54:07 | 15 of 91 START table model agency_data_pipeline.adwords_ads.......... [RUN]
2018-04-17 13:54:07,521: Compiling model.agency_data_pipeline.adwords_ads
2018-04-17 13:54:07,526: Writing injected SQL for node "model.agency_data_pipeline.adwords_ads"
2018-04-17 13:54:07,505: 13:54:07 | 16 of 91 START table model agency_data_pipeline.bing_ads_conversions. [RUN]
2018-04-17 13:54:07,527: Compiling model.agency_data_pipeline.bing_ads_conversions
2018-04-17 13:54:07,534: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_conversions"
2018-04-17 13:54:07,535: Acquiring new bigquery connection "mappings_ga_proc".
2018-04-17 13:54:07,536: Re-using an available connection from the pool.
2018-04-17 13:54:07,545: Acquiring new bigquery connection "adwords_ads".
2018-04-17 13:54:07,545: Re-using an available connection from the pool.
2018-04-17 13:54:07,560: Acquiring new bigquery connection "bing_ads_conversions".
2018-04-17 13:54:07,560: Re-using an available connection from the pool.
2018-04-17 13:54:08,509: Model SQL (mappings_ga_proc):
select 
client,
account,
client_name,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
account,
client_name,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.mappings_ga` 

) 

WHERE lv = time_of_entry
and client in (select client from `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc` )
group by client, account, client_name, source, medium, platform_n, channel_n, time_of_entry
2018-04-17 13:54:08,525: Model SQL (adwords_ads):
SELECT  
day,
campaignid,
a.account as account,
utm_campaign,
sum( case when b.goal_type = 'Transaction' then conversions else 0 end ) as transactions
FROM (

	SELECT  
	day,
	adid,
	campaignid,
	account,
	lower(conversionname) conversionname,
	conversions,
	lower(campaign) utm_campaign,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY campaignid, day ORDER BY _sdc_sequence DESC) lv
	FROM
	`growth-engines-pipeline.adwords_2.AD_PERFORMANCE_REPORT`

) a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_conversions` b
ON ( a.conversionname = b.goal_name
	AND a.account = b.account )
WHERE lv = _sdc_sequence
group by day, campaignid, account, utm_campaign
2018-04-17 13:54:08,569: Model SQL (bing_ads_conversions):
SELECT
date, 
a.account account, 
a.channel channel,
a.platform platform,
campaignid,
campaignname,
sum( case when b.goal_type = 'Transactions' then conversions else 0 end ) as transactions
FROM

  ( 
SELECT  
cast(gregoriandate as date) date,
replace(accountname,',','') account,
'Paid' as channel,
'Bing Ads' as platform,
trim(replace(replace(lower(goal),',',''),' ','')) goal,
goalid,
campaignid,
campaignname,
conversions,
_sdc_sequence,
first_value(_sdc_sequence) OVER (PARTITION BY campaignid, goalid, gregoriandate ORDER BY _sdc_sequence DESC) lv
FROM `growth-engines-pipeline.bing_ads.goals_and_funnels_report` 

  ) a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`conversion_goals_proc` b
ON (
	a.account = b.account AND
	a.platform = b.platform AND
	a.goal = b.goal_name
)
where a.lv = a._sdc_sequence
group by date, account, channel, platform, campaignid, campaignname
2018-04-17 13:54:08,760: Writing injected SQL for node "model.agency_data_pipeline.fb_adcreative"
2018-04-17 13:54:09,558: Model SQL (fb_adcreative):




with fb_adcreative as (


	    
		   	SELECT 
			id,
			object_url,
			url_tags,
			_sdc_sequence
			FROM `growth-engines-pipeline.fb_ads_luca_danni.adcreative`
		    
	   
)

select creative_id, max(url) url
from (
  select
  id creative_id,
  lower(trim(regexp_replace(replace(replace(replace(replace(object_url,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
  first_value(_sdc_sequence) OVER (PARTITION BY id ORDER BY _sdc_sequence DESC) lv,
  _sdc_sequence
  from fb_adcreative
  )
where lv = _sdc_sequence
group by creative_id


2018-04-17 13:54:10,783: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d707278>]}
2018-04-17 13:54:10,791: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d66bef0>]}
2018-04-17 13:54:10,799: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fba9780>]}
2018-04-17 13:54:11,021: 13:54:11 | 15 of 91 OK created table model agency_data_pipeline.adwords_ads..... [CREATE TABLE in 3.26s]
2018-04-17 13:54:11,023: 13:54:11 | 17 of 91 START table model agency_data_pipeline.fb_ads_insights...... [RUN]
2018-04-17 13:54:11,025: Compiling model.agency_data_pipeline.fb_ads_insights
2018-04-17 13:54:11,037: Acquiring new bigquery connection "fb_ads_insights".
2018-04-17 13:54:11,037: Re-using an available connection from the pool.
2018-04-17 13:54:11,037: Fetching data for query fb_ads_insights:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 13:54:11,259: 13:54:11 | 14 of 91 OK created table model agency_data_pipeline.mappings_ga_proc [CREATE TABLE in 3.28s]
2018-04-17 13:54:11,260: 13:54:11 | 18 of 91 START table model agency_data_pipeline.fb_ads_insights_conversions [RUN]
2018-04-17 13:54:11,261: Compiling model.agency_data_pipeline.fb_ads_insights_conversions
2018-04-17 13:54:11,276: Acquiring new bigquery connection "fb_ads_insights_conversions".
2018-04-17 13:54:11,276: Re-using an available connection from the pool.
2018-04-17 13:54:11,276: Fetching data for query fb_ads_insights_conversions:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 13:54:11,432: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_insights"
2018-04-17 13:54:11,530: 13:54:11 | 16 of 91 OK created table model agency_data_pipeline.bing_ads_conversions [CREATE TABLE in 3.27s]
2018-04-17 13:54:11,531: 13:54:11 | 19 of 91 START table model agency_data_pipeline.shopify_refunds_proc. [RUN]
2018-04-17 13:54:11,531: Compiling model.agency_data_pipeline.shopify_refunds_proc
2018-04-17 13:54:11,545: Acquiring new bigquery connection "shopify_refunds_proc".
2018-04-17 13:54:11,546: Re-using an available connection from the pool.
2018-04-17 13:54:11,546: Fetching data for query shopify_refunds_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 13:54:11,682: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_insights_conversions"
2018-04-17 13:54:11,811: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fb99d68>]}
2018-04-17 13:54:12,046: 13:54:12 | 13 of 91 OK created table model agency_data_pipeline.fb_adcreative... [CREATE TABLE in 4.31s]
2018-04-17 13:54:12,046: 13:54:12 | 20 of 91 START table model agency_data_pipeline.ga_mcf_proc.......... [RUN]
2018-04-17 13:54:12,047: Compiling model.agency_data_pipeline.ga_mcf_proc
2018-04-17 13:54:12,054: Writing injected SQL for node "model.agency_data_pipeline.ga_mcf_proc"
2018-04-17 13:54:12,055: Acquiring new bigquery connection "ga_mcf_proc".
2018-04-17 13:54:12,055: Re-using an available connection from the pool.
2018-04-17 13:54:12,480: Model SQL (fb_ads_insights):




with fb_ads_insights as (

	    
		   	SELECT 
			date_start,
			campaign_id,
			campaign_name,
			ad_id,
			account_name,
			spend,
			reach,
			inline_link_clicks,
			_sdc_sequence,
			first_value(_sdc_sequence) OVER (PARTITION BY date_start, ad_id, campaign_id ORDER BY _sdc_sequence DESC) lv
			FROM `growth-engines-pipeline.fb_ads_luca_danni.ads_insights`
		    
	   

)

select
date_start date,
campaign_id,
campaign_name campaign,
ad_id,
account_name account,
max(spend) cost,
max(reach) impressions,
max(inline_link_clicks) clicks
from fb_ads_insights
where lv = _sdc_sequence
group by date, campaign_id, ad_id, account, campaign


2018-04-17 13:54:12,563: Model SQL (fb_ads_insights_conversions):




with fb_ads_insights_conversions as (

	    
		   	SELECT 
			date_start,
			campaign_id,
			campaign_name,
			ad_id,
			account_name,
			spend,
			reach,
			inline_link_clicks,
			_sdc_sequence,
			action_type,
			value
			FROM `growth-engines-pipeline.fb_ads_luca_danni.ads_insights`
			cross join unnest(actions)
		    
	   

)

SELECT * 
FROM 
	(
    SELECT
    date_start date,
    campaign_id,
    campaign_name campaign,
    ad_id,
    account_name account,
    action_type,
    value conversions,
    first_value(_sdc_sequence) OVER (PARTITION BY ad_id, date_start ORDER BY _sdc_sequence DESC) lv,
    _sdc_sequence
    FROM fb_ads_insights_conversions
   	)
where lv = _sdc_sequence
and action_type like '%purchase%'


2018-04-17 13:54:12,771: Writing injected SQL for node "model.agency_data_pipeline.shopify_refunds_proc"
2018-04-17 13:54:12,799: Model SQL (ga_mcf_proc):
SELECT 
date,
account,
'Google Analytics' as lookup_platform,
source_medium_path,
trim(lower(split(split(source_medium_path,'->')[SAFE_ORDINAL(1)],'/')[SAFE_ORDINAL(1)])) as source,
trim(lower(split(split(source_medium_path,'->')[SAFE_ORDINAL(1)],'/')[SAFE_ORDINAL(2)])) as medium,
first_interaction_campaign campaign,
cast(regexp_replace(transaction_id, r'#', '') as int64) transactionid,
max(first_interaction_conversions) transactions,
max(first_interaction_conversion_value) revenue
FROM `growth-engines-pipeline.agency_data_pipeline.ga_mcf`
where account in (select account from `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc` where platform = 'Google Analytics')
group by date, account, source, medium, campaign, source_medium_path, lookup_platform, transactionid
2018-04-17 13:54:13,591: Model SQL (shopify_refunds_proc):




with refunds as (

	
	SELECT
	order_number,
	checkout_id,
	financial_status,
	line_item_id,
	quantity,
	subtotal,
	line_item.variant_id variant_id,
	line_item.id refund_id,
 	_sdc_sequence
	FROM `growth-engines-pipeline.shopify_lucadanni.orders` 
	cross join unnest(refunds), unnest(refund_line_items)
  	where financial_status like '%refund%'
	
	

)

SELECT * 
FROM 
	(
    SELECT
	order_number,
	checkout_id,
	financial_status,
	line_item_id,
	quantity,
	subtotal refund_amount,
	variant_id,
	refund_id,
 	_sdc_sequence,
    first_value(_sdc_sequence) OVER (PARTITION BY order_number, line_item_id ORDER BY _sdc_sequence DESC) lv
    FROM refunds
   	) 
WHERE lv = _sdc_sequence


2018-04-17 13:54:15,810: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d822c50>]}
2018-04-17 13:54:15,855: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d707278>]}
2018-04-17 13:54:16,342: 13:54:16 | 19 of 91 OK created table model agency_data_pipeline.shopify_refunds_proc [CREATE TABLE in 4.28s]
2018-04-17 13:54:16,571: 13:54:16 | 17 of 91 OK created table model agency_data_pipeline.fb_ads_insights. [CREATE TABLE in 4.83s]
2018-04-17 13:54:17,047: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d66bef0>]}
2018-04-17 13:54:17,283: 13:54:17 | 18 of 91 OK created table model agency_data_pipeline.fb_ads_insights_conversions [CREATE TABLE in 5.79s]
2018-04-17 13:54:18,354: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d7dda20>]}
2018-04-17 13:54:18,651: 13:54:18 | 20 of 91 OK created table model agency_data_pipeline.ga_mcf_proc..... [CREATE TABLE in 6.31s]
2018-04-17 13:54:18,652: 13:54:18 | 21 of 91 START table model agency_data_pipeline.fb_ads............... [RUN]
2018-04-17 13:54:18,653: Compiling model.agency_data_pipeline.fb_ads
2018-04-17 13:54:18,652: 13:54:18 | 22 of 91 START table model agency_data_pipeline.shopify_customers_proc [RUN]
2018-04-17 13:54:18,659: Compiling model.agency_data_pipeline.shopify_customers_proc
2018-04-17 13:54:18,678: Acquiring new bigquery connection "shopify_customers_proc".
2018-04-17 13:54:18,678: Re-using an available connection from the pool.
2018-04-17 13:54:18,678: Fetching data for query shopify_customers_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 13:54:18,679: Acquiring new bigquery connection "fb_ads".
2018-04-17 13:54:18,679: Re-using an available connection from the pool.
2018-04-17 13:54:18,679: Fetching data for query fb_ads:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 13:54:19,080: Writing injected SQL for node "model.agency_data_pipeline.shopify_customers_proc"
2018-04-17 13:54:19,207: Writing injected SQL for node "model.agency_data_pipeline.fb_ads"
2018-04-17 13:54:20,114: Model SQL (shopify_customers_proc):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc`





with customers as (

	
	SELECT
	'lucadanni' client_name,
	'Shopify' as lookup_platform,
	cast(created_at as date) created_at,
	id,
	first_name,
	last_name,
	email,
	_sdc_sequence,
	first_value(_sdc_sequence) over (partition by id, _sdc_sequence order by _sdc_sequence desc) lv
	FROM `growth-engines-pipeline.shopify_lucadanni.customers` 
	
	

)

SELECT
account,
client,
platform,
id,
min(created_at) created_at,
max(first_name) first_name,
max(last_name) last_name,
max(email) email
FROM (
	SELECT
	b.account,
	b.client,
	b.platform,
	created_at,
	id,
	first_name,
	last_name,
	email
	FROM customers a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
	ON ( a.client_name = b.client_name
	  AND a.lookup_platform = b.platform )
	where a.lv = a._sdc_sequence
)
group by account, client, platform, id

2018-04-17 13:54:20,115: Model SQL (fb_ads):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`fb_adcreative`





with fb_ads as (

	    
		   	SELECT 
			id ad_id,
			creative.creative_id creative_id,
			_sdc_sequence
			FROM `growth-engines-pipeline.fb_ads_luca_danni.ads`
		     
	   

)

SELECT
a.ad_id,
b.creative_id,
b.url
FROM (
    SELECT
    ad_id,
    creative_id,
    first_value(_sdc_sequence) OVER (PARTITION BY ad_id ORDER BY _sdc_sequence DESC) lv,
    _sdc_sequence
    FROM fb_ads
    ) a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`fb_adcreative` b
ON (
	a.creative_id = b.creative_id 
)
WHERE a.lv = a._sdc_sequence


2018-04-17 13:54:22,377: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fb94f98>]}
2018-04-17 13:54:22,610: 13:54:22 | 21 of 91 OK created table model agency_data_pipeline.fb_ads.......... [CREATE TABLE in 3.72s]
2018-04-17 13:54:24,578: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fc02908>]}
2018-04-17 13:54:24,823: 13:54:24 | 22 of 91 OK created table model agency_data_pipeline.shopify_customers_proc [CREATE TABLE in 5.92s]
2018-04-17 13:54:24,824: 13:54:24 | 23 of 91 START table model agency_data_pipeline.ga_mcf_stats......... [RUN]
2018-04-17 13:54:24,824: 13:54:24 | 24 of 91 START table model agency_data_pipeline.shopify_products_proc [RUN]
2018-04-17 13:54:24,825: 13:54:24 | 25 of 91 START table model agency_data_pipeline.bing_ads_stats....... [RUN]
2018-04-17 13:54:24,825: 13:54:24 | 26 of 91 START table model agency_data_pipeline.agg_customers_union.. [RUN]
2018-04-17 13:54:24,825: Compiling model.agency_data_pipeline.ga_mcf_stats
2018-04-17 13:54:24,825: Compiling model.agency_data_pipeline.shopify_products_proc
2018-04-17 13:54:24,826: Compiling model.agency_data_pipeline.bing_ads_stats
2018-04-17 13:54:24,826: Compiling model.agency_data_pipeline.agg_customers_union
2018-04-17 13:54:24,837: Writing injected SQL for node "model.agency_data_pipeline.ga_mcf_stats"
2018-04-17 13:54:24,846: Acquiring new bigquery connection "shopify_products_proc".
2018-04-17 13:54:24,851: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_stats"
2018-04-17 13:54:24,857: Writing injected SQL for node "model.agency_data_pipeline.agg_customers_union"
2018-04-17 13:54:24,857: Re-using an available connection from the pool.
2018-04-17 13:54:24,859: Acquiring new bigquery connection "ga_mcf_stats".
2018-04-17 13:54:24,859: Fetching data for query shopify_products_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 13:54:24,859: Acquiring new bigquery connection "bing_ads_stats".
2018-04-17 13:54:24,860: Re-using an available connection from the pool.
2018-04-17 13:54:24,860: Acquiring new bigquery connection "agg_customers_union".
2018-04-17 13:54:24,861: Re-using an available connection from the pool.
2018-04-17 13:54:24,866: Re-using an available connection from the pool.
2018-04-17 13:54:25,306: Writing injected SQL for node "model.agency_data_pipeline.shopify_products_proc"
2018-04-17 13:54:25,716: Model SQL (agg_customers_union):
SELECT *
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`shopify_customers_proc`
2018-04-17 13:54:25,746: Model SQL (bing_ads_stats):
select
a.date, 
a.account, 
a.channel,
a.platform,
url,
a.campaignname campaign,
utm_campaign,
cost,
clicks,
impressions,
transactions
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`bing_ads_ads` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`bing_ads_conversions` b
ON (
	a.date = b.date AND
	a.account = b.account AND
	a.campaignid = b.campaignid

)
2018-04-17 13:54:25,801: Model SQL (ga_mcf_stats):
SELECT  
date,
a.account account,
b.client client,
case when c.platform is null then "Unmapped" else c.platform end as platform,
case when c.channel is null then "Unmapped" else c.channel end as channel,
lower(a.source) source,
lower(a.medium) medium,
lower(campaign) campaign,
transactionid,
sum(transactions) first_touch_transactions,
sum(revenue) first_touch_revenue
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`ga_mcf_proc` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc` b 
ON ( a.account = b.account and
	a.lookup_platform = b.platform )
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc` c
ON ( lower(a.source) = c.source
  AND lower(a.medium) = c.medium 
  and a.account = c.account )
group by date, account, client, source, medium, campaign, platform, channel, transactionid
2018-04-17 13:54:26,029: Model SQL (shopify_products_proc):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc`, `growth-engines-pipeline`.`agency_data_pipeline`.`shopify_refunds_proc`





with products as (

	
	SELECT
	'lucadanni' client_name,
	'Shopify' as lookup_platform,
	product_type,
	product_id,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY product_id ORDER BY _sdc_sequence DESC) lv
	FROM `growth-engines-pipeline.shopify_lucadanni.products` 
	cross join unnest(variants)
	
	

)

SELECT
b.account,
b.client,
b.platform,
max(product_type) product_type,
product_id
FROM products a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
ON ( a.client_name = b.client_name
  AND a.lookup_platform = b.platform )
where a.lv = a._sdc_sequence
group by product_id, account, client, platform


2018-04-17 13:54:27,948: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d822908>]}
2018-04-17 13:54:28,190: 13:54:28 | 25 of 91 OK created table model agency_data_pipeline.bing_ads_stats.. [CREATE TABLE in 3.12s]
2018-04-17 13:54:28,190: 13:54:28 | 27 of 91 START table model agency_data_pipeline.shopify_orders_proc.. [RUN]
2018-04-17 13:54:28,191: Compiling model.agency_data_pipeline.shopify_orders_proc
2018-04-17 13:54:28,201: Acquiring new bigquery connection "shopify_orders_proc".
2018-04-17 13:54:28,201: Re-using an available connection from the pool.
2018-04-17 13:54:28,201: Fetching data for query shopify_orders_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 13:54:28,250: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d7e64e0>]}
2018-04-17 13:54:28,514: 13:54:28 | 24 of 91 OK created table model agency_data_pipeline.shopify_products_proc [CREATE TABLE in 3.42s]
2018-04-17 13:54:28,848: Writing injected SQL for node "model.agency_data_pipeline.shopify_orders_proc"
2018-04-17 13:54:29,018: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d7c0358>]}
2018-04-17 13:54:29,266: 13:54:29 | 26 of 91 OK created table model agency_data_pipeline.agg_customers_union [CREATE TABLE in 4.19s]
2018-04-17 13:54:29,674: Model SQL (shopify_orders_proc):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc`, `growth-engines-pipeline`.`agency_data_pipeline`.`shopify_refunds_proc`





with orders as (

	
	SELECT
	'lucadanni' client_name,
	'Shopify' as lookup_platform,
	created_at,
	order_number,
	quantity,
	cast(pre_tax_price as float64) price, 
	total_line_items_price total_order_price_undiscounted,
	total_discounts,
	cast(discounted_price as float64) total_order_shipping_price,
	total_price_usd total_order_price_incl_shipping,
	checkout_id,
	product_id, 
	landing_site,
	sku, 
	variant_title, 
	variant_id,
	_id line_item_id,
	customer.id customer_id,
	customer.orders_count orders_count,
	customer.created_at customer_created_at,
	customer.last_order_id last_order_id,
	financial_status,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY order_number, _id ORDER BY _sdc_sequence DESC) lv
	FROM `growth-engines-pipeline.shopify_lucadanni.orders` 
	cross join unnest(line_items), unnest(shipping_lines)
	where source_name != 'shopify_draft_order'
	
	

)

SELECT
b.account,
b.client,
b.platform,
created_at,
a.order_number,
a.quantity,
c.quantity refund_quantity,
case when c.quantity is not null then a.quantity - c.quantity else a.quantity end as final_quantity,
price, 
total_order_price_undiscounted,
total_discounts,
total_order_shipping_price,
total_order_price_incl_shipping,
refund_amount,
case when refund_amount is not null then price - refund_amount else price end as final_price,
a.checkout_id,
a.product_id, 
landing_site,
sku, 
variant_title, 
a.variant_id,
a.line_item_id,	
customer_id,
orders_count,
customer_created_at,
last_order_id,
a.financial_status
FROM orders a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
ON ( a.client_name = b.client_name
  AND a.lookup_platform = b.platform )
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`shopify_refunds_proc` c
ON ( a.order_number = c.order_number
	AND a.line_item_id = c.line_item_id )   	
where a.lv = a._sdc_sequence


2018-04-17 13:54:30,303: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d7dda20>]}
2018-04-17 13:54:30,539: 13:54:30 | 23 of 91 OK created table model agency_data_pipeline.ga_mcf_stats.... [CREATE TABLE in 5.48s]
2018-04-17 13:54:37,460: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fc026a0>]}
2018-04-17 13:54:37,690: 13:54:37 | 27 of 91 OK created table model agency_data_pipeline.shopify_orders_proc [CREATE TABLE in 9.27s]
2018-04-17 13:54:37,691: 13:54:37 | 28 of 91 START table model agency_data_pipeline.agg_orders_union..... [RUN]
2018-04-17 13:54:37,692: Compiling model.agency_data_pipeline.agg_orders_union
2018-04-17 13:54:37,692: 13:54:37 | 29 of 91 START table model agency_data_pipeline.agg_products......... [RUN]
2018-04-17 13:54:37,698: Compiling model.agency_data_pipeline.agg_products
2018-04-17 13:54:37,692: 13:54:37 | 30 of 91 START table model agency_data_pipeline.ga_transactions...... [RUN]
2018-04-17 13:54:37,692: 13:54:37 | 31 of 91 START table model agency_data_pipeline.adwords_join......... [RUN]
2018-04-17 13:54:37,705: Writing injected SQL for node "model.agency_data_pipeline.agg_products"
2018-04-17 13:54:37,707: Writing injected SQL for node "model.agency_data_pipeline.agg_orders_union"
2018-04-17 13:54:37,707: Compiling model.agency_data_pipeline.ga_transactions
2018-04-17 13:54:37,707: Compiling model.agency_data_pipeline.adwords_join
2018-04-17 13:54:37,718: Acquiring new bigquery connection "ga_transactions".
2018-04-17 13:54:37,725: Writing injected SQL for node "model.agency_data_pipeline.adwords_join"
2018-04-17 13:54:37,735: Acquiring new bigquery connection "adwords_join".
2018-04-17 13:54:37,725: Re-using an available connection from the pool.
2018-04-17 13:54:37,733: Acquiring new bigquery connection "agg_orders_union".
2018-04-17 13:54:37,737: Re-using an available connection from the pool.
2018-04-17 13:54:37,727: Acquiring new bigquery connection "agg_products".
2018-04-17 13:54:37,737: Fetching data for query ga_transactions:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Google Analytics'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 13:54:37,741: Re-using an available connection from the pool.
2018-04-17 13:54:37,747: Re-using an available connection from the pool.
2018-04-17 13:54:38,750: Model SQL (agg_products):
SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`shopify_products_proc`
2018-04-17 13:54:38,824: Model SQL (agg_orders_union):
SELECT
account,
client,
platform,
created_at,
order_number,
quantity,
refund_quantity,
final_quantity,
price, 
total_order_price_undiscounted,
total_discounts,
total_order_shipping_price,
total_order_price_incl_shipping,
refund_amount,
final_price,
checkout_id,
product_id, 
landing_site,
sku, 
variant_title, 
variant_id,
line_item_id,	
customer_id,
orders_count,
customer_created_at,
last_order_id,
financial_status
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`shopify_orders_proc`
2018-04-17 13:54:38,825: Model SQL (adwords_join):
select
a.day,
a.campaignid, 
a.campaign,
a.account, 
channel,
platform,
url,
utm_campaign,
cost,
impressions,
clicks,
impression_share_num,
impression_share_den,
transactions
FROM ( 
	
	select
	day,
	a.campaign,
	a.campaignid, 
	account, 
	channel,
	platform,
	url,
	cost,
	impressions,
	clicks,
	impression_share_num,
	impression_share_den
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_campaigns` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_urls` b
	ON a.campaignid = b.campaignid

) a 
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_ads` b
ON ( a.campaignid = b.campaignid
	and a.day = b.day )
2018-04-17 13:54:38,984: Fetching data for query ga_transactions:


        select
            goal_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_conversions`

        
        ##where 1 = 1
        where goal_type = 'Conversion'
        
        
        
        ##and 2 = 2
        and client_name = 'lucadanni'
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 13:54:39,917: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fb94f28>]}
2018-04-17 13:54:40,174: 13:54:40 | 29 of 91 OK created table model agency_data_pipeline.agg_products.... [CREATE TABLE in 2.22s]
2018-04-17 13:54:40,175: 13:54:40 | 32 of 91 START table model agency_data_pipeline.ga_traffic........... [RUN]
2018-04-17 13:54:40,175: Compiling model.agency_data_pipeline.ga_traffic
2018-04-17 13:54:40,191: Acquiring new bigquery connection "ga_traffic".
2018-04-17 13:54:40,191: Re-using an available connection from the pool.
2018-04-17 13:54:40,191: Fetching data for query ga_traffic:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'GA Traffic'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 13:54:40,306: Writing injected SQL for node "model.agency_data_pipeline.ga_transactions"
2018-04-17 13:54:41,243: Model SQL (ga_transactions):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc`, `growth-engines-pipeline`.`agency_data_pipeline`.`ga_conversions`


##`growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` 



with ga_report as (

	    

	    	
	    	
		   	SELECT
		   	'lucadanni' as client_name,
		   	'Google Analytics' as lookup_platform,
			lower(trim(regexp_replace(replace(replace(replace(replace(CONCAT(hostname,landingpagepath),'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
			date,
			lower(source) source,
			lower(medium) medium,
			lower(campaign) campaign,
			cast(regexp_replace(transactionid, r'#', '') as int64) transactionid,
			transactions last_touch_transactions,
			(transactionrevenue - transactionshipping - transactiontax) as last_touch_revenue,
			transactionshipping,
			transactiontax,
			_sdc_sequence,
			first_value(_sdc_sequence) OVER (PARTITION BY hostname, landingpagepath, date, source, medium, transactionid ORDER BY _sdc_sequence DESC) lv
			FROM `growth-engines-pipeline.ga_lucadanni.report` 

		    
	   

)


SELECT  
cast(date as date) date,
b.account,
b.client client,
c.source source,
c.medium medium,
a.campaign campaign,
concat(a.source, ' / ', a.medium) source_medium,  
case when c.platform is null then "Unmapped" else c.platform end as platform,
case when c.channel is null then "Unmapped" else c.channel end as channel,
regexp_replace(url, r'offers.|offer.|get.|info.|pos.|go.|join.|pages.','') url,
transactionid,
max(last_touch_transactions) last_touch_transactions,
max(last_touch_revenue) last_touch_revenue,
max(transactionshipping) last_touch_shipping,
max(transactiontax) last_touch_tax
FROM ga_report a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
ON ( a.client_name = b.client_name 
	AND a.lookup_platform = b.platform )
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc` c
ON ( a.source = c.source
  AND a.medium = c.medium 
  AND a.client_name = c.client_name )
GROUP BY date, account, client, source, medium, campaign, source_medium, platform, channel, url, transactionid


2018-04-17 13:54:41,446: Fetching data for query ga_traffic:


        select
            goal_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_conversions`

        
        ##where 1 = 1
        where goal_type = 'Conversion'
        
        
        
        ##and 2 = 2
        and client_name = 'lucadanni'
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 13:54:41,930: Writing injected SQL for node "model.agency_data_pipeline.ga_traffic"
2018-04-17 13:54:42,778: Model SQL (ga_traffic):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc`, `growth-engines-pipeline`.`agency_data_pipeline`.`ga_conversions`


##`growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` 



with ga_report as (

	    

	    	
	    	
		   	SELECT
		   	'lucadanni' as client_name,
		   	'GA Traffic' as lookup_platform,
			lower(trim(regexp_replace(replace(replace(replace(replace(CONCAT(hostname,landingpagepath),'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
			date,
			lower(source) source,
			lower(medium) medium,
			lower(campaign) campaign,
			sessions,
			## goal completion columns
							
				goalcompletionsall as goal_completions,		
			
			_sdc_sequence,
			first_value(_sdc_sequence) OVER (PARTITION BY hostname, landingpagepath, date, source, medium, campaign ORDER BY _sdc_sequence DESC) lv
			FROM `growth-engines-pipeline.ga_lucadanni_traffic.report` 

		    
	   

)


SELECT  
cast(date as date) date,
b.account,
b.client client,
c.source source,
c.medium medium,
a.campaign campaign,
concat(a.source, ' / ', a.medium) source_medium,  
case when c.platform is null then "Unmapped" else c.platform end as platform,
case when c.channel is null then "Unmapped" else c.channel end as channel,
regexp_replace(url, r'offers.|offer.|get.|info.|pos.|go.|join.|pages.','') url,
max(sessions) sessions,
max(goal_completions) goal_completions
FROM ga_report a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
ON ( a.client_name = b.client_name 
	AND a.lookup_platform = b.platform )
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc` c
ON ( a.source = c.source
  AND a.medium = c.medium 
  AND a.client_name = c.client_name )
GROUP BY date, account, client, source, medium, campaign, source_medium, platform, channel, url


2018-04-17 13:54:45,497: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fc14470>]}
2018-04-17 13:54:45,613: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fb73518>]}
2018-04-17 13:54:45,744: 13:54:45 | 28 of 91 OK created table model agency_data_pipeline.agg_orders_union [CREATE TABLE in 7.80s]
2018-04-17 13:54:46,039: 13:54:46 | 31 of 91 OK created table model agency_data_pipeline.adwords_join.... [CREATE TABLE in 7.91s]
2018-04-17 13:54:46,846: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fbbadd8>]}
2018-04-17 13:54:47,073: 13:54:47 | 30 of 91 OK created table model agency_data_pipeline.ga_transactions. [CREATE TABLE in 9.14s]
2018-04-17 13:54:52,864: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fc14240>]}
2018-04-17 13:54:53,570: 13:54:53 | 32 of 91 OK created table model agency_data_pipeline.ga_traffic...... [CREATE TABLE in 12.69s]
2018-04-17 13:54:53,571: 13:54:53 | 33 of 91 START table model agency_data_pipeline.agg_transaction_order_number [RUN]
2018-04-17 13:54:53,571: Compiling model.agency_data_pipeline.agg_transaction_order_number
2018-04-17 13:54:53,571: 13:54:53 | 34 of 91 START table model agency_data_pipeline.adwords_impression_share [RUN]
2018-04-17 13:54:53,578: Compiling model.agency_data_pipeline.adwords_impression_share
2018-04-17 13:54:53,578: Writing injected SQL for node "model.agency_data_pipeline.agg_transaction_order_number"
2018-04-17 13:54:53,588: Writing injected SQL for node "model.agency_data_pipeline.adwords_impression_share"
2018-04-17 13:54:53,571: 13:54:53 | 35 of 91 START table model agency_data_pipeline.agg_transaction_line_item [RUN]
2018-04-17 13:54:53,589: Compiling model.agency_data_pipeline.agg_transaction_line_item
2018-04-17 13:54:53,571: 13:54:53 | 36 of 91 START table model agency_data_pipeline.fb_ads_stats......... [RUN]
2018-04-17 13:54:53,597: Compiling model.agency_data_pipeline.fb_ads_stats
2018-04-17 13:54:53,607: Writing injected SQL for node "model.agency_data_pipeline.agg_transaction_line_item"
2018-04-17 13:54:53,610: Acquiring new bigquery connection "agg_transaction_order_number".
2018-04-17 13:54:53,611: Re-using an available connection from the pool.
2018-04-17 13:54:53,617: Acquiring new bigquery connection "adwords_impression_share".
2018-04-17 13:54:53,617: Re-using an available connection from the pool.
2018-04-17 13:54:53,624: Acquiring new bigquery connection "agg_transaction_line_item".
2018-04-17 13:54:53,625: Re-using an available connection from the pool.
2018-04-17 13:54:53,641: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_stats"
2018-04-17 13:54:53,643: Acquiring new bigquery connection "fb_ads_stats".
2018-04-17 13:54:53,645: Re-using an available connection from the pool.
2018-04-17 13:54:54,484: Model SQL (agg_transaction_line_item):
SELECT
client,
created_at,
order_number,
quantity,
refund_quantity,
final_quantity,
price, 
total_order_price_undiscounted,
total_discounts,
total_order_shipping_price,
total_order_price_incl_shipping,
refund_amount,
final_price,
checkout_id,
product_id, 
landing_site,
sku, 
variant_title, 
variant_id,
line_item_id,	
customer_id,
orders_count,
customer_created_at,
last_order_id,
financial_status
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`agg_orders_union`
2018-04-17 13:54:54,526: Model SQL (agg_transaction_order_number):
SELECT
client,
cast(created_at as date) date,
order_number,
customer_id,
sum(final_quantity) final_quantity,
sum(final_price) final_price,
max(total_order_shipping_price) shipping_price
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`agg_orders_union`
GROUP BY client, created_at, order_number, customer_id
2018-04-17 13:54:54,591: Model SQL (adwords_impression_share):
SELECT 
cast(day as date) date, 
account, 
channel,
platform,
sum(impression_share_num) impressions,
sum(impression_share_den) available_impressions
FROM 
  `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_join`
group by date, account, platform, channel
2018-04-17 13:54:54,701: Model SQL (fb_ads_stats):
with cost as (

    select 
        date, account, ad_id, campaign,
        cost, impressions, clicks, null as conversions
    from `growth-engines-pipeline`.`agency_data_pipeline`.`fb_ads_insights`
),

conversions as (

    select 
        date, account, ad_id, campaign,
        null as cost, null as impressions, null as clicks, conversions
    from `growth-engines-pipeline`.`agency_data_pipeline`.`fb_ads_insights_conversions`
),

urls as (

    select ad_id, url
    from `growth-engines-pipeline`.`agency_data_pipeline`.`fb_ads`
)


SELECT
    cast(date as date) date,
    'FB Ads' platform,
    'Paid' channel,
    account, 
    b.url url,
    campaign,
    lower(campaign) utm_campaign, 
    sum(cost) cost,
    sum(impressions) impressions,
    sum(clicks) clicks,
    sum(conversions) transactions
FROM
(
    SELECT *
    FROM 
      cost
    UNION ALL
    SELECT *
    FROM 
      conversions
) a
LEFT JOIN urls b
ON ( a.ad_id = b.ad_id )
group by date, platform, channel, account, url, campaign, utm_campaign
2018-04-17 13:54:56,854: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fb7d860>]}
2018-04-17 13:54:56,926: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d66b2b0>]}
2018-04-17 13:54:57,075: 13:54:57 | 34 of 91 OK created table model agency_data_pipeline.adwords_impression_share [CREATE TABLE in 3.28s]
2018-04-17 13:54:57,076: 13:54:57 | 37 of 91 START table model agency_data_pipeline.adwords_stats........ [RUN]
2018-04-17 13:54:57,076: Compiling model.agency_data_pipeline.adwords_stats
2018-04-17 13:54:57,085: Writing injected SQL for node "model.agency_data_pipeline.adwords_stats"
2018-04-17 13:54:57,089: Acquiring new bigquery connection "adwords_stats".
2018-04-17 13:54:57,089: Re-using an available connection from the pool.
2018-04-17 13:54:57,325: 13:54:57 | 36 of 91 OK created table model agency_data_pipeline.fb_ads_stats.... [CREATE TABLE in 3.33s]
2018-04-17 13:54:57,847: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fbddfd0>]}
2018-04-17 13:54:57,887: Model SQL (adwords_stats):
SELECT 
cast(day as date) date, 
account, 
platform,
channel,
url,
utm_campaign,
campaign,
sum(cost) cost,
sum(impressions) impressions,
sum(clicks) clicks,
sum(transactions) transactions
FROM 
  `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_join`
group by date, account, platform, channel, url, campaign, utm_campaign
2018-04-17 13:54:58,114: 13:54:58 | 33 of 91 OK created table model agency_data_pipeline.agg_transaction_order_number [CREATE TABLE in 4.28s]
2018-04-17 13:55:01,087: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d822c50>]}
2018-04-17 13:55:01,341: 13:55:01 | 35 of 91 OK created table model agency_data_pipeline.agg_transaction_line_item [CREATE TABLE in 7.50s]
2018-04-17 13:55:02,310: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d7a4780>]}
2018-04-17 13:55:02,556: 13:55:02 | 37 of 91 OK created table model agency_data_pipeline.adwords_stats... [CREATE TABLE in 5.23s]
2018-04-17 13:55:02,557: 13:55:02 | 38 of 91 START table model agency_data_pipeline.customers_by_transaction [RUN]
2018-04-17 13:55:02,557: Compiling model.agency_data_pipeline.customers_by_transaction
2018-04-17 13:55:02,567: Writing injected SQL for node "model.agency_data_pipeline.customers_by_transaction"
2018-04-17 13:55:02,568: Acquiring new bigquery connection "customers_by_transaction".
2018-04-17 13:55:02,568: Re-using an available connection from the pool.
2018-04-17 13:55:03,530: Model SQL (customers_by_transaction):
SELECT
client,
customer_id,
order_number,
order_date,
first_order_date,
case when first_order_number = order_number then 'New' else 'Existing' end as order_type,
final_price,
first_order_revenue,
lifetime_revenue
FROM

(

	SELECT
	client,
	customer_id,
	order_number,
	date order_date,
	first_value(date) over w1 first_order_date,
	first_value(order_number) over w1 first_order_number,
	first_value(final_price) over w1 first_order_revenue,
    final_price,
	sum(final_price) over w2 lifetime_revenue
	FROM
    `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_order_number`
	WINDOW w1 as (PARTITION BY client, customer_id ORDER BY date desc),
	w2 as (PARTITION BY client, customer_id)
)
2018-04-17 13:55:06,856: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d7ddd30>]}
2018-04-17 13:55:07,086: 13:55:07 | 38 of 91 OK created table model agency_data_pipeline.customers_by_transaction [CREATE TABLE in 4.30s]
2018-04-17 13:55:07,087: 13:55:07 | 39 of 91 START table model agency_data_pipeline.agg_ga_transaction_order_number [RUN]
2018-04-17 13:55:07,087: Compiling model.agency_data_pipeline.agg_ga_transaction_order_number
2018-04-17 13:55:07,087: 13:55:07 | 40 of 91 START table model agency_data_pipeline.frequency_proc....... [RUN]
2018-04-17 13:55:07,094: Writing injected SQL for node "model.agency_data_pipeline.agg_ga_transaction_order_number"
2018-04-17 13:55:07,094: Compiling model.agency_data_pipeline.frequency_proc
2018-04-17 13:55:07,100: Writing injected SQL for node "model.agency_data_pipeline.frequency_proc"
2018-04-17 13:55:07,102: Acquiring new bigquery connection "agg_ga_transaction_order_number".
2018-04-17 13:55:07,102: Re-using an available connection from the pool.
2018-04-17 13:55:07,106: Acquiring new bigquery connection "frequency_proc".
2018-04-17 13:55:07,106: Re-using an available connection from the pool.
2018-04-17 13:55:07,788: Model SQL (frequency_proc):
WITH transactions AS (

  	SELECT 
	client,
	customer_id,
	order_number,
	order_date,
	unix_date(order_date) d
	FROM
	`growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_order_number`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)

SELECT 
client,
'Rolling 365' as period,
date_in_range date,
unix_date_in_range, 
customer_id,
count(distinct(order_number)) frequency
FROM daterange
JOIN transactions
ON transactions.d > ( daterange.unix_date_in_range - 365 )
AND transactions.d <= daterange.unix_date_in_range
group by client, unix_date_in_range, customer_id
2018-04-17 13:55:07,789: Bad request while running:
WITH transactions AS (

  	SELECT 
	client,
	customer_id,
	order_number,
	order_date,
	unix_date(order_date) d
	FROM
	`growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_order_number`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)

SELECT 
client,
'Rolling 365' as period,
date_in_range date,
unix_date_in_range, 
customer_id,
count(distinct(order_number)) frequency
FROM daterange
JOIN transactions
ON transactions.d > ( daterange.unix_date_in_range - 365 )
AND transactions.d <= daterange.unix_date_in_range
group by client, unix_date_in_range, customer_id
2018-04-17 13:55:07,789: 400 Unrecognized name: order_date at [7:9]
2018-04-17 13:55:07,790: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fbbc3c8>]}
2018-04-17 13:55:08,015: 13:55:08 | 40 of 91 ERROR creating table model agency_data_pipeline.frequency_proc [ERROR in 0.70s]
2018-04-17 13:55:08,177: Model SQL (agg_ga_transaction_order_number):
with ga as (

    select 
        date, account, client, 
        channel as last_touch_channel, 
        platform as last_touch_platform, 
        url as last_touch_url, 
        campaign as last_touch_utm_campaign, 
        '' as first_touch_channel, 
        '' as first_touch_platform, 
        '' as first_touch_utm_campaign, 
        transactionid,
        last_touch_transactions, last_touch_revenue,
        last_touch_shipping, last_touch_tax,
        null as first_touch_transactions, null as first_touch_revenue
    from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_transactions`

),

ga_mcf as (

    select 
        date, account, client, 
        '' as last_touch_channel,
        '' as last_touch_platform,
        '' as last_touch_url,
        '' as last_touch_utm_campaign, 
        channel as first_touch_channel, 
        platform as first_touch_platform, 
        campaign as first_touch_utm_campaign, 
        transactionid, 
        null as last_touch_transactions, null as last_touch_revenue,
        null as last_touch_shipping, null as last_touch_tax,
        first_touch_transactions, first_touch_revenue
    from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_mcf_stats`

)


SELECT
    date, 
    client,
    transactionid,
    max(last_touch_channel) last_touch_channel, 
    max(last_touch_platform) last_touch_platform, 
    max(last_touch_url) last_touch_url, 
    max(last_touch_utm_campaign) last_touch_utm_campaign, 
    max(first_touch_channel) first_touch_channel, 
    max(first_touch_platform) first_touch_platform, 
    max(first_touch_utm_campaign) first_touch_utm_campaign,
    sum(last_touch_transactions) last_touch_transactions,
    sum(last_touch_revenue) last_touch_revenue,
    sum(last_touch_shipping) last_touch_shipping_revenue,
    sum(last_touch_tax) last_touch_tax_revenue,
    sum(first_touch_transactions) first_touch_transactions,
    sum(first_touch_revenue) - ifnull(sum(last_touch_shipping),0) - ifnull(sum(last_touch_tax),0) first_touch_revenue
FROM
(
    SELECT *
    FROM 
      ga
    UNION ALL
    SELECT *
    FROM 
      ga_mcf
) 
GROUP BY
    date, client, transactionid
2018-04-17 13:55:13,778: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d7a4780>]}
2018-04-17 13:55:14,010: 13:55:14 | 39 of 91 OK created table model agency_data_pipeline.agg_ga_transaction_order_number [CREATE TABLE in 6.69s]
2018-04-17 13:55:14,011: 13:55:14 | 41 of 91 SKIP relation agency_data_pipeline.frequency_stats.......... [SKIP]
2018-04-17 13:55:14,012: 13:55:14 | 42 of 91 START table model agency_data_pipeline.agg_ga_campaign...... [RUN]
2018-04-17 13:55:14,012: Compiling model.agency_data_pipeline.agg_ga_campaign
2018-04-17 13:55:14,019: 13:55:14 | 43 of 91 START table model agency_data_pipeline.agg_transaction_line_item_type [RUN]
2018-04-17 13:55:14,030: Writing injected SQL for node "model.agency_data_pipeline.agg_ga_campaign"
2018-04-17 13:55:14,030: Compiling model.agency_data_pipeline.agg_transaction_line_item_type
2018-04-17 13:55:14,035: Writing injected SQL for node "model.agency_data_pipeline.agg_transaction_line_item_type"
2018-04-17 13:55:14,037: Acquiring new bigquery connection "agg_transaction_line_item_type".
2018-04-17 13:55:14,037: Re-using an available connection from the pool.
2018-04-17 13:55:14,038: Acquiring new bigquery connection "agg_ga_campaign".
2018-04-17 13:55:14,038: Re-using an available connection from the pool.
2018-04-17 13:55:15,000: Model SQL (agg_ga_campaign):
with ga_transactions as (

	select 
		date, account, client, channel, platform, url, 
		campaign,
		null as sessions, null as goal_completions, last_touch_transactions, last_touch_revenue,
		last_touch_shipping, last_touch_tax,
		null as first_touch_transactions, null as first_touch_revenue
	from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_transactions`

),

ga_traffic as (

    select 
        date, account, client, channel, platform, url, 
        campaign,
        sessions, goal_completions, null as last_touch_transactions, null as last_touch_revenue,
        null as last_touch_shipping, null as last_touch_tax,
        null as first_touch_transactions, null as first_touch_revenue
    from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_traffic`

),

ga_mcf as (

	select 
		date, account, client, channel, platform, '' as url,
		campaign, 
		null as sessions, null as goal_completions, null as last_touch_transactions, null as last_touch_revenue,
		null as last_touch_shipping, null as last_touch_tax,
		first_touch_transactions, first_touch_revenue
	from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_mcf_stats`

)


SELECT
    date, 
    client,
    platform,
    channel, 
    url,
    campaign utm_campaign,
	sum(sessions) sessions,
	sum(goal_completions) goal_completions,
	sum(last_touch_transactions) last_touch_transactions,
	sum(last_touch_revenue) last_touch_revenue,
    sum(last_touch_shipping) last_touch_shipping_revenue,
    sum(last_touch_tax) last_touch_tax_revenue,
    sum(first_touch_transactions) first_touch_transactions,
    sum(first_touch_revenue) - sum(ifnull(last_touch_shipping,0)) - sum(ifnull(last_touch_tax,0)) first_touch_revenue

FROM
(
    SELECT *
    FROM 
      ga_transactions
    UNION ALL
    SELECT *
    FROM 
      ga_traffic
    UNION ALL
    SELECT *
    FROM 
      ga_mcf
) 
GROUP BY
    date, client, platform, channel, url, utm_campaign
2018-04-17 13:55:15,027: Model SQL (agg_transaction_line_item_type):
SELECT
client,
product_id,
product_type,
customer_id,
sku,
order_number,
created_at,
final_quantity,
final_price
FROM

( 
	SELECT 
	a.client, 
	a.product_id,
	product_type,
	customer_id,
	a.sku, 
	order_number,
	created_at,
	final_quantity,
	final_price
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_line_item` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`agg_products` b
	ON (
		a.product_id = b.product_id
	  and a.client = b.client
		)

)
2018-04-17 13:55:20,593: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d7e67b8>]}
2018-04-17 13:55:20,833: 13:55:20 | 43 of 91 OK created table model agency_data_pipeline.agg_transaction_line_item_type [CREATE TABLE in 6.56s]
2018-04-17 13:55:23,619: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fb7d5f8>]}
2018-04-17 13:55:24,379: 13:55:24 | 42 of 91 OK created table model agency_data_pipeline.agg_ga_campaign. [CREATE TABLE in 9.61s]
2018-04-17 13:55:24,380: 13:55:24 | 44 of 91 START table model agency_data_pipeline.customers_first_purchase_product_type_proc [RUN]
2018-04-17 13:55:24,380: 13:55:24 | 45 of 91 START table model agency_data_pipeline.agg_transaction_product_type [RUN]
2018-04-17 13:55:24,381: Compiling model.agency_data_pipeline.customers_first_purchase_product_type_proc
2018-04-17 13:55:24,381: Compiling model.agency_data_pipeline.agg_transaction_product_type
2018-04-17 13:55:24,396: Writing injected SQL for node "model.agency_data_pipeline.customers_first_purchase_product_type_proc"
2018-04-17 13:55:24,398: Writing injected SQL for node "model.agency_data_pipeline.agg_transaction_product_type"
2018-04-17 13:55:24,403: Acquiring new bigquery connection "customers_first_purchase_product_type_proc".
2018-04-17 13:55:24,403: Re-using an available connection from the pool.
2018-04-17 13:55:24,404: Acquiring new bigquery connection "agg_transaction_product_type".
2018-04-17 13:55:24,405: Re-using an available connection from the pool.
2018-04-17 13:55:27,494: Model SQL (customers_first_purchase_product_type_proc):
SELECT 
client, 
customer_id, 
product_type,
min(cast(created_at as date)) first_order_date,
unix_date( min(cast(created_at as date))) first_order_unix_date
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_line_item_type`
GROUP BY client, customer_id, product_type
2018-04-17 13:55:27,495: Model SQL (agg_transaction_product_type):
SELECT
client,
product_type,
customer_id,
order_number,
created_at,
first_value(product_type) over (PARTITION BY client, customer_id, order_number, created_at ORDER BY final_price desc) as top_order_product_type,
final_quantity,
final_price,
sum(final_quantity) over (PARTITION BY client, customer_id, order_number) as total_order_quantity,
sum(final_price) over (PARTITION BY client, customer_id, order_number) as total_order_value
FROM
	(
		SELECT
		client,
		product_type,
		customer_id,
		order_number,
		created_at,
		sum(final_quantity) final_quantity,
		sum(final_price) final_price
		FROM
		`growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_line_item_type`
		GROUP BY
		client,
		product_type,
		customer_id,
		order_number,
		created_at
	)
2018-04-17 13:55:30,484: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d7a4780>]}
2018-04-17 13:55:30,785: 13:55:30 | 44 of 91 OK created table model agency_data_pipeline.customers_first_purchase_product_type_proc [CREATE TABLE in 6.10s]
2018-04-17 13:55:31,979: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fbbc3c8>]}
2018-04-17 13:55:32,216: 13:55:32 | 45 of 91 OK created table model agency_data_pipeline.agg_transaction_product_type [CREATE TABLE in 7.60s]
2018-04-17 13:55:32,217: 13:55:32 | 46 of 91 START table model agency_data_pipeline.products_proc........ [RUN]
2018-04-17 13:55:32,218: Compiling model.agency_data_pipeline.products_proc
2018-04-17 13:55:32,217: 13:55:32 | 47 of 91 START table model agency_data_pipeline.order_paths_proc..... [RUN]
2018-04-17 13:55:32,223: Compiling model.agency_data_pipeline.order_paths_proc
2018-04-17 13:55:32,217: 13:55:32 | 48 of 91 START table model agency_data_pipeline.customers_products_proc [RUN]
2018-04-17 13:55:32,226: Writing injected SQL for node "model.agency_data_pipeline.products_proc"
2018-04-17 13:55:32,232: Writing injected SQL for node "model.agency_data_pipeline.order_paths_proc"
2018-04-17 13:55:32,232: Compiling model.agency_data_pipeline.customers_products_proc
2018-04-17 13:55:32,239: Writing injected SQL for node "model.agency_data_pipeline.customers_products_proc"
2018-04-17 13:55:32,240: Acquiring new bigquery connection "order_paths_proc".
2018-04-17 13:55:32,241: Acquiring new bigquery connection "products_proc".
2018-04-17 13:55:32,242: Re-using an available connection from the pool.
2018-04-17 13:55:32,243: Acquiring new bigquery connection "customers_products_proc".
2018-04-17 13:55:32,244: Re-using an available connection from the pool.
2018-04-17 13:55:32,245: Re-using an available connection from the pool.
2018-04-17 13:55:34,983: Model SQL (order_paths_proc):
SELECT
client, 
customer_id, 
first_value(product_type) OVER w1 as first_product_type,
nth_value(product_type, 2) OVER w1 as second_product_type,
cast(first_value(created_at) OVER w1 as date) as first_purchase_date,
cast(nth_value(created_at, 2) OVER w1 as date) as second_purchase_date,
cast(nth_value(created_at, 3) OVER w1 as date) as third_purchase_date,
cast(nth_value(created_at, 4) OVER w1 as date) as fourth_purchase_date,
cast(nth_value(created_at, 5) OVER w1 as date) as fifth_purchase_date,
first_value(order_number) OVER w1 as first_order_number,
nth_value(order_number, 2) OVER w1 as second_order_number,
nth_value(order_number, 3) OVER w1 as third_order_number,
nth_value(order_number, 4) OVER w1 as fourth_order_number,
nth_value(order_number, 5) OVER w1 as fifth_order_number,
first_value(total_order_value) OVER w1 as first_order_value,
nth_value(total_order_value, 2) OVER w1 as second_order_value
FROM (
	  
	  SELECT 
	  client, 
	  product_type,
	  customer_id,
	  order_number,
	  created_at, 
	  total_order_value
	  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_product_type`
	  WHERE product_type = top_order_product_type

)
WINDOW w1 as (PARTITION BY client, customer_id ORDER BY created_at asc)
2018-04-17 13:55:35,017: Model SQL (products_proc):
WITH transactions AS (
  SELECT 
  client, 
  product_id,
  product_type,
  customer_id,
  sku, 
  order_number,
  unix_date(cast(created_at as date)) d, 
  final_quantity,
  final_price
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_line_item_type`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)

SELECT 
client,
'Last 30' as period,
sku, 
product_type,
date_in_range date,
unix_date_in_range, 
count(distinct(customer_id)) unique_customers,
count(distinct(order_number)) orders,
sum(final_quantity) quantity,
sum(final_price) revenue
FROM daterange
JOIN transactions
ON transactions.d > ( daterange.unix_date_in_range - 30 )
AND transactions.d <= daterange.unix_date_in_range
group by date_in_range, unix_date_in_range, client, sku, product_type

UNION ALL

SELECT 
client,
'Last 90' as period,
sku, 
product_type,
date_in_range date,
unix_date_in_range, 
count(distinct(customer_id)) unique_customers,
count(distinct(order_number)) orders,
sum(final_quantity) quantity,
sum(final_price) revenue
FROM daterange
JOIN transactions
ON transactions.d > ( daterange.unix_date_in_range - 90 )
AND transactions.d <= daterange.unix_date_in_range
group by date_in_range, unix_date_in_range, client, sku, product_type

UNION ALL

SELECT 
client,
'YoY 30' as date_range,
sku, 
product_type,
date_in_range date,
unix_date_in_range, 
count(distinct(customer_id)) unique_customers,
count(distinct(order_number)) orders,
sum(final_quantity) quantity,
sum(final_price) revenue
FROM daterange
JOIN transactions
ON transactions.d > ( daterange.unix_date_in_range - 395 )
AND transactions.d <= ( daterange.unix_date_in_range - 365 )
group by date_in_range, unix_date_in_range, client, sku, product_type
2018-04-17 13:55:35,101: Model SQL (customers_products_proc):
WITH customers AS (
  SELECT 
  client, 
  product_id,
  product_type,
  customer_id,
  sku, 
  order_number,
  cast(created_at as date) order_date,
  unix_date(cast(created_at as date)) unix_order_date, 
  final_quantity quantity,
  final_price revenue
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_line_item_type`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)

SELECT 
client,
period,
customer_id,
product_type,
date,
window_end_unix_date,
window_end_unix_date - 365 as window_start_unix_date,
window_end_unix_date - unix_date(recent_order) recency_days,
frequency,
quantity,
revenue,
case when frequency > 0 then revenue/frequency else 0 end as aov
FROM 
(  

  SELECT 
  client,
  'Rolling 365' as period,
  customer_id,
  product_type,
  date_in_range date,
  unix_date_in_range,
  unix_date_in_range window_end_unix_date, 
  max(order_date) recent_order,
  sum(quantity) as quantity,
  sum(revenue) as revenue,
  count(distinct(order_number)) as frequency
  FROM daterange
  JOIN customers
  ON customers.unix_order_date > ( daterange.unix_date_in_range - 365 )
  AND customers.unix_order_date <= daterange.unix_date_in_range
  GROUP BY client, customer_id, date, unix_date_in_range, product_type

  UNION ALL

  SELECT 
  client,
  'Rolling 365 (t-1mo)' as period,
  customer_id,
  product_type,
  date_in_range date,
  unix_date_in_range, 
  unix_date_in_range - 30 window_end_unix_date, 
  max(order_date) recent_order,
  sum(quantity) as quantity,
  sum(revenue) as revenue,
  count(distinct(order_number)) as frequency
  FROM daterange
  JOIN customers
  ON customers.unix_order_date > ( daterange.unix_date_in_range - 395 )
  AND customers.unix_order_date <= ( daterange.unix_date_in_range - 30 )
  GROUP BY client, customer_id, date, unix_date_in_range, product_type

  UNION ALL

  SELECT 
  client,
  'Rolling 365 (t-1yr)' as period,
  customer_id,
  product_type,
  date_in_range date,
  unix_date_in_range, 
  unix_date_in_range - 365 window_end_unix_date, 
  max(order_date) recent_order,
  sum(quantity) as quantity,
  sum(revenue) as revenue,
  count(distinct(order_number)) as frequency
  FROM daterange
  JOIN customers
  ON customers.unix_order_date > ( daterange.unix_date_in_range - 730 )
  AND customers.unix_order_date <= ( daterange.unix_date_in_range - 365 )
  GROUP BY client, customer_id, date, unix_date_in_range, product_type

)
2018-04-17 13:55:38,070: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fbba518>]}
2018-04-17 13:55:38,311: 13:55:38 | 47 of 91 OK created table model agency_data_pipeline.order_paths_proc [CREATE TABLE in 5.85s]
2018-04-17 13:55:41,013: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fbb39b0>]}
2018-04-17 13:55:41,241: 13:55:41 | 46 of 91 OK created table model agency_data_pipeline.products_proc... [CREATE TABLE in 8.80s]
2018-04-17 13:56:13,838: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d822908>]}
2018-04-17 13:56:14,123: 13:56:14 | 48 of 91 OK created table model agency_data_pipeline.customers_products_proc [CREATE TABLE in 41.60s]
2018-04-17 13:56:14,125: 13:56:14 | 49 of 91 START table model agency_data_pipeline.order_paths_agg...... [RUN]
2018-04-17 13:56:14,125: 13:56:14 | 50 of 91 START table model agency_data_pipeline.segment_proc_sku..... [RUN]
2018-04-17 13:56:14,125: Compiling model.agency_data_pipeline.order_paths_agg
2018-04-17 13:56:14,125: Compiling model.agency_data_pipeline.segment_proc_sku
2018-04-17 13:56:14,150: Writing injected SQL for node "model.agency_data_pipeline.order_paths_agg"
2018-04-17 13:56:14,153: Writing injected SQL for node "model.agency_data_pipeline.segment_proc_sku"
2018-04-17 13:56:14,158: Acquiring new bigquery connection "segment_proc_sku".
2018-04-17 13:56:14,159: Acquiring new bigquery connection "order_paths_agg".
2018-04-17 13:56:14,159: Re-using an available connection from the pool.
2018-04-17 13:56:14,160: Re-using an available connection from the pool.
2018-04-17 13:56:15,110: Model SQL (segment_proc_sku):
SELECT
client,
period,
sku, 
product_type,
date,
unique_customers,
orders,
quantity,
revenue,
case when orders > orders_90pct then 'Best Seller'
	when orders > orders_75pct then 'Good'
	when orders > orders_25pct then 'Average'
	else 'Poor' end as segment,
orders_90pct,
orders_75pct,
orders_25pct
FROM
(
	SELECT 
	client,
	period,
	sku, 
	product_type,
	date,
	unique_customers,
	orders,
	quantity,
	revenue,
	PERCENTILE_CONT(orders, 0.90) OVER w1 AS orders_90pct,
	PERCENTILE_CONT(orders, 0.75) OVER w1 AS orders_75pct,
	PERCENTILE_CONT(orders, 0.25) OVER w1 AS orders_25pct
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`products_proc`
	WINDOW w1 as (PARTITION BY client, period, date)
)
2018-04-17 13:56:15,112: Model SQL (order_paths_agg):
SELECT
client, 
first_product_type,
second_product_type,
first_purchase_date,
count(distinct(customer_id)) customer_count, 
count(distinct(second_order_number)) second_orders, 
count(distinct(third_order_number)) third_orders, 
count(distinct(fourth_order_number)) fourth_orders, 
count(distinct(fifth_order_number)) fifth_orders, 
sum(date_diff(second_purchase_date, first_purchase_date, DAY)) second_order_latency_days,
sum(date_diff(third_purchase_date, second_purchase_date, DAY)) third_order_latency_days,
sum(date_diff(fourth_purchase_date, third_purchase_date, DAY)) fourth_order_latency_days,
sum(date_diff(fifth_purchase_date, fourth_purchase_date, DAY)) fifth_order_latency_days,
sum(first_order_value) first_order_revenue,
sum(second_order_value) second_order_revenue
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`order_paths_proc`
where second_product_type is not null
GROUP BY client, first_product_type, second_product_type, first_purchase_date
2018-04-17 13:56:17,309: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fc07c88>]}
2018-04-17 13:56:17,371: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fbbc3c8>]}
2018-04-17 13:56:17,947: 13:56:17 | 50 of 91 OK created table model agency_data_pipeline.segment_proc_sku [CREATE TABLE in 3.18s]
2018-04-17 13:56:18,187: 13:56:18 | 49 of 91 OK created table model agency_data_pipeline.order_paths_agg. [CREATE TABLE in 3.25s]
2018-04-17 13:56:18,188: 13:56:18 | 51 of 91 START table model agency_data_pipeline.agg_ga_transaction... [RUN]
2018-04-17 13:56:18,188: 13:56:18 | 52 of 91 START table model agency_data_pipeline.segment_proc_customers_products [RUN]
2018-04-17 13:56:18,188: 13:56:18 | 53 of 91 START table model agency_data_pipeline.segment_stats_sku.... [RUN]
2018-04-17 13:56:18,189: Compiling model.agency_data_pipeline.agg_ga_transaction
2018-04-17 13:56:18,189: 13:56:18 | 54 of 91 START table model agency_data_pipeline.agg_transaction...... [RUN]
2018-04-17 13:56:18,189: Compiling model.agency_data_pipeline.segment_proc_customers_products
2018-04-17 13:56:18,189: Compiling model.agency_data_pipeline.segment_stats_sku
2018-04-17 13:56:18,197: Writing injected SQL for node "model.agency_data_pipeline.agg_ga_transaction"
2018-04-17 13:56:18,197: Compiling model.agency_data_pipeline.agg_transaction
2018-04-17 13:56:18,203: Writing injected SQL for node "model.agency_data_pipeline.segment_proc_customers_products"
2018-04-17 13:56:18,208: Writing injected SQL for node "model.agency_data_pipeline.segment_stats_sku"
2018-04-17 13:56:18,215: Writing injected SQL for node "model.agency_data_pipeline.agg_transaction"
2018-04-17 13:56:18,217: Acquiring new bigquery connection "agg_ga_transaction".
2018-04-17 13:56:18,217: Re-using an available connection from the pool.
2018-04-17 13:56:18,219: Acquiring new bigquery connection "segment_proc_customers_products".
2018-04-17 13:56:18,220: Re-using an available connection from the pool.
2018-04-17 13:56:18,222: Acquiring new bigquery connection "agg_transaction".
2018-04-17 13:56:18,224: Re-using an available connection from the pool.
2018-04-17 13:56:18,225: Acquiring new bigquery connection "segment_stats_sku".
2018-04-17 13:56:18,226: Re-using an available connection from the pool.
2018-04-17 13:56:19,078: Model SQL (agg_transaction):
SELECT
client,
date,
customer_id,
order_number,
last_touch_channel,
last_touch_platform,
last_touch_url,
first_touch_channel, 
first_touch_platform, 
first_touch_utm_campaign,
ifnull( sum(last_touch_transactions), 0) last_touch_transactions, 
ifnull( sum(last_touch_revenue), 0) last_touch_revenue, 
ifnull( sum(first_touch_transactions), 0) first_touch_transactions, 
ifnull( sum(first_touch_revenue), 0) first_touch_revenue,
ifnull( sum(final_quantity), 0) quantity,
ifnull( sum(final_price), 0) revenue,
ifnull( sum(shipping_price), 0) shipping_revenue,
ROW_NUMBER() OVER (PARTITION BY client, customer_id, order_number ORDER BY date asc) AS order_sequence
FROM
(
	SELECT
	a.client,
	a.date date,
	b.date ga_date,
	a.customer_id,
	a.order_number,
	transactionid,
	b.last_touch_channel,
	b.last_touch_platform,
	b.last_touch_url,
	b.first_touch_channel, 
	b.first_touch_platform, 
	b.first_touch_utm_campaign, 
	last_touch_transactions, 
	last_touch_revenue, 
	first_touch_transactions, 
	first_touch_revenue,
	final_quantity,
	final_price,
	shipping_price
	FROM
	`growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_order_number` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`agg_ga_transaction_order_number` b
	ON (
		a.client = b.client and
		a.order_number = b.transactionid
	)

)
GROUP BY
client, 
date, 
customer_id,
order_number, 
last_touch_channel,
last_touch_platform,
last_touch_url,
first_touch_channel, 
first_touch_platform, 
first_touch_utm_campaign
2018-04-17 13:56:19,084: Model SQL (agg_ga_transaction):
#done - lookup customer id from transaction id from orders
#done - tag an order as 'new' or 'existing' based on transaction id
#sum lifetime value of that customer id
#first order value for customer
#read from agg_ga_transaction into agg_ga_campaign instead of directly from ga_transactions and ga_mcf_stats


with ga as (

    select 
        date, 
        client, 
        'Last-touch' as attribution,
        channel, 
        platform, 
        url, 
        campaign, 
        transactionid,
        last_touch_transactions transactions, 
        last_touch_revenue + ifnull(last_touch_shipping, 0) + ifnull(last_touch_tax, 0) as revenue
    from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_transactions`

),

ga_mcf as (

    select 
        date, 
        client, 
        'First-touch' as attribution,
        channel, 
        platform, 
        '' as url,
        campaign, 
        transactionid, 
        first_touch_transactions as transactions,
        first_touch_revenue as revenue
    from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_mcf_stats`

)


SELECT
    date, 
    a.client client,
    attribution,
    transactionid,
    b.customer_id customer_id,
    b.order_type order_type,
    b.first_order_revenue first_order_revenue,
    b.lifetime_revenue lifetime_revenue,
    channel,
    platform,
    url,
    campaign,
    transactions,
    revenue
FROM (
    SELECT * FROM ga
    UNION ALL
    SELECT * FROM ga_mcf
) a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`customers_by_transaction` b
ON (
    a.client = b.client AND
    a.transactionid = b.order_number
)
2018-04-17 13:56:19,145: Model SQL (segment_stats_sku):
WITH last_30 as (

	SELECT
	client,
	sku, 
	product_type,
	date,
	unique_customers as customers_30,
	orders as orders_30,
	revenue as revenue_30,
	segment as segment_30,
	0 as customers_90,
	0 as orders_90,
	0 as revenue_90,
	'' as segment_90,
	0 as customers_yoy_30,
	0 as orders_yoy_30,
	0 as revenue_yoy_30,
	'' as segment_yoy_30
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_sku`
	WHERE period = 'Last 30'

),

last_90 as (

	SELECT
	client,
	sku, 
	product_type,
	date,
	0 as customers_30,
	0 as orders_30,
	0 as revenue_30,
	'' as segment_30,
	unique_customers as customers_90,
	orders as orders_90,
	revenue as revenue_90,
	segment as segment_90,
	0 as customers_yoy_30,
	0 as orders_yoy_30,
	0 as revenue_yoy_30,
	'' as segment_yoy_30
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_sku`
	WHERE period = 'Last 90'

),

yoy_30 as (

	SELECT
	client,
	sku, 
	product_type,
	date,
	0 as customers_30,
	0 as orders_30,
	0 as revenue_30,
	'' as segment_30,
	0 as customers_90,
	0 as orders_90,
	0 as revenue_90,
	'' as segment_90,
	unique_customers as customers_yoy_30,
	orders as orders_yoy_30,
	revenue as revenue_yoy_30,
	segment as segment_yoy_30
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_sku`
	WHERE period = 'YoY 30'

)

SELECT
client,
sku, 
product_type,
date,
ifnull(sum(customers_30), 0) customers_30,
ifnull(sum(orders_30), 0) orders_30,
ifnull(sum(revenue_30), 0) revenue_30,
ifnull(max(segment_30), '') segment_30,
ifnull(sum(customers_90), 0) customers_90,
ifnull(sum(orders_90), 0) orders_90,
ifnull(sum(revenue_90), 0) revenue_90,
ifnull(max(segment_90), '') segment_90,
ifnull(sum(customers_yoy_30), 0) customers_yoy_30,
ifnull(sum(orders_yoy_30), 0) orders_yoy_30,
ifnull(sum(revenue_yoy_30), 0) revenue_yoy_30,
ifnull(max(segment_yoy_30), '') segment_yoy_30
FROM
(
	SELECT * FROM last_30
	UNION ALL
	SELECT * FROM last_90
	UNION ALL
	SELECT * FROM yoy_30

)
GROUP BY client, sku, product_type, date
2018-04-17 13:56:19,154: Model SQL (segment_proc_customers_products):
SELECT
client,
period,
date,
customer_id,
first_order_date,
first_order_unix_date,
product_type,
recency_days,
frequency,
revenue,
quantity,
aov,
case when frequency = 1 and recency_days <= 30 and first_order_unix_date >= window_start_unix_date then 'New'
	when frequency = 1 then 'One-time Purchaser'
	when frequency > frequency_90pct and recency_days < recency_90pct and aov > aov_50pct then 'Champion'
	when recency_days < recency_90pct and frequency > frequency_75pct then 'Potential Loyalists' 
	when frequency > frequency_75pct and recency_days <= recency_50pct then 'Cant Lose'
	when recency_days < recency_50pct and frequency > frequency_50pct then 'Loyal'
	when recency_days > recency_50pct and frequency > frequency_50pct then 'Frequent, not Recent'
	when recency_days < recency_50pct and frequency < frequency_50pct then 'Recent, not Frequent'
	else 'Unbucketed' end as segment,
aov_50pct,
frequency_90pct,
frequency_75pct,
frequency_50pct,
recency_90pct,
recency_75pct,
recency_50pct
FROM
(
	SELECT 
	a.client client,
	period,
	date,
	a.customer_id customer_id,
	a.product_type product_type,
	b.first_order_date first_order_date,
	b.first_order_unix_date first_order_unix_date,
	window_start_unix_date,
	window_end_unix_date,	
	recency_days,
	frequency,
	revenue,
	quantity,
	aov,
	PERCENTILE_CONT(aov, 0.50) OVER w1 AS aov_50pct,
	PERCENTILE_CONT(frequency, 0.90) OVER w1 AS frequency_90pct,
	PERCENTILE_CONT(frequency, 0.75) OVER w1 AS frequency_75pct,
	PERCENTILE_CONT(frequency, 0.90) OVER w1 AS frequency_50pct,
	PERCENTILE_CONT(recency_days, 0.10) OVER w1 AS recency_90pct,
	PERCENTILE_CONT(recency_days, 0.25) OVER w1 AS recency_75pct,
	PERCENTILE_CONT(recency_days, 0.5) OVER w1 AS recency_50pct
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`customers_products_proc` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`customers_first_purchase_product_type_proc` b
	ON (
		a.client = b.client and
		a.customer_id = b.customer_id and
		a.product_type = b.product_type
		)
	WINDOW w1 as (PARTITION BY a.client, period, date, a.product_type)
)
2018-04-17 13:56:22,544: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d66bef0>]}
2018-04-17 13:56:22,768: 13:56:22 | 53 of 91 OK created table model agency_data_pipeline.segment_stats_sku [CREATE TABLE in 4.35s]
2018-04-17 13:56:24,669: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fba3208>]}
2018-04-17 13:56:24,705: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d822908>]}
2018-04-17 13:56:24,898: 13:56:24 | 54 of 91 OK created table model agency_data_pipeline.agg_transaction. [CREATE TABLE in 6.47s]
2018-04-17 13:56:25,134: 13:56:25 | 51 of 91 OK created table model agency_data_pipeline.agg_ga_transaction [CREATE TABLE in 6.52s]
2018-04-17 13:56:43,010: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fbb3550>]}
2018-04-17 13:56:43,686: 13:56:43 | 52 of 91 OK created table model agency_data_pipeline.segment_proc_customers_products [CREATE TABLE in 24.82s]
2018-04-17 13:56:43,688: 13:56:43 | 55 of 91 START table model agency_data_pipeline.segment_stats_customers_products_agg [RUN]
2018-04-17 13:56:43,688: 13:56:43 | 56 of 91 START table model agency_data_pipeline.customers_first_purchase_proc [RUN]
2018-04-17 13:56:43,690: Compiling model.agency_data_pipeline.segment_stats_customers_products_agg
2018-04-17 13:56:43,689: 13:56:43 | 57 of 91 START table model agency_data_pipeline.segment_stats_category [RUN]
2018-04-17 13:56:43,690: Compiling model.agency_data_pipeline.customers_first_purchase_proc
2018-04-17 13:56:43,689: 13:56:43 | 58 of 91 START table model agency_data_pipeline.agg_transaction_daily [RUN]
2018-04-17 13:56:43,704: Writing injected SQL for node "model.agency_data_pipeline.segment_stats_customers_products_agg"
2018-04-17 13:56:43,704: Compiling model.agency_data_pipeline.segment_stats_category
2018-04-17 13:56:43,716: Compiling model.agency_data_pipeline.agg_transaction_daily
2018-04-17 13:56:43,716: Writing injected SQL for node "model.agency_data_pipeline.customers_first_purchase_proc"
2018-04-17 13:56:43,733: Writing injected SQL for node "model.agency_data_pipeline.agg_transaction_daily"
2018-04-17 13:56:43,743: Writing injected SQL for node "model.agency_data_pipeline.segment_stats_category"
2018-04-17 13:56:43,747: Acquiring new bigquery connection "segment_stats_category".
2018-04-17 13:56:43,749: Re-using an available connection from the pool.
2018-04-17 13:56:43,752: Acquiring new bigquery connection "segment_stats_customers_products_agg".
2018-04-17 13:56:43,754: Re-using an available connection from the pool.
2018-04-17 13:56:43,766: Acquiring new bigquery connection "agg_transaction_daily".
2018-04-17 13:56:43,768: Re-using an available connection from the pool.
2018-04-17 13:56:43,780: Acquiring new bigquery connection "customers_first_purchase_proc".
2018-04-17 13:56:43,780: Re-using an available connection from the pool.
2018-04-17 13:56:44,783: Model SQL (segment_stats_customers_products_agg):
WITH ty as (

	SELECT
	client,
	date,
	customer_id,
	product_type,
	segment as segment_365,
	recency_days as recency_365,
	frequency as frequency_365,
	revenue as revenue_365,
	aov as aov_365,
	'' as segment_mom,
	0 as recency_mom,
	0 as frequency_mom,
	0 as revenue_mom,
	0 as aov_mom,
	'' as segment_yoy,
	0 as recency_yoy,
	0 as frequency_yoy,
	0 as revenue_yoy,
	0 as aov_yoy
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers_products`
	WHERE period = 'Rolling 365'

),

last_month as (

	SELECT
	client,
	date,
	customer_id,
	product_type,
	'' as segment_365,
	0 as recency_365,
	0 as frequency_365,
	0 as revenue_365,
	0 as aov_365,
	segment as segment_mom,
	recency_days as recency_mom,
	frequency as frequency_mom,
	revenue as revenue_mom,
	aov as aov_mom,
	'' as segment_yoy,
	0 as recency_yoy,
	0 as frequency_yoy,
	0 as revenue_yoy,
	0 as aov_yoy
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers_products`
	WHERE period = 'Rolling 365 (t-1mo)'

),

this_month_1yr as (

	SELECT
	client,
	date,
	customer_id,
	product_type,
	'' as segment_365,
	0 as recency_365,
	0 as frequency_365,
	0 as revenue_365,
	0 as aov_365,
	'' as segment_mom,
	0 as recency_mom,
	0 as frequency_mom,
	0 as revenue_mom,
	0 as aov_mom,
	segment as segment_yoy,
	recency_days as recency_yoy,
	frequency as frequency_yoy,
	revenue as revenue_yoy,
	aov as aov_yoy
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers_products`
	WHERE period = 'Rolling 365 (t-1yr)'


)

SELECT
client,
date, 
customer_id,
product_type,
ifnull(max(segment_365), '') segment_365,
ifnull(max(segment_mom), '') segment_mom,
ifnull(max(segment_yoy), '') segment_yoy,
ifnull(sum(recency_365), 0) recency_365,
ifnull(sum(frequency_365), 0) frequency_365,
ifnull(sum(revenue_365), 0) revenue_365,
ifnull(sum(aov_365), 0) aov_365,
ifnull(sum(recency_mom), 0) recency_mom,
ifnull(sum(frequency_mom), 0) frequency_mom,
ifnull(sum(revenue_mom), 0) revenue_mom,
ifnull(sum(aov_mom), 0) aov_mom,	
ifnull(sum(recency_yoy), 0) recency_yoy,
ifnull(sum(frequency_yoy), 0) frequency_yoy,
ifnull(sum(revenue_yoy), 0) revenue_yoy,
ifnull(sum(aov_yoy), 0) aov_yoy
FROM
(
	SELECT * FROM ty
	UNION ALL
	SELECT * FROM last_month
	UNION ALL
	SELECT * FROM this_month_1yr

)
GROUP BY client, date, customer_id, product_type
2018-04-17 13:56:44,786: Model SQL (customers_first_purchase_proc):
SELECT 
client, 
customer_id, 
min(cast(date as date)) first_order_date,
unix_date( min(cast(date as date))) first_order_unix_date
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction`
GROUP BY client, customer_id
2018-04-17 13:56:44,793: Model SQL (agg_transaction_daily):
SELECT
client,
date,
customer_id,
sum(last_touch_transactions) last_touch_transactions, 
sum(last_touch_revenue) last_touch_revenue, 
sum(first_touch_transactions) first_touch_transactions, 
sum(first_touch_revenue) first_touch_revenue,
sum(quantity) quantity,
sum(revenue) revenue,
count(distinct(order_number)) order_count
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction`
GROUP BY
client, 
date, 
customer_id
2018-04-17 13:56:44,837: Model SQL (segment_stats_category):
SELECT
client,
product_type,
date,
segment_30,
segment_90,
segment_yoy_30,
ifnull(sum(customers_30), 0) customers_30,
ifnull(sum(orders_30), 0) orders_30,
ifnull(sum(revenue_30), 0) revenue_30,
ifnull(sum(customers_90), 0) customers_90,
ifnull(sum(orders_90), 0) orders_90,
ifnull(sum(revenue_90), 0) revenue_90,
ifnull(sum(customers_yoy_30), 0) customers_yoy_30,
ifnull(sum(orders_yoy_30), 0) orders_yoy_30,
ifnull(sum(revenue_yoy_30), 0) revenue_yoy_30
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`segment_stats_sku`
GROUP BY client, product_type, date, segment_30, segment_90, segment_yoy_30
2018-04-17 13:56:47,011: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fbbc470>]}
2018-04-17 13:56:47,057: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fb73dd8>]}
2018-04-17 13:56:47,238: 13:56:47 | 56 of 91 OK created table model agency_data_pipeline.customers_first_purchase_proc [CREATE TABLE in 3.32s]
2018-04-17 13:56:47,240: 13:56:47 | 59 of 91 START table model agency_data_pipeline.order_paths_stats.... [RUN]
2018-04-17 13:56:47,241: Compiling model.agency_data_pipeline.order_paths_stats
2018-04-17 13:56:47,250: Writing injected SQL for node "model.agency_data_pipeline.order_paths_stats"
2018-04-17 13:56:47,252: Acquiring new bigquery connection "order_paths_stats".
2018-04-17 13:56:47,252: Re-using an available connection from the pool.
2018-04-17 13:56:47,543: 13:56:47 | 57 of 91 OK created table model agency_data_pipeline.segment_stats_category [CREATE TABLE in 3.35s]
2018-04-17 13:56:47,545: 13:56:47 | 60 of 91 START table model agency_data_pipeline.agg_ga_campaign_by_type [RUN]
2018-04-17 13:56:47,545: Compiling model.agency_data_pipeline.agg_ga_campaign_by_type
2018-04-17 13:56:47,617: Writing injected SQL for node "model.agency_data_pipeline.agg_ga_campaign_by_type"
2018-04-17 13:56:47,619: Acquiring new bigquery connection "agg_ga_campaign_by_type".
2018-04-17 13:56:47,619: Re-using an available connection from the pool.
2018-04-17 13:56:48,132: Model SQL (order_paths_stats):
WITH transactions AS (
  SELECT 
  client, 
  first_product_type,
  second_product_type,
  first_purchase_date,
  customer_count,
  second_orders,
  third_orders,
  fourth_orders,
  fifth_orders,
  second_order_latency_days,
  third_order_latency_days,
  fourth_order_latency_days,
  fifth_order_latency_days,
  first_order_revenue,
  second_order_revenue,
  unix_date(cast(first_purchase_date as date)) d
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`order_paths_agg`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)

SELECT 
client,
'Rolling 365' as period,
first_product_type,
second_product_type,
date_in_range date,
unix_date_in_range, 
sum(customer_count) customer_count,
sum(second_orders) second_orders,
sum(third_orders) third_orders,
sum(fourth_orders) fourth_orders,
sum(fifth_orders) fifth_orders,
sum(second_order_latency_days) second_order_latency_days,
sum(third_order_latency_days) third_order_latency_days,
sum(fourth_order_latency_days) fourth_order_latency_days,
sum(fifth_order_latency_days) fifth_order_latency_days,
sum(first_order_revenue) first_order_revenue,
sum(second_order_revenue) second_order_revenue
FROM daterange
JOIN transactions
ON transactions.d > ( daterange.unix_date_in_range - 365 )
AND transactions.d <= daterange.unix_date_in_range
group by client, first_product_type, second_product_type, date_in_range, unix_date_in_range
2018-04-17 13:56:48,499: Model SQL (agg_ga_campaign_by_type):
with orders_new as (
    select 
    date, 
    client, 
    attribution,
    channel, 
    platform, 
    url, 
    campaign,
    count(distinct(customer_id)) customers_new,
    sum(transactions) transactions_new,
    sum(revenue) revenue_new,
    sum(first_order_revenue) first_order_revenue_new,
    sum(lifetime_revenue) lifetime_revenue_new,
    null as customers_total,
    null as transactions_total,
    null as revenue_total
    from `growth-engines-pipeline`.`agency_data_pipeline`.`agg_ga_transaction`
    where order_type = 'New'
    group by date, client, attribution, channel, platform, url, campaign
),
    
orders_total as (
    select 
    date, 
    client, 
    attribution,
    channel, 
    platform, 
    url, 
    campaign,
    null as customers_new,
    null as transactions_new,
    null as revenue_new,
    null as first_order_revenue_new,
    null as lifetime_revenue_new,
    count(distinct(customer_id)) customers_total,
    sum(transactions) transactions_total,
    sum(revenue) revenue_total
    from `growth-engines-pipeline`.`agency_data_pipeline`.`agg_ga_transaction`
    group by date, client, attribution, channel, platform, url, campaign

)

SELECT 
date, 
client, 
attribution,
channel, 
platform, 
url, 
campaign,
sum(customers_new) customers_new,
sum(transactions_new) transactions_new,
sum(revenue_new) revenue_new,
sum(first_order_revenue_new) first_order_revenue_new,
sum(lifetime_revenue_new) lifetime_revenue_new,
sum(customers_total) customers_total,
sum(transactions_total) transactions_total,
sum(revenue_total) revenue_total
from
    ( 
        SELECT * FROM orders_new
        UNION ALL 
        SELECT * FROM orders_total
    )
group by date, client, attribution, channel, platform, url, campaign
2018-04-17 13:56:50,406: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fbba940>]}
2018-04-17 13:56:50,636: 13:56:50 | 59 of 91 OK created table model agency_data_pipeline.order_paths_stats [CREATE TABLE in 3.16s]
2018-04-17 13:56:51,389: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d7a4198>]}
2018-04-17 13:56:51,613: 13:56:51 | 58 of 91 OK created table model agency_data_pipeline.agg_transaction_daily [CREATE TABLE in 7.67s]
2018-04-17 13:56:54,019: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fb73dd8>]}
2018-04-17 13:56:54,291: 13:56:54 | 60 of 91 OK created table model agency_data_pipeline.agg_ga_campaign_by_type [CREATE TABLE in 6.47s]
2018-04-17 13:57:10,152: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a2bc898>]}
2018-04-17 13:57:10,770: 13:57:10 | 55 of 91 OK created table model agency_data_pipeline.segment_stats_customers_products_agg [CREATE TABLE in 26.46s]
2018-04-17 13:57:10,771: 13:57:10 | 61 of 91 START table model agency_data_pipeline.customers_proc....... [RUN]
2018-04-17 13:57:10,771: 13:57:10 | 62 of 91 START table model agency_data_pipeline.segment_stats_customers_products [RUN]
2018-04-17 13:57:10,772: Compiling model.agency_data_pipeline.customers_proc
2018-04-17 13:57:10,772: 13:57:10 | 63 of 91 START table model agency_data_pipeline.growth_customer_0_365 [RUN]
2018-04-17 13:57:10,772: Compiling model.agency_data_pipeline.segment_stats_customers_products
2018-04-17 13:57:10,778: Compiling model.agency_data_pipeline.growth_customer_0_365
2018-04-17 13:57:10,786: Writing injected SQL for node "model.agency_data_pipeline.customers_proc"
2018-04-17 13:57:10,797: Writing injected SQL for node "model.agency_data_pipeline.segment_stats_customers_products"
2018-04-17 13:57:10,811: Writing injected SQL for node "model.agency_data_pipeline.growth_customer_0_365"
2018-04-17 13:57:10,815: Acquiring new bigquery connection "segment_stats_customers_products".
2018-04-17 13:57:10,815: Re-using an available connection from the pool.
2018-04-17 13:57:10,818: Acquiring new bigquery connection "growth_customer_0_365".
2018-04-17 13:57:10,820: Re-using an available connection from the pool.
2018-04-17 13:57:10,822: Acquiring new bigquery connection "customers_proc".
2018-04-17 13:57:10,822: Re-using an available connection from the pool.
2018-04-17 13:57:11,604: Model SQL (customers_proc):
WITH customers AS (
  SELECT 
  client, 
  customer_id, 
  order_number,
  cast(date as date) order_date,
  unix_date(cast(date as date)) unix_order_date, 
  quantity,
  revenue 
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)
 
SELECT 
client,
period,
customer_id,
date,
window_end_unix_date,
window_end_unix_date - 365 as window_start_unix_date,
window_end_unix_date - unix_date(recent_order) recency_days,
frequency,
quantity,
revenue,
case when frequency > 0 then revenue/frequency else 0 end as aov
FROM 
(  

  SELECT 
  client,
  'Rolling 365' as period,
  customer_id,
  date_in_range date,
  unix_date_in_range,
  unix_date_in_range window_end_unix_date,
  max(order_date) recent_order,
  sum(quantity) as quantity,
  sum(revenue) as revenue,
  count(distinct(order_number)) as frequency
  FROM daterange
  JOIN customers
  ON customers.unix_order_date > ( daterange.unix_date_in_range - 365 )
  AND customers.unix_order_date <= daterange.unix_date_in_range
  GROUP BY client, customer_id, date, unix_date_in_range

  UNION ALL

  SELECT 
  client,
  'Rolling 365 (t-1mo)' as period,
  customer_id,
  date_in_range date,
  unix_date_in_range,
  unix_date_in_range - 30 window_end_unix_date, 
  max(order_date) recent_order,
  sum(quantity) as quantity,
  sum(revenue) as revenue,
  count(distinct(order_number)) as frequency
  FROM daterange
  JOIN customers
  ON customers.unix_order_date > ( daterange.unix_date_in_range - 395 )
  AND customers.unix_order_date <= ( daterange.unix_date_in_range - 30 )
  GROUP BY client, customer_id, date, unix_date_in_range

  UNION ALL

  SELECT 
  client,
  'Rolling 365 (t-1yr)' as period,
  customer_id,
  date_in_range date,
  unix_date_in_range, 
  unix_date_in_range - 365 window_end_unix_date, 
  max(order_date) recent_order,
  sum(quantity) as quantity,
  sum(revenue) as revenue,
  count(distinct(order_number)) as frequency
  FROM daterange
  JOIN customers
  ON customers.unix_order_date > ( daterange.unix_date_in_range - 730 )
  AND customers.unix_order_date <= ( daterange.unix_date_in_range - 365 )
  GROUP BY client, customer_id, date, unix_date_in_range

)
2018-04-17 13:57:11,702: Model SQL (segment_stats_customers_products):
SELECT
client,
date,
product_type,
segment_365,
segment_mom,
segment_yoy,
count(distinct(customer_id)) customers,
avg(recency_365) recency_365,
sum(frequency_365) frequency_365,
sum(revenue_365) revenue_365,
case when sum(frequency_365) > 0 then sum(revenue_365)/sum(frequency_365) else null end as aov_365,
avg(recency_mom) recency_mom,
sum(frequency_mom) frequency_mom,
sum(revenue_mom) revenue_mom,
case when sum(frequency_mom) > 0 then sum(revenue_mom)/sum(frequency_mom) else null end as aov_mom,
avg(recency_yoy) recency_yoy,
sum(frequency_yoy) frequency_yoy,
sum(revenue_yoy) revenue_yoy,
case when sum(frequency_yoy) > 0 then sum(revenue_yoy)/sum(frequency_yoy) else null end as aov_yoy
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_stats_customers_products_agg`
GROUP BY client, date, product_type, segment_365, segment_mom, segment_yoy
2018-04-17 13:57:11,743: Model SQL (growth_customer_0_365):
WITH transactions AS (
  SELECT 
  client, 
  customer_id, 
  order_number,
  unix_date(cast(date as date)) d, 
  quantity,
  revenue,
  shipping_revenue
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)

SELECT 
date_in_range date,
unix_date_in_range, 
unix_date_in_range_yoy, 
client, 
customer_id,
count(distinct(order_number)) orders,
sum(quantity) quantity,
sum(revenue) revenue,
sum(shipping_revenue) shipping_revenue
FROM daterange
JOIN transactions
ON transactions.d >= ( daterange.unix_date_in_range - 365 ) 
AND transactions.d <= daterange.unix_date_in_range
GROUP BY date, unix_date_in_range, unix_date_in_range_yoy, client, customer_id
2018-04-17 13:57:23,819: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a2bc630>]}
2018-04-17 13:57:24,048: 13:57:24 | 62 of 91 OK created table model agency_data_pipeline.segment_stats_customers_products [CREATE TABLE in 13.05s]
2018-04-17 13:57:30,624: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a2ec4a8>]}
2018-04-17 13:57:30,843: 13:57:30 | 63 of 91 OK created table model agency_data_pipeline.growth_customer_0_365 [CREATE TABLE in 19.85s]
2018-04-17 13:57:42,656: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fbbc0f0>]}
2018-04-17 13:57:43,353: 13:57:43 | 61 of 91 OK created table model agency_data_pipeline.customers_proc.. [CREATE TABLE in 31.88s]
2018-04-17 13:57:43,354: 13:57:43 | 64 of 91 START table model agency_data_pipeline.segment_list_customers_products [RUN]
2018-04-17 13:57:43,355: Compiling model.agency_data_pipeline.segment_list_customers_products
2018-04-17 13:57:43,354: 13:57:43 | 65 of 91 START table model agency_data_pipeline.retention_60_plus.... [RUN]
2018-04-17 13:57:43,355: 13:57:43 | 66 of 91 START table model agency_data_pipeline.retention_30_60...... [RUN]
2018-04-17 13:57:43,355: 13:57:43 | 67 of 91 START table model agency_data_pipeline.retention_365_730.... [RUN]
2018-04-17 13:57:43,367: Compiling model.agency_data_pipeline.retention_60_plus
2018-04-17 13:57:43,370: Writing injected SQL for node "model.agency_data_pipeline.segment_list_customers_products"
2018-04-17 13:57:43,370: Compiling model.agency_data_pipeline.retention_30_60
2018-04-17 13:57:43,370: Compiling model.agency_data_pipeline.retention_365_730
2018-04-17 13:57:43,376: Writing injected SQL for node "model.agency_data_pipeline.retention_60_plus"
2018-04-17 13:57:43,381: Writing injected SQL for node "model.agency_data_pipeline.retention_30_60"
2018-04-17 13:57:43,389: Writing injected SQL for node "model.agency_data_pipeline.retention_365_730"
2018-04-17 13:57:43,390: Acquiring new bigquery connection "segment_list_customers_products".
2018-04-17 13:57:43,391: Re-using an available connection from the pool.
2018-04-17 13:57:43,398: Acquiring new bigquery connection "retention_60_plus".
2018-04-17 13:57:43,399: Acquiring new bigquery connection "retention_30_60".
2018-04-17 13:57:43,399: Re-using an available connection from the pool.
2018-04-17 13:57:43,400: Acquiring new bigquery connection "retention_365_730".
2018-04-17 13:57:43,402: Re-using an available connection from the pool.
2018-04-17 13:57:43,403: Re-using an available connection from the pool.
2018-04-17 13:57:44,423: Model SQL (retention_60_plus):
WITH transactions AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_daily`
),

daterange AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`  	
),

temp AS (
  SELECT 
  client, 
  customer_id, 
  unix_date(date) d, 
  quantity,
  revenue,
  order_count
  FROM transactions
)

SELECT 
date_in_range date, 
unix_date_in_range,
client, 
customer_id,
sum(quantity) quantity,
sum(revenue) revenue,
sum(order_count) order_count
FROM daterange
JOIN temp
ON temp.d < ( daterange.unix_date_in_range_bom_mom ) 
group by date_in_range, unix_date_in_range, client, customer_id
2018-04-17 13:57:44,425: Model SQL (retention_365_730):
WITH transactions AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_daily`
),

daterange AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`  	
),

temp AS (
  SELECT 
  client, 
  customer_id, 
  unix_date(date) d, 
  quantity,
  revenue,
  order_count
  FROM transactions
)

SELECT 
date_in_range date, 
unix_date_in_range,
client, 
customer_id,
sum(quantity) quantity,
sum(revenue) revenue,
sum(order_count) order_count
FROM daterange
JOIN temp
ON ( temp.d >= ( daterange.unix_date_in_range - 730 ) 
AND temp.d < ( daterange.unix_date_in_range - 365 ) )
group by date_in_range, unix_date_in_range, client, customer_id
2018-04-17 13:57:44,426: Model SQL (retention_30_60):
WITH transactions AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_daily`
),

daterange AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`  	
),

temp AS (
  SELECT 
  client, 
  customer_id, 
  unix_date(date) d, 
  quantity,
  revenue,
  order_count
  FROM transactions
)

SELECT 
date_in_range date, 
unix_date_in_range,
client, 
customer_id,
sum(quantity) quantity,
sum(revenue) revenue,
sum(order_count) order_count
FROM daterange
JOIN temp
ON ( temp.d >= ( daterange.unix_date_in_range_bom_mom ) 
AND temp.d < ( daterange.unix_date_in_range_bom ) )
group by date_in_range, unix_date_in_range, client, customer_id
2018-04-17 13:57:44,595: Model SQL (segment_list_customers_products):
SELECT
a.client,
period,
date,
customer_id,
product_type,
b.first_name,
b.last_name,
b.email,
recency_days,
frequency,
revenue,
quantity,
aov,
segment
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers_products` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`agg_customers_union` b
ON (
	a.client = b.client AND
	a.customer_id = b.id
)
2018-04-17 13:57:48,884: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fc07518>]}
2018-04-17 13:57:49,116: 13:57:49 | 66 of 91 OK created table model agency_data_pipeline.retention_30_60. [CREATE TABLE in 5.51s]
2018-04-17 13:57:49,116: 13:57:49 | 68 of 91 START table model agency_data_pipeline.retention_0_365...... [RUN]
2018-04-17 13:57:49,117: Compiling model.agency_data_pipeline.retention_0_365
2018-04-17 13:57:49,128: Writing injected SQL for node "model.agency_data_pipeline.retention_0_365"
2018-04-17 13:57:49,130: Acquiring new bigquery connection "retention_0_365".
2018-04-17 13:57:49,130: Re-using an available connection from the pool.
2018-04-17 13:57:49,886: Model SQL (retention_0_365):
WITH transactions AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_daily`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
),

temp AS (
  SELECT 
  client, 
  customer_id, 
  unix_date(date) d, 
  quantity,
  revenue,
  order_count
  FROM transactions
)

SELECT 
date_in_range date,
unix_date_in_range, 
client, 
customer_id,
sum(quantity) quantity,
sum(revenue) revenue,
sum(order_count) order_count
FROM daterange
JOIN temp
ON temp.d >= ( daterange.unix_date_in_range - 365 ) 
AND temp.d <= daterange.unix_date_in_range
group by date_in_range, unix_date_in_range, client, customer_id
2018-04-17 13:57:49,985: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fc07e10>]}
2018-04-17 13:57:50,217: 13:57:50 | 67 of 91 OK created table model agency_data_pipeline.retention_365_730 [CREATE TABLE in 6.61s]
2018-04-17 13:57:50,218: 13:57:50 | 69 of 91 START table model agency_data_pipeline.retention_730_plus... [RUN]
2018-04-17 13:57:50,219: Compiling model.agency_data_pipeline.retention_730_plus
2018-04-17 13:57:50,229: Writing injected SQL for node "model.agency_data_pipeline.retention_730_plus"
2018-04-17 13:57:50,230: Acquiring new bigquery connection "retention_730_plus".
2018-04-17 13:57:50,230: Re-using an available connection from the pool.
2018-04-17 13:57:51,034: Model SQL (retention_730_plus):
WITH transactions AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_daily`
),

daterange AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`  	
),

temp AS (
  SELECT 
  client, 
  customer_id, 
  unix_date(date) d, 
  quantity,
  revenue,
  order_count
  FROM transactions
)

SELECT 
date_in_range date, 
unix_date_in_range,
client, 
customer_id,
sum(quantity) quantity,
sum(revenue) revenue,
sum(order_count) order_count
FROM daterange
JOIN temp
ON temp.d <= ( daterange.unix_date_in_range - 730 ) 
group by date_in_range, unix_date_in_range, client, customer_id
2018-04-17 13:57:53,279: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fc07e10>]}
2018-04-17 13:57:53,535: 13:57:53 | 69 of 91 OK created table model agency_data_pipeline.retention_730_plus [CREATE TABLE in 3.06s]
2018-04-17 13:57:53,535: 13:57:53 | 70 of 91 START table model agency_data_pipeline.retention_0_30....... [RUN]
2018-04-17 13:57:53,536: Compiling model.agency_data_pipeline.retention_0_30
2018-04-17 13:57:53,546: Writing injected SQL for node "model.agency_data_pipeline.retention_0_30"
2018-04-17 13:57:53,547: Acquiring new bigquery connection "retention_0_30".
2018-04-17 13:57:53,547: Re-using an available connection from the pool.
2018-04-17 13:57:54,235: Model SQL (retention_0_30):
WITH transactions AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_daily`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
),

temp AS (
  SELECT 
  client, 
  customer_id, 
  unix_date(date) d, 
  quantity,
  revenue,
  order_count
  FROM transactions
)

SELECT 
date_in_range date,
unix_date_in_range, 
client, 
customer_id,
sum(quantity) quantity,
sum(revenue) revenue,
sum(order_count) order_count
FROM daterange
JOIN temp
ON temp.d >= ( daterange.unix_date_in_range_bom ) 
AND temp.d <= daterange.unix_date_in_range
group by date_in_range, unix_date_in_range, client, customer_id
2018-04-17 13:57:55,533: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fba3f28>]}
2018-04-17 13:57:55,784: 13:57:55 | 65 of 91 OK created table model agency_data_pipeline.retention_60_plus [CREATE TABLE in 12.17s]
2018-04-17 13:57:57,653: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fc07e10>]}
2018-04-17 13:57:57,906: 13:57:57 | 70 of 91 OK created table model agency_data_pipeline.retention_0_30.. [CREATE TABLE in 4.12s]
2018-04-17 13:58:02,111: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fc07518>]}
2018-04-17 13:58:02,349: 13:58:02 | 68 of 91 OK created table model agency_data_pipeline.retention_0_365. [CREATE TABLE in 12.99s]
2018-04-17 13:58:30,263: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d7e67b8>]}
2018-04-17 13:58:30,554: 13:58:30 | 64 of 91 OK created table model agency_data_pipeline.segment_list_customers_products [CREATE TABLE in 46.91s]
2018-04-17 13:58:30,556: 13:58:30 | 71 of 91 START table model agency_data_pipeline.segment_proc_customers [RUN]
2018-04-17 13:58:30,556: 13:58:30 | 72 of 91 START table model agency_data_pipeline.agg_platforms_union.. [RUN]
2018-04-17 13:58:30,557: Compiling model.agency_data_pipeline.segment_proc_customers
2018-04-17 13:58:30,557: Compiling model.agency_data_pipeline.agg_platforms_union
2018-04-17 13:58:30,572: Writing injected SQL for node "model.agency_data_pipeline.segment_proc_customers"
2018-04-17 13:58:30,578: Writing injected SQL for node "model.agency_data_pipeline.agg_platforms_union"
2018-04-17 13:58:30,582: Acquiring new bigquery connection "agg_platforms_union".
2018-04-17 13:58:30,582: Re-using an available connection from the pool.
2018-04-17 13:58:30,587: Acquiring new bigquery connection "segment_proc_customers".
2018-04-17 13:58:30,589: Re-using an available connection from the pool.
2018-04-17 13:58:31,610: Model SQL (segment_proc_customers):
SELECT
client,
period,
date,
customer_id,
first_order_date,
first_order_unix_date,
recency_days,
frequency,
revenue,
quantity,
aov,
case when frequency = 1 and recency_days <= 30 and first_order_unix_date >= window_start_unix_date then 'New'
	when frequency = 1 then 'One-time Purchaser'
	when frequency > frequency_90pct and recency_days < recency_90pct and aov > aov_50pct then 'Champion'
	when recency_days < recency_90pct and frequency > frequency_75pct then 'Potential Loyalists' 
	when frequency > frequency_75pct and recency_days <= recency_50pct then 'Cant Lose'
	when recency_days < recency_50pct and frequency > frequency_50pct then 'Loyal'
	when recency_days > recency_50pct and frequency > frequency_50pct then 'Frequent, not Recent'
	when recency_days < recency_50pct and frequency < frequency_50pct then 'Recent, not Frequent'
	else 'Unbucketed' end as segment,
aov_50pct,
frequency_90pct,
frequency_75pct,
frequency_50pct,
recency_90pct,
recency_75pct,
recency_50pct
FROM
(
	SELECT 
	a.client client,
	period,
	date,
	a.customer_id customer_id,
	b.first_order_date first_order_date,
	b.first_order_unix_date first_order_unix_date,
	window_start_unix_date,
	window_end_unix_date,
	recency_days,
	frequency,
	revenue,
	quantity,
	aov,
	PERCENTILE_CONT(aov, 0.50) OVER w1 AS aov_50pct,
	PERCENTILE_CONT(frequency, 0.90) OVER w1 AS frequency_90pct,
	PERCENTILE_CONT(frequency, 0.75) OVER w1 AS frequency_75pct,
	PERCENTILE_CONT(frequency, 0.90) OVER w1 AS frequency_50pct,
	PERCENTILE_CONT(recency_days, 0.10) OVER w1 AS recency_90pct,
	PERCENTILE_CONT(recency_days, 0.25) OVER w1 AS recency_75pct,
	PERCENTILE_CONT(recency_days, 0.5) OVER w1 AS recency_50pct
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`customers_proc` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`customers_first_purchase_proc` b
	ON (
		a.client = b.client and
		a.customer_id = b.customer_id
		)
	WINDOW w1 as (PARTITION BY a.client, period, date)
)
2018-04-17 13:58:31,726: Model SQL (agg_platforms_union):
SELECT 
date, 
account, 
channel,
platform,
url,
utm_campaign,
campaign,
cost,
impressions,
clicks,
transactions
FROM 
`growth-engines-pipeline`.`agency_data_pipeline`.`adwords_stats`

UNION ALL

SELECT 
date, 
account, 
channel,
platform,
url,
utm_campaign,
campaign,
cost,
impressions,
clicks,
transactions
FROM 
`growth-engines-pipeline`.`agency_data_pipeline`.`bing_ads_stats`

UNION ALL  

SELECT 
date, 
account, 
channel,
platform,
url,
utm_campaign,
campaign,
cost,
impressions,
clicks,
transactions
FROM 
`growth-engines-pipeline`.`agency_data_pipeline`.`fb_ads_stats`
2018-04-17 13:58:37,263: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a2ec748>]}
2018-04-17 13:58:37,933: 13:58:37 | 72 of 91 OK created table model agency_data_pipeline.agg_platforms_union [CREATE TABLE in 6.71s]
2018-04-17 13:59:02,555: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a303048>]}
2018-04-17 13:59:02,816: 13:59:02 | 71 of 91 OK created table model agency_data_pipeline.segment_proc_customers [CREATE TABLE in 32.00s]
2018-04-17 13:59:02,818: 13:59:02 | 73 of 91 START table model agency_data_pipeline.retention_0_365_rebuy [RUN]
2018-04-17 13:59:02,819: 13:59:02 | 74 of 91 START table model agency_data_pipeline.retention_0_30_rebuy. [RUN]
2018-04-17 13:59:02,820: Compiling model.agency_data_pipeline.retention_0_365_rebuy
2018-04-17 13:59:02,819: 13:59:02 | 75 of 91 START table model agency_data_pipeline.segment_stats_customers_agg [RUN]
2018-04-17 13:59:02,820: Compiling model.agency_data_pipeline.retention_0_30_rebuy
2018-04-17 13:59:02,830: Writing injected SQL for node "model.agency_data_pipeline.retention_0_365_rebuy"
2018-04-17 13:59:02,830: Compiling model.agency_data_pipeline.segment_stats_customers_agg
2018-04-17 13:59:02,838: Writing injected SQL for node "model.agency_data_pipeline.retention_0_30_rebuy"
2018-04-17 13:59:02,846: Writing injected SQL for node "model.agency_data_pipeline.segment_stats_customers_agg"
2018-04-17 13:59:02,849: Acquiring new bigquery connection "retention_0_365_rebuy".
2018-04-17 13:59:02,853: Acquiring new bigquery connection "retention_0_30_rebuy".
2018-04-17 13:59:02,854: Acquiring new bigquery connection "segment_stats_customers_agg".
2018-04-17 13:59:02,854: Re-using an available connection from the pool.
2018-04-17 13:59:02,854: Re-using an available connection from the pool.
2018-04-17 13:59:02,855: Re-using an available connection from the pool.
2018-04-17 13:59:03,796: Model SQL (retention_0_30_rebuy):
SELECT 
r2.client,
r2.date,
r2.customer_id, 
r2.quantity,
r2.revenue
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_30_60` r1 
left join `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30` r2 
  on ( r1.customer_id = r2.customer_id 
  and r1.date = r2.date )
2018-04-17 13:59:03,806: Model SQL (segment_stats_customers_agg):
WITH ty as (

	SELECT
	client,
	date,
	customer_id,
	segment as segment_365,
	recency_days as recency_365,
	frequency as frequency_365,
	revenue as revenue_365,
	aov as aov_365,
	'' as segment_mom,
	0 as recency_mom,
	0 as frequency_mom,
	0 as revenue_mom,
	0 as aov_mom,
	'' as segment_yoy,
	0 as recency_yoy,
	0 as frequency_yoy,
	0 as revenue_yoy,
	0 as aov_yoy
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers`
	WHERE period = 'Rolling 365'

),

last_month as (

	SELECT
	client,
	date,
	customer_id,
	'' as segment_365,
	0 as recency_365,
	0 as frequency_365,
	0 as revenue_365,
	0 as aov_365,
	segment as segment_mom,
	recency_days as recency_mom,
	frequency as frequency_mom,
	revenue as revenue_mom,
	aov as aov_mom,
	'' as segment_yoy,
	0 as recency_yoy,
	0 as frequency_yoy,
	0 as revenue_yoy,
	0 as aov_yoy
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers`
	WHERE period = 'Rolling 365 (t-1mo)'

),

this_month_1yr as (

	SELECT
	client,
	date,
	customer_id,
	'' as segment_365,
	0 as recency_365,
	0 as frequency_365,
	0 as revenue_365,
	0 as aov_365,
	'' as segment_mom,
	0 as recency_mom,
	0 as frequency_mom,
	0 as revenue_mom,
	0 as aov_mom,
	segment as segment_yoy,
	recency_days as recency_yoy,
	frequency as frequency_yoy,
	revenue as revenue_yoy,
	aov as aov_yoy
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers`
	WHERE period = 'Rolling 365 (t-1yr)'


)

SELECT
client,
date, 
customer_id,
ifnull(max(segment_365), '') segment_365,
ifnull(max(segment_mom), '') segment_mom,
ifnull(max(segment_yoy), '') segment_yoy,
ifnull(sum(recency_365), 0) recency_365,
ifnull(sum(frequency_365), 0) frequency_365,
ifnull(sum(revenue_365), 0) revenue_365,
ifnull(sum(aov_365), 0) aov_365,
ifnull(sum(recency_mom), 0) recency_mom,
ifnull(sum(frequency_mom), 0) frequency_mom,
ifnull(sum(revenue_mom), 0) revenue_mom,
ifnull(sum(aov_mom), 0) aov_mom,	
ifnull(sum(recency_yoy), 0) recency_yoy,
ifnull(sum(frequency_yoy), 0) frequency_yoy,
ifnull(sum(revenue_yoy), 0) revenue_yoy,
ifnull(sum(aov_yoy), 0) aov_yoy
FROM
(
	SELECT * FROM ty
	UNION ALL
	SELECT * FROM last_month
	UNION ALL
	SELECT * FROM this_month_1yr

)
GROUP BY client, date, customer_id
2018-04-17 13:59:03,827: Model SQL (retention_0_365_rebuy):
SELECT 
r2.client,
r2.date,
r2.customer_id, 
r2.quantity,
r2.revenue
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_365_730` r1 
left join `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365` r2 
  on ( r1.customer_id = r2.customer_id 
  and r1.date = r2.date )
2018-04-17 13:59:05,995: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fba3898>]}
2018-04-17 13:59:06,227: 13:59:06 | 74 of 91 OK created table model agency_data_pipeline.retention_0_30_rebuy [CREATE TABLE in 3.18s]
2018-04-17 13:59:09,391: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d7e67b8>]}
2018-04-17 13:59:09,629: 13:59:09 | 73 of 91 OK created table model agency_data_pipeline.retention_0_365_rebuy [CREATE TABLE in 6.57s]
2018-04-17 13:59:26,327: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d7e6f98>]}
2018-04-17 13:59:26,689: 13:59:26 | 75 of 91 OK created table model agency_data_pipeline.segment_stats_customers_agg [CREATE TABLE in 23.50s]
2018-04-17 13:59:26,690: 13:59:26 | 76 of 91 START table model agency_data_pipeline.retention_stats_rebuy_rate_month [RUN]
2018-04-17 13:59:26,691: Compiling model.agency_data_pipeline.retention_stats_rebuy_rate_month
2018-04-17 13:59:26,690: 13:59:26 | 77 of 91 START table model agency_data_pipeline.retention_0_365_new.. [RUN]
2018-04-17 13:59:26,698: Writing injected SQL for node "model.agency_data_pipeline.retention_stats_rebuy_rate_month"
2018-04-17 13:59:26,690: 13:59:26 | 78 of 91 START table model agency_data_pipeline.segment_stats_customers [RUN]
2018-04-17 13:59:26,690: 13:59:26 | 79 of 91 START table model agency_data_pipeline.retention_stats_rebuy_rate [RUN]
2018-04-17 13:59:26,698: Compiling model.agency_data_pipeline.retention_0_365_new
2018-04-17 13:59:26,699: Compiling model.agency_data_pipeline.segment_stats_customers
2018-04-17 13:59:26,699: Compiling model.agency_data_pipeline.retention_stats_rebuy_rate
2018-04-17 13:59:26,710: Writing injected SQL for node "model.agency_data_pipeline.segment_stats_customers"
2018-04-17 13:59:26,705: Writing injected SQL for node "model.agency_data_pipeline.retention_0_365_new"
2018-04-17 13:59:26,711: Acquiring new bigquery connection "retention_stats_rebuy_rate_month".
2018-04-17 13:59:26,723: Writing injected SQL for node "model.agency_data_pipeline.retention_stats_rebuy_rate"
2018-04-17 13:59:26,723: Re-using an available connection from the pool.
2018-04-17 13:59:26,726: Acquiring new bigquery connection "segment_stats_customers".
2018-04-17 13:59:26,726: Re-using an available connection from the pool.
2018-04-17 13:59:26,728: Acquiring new bigquery connection "retention_stats_rebuy_rate".
2018-04-17 13:59:26,729: Re-using an available connection from the pool.
2018-04-17 13:59:26,732: Acquiring new bigquery connection "retention_0_365_new".
2018-04-17 13:59:26,734: Re-using an available connection from the pool.
2018-04-17 13:59:27,833: Model SQL (retention_stats_rebuy_rate):
WITH r1 AS (
	SELECT 
	date,
	client,
	count(distinct customer_id) customers_prior_year,
	0 as customers_current_year, 
	sum(quantity) quantity_prior_year,
	0 as quantity_current_year,
	sum(revenue) revenue_prior_year,
	0 as revenue_current_year,
	case when sum(quantity) > 0 then sum(revenue)/sum(quantity) else null end as aov_prior_year,
	null as aov_current_year
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_365_730`
	group by date, client
),

r2 AS (
	SELECT 
	date,
	client,
	0 as customers_prior_year,
	count(distinct customer_id) customers_current_year, 
	0 as quantity_prior_year,
	sum(quantity) quantity_current_year,
	0 as revenue_prior_year,
	sum(revenue) revenue_current_year,
	null as aov_prior_year,
	case when sum(quantity) > 0 then sum(revenue)/sum(quantity) else null end as aov_current_year
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365_rebuy`
	group by date, client
)

SELECT 
date,
client,
sum(customers_prior_year) customers_prior_year, 
sum(customers_current_year) customers_current_year,
sum(quantity_prior_year) quantity_prior_year,
sum(quantity_current_year) quantity_current_year,
sum(revenue_prior_year) revenue_prior_year,
sum(revenue_current_year) revenue_current_year,
sum(aov_prior_year) aov_prior_year,
sum(aov_current_year) aov_current_year,
case when sum(revenue_prior_year) > 0 then sum(revenue_current_year)/sum(revenue_prior_year) else null end as revenue_retention,
case when sum(customers_prior_year) > 0 then sum(customers_current_year)/sum(customers_prior_year) else null end as customer_retention
FROM
(
	SELECT
	date,
	client,
	customers_prior_year,
	customers_current_year,
	quantity_prior_year,
	quantity_current_year,
	revenue_prior_year,
	revenue_current_year,
	aov_prior_year,
	aov_current_year
	FROM r1

	UNION ALL

	SELECT
	date,
	client,
	customers_prior_year,
	customers_current_year,
	quantity_prior_year,
	quantity_current_year,
	revenue_prior_year,
	revenue_current_year,
	aov_prior_year,
	aov_current_year
	FROM r2

) 
GROUP BY date, client
2018-04-17 13:59:27,834: Model SQL (segment_stats_customers):
SELECT
client,
date,
segment_365,
segment_mom,
segment_yoy,
count(distinct(customer_id)) customers,
avg(recency_365) recency_365,
sum(frequency_365) frequency_365,
sum(revenue_365) revenue_365,
case when sum(frequency_365) > 0 then sum(revenue_365)/sum(frequency_365) else null end as aov_365,
avg(recency_mom) recency_mom,
sum(frequency_mom) frequency_mom,
sum(revenue_mom) revenue_mom,
case when sum(frequency_mom) > 0 then sum(revenue_mom)/sum(frequency_mom) else null end as aov_mom,
avg(recency_yoy) recency_yoy,
sum(frequency_yoy) frequency_yoy,
sum(revenue_yoy) revenue_yoy,
case when sum(frequency_yoy) > 0 then sum(revenue_yoy)/sum(frequency_yoy) else null end as aov_yoy
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_stats_customers_agg`
GROUP BY client, date, segment_365, segment_mom, segment_yoy
2018-04-17 13:59:27,834: Model SQL (retention_stats_rebuy_rate_month):
WITH r1 AS (
	SELECT 
	date,
	client,
	count(distinct customer_id) customers_prior_year,
	0 as customers_current_year, 
	sum(quantity) quantity_prior_year,
	0 as quantity_current_year,
	sum(revenue) revenue_prior_year,
	0 as revenue_current_year,
	case when sum(quantity) > 0 then sum(revenue)/sum(quantity) else null end as aov_prior_year,
	null as aov_current_year
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_30_60`
	group by date, client
),

r2 AS (
	SELECT 
	date,
	client,
	0 as customers_prior_year,
	count(distinct customer_id) customers_current_year, 
	0 as quantity_prior_year,
	sum(quantity) quantity_current_year,
	0 as revenue_prior_year,
	sum(revenue) revenue_current_year,
	null as aov_prior_year,
	case when sum(quantity) > 0 then sum(revenue)/sum(quantity) else null end as aov_current_year
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30_rebuy`
	group by date, client
)

SELECT 
date,
client,
sum(customers_prior_year) customers_prior_year, 
sum(customers_current_year) customers_current_year,
sum(quantity_prior_year) quantity_prior_year,
sum(quantity_current_year) quantity_current_year,
sum(revenue_prior_year) revenue_prior_year,
sum(revenue_current_year) revenue_current_year,
sum(aov_prior_year) aov_prior_year,
sum(aov_current_year) aov_current_year,
case when sum(revenue_prior_year) > 0 then sum(revenue_current_year)/sum(revenue_prior_year) else null end as revenue_retention,
case when sum(customers_prior_year) > 0 then sum(customers_current_year)/sum(customers_prior_year) else null end as customer_retention
FROM
(
	SELECT
	date,
	client,
	customers_prior_year,
	customers_current_year,
	quantity_prior_year,
	quantity_current_year,
	revenue_prior_year,
	revenue_current_year,
	aov_prior_year,
	aov_current_year
	FROM r1

	UNION ALL

	SELECT
	date,
	client,
	customers_prior_year,
	customers_current_year,
	quantity_prior_year,
	quantity_current_year,
	revenue_prior_year,
	revenue_current_year,
	aov_prior_year,
	aov_current_year
	FROM r2

) 
GROUP BY date, client
2018-04-17 13:59:27,835: Model SQL (retention_0_365_new):
SELECT 
a.client,
a.date,
a.customer_id, 
a.quantity,
a.revenue,
a.order_count
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_730_plus` b
ON (
	a.client = b.client AND
	a.date = b.date AND
	a.customer_id = b.customer_id
)
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_365_730` c
ON (
	a.client = c.client AND
	a.date = c.date AND
	a.customer_id = c.customer_id
)
WHERE b.customer_id is null 
and c.customer_id is null
2018-04-17 13:59:30,056: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a303240>]}
2018-04-17 13:59:30,077: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fbb3be0>]}
2018-04-17 13:59:30,295: 13:59:30 | 79 of 91 OK created table model agency_data_pipeline.retention_stats_rebuy_rate [CREATE TABLE in 3.36s]
2018-04-17 13:59:30,298: 13:59:30 | 80 of 91 START table model agency_data_pipeline.agg_platforms_client. [RUN]
2018-04-17 13:59:30,301: Compiling model.agency_data_pipeline.agg_platforms_client
2018-04-17 13:59:30,311: Writing injected SQL for node "model.agency_data_pipeline.agg_platforms_client"
2018-04-17 13:59:30,314: Acquiring new bigquery connection "agg_platforms_client".
2018-04-17 13:59:30,314: Re-using an available connection from the pool.
2018-04-17 13:59:30,616: 13:59:30 | 76 of 91 OK created table model agency_data_pipeline.retention_stats_rebuy_rate_month [CREATE TABLE in 3.39s]
2018-04-17 13:59:30,616: 13:59:30 | 81 of 91 START table model agency_data_pipeline.retention_0_365_reactivated [RUN]
2018-04-17 13:59:30,616: Compiling model.agency_data_pipeline.retention_0_365_reactivated
2018-04-17 13:59:30,623: Writing injected SQL for node "model.agency_data_pipeline.retention_0_365_reactivated"
2018-04-17 13:59:30,626: Acquiring new bigquery connection "retention_0_365_reactivated".
2018-04-17 13:59:30,626: Re-using an available connection from the pool.
2018-04-17 13:59:31,026: Model SQL (agg_platforms_client):
SELECT 
date, 
a.account account, 
b.client client,
a.platform platform,
a.channel channel,
url,
utm_campaign,
campaign,
cost,
impressions,
clicks,
transactions ad_platform_transactions
FROM 
  `growth-engines-pipeline`.`agency_data_pipeline`.`agg_platforms_union` a
LEFT JOIN 
  `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc` b
ON ( 
  a.account = b.account AND
  a.platform = b.platform
)
2018-04-17 13:59:31,387: Model SQL (retention_0_365_reactivated):
SELECT 
a.client,
a.date,
a.customer_id, 
a.quantity,
a.revenue
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_730_plus` b
ON (
	a.client = b.client AND
	a.date = b.date AND
	a.customer_id = b.customer_id
)
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_365_730` c
ON (
	a.client = c.client AND
	a.date = c.date AND
	a.customer_id = c.customer_id
)
WHERE b.customer_id is not null 
AND c.customer_id is null
2018-04-17 13:59:33,593: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fb7dac8>]}
2018-04-17 13:59:33,820: 13:59:33 | 81 of 91 OK created table model agency_data_pipeline.retention_0_365_reactivated [CREATE TABLE in 2.98s]
2018-04-17 13:59:33,820: 13:59:33 | 82 of 91 START table model agency_data_pipeline.retention_0_30_new... [RUN]
2018-04-17 13:59:33,820: Compiling model.agency_data_pipeline.retention_0_30_new
2018-04-17 13:59:33,828: Writing injected SQL for node "model.agency_data_pipeline.retention_0_30_new"
2018-04-17 13:59:33,828: Acquiring new bigquery connection "retention_0_30_new".
2018-04-17 13:59:33,829: Re-using an available connection from the pool.
2018-04-17 13:59:34,607: Model SQL (retention_0_30_new):
SELECT 
a.client,
a.date,
a.customer_id, 
a.quantity,
a.revenue,
a.order_count
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_60_plus` b
ON (
	a.client = b.client AND
	a.date = b.date AND
	a.customer_id = b.customer_id
)
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_30_60` c
ON (
	a.client = c.client AND
	a.date = c.date AND
	a.customer_id = c.customer_id
)
WHERE b.customer_id is null 
and c.customer_id is null
2018-04-17 13:59:35,453: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fbb3b70>]}
2018-04-17 13:59:35,702: 13:59:35 | 80 of 91 OK created table model agency_data_pipeline.agg_platforms_client [CREATE TABLE in 5.15s]
2018-04-17 13:59:35,702: 13:59:35 | 83 of 91 START table model agency_data_pipeline.retention_0_30_reactivated [RUN]
2018-04-17 13:59:35,702: Compiling model.agency_data_pipeline.retention_0_30_reactivated
2018-04-17 13:59:35,713: Writing injected SQL for node "model.agency_data_pipeline.retention_0_30_reactivated"
2018-04-17 13:59:35,716: Acquiring new bigquery connection "retention_0_30_reactivated".
2018-04-17 13:59:35,717: Re-using an available connection from the pool.
2018-04-17 13:59:36,722: Model SQL (retention_0_30_reactivated):
SELECT 
a.client,
a.date,
a.customer_id, 
a.quantity,
a.revenue
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_60_plus` b
ON (
	a.client = b.client AND
	a.date = b.date AND
	a.customer_id = b.customer_id
)
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_30_60` c
ON (
	a.client = c.client AND
	a.date = c.date AND
	a.customer_id = c.customer_id
)
WHERE b.customer_id is not null 
AND c.customer_id is null
2018-04-17 13:59:36,829: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fb73e10>]}
2018-04-17 13:59:37,078: 13:59:37 | 77 of 91 OK created table model agency_data_pipeline.retention_0_365_new [CREATE TABLE in 10.13s]
2018-04-17 13:59:39,170: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a303e80>]}
2018-04-17 13:59:39,810: 13:59:39 | 82 of 91 OK created table model agency_data_pipeline.retention_0_30_new [CREATE TABLE in 5.35s]
2018-04-17 13:59:41,177: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fbb3b70>]}
2018-04-17 13:59:41,403: 13:59:41 | 83 of 91 OK created table model agency_data_pipeline.retention_0_30_reactivated [CREATE TABLE in 5.47s]
2018-04-17 13:59:42,375: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fb739e8>]}
2018-04-17 13:59:42,628: 13:59:42 | 78 of 91 OK created table model agency_data_pipeline.segment_stats_customers [CREATE TABLE in 15.68s]
2018-04-17 13:59:42,629: 13:59:42 | 84 of 91 START table model agency_data_pipeline.segment_list_customers [RUN]
2018-04-17 13:59:42,630: Compiling model.agency_data_pipeline.segment_list_customers
2018-04-17 13:59:42,638: Writing injected SQL for node "model.agency_data_pipeline.segment_list_customers"
2018-04-17 13:59:42,641: Acquiring new bigquery connection "segment_list_customers".
2018-04-17 13:59:42,641: Re-using an available connection from the pool.
2018-04-17 13:59:43,746: Model SQL (segment_list_customers):
SELECT
a.client,
period,
date,
customer_id,
b.first_name,
b.last_name,
b.email,
recency_days,
frequency,
revenue,
quantity,
aov,
segment
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`agg_customers_union` b
ON (
	a.client = b.client AND
	a.customer_id = b.id
)
2018-04-17 14:00:19,604: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fb82e48>]}
2018-04-17 14:00:20,413: 14:00:20 | 84 of 91 OK created table model agency_data_pipeline.segment_list_customers [CREATE TABLE in 36.97s]
2018-04-17 14:00:20,414: 14:00:20 | 85 of 91 START table model agency_data_pipeline.growth_customer_0_365_segment [RUN]
2018-04-17 14:00:20,414: Compiling model.agency_data_pipeline.growth_customer_0_365_segment
2018-04-17 14:00:20,426: Writing injected SQL for node "model.agency_data_pipeline.growth_customer_0_365_segment"
2018-04-17 14:00:20,430: Acquiring new bigquery connection "growth_customer_0_365_segment".
2018-04-17 14:00:20,430: Re-using an available connection from the pool.
2018-04-17 14:00:21,587: Model SQL (growth_customer_0_365_segment):
with segment as (

	SELECT 
	a.date,
	unix_date_in_range,
	unix_date_in_range_yoy,
	a.client client,
	a.customer_id customer_id,
	case when b.customer_id is not null then 'New' else 'Existing' end as segment,
	a.orders,
	a.quantity,
	a.revenue,
	a.shipping_revenue
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_customer_0_365` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365_new` b
	ON (
	  a.customer_id = b.customer_id AND
	  a.date  = b.date AND
	  a.client = b.client
	)
),

total as (

	SELECT 
	date,
	unix_date_in_range,
	unix_date_in_range_yoy,
	client,
	customer_id,
	'Total' as segment,
	orders,
	quantity,
	revenue,
	shipping_revenue
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_customer_0_365`

)

SELECT 
date,
unix_date_in_range,
unix_date_in_range_yoy,
client,
segment,
count(distinct(customer_id)) customers,
sum(orders) orders,
sum(quantity) quantity,
sum(revenue) revenue,
sum(shipping_revenue) shipping_revenue
FROM
( 
	SELECT * FROM segment
	UNION ALL
	SELECT * FROM total
) 
GROUP BY date, unix_date_in_range, unix_date_in_range_yoy, client, segment
2018-04-17 14:00:33,038: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d7e6f60>]}
2018-04-17 14:00:33,291: 14:00:33 | 85 of 91 OK created table model agency_data_pipeline.growth_customer_0_365_segment [CREATE TABLE in 12.62s]
2018-04-17 14:00:33,292: 14:00:33 | 86 of 91 START table model agency_data_pipeline.growth_date_union.... [RUN]
2018-04-17 14:00:33,292: Compiling model.agency_data_pipeline.growth_date_union
2018-04-17 14:00:33,303: Writing injected SQL for node "model.agency_data_pipeline.growth_date_union"
2018-04-17 14:00:33,306: Acquiring new bigquery connection "growth_date_union".
2018-04-17 14:00:33,307: Re-using an available connection from the pool.
2018-04-17 14:00:34,452: Model SQL (growth_date_union):
with ty as (

  SELECT 
  date,
  unix_date_in_range, 
  unix_date_in_range_yoy, 
  client, 
  segment,
  customers customers_ty,
  orders orders_ty,
  quantity quantity_ty,
  revenue revenue_ty,
  shipping_revenue shipping_revenue_ty,
  null as customers_ly,
  null as orders_ly,
  null as quantity_ly,
  null as revenue_ly,
  null as shipping_revenue_ly
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_customer_0_365_segment`

),

ly as (

  SELECT 
  date,
  0 as unix_date_in_range, 
  unix_date_in_range unix_date_in_range_yoy, 
  client, 
  segment,
  null as customers_ty,
  null as orders_ty,
  null as quantity_ty,
  null as revenue_ty,
  null as shipping_revenue_ty,
  customers customers_ly,
  orders orders_ly,
  quantity quantity_ly,
  revenue revenue_ly,
  shipping_revenue shipping_revenue_ly
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_customer_0_365_segment`

)


SELECT
max(date) date,
max(unix_date_in_range) unix_date_in_range,
unix_date_in_range_yoy,
client,
segment,
ifnull(sum(customers_ty), 0) customers_ty,
ifnull(sum(orders_ty), 0) orders_ty,
ifnull(sum(quantity_ty), 0) quantity_ty,
ifnull(sum(revenue_ty), 0) revenue_ty,
ifnull(sum(shipping_revenue_ty), 0) shipping_revenue_ty,
case when sum(orders_ty) > 0 then sum(revenue_ty)/sum(orders_ty) else null end as aov_ty,
ifnull(sum(customers_ly), 0) customers_ly,
ifnull(sum(orders_ly), 0) orders_ly,
ifnull(sum(quantity_ly), 0) quantity_ly,
ifnull(sum(revenue_ly), 0) revenue_ly,
ifnull(sum(shipping_revenue_ly), 0) shipping_revenue_ly,
case when sum(orders_ly) > 0 then sum(revenue_ly)/sum(orders_ly) else null end as aov_ly,
case when sum(orders_ly) > 0 then ( sum(orders_ty) - sum(orders_ly) ) / sum(orders_ly) else null end as order_growth,
case when sum(revenue_ly) > 0 then ( sum(revenue_ty) - sum(revenue_ly) ) / sum(revenue_ly) else null end as revenue_growth,
case when sum(customers_ly) > 0 then ( sum(customers_ty) - sum(customers_ly) ) / sum(customers_ly) else null end as customer_growth,
case when sum(orders_ly) > 0 then ( sum(revenue_ty)/sum(orders_ty) - sum(revenue_ly)/sum(orders_ly) ) / ( sum(revenue_ly)/sum(orders_ly) ) else null end as aov_growth
FROM (

  SELECT * FROM ty
  UNION ALL
  SELECT * FROM ly

)
where unix_date_in_range is not null
group by unix_date_in_range_yoy, client, segment
2018-04-17 14:00:35,562: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fb7dac8>]}
2018-04-17 14:00:35,933: 14:00:35 | 86 of 91 OK created table model agency_data_pipeline.growth_date_union [CREATE TABLE in 2.27s]
2018-04-17 14:00:35,934: 14:00:35 | 87 of 91 START table model agency_data_pipeline.retention_stats_month [RUN]
2018-04-17 14:00:35,934: 14:00:35 | 88 of 91 START table model agency_data_pipeline.growth_stats......... [RUN]
2018-04-17 14:00:35,934: Compiling model.agency_data_pipeline.retention_stats_month
2018-04-17 14:00:35,935: 14:00:35 | 89 of 91 START table model agency_data_pipeline.retention_stats...... [RUN]
2018-04-17 14:00:35,935: Compiling model.agency_data_pipeline.growth_stats
2018-04-17 14:00:35,942: Compiling model.agency_data_pipeline.retention_stats
2018-04-17 14:00:35,960: Writing injected SQL for node "model.agency_data_pipeline.retention_stats_month"
2018-04-17 14:00:35,964: Writing injected SQL for node "model.agency_data_pipeline.growth_stats"
2018-04-17 14:00:35,974: Writing injected SQL for node "model.agency_data_pipeline.retention_stats"
2018-04-17 14:00:35,977: Acquiring new bigquery connection "retention_stats_month".
2018-04-17 14:00:35,978: Acquiring new bigquery connection "growth_stats".
2018-04-17 14:00:35,978: Re-using an available connection from the pool.
2018-04-17 14:00:35,979: Acquiring new bigquery connection "retention_stats".
2018-04-17 14:00:35,980: Re-using an available connection from the pool.
2018-04-17 14:00:35,982: Re-using an available connection from the pool.
2018-04-17 14:00:36,875: Model SQL (growth_stats):
with orders as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'Orders' as metric,
  orders_ty as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`
),

order_growth as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'Order Growth' as metric,
  order_growth as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`
),

revenue as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'Revenue' as metric,
  revenue_ty as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`
),

revenue_growth as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'Revenue Growth' as metric,
  revenue_growth as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`
),

customers as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'Customers' as metric,
  customers_ty as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`
),

customer_growth as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'Customer Growth' as metric,
  customer_growth as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`

),

aov as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'AOV' as metric,
  aov_ty as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`

),

aov_growth as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'AOV Growth' as metric,
  aov_growth as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`

)

SELECT * FROM orders
UNION ALL 
SELECT * FROM order_growth
UNION ALL
SELECT * FROM revenue
UNION ALL 
SELECT * FROM revenue_growth
UNION ALL
SELECT * FROM customers
UNION ALL 
SELECT * FROM customer_growth
UNION ALL
SELECT * FROM aov
UNION ALL 
SELECT * FROM aov_growth
2018-04-17 14:00:36,942: Model SQL (retention_stats):
WITH last_year_buyers AS (
	SELECT 
	date,
	client,
	'Last year buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_365_730`
	group by date, client
),

rebuy_rate AS (
	SELECT 
	date,
	client,
	'Rebuy rate' as metric,
	customer_retention value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_stats_rebuy_rate`
),

repeat_buyers AS (
	SELECT 
	date,
	client,
	'Repeat buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365_rebuy`
	group by date, client
),

reactivated_buyers AS (
	SELECT 
	date,
	client,
	'Reactivated buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365_reactivated`
	group by date, client
),

new_buyers AS (
	SELECT 
	date,
	client,
	'New buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365_new`
	group by date, client
),

this_year_buyers AS (
	SELECT 
	date,
	client,
	'This year buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365`
	group by date, client
),

this_year_revenue AS (
	SELECT 
	date,
	client,
	'This year revenue' as metric,
	sum(revenue) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365`
	group by date, client
),

this_year_aov AS (
	SELECT 
	date,
	client,
	'This year AOV' as metric,
	case when sum(order_count) > 0 then sum(revenue)/sum(order_count) else 0 end as value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365`
	group by date, client
),

this_year_frequency AS (
	SELECT 
	date,
	client,
	'This year frequency' as metric,
	case when count(distinct customer_id) > 0 then sum(order_count)/count(distinct customer_id) else 0 end as value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365`
	group by date, client
)

SELECT 
date,
client,
metric,
ifnull(value, 0) value
FROM
(
	SELECT
	date,
	client,
	metric,
	value
	FROM last_year_buyers

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM rebuy_rate

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM repeat_buyers

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM reactivated_buyers	

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM new_buyers	

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_year_buyers	

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_year_revenue

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_year_aov

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_year_frequency

	UNION ALL

	SELECT
	a.date,
	a.client,
	'Dormant buyers' as metric,
	a.value - ifnull(b.value, 0) as value
	FROM last_year_buyers a
	LEFT JOIN repeat_buyers b
	ON ( a.date = b.date AND
		a.client = b.client )							

)
2018-04-17 14:00:37,024: Model SQL (retention_stats_month):
WITH last_month_buyers AS (
	SELECT 
	date,
	client,
	'Last month buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_30_60`
	group by date, client
),

rebuy_rate AS (
	SELECT 
	date,
	client,
	'Rebuy rate' as metric,
	customer_retention value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_stats_rebuy_rate_month`
),

repeat_buyers AS (
	SELECT 
	date,
	client,
	'Repeat buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30_rebuy`
	group by date, client
),

reactivated_buyers AS (
	SELECT 
	date,
	client,
	'Reactivated buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30_reactivated`
	group by date, client
),

new_buyers AS (
	SELECT 
	date,
	client,
	'New buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30_new`
	group by date, client
),

this_month_buyers AS (
	SELECT 
	date,
	client,
	'This month buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30`
	group by date, client
),

this_month_revenue AS (
	SELECT 
	date,
	client,
	'This month revenue' as metric,
	sum(revenue) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30`
	group by date, client
),

this_month_aov AS (
	SELECT 
	date,
	client,
	'This month AOV' as metric,
	case when sum(order_count) > 0 then sum(revenue)/sum(order_count) else 0 end as value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30`
	group by date, client
),

this_month_frequency AS (
	SELECT 
	date,
	client,
	'This month frequency' as metric,
	case when count(distinct customer_id) > 0 then sum(order_count)/count(distinct customer_id) else 0 end as value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30`
	group by date, client
)

SELECT 
date,
client,
metric,
ifnull(value, 0) value
FROM
(
	SELECT
	date,
	client,
	metric,
	value
	FROM last_month_buyers

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM rebuy_rate

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM repeat_buyers

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM reactivated_buyers	

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM new_buyers	

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_month_buyers	

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_month_revenue

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_month_aov

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_month_frequency

	UNION ALL

	SELECT
	a.date,
	a.client,
	'Dormant buyers' as metric,
	a.value - ifnull(b.value, 0) as value
	FROM last_month_buyers a
	LEFT JOIN repeat_buyers b
	ON ( a.date = b.date AND
		a.client = b.client )							

)
2018-04-17 14:00:37,992: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fc073c8>]}
2018-04-17 14:00:38,471: 14:00:38 | 88 of 91 OK created table model agency_data_pipeline.growth_stats.... [CREATE TABLE in 2.06s]
2018-04-17 14:00:40,463: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d7e6f60>]}
2018-04-17 14:00:40,705: 14:00:40 | 87 of 91 OK created table model agency_data_pipeline.retention_stats_month [CREATE TABLE in 4.53s]
2018-04-17 14:00:43,599: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fbdde48>]}
2018-04-17 14:00:43,968: 14:00:43 | 89 of 91 OK created table model agency_data_pipeline.retention_stats. [CREATE TABLE in 7.66s]
2018-04-17 14:00:43,969: 14:00:43 | 90 of 91 START table model agency_data_pipeline.agg_campaign......... [RUN]
2018-04-17 14:00:43,969: Compiling model.agency_data_pipeline.agg_campaign
2018-04-17 14:00:43,981: Writing injected SQL for node "model.agency_data_pipeline.agg_campaign"
2018-04-17 14:00:43,985: Acquiring new bigquery connection "agg_campaign".
2018-04-17 14:00:43,985: Re-using an available connection from the pool.
2018-04-17 14:00:45,139: Model SQL (agg_campaign):
with ga as (

	select 
		date, client, attribution, channel, platform, url, campaign as utm_campaign, '' as campaign,
    	customers_new,
    	transactions_new,
    	revenue_new,
    	first_order_revenue_new,
    	lifetime_revenue_new,
    	customers_total,
    	transactions_total,
    	revenue_total,
		null as cost, null as impressions, null as clicks, null as ad_platform_transactions
	from `growth-engines-pipeline`.`agency_data_pipeline`.`agg_ga_campaign_by_type`

),

platforms_last_touch as (

	select 
		date, client, 'Last-touch' as attribution, channel, platform, url, utm_campaign, campaign,
		null as customers_new,
    	null as transactions_new,
    	null as revenue_new,
    	null as first_order_revenue_new,
    	null as lifetime_revenue_new,
    	null as customers_total,
    	null as transactions_total,
    	null as revenue_total,
		cost, impressions, clicks, ad_platform_transactions
	from `growth-engines-pipeline`.`agency_data_pipeline`.`agg_platforms_client`

),

platforms_first_touch as (

    select 
        date, client, 'First-touch' as attribution, channel, platform, url, utm_campaign, campaign,
        null as customers_new,
        null as transactions_new,
        null as revenue_new,
        null as first_order_revenue_new,
        null as lifetime_revenue_new,
        null as customers_total,
        null as transactions_total,
        null as revenue_total,
        cost, impressions, clicks, ad_platform_transactions
    from `growth-engines-pipeline`.`agency_data_pipeline`.`agg_platforms_client`

)


SELECT
    date, 
    client,
    attribution,
    platform,
    channel, 
    url,
    utm_campaign,
    max(campaign) campaign,
    ifnull( sum(cost), 0) cost,
	ifnull( sum(impressions), 0) impressions,
	ifnull( sum(clicks), 0) clicks,
	ifnull( sum(ad_platform_transactions), 0) ad_platform_transactions,
	ifnull( sum(customers_new), 0) customers_new,
	ifnull( sum(transactions_new), 0) transactions_new,
	ifnull( sum(revenue_new), 0) revenue_new,
	ifnull( sum(first_order_revenue_new), 0) first_order_revenue_new,
	ifnull( sum(lifetime_revenue_new), 0) lifetime_revenue_new,
	ifnull( sum(customers_total), 0) customers_total,
	ifnull( sum(transactions_total), 0) transactions_total,
	ifnull( sum(revenue_total), 0) revenue_total	
FROM 
(
    SELECT *
    FROM 
      ga
    UNION ALL
    SELECT *
    FROM 
      platforms_first_touch
    UNION ALL
    SELECT *
    FROM 
      platforms_last_touch      
) 
GROUP BY
    date, client, attribution, platform, channel, url, utm_campaign
2018-04-17 14:00:54,037: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fb7dac8>]}
2018-04-17 14:00:54,282: 14:00:54 | 90 of 91 OK created table model agency_data_pipeline.agg_campaign.... [CREATE TABLE in 10.07s]
2018-04-17 14:00:54,283: 14:00:54 | 91 of 91 START table model agency_data_pipeline.agg_platform_monthly. [RUN]
2018-04-17 14:00:54,283: Compiling model.agency_data_pipeline.agg_platform_monthly
2018-04-17 14:00:54,290: Writing injected SQL for node "model.agency_data_pipeline.agg_platform_monthly"
2018-04-17 14:00:54,291: Acquiring new bigquery connection "agg_platform_monthly".
2018-04-17 14:00:54,291: Re-using an available connection from the pool.
2018-04-17 14:00:55,231: Model SQL (agg_platform_monthly):
SELECT
    FORMAT_DATE("%Y-%m", date) AS yyyymm,
    client,
    attribution,
    platform,
    channel, 
    sum(cost) cost,
	sum(clicks) clicks,
	sum(customers_new) customers_new,
	sum(first_order_revenue_new) first_order_revenue_new,
	sum(lifetime_revenue_new) lifetime_revenue_new,
	sum(transactions_new) transactions_new,
	sum(revenue_new) revenue_new,
    sum(customers_total) customers_total,
    sum(transactions_total) transactions_total,
    sum(revenue_total) revenue_total
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_campaign`
GROUP BY
    yyyymm, client, attribution, platform, channel
2018-04-17 14:00:57,563: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'eef60707-caea-47bd-ab45-73b52cd0f3de', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fbb3550>]}
2018-04-17 14:00:57,819: 14:00:57 | 91 of 91 OK created table model agency_data_pipeline.agg_platform_monthly [CREATE TABLE in 3.28s]
2018-04-17 14:00:57,867: 14:00:57 | 
2018-04-17 14:00:57,867: 14:00:57 | Finished running 91 table models in 424.89s.
2018-04-17 14:00:57,867: Connection 'master' was left open.
2018-04-17 14:00:57,868: 
2018-04-17 14:00:57,868: Completed with 1 errors:
2018-04-17 14:00:57,869: 
2018-04-17 14:00:57,869: Database Error in model frequency_proc (models/segmentation/frequency/frequency_proc.sql)
2018-04-17 14:00:57,869:   Unrecognized name: order_date at [7:9]
2018-04-17 14:00:57,869:   compiled SQL at target/compiled/agency_data_pipeline/segmentation/frequency/frequency_proc.sql
2018-04-17 14:00:57,869: 
Done. PASS=89 ERROR=1 SKIP=1 TOTAL=91
2018-04-17 14:00:57,870: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d65f9e8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d65fc18>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d593588>]}
2018-04-17 14:00:58,465: Flushing usage events
2018-04-17 14:03:01,860: Tracking: tracking
2018-04-17 14:03:01,862: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113aabd68>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113aabe80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113aab940>]}
2018-04-17 14:03:02,615: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-04-17 14:03:02,640: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/growth-engines/dbt_modules
2018-04-17 14:03:02,646: Parsing get_column_values.sql
2018-04-17 14:03:02,671: Parsing get_url_parameter.sql
2018-04-17 14:03:02,680: Parsing split_part.sql
2018-04-17 14:03:02,691: Parsing table_exists.sql
2018-04-17 14:03:02,702: Parsing core.sql
2018-04-17 14:03:02,716: Parsing adapters/bigquery.sql
2018-04-17 14:03:02,728: Parsing adapters/common.sql
2018-04-17 14:03:02,745: Parsing adapters/postgres.sql
2018-04-17 14:03:02,751: Parsing adapters/redshift.sql
2018-04-17 14:03:02,778: Parsing etc/get_custom_schema.sql
2018-04-17 14:03:02,787: Parsing materializations/archive.sql
2018-04-17 14:03:02,829: Parsing materializations/bigquery.sql
2018-04-17 14:03:02,847: Parsing materializations/helpers.sql
2018-04-17 14:03:02,872: Parsing materializations/incremental.sql
2018-04-17 14:03:02,902: Parsing materializations/table.sql
2018-04-17 14:03:02,929: Parsing materializations/view.sql
2018-04-17 14:03:02,946: Parsing materializations/wrapper.sql
2018-04-17 14:03:02,951: Parsing schema_tests/accepted_values.sql
2018-04-17 14:03:02,958: Parsing schema_tests/not_null.sql
2018-04-17 14:03:02,962: Parsing schema_tests/relationships.sql
2018-04-17 14:03:02,969: Parsing schema_tests/unique.sql
2018-04-17 14:03:03,040: Parsing model.agency_data_pipeline.accounts_proc
2018-04-17 14:03:03,043: Parsing model.agency_data_pipeline.all_dates
2018-04-17 14:03:03,045: Parsing model.agency_data_pipeline.carts_proc
2018-04-17 14:03:03,047: Parsing model.agency_data_pipeline.clients_proc
2018-04-17 14:03:03,050: Parsing model.agency_data_pipeline.conversion_goals_proc
2018-04-17 14:03:03,052: Parsing model.agency_data_pipeline.mappings_ga_proc
2018-04-17 14:03:03,054: Acquiring new bigquery connection "master".
2018-04-17 14:03:03,054: Opening a new connection (0 currently allocated)
2018-04-17 14:03:03,060: Parsing model.agency_data_pipeline.monthend_dates
2018-04-17 14:03:03,064: Parsing model.agency_data_pipeline.adwords_ads
2018-04-17 14:03:03,067: Parsing model.agency_data_pipeline.adwords_campaigns
2018-04-17 14:03:03,069: Parsing model.agency_data_pipeline.adwords_conversions
2018-04-17 14:03:03,071: Parsing model.agency_data_pipeline.adwords_impression_share
2018-04-17 14:03:03,072: Parsing model.agency_data_pipeline.adwords_join
2018-04-17 14:03:03,075: Parsing model.agency_data_pipeline.adwords_stats
2018-04-17 14:03:03,077: Parsing model.agency_data_pipeline.adwords_urls
2018-04-17 14:03:03,078: Parsing model.agency_data_pipeline.bing_ads_ads
2018-04-17 14:03:03,081: Parsing model.agency_data_pipeline.bing_ads_conversions
2018-04-17 14:03:03,083: Parsing model.agency_data_pipeline.bing_ads_impression_share
2018-04-17 14:03:03,086: Parsing model.agency_data_pipeline.bing_ads_stats
2018-04-17 14:03:03,090: Parsing model.agency_data_pipeline.fb_adcreative
2018-04-17 14:03:03,099: Parsing model.agency_data_pipeline.fb_ads
2018-04-17 14:03:03,105: Parsing model.agency_data_pipeline.fb_ads_insights
2018-04-17 14:03:03,110: Parsing model.agency_data_pipeline.fb_ads_insights_conversions
2018-04-17 14:03:03,116: Parsing model.agency_data_pipeline.fb_ads_stats
2018-04-17 14:03:03,118: Parsing model.agency_data_pipeline.ga_conversions
2018-04-17 14:03:03,120: Parsing model.agency_data_pipeline.ga_traffic
2018-04-17 14:03:03,132: Parsing model.agency_data_pipeline.ga_transactions
2018-04-17 14:03:03,141: Parsing model.agency_data_pipeline.ga_mcf_proc
2018-04-17 14:03:03,143: Parsing model.agency_data_pipeline.ga_mcf_stats
2018-04-17 14:03:03,146: Parsing model.agency_data_pipeline.shopify_customers_proc
2018-04-17 14:03:03,152: Parsing model.agency_data_pipeline.shopify_orders_proc
2018-04-17 14:03:03,159: Parsing model.agency_data_pipeline.shopify_products_proc
2018-04-17 14:03:03,166: Parsing model.agency_data_pipeline.shopify_refunds_proc
2018-04-17 14:03:03,171: Parsing model.agency_data_pipeline.agg_campaign
2018-04-17 14:03:03,174: Parsing model.agency_data_pipeline.agg_customers_union
2018-04-17 14:03:03,176: Parsing model.agency_data_pipeline.agg_ga_campaign
2018-04-17 14:03:03,179: Parsing model.agency_data_pipeline.agg_ga_campaign_by_type
2018-04-17 14:03:03,181: Parsing model.agency_data_pipeline.agg_ga_transaction
2018-04-17 14:03:03,184: Parsing model.agency_data_pipeline.agg_ga_transaction_order_number
2018-04-17 14:03:03,186: Parsing model.agency_data_pipeline.agg_orders_union
2018-04-17 14:03:03,188: Parsing model.agency_data_pipeline.agg_platform_monthly
2018-04-17 14:03:03,190: Parsing model.agency_data_pipeline.agg_platforms_client
2018-04-17 14:03:03,192: Parsing model.agency_data_pipeline.agg_platforms_union
2018-04-17 14:03:03,195: Parsing model.agency_data_pipeline.agg_products
2018-04-17 14:03:03,196: Parsing model.agency_data_pipeline.agg_transaction
2018-04-17 14:03:03,199: Parsing model.agency_data_pipeline.agg_transaction_daily
2018-04-17 14:03:03,200: Parsing model.agency_data_pipeline.agg_transaction_line_item
2018-04-17 14:03:03,202: Parsing model.agency_data_pipeline.agg_transaction_line_item_type
2018-04-17 14:03:03,204: Parsing model.agency_data_pipeline.agg_transaction_order_number
2018-04-17 14:03:03,205: Parsing model.agency_data_pipeline.agg_transaction_product_type
2018-04-17 14:03:03,207: Parsing model.agency_data_pipeline.customers_by_transaction
2018-04-17 14:03:03,209: Parsing model.agency_data_pipeline.growth_customer_0_365
2018-04-17 14:03:03,211: Parsing model.agency_data_pipeline.growth_customer_0_365_segment
2018-04-17 14:03:03,214: Parsing model.agency_data_pipeline.growth_date_union
2018-04-17 14:03:03,217: Parsing model.agency_data_pipeline.growth_stats
2018-04-17 14:03:03,223: Parsing model.agency_data_pipeline.retention_0_365
2018-04-17 14:03:03,225: Parsing model.agency_data_pipeline.retention_0_365_new
2018-04-17 14:03:03,227: Parsing model.agency_data_pipeline.retention_0_365_reactivated
2018-04-17 14:03:03,230: Parsing model.agency_data_pipeline.retention_0_365_rebuy
2018-04-17 14:03:03,232: Parsing model.agency_data_pipeline.retention_365_730
2018-04-17 14:03:03,234: Parsing model.agency_data_pipeline.retention_730_plus
2018-04-17 14:03:03,236: Parsing model.agency_data_pipeline.retention_stats
2018-04-17 14:03:03,241: Parsing model.agency_data_pipeline.retention_stats_rebuy_rate
2018-04-17 14:03:03,244: Parsing model.agency_data_pipeline.retention_0_30
2018-04-17 14:03:03,246: Parsing model.agency_data_pipeline.retention_0_30_new
2018-04-17 14:03:03,248: Parsing model.agency_data_pipeline.retention_0_30_reactivated
2018-04-17 14:03:03,252: Parsing model.agency_data_pipeline.retention_0_30_rebuy
2018-04-17 14:03:03,256: Parsing model.agency_data_pipeline.retention_30_60
2018-04-17 14:03:03,260: Parsing model.agency_data_pipeline.retention_60_plus
2018-04-17 14:03:03,263: Parsing model.agency_data_pipeline.retention_stats_month
2018-04-17 14:03:03,268: Parsing model.agency_data_pipeline.retention_stats_rebuy_rate_month
2018-04-17 14:03:03,270: Parsing model.agency_data_pipeline.customers_first_purchase_proc
2018-04-17 14:03:03,272: Parsing model.agency_data_pipeline.customers_proc
2018-04-17 14:03:03,275: Parsing model.agency_data_pipeline.segment_list_customers
2018-04-17 14:03:03,277: Parsing model.agency_data_pipeline.segment_proc_customers
2018-04-17 14:03:03,279: Parsing model.agency_data_pipeline.segment_stats_customers
2018-04-17 14:03:03,281: Parsing model.agency_data_pipeline.segment_stats_customers_agg
2018-04-17 14:03:03,284: Parsing model.agency_data_pipeline.customers_first_purchase_product_type_proc
2018-04-17 14:03:03,285: Parsing model.agency_data_pipeline.customers_products_proc
2018-04-17 14:03:03,288: Parsing model.agency_data_pipeline.segment_list_customers_products
2018-04-17 14:03:03,290: Parsing model.agency_data_pipeline.segment_proc_customers_products
2018-04-17 14:03:03,292: Parsing model.agency_data_pipeline.segment_stats_customers_products
2018-04-17 14:03:03,295: Parsing model.agency_data_pipeline.segment_stats_customers_products_agg
2018-04-17 14:03:03,298: Parsing model.agency_data_pipeline.frequency_proc
2018-04-17 14:03:03,302: Parsing model.agency_data_pipeline.frequency_stats
2018-04-17 14:03:03,305: Parsing model.agency_data_pipeline.order_paths_agg
2018-04-17 14:03:03,309: Parsing model.agency_data_pipeline.order_paths_proc
2018-04-17 14:03:03,312: Parsing model.agency_data_pipeline.order_paths_stats
2018-04-17 14:03:03,315: Parsing model.agency_data_pipeline.products_proc
2018-04-17 14:03:03,317: Parsing model.agency_data_pipeline.segment_proc_sku
2018-04-17 14:03:03,319: Parsing model.agency_data_pipeline.segment_stats_category
2018-04-17 14:03:03,321: Parsing model.agency_data_pipeline.segment_stats_sku
2018-04-17 14:03:03,356: Found 91 models, 0 tests, 0 archives, 0 analyses, 46 macros, 0 operations
2018-04-17 14:03:03,420: 
2018-04-17 14:03:04,840: 14:03:04 | Concurrency: 4 threads (target='prod')
2018-04-17 14:03:04,841: 14:03:04 | 
2018-04-17 14:03:05,527: 14:03:05 | 1 of 91 START table model agency_data_pipeline.bing_ads_ads.......... [RUN]
2018-04-17 14:03:05,528: Compiling model.agency_data_pipeline.bing_ads_ads
2018-04-17 14:03:05,533: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_ads"
2018-04-17 14:03:05,534: 14:03:05 | 2 of 91 START table model agency_data_pipeline.conversion_goals_proc. [RUN]
2018-04-17 14:03:05,534: Compiling model.agency_data_pipeline.conversion_goals_proc
2018-04-17 14:03:05,539: Writing injected SQL for node "model.agency_data_pipeline.conversion_goals_proc"
2018-04-17 14:03:05,534: 14:03:05 | 3 of 91 START table model agency_data_pipeline.adwords_conversions... [RUN]
2018-04-17 14:03:05,539: Compiling model.agency_data_pipeline.adwords_conversions
2018-04-17 14:03:05,545: Writing injected SQL for node "model.agency_data_pipeline.adwords_conversions"
2018-04-17 14:03:05,534: 14:03:05 | 4 of 91 START table model agency_data_pipeline.carts_proc............ [RUN]
2018-04-17 14:03:05,546: Compiling model.agency_data_pipeline.carts_proc
2018-04-17 14:03:05,550: Writing injected SQL for node "model.agency_data_pipeline.carts_proc"
2018-04-17 14:03:05,564: Acquiring new bigquery connection "conversion_goals_proc".
2018-04-17 14:03:05,567: Opening a new connection (1 currently allocated)
2018-04-17 14:03:05,566: Acquiring new bigquery connection "adwords_conversions".
2018-04-17 14:03:05,572: Acquiring new bigquery connection "bing_ads_ads".
2018-04-17 14:03:05,573: Opening a new connection (2 currently allocated)
2018-04-17 14:03:05,575: Acquiring new bigquery connection "carts_proc".
2018-04-17 14:03:05,577: Opening a new connection (3 currently allocated)
2018-04-17 14:03:05,638: Opening a new connection (4 currently allocated)
2018-04-17 14:03:07,347: Model SQL (conversion_goals_proc):
select 
client,
platform,
goal_name,
max(goal_type) goal_type,
account,
max(time_of_entry) time_of_entry
from  ( 

SELECT  
client,
platform,
trim(replace(replace(lower(goal_name),',',''),' ','')) goal_name,
goal_type,
account,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY platform ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.conversion_goals` 

) 

WHERE lv = time_of_entry
group by client, platform, account, goal_name
2018-04-17 14:03:07,355: Model SQL (bing_ads_ads):
select
date, 
account, 
channel,
platform,
campaignid,
campaignname,
max(lower(trim(replace(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$','' ),'.html',''),'/'))) as url,
utm_campaign,
sum(cost) as cost,
sum(impressions) as impressions,
sum(clicks) as clicks,
sum(conversions) as conversions
from 
  ( 
SELECT  
cast(gregoriandate as date) date,
replace(accountname,',','') account,
'Paid' as channel,
'Bing Ads' as platform,
adid,
adtype,
campaignid, 
campaignname,
finalurl url,
case when regexp_contains(destinationurl, 'utm_campaign')
	then replace(lower(nullif(
  

    split(
        
  

    split(
        destinationurl,
        'utm_campaign='
        )[offset(1)]


,
        '&'
        )[offset(0)]


,'')),'+',' ') 
	else null end as utm_campaign,
spend cost, 
impressions, 
clicks, 
conversions,
_sdc_sequence,
first_value(_sdc_sequence) OVER (PARTITION BY adid, gregoriandate ORDER BY _sdc_sequence DESC) lv
FROM `growth-engines-pipeline.bing_ads.ad_performance_report` 
  )

where lv = _sdc_sequence
group by date, account, channel, platform, campaignid, campaignname, utm_campaign
2018-04-17 14:03:07,355: Model SQL (carts_proc):
select 
client,
client_name,
account,
platform
from  ( 

SELECT  
client,
client_name,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.accounts`
WHERE platform in ('Shopify', 'Custom cart')

) 

WHERE lv = time_of_entry
2018-04-17 14:03:07,389: Model SQL (adwords_conversions):
select 
client,
client_name,
platform,
goal_name,
goal_type,
account,
time_of_entry
from  ( 

SELECT  
client,
client_name,
platform,
trim(lower(goal_name)) goal_name,
goal_type,
account,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform, goal_name ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.conversion_goals` 
WHERE platform = 'Adwords'

) 

WHERE lv = time_of_entry
2018-04-17 14:03:08,489: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa21f131-c2f5-4687-bbac-c028fcb4cf0a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113c60b00>]}
2018-04-17 14:03:08,545: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa21f131-c2f5-4687-bbac-c028fcb4cf0a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113cb5908>]}
2018-04-17 14:03:08,913: 14:03:08 | 4 of 91 OK created table model agency_data_pipeline.carts_proc....... [CREATE TABLE in 2.94s]
2018-04-17 14:03:08,914: 14:03:08 | 5 of 91 START table model agency_data_pipeline.bing_ads_impression_share [RUN]
2018-04-17 14:03:08,916: Compiling model.agency_data_pipeline.bing_ads_impression_share
2018-04-17 14:03:08,928: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_impression_share"
2018-04-17 14:03:08,932: Acquiring new bigquery connection "bing_ads_impression_share".
2018-04-17 14:03:08,933: Re-using an available connection from the pool.
2018-04-17 14:03:09,239: 14:03:09 | 2 of 91 OK created table model agency_data_pipeline.conversion_goals_proc [CREATE TABLE in 3.01s]
2018-04-17 14:03:09,241: 14:03:09 | 6 of 91 START table model agency_data_pipeline.adwords_campaigns..... [RUN]
2018-04-17 14:03:09,242: Compiling model.agency_data_pipeline.adwords_campaigns
2018-04-17 14:03:09,247: Writing injected SQL for node "model.agency_data_pipeline.adwords_campaigns"
2018-04-17 14:03:09,248: Acquiring new bigquery connection "adwords_campaigns".
2018-04-17 14:03:09,248: Re-using an available connection from the pool.
2018-04-17 14:03:09,823: Model SQL (bing_ads_impression_share):
SELECT 
date, 
account,
channel,
platform,
sum(impressions) impressions,
sum(available_impressions) available_impressions
FROM

(

SELECT  
cast(gregoriandate as date) date,
replace(accountname,',','') account,  
'Paid' as channel,
'Bing Ads' as platform,
case when impressionsharepercent is null then 0 else impressions end as impressions,
cast(round(case when ( impressionsharepercent is not null and impressionsharepercent > 0 ) then (impressions*100)/impressionsharepercent else 0 end) as int64) as available_impressions,
_sdc_sequence,
first_value(_sdc_sequence) OVER (PARTITION BY campaignid, gregoriandate ORDER BY _sdc_sequence DESC) lv
FROM `growth-engines-pipeline.bing_ads.campaign_performance_report` 

)

where lv = _sdc_sequence
group by date, account, channel, platform
2018-04-17 14:03:10,139: Model SQL (adwords_campaigns):
select
day,
campaignid, 
campaign,
account, 
channel,
platform,
sum(cost) cost,
sum(impressions) impressions,
sum(clicks) clicks,
sum(impression_share_num) impression_share_num,
sum(impression_share_den) impression_share_den
from 
  ( 
	SELECT  
	day,
	campaignid,
	campaign,
	account as account,
	'Paid' as channel,
	'Adwords' as platform,
	cost/1000000 cost, 
	impressions as impressions, 
	clicks, 
	case when searchimprshare is not null then impressions end as impression_share_num,
	case when searchimprshare is not null then impressions/(searchimprshare/100) end as impression_share_den,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY campaignid, day ORDER BY _sdc_sequence DESC) lv
	FROM `growth-engines-pipeline.adwords_2.CAMPAIGN_PERFORMANCE_REPORT`
  )
where lv = _sdc_sequence
group by day, campaignid, account, channel, platform, campaign
2018-04-17 14:03:10,752: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa21f131-c2f5-4687-bbac-c028fcb4cf0a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113c60c50>]}
2018-04-17 14:03:10,964: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa21f131-c2f5-4687-bbac-c028fcb4cf0a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113c60b00>]}
2018-04-17 14:03:11,129: 14:03:11 | 1 of 91 OK created table model agency_data_pipeline.bing_ads_ads..... [CREATE TABLE in 5.22s]
2018-04-17 14:03:11,131: 14:03:11 | 7 of 91 START table model agency_data_pipeline.adwords_urls.......... [RUN]
2018-04-17 14:03:11,131: Compiling model.agency_data_pipeline.adwords_urls
2018-04-17 14:03:11,141: Writing injected SQL for node "model.agency_data_pipeline.adwords_urls"
2018-04-17 14:03:11,148: Acquiring new bigquery connection "adwords_urls".
2018-04-17 14:03:11,150: Re-using an available connection from the pool.
2018-04-17 14:03:11,445: 14:03:11 | 5 of 91 OK created table model agency_data_pipeline.bing_ads_impression_share [CREATE TABLE in 2.05s]
2018-04-17 14:03:11,446: 14:03:11 | 8 of 91 START table model agency_data_pipeline.clients_proc.......... [RUN]
2018-04-17 14:03:11,446: Compiling model.agency_data_pipeline.clients_proc
2018-04-17 14:03:11,450: Writing injected SQL for node "model.agency_data_pipeline.clients_proc"
2018-04-17 14:03:11,451: Acquiring new bigquery connection "clients_proc".
2018-04-17 14:03:11,451: Re-using an available connection from the pool.
2018-04-17 14:03:12,220: Model SQL (clients_proc):
select 
client,
client_name,
account,
platform
from  ( 

SELECT  
client,
client_name,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.accounts`
where client_name != ''
) 

WHERE lv = time_of_entry
2018-04-17 14:03:12,224: Model SQL (adwords_urls):
SELECT
campaignid,
lower(trim(regexp_replace(replace(replace(replace(replace(finalurl,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url

FROM (

SELECT  
campaignid,
finalurl,
first_value(finalurl) OVER (PARTITION BY campaignid ORDER BY day DESC) lv
FROM `growth-engines-pipeline.adwords_2.FINAL_URL_REPORT`
)

WHERE lv = finalurl
group by campaignid, url
order by campaignid asc
2018-04-17 14:03:13,351: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa21f131-c2f5-4687-bbac-c028fcb4cf0a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113c60b00>]}
2018-04-17 14:03:13,767: 14:03:13 | 8 of 91 OK created table model agency_data_pipeline.clients_proc..... [CREATE TABLE in 1.90s]
2018-04-17 14:03:13,768: 14:03:13 | 9 of 91 START table model agency_data_pipeline.accounts_proc......... [RUN]
2018-04-17 14:03:13,768: Compiling model.agency_data_pipeline.accounts_proc
2018-04-17 14:03:13,775: Writing injected SQL for node "model.agency_data_pipeline.accounts_proc"
2018-04-17 14:03:13,776: Acquiring new bigquery connection "accounts_proc".
2018-04-17 14:03:13,776: Re-using an available connection from the pool.
2018-04-17 14:03:14,465: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa21f131-c2f5-4687-bbac-c028fcb4cf0a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113c60c50>]}
2018-04-17 14:03:14,710: Model SQL (accounts_proc):
select 
client,
account,
platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.accounts` 

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-04-17 14:03:14,824: 14:03:14 | 7 of 91 OK created table model agency_data_pipeline.adwords_urls..... [CREATE TABLE in 3.33s]
2018-04-17 14:03:14,825: 14:03:14 | 10 of 91 START table model agency_data_pipeline.ga_conversions....... [RUN]
2018-04-17 14:03:14,826: Compiling model.agency_data_pipeline.ga_conversions
2018-04-17 14:03:14,834: Writing injected SQL for node "model.agency_data_pipeline.ga_conversions"
2018-04-17 14:03:14,837: Acquiring new bigquery connection "ga_conversions".
2018-04-17 14:03:14,837: Re-using an available connection from the pool.
2018-04-17 14:03:15,612: Model SQL (ga_conversions):
select 
client,
client_name,
platform,
goal_name,
goal_type,
account,
time_of_entry
from  ( 

SELECT  
client,
client_name,
platform,
trim(goal_name) goal_name,
goal_type,
account,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform, goal_name ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.conversion_goals` 
WHERE platform = 'Google Analytics'

) 

WHERE lv = time_of_entry
2018-04-17 14:03:15,747: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa21f131-c2f5-4687-bbac-c028fcb4cf0a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113ca17b8>]}
2018-04-17 14:03:15,843: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa21f131-c2f5-4687-bbac-c028fcb4cf0a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113c60b00>]}
2018-04-17 14:03:16,124: 14:03:16 | 6 of 91 OK created table model agency_data_pipeline.adwords_campaigns [CREATE TABLE in 6.51s]
2018-04-17 14:03:16,126: 14:03:16 | 11 of 91 START table model agency_data_pipeline.monthend_dates....... [RUN]
2018-04-17 14:03:16,128: Compiling model.agency_data_pipeline.monthend_dates
2018-04-17 14:03:16,137: Writing injected SQL for node "model.agency_data_pipeline.monthend_dates"
2018-04-17 14:03:16,138: Acquiring new bigquery connection "monthend_dates".
2018-04-17 14:03:16,138: Re-using an available connection from the pool.
2018-04-17 14:03:16,363: 14:03:16 | 9 of 91 OK created table model agency_data_pipeline.accounts_proc.... [CREATE TABLE in 2.07s]
2018-04-17 14:03:16,363: 14:03:16 | 12 of 91 START table model agency_data_pipeline.all_dates............ [RUN]
2018-04-17 14:03:16,364: Compiling model.agency_data_pipeline.all_dates
2018-04-17 14:03:16,371: Writing injected SQL for node "model.agency_data_pipeline.all_dates"
2018-04-17 14:03:16,372: Acquiring new bigquery connection "all_dates".
2018-04-17 14:03:16,372: Re-using an available connection from the pool.
2018-04-17 14:03:16,752: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa21f131-c2f5-4687-bbac-c028fcb4cf0a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113c60c50>]}
2018-04-17 14:03:16,904: Model SQL (monthend_dates):
SELECT
date_in_range,
date_in_range_bom,
date_in_range_bom_mom,
unix_date_in_range,
unix_date_in_range_bom,
unix_date(date_in_range_bom_mom) unix_date_in_range_bom_mom,
yyyymm,
date_in_range_yoy,
unix_date(date_in_range_yoy) unix_date_in_range_yoy

FROM
(
	SELECT 
	date_in_range,
	date_in_range_bom,
	date_sub(date_in_range_bom, INTERVAL 1 MONTH) date_in_range_bom_mom,
  date_sub(date_in_range, INTERVAL 1 YEAR) date_in_range_yoy,
	unix_date_in_range,
	unix_date(date_in_range_bom) unix_date_in_range_bom,
	yyyymm,
	first_value(date_in_range) over (partition by yyyymm order by date_in_range desc) monthend_date_in_range
	FROM
	( 
		SELECT 
		date_in_range,
		date_trunc( date_in_range, MONTH) date_in_range_bom,
		unix_date(date_in_range) unix_date_in_range,
		format_date("%Y-%m", date_in_range) AS yyyymm
		FROM UNNEST(
		    GENERATE_DATE_ARRAY(DATE('2016-01-31'), CURRENT_DATE(), INTERVAL 1 DAY)
		) AS date_in_range
	)
)
where date_in_range = monthend_date_in_range
2018-04-17 14:03:17,090: Model SQL (all_dates):
SELECT 
date_in_range,
unix_date(date_in_range) unix_date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-04-17 14:03:17,382: 14:03:17 | 10 of 91 OK created table model agency_data_pipeline.ga_conversions.. [CREATE TABLE in 1.93s]
2018-04-17 14:03:18,027: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa21f131-c2f5-4687-bbac-c028fcb4cf0a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113ca17b8>]}
2018-04-17 14:03:18,219: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa21f131-c2f5-4687-bbac-c028fcb4cf0a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113c60b00>]}
2018-04-17 14:03:18,260: 14:03:18 | 11 of 91 OK created table model agency_data_pipeline.monthend_dates.. [CREATE TABLE in 1.90s]
2018-04-17 14:03:18,906: 14:03:18 | 12 of 91 OK created table model agency_data_pipeline.all_dates....... [CREATE TABLE in 1.86s]
2018-04-17 14:08:47,893: 14:08:47 | The bigquery adapter does not support query cancellation. Some queries may still be running!
2018-04-17 14:08:47,897: Connection 'master' was left open.
2018-04-17 14:08:47,897: ctrl-c
2018-04-17 14:08:57,987: Tracking: tracking
2018-04-17 14:08:57,987: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f1a8f60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f1a8e80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f1a8dd8>]}
2018-04-17 14:08:58,789: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-04-17 14:08:58,828: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/growth-engines/dbt_modules
2018-04-17 14:08:58,838: Parsing get_column_values.sql
2018-04-17 14:08:58,870: Parsing get_url_parameter.sql
2018-04-17 14:08:58,883: Parsing split_part.sql
2018-04-17 14:08:58,891: Parsing table_exists.sql
2018-04-17 14:08:58,905: Parsing core.sql
2018-04-17 14:08:58,929: Parsing adapters/bigquery.sql
2018-04-17 14:08:58,942: Parsing adapters/common.sql
2018-04-17 14:08:58,962: Parsing adapters/postgres.sql
2018-04-17 14:08:58,967: Parsing adapters/redshift.sql
2018-04-17 14:08:58,999: Parsing etc/get_custom_schema.sql
2018-04-17 14:08:59,015: Parsing materializations/archive.sql
2018-04-17 14:08:59,058: Parsing materializations/bigquery.sql
2018-04-17 14:08:59,084: Parsing materializations/helpers.sql
2018-04-17 14:08:59,116: Parsing materializations/incremental.sql
2018-04-17 14:08:59,151: Parsing materializations/table.sql
2018-04-17 14:08:59,191: Parsing materializations/view.sql
2018-04-17 14:08:59,214: Parsing materializations/wrapper.sql
2018-04-17 14:08:59,223: Parsing schema_tests/accepted_values.sql
2018-04-17 14:08:59,229: Parsing schema_tests/not_null.sql
2018-04-17 14:08:59,234: Parsing schema_tests/relationships.sql
2018-04-17 14:08:59,237: Parsing schema_tests/unique.sql
2018-04-17 14:08:59,319: Parsing model.agency_data_pipeline.accounts_proc
2018-04-17 14:08:59,323: Parsing model.agency_data_pipeline.all_dates
2018-04-17 14:08:59,326: Parsing model.agency_data_pipeline.carts_proc
2018-04-17 14:08:59,338: Parsing model.agency_data_pipeline.clients_proc
2018-04-17 14:08:59,342: Parsing model.agency_data_pipeline.conversion_goals_proc
2018-04-17 14:08:59,346: Parsing model.agency_data_pipeline.mappings_ga_proc
2018-04-17 14:08:59,349: Acquiring new bigquery connection "master".
2018-04-17 14:08:59,350: Opening a new connection (0 currently allocated)
2018-04-17 14:08:59,357: Parsing model.agency_data_pipeline.monthend_dates
2018-04-17 14:08:59,359: Parsing model.agency_data_pipeline.adwords_ads
2018-04-17 14:08:59,361: Parsing model.agency_data_pipeline.adwords_campaigns
2018-04-17 14:08:59,363: Parsing model.agency_data_pipeline.adwords_conversions
2018-04-17 14:08:59,365: Parsing model.agency_data_pipeline.adwords_impression_share
2018-04-17 14:08:59,367: Parsing model.agency_data_pipeline.adwords_join
2018-04-17 14:08:59,370: Parsing model.agency_data_pipeline.adwords_stats
2018-04-17 14:08:59,372: Parsing model.agency_data_pipeline.adwords_urls
2018-04-17 14:08:59,375: Parsing model.agency_data_pipeline.bing_ads_ads
2018-04-17 14:08:59,379: Parsing model.agency_data_pipeline.bing_ads_conversions
2018-04-17 14:08:59,381: Parsing model.agency_data_pipeline.bing_ads_impression_share
2018-04-17 14:08:59,383: Parsing model.agency_data_pipeline.bing_ads_stats
2018-04-17 14:08:59,387: Parsing model.agency_data_pipeline.fb_adcreative
2018-04-17 14:08:59,394: Parsing model.agency_data_pipeline.fb_ads
2018-04-17 14:08:59,422: Parsing model.agency_data_pipeline.fb_ads_insights
2018-04-17 14:08:59,434: Parsing model.agency_data_pipeline.fb_ads_insights_conversions
2018-04-17 14:08:59,443: Parsing model.agency_data_pipeline.fb_ads_stats
2018-04-17 14:08:59,448: Parsing model.agency_data_pipeline.ga_conversions
2018-04-17 14:08:59,450: Parsing model.agency_data_pipeline.ga_traffic
2018-04-17 14:08:59,480: Parsing model.agency_data_pipeline.ga_transactions
2018-04-17 14:08:59,500: Parsing model.agency_data_pipeline.ga_mcf_proc
2018-04-17 14:08:59,513: Parsing model.agency_data_pipeline.ga_mcf_stats
2018-04-17 14:08:59,522: Parsing model.agency_data_pipeline.shopify_customers_proc
2018-04-17 14:08:59,547: Parsing model.agency_data_pipeline.shopify_orders_proc
2018-04-17 14:08:59,561: Parsing model.agency_data_pipeline.shopify_products_proc
2018-04-17 14:08:59,567: Parsing model.agency_data_pipeline.shopify_refunds_proc
2018-04-17 14:08:59,577: Parsing model.agency_data_pipeline.agg_campaign
2018-04-17 14:08:59,587: Parsing model.agency_data_pipeline.agg_customers_union
2018-04-17 14:08:59,590: Parsing model.agency_data_pipeline.agg_ga_campaign
2018-04-17 14:08:59,619: Parsing model.agency_data_pipeline.agg_ga_campaign_by_type
2018-04-17 14:08:59,628: Parsing model.agency_data_pipeline.agg_ga_transaction
2018-04-17 14:08:59,652: Parsing model.agency_data_pipeline.agg_ga_transaction_order_number
2018-04-17 14:08:59,677: Parsing model.agency_data_pipeline.agg_orders_union
2018-04-17 14:08:59,693: Parsing model.agency_data_pipeline.agg_platform_monthly
2018-04-17 14:08:59,697: Parsing model.agency_data_pipeline.agg_platforms_client
2018-04-17 14:08:59,702: Parsing model.agency_data_pipeline.agg_platforms_union
2018-04-17 14:08:59,710: Parsing model.agency_data_pipeline.agg_products
2018-04-17 14:08:59,713: Parsing model.agency_data_pipeline.agg_transaction
2018-04-17 14:08:59,722: Parsing model.agency_data_pipeline.agg_transaction_daily
2018-04-17 14:08:59,727: Parsing model.agency_data_pipeline.agg_transaction_line_item
2018-04-17 14:08:59,729: Parsing model.agency_data_pipeline.agg_transaction_line_item_type
2018-04-17 14:08:59,732: Parsing model.agency_data_pipeline.agg_transaction_order_number
2018-04-17 14:08:59,735: Parsing model.agency_data_pipeline.agg_transaction_product_type
2018-04-17 14:08:59,738: Parsing model.agency_data_pipeline.customers_by_transaction
2018-04-17 14:08:59,741: Parsing model.agency_data_pipeline.growth_customer_0_365
2018-04-17 14:08:59,743: Parsing model.agency_data_pipeline.growth_customer_0_365_segment
2018-04-17 14:08:59,747: Parsing model.agency_data_pipeline.growth_date_union
2018-04-17 14:08:59,751: Parsing model.agency_data_pipeline.growth_stats
2018-04-17 14:08:59,757: Parsing model.agency_data_pipeline.retention_0_365
2018-04-17 14:08:59,761: Parsing model.agency_data_pipeline.retention_0_365_new
2018-04-17 14:08:59,765: Parsing model.agency_data_pipeline.retention_0_365_reactivated
2018-04-17 14:08:59,769: Parsing model.agency_data_pipeline.retention_0_365_rebuy
2018-04-17 14:08:59,772: Parsing model.agency_data_pipeline.retention_365_730
2018-04-17 14:08:59,778: Parsing model.agency_data_pipeline.retention_730_plus
2018-04-17 14:08:59,781: Parsing model.agency_data_pipeline.retention_stats
2018-04-17 14:08:59,789: Parsing model.agency_data_pipeline.retention_stats_rebuy_rate
2018-04-17 14:08:59,793: Parsing model.agency_data_pipeline.retention_0_30
2018-04-17 14:08:59,797: Parsing model.agency_data_pipeline.retention_0_30_new
2018-04-17 14:08:59,807: Parsing model.agency_data_pipeline.retention_0_30_reactivated
2018-04-17 14:08:59,821: Parsing model.agency_data_pipeline.retention_0_30_rebuy
2018-04-17 14:08:59,832: Parsing model.agency_data_pipeline.retention_30_60
2018-04-17 14:08:59,838: Parsing model.agency_data_pipeline.retention_60_plus
2018-04-17 14:08:59,843: Parsing model.agency_data_pipeline.retention_stats_month
2018-04-17 14:08:59,863: Parsing model.agency_data_pipeline.retention_stats_rebuy_rate_month
2018-04-17 14:08:59,870: Parsing model.agency_data_pipeline.customers_first_purchase_proc
2018-04-17 14:08:59,873: Parsing model.agency_data_pipeline.customers_proc
2018-04-17 14:08:59,881: Parsing model.agency_data_pipeline.segment_list_customers
2018-04-17 14:08:59,887: Parsing model.agency_data_pipeline.segment_proc_customers
2018-04-17 14:08:59,893: Parsing model.agency_data_pipeline.segment_stats_customers
2018-04-17 14:08:59,896: Parsing model.agency_data_pipeline.segment_stats_customers_agg
2018-04-17 14:08:59,899: Parsing model.agency_data_pipeline.customers_first_purchase_product_type_proc
2018-04-17 14:08:59,902: Parsing model.agency_data_pipeline.customers_products_proc
2018-04-17 14:08:59,914: Parsing model.agency_data_pipeline.segment_list_customers_products
2018-04-17 14:08:59,922: Parsing model.agency_data_pipeline.segment_proc_customers_products
2018-04-17 14:08:59,932: Parsing model.agency_data_pipeline.segment_stats_customers_products
2018-04-17 14:08:59,946: Parsing model.agency_data_pipeline.segment_stats_customers_products_agg
2018-04-17 14:08:59,952: Parsing model.agency_data_pipeline.frequency_proc
2018-04-17 14:08:59,957: Parsing model.agency_data_pipeline.frequency_stats
2018-04-17 14:08:59,965: Parsing model.agency_data_pipeline.order_paths_agg
2018-04-17 14:08:59,975: Parsing model.agency_data_pipeline.order_paths_proc
2018-04-17 14:08:59,983: Parsing model.agency_data_pipeline.order_paths_stats
2018-04-17 14:08:59,991: Parsing model.agency_data_pipeline.products_proc
2018-04-17 14:08:59,995: Parsing model.agency_data_pipeline.segment_proc_sku
2018-04-17 14:08:59,998: Parsing model.agency_data_pipeline.segment_stats_category
2018-04-17 14:09:00,001: Parsing model.agency_data_pipeline.segment_stats_sku
2018-04-17 14:09:00,062: Found 91 models, 0 tests, 0 archives, 0 analyses, 46 macros, 0 operations
2018-04-17 14:09:00,300: 
2018-04-17 14:09:01,847: 14:09:01 | Concurrency: 4 threads (target='prod')
2018-04-17 14:09:01,847: 14:09:01 | 
2018-04-17 14:09:02,534: 14:09:02 | 1 of 91 START table model agency_data_pipeline.carts_proc............ [RUN]
2018-04-17 14:09:02,535: Compiling model.agency_data_pipeline.carts_proc
2018-04-17 14:09:02,539: Writing injected SQL for node "model.agency_data_pipeline.carts_proc"
2018-04-17 14:09:02,535: 14:09:02 | 2 of 91 START table model agency_data_pipeline.adwords_conversions... [RUN]
2018-04-17 14:09:02,539: Compiling model.agency_data_pipeline.adwords_conversions
2018-04-17 14:09:02,543: Writing injected SQL for node "model.agency_data_pipeline.adwords_conversions"
2018-04-17 14:09:02,535: 14:09:02 | 3 of 91 START table model agency_data_pipeline.adwords_campaigns..... [RUN]
2018-04-17 14:09:02,544: Compiling model.agency_data_pipeline.adwords_campaigns
2018-04-17 14:09:02,548: Writing injected SQL for node "model.agency_data_pipeline.adwords_campaigns"
2018-04-17 14:09:02,535: 14:09:02 | 4 of 91 START table model agency_data_pipeline.clients_proc.......... [RUN]
2018-04-17 14:09:02,549: Acquiring new bigquery connection "carts_proc".
2018-04-17 14:09:02,549: Compiling model.agency_data_pipeline.clients_proc
2018-04-17 14:09:02,551: Acquiring new bigquery connection "adwords_campaigns".
2018-04-17 14:09:02,551: Acquiring new bigquery connection "adwords_conversions".
2018-04-17 14:09:02,551: Opening a new connection (1 currently allocated)
2018-04-17 14:09:02,559: Writing injected SQL for node "model.agency_data_pipeline.clients_proc"
2018-04-17 14:09:02,562: Acquiring new bigquery connection "clients_proc".
2018-04-17 14:09:02,563: Opening a new connection (2 currently allocated)
2018-04-17 14:09:02,626: Opening a new connection (3 currently allocated)
2018-04-17 14:09:02,703: Opening a new connection (4 currently allocated)
2018-04-17 14:09:04,243: Model SQL (adwords_conversions):
select 
client,
client_name,
platform,
goal_name,
goal_type,
account,
time_of_entry
from  ( 

SELECT  
client,
client_name,
platform,
trim(lower(goal_name)) goal_name,
goal_type,
account,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform, goal_name ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.conversion_goals` 
WHERE platform = 'Adwords'

) 

WHERE lv = time_of_entry
2018-04-17 14:09:04,272: Model SQL (adwords_campaigns):
select
day,
campaignid, 
campaign,
account, 
channel,
platform,
sum(cost) cost,
sum(impressions) impressions,
sum(clicks) clicks,
sum(impression_share_num) impression_share_num,
sum(impression_share_den) impression_share_den
from 
  ( 
	SELECT  
	day,
	campaignid,
	campaign,
	account as account,
	'Paid' as channel,
	'Adwords' as platform,
	cost/1000000 cost, 
	impressions as impressions, 
	clicks, 
	case when searchimprshare is not null then impressions end as impression_share_num,
	case when searchimprshare is not null then impressions/(searchimprshare/100) end as impression_share_den,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY campaignid, day ORDER BY _sdc_sequence DESC) lv
	FROM `growth-engines-pipeline.adwords_2.CAMPAIGN_PERFORMANCE_REPORT`
  )
where lv = _sdc_sequence
group by day, campaignid, account, channel, platform, campaign
2018-04-17 14:09:04,275: Model SQL (clients_proc):
select 
client,
client_name,
account,
platform
from  ( 

SELECT  
client,
client_name,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.accounts`
where client_name != ''
) 

WHERE lv = time_of_entry
2018-04-17 14:09:04,279: Model SQL (carts_proc):
select 
client,
client_name,
account,
platform
from  ( 

SELECT  
client,
client_name,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.accounts`
WHERE platform in ('Shopify', 'Custom cart')

) 

WHERE lv = time_of_entry
2018-04-17 14:09:05,397: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f08467f5-3871-4f78-ba48-99dd38c09174', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1117f9e10>]}
2018-04-17 14:09:05,425: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f08467f5-3871-4f78-ba48-99dd38c09174', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10be4c710>]}
2018-04-17 14:09:05,642: 14:09:05 | 2 of 91 OK created table model agency_data_pipeline.adwords_conversions [CREATE TABLE in 2.86s]
2018-04-17 14:09:05,643: 14:09:05 | 5 of 91 START table model agency_data_pipeline.bing_ads_impression_share [RUN]
2018-04-17 14:09:05,644: Compiling model.agency_data_pipeline.bing_ads_impression_share
2018-04-17 14:09:05,649: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_impression_share"
2018-04-17 14:09:05,652: Acquiring new bigquery connection "bing_ads_impression_share".
2018-04-17 14:09:05,652: Re-using an available connection from the pool.
2018-04-17 14:09:05,893: 14:09:05 | 4 of 91 OK created table model agency_data_pipeline.clients_proc..... [CREATE TABLE in 2.88s]
2018-04-17 14:09:05,896: 14:09:05 | 6 of 91 START table model agency_data_pipeline.monthend_dates........ [RUN]
2018-04-17 14:09:05,896: Compiling model.agency_data_pipeline.monthend_dates
2018-04-17 14:09:05,904: Writing injected SQL for node "model.agency_data_pipeline.monthend_dates"
2018-04-17 14:09:05,905: Acquiring new bigquery connection "monthend_dates".
2018-04-17 14:09:05,906: Re-using an available connection from the pool.
2018-04-17 14:09:06,391: Model SQL (bing_ads_impression_share):
SELECT 
date, 
account,
channel,
platform,
sum(impressions) impressions,
sum(available_impressions) available_impressions
FROM

(

SELECT  
cast(gregoriandate as date) date,
replace(accountname,',','') account,  
'Paid' as channel,
'Bing Ads' as platform,
case when impressionsharepercent is null then 0 else impressions end as impressions,
cast(round(case when ( impressionsharepercent is not null and impressionsharepercent > 0 ) then (impressions*100)/impressionsharepercent else 0 end) as int64) as available_impressions,
_sdc_sequence,
first_value(_sdc_sequence) OVER (PARTITION BY campaignid, gregoriandate ORDER BY _sdc_sequence DESC) lv
FROM `growth-engines-pipeline.bing_ads.campaign_performance_report` 

)

where lv = _sdc_sequence
group by date, account, channel, platform
2018-04-17 14:09:06,537: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f08467f5-3871-4f78-ba48-99dd38c09174', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f3daf28>]}
2018-04-17 14:09:06,633: Model SQL (monthend_dates):
SELECT
date_in_range,
date_in_range_bom,
date_in_range_bom_mom,
unix_date_in_range,
unix_date_in_range_bom,
unix_date(date_in_range_bom_mom) unix_date_in_range_bom_mom,
yyyymm,
date_in_range_yoy,
unix_date(date_in_range_yoy) unix_date_in_range_yoy

FROM
(
	SELECT 
	date_in_range,
	date_in_range_bom,
	date_sub(date_in_range_bom, INTERVAL 1 MONTH) date_in_range_bom_mom,
  date_sub(date_in_range, INTERVAL 1 YEAR) date_in_range_yoy,
	unix_date_in_range,
	unix_date(date_in_range_bom) unix_date_in_range_bom,
	yyyymm,
	first_value(date_in_range) over (partition by yyyymm order by date_in_range desc) monthend_date_in_range
	FROM
	( 
		SELECT 
		date_in_range,
		date_trunc( date_in_range, MONTH) date_in_range_bom,
		unix_date(date_in_range) unix_date_in_range,
		format_date("%Y-%m", date_in_range) AS yyyymm
		FROM UNNEST(
		    GENERATE_DATE_ARRAY(DATE('2016-01-31'), CURRENT_DATE(), INTERVAL 1 DAY)
		) AS date_in_range
	)
)
where date_in_range = monthend_date_in_range
2018-04-17 14:09:06,770: 14:09:06 | 1 of 91 OK created table model agency_data_pipeline.carts_proc....... [CREATE TABLE in 4.00s]
2018-04-17 14:09:06,771: 14:09:06 | 7 of 91 START table model agency_data_pipeline.ga_conversions........ [RUN]
2018-04-17 14:09:06,771: Compiling model.agency_data_pipeline.ga_conversions
2018-04-17 14:09:06,777: Writing injected SQL for node "model.agency_data_pipeline.ga_conversions"
2018-04-17 14:09:06,781: Acquiring new bigquery connection "ga_conversions".
2018-04-17 14:09:06,781: Re-using an available connection from the pool.
2018-04-17 14:09:07,577: Model SQL (ga_conversions):
select 
client,
client_name,
platform,
goal_name,
goal_type,
account,
time_of_entry
from  ( 

SELECT  
client,
client_name,
platform,
trim(goal_name) goal_name,
goal_type,
account,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform, goal_name ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.conversion_goals` 
WHERE platform = 'Google Analytics'

) 

WHERE lv = time_of_entry
2018-04-17 14:09:08,638: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f08467f5-3871-4f78-ba48-99dd38c09174', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f270eb8>]}
2018-04-17 14:09:08,700: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f08467f5-3871-4f78-ba48-99dd38c09174', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f3daf28>]}
2018-04-17 14:09:08,875: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f08467f5-3871-4f78-ba48-99dd38c09174', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10be4c710>]}
2018-04-17 14:09:08,883: 14:09:08 | 5 of 91 OK created table model agency_data_pipeline.bing_ads_impression_share [CREATE TABLE in 2.99s]
2018-04-17 14:09:08,885: 14:09:08 | 8 of 91 START table model agency_data_pipeline.adwords_urls.......... [RUN]
2018-04-17 14:09:08,886: Compiling model.agency_data_pipeline.adwords_urls
2018-04-17 14:09:08,894: Writing injected SQL for node "model.agency_data_pipeline.adwords_urls"
2018-04-17 14:09:08,896: Acquiring new bigquery connection "adwords_urls".
2018-04-17 14:09:08,897: Re-using an available connection from the pool.
2018-04-17 14:09:09,143: 14:09:09 | 7 of 91 OK created table model agency_data_pipeline.ga_conversions... [CREATE TABLE in 1.93s]
2018-04-17 14:09:09,145: 14:09:09 | 9 of 91 START table model agency_data_pipeline.conversion_goals_proc. [RUN]
2018-04-17 14:09:09,148: Compiling model.agency_data_pipeline.conversion_goals_proc
2018-04-17 14:09:09,158: Writing injected SQL for node "model.agency_data_pipeline.conversion_goals_proc"
2018-04-17 14:09:09,159: Acquiring new bigquery connection "conversion_goals_proc".
2018-04-17 14:09:09,159: Re-using an available connection from the pool.
2018-04-17 14:09:09,453: 14:09:09 | 6 of 91 OK created table model agency_data_pipeline.monthend_dates... [CREATE TABLE in 2.98s]
2018-04-17 14:09:09,453: 14:09:09 | 10 of 91 START table model agency_data_pipeline.accounts_proc........ [RUN]
2018-04-17 14:09:09,453: Compiling model.agency_data_pipeline.accounts_proc
2018-04-17 14:09:09,459: Writing injected SQL for node "model.agency_data_pipeline.accounts_proc"
2018-04-17 14:09:09,461: Acquiring new bigquery connection "accounts_proc".
2018-04-17 14:09:09,461: Re-using an available connection from the pool.
2018-04-17 14:09:09,692: Model SQL (adwords_urls):
SELECT
campaignid,
lower(trim(regexp_replace(replace(replace(replace(replace(finalurl,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url

FROM (

SELECT  
campaignid,
finalurl,
first_value(finalurl) OVER (PARTITION BY campaignid ORDER BY day DESC) lv
FROM `growth-engines-pipeline.adwords_2.FINAL_URL_REPORT`
)

WHERE lv = finalurl
group by campaignid, url
order by campaignid asc
2018-04-17 14:09:10,018: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f08467f5-3871-4f78-ba48-99dd38c09174', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f3da9e8>]}
2018-04-17 14:09:10,110: Model SQL (conversion_goals_proc):
select 
client,
platform,
goal_name,
max(goal_type) goal_type,
account,
max(time_of_entry) time_of_entry
from  ( 

SELECT  
client,
platform,
trim(replace(replace(lower(goal_name),',',''),' ','')) goal_name,
goal_type,
account,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY platform ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.conversion_goals` 

) 

WHERE lv = time_of_entry
group by client, platform, account, goal_name
2018-04-17 14:09:10,256: 14:09:10 | 3 of 91 OK created table model agency_data_pipeline.adwords_campaigns [CREATE TABLE in 7.47s]
2018-04-17 14:09:10,257: 14:09:10 | 11 of 91 START table model agency_data_pipeline.bing_ads_ads......... [RUN]
2018-04-17 14:09:10,257: Compiling model.agency_data_pipeline.bing_ads_ads
2018-04-17 14:09:10,265: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_ads"
2018-04-17 14:09:10,266: Acquiring new bigquery connection "bing_ads_ads".
2018-04-17 14:09:10,266: Re-using an available connection from the pool.
2018-04-17 14:09:10,273: Model SQL (accounts_proc):
select 
client,
account,
platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.accounts` 

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-04-17 14:09:11,079: Model SQL (bing_ads_ads):
select
date, 
account, 
channel,
platform,
campaignid,
campaignname,
max(lower(trim(replace(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$','' ),'.html',''),'/'))) as url,
utm_campaign,
sum(cost) as cost,
sum(impressions) as impressions,
sum(clicks) as clicks,
sum(conversions) as conversions
from 
  ( 
SELECT  
cast(gregoriandate as date) date,
replace(accountname,',','') account,
'Paid' as channel,
'Bing Ads' as platform,
adid,
adtype,
campaignid, 
campaignname,
finalurl url,
case when regexp_contains(destinationurl, 'utm_campaign')
	then replace(lower(nullif(
  

    split(
        
  

    split(
        destinationurl,
        'utm_campaign='
        )[offset(1)]


,
        '&'
        )[offset(0)]


,'')),'+',' ') 
	else null end as utm_campaign,
spend cost, 
impressions, 
clicks, 
conversions,
_sdc_sequence,
first_value(_sdc_sequence) OVER (PARTITION BY adid, gregoriandate ORDER BY _sdc_sequence DESC) lv
FROM `growth-engines-pipeline.bing_ads.ad_performance_report` 
  )

where lv = _sdc_sequence
group by date, account, channel, platform, campaignid, campaignname, utm_campaign
2018-04-17 14:09:11,984: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f08467f5-3871-4f78-ba48-99dd38c09174', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f270eb8>]}
2018-04-17 14:09:12,273: 14:09:12 | 8 of 91 OK created table model agency_data_pipeline.adwords_urls..... [CREATE TABLE in 3.10s]
2018-04-17 14:09:12,273: 14:09:12 | 12 of 91 START table model agency_data_pipeline.all_dates............ [RUN]
2018-04-17 14:09:12,274: Compiling model.agency_data_pipeline.all_dates
2018-04-17 14:09:12,282: Writing injected SQL for node "model.agency_data_pipeline.all_dates"
2018-04-17 14:09:12,283: Acquiring new bigquery connection "all_dates".
2018-04-17 14:09:12,283: Re-using an available connection from the pool.
2018-04-17 14:09:12,359: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f08467f5-3871-4f78-ba48-99dd38c09174', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f3daf28>]}
2018-04-17 14:09:12,532: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f08467f5-3871-4f78-ba48-99dd38c09174', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10be4c710>]}
2018-04-17 14:09:12,605: 14:09:12 | 9 of 91 OK created table model agency_data_pipeline.conversion_goals_proc [CREATE TABLE in 3.21s]
2018-04-17 14:09:12,868: 14:09:12 | 10 of 91 OK created table model agency_data_pipeline.accounts_proc... [CREATE TABLE in 3.08s]
2018-04-17 14:09:13,222: Model SQL (all_dates):
SELECT 
date_in_range,
unix_date(date_in_range) unix_date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-04-17 14:09:14,339: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f08467f5-3871-4f78-ba48-99dd38c09174', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f270eb8>]}
2018-04-17 14:09:14,469: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f08467f5-3871-4f78-ba48-99dd38c09174', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f3da9e8>]}
2018-04-17 14:09:14,577: 14:09:14 | 12 of 91 OK created table model agency_data_pipeline.all_dates....... [CREATE TABLE in 2.06s]
2018-04-17 14:09:14,828: 14:09:14 | 11 of 91 OK created table model agency_data_pipeline.bing_ads_ads.... [CREATE TABLE in 4.21s]
2018-04-17 14:09:14,828: 14:09:14 | 13 of 91 START table model agency_data_pipeline.ga_mcf_proc.......... [RUN]
2018-04-17 14:09:14,829: Compiling model.agency_data_pipeline.ga_mcf_proc
2018-04-17 14:09:14,840: Writing injected SQL for node "model.agency_data_pipeline.ga_mcf_proc"
2018-04-17 14:09:14,838: 14:09:14 | 14 of 91 START table model agency_data_pipeline.fb_ads_insights...... [RUN]
2018-04-17 14:09:14,839: 14:09:14 | 15 of 91 START table model agency_data_pipeline.fb_ads_insights_conversions [RUN]
2018-04-17 14:09:14,842: Compiling model.agency_data_pipeline.fb_ads_insights_conversions
2018-04-17 14:09:14,841: Compiling model.agency_data_pipeline.fb_ads_insights
2018-04-17 14:09:14,842: Acquiring new bigquery connection "ga_mcf_proc".
2018-04-17 14:09:14,881: Re-using an available connection from the pool.
2018-04-17 14:09:14,874: Acquiring new bigquery connection "fb_ads_insights_conversions".
2018-04-17 14:09:14,894: Re-using an available connection from the pool.
2018-04-17 14:09:14,894: Fetching data for query fb_ads_insights_conversions:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 14:09:14,839: 14:09:14 | 16 of 91 START table model agency_data_pipeline.mappings_ga_proc..... [RUN]
2018-04-17 14:09:14,899: Compiling model.agency_data_pipeline.mappings_ga_proc
2018-04-17 14:09:14,881: Acquiring new bigquery connection "fb_ads_insights".
2018-04-17 14:09:15,010: Re-using an available connection from the pool.
2018-04-17 14:09:15,010: Fetching data for query fb_ads_insights:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 14:09:15,014: Writing injected SQL for node "model.agency_data_pipeline.mappings_ga_proc"
2018-04-17 14:09:15,017: Acquiring new bigquery connection "mappings_ga_proc".
2018-04-17 14:09:15,018: Re-using an available connection from the pool.
2018-04-17 14:09:15,909: Model SQL (mappings_ga_proc):
select 
client,
account,
client_name,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
account,
client_name,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.mappings_ga` 

) 

WHERE lv = time_of_entry
and client in (select client from `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc` )
group by client, account, client_name, source, medium, platform_n, channel_n, time_of_entry
2018-04-17 14:09:15,961: Model SQL (ga_mcf_proc):
SELECT 
date,
account,
'Google Analytics' as lookup_platform,
source_medium_path,
trim(lower(split(split(source_medium_path,'->')[SAFE_ORDINAL(1)],'/')[SAFE_ORDINAL(1)])) as source,
trim(lower(split(split(source_medium_path,'->')[SAFE_ORDINAL(1)],'/')[SAFE_ORDINAL(2)])) as medium,
first_interaction_campaign campaign,
cast(regexp_replace(transaction_id, r'#', '') as int64) transactionid,
max(first_interaction_conversions) transactions,
max(first_interaction_conversion_value) revenue
FROM `growth-engines-pipeline.agency_data_pipeline.ga_mcf`
where account in (select account from `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc` where platform = 'Google Analytics')
group by date, account, source, medium, campaign, source_medium_path, lookup_platform, transactionid
2018-04-17 14:09:16,236: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_insights_conversions"
2018-04-17 14:09:16,294: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_insights"
2018-04-17 14:09:17,027: Model SQL (fb_ads_insights_conversions):




with fb_ads_insights_conversions as (

	    
		   	SELECT 
			date_start,
			campaign_id,
			campaign_name,
			ad_id,
			account_name,
			spend,
			reach,
			inline_link_clicks,
			_sdc_sequence,
			action_type,
			value
			FROM `growth-engines-pipeline.fb_ads_luca_danni.ads_insights`
			cross join unnest(actions)
		    
	   

)

SELECT * 
FROM 
	(
    SELECT
    date_start date,
    campaign_id,
    campaign_name campaign,
    ad_id,
    account_name account,
    action_type,
    value conversions,
    first_value(_sdc_sequence) OVER (PARTITION BY ad_id, date_start ORDER BY _sdc_sequence DESC) lv,
    _sdc_sequence
    FROM fb_ads_insights_conversions
   	)
where lv = _sdc_sequence
and action_type like '%purchase%'


2018-04-17 14:09:17,069: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f08467f5-3871-4f78-ba48-99dd38c09174', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f3daf60>]}
2018-04-17 14:09:17,076: Model SQL (fb_ads_insights):




with fb_ads_insights as (

	    
		   	SELECT 
			date_start,
			campaign_id,
			campaign_name,
			ad_id,
			account_name,
			spend,
			reach,
			inline_link_clicks,
			_sdc_sequence,
			first_value(_sdc_sequence) OVER (PARTITION BY date_start, ad_id, campaign_id ORDER BY _sdc_sequence DESC) lv
			FROM `growth-engines-pipeline.fb_ads_luca_danni.ads_insights`
		    
	   

)

select
date_start date,
campaign_id,
campaign_name campaign,
ad_id,
account_name account,
max(spend) cost,
max(reach) impressions,
max(inline_link_clicks) clicks
from fb_ads_insights
where lv = _sdc_sequence
group by date, campaign_id, ad_id, account, campaign


2018-04-17 14:09:17,321: 14:09:17 | 16 of 91 OK created table model agency_data_pipeline.mappings_ga_proc [CREATE TABLE in 2.17s]
2018-04-17 14:09:17,322: 14:09:17 | 17 of 91 START table model agency_data_pipeline.shopify_refunds_proc. [RUN]
2018-04-17 14:09:17,322: Compiling model.agency_data_pipeline.shopify_refunds_proc
2018-04-17 14:09:17,332: Acquiring new bigquery connection "shopify_refunds_proc".
2018-04-17 14:09:17,332: Re-using an available connection from the pool.
2018-04-17 14:09:17,332: Fetching data for query shopify_refunds_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 14:09:19,162: Writing injected SQL for node "model.agency_data_pipeline.shopify_refunds_proc"
2018-04-17 14:09:20,083: Model SQL (shopify_refunds_proc):




with refunds as (

	
	SELECT
	order_number,
	checkout_id,
	financial_status,
	line_item_id,
	quantity,
	subtotal,
	line_item.variant_id variant_id,
	line_item.id refund_id,
 	_sdc_sequence
	FROM `growth-engines-pipeline.shopify_lucadanni.orders` 
	cross join unnest(refunds), unnest(refund_line_items)
  	where financial_status like '%refund%'
	
	

)

SELECT * 
FROM 
	(
    SELECT
	order_number,
	checkout_id,
	financial_status,
	line_item_id,
	quantity,
	subtotal refund_amount,
	variant_id,
	refund_id,
 	_sdc_sequence,
    first_value(_sdc_sequence) OVER (PARTITION BY order_number, line_item_id ORDER BY _sdc_sequence DESC) lv
    FROM refunds
   	) 
WHERE lv = _sdc_sequence


2018-04-17 14:09:20,606: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f08467f5-3871-4f78-ba48-99dd38c09174', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110376e10>]}
2018-04-17 14:09:20,942: 14:09:20 | 14 of 91 OK created table model agency_data_pipeline.fb_ads_insights. [CREATE TABLE in 5.76s]
2018-04-17 14:09:20,943: 14:09:20 | 18 of 91 START table model agency_data_pipeline.adwords_ads.......... [RUN]
2018-04-17 14:09:20,943: Compiling model.agency_data_pipeline.adwords_ads
2018-04-17 14:09:20,953: Writing injected SQL for node "model.agency_data_pipeline.adwords_ads"
2018-04-17 14:09:20,953: Acquiring new bigquery connection "adwords_ads".
2018-04-17 14:09:20,954: Re-using an available connection from the pool.
2018-04-17 14:09:21,492: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f08467f5-3871-4f78-ba48-99dd38c09174', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11038bef0>]}
2018-04-17 14:09:21,577: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f08467f5-3871-4f78-ba48-99dd38c09174', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f270eb8>]}
2018-04-17 14:09:21,821: Model SQL (adwords_ads):
SELECT  
day,
campaignid,
a.account as account,
utm_campaign,
sum( case when b.goal_type = 'Transaction' then conversions else 0 end ) as transactions
FROM (

	SELECT  
	day,
	adid,
	campaignid,
	account,
	lower(conversionname) conversionname,
	conversions,
	lower(campaign) utm_campaign,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY campaignid, day ORDER BY _sdc_sequence DESC) lv
	FROM
	`growth-engines-pipeline.adwords_2.AD_PERFORMANCE_REPORT`

) a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_conversions` b
ON ( a.conversionname = b.goal_name
	AND a.account = b.account )
WHERE lv = _sdc_sequence
group by day, campaignid, account, utm_campaign
2018-04-17 14:09:21,996: 14:09:21 | 15 of 91 OK created table model agency_data_pipeline.fb_ads_insights_conversions [CREATE TABLE in 6.65s]
2018-04-17 14:09:21,997: 14:09:21 | 19 of 91 START table model agency_data_pipeline.bing_ads_conversions. [RUN]
2018-04-17 14:09:21,999: Compiling model.agency_data_pipeline.bing_ads_conversions
2018-04-17 14:09:22,008: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_conversions"
2018-04-17 14:09:22,010: Acquiring new bigquery connection "bing_ads_conversions".
2018-04-17 14:09:22,011: Re-using an available connection from the pool.
2018-04-17 14:09:22,246: 14:09:22 | 13 of 91 OK created table model agency_data_pipeline.ga_mcf_proc..... [CREATE TABLE in 6.75s]
2018-04-17 14:09:22,246: 14:09:22 | 20 of 91 START table model agency_data_pipeline.fb_adcreative........ [RUN]
2018-04-17 14:09:22,247: Compiling model.agency_data_pipeline.fb_adcreative
2018-04-17 14:09:22,256: Acquiring new bigquery connection "fb_adcreative".
2018-04-17 14:09:22,256: Re-using an available connection from the pool.
2018-04-17 14:09:22,256: Fetching data for query fb_adcreative:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 14:09:22,331: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f08467f5-3871-4f78-ba48-99dd38c09174', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f3daf60>]}
2018-04-17 14:09:22,584: 14:09:22 | 17 of 91 OK created table model agency_data_pipeline.shopify_refunds_proc [CREATE TABLE in 5.01s]
2018-04-17 14:09:22,629: Writing injected SQL for node "model.agency_data_pipeline.fb_adcreative"
2018-04-17 14:09:22,838: Model SQL (bing_ads_conversions):
SELECT
date, 
a.account account, 
a.channel channel,
a.platform platform,
campaignid,
campaignname,
sum( case when b.goal_type = 'Transactions' then conversions else 0 end ) as transactions
FROM

  ( 
SELECT  
cast(gregoriandate as date) date,
replace(accountname,',','') account,
'Paid' as channel,
'Bing Ads' as platform,
trim(replace(replace(lower(goal),',',''),' ','')) goal,
goalid,
campaignid,
campaignname,
conversions,
_sdc_sequence,
first_value(_sdc_sequence) OVER (PARTITION BY campaignid, goalid, gregoriandate ORDER BY _sdc_sequence DESC) lv
FROM `growth-engines-pipeline.bing_ads.goals_and_funnels_report` 

  ) a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`conversion_goals_proc` b
ON (
	a.account = b.account AND
	a.platform = b.platform AND
	a.goal = b.goal_name
)
where a.lv = a._sdc_sequence
group by date, account, channel, platform, campaignid, campaignname
2018-04-17 14:09:23,378: Model SQL (fb_adcreative):




with fb_adcreative as (


	    
		   	SELECT 
			id,
			object_url,
			url_tags,
			_sdc_sequence
			FROM `growth-engines-pipeline.fb_ads_luca_danni.adcreative`
		    
	   
)

select creative_id, max(url) url
from (
  select
  id creative_id,
  lower(trim(regexp_replace(replace(replace(replace(replace(object_url,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
  first_value(_sdc_sequence) OVER (PARTITION BY id ORDER BY _sdc_sequence DESC) lv,
  _sdc_sequence
  from fb_adcreative
  )
where lv = _sdc_sequence
group by creative_id


2018-04-17 14:09:24,076: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f08467f5-3871-4f78-ba48-99dd38c09174', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1117af4e0>]}
2018-04-17 14:09:24,655: 14:09:24 | 18 of 91 OK created table model agency_data_pipeline.adwords_ads..... [CREATE TABLE in 3.13s]
2018-04-17 14:09:25,061: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f08467f5-3871-4f78-ba48-99dd38c09174', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11038bef0>]}
2018-04-17 14:09:25,589: 14:09:25 | 19 of 91 OK created table model agency_data_pipeline.bing_ads_conversions [CREATE TABLE in 3.06s]
2018-04-17 14:09:25,618: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f08467f5-3871-4f78-ba48-99dd38c09174', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f270eb8>]}
2018-04-17 14:09:25,881: 14:09:25 | 20 of 91 OK created table model agency_data_pipeline.fb_adcreative... [CREATE TABLE in 3.37s]
2018-04-17 14:09:25,883: 14:09:25 | 21 of 91 START table model agency_data_pipeline.fb_ads............... [RUN]
2018-04-17 14:09:25,883: 14:09:25 | 22 of 91 START table model agency_data_pipeline.shopify_customers_proc [RUN]
2018-04-17 14:09:25,883: Compiling model.agency_data_pipeline.fb_ads
2018-04-17 14:09:25,884: Compiling model.agency_data_pipeline.shopify_customers_proc
2018-04-17 14:09:25,899: Acquiring new bigquery connection "fb_ads".
2018-04-17 14:09:25,900: Acquiring new bigquery connection "shopify_customers_proc".
2018-04-17 14:09:25,900: Re-using an available connection from the pool.
2018-04-17 14:09:25,900: Fetching data for query fb_ads:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 14:09:25,900: Re-using an available connection from the pool.
2018-04-17 14:09:25,902: Fetching data for query shopify_customers_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 14:09:26,293: Writing injected SQL for node "model.agency_data_pipeline.fb_ads"
2018-04-17 14:09:26,299: Writing injected SQL for node "model.agency_data_pipeline.shopify_customers_proc"
2018-04-17 14:09:27,229: Model SQL (fb_ads):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`fb_adcreative`





with fb_ads as (

	    
		   	SELECT 
			id ad_id,
			creative.creative_id creative_id,
			_sdc_sequence
			FROM `growth-engines-pipeline.fb_ads_luca_danni.ads`
		     
	   

)

SELECT
a.ad_id,
b.creative_id,
b.url
FROM (
    SELECT
    ad_id,
    creative_id,
    first_value(_sdc_sequence) OVER (PARTITION BY ad_id ORDER BY _sdc_sequence DESC) lv,
    _sdc_sequence
    FROM fb_ads
    ) a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`fb_adcreative` b
ON (
	a.creative_id = b.creative_id 
)
WHERE a.lv = a._sdc_sequence


2018-04-17 14:09:27,337: Model SQL (shopify_customers_proc):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc`





with customers as (

	
	SELECT
	'lucadanni' client_name,
	'Shopify' as lookup_platform,
	cast(created_at as date) created_at,
	id,
	first_name,
	last_name,
	email,
	_sdc_sequence,
	first_value(_sdc_sequence) over (partition by id, _sdc_sequence order by _sdc_sequence desc) lv
	FROM `growth-engines-pipeline.shopify_lucadanni.customers` 
	
	

)

SELECT
account,
client,
platform,
id,
min(created_at) created_at,
max(first_name) first_name,
max(last_name) last_name,
max(email) email
FROM (
	SELECT
	b.account,
	b.client,
	b.platform,
	created_at,
	id,
	first_name,
	last_name,
	email
	FROM customers a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
	ON ( a.client_name = b.client_name
	  AND a.lookup_platform = b.platform )
	where a.lv = a._sdc_sequence
)
group by account, client, platform, id

2018-04-17 14:09:29,474: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f08467f5-3871-4f78-ba48-99dd38c09174', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1117ecdd8>]}
2018-04-17 14:09:29,938: 14:09:29 | 21 of 91 OK created table model agency_data_pipeline.fb_ads.......... [CREATE TABLE in 3.59s]
2018-04-17 14:09:32,887: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f08467f5-3871-4f78-ba48-99dd38c09174', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1117f9da0>]}
2018-04-17 14:09:33,272: 14:09:33 | 22 of 91 OK created table model agency_data_pipeline.shopify_customers_proc [CREATE TABLE in 7.00s]
2018-04-17 14:09:33,273: 14:09:33 | 23 of 91 START table model agency_data_pipeline.shopify_products_proc [RUN]
2018-04-17 14:09:33,274: Compiling model.agency_data_pipeline.shopify_products_proc
2018-04-17 14:09:33,273: 14:09:33 | 24 of 91 START table model agency_data_pipeline.ga_mcf_stats......... [RUN]
2018-04-17 14:09:33,279: Compiling model.agency_data_pipeline.ga_mcf_stats
2018-04-17 14:09:33,273: 14:09:33 | 25 of 91 START table model agency_data_pipeline.bing_ads_stats....... [RUN]
2018-04-17 14:09:33,284: Acquiring new bigquery connection "shopify_products_proc".
2018-04-17 14:09:33,290: Writing injected SQL for node "model.agency_data_pipeline.ga_mcf_stats"
2018-04-17 14:09:33,273: 14:09:33 | 26 of 91 START table model agency_data_pipeline.agg_customers_union.. [RUN]
2018-04-17 14:09:33,290: Compiling model.agency_data_pipeline.bing_ads_stats
2018-04-17 14:09:33,291: Re-using an available connection from the pool.
2018-04-17 14:09:33,291: Compiling model.agency_data_pipeline.agg_customers_union
2018-04-17 14:09:33,296: Fetching data for query shopify_products_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 14:09:33,298: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_stats"
2018-04-17 14:09:33,303: Writing injected SQL for node "model.agency_data_pipeline.agg_customers_union"
2018-04-17 14:09:33,303: Acquiring new bigquery connection "ga_mcf_stats".
2018-04-17 14:09:33,306: Re-using an available connection from the pool.
2018-04-17 14:09:33,309: Acquiring new bigquery connection "bing_ads_stats".
2018-04-17 14:09:33,309: Re-using an available connection from the pool.
2018-04-17 14:09:33,318: Acquiring new bigquery connection "agg_customers_union".
2018-04-17 14:09:33,318: Re-using an available connection from the pool.
2018-04-17 14:09:33,666: Writing injected SQL for node "model.agency_data_pipeline.shopify_products_proc"
2018-04-17 14:09:33,931: Unhandled error while executing None
404 GET https://www.googleapis.com/bigquery/v2/projects/growth-engines-pipeline/datasets/agency_data_pipeline/tables?pageToken=ga_mcf_stats: Not found: Token ga_mcf_stats
2018-04-17 14:09:33,932: 14:09:33 | 27 of 91 START table model agency_data_pipeline.shopify_orders_proc.. [RUN]
2018-04-17 14:09:33,932: Compiling model.agency_data_pipeline.shopify_orders_proc
2018-04-17 14:09:33,958: Acquiring new bigquery connection "shopify_orders_proc".
2018-04-17 14:09:33,958: Connection 'master' was left open.
2018-04-17 14:09:33,958: Connection 'ga_mcf_stats' was left open.
2018-04-17 14:09:33,958: Connection 'bing_ads_stats' was left open.
2018-04-17 14:09:33,959: Connection 'agg_customers_union' was left open.
2018-04-17 14:09:33,959: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1117a50f0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1117a5438>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1117a5780>]}
2018-04-17 14:09:33,963: Opening a new connection (0 currently allocated)
2018-04-17 14:09:33,973: Fetching data for query shopify_orders_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 14:09:34,206: Model SQL (bing_ads_stats):
select
a.date, 
a.account, 
a.channel,
a.platform,
url,
a.campaignname campaign,
utm_campaign,
cost,
clicks,
impressions,
transactions
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`bing_ads_ads` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`bing_ads_conversions` b
ON (
	a.date = b.date AND
	a.account = b.account AND
	a.campaignid = b.campaignid

)
2018-04-17 14:09:34,216: Model SQL (agg_customers_union):
SELECT *
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`shopify_customers_proc`
2018-04-17 14:09:34,241: Model SQL (ga_mcf_stats):
SELECT  
date,
a.account account,
b.client client,
case when c.platform is null then "Unmapped" else c.platform end as platform,
case when c.channel is null then "Unmapped" else c.channel end as channel,
lower(a.source) source,
lower(a.medium) medium,
lower(campaign) campaign,
transactionid,
sum(transactions) first_touch_transactions,
sum(revenue) first_touch_revenue
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`ga_mcf_proc` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc` b 
ON ( a.account = b.account and
	a.lookup_platform = b.platform )
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc` c
ON ( lower(a.source) = c.source
  AND lower(a.medium) = c.medium 
  and a.account = c.account )
group by date, account, client, source, medium, campaign, platform, channel, transactionid
2018-04-17 14:09:34,402: Encountered an error:
2018-04-17 14:09:34,402: 404 GET https://www.googleapis.com/bigquery/v2/projects/growth-engines-pipeline/datasets/agency_data_pipeline/tables?pageToken=ga_mcf_stats: Not found: Token ga_mcf_stats
2018-04-17 14:09:34,414: Traceback (most recent call last):
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/main.py", line 40, in main
    results, succeeded = handle_and_check(args)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/main.py", line 84, in handle_and_check
    task, res = run_from_args(parsed)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/main.py", line 138, in run_from_args
    results = run_from_task(task, proj, parsed)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/main.py", line 146, in run_from_task
    result = task.run()
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/task/run.py", line 26, in run
    results = runner.run(query, ModelRunner)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/runner.py", line 221, in run
    return self.run_from_graph(Selector, Runner, query)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/runner.py", line 208, in run_from_graph
    res = self.execute_nodes(linker, Runner, flat_graph, dep_list)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/runner.py", line 133, in execute_nodes
    for result in pool.imap_unordered(self.call_runner, args_list):
  File "/usr/local/opt/python3/Frameworks/Python.framework/Versions/3.6/lib/python3.6/multiprocessing/pool.py", line 735, in next
    raise value
  File "/usr/local/opt/python3/Frameworks/Python.framework/Versions/3.6/lib/python3.6/multiprocessing/pool.py", line 119, in worker
    result = (True, func(*args, **kwds))
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/runner.py", line 82, in call_runner
    result = runner.safe_run(flat_graph, existing)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/node_runners.py", line 139, in safe_run
    raise e
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/node_runners.py", line 108, in safe_run
    result = self.run(compiled_node, existing, flat_graph)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/node_runners.py", line 155, in run
    return self.execute(compiled_node, existing, flat_graph)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/node_runners.py", line 389, in execute
    materialization_macro.get('generator')(context)()
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/clients/jinja.py", line 51, in call
    return macro(*args, **kwargs)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/runtime.py", line 549, in __call__
    return self._invoke(arguments, autoescape)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/asyncsupport.py", line 110, in _invoke
    return original_invoke(self, arguments, autoescape)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/runtime.py", line 553, in _invoke
    rv = self._func(*arguments)
  File "<template>", line 55, in macro
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/sandbox.py", line 427, in call
    return __context.call(__obj, *args, **kwargs)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/runtime.py", line 260, in call
    return __obj(*args, **kwargs)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/context/common.py", line 48, in wrapped
    return getattr(self.adapter, fn)(*args, **kwargs)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/adapters/bigquery.py", line 154, in query_for_existing
    all_tables.extend(dataset.list_tables())
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/google/cloud/iterator.py", line 218, in _items_iter
    for page in self._page_iter(increment=False):
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/google/cloud/iterator.py", line 254, in _page_iter
    page = self._next_page()
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/google/cloud/iterator.py", line 348, in _next_page
    response = self._get_next_page_response()
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/google/cloud/iterator.py", line 399, in _get_next_page_response
    query_params=params)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/google/cloud/_http.py", line 293, in api_request
    raise exceptions.from_http_response(response)
google.cloud.exceptions.NotFound: 404 GET https://www.googleapis.com/bigquery/v2/projects/growth-engines-pipeline/datasets/agency_data_pipeline/tables?pageToken=ga_mcf_stats: Not found: Token ga_mcf_stats

2018-04-17 14:14:57,212: Tracking: tracking
2018-04-17 14:14:57,215: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109b1bcc0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109b1beb8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109b1bf60>]}
2018-04-17 14:14:58,022: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-04-17 14:14:58,050: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/growth-engines/dbt_modules
2018-04-17 14:14:58,055: Parsing get_column_values.sql
2018-04-17 14:14:58,079: Parsing get_url_parameter.sql
2018-04-17 14:14:58,086: Parsing split_part.sql
2018-04-17 14:14:58,092: Parsing table_exists.sql
2018-04-17 14:14:58,109: Parsing core.sql
2018-04-17 14:14:58,128: Parsing adapters/bigquery.sql
2018-04-17 14:14:58,138: Parsing adapters/common.sql
2018-04-17 14:14:58,159: Parsing adapters/postgres.sql
2018-04-17 14:14:58,164: Parsing adapters/redshift.sql
2018-04-17 14:14:58,194: Parsing etc/get_custom_schema.sql
2018-04-17 14:14:58,203: Parsing materializations/archive.sql
2018-04-17 14:14:58,260: Parsing materializations/bigquery.sql
2018-04-17 14:14:58,280: Parsing materializations/helpers.sql
2018-04-17 14:14:58,317: Parsing materializations/incremental.sql
2018-04-17 14:14:58,372: Parsing materializations/table.sql
2018-04-17 14:14:58,415: Parsing materializations/view.sql
2018-04-17 14:14:58,445: Parsing materializations/wrapper.sql
2018-04-17 14:14:58,451: Parsing schema_tests/accepted_values.sql
2018-04-17 14:14:58,461: Parsing schema_tests/not_null.sql
2018-04-17 14:14:58,467: Parsing schema_tests/relationships.sql
2018-04-17 14:14:58,473: Parsing schema_tests/unique.sql
2018-04-17 14:14:58,646: Parsing model.agency_data_pipeline.accounts_proc
2018-04-17 14:14:58,651: Parsing model.agency_data_pipeline.all_dates
2018-04-17 14:14:58,655: Parsing model.agency_data_pipeline.carts_proc
2018-04-17 14:14:58,658: Parsing model.agency_data_pipeline.clients_proc
2018-04-17 14:14:58,673: Parsing model.agency_data_pipeline.conversion_goals_proc
2018-04-17 14:14:58,680: Parsing model.agency_data_pipeline.mappings_ga_proc
2018-04-17 14:14:58,684: Acquiring new bigquery connection "master".
2018-04-17 14:14:58,685: Opening a new connection (0 currently allocated)
2018-04-17 14:14:58,690: Parsing model.agency_data_pipeline.monthend_dates
2018-04-17 14:14:58,692: Parsing model.agency_data_pipeline.adwords_ads
2018-04-17 14:14:58,697: Parsing model.agency_data_pipeline.adwords_campaigns
2018-04-17 14:14:58,703: Parsing model.agency_data_pipeline.adwords_conversions
2018-04-17 14:14:58,706: Parsing model.agency_data_pipeline.adwords_impression_share
2018-04-17 14:14:58,710: Parsing model.agency_data_pipeline.adwords_join
2018-04-17 14:14:58,718: Parsing model.agency_data_pipeline.adwords_stats
2018-04-17 14:14:58,722: Parsing model.agency_data_pipeline.adwords_urls
2018-04-17 14:14:58,727: Parsing model.agency_data_pipeline.bing_ads_ads
2018-04-17 14:14:58,739: Parsing model.agency_data_pipeline.bing_ads_conversions
2018-04-17 14:14:58,743: Parsing model.agency_data_pipeline.bing_ads_impression_share
2018-04-17 14:14:58,749: Parsing model.agency_data_pipeline.bing_ads_stats
2018-04-17 14:14:58,752: Parsing model.agency_data_pipeline.fb_adcreative
2018-04-17 14:14:58,761: Parsing model.agency_data_pipeline.fb_ads
2018-04-17 14:14:58,775: Parsing model.agency_data_pipeline.fb_ads_insights
2018-04-17 14:14:58,782: Parsing model.agency_data_pipeline.fb_ads_insights_conversions
2018-04-17 14:14:58,793: Parsing model.agency_data_pipeline.fb_ads_stats
2018-04-17 14:14:58,799: Parsing model.agency_data_pipeline.ga_conversions
2018-04-17 14:14:58,804: Parsing model.agency_data_pipeline.ga_traffic
2018-04-17 14:14:58,824: Parsing model.agency_data_pipeline.ga_transactions
2018-04-17 14:14:58,838: Parsing model.agency_data_pipeline.ga_mcf_proc
2018-04-17 14:14:58,842: Parsing model.agency_data_pipeline.ga_mcf_stats
2018-04-17 14:14:58,848: Parsing model.agency_data_pipeline.shopify_customers_proc
2018-04-17 14:14:58,861: Parsing model.agency_data_pipeline.shopify_orders_proc
2018-04-17 14:14:58,874: Parsing model.agency_data_pipeline.shopify_products_proc
2018-04-17 14:14:58,888: Parsing model.agency_data_pipeline.shopify_refunds_proc
2018-04-17 14:14:58,904: Parsing model.agency_data_pipeline.agg_campaign
2018-04-17 14:14:58,912: Parsing model.agency_data_pipeline.agg_customers_union
2018-04-17 14:14:58,917: Parsing model.agency_data_pipeline.agg_ga_campaign
2018-04-17 14:14:58,924: Parsing model.agency_data_pipeline.agg_ga_campaign_by_type
2018-04-17 14:14:58,941: Parsing model.agency_data_pipeline.agg_ga_transaction
2018-04-17 14:14:58,948: Parsing model.agency_data_pipeline.agg_ga_transaction_order_number
2018-04-17 14:14:58,952: Parsing model.agency_data_pipeline.agg_orders_union
2018-04-17 14:14:58,979: Parsing model.agency_data_pipeline.agg_platform_monthly
2018-04-17 14:14:58,987: Parsing model.agency_data_pipeline.agg_platforms_client
2018-04-17 14:14:58,996: Parsing model.agency_data_pipeline.agg_platforms_union
2018-04-17 14:14:59,002: Parsing model.agency_data_pipeline.agg_products
2018-04-17 14:14:59,008: Parsing model.agency_data_pipeline.agg_transaction
2018-04-17 14:14:59,014: Parsing model.agency_data_pipeline.agg_transaction_daily
2018-04-17 14:14:59,018: Parsing model.agency_data_pipeline.agg_transaction_line_item
2018-04-17 14:14:59,025: Parsing model.agency_data_pipeline.agg_transaction_line_item_type
2018-04-17 14:14:59,033: Parsing model.agency_data_pipeline.agg_transaction_order_number
2018-04-17 14:14:59,036: Parsing model.agency_data_pipeline.agg_transaction_product_type
2018-04-17 14:14:59,040: Parsing model.agency_data_pipeline.customers_by_transaction
2018-04-17 14:14:59,045: Parsing model.agency_data_pipeline.growth_customer_0_365
2018-04-17 14:14:59,049: Parsing model.agency_data_pipeline.growth_customer_0_365_segment
2018-04-17 14:14:59,054: Parsing model.agency_data_pipeline.growth_date_union
2018-04-17 14:14:59,058: Parsing model.agency_data_pipeline.growth_stats
2018-04-17 14:14:59,069: Parsing model.agency_data_pipeline.retention_0_365
2018-04-17 14:14:59,075: Parsing model.agency_data_pipeline.retention_0_365_new
2018-04-17 14:14:59,080: Parsing model.agency_data_pipeline.retention_0_365_reactivated
2018-04-17 14:14:59,086: Parsing model.agency_data_pipeline.retention_0_365_rebuy
2018-04-17 14:14:59,091: Parsing model.agency_data_pipeline.retention_365_730
2018-04-17 14:14:59,095: Parsing model.agency_data_pipeline.retention_730_plus
2018-04-17 14:14:59,101: Parsing model.agency_data_pipeline.retention_stats
2018-04-17 14:14:59,112: Parsing model.agency_data_pipeline.retention_stats_rebuy_rate
2018-04-17 14:14:59,115: Parsing model.agency_data_pipeline.retention_0_30
2018-04-17 14:14:59,123: Parsing model.agency_data_pipeline.retention_0_30_new
2018-04-17 14:14:59,130: Parsing model.agency_data_pipeline.retention_0_30_reactivated
2018-04-17 14:14:59,138: Parsing model.agency_data_pipeline.retention_0_30_rebuy
2018-04-17 14:14:59,141: Parsing model.agency_data_pipeline.retention_30_60
2018-04-17 14:14:59,145: Parsing model.agency_data_pipeline.retention_60_plus
2018-04-17 14:14:59,148: Parsing model.agency_data_pipeline.retention_stats_month
2018-04-17 14:14:59,155: Parsing model.agency_data_pipeline.retention_stats_rebuy_rate_month
2018-04-17 14:14:59,159: Parsing model.agency_data_pipeline.customers_first_purchase_proc
2018-04-17 14:14:59,162: Parsing model.agency_data_pipeline.customers_proc
2018-04-17 14:14:59,167: Parsing model.agency_data_pipeline.segment_list_customers
2018-04-17 14:14:59,171: Parsing model.agency_data_pipeline.segment_proc_customers
2018-04-17 14:14:59,176: Parsing model.agency_data_pipeline.segment_stats_customers
2018-04-17 14:14:59,179: Parsing model.agency_data_pipeline.segment_stats_customers_agg
2018-04-17 14:14:59,184: Parsing model.agency_data_pipeline.customers_first_purchase_product_type_proc
2018-04-17 14:14:59,186: Parsing model.agency_data_pipeline.customers_products_proc
2018-04-17 14:14:59,190: Parsing model.agency_data_pipeline.segment_list_customers_products
2018-04-17 14:14:59,192: Parsing model.agency_data_pipeline.segment_proc_customers_products
2018-04-17 14:14:59,196: Parsing model.agency_data_pipeline.segment_stats_customers_products
2018-04-17 14:14:59,200: Parsing model.agency_data_pipeline.segment_stats_customers_products_agg
2018-04-17 14:14:59,203: Parsing model.agency_data_pipeline.frequency_proc
2018-04-17 14:14:59,206: Parsing model.agency_data_pipeline.frequency_stats
2018-04-17 14:14:59,209: Parsing model.agency_data_pipeline.order_paths_agg
2018-04-17 14:14:59,212: Parsing model.agency_data_pipeline.order_paths_proc
2018-04-17 14:14:59,215: Parsing model.agency_data_pipeline.order_paths_stats
2018-04-17 14:14:59,218: Parsing model.agency_data_pipeline.products_proc
2018-04-17 14:14:59,220: Parsing model.agency_data_pipeline.segment_proc_sku
2018-04-17 14:14:59,223: Parsing model.agency_data_pipeline.segment_stats_category
2018-04-17 14:14:59,225: Parsing model.agency_data_pipeline.segment_stats_sku
2018-04-17 14:14:59,280: Found 91 models, 0 tests, 0 archives, 0 analyses, 46 macros, 0 operations
2018-04-17 14:14:59,438: 
2018-04-17 14:15:01,024: 14:15:01 | Concurrency: 4 threads (target='prod')
2018-04-17 14:15:01,024: 14:15:01 | 
2018-04-17 14:15:01,809: 14:15:01 | 1 of 91 START table model agency_data_pipeline.bing_ads_impression_share [RUN]
2018-04-17 14:15:01,809: Compiling model.agency_data_pipeline.bing_ads_impression_share
2018-04-17 14:15:01,809: 14:15:01 | 2 of 91 START table model agency_data_pipeline.monthend_dates........ [RUN]
2018-04-17 14:15:01,815: Compiling model.agency_data_pipeline.monthend_dates
2018-04-17 14:15:01,809: 14:15:01 | 3 of 91 START table model agency_data_pipeline.bing_ads_ads.......... [RUN]
2018-04-17 14:15:01,817: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_impression_share"
2018-04-17 14:15:01,822: Writing injected SQL for node "model.agency_data_pipeline.monthend_dates"
2018-04-17 14:15:01,822: Compiling model.agency_data_pipeline.bing_ads_ads
2018-04-17 14:15:01,809: 14:15:01 | 4 of 91 START table model agency_data_pipeline.accounts_proc......... [RUN]
2018-04-17 14:15:01,829: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_ads"
2018-04-17 14:15:01,830: Compiling model.agency_data_pipeline.accounts_proc
2018-04-17 14:15:01,831: Acquiring new bigquery connection "bing_ads_impression_share".
2018-04-17 14:15:01,836: Writing injected SQL for node "model.agency_data_pipeline.accounts_proc"
2018-04-17 14:15:01,837: Acquiring new bigquery connection "monthend_dates".
2018-04-17 14:15:01,838: Opening a new connection (1 currently allocated)
2018-04-17 14:15:01,839: Acquiring new bigquery connection "bing_ads_ads".
2018-04-17 14:15:01,841: Acquiring new bigquery connection "accounts_proc".
2018-04-17 14:15:01,842: Opening a new connection (2 currently allocated)
2018-04-17 14:15:01,921: Opening a new connection (3 currently allocated)
2018-04-17 14:15:01,924: Opening a new connection (4 currently allocated)
2018-04-17 14:15:03,450: Model SQL (bing_ads_impression_share):
SELECT 
date, 
account,
channel,
platform,
sum(impressions) impressions,
sum(available_impressions) available_impressions
FROM

(

SELECT  
cast(gregoriandate as date) date,
replace(accountname,',','') account,  
'Paid' as channel,
'Bing Ads' as platform,
case when impressionsharepercent is null then 0 else impressions end as impressions,
cast(round(case when ( impressionsharepercent is not null and impressionsharepercent > 0 ) then (impressions*100)/impressionsharepercent else 0 end) as int64) as available_impressions,
_sdc_sequence,
first_value(_sdc_sequence) OVER (PARTITION BY campaignid, gregoriandate ORDER BY _sdc_sequence DESC) lv
FROM `growth-engines-pipeline.bing_ads.campaign_performance_report` 

)

where lv = _sdc_sequence
group by date, account, channel, platform
2018-04-17 14:15:03,500: Model SQL (monthend_dates):
SELECT
date_in_range,
date_in_range_bom,
date_in_range_bom_mom,
unix_date_in_range,
unix_date_in_range_bom,
unix_date(date_in_range_bom_mom) unix_date_in_range_bom_mom,
yyyymm,
date_in_range_yoy,
unix_date(date_in_range_yoy) unix_date_in_range_yoy

FROM
(
	SELECT 
	date_in_range,
	date_in_range_bom,
	date_sub(date_in_range_bom, INTERVAL 1 MONTH) date_in_range_bom_mom,
  date_sub(date_in_range, INTERVAL 1 YEAR) date_in_range_yoy,
	unix_date_in_range,
	unix_date(date_in_range_bom) unix_date_in_range_bom,
	yyyymm,
	first_value(date_in_range) over (partition by yyyymm order by date_in_range desc) monthend_date_in_range
	FROM
	( 
		SELECT 
		date_in_range,
		date_trunc( date_in_range, MONTH) date_in_range_bom,
		unix_date(date_in_range) unix_date_in_range,
		format_date("%Y-%m", date_in_range) AS yyyymm
		FROM UNNEST(
		    GENERATE_DATE_ARRAY(DATE('2016-01-31'), CURRENT_DATE(), INTERVAL 1 DAY)
		) AS date_in_range
	)
)
where date_in_range = monthend_date_in_range
2018-04-17 14:15:03,507: Model SQL (bing_ads_ads):
select
date, 
account, 
channel,
platform,
campaignid,
campaignname,
max(lower(trim(replace(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$','' ),'.html',''),'/'))) as url,
utm_campaign,
sum(cost) as cost,
sum(impressions) as impressions,
sum(clicks) as clicks,
sum(conversions) as conversions
from 
  ( 
SELECT  
cast(gregoriandate as date) date,
replace(accountname,',','') account,
'Paid' as channel,
'Bing Ads' as platform,
adid,
adtype,
campaignid, 
campaignname,
finalurl url,
case when regexp_contains(destinationurl, 'utm_campaign')
	then replace(lower(nullif(
  

    split(
        
  

    split(
        destinationurl,
        'utm_campaign='
        )[offset(1)]


,
        '&'
        )[offset(0)]


,'')),'+',' ') 
	else null end as utm_campaign,
spend cost, 
impressions, 
clicks, 
conversions,
_sdc_sequence,
first_value(_sdc_sequence) OVER (PARTITION BY adid, gregoriandate ORDER BY _sdc_sequence DESC) lv
FROM `growth-engines-pipeline.bing_ads.ad_performance_report` 
  )

where lv = _sdc_sequence
group by date, account, channel, platform, campaignid, campaignname, utm_campaign
2018-04-17 14:15:03,576: Model SQL (accounts_proc):
select 
client,
account,
platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.accounts` 

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-04-17 14:15:04,624: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6a01a777-7ab7-430d-b8a1-d5ded90f0bca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109c21080>]}
2018-04-17 14:15:04,888: 14:15:04 | 2 of 91 OK created table model agency_data_pipeline.monthend_dates... [CREATE TABLE in 2.81s]
2018-04-17 14:15:04,888: 14:15:04 | 5 of 91 START table model agency_data_pipeline.conversion_goals_proc. [RUN]
2018-04-17 14:15:04,888: Compiling model.agency_data_pipeline.conversion_goals_proc
2018-04-17 14:15:04,897: Writing injected SQL for node "model.agency_data_pipeline.conversion_goals_proc"
2018-04-17 14:15:04,898: Acquiring new bigquery connection "conversion_goals_proc".
2018-04-17 14:15:04,898: Re-using an available connection from the pool.
2018-04-17 14:15:05,672: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6a01a777-7ab7-430d-b8a1-d5ded90f0bca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109cd4748>]}
2018-04-17 14:15:05,709: Model SQL (conversion_goals_proc):
select 
client,
platform,
goal_name,
max(goal_type) goal_type,
account,
max(time_of_entry) time_of_entry
from  ( 

SELECT  
client,
platform,
trim(replace(replace(lower(goal_name),',',''),' ','')) goal_name,
goal_type,
account,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY platform ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.conversion_goals` 

) 

WHERE lv = time_of_entry
group by client, platform, account, goal_name
2018-04-17 14:15:05,720: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6a01a777-7ab7-430d-b8a1-d5ded90f0bca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107008400>]}
2018-04-17 14:15:05,920: 14:15:05 | 1 of 91 OK created table model agency_data_pipeline.bing_ads_impression_share [CREATE TABLE in 3.86s]
2018-04-17 14:15:05,926: 14:15:05 | 6 of 91 START table model agency_data_pipeline.adwords_campaigns..... [RUN]
2018-04-17 14:15:05,926: Compiling model.agency_data_pipeline.adwords_campaigns
2018-04-17 14:15:05,936: Writing injected SQL for node "model.agency_data_pipeline.adwords_campaigns"
2018-04-17 14:15:05,942: Acquiring new bigquery connection "adwords_campaigns".
2018-04-17 14:15:05,942: Re-using an available connection from the pool.
2018-04-17 14:15:05,975: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6a01a777-7ab7-430d-b8a1-d5ded90f0bca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109c9beb8>]}
2018-04-17 14:15:06,181: 14:15:06 | 3 of 91 OK created table model agency_data_pipeline.bing_ads_ads..... [CREATE TABLE in 3.90s]
2018-04-17 14:15:06,183: 14:15:06 | 7 of 91 START table model agency_data_pipeline.carts_proc............ [RUN]
2018-04-17 14:15:06,184: Compiling model.agency_data_pipeline.carts_proc
2018-04-17 14:15:06,195: Writing injected SQL for node "model.agency_data_pipeline.carts_proc"
2018-04-17 14:15:06,200: Acquiring new bigquery connection "carts_proc".
2018-04-17 14:15:06,200: Re-using an available connection from the pool.
2018-04-17 14:15:06,453: 14:15:06 | 4 of 91 OK created table model agency_data_pipeline.accounts_proc.... [CREATE TABLE in 4.15s]
2018-04-17 14:15:06,453: 14:15:06 | 8 of 91 START table model agency_data_pipeline.ga_conversions........ [RUN]
2018-04-17 14:15:06,453: Compiling model.agency_data_pipeline.ga_conversions
2018-04-17 14:15:06,458: Writing injected SQL for node "model.agency_data_pipeline.ga_conversions"
2018-04-17 14:15:06,461: Acquiring new bigquery connection "ga_conversions".
2018-04-17 14:15:06,461: Re-using an available connection from the pool.
2018-04-17 14:15:06,771: Model SQL (adwords_campaigns):
select
day,
campaignid, 
campaign,
account, 
channel,
platform,
sum(cost) cost,
sum(impressions) impressions,
sum(clicks) clicks,
sum(impression_share_num) impression_share_num,
sum(impression_share_den) impression_share_den
from 
  ( 
	SELECT  
	day,
	campaignid,
	campaign,
	account as account,
	'Paid' as channel,
	'Adwords' as platform,
	cost/1000000 cost, 
	impressions as impressions, 
	clicks, 
	case when searchimprshare is not null then impressions end as impression_share_num,
	case when searchimprshare is not null then impressions/(searchimprshare/100) end as impression_share_den,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY campaignid, day ORDER BY _sdc_sequence DESC) lv
	FROM `growth-engines-pipeline.adwords_2.CAMPAIGN_PERFORMANCE_REPORT`
  )
where lv = _sdc_sequence
group by day, campaignid, account, channel, platform, campaign
2018-04-17 14:15:06,840: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6a01a777-7ab7-430d-b8a1-d5ded90f0bca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109c21080>]}
2018-04-17 14:15:07,070: Model SQL (carts_proc):
select 
client,
client_name,
account,
platform
from  ( 

SELECT  
client,
client_name,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.accounts`
WHERE platform in ('Shopify', 'Custom cart')

) 

WHERE lv = time_of_entry
2018-04-17 14:15:07,095: 14:15:07 | 5 of 91 OK created table model agency_data_pipeline.conversion_goals_proc [CREATE TABLE in 1.95s]
2018-04-17 14:15:07,096: 14:15:07 | 9 of 91 START table model agency_data_pipeline.adwords_urls.......... [RUN]
2018-04-17 14:15:07,096: Compiling model.agency_data_pipeline.adwords_urls
2018-04-17 14:15:07,101: Writing injected SQL for node "model.agency_data_pipeline.adwords_urls"
2018-04-17 14:15:07,102: Acquiring new bigquery connection "adwords_urls".
2018-04-17 14:15:07,102: Re-using an available connection from the pool.
2018-04-17 14:15:07,295: Model SQL (ga_conversions):
select 
client,
client_name,
platform,
goal_name,
goal_type,
account,
time_of_entry
from  ( 

SELECT  
client,
client_name,
platform,
trim(goal_name) goal_name,
goal_type,
account,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform, goal_name ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.conversion_goals` 
WHERE platform = 'Google Analytics'

) 

WHERE lv = time_of_entry
2018-04-17 14:15:07,919: Model SQL (adwords_urls):
SELECT
campaignid,
lower(trim(regexp_replace(replace(replace(replace(replace(finalurl,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url

FROM (

SELECT  
campaignid,
finalurl,
first_value(finalurl) OVER (PARTITION BY campaignid ORDER BY day DESC) lv
FROM `growth-engines-pipeline.adwords_2.FINAL_URL_REPORT`
)

WHERE lv = finalurl
group by campaignid, url
order by campaignid asc
2018-04-17 14:15:09,528: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6a01a777-7ab7-430d-b8a1-d5ded90f0bca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109c9beb8>]}
2018-04-17 14:15:10,122: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6a01a777-7ab7-430d-b8a1-d5ded90f0bca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109c21080>]}
2018-04-17 14:15:10,200: 14:15:10 | 8 of 91 OK created table model agency_data_pipeline.ga_conversions... [CREATE TABLE in 3.07s]
2018-04-17 14:15:10,201: 14:15:10 | 10 of 91 START table model agency_data_pipeline.clients_proc......... [RUN]
2018-04-17 14:15:10,201: Compiling model.agency_data_pipeline.clients_proc
2018-04-17 14:15:10,211: Writing injected SQL for node "model.agency_data_pipeline.clients_proc"
2018-04-17 14:15:10,215: Acquiring new bigquery connection "clients_proc".
2018-04-17 14:15:10,216: Re-using an available connection from the pool.
2018-04-17 14:15:10,525: 14:15:10 | 9 of 91 OK created table model agency_data_pipeline.adwords_urls..... [CREATE TABLE in 3.03s]
2018-04-17 14:15:10,525: 14:15:10 | 11 of 91 START table model agency_data_pipeline.all_dates............ [RUN]
2018-04-17 14:15:10,525: Compiling model.agency_data_pipeline.all_dates
2018-04-17 14:15:10,534: Writing injected SQL for node "model.agency_data_pipeline.all_dates"
2018-04-17 14:15:10,535: Acquiring new bigquery connection "all_dates".
2018-04-17 14:15:10,535: Re-using an available connection from the pool.
2018-04-17 14:15:11,011: Model SQL (clients_proc):
select 
client,
client_name,
account,
platform
from  ( 

SELECT  
client,
client_name,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.accounts`
where client_name != ''
) 

WHERE lv = time_of_entry
2018-04-17 14:15:11,287: Model SQL (all_dates):
SELECT 
date_in_range,
unix_date(date_in_range) unix_date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-04-17 14:15:12,122: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6a01a777-7ab7-430d-b8a1-d5ded90f0bca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109c9beb8>]}
2018-04-17 14:15:12,381: 14:15:12 | 10 of 91 OK created table model agency_data_pipeline.clients_proc.... [CREATE TABLE in 1.92s]
2018-04-17 14:15:12,381: 14:15:12 | 12 of 91 START table model agency_data_pipeline.adwords_conversions.. [RUN]
2018-04-17 14:15:12,382: Compiling model.agency_data_pipeline.adwords_conversions
2018-04-17 14:15:12,388: Writing injected SQL for node "model.agency_data_pipeline.adwords_conversions"
2018-04-17 14:15:12,388: Acquiring new bigquery connection "adwords_conversions".
2018-04-17 14:15:12,388: Re-using an available connection from the pool.
2018-04-17 14:15:12,409: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6a01a777-7ab7-430d-b8a1-d5ded90f0bca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109c21080>]}
2018-04-17 14:15:12,463: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6a01a777-7ab7-430d-b8a1-d5ded90f0bca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109cd4748>]}
2018-04-17 14:15:12,665: 14:15:12 | 11 of 91 OK created table model agency_data_pipeline.all_dates....... [CREATE TABLE in 1.88s]
2018-04-17 14:15:12,909: 14:15:12 | 6 of 91 OK created table model agency_data_pipeline.adwords_campaigns [CREATE TABLE in 6.54s]
2018-04-17 14:15:13,328: Model SQL (adwords_conversions):
select 
client,
client_name,
platform,
goal_name,
goal_type,
account,
time_of_entry
from  ( 

SELECT  
client,
client_name,
platform,
trim(lower(goal_name)) goal_name,
goal_type,
account,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform, goal_name ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.conversion_goals` 
WHERE platform = 'Adwords'

) 

WHERE lv = time_of_entry
2018-04-17 14:15:14,436: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6a01a777-7ab7-430d-b8a1-d5ded90f0bca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109c9beb8>]}
2018-04-17 14:15:14,683: 14:15:14 | 12 of 91 OK created table model agency_data_pipeline.adwords_conversions [CREATE TABLE in 2.05s]
2018-04-17 14:15:36,395: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6a01a777-7ab7-430d-b8a1-d5ded90f0bca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107008400>]}
2018-04-17 14:15:36,673: 14:15:36 | 7 of 91 OK created table model agency_data_pipeline.carts_proc....... [CREATE TABLE in 30.21s]
2018-04-17 14:15:36,675: 14:15:36 | 13 of 91 START table model agency_data_pipeline.bing_ads_conversions. [RUN]
2018-04-17 14:15:36,676: Compiling model.agency_data_pipeline.bing_ads_conversions
2018-04-17 14:15:36,675: 14:15:36 | 14 of 91 START table model agency_data_pipeline.shopify_refunds_proc. [RUN]
2018-04-17 14:15:36,675: 14:15:36 | 15 of 91 START table model agency_data_pipeline.fb_adcreative........ [RUN]
2018-04-17 14:15:36,687: Compiling model.agency_data_pipeline.shopify_refunds_proc
2018-04-17 14:15:36,692: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_conversions"
2018-04-17 14:15:36,692: Compiling model.agency_data_pipeline.fb_adcreative
2018-04-17 14:15:36,705: Acquiring new bigquery connection "shopify_refunds_proc".
2018-04-17 14:15:36,711: Acquiring new bigquery connection "bing_ads_conversions".
2018-04-17 14:15:36,716: Acquiring new bigquery connection "fb_adcreative".
2018-04-17 14:15:36,675: 14:15:36 | 16 of 91 START table model agency_data_pipeline.fb_ads_insights...... [RUN]
2018-04-17 14:15:36,717: Re-using an available connection from the pool.
2018-04-17 14:15:36,717: Compiling model.agency_data_pipeline.fb_ads_insights
2018-04-17 14:15:36,718: Fetching data for query shopify_refunds_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 14:15:36,718: Re-using an available connection from the pool.
2018-04-17 14:15:36,726: Re-using an available connection from the pool.
2018-04-17 14:15:36,726: Fetching data for query fb_adcreative:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 14:15:36,803: Acquiring new bigquery connection "fb_ads_insights".
2018-04-17 14:15:36,803: Re-using an available connection from the pool.
2018-04-17 14:15:36,804: Fetching data for query fb_ads_insights:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 14:15:37,752: Model SQL (bing_ads_conversions):
SELECT
date, 
a.account account, 
a.channel channel,
a.platform platform,
campaignid,
campaignname,
sum( case when b.goal_type = 'Transactions' then conversions else 0 end ) as transactions
FROM

  ( 
SELECT  
cast(gregoriandate as date) date,
replace(accountname,',','') account,
'Paid' as channel,
'Bing Ads' as platform,
trim(replace(replace(lower(goal),',',''),' ','')) goal,
goalid,
campaignid,
campaignname,
conversions,
_sdc_sequence,
first_value(_sdc_sequence) OVER (PARTITION BY campaignid, goalid, gregoriandate ORDER BY _sdc_sequence DESC) lv
FROM `growth-engines-pipeline.bing_ads.goals_and_funnels_report` 

  ) a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`conversion_goals_proc` b
ON (
	a.account = b.account AND
	a.platform = b.platform AND
	a.goal = b.goal_name
)
where a.lv = a._sdc_sequence
group by date, account, channel, platform, campaignid, campaignname
2018-04-17 14:15:37,990: Writing injected SQL for node "model.agency_data_pipeline.shopify_refunds_proc"
2018-04-17 14:15:38,069: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_insights"
2018-04-17 14:15:38,209: Writing injected SQL for node "model.agency_data_pipeline.fb_adcreative"
2018-04-17 14:15:38,916: Model SQL (fb_ads_insights):




with fb_ads_insights as (

	    
		   	SELECT 
			date_start,
			campaign_id,
			campaign_name,
			ad_id,
			account_name,
			spend,
			reach,
			inline_link_clicks,
			_sdc_sequence,
			first_value(_sdc_sequence) OVER (PARTITION BY date_start, ad_id, campaign_id ORDER BY _sdc_sequence DESC) lv
			FROM `growth-engines-pipeline.fb_ads_luca_danni.ads_insights`
		    
	   

)

select
date_start date,
campaign_id,
campaign_name campaign,
ad_id,
account_name account,
max(spend) cost,
max(reach) impressions,
max(inline_link_clicks) clicks
from fb_ads_insights
where lv = _sdc_sequence
group by date, campaign_id, ad_id, account, campaign


2018-04-17 14:15:38,972: Model SQL (shopify_refunds_proc):




with refunds as (

	
	SELECT
	order_number,
	checkout_id,
	financial_status,
	line_item_id,
	quantity,
	subtotal,
	line_item.variant_id variant_id,
	line_item.id refund_id,
 	_sdc_sequence
	FROM `growth-engines-pipeline.shopify_lucadanni.orders` 
	cross join unnest(refunds), unnest(refund_line_items)
  	where financial_status like '%refund%'
	
	

)

SELECT * 
FROM 
	(
    SELECT
	order_number,
	checkout_id,
	financial_status,
	line_item_id,
	quantity,
	subtotal refund_amount,
	variant_id,
	refund_id,
 	_sdc_sequence,
    first_value(_sdc_sequence) OVER (PARTITION BY order_number, line_item_id ORDER BY _sdc_sequence DESC) lv
    FROM refunds
   	) 
WHERE lv = _sdc_sequence


2018-04-17 14:15:39,090: Model SQL (fb_adcreative):




with fb_adcreative as (


	    
		   	SELECT 
			id,
			object_url,
			url_tags,
			_sdc_sequence
			FROM `growth-engines-pipeline.fb_ads_luca_danni.adcreative`
		    
	   
)

select creative_id, max(url) url
from (
  select
  id creative_id,
  lower(trim(regexp_replace(replace(replace(replace(replace(object_url,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
  first_value(_sdc_sequence) OVER (PARTITION BY id ORDER BY _sdc_sequence DESC) lv,
  _sdc_sequence
  from fb_adcreative
  )
where lv = _sdc_sequence
group by creative_id


2018-04-17 14:15:39,988: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6a01a777-7ab7-430d-b8a1-d5ded90f0bca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109d141d0>]}
2018-04-17 14:15:40,277: 14:15:40 | 13 of 91 OK created table model agency_data_pipeline.bing_ads_conversions [CREATE TABLE in 3.31s]
2018-04-17 14:15:40,277: 14:15:40 | 17 of 91 START table model agency_data_pipeline.adwords_ads.......... [RUN]
2018-04-17 14:15:40,277: Compiling model.agency_data_pipeline.adwords_ads
2018-04-17 14:15:40,288: Writing injected SQL for node "model.agency_data_pipeline.adwords_ads"
2018-04-17 14:15:40,289: Acquiring new bigquery connection "adwords_ads".
2018-04-17 14:15:40,289: Re-using an available connection from the pool.
2018-04-17 14:15:41,144: Model SQL (adwords_ads):
SELECT  
day,
campaignid,
a.account as account,
utm_campaign,
sum( case when b.goal_type = 'Transaction' then conversions else 0 end ) as transactions
FROM (

	SELECT  
	day,
	adid,
	campaignid,
	account,
	lower(conversionname) conversionname,
	conversions,
	lower(campaign) utm_campaign,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY campaignid, day ORDER BY _sdc_sequence DESC) lv
	FROM
	`growth-engines-pipeline.adwords_2.AD_PERFORMANCE_REPORT`

) a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_conversions` b
ON ( a.conversionname = b.goal_name
	AND a.account = b.account )
WHERE lv = _sdc_sequence
group by day, campaignid, account, utm_campaign
2018-04-17 14:15:41,225: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6a01a777-7ab7-430d-b8a1-d5ded90f0bca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109d02b70>]}
2018-04-17 14:15:41,324: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6a01a777-7ab7-430d-b8a1-d5ded90f0bca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10703fac8>]}
2018-04-17 14:15:41,459: 14:15:41 | 14 of 91 OK created table model agency_data_pipeline.shopify_refunds_proc [CREATE TABLE in 4.54s]
2018-04-17 14:15:41,460: 14:15:41 | 18 of 91 START table model agency_data_pipeline.ga_mcf_proc.......... [RUN]
2018-04-17 14:15:41,460: Compiling model.agency_data_pipeline.ga_mcf_proc
2018-04-17 14:15:41,468: Writing injected SQL for node "model.agency_data_pipeline.ga_mcf_proc"
2018-04-17 14:15:41,471: Acquiring new bigquery connection "ga_mcf_proc".
2018-04-17 14:15:41,473: Re-using an available connection from the pool.
2018-04-17 14:15:41,710: 14:15:41 | 15 of 91 OK created table model agency_data_pipeline.fb_adcreative... [CREATE TABLE in 4.63s]
2018-04-17 14:15:41,711: 14:15:41 | 19 of 91 START table model agency_data_pipeline.mappings_ga_proc..... [RUN]
2018-04-17 14:15:41,711: Compiling model.agency_data_pipeline.mappings_ga_proc
2018-04-17 14:15:41,720: Writing injected SQL for node "model.agency_data_pipeline.mappings_ga_proc"
2018-04-17 14:15:41,721: Acquiring new bigquery connection "mappings_ga_proc".
2018-04-17 14:15:41,721: Re-using an available connection from the pool.
2018-04-17 14:15:42,261: Model SQL (ga_mcf_proc):
SELECT 
date,
account,
'Google Analytics' as lookup_platform,
source_medium_path,
trim(lower(split(split(source_medium_path,'->')[SAFE_ORDINAL(1)],'/')[SAFE_ORDINAL(1)])) as source,
trim(lower(split(split(source_medium_path,'->')[SAFE_ORDINAL(1)],'/')[SAFE_ORDINAL(2)])) as medium,
first_interaction_campaign campaign,
cast(regexp_replace(transaction_id, r'#', '') as int64) transactionid,
max(first_interaction_conversions) transactions,
max(first_interaction_conversion_value) revenue
FROM `growth-engines-pipeline.agency_data_pipeline.ga_mcf`
where account in (select account from `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc` where platform = 'Google Analytics')
group by date, account, source, medium, campaign, source_medium_path, lookup_platform, transactionid
2018-04-17 14:15:42,361: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6a01a777-7ab7-430d-b8a1-d5ded90f0bca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10703f048>]}
2018-04-17 14:15:42,463: Model SQL (mappings_ga_proc):
select 
client,
account,
client_name,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
account,
client_name,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.mappings_ga` 

) 

WHERE lv = time_of_entry
and client in (select client from `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc` )
group by client, account, client_name, source, medium, platform_n, channel_n, time_of_entry
2018-04-17 14:15:42,624: 14:15:42 | 16 of 91 OK created table model agency_data_pipeline.fb_ads_insights. [CREATE TABLE in 5.64s]
2018-04-17 14:15:42,624: 14:15:42 | 20 of 91 START table model agency_data_pipeline.fb_ads_insights_conversions [RUN]
2018-04-17 14:15:42,625: Compiling model.agency_data_pipeline.fb_ads_insights_conversions
2018-04-17 14:15:42,637: Acquiring new bigquery connection "fb_ads_insights_conversions".
2018-04-17 14:15:42,637: Re-using an available connection from the pool.
2018-04-17 14:15:42,637: Fetching data for query fb_ads_insights_conversions:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 14:15:43,045: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_insights_conversions"
2018-04-17 14:15:43,444: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6a01a777-7ab7-430d-b8a1-d5ded90f0bca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109d141d0>]}
2018-04-17 14:15:43,673: 14:15:43 | 17 of 91 OK created table model agency_data_pipeline.adwords_ads..... [CREATE TABLE in 3.17s]
2018-04-17 14:15:43,860: Model SQL (fb_ads_insights_conversions):




with fb_ads_insights_conversions as (

	    
		   	SELECT 
			date_start,
			campaign_id,
			campaign_name,
			ad_id,
			account_name,
			spend,
			reach,
			inline_link_clicks,
			_sdc_sequence,
			action_type,
			value
			FROM `growth-engines-pipeline.fb_ads_luca_danni.ads_insights`
			cross join unnest(actions)
		    
	   

)

SELECT * 
FROM 
	(
    SELECT
    date_start date,
    campaign_id,
    campaign_name campaign,
    ad_id,
    account_name account,
    action_type,
    value conversions,
    first_value(_sdc_sequence) OVER (PARTITION BY ad_id, date_start ORDER BY _sdc_sequence DESC) lv,
    _sdc_sequence
    FROM fb_ads_insights_conversions
   	)
where lv = _sdc_sequence
and action_type like '%purchase%'


2018-04-17 14:15:44,702: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6a01a777-7ab7-430d-b8a1-d5ded90f0bca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109d14080>]}
2018-04-17 14:15:44,935: 14:15:44 | 19 of 91 OK created table model agency_data_pipeline.mappings_ga_proc [CREATE TABLE in 2.99s]
2018-04-17 14:15:47,896: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6a01a777-7ab7-430d-b8a1-d5ded90f0bca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109d02b70>]}
2018-04-17 14:15:48,243: 14:15:48 | 18 of 91 OK created table model agency_data_pipeline.ga_mcf_proc..... [CREATE TABLE in 6.44s]
2018-04-17 14:15:48,716: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6a01a777-7ab7-430d-b8a1-d5ded90f0bca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10703f048>]}
2018-04-17 14:15:48,946: 14:15:48 | 20 of 91 OK created table model agency_data_pipeline.fb_ads_insights_conversions [CREATE TABLE in 6.09s]
2018-04-17 14:15:48,946: 14:15:48 | 21 of 91 START table model agency_data_pipeline.shopify_customers_proc [RUN]
2018-04-17 14:15:48,947: 14:15:48 | 22 of 91 START table model agency_data_pipeline.fb_ads............... [RUN]
2018-04-17 14:15:48,947: Compiling model.agency_data_pipeline.shopify_customers_proc
2018-04-17 14:15:48,947: Compiling model.agency_data_pipeline.fb_ads
2018-04-17 14:15:48,956: Acquiring new bigquery connection "shopify_customers_proc".
2018-04-17 14:15:48,961: Re-using an available connection from the pool.
2018-04-17 14:15:48,961: Fetching data for query shopify_customers_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 14:15:48,964: Acquiring new bigquery connection "fb_ads".
2018-04-17 14:15:48,964: Re-using an available connection from the pool.
2018-04-17 14:15:48,964: Fetching data for query fb_ads:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 14:15:49,345: Writing injected SQL for node "model.agency_data_pipeline.fb_ads"
2018-04-17 14:15:49,391: Writing injected SQL for node "model.agency_data_pipeline.shopify_customers_proc"
2018-04-17 14:15:50,319: Model SQL (fb_ads):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`fb_adcreative`





with fb_ads as (

	    
		   	SELECT 
			id ad_id,
			creative.creative_id creative_id,
			_sdc_sequence
			FROM `growth-engines-pipeline.fb_ads_luca_danni.ads`
		     
	   

)

SELECT
a.ad_id,
b.creative_id,
b.url
FROM (
    SELECT
    ad_id,
    creative_id,
    first_value(_sdc_sequence) OVER (PARTITION BY ad_id ORDER BY _sdc_sequence DESC) lv,
    _sdc_sequence
    FROM fb_ads
    ) a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`fb_adcreative` b
ON (
	a.creative_id = b.creative_id 
)
WHERE a.lv = a._sdc_sequence


2018-04-17 14:15:50,424: Model SQL (shopify_customers_proc):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc`





with customers as (

	
	SELECT
	'lucadanni' client_name,
	'Shopify' as lookup_platform,
	cast(created_at as date) created_at,
	id,
	first_name,
	last_name,
	email,
	_sdc_sequence,
	first_value(_sdc_sequence) over (partition by id, _sdc_sequence order by _sdc_sequence desc) lv
	FROM `growth-engines-pipeline.shopify_lucadanni.customers` 
	
	

)

SELECT
account,
client,
platform,
id,
min(created_at) created_at,
max(first_name) first_name,
max(last_name) last_name,
max(email) email
FROM (
	SELECT
	b.account,
	b.client,
	b.platform,
	created_at,
	id,
	first_name,
	last_name,
	email
	FROM customers a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
	ON ( a.client_name = b.client_name
	  AND a.lookup_platform = b.platform )
	where a.lv = a._sdc_sequence
)
group by account, client, platform, id

2018-04-17 14:15:52,564: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6a01a777-7ab7-430d-b8a1-d5ded90f0bca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107008400>]}
2018-04-17 14:15:52,796: 14:15:52 | 22 of 91 OK created table model agency_data_pipeline.fb_ads.......... [CREATE TABLE in 3.62s]
2018-04-17 14:15:54,893: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '6a01a777-7ab7-430d-b8a1-d5ded90f0bca', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109d32be0>]}
2018-04-17 14:15:55,146: 14:15:55 | 21 of 91 OK created table model agency_data_pipeline.shopify_customers_proc [CREATE TABLE in 5.95s]
2018-04-17 14:15:55,147: 14:15:55 | 23 of 91 START table model agency_data_pipeline.ga_mcf_stats......... [RUN]
2018-04-17 14:15:55,147: 14:15:55 | 24 of 91 START table model agency_data_pipeline.bing_ads_stats....... [RUN]
2018-04-17 14:15:55,147: 14:15:55 | 25 of 91 START table model agency_data_pipeline.shopify_products_proc [RUN]
2018-04-17 14:15:55,147: Compiling model.agency_data_pipeline.ga_mcf_stats
2018-04-17 14:15:55,147: 14:15:55 | 26 of 91 START table model agency_data_pipeline.agg_customers_union.. [RUN]
2018-04-17 14:15:55,148: Compiling model.agency_data_pipeline.bing_ads_stats
2018-04-17 14:15:55,148: Compiling model.agency_data_pipeline.shopify_products_proc
2018-04-17 14:15:55,158: Writing injected SQL for node "model.agency_data_pipeline.ga_mcf_stats"
2018-04-17 14:15:55,158: Compiling model.agency_data_pipeline.agg_customers_union
2018-04-17 14:15:55,165: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_stats"
2018-04-17 14:15:55,180: Acquiring new bigquery connection "shopify_products_proc".
2018-04-17 14:15:55,182: Writing injected SQL for node "model.agency_data_pipeline.agg_customers_union"
2018-04-17 14:15:55,183: Acquiring new bigquery connection "ga_mcf_stats".
2018-04-17 14:15:55,184: Re-using an available connection from the pool.
2018-04-17 14:15:55,184: Fetching data for query shopify_products_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 14:15:55,185: Acquiring new bigquery connection "bing_ads_stats".
2018-04-17 14:15:55,185: Re-using an available connection from the pool.
2018-04-17 14:15:55,189: Acquiring new bigquery connection "agg_customers_union".
2018-04-17 14:15:55,193: Re-using an available connection from the pool.
2018-04-17 14:15:55,195: Re-using an available connection from the pool.
2018-04-17 14:15:55,590: Writing injected SQL for node "model.agency_data_pipeline.shopify_products_proc"
2018-04-17 14:15:55,870: Unhandled error while executing None
404 GET https://www.googleapis.com/bigquery/v2/projects/growth-engines-pipeline/datasets/agency_data_pipeline/tables?pageToken=ga_mcf_stats: Not found: Token ga_mcf_stats
2018-04-17 14:15:55,873: 14:15:55 | 27 of 91 START table model agency_data_pipeline.shopify_orders_proc.. [RUN]
2018-04-17 14:15:55,873: Connection 'master' was left open.
2018-04-17 14:15:55,874: Compiling model.agency_data_pipeline.shopify_orders_proc
2018-04-17 14:15:55,874: Connection 'ga_mcf_stats' was left open.
2018-04-17 14:15:55,886: Connection 'bing_ads_stats' was left open.
2018-04-17 14:15:55,888: Acquiring new bigquery connection "shopify_orders_proc".
2018-04-17 14:15:55,888: Connection 'agg_customers_union' was left open.
2018-04-17 14:15:55,889: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107064860>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107052710>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109d14fd0>]}
2018-04-17 14:15:55,890: Opening a new connection (0 currently allocated)
2018-04-17 14:15:55,905: Fetching data for query shopify_orders_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 14:15:56,124: Model SQL (bing_ads_stats):
select
a.date, 
a.account, 
a.channel,
a.platform,
url,
a.campaignname campaign,
utm_campaign,
cost,
clicks,
impressions,
transactions
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`bing_ads_ads` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`bing_ads_conversions` b
ON (
	a.date = b.date AND
	a.account = b.account AND
	a.campaignid = b.campaignid

)
2018-04-17 14:15:56,155: Model SQL (ga_mcf_stats):
SELECT  
date,
a.account account,
b.client client,
case when c.platform is null then "Unmapped" else c.platform end as platform,
case when c.channel is null then "Unmapped" else c.channel end as channel,
lower(a.source) source,
lower(a.medium) medium,
lower(campaign) campaign,
transactionid,
sum(transactions) first_touch_transactions,
sum(revenue) first_touch_revenue
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`ga_mcf_proc` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc` b 
ON ( a.account = b.account and
	a.lookup_platform = b.platform )
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc` c
ON ( lower(a.source) = c.source
  AND lower(a.medium) = c.medium 
  and a.account = c.account )
group by date, account, client, source, medium, campaign, platform, channel, transactionid
2018-04-17 14:15:56,161: Encountered an error:
2018-04-17 14:15:56,161: 404 GET https://www.googleapis.com/bigquery/v2/projects/growth-engines-pipeline/datasets/agency_data_pipeline/tables?pageToken=ga_mcf_stats: Not found: Token ga_mcf_stats
2018-04-17 14:15:56,175: Traceback (most recent call last):
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/main.py", line 40, in main
    results, succeeded = handle_and_check(args)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/main.py", line 84, in handle_and_check
    task, res = run_from_args(parsed)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/main.py", line 138, in run_from_args
    results = run_from_task(task, proj, parsed)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/main.py", line 146, in run_from_task
    result = task.run()
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/task/run.py", line 26, in run
    results = runner.run(query, ModelRunner)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/runner.py", line 221, in run
    return self.run_from_graph(Selector, Runner, query)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/runner.py", line 208, in run_from_graph
    res = self.execute_nodes(linker, Runner, flat_graph, dep_list)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/runner.py", line 133, in execute_nodes
    for result in pool.imap_unordered(self.call_runner, args_list):
  File "/usr/local/opt/python3/Frameworks/Python.framework/Versions/3.6/lib/python3.6/multiprocessing/pool.py", line 735, in next
    raise value
  File "/usr/local/opt/python3/Frameworks/Python.framework/Versions/3.6/lib/python3.6/multiprocessing/pool.py", line 119, in worker
    result = (True, func(*args, **kwds))
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/runner.py", line 82, in call_runner
    result = runner.safe_run(flat_graph, existing)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/node_runners.py", line 139, in safe_run
    raise e
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/node_runners.py", line 108, in safe_run
    result = self.run(compiled_node, existing, flat_graph)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/node_runners.py", line 155, in run
    return self.execute(compiled_node, existing, flat_graph)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/node_runners.py", line 389, in execute
    materialization_macro.get('generator')(context)()
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/clients/jinja.py", line 51, in call
    return macro(*args, **kwargs)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/runtime.py", line 549, in __call__
    return self._invoke(arguments, autoescape)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/asyncsupport.py", line 110, in _invoke
    return original_invoke(self, arguments, autoescape)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/runtime.py", line 553, in _invoke
    rv = self._func(*arguments)
  File "<template>", line 55, in macro
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/sandbox.py", line 427, in call
    return __context.call(__obj, *args, **kwargs)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/runtime.py", line 260, in call
    return __obj(*args, **kwargs)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/context/common.py", line 48, in wrapped
    return getattr(self.adapter, fn)(*args, **kwargs)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/adapters/bigquery.py", line 154, in query_for_existing
    all_tables.extend(dataset.list_tables())
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/google/cloud/iterator.py", line 218, in _items_iter
    for page in self._page_iter(increment=False):
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/google/cloud/iterator.py", line 254, in _page_iter
    page = self._next_page()
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/google/cloud/iterator.py", line 348, in _next_page
    response = self._get_next_page_response()
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/google/cloud/iterator.py", line 399, in _get_next_page_response
    query_params=params)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/google/cloud/_http.py", line 293, in api_request
    raise exceptions.from_http_response(response)
google.cloud.exceptions.NotFound: 404 GET https://www.googleapis.com/bigquery/v2/projects/growth-engines-pipeline/datasets/agency_data_pipeline/tables?pageToken=ga_mcf_stats: Not found: Token ga_mcf_stats

2018-04-17 14:15:56,223: Model SQL (agg_customers_union):
SELECT *
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`shopify_customers_proc`
2018-04-17 14:18:36,856: Tracking: tracking
2018-04-17 14:18:36,858: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107e78588>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107e78828>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107e78ba8>]}
2018-04-17 14:18:37,984: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-04-17 14:18:38,004: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/growth-engines/dbt_modules
2018-04-17 14:18:38,011: Parsing get_column_values.sql
2018-04-17 14:18:38,035: Parsing get_url_parameter.sql
2018-04-17 14:18:38,042: Parsing split_part.sql
2018-04-17 14:18:38,058: Parsing table_exists.sql
2018-04-17 14:18:38,075: Parsing core.sql
2018-04-17 14:18:38,100: Parsing adapters/bigquery.sql
2018-04-17 14:18:38,107: Parsing adapters/common.sql
2018-04-17 14:18:38,128: Parsing adapters/postgres.sql
2018-04-17 14:18:38,137: Parsing adapters/redshift.sql
2018-04-17 14:18:38,161: Parsing etc/get_custom_schema.sql
2018-04-17 14:18:38,169: Parsing materializations/archive.sql
2018-04-17 14:18:38,205: Parsing materializations/bigquery.sql
2018-04-17 14:18:38,227: Parsing materializations/helpers.sql
2018-04-17 14:18:38,245: Parsing materializations/incremental.sql
2018-04-17 14:18:38,274: Parsing materializations/table.sql
2018-04-17 14:18:38,295: Parsing materializations/view.sql
2018-04-17 14:18:38,322: Parsing materializations/wrapper.sql
2018-04-17 14:18:38,330: Parsing schema_tests/accepted_values.sql
2018-04-17 14:18:38,339: Parsing schema_tests/not_null.sql
2018-04-17 14:18:38,345: Parsing schema_tests/relationships.sql
2018-04-17 14:18:38,353: Parsing schema_tests/unique.sql
2018-04-17 14:18:38,437: Parsing model.agency_data_pipeline.accounts_proc
2018-04-17 14:18:38,439: Parsing model.agency_data_pipeline.all_dates
2018-04-17 14:18:38,440: Parsing model.agency_data_pipeline.carts_proc
2018-04-17 14:18:38,442: Parsing model.agency_data_pipeline.clients_proc
2018-04-17 14:18:38,444: Parsing model.agency_data_pipeline.conversion_goals_proc
2018-04-17 14:18:38,445: Parsing model.agency_data_pipeline.mappings_ga_proc
2018-04-17 14:18:38,447: Acquiring new bigquery connection "master".
2018-04-17 14:18:38,447: Opening a new connection (0 currently allocated)
2018-04-17 14:18:38,451: Parsing model.agency_data_pipeline.monthend_dates
2018-04-17 14:18:38,453: Parsing model.agency_data_pipeline.adwords_ads
2018-04-17 14:18:38,455: Parsing model.agency_data_pipeline.adwords_campaigns
2018-04-17 14:18:38,456: Parsing model.agency_data_pipeline.adwords_conversions
2018-04-17 14:18:38,458: Parsing model.agency_data_pipeline.adwords_impression_share
2018-04-17 14:18:38,459: Parsing model.agency_data_pipeline.adwords_join
2018-04-17 14:18:38,462: Parsing model.agency_data_pipeline.adwords_stats
2018-04-17 14:18:38,463: Parsing model.agency_data_pipeline.adwords_urls
2018-04-17 14:18:38,465: Parsing model.agency_data_pipeline.bing_ads_ads
2018-04-17 14:18:38,468: Parsing model.agency_data_pipeline.bing_ads_conversions
2018-04-17 14:18:38,470: Parsing model.agency_data_pipeline.bing_ads_impression_share
2018-04-17 14:18:38,472: Parsing model.agency_data_pipeline.bing_ads_stats
2018-04-17 14:18:38,473: Parsing model.agency_data_pipeline.fb_adcreative
2018-04-17 14:18:38,478: Parsing model.agency_data_pipeline.fb_ads
2018-04-17 14:18:38,484: Parsing model.agency_data_pipeline.fb_ads_insights
2018-04-17 14:18:38,489: Parsing model.agency_data_pipeline.fb_ads_insights_conversions
2018-04-17 14:18:38,495: Parsing model.agency_data_pipeline.fb_ads_stats
2018-04-17 14:18:38,498: Parsing model.agency_data_pipeline.ga_conversions
2018-04-17 14:18:38,500: Parsing model.agency_data_pipeline.ga_traffic
2018-04-17 14:18:38,511: Parsing model.agency_data_pipeline.ga_transactions
2018-04-17 14:18:38,525: Parsing model.agency_data_pipeline.ga_mcf_proc
2018-04-17 14:18:38,528: Parsing model.agency_data_pipeline.ga_mcf_stats
2018-04-17 14:18:38,531: Parsing model.agency_data_pipeline.shopify_customers_proc
2018-04-17 14:18:38,537: Parsing model.agency_data_pipeline.shopify_orders_proc
2018-04-17 14:18:38,544: Parsing model.agency_data_pipeline.shopify_products_proc
2018-04-17 14:18:38,550: Parsing model.agency_data_pipeline.shopify_refunds_proc
2018-04-17 14:18:38,555: Parsing model.agency_data_pipeline.agg_campaign
2018-04-17 14:18:38,558: Parsing model.agency_data_pipeline.agg_customers_union
2018-04-17 14:18:38,560: Parsing model.agency_data_pipeline.agg_ga_campaign
2018-04-17 14:18:38,562: Parsing model.agency_data_pipeline.agg_ga_campaign_by_type
2018-04-17 14:18:38,565: Parsing model.agency_data_pipeline.agg_ga_transaction
2018-04-17 14:18:38,568: Parsing model.agency_data_pipeline.agg_ga_transaction_order_number
2018-04-17 14:18:38,571: Parsing model.agency_data_pipeline.agg_orders_union
2018-04-17 14:18:38,572: Parsing model.agency_data_pipeline.agg_platform_monthly
2018-04-17 14:18:38,574: Parsing model.agency_data_pipeline.agg_platforms_client
2018-04-17 14:18:38,576: Parsing model.agency_data_pipeline.agg_platforms_union
2018-04-17 14:18:38,578: Parsing model.agency_data_pipeline.agg_products
2018-04-17 14:18:38,580: Parsing model.agency_data_pipeline.agg_transaction
2018-04-17 14:18:38,583: Parsing model.agency_data_pipeline.agg_transaction_daily
2018-04-17 14:18:38,585: Parsing model.agency_data_pipeline.agg_transaction_line_item
2018-04-17 14:18:38,586: Parsing model.agency_data_pipeline.agg_transaction_line_item_type
2018-04-17 14:18:38,589: Parsing model.agency_data_pipeline.agg_transaction_order_number
2018-04-17 14:18:38,590: Parsing model.agency_data_pipeline.agg_transaction_product_type
2018-04-17 14:18:38,592: Parsing model.agency_data_pipeline.customers_by_transaction
2018-04-17 14:18:38,594: Parsing model.agency_data_pipeline.growth_customer_0_365
2018-04-17 14:18:38,596: Parsing model.agency_data_pipeline.growth_customer_0_365_segment
2018-04-17 14:18:38,599: Parsing model.agency_data_pipeline.growth_date_union
2018-04-17 14:18:38,602: Parsing model.agency_data_pipeline.growth_stats
2018-04-17 14:18:38,607: Parsing model.agency_data_pipeline.retention_0_365
2018-04-17 14:18:38,610: Parsing model.agency_data_pipeline.retention_0_365_new
2018-04-17 14:18:38,613: Parsing model.agency_data_pipeline.retention_0_365_reactivated
2018-04-17 14:18:38,615: Parsing model.agency_data_pipeline.retention_0_365_rebuy
2018-04-17 14:18:38,617: Parsing model.agency_data_pipeline.retention_365_730
2018-04-17 14:18:38,620: Parsing model.agency_data_pipeline.retention_730_plus
2018-04-17 14:18:38,622: Parsing model.agency_data_pipeline.retention_stats
2018-04-17 14:18:38,627: Parsing model.agency_data_pipeline.retention_stats_rebuy_rate
2018-04-17 14:18:38,630: Parsing model.agency_data_pipeline.retention_0_30
2018-04-17 14:18:38,632: Parsing model.agency_data_pipeline.retention_0_30_new
2018-04-17 14:18:38,634: Parsing model.agency_data_pipeline.retention_0_30_reactivated
2018-04-17 14:18:38,637: Parsing model.agency_data_pipeline.retention_0_30_rebuy
2018-04-17 14:18:38,639: Parsing model.agency_data_pipeline.retention_30_60
2018-04-17 14:18:38,641: Parsing model.agency_data_pipeline.retention_60_plus
2018-04-17 14:18:38,643: Parsing model.agency_data_pipeline.retention_stats_month
2018-04-17 14:18:38,648: Parsing model.agency_data_pipeline.retention_stats_rebuy_rate_month
2018-04-17 14:18:38,651: Parsing model.agency_data_pipeline.customers_first_purchase_proc
2018-04-17 14:18:38,654: Parsing model.agency_data_pipeline.customers_proc
2018-04-17 14:18:38,659: Parsing model.agency_data_pipeline.segment_list_customers
2018-04-17 14:18:38,662: Parsing model.agency_data_pipeline.segment_proc_customers
2018-04-17 14:18:38,665: Parsing model.agency_data_pipeline.segment_stats_customers
2018-04-17 14:18:38,667: Parsing model.agency_data_pipeline.segment_stats_customers_agg
2018-04-17 14:18:38,669: Parsing model.agency_data_pipeline.customers_first_purchase_product_type_proc
2018-04-17 14:18:38,671: Parsing model.agency_data_pipeline.customers_products_proc
2018-04-17 14:18:38,674: Parsing model.agency_data_pipeline.segment_list_customers_products
2018-04-17 14:18:38,676: Parsing model.agency_data_pipeline.segment_proc_customers_products
2018-04-17 14:18:38,678: Parsing model.agency_data_pipeline.segment_stats_customers_products
2018-04-17 14:18:38,680: Parsing model.agency_data_pipeline.segment_stats_customers_products_agg
2018-04-17 14:18:38,684: Parsing model.agency_data_pipeline.frequency_proc
2018-04-17 14:18:38,688: Parsing model.agency_data_pipeline.frequency_stats
2018-04-17 14:18:38,691: Parsing model.agency_data_pipeline.order_paths_agg
2018-04-17 14:18:38,694: Parsing model.agency_data_pipeline.order_paths_proc
2018-04-17 14:18:38,696: Parsing model.agency_data_pipeline.order_paths_stats
2018-04-17 14:18:38,699: Parsing model.agency_data_pipeline.products_proc
2018-04-17 14:18:38,701: Parsing model.agency_data_pipeline.segment_proc_sku
2018-04-17 14:18:38,703: Parsing model.agency_data_pipeline.segment_stats_category
2018-04-17 14:18:38,705: Parsing model.agency_data_pipeline.segment_stats_sku
2018-04-17 14:18:38,732: Found 91 models, 0 tests, 0 archives, 0 analyses, 46 macros, 0 operations
2018-04-17 14:18:38,795: 
2018-04-17 14:18:40,620: 14:18:40 | Concurrency: 4 threads (target='prod')
2018-04-17 14:18:40,621: 14:18:40 | 
2018-04-17 14:18:41,280: 14:18:41 | 1 of 91 START table model agency_data_pipeline.monthend_dates........ [RUN]
2018-04-17 14:18:41,281: Compiling model.agency_data_pipeline.monthend_dates
2018-04-17 14:18:41,285: Writing injected SQL for node "model.agency_data_pipeline.monthend_dates"
2018-04-17 14:18:41,281: 14:18:41 | 2 of 91 START table model agency_data_pipeline.conversion_goals_proc. [RUN]
2018-04-17 14:18:41,281: 14:18:41 | 3 of 91 START table model agency_data_pipeline.carts_proc............ [RUN]
2018-04-17 14:18:41,285: Compiling model.agency_data_pipeline.conversion_goals_proc
2018-04-17 14:18:41,281: 14:18:41 | 4 of 91 START table model agency_data_pipeline.accounts_proc......... [RUN]
2018-04-17 14:18:41,286: Compiling model.agency_data_pipeline.carts_proc
2018-04-17 14:18:41,287: Acquiring new bigquery connection "monthend_dates".
2018-04-17 14:18:41,291: Writing injected SQL for node "model.agency_data_pipeline.conversion_goals_proc"
2018-04-17 14:18:41,291: Compiling model.agency_data_pipeline.accounts_proc
2018-04-17 14:18:41,295: Writing injected SQL for node "model.agency_data_pipeline.carts_proc"
2018-04-17 14:18:41,295: Opening a new connection (1 currently allocated)
2018-04-17 14:18:41,297: Acquiring new bigquery connection "conversion_goals_proc".
2018-04-17 14:18:41,310: Opening a new connection (2 currently allocated)
2018-04-17 14:18:41,306: Writing injected SQL for node "model.agency_data_pipeline.accounts_proc"
2018-04-17 14:18:41,431: Acquiring new bigquery connection "accounts_proc".
2018-04-17 14:18:41,434: Acquiring new bigquery connection "carts_proc".
2018-04-17 14:18:41,434: Opening a new connection (3 currently allocated)
2018-04-17 14:18:41,437: Opening a new connection (4 currently allocated)
2018-04-17 14:18:42,864: Model SQL (monthend_dates):
SELECT
date_in_range,
date_in_range_bom,
date_in_range_bom_mom,
unix_date_in_range,
unix_date_in_range_bom,
unix_date(date_in_range_bom_mom) unix_date_in_range_bom_mom,
yyyymm,
date_in_range_yoy,
unix_date(date_in_range_yoy) unix_date_in_range_yoy

FROM
(
	SELECT 
	date_in_range,
	date_in_range_bom,
	date_sub(date_in_range_bom, INTERVAL 1 MONTH) date_in_range_bom_mom,
  date_sub(date_in_range, INTERVAL 1 YEAR) date_in_range_yoy,
	unix_date_in_range,
	unix_date(date_in_range_bom) unix_date_in_range_bom,
	yyyymm,
	first_value(date_in_range) over (partition by yyyymm order by date_in_range desc) monthend_date_in_range
	FROM
	( 
		SELECT 
		date_in_range,
		date_trunc( date_in_range, MONTH) date_in_range_bom,
		unix_date(date_in_range) unix_date_in_range,
		format_date("%Y-%m", date_in_range) AS yyyymm
		FROM UNNEST(
		    GENERATE_DATE_ARRAY(DATE('2016-01-31'), CURRENT_DATE(), INTERVAL 1 DAY)
		) AS date_in_range
	)
)
where date_in_range = monthend_date_in_range
2018-04-17 14:18:42,904: Model SQL (accounts_proc):
select 
client,
account,
platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.accounts` 

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-04-17 14:18:42,959: Model SQL (carts_proc):
select 
client,
client_name,
account,
platform
from  ( 

SELECT  
client,
client_name,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.accounts`
WHERE platform in ('Shopify', 'Custom cart')

) 

WHERE lv = time_of_entry
2018-04-17 14:18:43,014: Model SQL (conversion_goals_proc):
select 
client,
platform,
goal_name,
max(goal_type) goal_type,
account,
max(time_of_entry) time_of_entry
from  ( 

SELECT  
client,
platform,
trim(replace(replace(lower(goal_name),',',''),' ','')) goal_name,
goal_type,
account,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY platform ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.conversion_goals` 

) 

WHERE lv = time_of_entry
group by client, platform, account, goal_name
2018-04-17 14:18:43,990: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4eeb33a9-7300-4c28-ad4b-1e14f2165a72', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108024cf8>]}
2018-04-17 14:18:44,036: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4eeb33a9-7300-4c28-ad4b-1e14f2165a72', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108024a90>]}
2018-04-17 14:18:44,228: 14:18:44 | 1 of 91 OK created table model agency_data_pipeline.monthend_dates... [CREATE TABLE in 2.71s]
2018-04-17 14:18:44,229: 14:18:44 | 5 of 91 START table model agency_data_pipeline.bing_ads_ads.......... [RUN]
2018-04-17 14:18:44,230: Compiling model.agency_data_pipeline.bing_ads_ads
2018-04-17 14:18:44,244: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_ads"
2018-04-17 14:18:44,247: Acquiring new bigquery connection "bing_ads_ads".
2018-04-17 14:18:44,248: Re-using an available connection from the pool.
2018-04-17 14:18:44,487: 14:18:44 | 4 of 91 OK created table model agency_data_pipeline.accounts_proc.... [CREATE TABLE in 2.74s]
2018-04-17 14:18:44,490: 14:18:44 | 6 of 91 START table model agency_data_pipeline.ga_conversions........ [RUN]
2018-04-17 14:18:44,490: Compiling model.agency_data_pipeline.ga_conversions
2018-04-17 14:18:44,499: Writing injected SQL for node "model.agency_data_pipeline.ga_conversions"
2018-04-17 14:18:44,504: Acquiring new bigquery connection "ga_conversions".
2018-04-17 14:18:44,504: Re-using an available connection from the pool.
2018-04-17 14:18:45,053: Model SQL (bing_ads_ads):
select
date, 
account, 
channel,
platform,
campaignid,
campaignname,
max(lower(trim(replace(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$','' ),'.html',''),'/'))) as url,
utm_campaign,
sum(cost) as cost,
sum(impressions) as impressions,
sum(clicks) as clicks,
sum(conversions) as conversions
from 
  ( 
SELECT  
cast(gregoriandate as date) date,
replace(accountname,',','') account,
'Paid' as channel,
'Bing Ads' as platform,
adid,
adtype,
campaignid, 
campaignname,
finalurl url,
case when regexp_contains(destinationurl, 'utm_campaign')
	then replace(lower(nullif(
  

    split(
        
  

    split(
        destinationurl,
        'utm_campaign='
        )[offset(1)]


,
        '&'
        )[offset(0)]


,'')),'+',' ') 
	else null end as utm_campaign,
spend cost, 
impressions, 
clicks, 
conversions,
_sdc_sequence,
first_value(_sdc_sequence) OVER (PARTITION BY adid, gregoriandate ORDER BY _sdc_sequence DESC) lv
FROM `growth-engines-pipeline.bing_ads.ad_performance_report` 
  )

where lv = _sdc_sequence
group by date, account, channel, platform, campaignid, campaignname, utm_campaign
2018-04-17 14:18:45,262: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4eeb33a9-7300-4c28-ad4b-1e14f2165a72', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104aa5710>]}
2018-04-17 14:18:45,338: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4eeb33a9-7300-4c28-ad4b-1e14f2165a72', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104b56550>]}
2018-04-17 14:18:45,503: Model SQL (ga_conversions):
select 
client,
client_name,
platform,
goal_name,
goal_type,
account,
time_of_entry
from  ( 

SELECT  
client,
client_name,
platform,
trim(goal_name) goal_name,
goal_type,
account,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform, goal_name ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.conversion_goals` 
WHERE platform = 'Google Analytics'

) 

WHERE lv = time_of_entry
2018-04-17 14:18:45,508: 14:18:45 | 2 of 91 OK created table model agency_data_pipeline.conversion_goals_proc [CREATE TABLE in 3.98s]
2018-04-17 14:18:45,509: 14:18:45 | 7 of 91 START table model agency_data_pipeline.adwords_urls.......... [RUN]
2018-04-17 14:18:45,510: Compiling model.agency_data_pipeline.adwords_urls
2018-04-17 14:18:45,516: Writing injected SQL for node "model.agency_data_pipeline.adwords_urls"
2018-04-17 14:18:45,521: Acquiring new bigquery connection "adwords_urls".
2018-04-17 14:18:45,521: Re-using an available connection from the pool.
2018-04-17 14:18:45,755: 14:18:45 | 3 of 91 OK created table model agency_data_pipeline.carts_proc....... [CREATE TABLE in 4.05s]
2018-04-17 14:18:45,755: 14:18:45 | 8 of 91 START table model agency_data_pipeline.adwords_campaigns..... [RUN]
2018-04-17 14:18:45,756: Compiling model.agency_data_pipeline.adwords_campaigns
2018-04-17 14:18:45,765: Writing injected SQL for node "model.agency_data_pipeline.adwords_campaigns"
2018-04-17 14:18:45,768: Acquiring new bigquery connection "adwords_campaigns".
2018-04-17 14:18:45,768: Re-using an available connection from the pool.
2018-04-17 14:18:46,284: Model SQL (adwords_urls):
SELECT
campaignid,
lower(trim(regexp_replace(replace(replace(replace(replace(finalurl,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url

FROM (

SELECT  
campaignid,
finalurl,
first_value(finalurl) OVER (PARTITION BY campaignid ORDER BY day DESC) lv
FROM `growth-engines-pipeline.adwords_2.FINAL_URL_REPORT`
)

WHERE lv = finalurl
group by campaignid, url
order by campaignid asc
2018-04-17 14:18:46,669: Model SQL (adwords_campaigns):
select
day,
campaignid, 
campaign,
account, 
channel,
platform,
sum(cost) cost,
sum(impressions) impressions,
sum(clicks) clicks,
sum(impression_share_num) impression_share_num,
sum(impression_share_den) impression_share_den
from 
  ( 
	SELECT  
	day,
	campaignid,
	campaign,
	account as account,
	'Paid' as channel,
	'Adwords' as platform,
	cost/1000000 cost, 
	impressions as impressions, 
	clicks, 
	case when searchimprshare is not null then impressions end as impression_share_num,
	case when searchimprshare is not null then impressions/(searchimprshare/100) end as impression_share_den,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY campaignid, day ORDER BY _sdc_sequence DESC) lv
	FROM `growth-engines-pipeline.adwords_2.CAMPAIGN_PERFORMANCE_REPORT`
  )
where lv = _sdc_sequence
group by day, campaignid, account, channel, platform, campaign
2018-04-17 14:18:47,417: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4eeb33a9-7300-4c28-ad4b-1e14f2165a72', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1080a32e8>]}
2018-04-17 14:18:47,685: 14:18:47 | 5 of 91 OK created table model agency_data_pipeline.bing_ads_ads..... [CREATE TABLE in 3.19s]
2018-04-17 14:18:47,685: 14:18:47 | 9 of 91 START table model agency_data_pipeline.bing_ads_impression_share [RUN]
2018-04-17 14:18:47,686: Compiling model.agency_data_pipeline.bing_ads_impression_share
2018-04-17 14:18:47,693: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_impression_share"
2018-04-17 14:18:47,695: Acquiring new bigquery connection "bing_ads_impression_share".
2018-04-17 14:18:47,695: Re-using an available connection from the pool.
2018-04-17 14:18:47,750: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4eeb33a9-7300-4c28-ad4b-1e14f2165a72', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108006fd0>]}
2018-04-17 14:18:48,008: 14:18:48 | 6 of 91 OK created table model agency_data_pipeline.ga_conversions... [CREATE TABLE in 3.26s]
2018-04-17 14:18:48,008: 14:18:48 | 10 of 91 START table model agency_data_pipeline.all_dates............ [RUN]
2018-04-17 14:18:48,009: Compiling model.agency_data_pipeline.all_dates
2018-04-17 14:18:48,015: Writing injected SQL for node "model.agency_data_pipeline.all_dates"
2018-04-17 14:18:48,016: Acquiring new bigquery connection "all_dates".
2018-04-17 14:18:48,016: Re-using an available connection from the pool.
2018-04-17 14:18:48,534: Model SQL (bing_ads_impression_share):
SELECT 
date, 
account,
channel,
platform,
sum(impressions) impressions,
sum(available_impressions) available_impressions
FROM

(

SELECT  
cast(gregoriandate as date) date,
replace(accountname,',','') account,  
'Paid' as channel,
'Bing Ads' as platform,
case when impressionsharepercent is null then 0 else impressions end as impressions,
cast(round(case when ( impressionsharepercent is not null and impressionsharepercent > 0 ) then (impressions*100)/impressionsharepercent else 0 end) as int64) as available_impressions,
_sdc_sequence,
first_value(_sdc_sequence) OVER (PARTITION BY campaignid, gregoriandate ORDER BY _sdc_sequence DESC) lv
FROM `growth-engines-pipeline.bing_ads.campaign_performance_report` 

)

where lv = _sdc_sequence
group by date, account, channel, platform
2018-04-17 14:18:48,537: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4eeb33a9-7300-4c28-ad4b-1e14f2165a72', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104aa5710>]}
2018-04-17 14:18:48,699: Model SQL (all_dates):
SELECT 
date_in_range,
unix_date(date_in_range) unix_date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-04-17 14:18:48,782: 14:18:48 | 7 of 91 OK created table model agency_data_pipeline.adwords_urls..... [CREATE TABLE in 3.03s]
2018-04-17 14:18:48,782: 14:18:48 | 11 of 91 START table model agency_data_pipeline.adwords_conversions.. [RUN]
2018-04-17 14:18:48,783: Compiling model.agency_data_pipeline.adwords_conversions
2018-04-17 14:18:48,790: Writing injected SQL for node "model.agency_data_pipeline.adwords_conversions"
2018-04-17 14:18:48,792: Acquiring new bigquery connection "adwords_conversions".
2018-04-17 14:18:48,792: Re-using an available connection from the pool.
2018-04-17 14:18:49,548: Model SQL (adwords_conversions):
select 
client,
client_name,
platform,
goal_name,
goal_type,
account,
time_of_entry
from  ( 

SELECT  
client,
client_name,
platform,
trim(lower(goal_name)) goal_name,
goal_type,
account,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform, goal_name ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.conversion_goals` 
WHERE platform = 'Adwords'

) 

WHERE lv = time_of_entry
2018-04-17 14:18:49,657: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4eeb33a9-7300-4c28-ad4b-1e14f2165a72', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1080a32e8>]}
2018-04-17 14:18:49,803: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4eeb33a9-7300-4c28-ad4b-1e14f2165a72', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108006fd0>]}
2018-04-17 14:18:49,915: 14:18:49 | 9 of 91 OK created table model agency_data_pipeline.bing_ads_impression_share [CREATE TABLE in 1.97s]
2018-04-17 14:18:49,917: 14:18:49 | 12 of 91 START table model agency_data_pipeline.clients_proc......... [RUN]
2018-04-17 14:18:49,918: Compiling model.agency_data_pipeline.clients_proc
2018-04-17 14:18:49,926: Writing injected SQL for node "model.agency_data_pipeline.clients_proc"
2018-04-17 14:18:49,928: Acquiring new bigquery connection "clients_proc".
2018-04-17 14:18:49,929: Re-using an available connection from the pool.
2018-04-17 14:18:50,168: 14:18:50 | 10 of 91 OK created table model agency_data_pipeline.all_dates....... [CREATE TABLE in 1.79s]
2018-04-17 14:18:50,674: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4eeb33a9-7300-4c28-ad4b-1e14f2165a72', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104aa5710>]}
2018-04-17 14:18:50,700: Model SQL (clients_proc):
select 
client,
client_name,
account,
platform
from  ( 

SELECT  
client,
client_name,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.accounts`
where client_name != ''
) 

WHERE lv = time_of_entry
2018-04-17 14:18:50,916: 14:18:50 | 11 of 91 OK created table model agency_data_pipeline.adwords_conversions [CREATE TABLE in 1.89s]
2018-04-17 14:18:51,840: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4eeb33a9-7300-4c28-ad4b-1e14f2165a72', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1080a32e8>]}
2018-04-17 14:18:52,098: 14:18:52 | 12 of 91 OK created table model agency_data_pipeline.clients_proc.... [CREATE TABLE in 1.92s]
2018-04-17 14:18:52,227: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4eeb33a9-7300-4c28-ad4b-1e14f2165a72', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104aa5710>]}
2018-04-17 14:18:52,504: 14:18:52 | 8 of 91 OK created table model agency_data_pipeline.adwords_campaigns [CREATE TABLE in 6.47s]
2018-04-17 14:18:52,504: 14:18:52 | 13 of 91 START table model agency_data_pipeline.fb_adcreative........ [RUN]
2018-04-17 14:18:52,505: 14:18:52 | 14 of 91 START table model agency_data_pipeline.bing_ads_conversions. [RUN]
2018-04-17 14:18:52,505: 14:18:52 | 15 of 91 START table model agency_data_pipeline.shopify_refunds_proc. [RUN]
2018-04-17 14:18:52,505: 14:18:52 | 16 of 91 START table model agency_data_pipeline.adwords_ads.......... [RUN]
2018-04-17 14:18:52,506: Compiling model.agency_data_pipeline.fb_adcreative
2018-04-17 14:18:52,506: Compiling model.agency_data_pipeline.bing_ads_conversions
2018-04-17 14:18:52,506: Compiling model.agency_data_pipeline.shopify_refunds_proc
2018-04-17 14:18:52,506: Compiling model.agency_data_pipeline.adwords_ads
2018-04-17 14:18:52,534: Acquiring new bigquery connection "shopify_refunds_proc".
2018-04-17 14:18:52,534: Re-using an available connection from the pool.
2018-04-17 14:18:52,534: Fetching data for query shopify_refunds_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 14:18:52,534: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_conversions"
2018-04-17 14:18:52,537: Acquiring new bigquery connection "fb_adcreative".
2018-04-17 14:18:52,537: Re-using an available connection from the pool.
2018-04-17 14:18:52,537: Fetching data for query fb_adcreative:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 14:18:52,539: Writing injected SQL for node "model.agency_data_pipeline.adwords_ads"
2018-04-17 14:18:52,544: Acquiring new bigquery connection "bing_ads_conversions".
2018-04-17 14:18:52,544: Re-using an available connection from the pool.
2018-04-17 14:18:52,545: Acquiring new bigquery connection "adwords_ads".
2018-04-17 14:18:52,546: Re-using an available connection from the pool.
2018-04-17 14:18:53,530: Model SQL (bing_ads_conversions):
SELECT
date, 
a.account account, 
a.channel channel,
a.platform platform,
campaignid,
campaignname,
sum( case when b.goal_type = 'Transactions' then conversions else 0 end ) as transactions
FROM

  ( 
SELECT  
cast(gregoriandate as date) date,
replace(accountname,',','') account,
'Paid' as channel,
'Bing Ads' as platform,
trim(replace(replace(lower(goal),',',''),' ','')) goal,
goalid,
campaignid,
campaignname,
conversions,
_sdc_sequence,
first_value(_sdc_sequence) OVER (PARTITION BY campaignid, goalid, gregoriandate ORDER BY _sdc_sequence DESC) lv
FROM `growth-engines-pipeline.bing_ads.goals_and_funnels_report` 

  ) a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`conversion_goals_proc` b
ON (
	a.account = b.account AND
	a.platform = b.platform AND
	a.goal = b.goal_name
)
where a.lv = a._sdc_sequence
group by date, account, channel, platform, campaignid, campaignname
2018-04-17 14:18:53,531: Model SQL (adwords_ads):
SELECT  
day,
campaignid,
a.account as account,
utm_campaign,
sum( case when b.goal_type = 'Transaction' then conversions else 0 end ) as transactions
FROM (

	SELECT  
	day,
	adid,
	campaignid,
	account,
	lower(conversionname) conversionname,
	conversions,
	lower(campaign) utm_campaign,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY campaignid, day ORDER BY _sdc_sequence DESC) lv
	FROM
	`growth-engines-pipeline.adwords_2.AD_PERFORMANCE_REPORT`

) a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_conversions` b
ON ( a.conversionname = b.goal_name
	AND a.account = b.account )
WHERE lv = _sdc_sequence
group by day, campaignid, account, utm_campaign
2018-04-17 14:18:53,842: Writing injected SQL for node "model.agency_data_pipeline.shopify_refunds_proc"
2018-04-17 14:18:53,917: Writing injected SQL for node "model.agency_data_pipeline.fb_adcreative"
2018-04-17 14:18:54,686: Model SQL (shopify_refunds_proc):




with refunds as (

	
	SELECT
	order_number,
	checkout_id,
	financial_status,
	line_item_id,
	quantity,
	subtotal,
	line_item.variant_id variant_id,
	line_item.id refund_id,
 	_sdc_sequence
	FROM `growth-engines-pipeline.shopify_lucadanni.orders` 
	cross join unnest(refunds), unnest(refund_line_items)
  	where financial_status like '%refund%'
	
	

)

SELECT * 
FROM 
	(
    SELECT
	order_number,
	checkout_id,
	financial_status,
	line_item_id,
	quantity,
	subtotal refund_amount,
	variant_id,
	refund_id,
 	_sdc_sequence,
    first_value(_sdc_sequence) OVER (PARTITION BY order_number, line_item_id ORDER BY _sdc_sequence DESC) lv
    FROM refunds
   	) 
WHERE lv = _sdc_sequence


2018-04-17 14:18:54,730: Model SQL (fb_adcreative):




with fb_adcreative as (


	    
		   	SELECT 
			id,
			object_url,
			url_tags,
			_sdc_sequence
			FROM `growth-engines-pipeline.fb_ads_luca_danni.adcreative`
		    
	   
)

select creative_id, max(url) url
from (
  select
  id creative_id,
  lower(trim(regexp_replace(replace(replace(replace(replace(object_url,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
  first_value(_sdc_sequence) OVER (PARTITION BY id ORDER BY _sdc_sequence DESC) lv,
  _sdc_sequence
  from fb_adcreative
  )
where lv = _sdc_sequence
group by creative_id


2018-04-17 14:18:55,752: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4eeb33a9-7300-4c28-ad4b-1e14f2165a72', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1080499e8>]}
2018-04-17 14:18:55,776: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4eeb33a9-7300-4c28-ad4b-1e14f2165a72', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104b527f0>]}
2018-04-17 14:18:56,194: 14:18:56 | 14 of 91 OK created table model agency_data_pipeline.bing_ads_conversions [CREATE TABLE in 3.25s]
2018-04-17 14:18:56,195: 14:18:56 | 17 of 91 START table model agency_data_pipeline.mappings_ga_proc..... [RUN]
2018-04-17 14:18:56,198: Compiling model.agency_data_pipeline.mappings_ga_proc
2018-04-17 14:18:56,209: Writing injected SQL for node "model.agency_data_pipeline.mappings_ga_proc"
2018-04-17 14:18:56,211: Acquiring new bigquery connection "mappings_ga_proc".
2018-04-17 14:18:56,212: Re-using an available connection from the pool.
2018-04-17 14:18:56,453: 14:18:56 | 16 of 91 OK created table model agency_data_pipeline.adwords_ads..... [CREATE TABLE in 3.27s]
2018-04-17 14:18:56,454: 14:18:56 | 18 of 91 START table model agency_data_pipeline.fb_ads_insights...... [RUN]
2018-04-17 14:18:56,454: Compiling model.agency_data_pipeline.fb_ads_insights
2018-04-17 14:18:56,464: Acquiring new bigquery connection "fb_ads_insights".
2018-04-17 14:18:56,465: Re-using an available connection from the pool.
2018-04-17 14:18:56,465: Fetching data for query fb_ads_insights:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 14:18:56,835: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_insights"
2018-04-17 14:18:56,944: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4eeb33a9-7300-4c28-ad4b-1e14f2165a72', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104b3ca58>]}
2018-04-17 14:18:56,981: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4eeb33a9-7300-4c28-ad4b-1e14f2165a72', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10802bd30>]}
2018-04-17 14:18:57,095: Model SQL (mappings_ga_proc):
select 
client,
account,
client_name,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
account,
client_name,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.mappings_ga` 

) 

WHERE lv = time_of_entry
and client in (select client from `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc` )
group by client, account, client_name, source, medium, platform_n, channel_n, time_of_entry
2018-04-17 14:18:57,192: 14:18:57 | 15 of 91 OK created table model agency_data_pipeline.shopify_refunds_proc [CREATE TABLE in 4.44s]
2018-04-17 14:18:57,193: 14:18:57 | 19 of 91 START table model agency_data_pipeline.ga_mcf_proc.......... [RUN]
2018-04-17 14:18:57,194: Compiling model.agency_data_pipeline.ga_mcf_proc
2018-04-17 14:18:57,204: Writing injected SQL for node "model.agency_data_pipeline.ga_mcf_proc"
2018-04-17 14:18:57,208: Acquiring new bigquery connection "ga_mcf_proc".
2018-04-17 14:18:57,209: Re-using an available connection from the pool.
2018-04-17 14:18:57,600: Model SQL (fb_ads_insights):




with fb_ads_insights as (

	    
		   	SELECT 
			date_start,
			campaign_id,
			campaign_name,
			ad_id,
			account_name,
			spend,
			reach,
			inline_link_clicks,
			_sdc_sequence,
			first_value(_sdc_sequence) OVER (PARTITION BY date_start, ad_id, campaign_id ORDER BY _sdc_sequence DESC) lv
			FROM `growth-engines-pipeline.fb_ads_luca_danni.ads_insights`
		    
	   

)

select
date_start date,
campaign_id,
campaign_name campaign,
ad_id,
account_name account,
max(spend) cost,
max(reach) impressions,
max(inline_link_clicks) clicks
from fb_ads_insights
where lv = _sdc_sequence
group by date, campaign_id, ad_id, account, campaign


2018-04-17 14:18:57,668: 14:18:57 | 13 of 91 OK created table model agency_data_pipeline.fb_adcreative... [CREATE TABLE in 4.48s]
2018-04-17 14:18:57,669: 14:18:57 | 20 of 91 START table model agency_data_pipeline.fb_ads_insights_conversions [RUN]
2018-04-17 14:18:57,669: Compiling model.agency_data_pipeline.fb_ads_insights_conversions
2018-04-17 14:18:57,679: Acquiring new bigquery connection "fb_ads_insights_conversions".
2018-04-17 14:18:57,680: Re-using an available connection from the pool.
2018-04-17 14:18:57,680: Fetching data for query fb_ads_insights_conversions:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 14:18:57,937: Model SQL (ga_mcf_proc):
SELECT 
date,
account,
'Google Analytics' as lookup_platform,
source_medium_path,
trim(lower(split(split(source_medium_path,'->')[SAFE_ORDINAL(1)],'/')[SAFE_ORDINAL(1)])) as source,
trim(lower(split(split(source_medium_path,'->')[SAFE_ORDINAL(1)],'/')[SAFE_ORDINAL(2)])) as medium,
first_interaction_campaign campaign,
cast(regexp_replace(transaction_id, r'#', '') as int64) transactionid,
max(first_interaction_conversions) transactions,
max(first_interaction_conversion_value) revenue
FROM `growth-engines-pipeline.agency_data_pipeline.ga_mcf`
where account in (select account from `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc` where platform = 'Google Analytics')
group by date, account, source, medium, campaign, source_medium_path, lookup_platform, transactionid
2018-04-17 14:18:58,080: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_insights_conversions"
2018-04-17 14:18:58,224: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4eeb33a9-7300-4c28-ad4b-1e14f2165a72', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1080499e8>]}
2018-04-17 14:18:58,505: 14:18:58 | 17 of 91 OK created table model agency_data_pipeline.mappings_ga_proc [CREATE TABLE in 2.03s]
2018-04-17 14:18:58,873: Model SQL (fb_ads_insights_conversions):




with fb_ads_insights_conversions as (

	    
		   	SELECT 
			date_start,
			campaign_id,
			campaign_name,
			ad_id,
			account_name,
			spend,
			reach,
			inline_link_clicks,
			_sdc_sequence,
			action_type,
			value
			FROM `growth-engines-pipeline.fb_ads_luca_danni.ads_insights`
			cross join unnest(actions)
		    
	   

)

SELECT * 
FROM 
	(
    SELECT
    date_start date,
    campaign_id,
    campaign_name campaign,
    ad_id,
    account_name account,
    action_type,
    value conversions,
    first_value(_sdc_sequence) OVER (PARTITION BY ad_id, date_start ORDER BY _sdc_sequence DESC) lv,
    _sdc_sequence
    FROM fb_ads_insights_conversions
   	)
where lv = _sdc_sequence
and action_type like '%purchase%'


2018-04-17 14:18:59,840: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4eeb33a9-7300-4c28-ad4b-1e14f2165a72', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104afe6d8>]}
2018-04-17 14:19:00,457: 14:19:00 | 18 of 91 OK created table model agency_data_pipeline.fb_ads_insights. [CREATE TABLE in 3.39s]
2018-04-17 14:19:03,347: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4eeb33a9-7300-4c28-ad4b-1e14f2165a72', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10802bd30>]}
2018-04-17 14:19:03,498: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4eeb33a9-7300-4c28-ad4b-1e14f2165a72', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104b4dbe0>]}
2018-04-17 14:19:03,625: 14:19:03 | 20 of 91 OK created table model agency_data_pipeline.fb_ads_insights_conversions [CREATE TABLE in 5.68s]
2018-04-17 14:19:03,996: 14:19:03 | 19 of 91 OK created table model agency_data_pipeline.ga_mcf_proc..... [CREATE TABLE in 6.30s]
2018-04-17 14:19:03,997: 14:19:03 | 21 of 91 START table model agency_data_pipeline.shopify_customers_proc [RUN]
2018-04-17 14:19:03,997: Compiling model.agency_data_pipeline.shopify_customers_proc
2018-04-17 14:19:03,997: 14:19:03 | 22 of 91 START table model agency_data_pipeline.fb_ads............... [RUN]
2018-04-17 14:19:04,004: Compiling model.agency_data_pipeline.fb_ads
2018-04-17 14:19:04,015: Acquiring new bigquery connection "shopify_customers_proc".
2018-04-17 14:19:04,016: Re-using an available connection from the pool.
2018-04-17 14:19:04,019: Acquiring new bigquery connection "fb_ads".
2018-04-17 14:19:04,019: Fetching data for query shopify_customers_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 14:19:04,020: Re-using an available connection from the pool.
2018-04-17 14:19:04,022: Fetching data for query fb_ads:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 14:19:04,496: Writing injected SQL for node "model.agency_data_pipeline.shopify_customers_proc"
2018-04-17 14:19:04,502: Writing injected SQL for node "model.agency_data_pipeline.fb_ads"
2018-04-17 14:19:05,448: Model SQL (fb_ads):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`fb_adcreative`





with fb_ads as (

	    
		   	SELECT 
			id ad_id,
			creative.creative_id creative_id,
			_sdc_sequence
			FROM `growth-engines-pipeline.fb_ads_luca_danni.ads`
		     
	   

)

SELECT
a.ad_id,
b.creative_id,
b.url
FROM (
    SELECT
    ad_id,
    creative_id,
    first_value(_sdc_sequence) OVER (PARTITION BY ad_id ORDER BY _sdc_sequence DESC) lv,
    _sdc_sequence
    FROM fb_ads
    ) a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`fb_adcreative` b
ON (
	a.creative_id = b.creative_id 
)
WHERE a.lv = a._sdc_sequence


2018-04-17 14:19:05,504: Model SQL (shopify_customers_proc):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc`





with customers as (

	
	SELECT
	'lucadanni' client_name,
	'Shopify' as lookup_platform,
	cast(created_at as date) created_at,
	id,
	first_name,
	last_name,
	email,
	_sdc_sequence,
	first_value(_sdc_sequence) over (partition by id, _sdc_sequence order by _sdc_sequence desc) lv
	FROM `growth-engines-pipeline.shopify_lucadanni.customers` 
	
	

)

SELECT
account,
client,
platform,
id,
min(created_at) created_at,
max(first_name) first_name,
max(last_name) last_name,
max(email) email
FROM (
	SELECT
	b.account,
	b.client,
	b.platform,
	created_at,
	id,
	first_name,
	last_name,
	email
	FROM customers a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
	ON ( a.client_name = b.client_name
	  AND a.lookup_platform = b.platform )
	where a.lv = a._sdc_sequence
)
group by account, client, platform, id

2018-04-17 14:19:07,689: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4eeb33a9-7300-4c28-ad4b-1e14f2165a72', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104b44f28>]}
2018-04-17 14:19:08,291: 14:19:08 | 22 of 91 OK created table model agency_data_pipeline.fb_ads.......... [CREATE TABLE in 3.68s]
2018-04-17 14:19:10,018: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4eeb33a9-7300-4c28-ad4b-1e14f2165a72', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104aa5710>]}
2018-04-17 14:19:10,625: 14:19:10 | 21 of 91 OK created table model agency_data_pipeline.shopify_customers_proc [CREATE TABLE in 6.02s]
2018-04-17 14:19:10,626: 14:19:10 | 23 of 91 START table model agency_data_pipeline.shopify_orders_proc.. [RUN]
2018-04-17 14:19:10,627: 14:19:10 | 24 of 91 START table model agency_data_pipeline.bing_ads_stats....... [RUN]
2018-04-17 14:19:10,627: 14:19:10 | 25 of 91 START table model agency_data_pipeline.shopify_products_proc [RUN]
2018-04-17 14:19:10,627: 14:19:10 | 26 of 91 START table model agency_data_pipeline.agg_customers_union.. [RUN]
2018-04-17 14:19:10,627: Compiling model.agency_data_pipeline.shopify_orders_proc
2018-04-17 14:19:10,627: Compiling model.agency_data_pipeline.bing_ads_stats
2018-04-17 14:19:10,628: Compiling model.agency_data_pipeline.shopify_products_proc
2018-04-17 14:19:10,628: Compiling model.agency_data_pipeline.agg_customers_union
2018-04-17 14:19:10,653: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_stats"
2018-04-17 14:19:10,658: Writing injected SQL for node "model.agency_data_pipeline.agg_customers_union"
2018-04-17 14:19:10,659: Acquiring new bigquery connection "shopify_products_proc".
2018-04-17 14:19:10,659: Acquiring new bigquery connection "shopify_orders_proc".
2018-04-17 14:19:10,660: Re-using an available connection from the pool.
2018-04-17 14:19:10,661: Acquiring new bigquery connection "bing_ads_stats".
2018-04-17 14:19:10,661: Fetching data for query shopify_products_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 14:19:10,661: Re-using an available connection from the pool.
2018-04-17 14:19:10,662: Acquiring new bigquery connection "agg_customers_union".
2018-04-17 14:19:10,662: Fetching data for query shopify_orders_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 14:19:10,662: Re-using an available connection from the pool.
2018-04-17 14:19:10,664: Re-using an available connection from the pool.
2018-04-17 14:19:11,048: Writing injected SQL for node "model.agency_data_pipeline.shopify_orders_proc"
2018-04-17 14:19:11,079: Writing injected SQL for node "model.agency_data_pipeline.shopify_products_proc"
2018-04-17 14:19:11,622: Model SQL (agg_customers_union):
SELECT *
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`shopify_customers_proc`
2018-04-17 14:19:11,702: Model SQL (bing_ads_stats):
select
a.date, 
a.account, 
a.channel,
a.platform,
url,
a.campaignname campaign,
utm_campaign,
cost,
clicks,
impressions,
transactions
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`bing_ads_ads` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`bing_ads_conversions` b
ON (
	a.date = b.date AND
	a.account = b.account AND
	a.campaignid = b.campaignid

)
2018-04-17 14:19:12,062: Model SQL (shopify_products_proc):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc`, `growth-engines-pipeline`.`agency_data_pipeline`.`shopify_refunds_proc`





with products as (

	
	SELECT
	'lucadanni' client_name,
	'Shopify' as lookup_platform,
	product_type,
	product_id,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY product_id ORDER BY _sdc_sequence DESC) lv
	FROM `growth-engines-pipeline.shopify_lucadanni.products` 
	cross join unnest(variants)
	
	

)

SELECT
b.account,
b.client,
b.platform,
max(product_type) product_type,
product_id
FROM products a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
ON ( a.client_name = b.client_name
  AND a.lookup_platform = b.platform )
where a.lv = a._sdc_sequence
group by product_id, account, client, platform


2018-04-17 14:19:12,073: Model SQL (shopify_orders_proc):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc`, `growth-engines-pipeline`.`agency_data_pipeline`.`shopify_refunds_proc`





with orders as (

	
	SELECT
	'lucadanni' client_name,
	'Shopify' as lookup_platform,
	created_at,
	order_number,
	quantity,
	cast(pre_tax_price as float64) price, 
	total_line_items_price total_order_price_undiscounted,
	total_discounts,
	cast(discounted_price as float64) total_order_shipping_price,
	total_price_usd total_order_price_incl_shipping,
	checkout_id,
	product_id, 
	landing_site,
	sku, 
	variant_title, 
	variant_id,
	_id line_item_id,
	customer.id customer_id,
	customer.orders_count orders_count,
	customer.created_at customer_created_at,
	customer.last_order_id last_order_id,
	financial_status,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY order_number, _id ORDER BY _sdc_sequence DESC) lv
	FROM `growth-engines-pipeline.shopify_lucadanni.orders` 
	cross join unnest(line_items), unnest(shipping_lines)
	where source_name != 'shopify_draft_order'
	
	

)

SELECT
b.account,
b.client,
b.platform,
created_at,
a.order_number,
a.quantity,
c.quantity refund_quantity,
case when c.quantity is not null then a.quantity - c.quantity else a.quantity end as final_quantity,
price, 
total_order_price_undiscounted,
total_discounts,
total_order_shipping_price,
total_order_price_incl_shipping,
refund_amount,
case when refund_amount is not null then price - refund_amount else price end as final_price,
a.checkout_id,
a.product_id, 
landing_site,
sku, 
variant_title, 
a.variant_id,
a.line_item_id,	
customer_id,
orders_count,
customer_created_at,
last_order_id,
a.financial_status
FROM orders a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
ON ( a.client_name = b.client_name
  AND a.lookup_platform = b.platform )
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`shopify_refunds_proc` c
ON ( a.order_number = c.order_number
	AND a.line_item_id = c.line_item_id )   	
where a.lv = a._sdc_sequence


2018-04-17 14:19:13,930: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4eeb33a9-7300-4c28-ad4b-1e14f2165a72', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108024748>]}
2018-04-17 14:19:14,237: 14:19:14 | 24 of 91 OK created table model agency_data_pipeline.bing_ads_stats.. [CREATE TABLE in 3.30s]
2018-04-17 14:19:14,237: 14:19:14 | 27 of 91 START table model agency_data_pipeline.ga_mcf_stats......... [RUN]
2018-04-17 14:19:14,238: Compiling model.agency_data_pipeline.ga_mcf_stats
2018-04-17 14:19:14,248: Writing injected SQL for node "model.agency_data_pipeline.ga_mcf_stats"
2018-04-17 14:19:14,250: Acquiring new bigquery connection "ga_mcf_stats".
2018-04-17 14:19:14,250: Re-using an available connection from the pool.
2018-04-17 14:19:14,341: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4eeb33a9-7300-4c28-ad4b-1e14f2165a72', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104b3ce48>]}
2018-04-17 14:19:14,815: 14:19:14 | 25 of 91 OK created table model agency_data_pipeline.shopify_products_proc [CREATE TABLE in 3.71s]
2018-04-17 14:19:14,953: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4eeb33a9-7300-4c28-ad4b-1e14f2165a72', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104afe4e0>]}
2018-04-17 14:19:14,990: Model SQL (ga_mcf_stats):
SELECT  
date,
a.account account,
b.client client,
case when c.platform is null then "Unmapped" else c.platform end as platform,
case when c.channel is null then "Unmapped" else c.channel end as channel,
lower(a.source) source,
lower(a.medium) medium,
lower(campaign) campaign,
transactionid,
sum(transactions) first_touch_transactions,
sum(revenue) first_touch_revenue
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`ga_mcf_proc` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc` b 
ON ( a.account = b.account and
	a.lookup_platform = b.platform )
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc` c
ON ( lower(a.source) = c.source
  AND lower(a.medium) = c.medium 
  and a.account = c.account )
group by date, account, client, source, medium, campaign, platform, channel, transactionid
2018-04-17 14:19:15,209: 14:19:15 | 26 of 91 OK created table model agency_data_pipeline.agg_customers_union [CREATE TABLE in 4.32s]
2018-04-17 14:19:19,831: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4eeb33a9-7300-4c28-ad4b-1e14f2165a72', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108024748>]}
2018-04-17 14:19:20,386: 14:19:20 | 27 of 91 OK created table model agency_data_pipeline.ga_mcf_stats.... [CREATE TABLE in 5.59s]
2018-04-17 14:19:22,129: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4eeb33a9-7300-4c28-ad4b-1e14f2165a72', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104b4dbe0>]}
2018-04-17 14:19:22,376: 14:19:22 | 23 of 91 OK created table model agency_data_pipeline.shopify_orders_proc [CREATE TABLE in 11.50s]
2018-04-17 14:19:22,377: 14:19:22 | 28 of 91 START table model agency_data_pipeline.agg_products......... [RUN]
2018-04-17 14:19:22,377: 14:19:22 | 29 of 91 START table model agency_data_pipeline.adwords_join......... [RUN]
2018-04-17 14:19:22,377: 14:19:22 | 30 of 91 START table model agency_data_pipeline.ga_transactions...... [RUN]
2018-04-17 14:19:22,378: 14:19:22 | 31 of 91 START table model agency_data_pipeline.ga_traffic........... [RUN]
2018-04-17 14:19:22,378: Compiling model.agency_data_pipeline.agg_products
2018-04-17 14:19:22,378: Compiling model.agency_data_pipeline.adwords_join
2018-04-17 14:19:22,378: Compiling model.agency_data_pipeline.ga_transactions
2018-04-17 14:19:22,378: Compiling model.agency_data_pipeline.ga_traffic
2018-04-17 14:19:22,387: Writing injected SQL for node "model.agency_data_pipeline.agg_products"
2018-04-17 14:19:22,402: Writing injected SQL for node "model.agency_data_pipeline.adwords_join"
2018-04-17 14:19:22,426: Acquiring new bigquery connection "ga_transactions".
2018-04-17 14:19:22,430: Acquiring new bigquery connection "ga_traffic".
2018-04-17 14:19:22,431: Re-using an available connection from the pool.
2018-04-17 14:19:22,431: Fetching data for query ga_transactions:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Google Analytics'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 14:19:22,432: Re-using an available connection from the pool.
2018-04-17 14:19:22,432: Fetching data for query ga_traffic:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'GA Traffic'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 14:19:22,434: Acquiring new bigquery connection "adwords_join".
2018-04-17 14:19:22,434: Re-using an available connection from the pool.
2018-04-17 14:19:22,440: Acquiring new bigquery connection "agg_products".
2018-04-17 14:19:22,442: Re-using an available connection from the pool.
2018-04-17 14:19:23,433: Model SQL (agg_products):
SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`shopify_products_proc`
2018-04-17 14:19:23,453: Model SQL (adwords_join):
select
a.day,
a.campaignid, 
a.campaign,
a.account, 
channel,
platform,
url,
utm_campaign,
cost,
impressions,
clicks,
impression_share_num,
impression_share_den,
transactions
FROM ( 
	
	select
	day,
	a.campaign,
	a.campaignid, 
	account, 
	channel,
	platform,
	url,
	cost,
	impressions,
	clicks,
	impression_share_num,
	impression_share_den
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_campaigns` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_urls` b
	ON a.campaignid = b.campaignid

) a 
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_ads` b
ON ( a.campaignid = b.campaignid
	and a.day = b.day )
2018-04-17 14:19:23,702: Fetching data for query ga_traffic:


        select
            goal_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_conversions`

        
        ##where 1 = 1
        where goal_type = 'Conversion'
        
        
        
        ##and 2 = 2
        and client_name = 'lucadanni'
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 14:19:23,774: Fetching data for query ga_transactions:


        select
            goal_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_conversions`

        
        ##where 1 = 1
        where goal_type = 'Conversion'
        
        
        
        ##and 2 = 2
        and client_name = 'lucadanni'
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 14:19:25,382: Writing injected SQL for node "model.agency_data_pipeline.ga_traffic"
2018-04-17 14:19:25,438: Writing injected SQL for node "model.agency_data_pipeline.ga_transactions"
2018-04-17 14:19:25,632: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4eeb33a9-7300-4c28-ad4b-1e14f2165a72', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104aa5710>]}
2018-04-17 14:19:25,874: 14:19:25 | 28 of 91 OK created table model agency_data_pipeline.agg_products.... [CREATE TABLE in 3.25s]
2018-04-17 14:19:25,874: 14:19:25 | 32 of 91 START table model agency_data_pipeline.agg_orders_union..... [RUN]
2018-04-17 14:19:25,875: Compiling model.agency_data_pipeline.agg_orders_union
2018-04-17 14:19:25,883: Writing injected SQL for node "model.agency_data_pipeline.agg_orders_union"
2018-04-17 14:19:25,884: Acquiring new bigquery connection "agg_orders_union".
2018-04-17 14:19:25,884: Re-using an available connection from the pool.
2018-04-17 14:19:26,203: Model SQL (ga_traffic):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc`, `growth-engines-pipeline`.`agency_data_pipeline`.`ga_conversions`


##`growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` 



with ga_report as (

	    

	    	
	    	
		   	SELECT
		   	'lucadanni' as client_name,
		   	'GA Traffic' as lookup_platform,
			lower(trim(regexp_replace(replace(replace(replace(replace(CONCAT(hostname,landingpagepath),'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
			date,
			lower(source) source,
			lower(medium) medium,
			lower(campaign) campaign,
			sessions,
			## goal completion columns
							
				goalcompletionsall as goal_completions,		
			
			_sdc_sequence,
			first_value(_sdc_sequence) OVER (PARTITION BY hostname, landingpagepath, date, source, medium, campaign ORDER BY _sdc_sequence DESC) lv
			FROM `growth-engines-pipeline.ga_lucadanni_traffic.report` 

		    
	   

)


SELECT  
cast(date as date) date,
b.account,
b.client client,
c.source source,
c.medium medium,
a.campaign campaign,
concat(a.source, ' / ', a.medium) source_medium,  
case when c.platform is null then "Unmapped" else c.platform end as platform,
case when c.channel is null then "Unmapped" else c.channel end as channel,
regexp_replace(url, r'offers.|offer.|get.|info.|pos.|go.|join.|pages.','') url,
max(sessions) sessions,
max(goal_completions) goal_completions
FROM ga_report a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
ON ( a.client_name = b.client_name 
	AND a.lookup_platform = b.platform )
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc` c
ON ( a.source = c.source
  AND a.medium = c.medium 
  AND a.client_name = c.client_name )
GROUP BY date, account, client, source, medium, campaign, source_medium, platform, channel, url


2018-04-17 14:19:26,282: Model SQL (ga_transactions):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc`, `growth-engines-pipeline`.`agency_data_pipeline`.`ga_conversions`


##`growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` 



with ga_report as (

	    

	    	
	    	
		   	SELECT
		   	'lucadanni' as client_name,
		   	'Google Analytics' as lookup_platform,
			lower(trim(regexp_replace(replace(replace(replace(replace(CONCAT(hostname,landingpagepath),'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
			date,
			lower(source) source,
			lower(medium) medium,
			lower(campaign) campaign,
			cast(regexp_replace(transactionid, r'#', '') as int64) transactionid,
			transactions last_touch_transactions,
			(transactionrevenue - transactionshipping - transactiontax) as last_touch_revenue,
			transactionshipping,
			transactiontax,
			_sdc_sequence,
			first_value(_sdc_sequence) OVER (PARTITION BY hostname, landingpagepath, date, source, medium, transactionid ORDER BY _sdc_sequence DESC) lv
			FROM `growth-engines-pipeline.ga_lucadanni.report` 

		    
	   

)


SELECT  
cast(date as date) date,
b.account,
b.client client,
c.source source,
c.medium medium,
a.campaign campaign,
concat(a.source, ' / ', a.medium) source_medium,  
case when c.platform is null then "Unmapped" else c.platform end as platform,
case when c.channel is null then "Unmapped" else c.channel end as channel,
regexp_replace(url, r'offers.|offer.|get.|info.|pos.|go.|join.|pages.','') url,
transactionid,
max(last_touch_transactions) last_touch_transactions,
max(last_touch_revenue) last_touch_revenue,
max(transactionshipping) last_touch_shipping,
max(transactiontax) last_touch_tax
FROM ga_report a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
ON ( a.client_name = b.client_name 
	AND a.lookup_platform = b.platform )
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc` c
ON ( a.source = c.source
  AND a.medium = c.medium 
  AND a.client_name = c.client_name )
GROUP BY date, account, client, source, medium, campaign, source_medium, platform, channel, url, transactionid


2018-04-17 14:19:26,667: Model SQL (agg_orders_union):
SELECT
account,
client,
platform,
created_at,
order_number,
quantity,
refund_quantity,
final_quantity,
price, 
total_order_price_undiscounted,
total_discounts,
total_order_shipping_price,
total_order_price_incl_shipping,
refund_amount,
final_price,
checkout_id,
product_id, 
landing_site,
sku, 
variant_title, 
variant_id,
line_item_id,	
customer_id,
orders_count,
customer_created_at,
last_order_id,
financial_status
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`shopify_orders_proc`
2018-04-17 14:19:29,036: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4eeb33a9-7300-4c28-ad4b-1e14f2165a72', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104b0e668>]}
2018-04-17 14:19:29,276: 14:19:29 | 29 of 91 OK created table model agency_data_pipeline.adwords_join.... [CREATE TABLE in 6.66s]
2018-04-17 14:19:31,834: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4eeb33a9-7300-4c28-ad4b-1e14f2165a72', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108006cf8>]}
2018-04-17 14:19:32,273: 14:19:32 | 30 of 91 OK created table model agency_data_pipeline.ga_transactions. [CREATE TABLE in 9.46s]
2018-04-17 14:19:33,352: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4eeb33a9-7300-4c28-ad4b-1e14f2165a72', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104aa5710>]}
2018-04-17 14:19:33,596: 14:19:33 | 32 of 91 OK created table model agency_data_pipeline.agg_orders_union [CREATE TABLE in 7.48s]
2018-04-17 14:19:36,238: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4eeb33a9-7300-4c28-ad4b-1e14f2165a72', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104b17e80>]}
2018-04-17 14:19:36,498: 14:19:36 | 31 of 91 OK created table model agency_data_pipeline.ga_traffic...... [CREATE TABLE in 13.86s]
2018-04-17 14:19:36,499: 14:19:36 | 33 of 91 START table model agency_data_pipeline.agg_transaction_order_number [RUN]
2018-04-17 14:19:36,500: Compiling model.agency_data_pipeline.agg_transaction_order_number
2018-04-17 14:19:36,499: 14:19:36 | 34 of 91 START table model agency_data_pipeline.adwords_stats........ [RUN]
2018-04-17 14:19:36,507: Compiling model.agency_data_pipeline.adwords_stats
2018-04-17 14:19:36,514: Writing injected SQL for node "model.agency_data_pipeline.agg_transaction_order_number"
2018-04-17 14:19:36,514: Writing injected SQL for node "model.agency_data_pipeline.adwords_stats"
2018-04-17 14:19:36,499: 14:19:36 | 35 of 91 START table model agency_data_pipeline.agg_transaction_line_item [RUN]
2018-04-17 14:19:36,500: 14:19:36 | 36 of 91 START table model agency_data_pipeline.adwords_impression_share [RUN]
2018-04-17 14:19:36,515: Acquiring new bigquery connection "agg_transaction_order_number".
2018-04-17 14:19:36,515: Compiling model.agency_data_pipeline.agg_transaction_line_item
2018-04-17 14:19:36,515: Compiling model.agency_data_pipeline.adwords_impression_share
2018-04-17 14:19:36,515: Re-using an available connection from the pool.
2018-04-17 14:19:36,520: Writing injected SQL for node "model.agency_data_pipeline.agg_transaction_line_item"
2018-04-17 14:19:36,520: Acquiring new bigquery connection "adwords_stats".
2018-04-17 14:19:36,525: Writing injected SQL for node "model.agency_data_pipeline.adwords_impression_share"
2018-04-17 14:19:36,527: Re-using an available connection from the pool.
2018-04-17 14:19:36,529: Acquiring new bigquery connection "agg_transaction_line_item".
2018-04-17 14:19:36,529: Re-using an available connection from the pool.
2018-04-17 14:19:36,537: Acquiring new bigquery connection "adwords_impression_share".
2018-04-17 14:19:36,541: Re-using an available connection from the pool.
2018-04-17 14:19:37,421: Model SQL (adwords_impression_share):
SELECT 
cast(day as date) date, 
account, 
channel,
platform,
sum(impression_share_num) impressions,
sum(impression_share_den) available_impressions
FROM 
  `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_join`
group by date, account, platform, channel
2018-04-17 14:19:37,440: Model SQL (agg_transaction_line_item):
SELECT
client,
created_at,
order_number,
quantity,
refund_quantity,
final_quantity,
price, 
total_order_price_undiscounted,
total_discounts,
total_order_shipping_price,
total_order_price_incl_shipping,
refund_amount,
final_price,
checkout_id,
product_id, 
landing_site,
sku, 
variant_title, 
variant_id,
line_item_id,	
customer_id,
orders_count,
customer_created_at,
last_order_id,
financial_status
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`agg_orders_union`
2018-04-17 14:19:37,472: Model SQL (adwords_stats):
SELECT 
cast(day as date) date, 
account, 
platform,
channel,
url,
utm_campaign,
campaign,
sum(cost) cost,
sum(impressions) impressions,
sum(clicks) clicks,
sum(transactions) transactions
FROM 
  `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_join`
group by date, account, platform, channel, url, campaign, utm_campaign
2018-04-17 14:19:37,482: Model SQL (agg_transaction_order_number):
SELECT
client,
cast(created_at as date) date,
order_number,
customer_id,
sum(final_quantity) final_quantity,
sum(final_price) final_price,
max(total_order_shipping_price) shipping_price
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`agg_orders_union`
GROUP BY client, created_at, order_number, customer_id
2018-04-17 14:19:39,652: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4eeb33a9-7300-4c28-ad4b-1e14f2165a72', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1080499e8>]}
2018-04-17 14:19:40,620: 14:19:40 | 36 of 91 OK created table model agency_data_pipeline.adwords_impression_share [CREATE TABLE in 3.14s]
2018-04-17 14:19:40,620: 14:19:40 | 37 of 91 START table model agency_data_pipeline.fb_ads_stats......... [RUN]
2018-04-17 14:19:40,621: Compiling model.agency_data_pipeline.fb_ads_stats
2018-04-17 14:19:40,629: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_stats"
2018-04-17 14:19:40,629: Acquiring new bigquery connection "fb_ads_stats".
2018-04-17 14:19:40,630: Re-using an available connection from the pool.
2018-04-17 14:19:40,967: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4eeb33a9-7300-4c28-ad4b-1e14f2165a72', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104ba1a90>]}
2018-04-17 14:19:41,219: 14:19:41 | 33 of 91 OK created table model agency_data_pipeline.agg_transaction_order_number [CREATE TABLE in 4.47s]
2018-04-17 14:19:41,383: Model SQL (fb_ads_stats):
with cost as (

    select 
        date, account, ad_id, campaign,
        cost, impressions, clicks, null as conversions
    from `growth-engines-pipeline`.`agency_data_pipeline`.`fb_ads_insights`
),

conversions as (

    select 
        date, account, ad_id, campaign,
        null as cost, null as impressions, null as clicks, conversions
    from `growth-engines-pipeline`.`agency_data_pipeline`.`fb_ads_insights_conversions`
),

urls as (

    select ad_id, url
    from `growth-engines-pipeline`.`agency_data_pipeline`.`fb_ads`
)


SELECT
    cast(date as date) date,
    'FB Ads' platform,
    'Paid' channel,
    account, 
    b.url url,
    campaign,
    lower(campaign) utm_campaign, 
    sum(cost) cost,
    sum(impressions) impressions,
    sum(clicks) clicks,
    sum(conversions) transactions
FROM
(
    SELECT *
    FROM 
      cost
    UNION ALL
    SELECT *
    FROM 
      conversions
) a
LEFT JOIN urls b
ON ( a.ad_id = b.ad_id )
group by date, platform, channel, account, url, campaign, utm_campaign
2018-04-17 14:19:43,059: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4eeb33a9-7300-4c28-ad4b-1e14f2165a72', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108006cf8>]}
2018-04-17 14:19:43,387: 14:19:43 | 34 of 91 OK created table model agency_data_pipeline.adwords_stats... [CREATE TABLE in 6.55s]
2018-04-17 14:19:43,619: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4eeb33a9-7300-4c28-ad4b-1e14f2165a72', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1080499e8>]}
2018-04-17 14:19:43,944: 14:19:43 | 37 of 91 OK created table model agency_data_pipeline.fb_ads_stats.... [CREATE TABLE in 3.00s]
2018-04-17 14:19:44,094: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4eeb33a9-7300-4c28-ad4b-1e14f2165a72', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108006b38>]}
2018-04-17 14:19:44,508: 14:19:44 | 35 of 91 OK created table model agency_data_pipeline.agg_transaction_line_item [CREATE TABLE in 7.58s]
2018-04-17 14:19:44,509: 14:19:44 | 38 of 91 START table model agency_data_pipeline.customers_by_transaction [RUN]
2018-04-17 14:19:44,509: Compiling model.agency_data_pipeline.customers_by_transaction
2018-04-17 14:19:44,517: Writing injected SQL for node "model.agency_data_pipeline.customers_by_transaction"
2018-04-17 14:19:44,519: Acquiring new bigquery connection "customers_by_transaction".
2018-04-17 14:19:44,519: Re-using an available connection from the pool.
2018-04-17 14:19:45,446: Model SQL (customers_by_transaction):
SELECT
client,
customer_id,
order_number,
order_date,
first_order_date,
case when first_order_number = order_number then 'New' else 'Existing' end as order_type,
final_price,
first_order_revenue,
lifetime_revenue
FROM

(

	SELECT
	client,
	customer_id,
	order_number,
	date order_date,
	first_value(date) over w1 first_order_date,
	first_value(order_number) over w1 first_order_number,
	first_value(final_price) over w1 first_order_revenue,
    final_price,
	sum(final_price) over w2 lifetime_revenue
	FROM
    `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_order_number`
	WINDOW w1 as (PARTITION BY client, customer_id ORDER BY date desc),
	w2 as (PARTITION BY client, customer_id)
)
2018-04-17 14:19:48,788: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4eeb33a9-7300-4c28-ad4b-1e14f2165a72', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107f46d68>]}
2018-04-17 14:19:49,049: 14:19:49 | 38 of 91 OK created table model agency_data_pipeline.customers_by_transaction [CREATE TABLE in 4.28s]
2018-04-17 14:19:49,050: 14:19:49 | 39 of 91 START table model agency_data_pipeline.agg_ga_transaction_order_number [RUN]
2018-04-17 14:19:49,051: Compiling model.agency_data_pipeline.agg_ga_transaction_order_number
2018-04-17 14:19:49,050: 14:19:49 | 40 of 91 START table model agency_data_pipeline.frequency_proc....... [RUN]
2018-04-17 14:19:49,057: Compiling model.agency_data_pipeline.frequency_proc
2018-04-17 14:19:49,062: Writing injected SQL for node "model.agency_data_pipeline.frequency_proc"
2018-04-17 14:19:49,064: Writing injected SQL for node "model.agency_data_pipeline.agg_ga_transaction_order_number"
2018-04-17 14:19:49,065: Acquiring new bigquery connection "frequency_proc".
2018-04-17 14:19:49,065: Re-using an available connection from the pool.
2018-04-17 14:19:49,066: Acquiring new bigquery connection "agg_ga_transaction_order_number".
2018-04-17 14:19:49,066: Re-using an available connection from the pool.
2018-04-17 14:19:49,738: Model SQL (frequency_proc):
WITH transactions AS (

  	SELECT 
	client,
	customer_id,
	order_number,
	date,
	unix_date(order_date) d
	FROM
	`growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_order_number`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)

SELECT 
client,
'Rolling 365' as period,
date_in_range date,
unix_date_in_range, 
customer_id,
count(distinct(order_number)) frequency
FROM daterange
JOIN transactions
ON transactions.d > ( daterange.unix_date_in_range - 365 )
AND transactions.d <= daterange.unix_date_in_range
group by client, unix_date_in_range, customer_id
2018-04-17 14:19:49,739: Bad request while running:
WITH transactions AS (

  	SELECT 
	client,
	customer_id,
	order_number,
	date,
	unix_date(order_date) d
	FROM
	`growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_order_number`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)

SELECT 
client,
'Rolling 365' as period,
date_in_range date,
unix_date_in_range, 
customer_id,
count(distinct(order_number)) frequency
FROM daterange
JOIN transactions
ON transactions.d > ( daterange.unix_date_in_range - 365 )
AND transactions.d <= daterange.unix_date_in_range
group by client, unix_date_in_range, customer_id
2018-04-17 14:19:49,740: 400 Unrecognized name: order_date at [8:19]
2018-04-17 14:19:49,741: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4eeb33a9-7300-4c28-ad4b-1e14f2165a72', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104afe4e0>]}
2018-04-17 14:19:49,987: 14:19:49 | 40 of 91 ERROR creating table model agency_data_pipeline.frequency_proc [ERROR in 0.68s]
2018-04-17 14:19:50,050: Model SQL (agg_ga_transaction_order_number):
with ga as (

    select 
        date, account, client, 
        channel as last_touch_channel, 
        platform as last_touch_platform, 
        url as last_touch_url, 
        campaign as last_touch_utm_campaign, 
        '' as first_touch_channel, 
        '' as first_touch_platform, 
        '' as first_touch_utm_campaign, 
        transactionid,
        last_touch_transactions, last_touch_revenue,
        last_touch_shipping, last_touch_tax,
        null as first_touch_transactions, null as first_touch_revenue
    from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_transactions`

),

ga_mcf as (

    select 
        date, account, client, 
        '' as last_touch_channel,
        '' as last_touch_platform,
        '' as last_touch_url,
        '' as last_touch_utm_campaign, 
        channel as first_touch_channel, 
        platform as first_touch_platform, 
        campaign as first_touch_utm_campaign, 
        transactionid, 
        null as last_touch_transactions, null as last_touch_revenue,
        null as last_touch_shipping, null as last_touch_tax,
        first_touch_transactions, first_touch_revenue
    from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_mcf_stats`

)


SELECT
    date, 
    client,
    transactionid,
    max(last_touch_channel) last_touch_channel, 
    max(last_touch_platform) last_touch_platform, 
    max(last_touch_url) last_touch_url, 
    max(last_touch_utm_campaign) last_touch_utm_campaign, 
    max(first_touch_channel) first_touch_channel, 
    max(first_touch_platform) first_touch_platform, 
    max(first_touch_utm_campaign) first_touch_utm_campaign,
    sum(last_touch_transactions) last_touch_transactions,
    sum(last_touch_revenue) last_touch_revenue,
    sum(last_touch_shipping) last_touch_shipping_revenue,
    sum(last_touch_tax) last_touch_tax_revenue,
    sum(first_touch_transactions) first_touch_transactions,
    sum(first_touch_revenue) - ifnull(sum(last_touch_shipping),0) - ifnull(sum(last_touch_tax),0) first_touch_revenue
FROM
(
    SELECT *
    FROM 
      ga
    UNION ALL
    SELECT *
    FROM 
      ga_mcf
) 
GROUP BY
    date, client, transactionid
2018-04-17 14:19:55,665: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4eeb33a9-7300-4c28-ad4b-1e14f2165a72', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108006b38>]}
2018-04-17 14:19:55,928: 14:19:55 | 39 of 91 OK created table model agency_data_pipeline.agg_ga_transaction_order_number [CREATE TABLE in 6.61s]
2018-04-17 14:19:55,929: 14:19:55 | 41 of 91 SKIP relation agency_data_pipeline.frequency_stats.......... [SKIP]
2018-04-17 14:19:55,929: 14:19:55 | 42 of 91 START table model agency_data_pipeline.agg_transaction_line_item_type [RUN]
2018-04-17 14:19:55,930: 14:19:55 | 43 of 91 START table model agency_data_pipeline.agg_ga_campaign...... [RUN]
2018-04-17 14:19:55,930: Compiling model.agency_data_pipeline.agg_transaction_line_item_type
2018-04-17 14:19:55,930: Compiling model.agency_data_pipeline.agg_ga_campaign
2018-04-17 14:19:55,945: Writing injected SQL for node "model.agency_data_pipeline.agg_transaction_line_item_type"
2018-04-17 14:19:55,946: Writing injected SQL for node "model.agency_data_pipeline.agg_ga_campaign"
2018-04-17 14:19:55,947: Acquiring new bigquery connection "agg_transaction_line_item_type".
2018-04-17 14:19:55,947: Re-using an available connection from the pool.
2018-04-17 14:19:55,948: Acquiring new bigquery connection "agg_ga_campaign".
2018-04-17 14:19:55,948: Re-using an available connection from the pool.
2018-04-17 14:19:56,835: Model SQL (agg_ga_campaign):
with ga_transactions as (

	select 
		date, account, client, channel, platform, url, 
		campaign,
		null as sessions, null as goal_completions, last_touch_transactions, last_touch_revenue,
		last_touch_shipping, last_touch_tax,
		null as first_touch_transactions, null as first_touch_revenue
	from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_transactions`

),

ga_traffic as (

    select 
        date, account, client, channel, platform, url, 
        campaign,
        sessions, goal_completions, null as last_touch_transactions, null as last_touch_revenue,
        null as last_touch_shipping, null as last_touch_tax,
        null as first_touch_transactions, null as first_touch_revenue
    from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_traffic`

),

ga_mcf as (

	select 
		date, account, client, channel, platform, '' as url,
		campaign, 
		null as sessions, null as goal_completions, null as last_touch_transactions, null as last_touch_revenue,
		null as last_touch_shipping, null as last_touch_tax,
		first_touch_transactions, first_touch_revenue
	from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_mcf_stats`

)


SELECT
    date, 
    client,
    platform,
    channel, 
    url,
    campaign utm_campaign,
	sum(sessions) sessions,
	sum(goal_completions) goal_completions,
	sum(last_touch_transactions) last_touch_transactions,
	sum(last_touch_revenue) last_touch_revenue,
    sum(last_touch_shipping) last_touch_shipping_revenue,
    sum(last_touch_tax) last_touch_tax_revenue,
    sum(first_touch_transactions) first_touch_transactions,
    sum(first_touch_revenue) - sum(ifnull(last_touch_shipping,0)) - sum(ifnull(last_touch_tax,0)) first_touch_revenue

FROM
(
    SELECT *
    FROM 
      ga_transactions
    UNION ALL
    SELECT *
    FROM 
      ga_traffic
    UNION ALL
    SELECT *
    FROM 
      ga_mcf
) 
GROUP BY
    date, client, platform, channel, url, utm_campaign
2018-04-17 14:19:56,847: Model SQL (agg_transaction_line_item_type):
SELECT
client,
product_id,
product_type,
customer_id,
sku,
order_number,
created_at,
final_quantity,
final_price
FROM

( 
	SELECT 
	a.client, 
	a.product_id,
	product_type,
	customer_id,
	a.sku, 
	order_number,
	created_at,
	final_quantity,
	final_price
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_line_item` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`agg_products` b
	ON (
		a.product_id = b.product_id
	  and a.client = b.client
		)

)
2018-04-17 14:20:02,449: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4eeb33a9-7300-4c28-ad4b-1e14f2165a72', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104bb0630>]}
2018-04-17 14:20:02,687: 14:20:02 | 42 of 91 OK created table model agency_data_pipeline.agg_transaction_line_item_type [CREATE TABLE in 6.52s]
2018-04-17 14:20:06,950: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4eeb33a9-7300-4c28-ad4b-1e14f2165a72', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108006cf8>]}
2018-04-17 14:20:07,188: 14:20:07 | 43 of 91 OK created table model agency_data_pipeline.agg_ga_campaign. [CREATE TABLE in 11.02s]
2018-04-17 14:20:07,189: 14:20:07 | 44 of 91 START table model agency_data_pipeline.agg_transaction_product_type [RUN]
2018-04-17 14:20:07,189: Compiling model.agency_data_pipeline.agg_transaction_product_type
2018-04-17 14:20:07,189: 14:20:07 | 45 of 91 START table model agency_data_pipeline.customers_first_purchase_product_type_proc [RUN]
2018-04-17 14:20:07,196: Compiling model.agency_data_pipeline.customers_first_purchase_product_type_proc
2018-04-17 14:20:07,204: Writing injected SQL for node "model.agency_data_pipeline.agg_transaction_product_type"
2018-04-17 14:20:07,206: Writing injected SQL for node "model.agency_data_pipeline.customers_first_purchase_product_type_proc"
2018-04-17 14:20:07,213: Acquiring new bigquery connection "agg_transaction_product_type".
2018-04-17 14:20:07,213: Re-using an available connection from the pool.
2018-04-17 14:20:07,218: Acquiring new bigquery connection "customers_first_purchase_product_type_proc".
2018-04-17 14:20:07,219: Re-using an available connection from the pool.
2018-04-17 14:20:08,190: Model SQL (customers_first_purchase_product_type_proc):
SELECT 
client, 
customer_id, 
product_type,
min(cast(created_at as date)) first_order_date,
unix_date( min(cast(created_at as date))) first_order_unix_date
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_line_item_type`
GROUP BY client, customer_id, product_type
2018-04-17 14:20:08,201: Model SQL (agg_transaction_product_type):
SELECT
client,
product_type,
customer_id,
order_number,
created_at,
first_value(product_type) over (PARTITION BY client, customer_id, order_number, created_at ORDER BY final_price desc) as top_order_product_type,
final_quantity,
final_price,
sum(final_quantity) over (PARTITION BY client, customer_id, order_number) as total_order_quantity,
sum(final_price) over (PARTITION BY client, customer_id, order_number) as total_order_value
FROM
	(
		SELECT
		client,
		product_type,
		customer_id,
		order_number,
		created_at,
		sum(final_quantity) final_quantity,
		sum(final_price) final_price
		FROM
		`growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_line_item_type`
		GROUP BY
		client,
		product_type,
		customer_id,
		order_number,
		created_at
	)
2018-04-17 14:20:11,582: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4eeb33a9-7300-4c28-ad4b-1e14f2165a72', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104b7ab38>]}
2018-04-17 14:20:11,838: 14:20:11 | 45 of 91 OK created table model agency_data_pipeline.customers_first_purchase_product_type_proc [CREATE TABLE in 4.39s]
2018-04-17 14:20:12,659: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4eeb33a9-7300-4c28-ad4b-1e14f2165a72', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108006b38>]}
2018-04-17 14:20:12,906: 14:20:12 | 44 of 91 OK created table model agency_data_pipeline.agg_transaction_product_type [CREATE TABLE in 5.47s]
2018-04-17 14:20:12,907: 14:20:12 | 46 of 91 START table model agency_data_pipeline.customers_products_proc [RUN]
2018-04-17 14:20:12,907: 14:20:12 | 47 of 91 START table model agency_data_pipeline.products_proc........ [RUN]
2018-04-17 14:20:12,908: Compiling model.agency_data_pipeline.customers_products_proc
2018-04-17 14:20:12,908: 14:20:12 | 48 of 91 START table model agency_data_pipeline.order_paths_proc..... [RUN]
2018-04-17 14:20:12,908: Compiling model.agency_data_pipeline.products_proc
2018-04-17 14:20:12,915: Compiling model.agency_data_pipeline.order_paths_proc
2018-04-17 14:20:12,916: Writing injected SQL for node "model.agency_data_pipeline.customers_products_proc"
2018-04-17 14:20:12,922: Writing injected SQL for node "model.agency_data_pipeline.products_proc"
2018-04-17 14:20:12,926: Writing injected SQL for node "model.agency_data_pipeline.order_paths_proc"
2018-04-17 14:20:12,927: Acquiring new bigquery connection "products_proc".
2018-04-17 14:20:12,928: Re-using an available connection from the pool.
2018-04-17 14:20:12,928: Acquiring new bigquery connection "customers_products_proc".
2018-04-17 14:20:12,929: Re-using an available connection from the pool.
2018-04-17 14:20:12,933: Acquiring new bigquery connection "order_paths_proc".
2018-04-17 14:20:12,933: Re-using an available connection from the pool.
2018-04-17 14:20:13,987: Model SQL (order_paths_proc):
SELECT
client, 
customer_id, 
first_value(product_type) OVER w1 as first_product_type,
nth_value(product_type, 2) OVER w1 as second_product_type,
cast(first_value(created_at) OVER w1 as date) as first_purchase_date,
cast(nth_value(created_at, 2) OVER w1 as date) as second_purchase_date,
cast(nth_value(created_at, 3) OVER w1 as date) as third_purchase_date,
cast(nth_value(created_at, 4) OVER w1 as date) as fourth_purchase_date,
cast(nth_value(created_at, 5) OVER w1 as date) as fifth_purchase_date,
first_value(order_number) OVER w1 as first_order_number,
nth_value(order_number, 2) OVER w1 as second_order_number,
nth_value(order_number, 3) OVER w1 as third_order_number,
nth_value(order_number, 4) OVER w1 as fourth_order_number,
nth_value(order_number, 5) OVER w1 as fifth_order_number,
first_value(total_order_value) OVER w1 as first_order_value,
nth_value(total_order_value, 2) OVER w1 as second_order_value
FROM (
	  
	  SELECT 
	  client, 
	  product_type,
	  customer_id,
	  order_number,
	  created_at, 
	  total_order_value
	  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_product_type`
	  WHERE product_type = top_order_product_type

)
WINDOW w1 as (PARTITION BY client, customer_id ORDER BY created_at asc)
2018-04-17 14:20:13,988: Model SQL (customers_products_proc):
WITH customers AS (
  SELECT 
  client, 
  product_id,
  product_type,
  customer_id,
  sku, 
  order_number,
  cast(created_at as date) order_date,
  unix_date(cast(created_at as date)) unix_order_date, 
  final_quantity quantity,
  final_price revenue
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_line_item_type`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)

SELECT 
client,
period,
customer_id,
product_type,
date,
window_end_unix_date,
window_end_unix_date - 365 as window_start_unix_date,
window_end_unix_date - unix_date(recent_order) recency_days,
frequency,
quantity,
revenue,
case when frequency > 0 then revenue/frequency else 0 end as aov
FROM 
(  

  SELECT 
  client,
  'Rolling 365' as period,
  customer_id,
  product_type,
  date_in_range date,
  unix_date_in_range,
  unix_date_in_range window_end_unix_date, 
  max(order_date) recent_order,
  sum(quantity) as quantity,
  sum(revenue) as revenue,
  count(distinct(order_number)) as frequency
  FROM daterange
  JOIN customers
  ON customers.unix_order_date > ( daterange.unix_date_in_range - 365 )
  AND customers.unix_order_date <= daterange.unix_date_in_range
  GROUP BY client, customer_id, date, unix_date_in_range, product_type

  UNION ALL

  SELECT 
  client,
  'Rolling 365 (t-1mo)' as period,
  customer_id,
  product_type,
  date_in_range date,
  unix_date_in_range, 
  unix_date_in_range - 30 window_end_unix_date, 
  max(order_date) recent_order,
  sum(quantity) as quantity,
  sum(revenue) as revenue,
  count(distinct(order_number)) as frequency
  FROM daterange
  JOIN customers
  ON customers.unix_order_date > ( daterange.unix_date_in_range - 395 )
  AND customers.unix_order_date <= ( daterange.unix_date_in_range - 30 )
  GROUP BY client, customer_id, date, unix_date_in_range, product_type

  UNION ALL

  SELECT 
  client,
  'Rolling 365 (t-1yr)' as period,
  customer_id,
  product_type,
  date_in_range date,
  unix_date_in_range, 
  unix_date_in_range - 365 window_end_unix_date, 
  max(order_date) recent_order,
  sum(quantity) as quantity,
  sum(revenue) as revenue,
  count(distinct(order_number)) as frequency
  FROM daterange
  JOIN customers
  ON customers.unix_order_date > ( daterange.unix_date_in_range - 730 )
  AND customers.unix_order_date <= ( daterange.unix_date_in_range - 365 )
  GROUP BY client, customer_id, date, unix_date_in_range, product_type

)
2018-04-17 14:20:13,989: Model SQL (products_proc):
WITH transactions AS (
  SELECT 
  client, 
  product_id,
  product_type,
  customer_id,
  sku, 
  order_number,
  unix_date(cast(created_at as date)) d, 
  final_quantity,
  final_price
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_line_item_type`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)

SELECT 
client,
'Last 30' as period,
sku, 
product_type,
date_in_range date,
unix_date_in_range, 
count(distinct(customer_id)) unique_customers,
count(distinct(order_number)) orders,
sum(final_quantity) quantity,
sum(final_price) revenue
FROM daterange
JOIN transactions
ON transactions.d > ( daterange.unix_date_in_range - 30 )
AND transactions.d <= daterange.unix_date_in_range
group by date_in_range, unix_date_in_range, client, sku, product_type

UNION ALL

SELECT 
client,
'Last 90' as period,
sku, 
product_type,
date_in_range date,
unix_date_in_range, 
count(distinct(customer_id)) unique_customers,
count(distinct(order_number)) orders,
sum(final_quantity) quantity,
sum(final_price) revenue
FROM daterange
JOIN transactions
ON transactions.d > ( daterange.unix_date_in_range - 90 )
AND transactions.d <= daterange.unix_date_in_range
group by date_in_range, unix_date_in_range, client, sku, product_type

UNION ALL

SELECT 
client,
'YoY 30' as date_range,
sku, 
product_type,
date_in_range date,
unix_date_in_range, 
count(distinct(customer_id)) unique_customers,
count(distinct(order_number)) orders,
sum(final_quantity) quantity,
sum(final_price) revenue
FROM daterange
JOIN transactions
ON transactions.d > ( daterange.unix_date_in_range - 395 )
AND transactions.d <= ( daterange.unix_date_in_range - 365 )
group by date_in_range, unix_date_in_range, client, sku, product_type
2018-04-17 14:20:16,250: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4eeb33a9-7300-4c28-ad4b-1e14f2165a72', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104b36860>]}
2018-04-17 14:20:16,917: 14:20:16 | 48 of 91 OK created table model agency_data_pipeline.order_paths_proc [CREATE TABLE in 3.34s]
2018-04-17 14:20:21,914: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4eeb33a9-7300-4c28-ad4b-1e14f2165a72', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104b17da0>]}
2018-04-17 14:20:22,155: 14:20:22 | 47 of 91 OK created table model agency_data_pipeline.products_proc... [CREATE TABLE in 9.01s]
2018-04-17 14:20:48,434: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4eeb33a9-7300-4c28-ad4b-1e14f2165a72', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108006cf8>]}
2018-04-17 14:20:48,750: 14:20:48 | 46 of 91 OK created table model agency_data_pipeline.customers_products_proc [CREATE TABLE in 35.53s]
2018-04-17 14:20:48,751: 14:20:48 | 49 of 91 START table model agency_data_pipeline.segment_proc_sku..... [RUN]
2018-04-17 14:20:48,752: 14:20:48 | 50 of 91 START table model agency_data_pipeline.order_paths_agg...... [RUN]
2018-04-17 14:20:48,752: Compiling model.agency_data_pipeline.segment_proc_sku
2018-04-17 14:20:48,752: Compiling model.agency_data_pipeline.order_paths_agg
2018-04-17 14:20:48,767: Writing injected SQL for node "model.agency_data_pipeline.segment_proc_sku"
2018-04-17 14:20:48,771: Writing injected SQL for node "model.agency_data_pipeline.order_paths_agg"
2018-04-17 14:20:48,772: Acquiring new bigquery connection "segment_proc_sku".
2018-04-17 14:20:48,772: Re-using an available connection from the pool.
2018-04-17 14:20:48,775: Acquiring new bigquery connection "order_paths_agg".
2018-04-17 14:20:48,775: Re-using an available connection from the pool.
2018-04-17 14:20:51,699: Model SQL (order_paths_agg):
SELECT
client, 
first_product_type,
second_product_type,
first_purchase_date,
count(distinct(customer_id)) customer_count, 
count(distinct(second_order_number)) second_orders, 
count(distinct(third_order_number)) third_orders, 
count(distinct(fourth_order_number)) fourth_orders, 
count(distinct(fifth_order_number)) fifth_orders, 
sum(date_diff(second_purchase_date, first_purchase_date, DAY)) second_order_latency_days,
sum(date_diff(third_purchase_date, second_purchase_date, DAY)) third_order_latency_days,
sum(date_diff(fourth_purchase_date, third_purchase_date, DAY)) fourth_order_latency_days,
sum(date_diff(fifth_purchase_date, fourth_purchase_date, DAY)) fifth_order_latency_days,
sum(first_order_value) first_order_revenue,
sum(second_order_value) second_order_revenue
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`order_paths_proc`
where second_product_type is not null
GROUP BY client, first_product_type, second_product_type, first_purchase_date
2018-04-17 14:20:51,700: Model SQL (segment_proc_sku):
SELECT
client,
period,
sku, 
product_type,
date,
unique_customers,
orders,
quantity,
revenue,
case when orders > orders_90pct then 'Best Seller'
	when orders > orders_75pct then 'Good'
	when orders > orders_25pct then 'Average'
	else 'Poor' end as segment,
orders_90pct,
orders_75pct,
orders_25pct
FROM
(
	SELECT 
	client,
	period,
	sku, 
	product_type,
	date,
	unique_customers,
	orders,
	quantity,
	revenue,
	PERCENTILE_CONT(orders, 0.90) OVER w1 AS orders_90pct,
	PERCENTILE_CONT(orders, 0.75) OVER w1 AS orders_75pct,
	PERCENTILE_CONT(orders, 0.25) OVER w1 AS orders_25pct
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`products_proc`
	WINDOW w1 as (PARTITION BY client, period, date)
)
2018-04-17 14:20:53,237: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4eeb33a9-7300-4c28-ad4b-1e14f2165a72', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10802bd30>]}
2018-04-17 14:20:54,061: 14:20:54 | 50 of 91 OK created table model agency_data_pipeline.order_paths_agg. [CREATE TABLE in 4.48s]
2018-04-17 14:20:54,769: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4eeb33a9-7300-4c28-ad4b-1e14f2165a72', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108006b38>]}
2018-04-17 14:20:55,133: 14:20:55 | 49 of 91 OK created table model agency_data_pipeline.segment_proc_sku [CREATE TABLE in 6.02s]
2018-04-17 14:20:55,134: 14:20:55 | 51 of 91 START table model agency_data_pipeline.segment_proc_customers_products [RUN]
2018-04-17 14:20:55,135: 14:20:55 | 52 of 91 START table model agency_data_pipeline.agg_transaction...... [RUN]
2018-04-17 14:20:55,135: 14:20:55 | 53 of 91 START table model agency_data_pipeline.agg_ga_transaction... [RUN]
2018-04-17 14:20:55,135: 14:20:55 | 54 of 91 START table model agency_data_pipeline.segment_stats_sku.... [RUN]
2018-04-17 14:20:55,135: Compiling model.agency_data_pipeline.segment_proc_customers_products
2018-04-17 14:20:55,136: Compiling model.agency_data_pipeline.agg_transaction
2018-04-17 14:20:55,136: Compiling model.agency_data_pipeline.agg_ga_transaction
2018-04-17 14:20:55,136: Compiling model.agency_data_pipeline.segment_stats_sku
2018-04-17 14:20:55,154: Writing injected SQL for node "model.agency_data_pipeline.segment_proc_customers_products"
2018-04-17 14:20:55,166: Writing injected SQL for node "model.agency_data_pipeline.segment_stats_sku"
2018-04-17 14:20:55,168: Writing injected SQL for node "model.agency_data_pipeline.agg_ga_transaction"
2018-04-17 14:20:55,169: Writing injected SQL for node "model.agency_data_pipeline.agg_transaction"
2018-04-17 14:20:55,173: Acquiring new bigquery connection "segment_proc_customers_products".
2018-04-17 14:20:55,174: Acquiring new bigquery connection "segment_stats_sku".
2018-04-17 14:20:55,174: Acquiring new bigquery connection "agg_ga_transaction".
2018-04-17 14:20:55,174: Re-using an available connection from the pool.
2018-04-17 14:20:55,175: Acquiring new bigquery connection "agg_transaction".
2018-04-17 14:20:55,175: Re-using an available connection from the pool.
2018-04-17 14:20:55,176: Re-using an available connection from the pool.
2018-04-17 14:20:55,178: Re-using an available connection from the pool.
2018-04-17 14:21:00,000: Model SQL (agg_transaction):
SELECT
client,
date,
customer_id,
order_number,
last_touch_channel,
last_touch_platform,
last_touch_url,
first_touch_channel, 
first_touch_platform, 
first_touch_utm_campaign,
ifnull( sum(last_touch_transactions), 0) last_touch_transactions, 
ifnull( sum(last_touch_revenue), 0) last_touch_revenue, 
ifnull( sum(first_touch_transactions), 0) first_touch_transactions, 
ifnull( sum(first_touch_revenue), 0) first_touch_revenue,
ifnull( sum(final_quantity), 0) quantity,
ifnull( sum(final_price), 0) revenue,
ifnull( sum(shipping_price), 0) shipping_revenue,
ROW_NUMBER() OVER (PARTITION BY client, customer_id, order_number ORDER BY date asc) AS order_sequence
FROM
(
	SELECT
	a.client,
	a.date date,
	b.date ga_date,
	a.customer_id,
	a.order_number,
	transactionid,
	b.last_touch_channel,
	b.last_touch_platform,
	b.last_touch_url,
	b.first_touch_channel, 
	b.first_touch_platform, 
	b.first_touch_utm_campaign, 
	last_touch_transactions, 
	last_touch_revenue, 
	first_touch_transactions, 
	first_touch_revenue,
	final_quantity,
	final_price,
	shipping_price
	FROM
	`growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_order_number` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`agg_ga_transaction_order_number` b
	ON (
		a.client = b.client and
		a.order_number = b.transactionid
	)

)
GROUP BY
client, 
date, 
customer_id,
order_number, 
last_touch_channel,
last_touch_platform,
last_touch_url,
first_touch_channel, 
first_touch_platform, 
first_touch_utm_campaign
2018-04-17 14:21:00,520: Unhandled error while executing None
('Connection aborted.', OSError("(54, 'ECONNRESET')",))
2018-04-17 14:21:00,520: Connection 'master' was left open.
2018-04-17 14:21:00,520: Connection 'segment_proc_customers_products' was left open.
2018-04-17 14:21:00,520: Connection 'agg_ga_transaction' was left open.
2018-04-17 14:21:00,521: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104b0ecc0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104b5f198>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104b5f6a0>]}
2018-04-17 14:21:00,523: Unhandled error while executing None
('Connection aborted.', OSError("(54, 'ECONNRESET')",))
2018-04-17 14:21:00,842: Encountered an error:
2018-04-17 14:21:00,843: ('Connection aborted.', OSError("(54, 'ECONNRESET')",))
2018-04-17 14:21:00,912: Traceback (most recent call last):
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/urllib3/connectionpool.py", line 601, in urlopen
    chunked=chunked)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/urllib3/connectionpool.py", line 387, in _make_request
    six.raise_from(e, None)
  File "<string>", line 2, in raise_from
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/urllib3/connectionpool.py", line 383, in _make_request
    httplib_response = conn.getresponse()
  File "/usr/local/opt/python3/Frameworks/Python.framework/Versions/3.6/lib/python3.6/http/client.py", line 1331, in getresponse
    response.begin()
  File "/usr/local/opt/python3/Frameworks/Python.framework/Versions/3.6/lib/python3.6/http/client.py", line 297, in begin
    version, status, reason = self._read_status()
  File "/usr/local/opt/python3/Frameworks/Python.framework/Versions/3.6/lib/python3.6/http/client.py", line 258, in _read_status
    line = str(self.fp.readline(_MAXLINE + 1), "iso-8859-1")
  File "/usr/local/opt/python3/Frameworks/Python.framework/Versions/3.6/lib/python3.6/socket.py", line 586, in readinto
    return self._sock.recv_into(b)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/urllib3/contrib/pyopenssl.py", line 285, in recv_into
    raise SocketError(str(e))
OSError: (54, 'ECONNRESET')

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/requests/adapters.py", line 440, in send
    timeout=timeout
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/urllib3/connectionpool.py", line 639, in urlopen
    _stacktrace=sys.exc_info()[2])
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/urllib3/util/retry.py", line 357, in increment
    raise six.reraise(type(error), error, _stacktrace)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/urllib3/packages/six.py", line 685, in reraise
    raise value.with_traceback(tb)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/urllib3/connectionpool.py", line 601, in urlopen
    chunked=chunked)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/urllib3/connectionpool.py", line 387, in _make_request
    six.raise_from(e, None)
  File "<string>", line 2, in raise_from
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/urllib3/connectionpool.py", line 383, in _make_request
    httplib_response = conn.getresponse()
  File "/usr/local/opt/python3/Frameworks/Python.framework/Versions/3.6/lib/python3.6/http/client.py", line 1331, in getresponse
    response.begin()
  File "/usr/local/opt/python3/Frameworks/Python.framework/Versions/3.6/lib/python3.6/http/client.py", line 297, in begin
    version, status, reason = self._read_status()
  File "/usr/local/opt/python3/Frameworks/Python.framework/Versions/3.6/lib/python3.6/http/client.py", line 258, in _read_status
    line = str(self.fp.readline(_MAXLINE + 1), "iso-8859-1")
  File "/usr/local/opt/python3/Frameworks/Python.framework/Versions/3.6/lib/python3.6/socket.py", line 586, in readinto
    return self._sock.recv_into(b)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/urllib3/contrib/pyopenssl.py", line 285, in recv_into
    raise SocketError(str(e))
urllib3.exceptions.ProtocolError: ('Connection aborted.', OSError("(54, 'ECONNRESET')",))

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/main.py", line 40, in main
    results, succeeded = handle_and_check(args)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/main.py", line 84, in handle_and_check
    task, res = run_from_args(parsed)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/main.py", line 138, in run_from_args
    results = run_from_task(task, proj, parsed)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/main.py", line 146, in run_from_task
    result = task.run()
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/task/run.py", line 26, in run
    results = runner.run(query, ModelRunner)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/runner.py", line 221, in run
    return self.run_from_graph(Selector, Runner, query)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/runner.py", line 208, in run_from_graph
    res = self.execute_nodes(linker, Runner, flat_graph, dep_list)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/runner.py", line 133, in execute_nodes
    for result in pool.imap_unordered(self.call_runner, args_list):
  File "/usr/local/opt/python3/Frameworks/Python.framework/Versions/3.6/lib/python3.6/multiprocessing/pool.py", line 735, in next
    raise value
  File "/usr/local/opt/python3/Frameworks/Python.framework/Versions/3.6/lib/python3.6/multiprocessing/pool.py", line 119, in worker
    result = (True, func(*args, **kwds))
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/runner.py", line 82, in call_runner
    result = runner.safe_run(flat_graph, existing)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/node_runners.py", line 139, in safe_run
    raise e
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/node_runners.py", line 108, in safe_run
    result = self.run(compiled_node, existing, flat_graph)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/node_runners.py", line 155, in run
    return self.execute(compiled_node, existing, flat_graph)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/node_runners.py", line 389, in execute
    materialization_macro.get('generator')(context)()
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/clients/jinja.py", line 51, in call
    return macro(*args, **kwargs)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/runtime.py", line 549, in __call__
    return self._invoke(arguments, autoescape)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/asyncsupport.py", line 110, in _invoke
    return original_invoke(self, arguments, autoescape)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/runtime.py", line 553, in _invoke
    rv = self._func(*arguments)
  File "<template>", line 65, in macro
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/sandbox.py", line 427, in call
    return __context.call(__obj, *args, **kwargs)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/runtime.py", line 260, in call
    return __obj(*args, **kwargs)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/context/common.py", line 48, in wrapped
    return getattr(self.adapter, fn)(*args, **kwargs)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/adapters/bigquery.py", line 256, in execute_model
    model_sql)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/adapters/bigquery.py", line 226, in materialize_as_table
    job.begin()
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/google/cloud/bigquery/job.py", line 380, in begin
    method='POST', path=path, data=self._build_resource())
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/google/cloud/_http.py", line 290, in api_request
    headers=headers, target_object=_target_object)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/google/cloud/_http.py", line 183, in _make_request
    return self._do_request(method, url, headers, data, target_object)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/google/cloud/_http.py", line 212, in _do_request
    url=url, method=method, headers=headers, data=data)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/google/auth/transport/requests.py", line 179, in request
    method, url, data=data, headers=request_headers, **kwargs)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/requests/sessions.py", line 508, in request
    resp = self.send(prep, **send_kwargs)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/requests/sessions.py", line 618, in send
    r = adapter.send(request, **kwargs)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/requests/adapters.py", line 490, in send
    raise ConnectionError(err, request=request)
requests.exceptions.ConnectionError: ('Connection aborted.', OSError("(54, 'ECONNRESET')",))

2018-04-17 14:23:10,084: Tracking: tracking
2018-04-17 14:23:10,086: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1085d2f60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1085d2e80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1085d2dd8>]}
2018-04-17 14:23:10,872: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-04-17 14:23:10,901: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/growth-engines/dbt_modules
2018-04-17 14:23:10,911: Parsing get_column_values.sql
2018-04-17 14:23:10,936: Parsing get_url_parameter.sql
2018-04-17 14:23:10,945: Parsing split_part.sql
2018-04-17 14:23:10,956: Parsing table_exists.sql
2018-04-17 14:23:10,974: Parsing core.sql
2018-04-17 14:23:10,990: Parsing adapters/bigquery.sql
2018-04-17 14:23:10,999: Parsing adapters/common.sql
2018-04-17 14:23:11,021: Parsing adapters/postgres.sql
2018-04-17 14:23:11,029: Parsing adapters/redshift.sql
2018-04-17 14:23:11,056: Parsing etc/get_custom_schema.sql
2018-04-17 14:23:11,069: Parsing materializations/archive.sql
2018-04-17 14:23:11,104: Parsing materializations/bigquery.sql
2018-04-17 14:23:11,125: Parsing materializations/helpers.sql
2018-04-17 14:23:11,148: Parsing materializations/incremental.sql
2018-04-17 14:23:11,185: Parsing materializations/table.sql
2018-04-17 14:23:11,209: Parsing materializations/view.sql
2018-04-17 14:23:11,237: Parsing materializations/wrapper.sql
2018-04-17 14:23:11,246: Parsing schema_tests/accepted_values.sql
2018-04-17 14:23:11,257: Parsing schema_tests/not_null.sql
2018-04-17 14:23:11,263: Parsing schema_tests/relationships.sql
2018-04-17 14:23:11,271: Parsing schema_tests/unique.sql
2018-04-17 14:23:11,432: Parsing model.agency_data_pipeline.accounts_proc
2018-04-17 14:23:11,435: Parsing model.agency_data_pipeline.all_dates
2018-04-17 14:23:11,438: Parsing model.agency_data_pipeline.carts_proc
2018-04-17 14:23:11,440: Parsing model.agency_data_pipeline.clients_proc
2018-04-17 14:23:11,443: Parsing model.agency_data_pipeline.conversion_goals_proc
2018-04-17 14:23:11,446: Parsing model.agency_data_pipeline.mappings_ga_proc
2018-04-17 14:23:11,450: Acquiring new bigquery connection "master".
2018-04-17 14:23:11,450: Opening a new connection (0 currently allocated)
2018-04-17 14:23:11,457: Parsing model.agency_data_pipeline.monthend_dates
2018-04-17 14:23:11,459: Parsing model.agency_data_pipeline.adwords_ads
2018-04-17 14:23:11,462: Parsing model.agency_data_pipeline.adwords_campaigns
2018-04-17 14:23:11,465: Parsing model.agency_data_pipeline.adwords_conversions
2018-04-17 14:23:11,467: Parsing model.agency_data_pipeline.adwords_impression_share
2018-04-17 14:23:11,469: Parsing model.agency_data_pipeline.adwords_join
2018-04-17 14:23:11,472: Parsing model.agency_data_pipeline.adwords_stats
2018-04-17 14:23:11,475: Parsing model.agency_data_pipeline.adwords_urls
2018-04-17 14:23:11,477: Parsing model.agency_data_pipeline.bing_ads_ads
2018-04-17 14:23:11,481: Parsing model.agency_data_pipeline.bing_ads_conversions
2018-04-17 14:23:11,485: Parsing model.agency_data_pipeline.bing_ads_impression_share
2018-04-17 14:23:11,487: Parsing model.agency_data_pipeline.bing_ads_stats
2018-04-17 14:23:11,491: Parsing model.agency_data_pipeline.fb_adcreative
2018-04-17 14:23:11,503: Parsing model.agency_data_pipeline.fb_ads
2018-04-17 14:23:11,516: Parsing model.agency_data_pipeline.fb_ads_insights
2018-04-17 14:23:11,525: Parsing model.agency_data_pipeline.fb_ads_insights_conversions
2018-04-17 14:23:11,531: Parsing model.agency_data_pipeline.fb_ads_stats
2018-04-17 14:23:11,534: Parsing model.agency_data_pipeline.ga_conversions
2018-04-17 14:23:11,536: Parsing model.agency_data_pipeline.ga_traffic
2018-04-17 14:23:11,551: Parsing model.agency_data_pipeline.ga_transactions
2018-04-17 14:23:11,562: Parsing model.agency_data_pipeline.ga_mcf_proc
2018-04-17 14:23:11,565: Parsing model.agency_data_pipeline.ga_mcf_stats
2018-04-17 14:23:11,571: Parsing model.agency_data_pipeline.shopify_customers_proc
2018-04-17 14:23:11,578: Parsing model.agency_data_pipeline.shopify_orders_proc
2018-04-17 14:23:11,587: Parsing model.agency_data_pipeline.shopify_products_proc
2018-04-17 14:23:11,598: Parsing model.agency_data_pipeline.shopify_refunds_proc
2018-04-17 14:23:11,605: Parsing model.agency_data_pipeline.agg_campaign
2018-04-17 14:23:11,611: Parsing model.agency_data_pipeline.agg_customers_union
2018-04-17 14:23:11,613: Parsing model.agency_data_pipeline.agg_ga_campaign
2018-04-17 14:23:11,617: Parsing model.agency_data_pipeline.agg_ga_campaign_by_type
2018-04-17 14:23:11,620: Parsing model.agency_data_pipeline.agg_ga_transaction
2018-04-17 14:23:11,624: Parsing model.agency_data_pipeline.agg_ga_transaction_order_number
2018-04-17 14:23:11,627: Parsing model.agency_data_pipeline.agg_orders_union
2018-04-17 14:23:11,630: Parsing model.agency_data_pipeline.agg_platform_monthly
2018-04-17 14:23:11,633: Parsing model.agency_data_pipeline.agg_platforms_client
2018-04-17 14:23:11,638: Parsing model.agency_data_pipeline.agg_platforms_union
2018-04-17 14:23:11,643: Parsing model.agency_data_pipeline.agg_products
2018-04-17 14:23:11,645: Parsing model.agency_data_pipeline.agg_transaction
2018-04-17 14:23:11,654: Parsing model.agency_data_pipeline.agg_transaction_daily
2018-04-17 14:23:11,656: Parsing model.agency_data_pipeline.agg_transaction_line_item
2018-04-17 14:23:11,658: Parsing model.agency_data_pipeline.agg_transaction_line_item_type
2018-04-17 14:23:11,661: Parsing model.agency_data_pipeline.agg_transaction_order_number
2018-04-17 14:23:11,663: Parsing model.agency_data_pipeline.agg_transaction_product_type
2018-04-17 14:23:11,666: Parsing model.agency_data_pipeline.customers_by_transaction
2018-04-17 14:23:11,669: Parsing model.agency_data_pipeline.growth_customer_0_365
2018-04-17 14:23:11,672: Parsing model.agency_data_pipeline.growth_customer_0_365_segment
2018-04-17 14:23:11,675: Parsing model.agency_data_pipeline.growth_date_union
2018-04-17 14:23:11,678: Parsing model.agency_data_pipeline.growth_stats
2018-04-17 14:23:11,685: Parsing model.agency_data_pipeline.retention_0_365
2018-04-17 14:23:11,688: Parsing model.agency_data_pipeline.retention_0_365_new
2018-04-17 14:23:11,693: Parsing model.agency_data_pipeline.retention_0_365_reactivated
2018-04-17 14:23:11,697: Parsing model.agency_data_pipeline.retention_0_365_rebuy
2018-04-17 14:23:11,702: Parsing model.agency_data_pipeline.retention_365_730
2018-04-17 14:23:11,705: Parsing model.agency_data_pipeline.retention_730_plus
2018-04-17 14:23:11,714: Parsing model.agency_data_pipeline.retention_stats
2018-04-17 14:23:11,722: Parsing model.agency_data_pipeline.retention_stats_rebuy_rate
2018-04-17 14:23:11,725: Parsing model.agency_data_pipeline.retention_0_30
2018-04-17 14:23:11,728: Parsing model.agency_data_pipeline.retention_0_30_new
2018-04-17 14:23:11,732: Parsing model.agency_data_pipeline.retention_0_30_reactivated
2018-04-17 14:23:11,735: Parsing model.agency_data_pipeline.retention_0_30_rebuy
2018-04-17 14:23:11,738: Parsing model.agency_data_pipeline.retention_30_60
2018-04-17 14:23:11,740: Parsing model.agency_data_pipeline.retention_60_plus
2018-04-17 14:23:11,744: Parsing model.agency_data_pipeline.retention_stats_month
2018-04-17 14:23:11,752: Parsing model.agency_data_pipeline.retention_stats_rebuy_rate_month
2018-04-17 14:23:11,755: Parsing model.agency_data_pipeline.customers_first_purchase_proc
2018-04-17 14:23:11,757: Parsing model.agency_data_pipeline.customers_proc
2018-04-17 14:23:11,759: Parsing model.agency_data_pipeline.segment_list_customers
2018-04-17 14:23:11,762: Parsing model.agency_data_pipeline.segment_proc_customers
2018-04-17 14:23:11,765: Parsing model.agency_data_pipeline.segment_stats_customers
2018-04-17 14:23:11,768: Parsing model.agency_data_pipeline.segment_stats_customers_agg
2018-04-17 14:23:11,773: Parsing model.agency_data_pipeline.customers_first_purchase_product_type_proc
2018-04-17 14:23:11,775: Parsing model.agency_data_pipeline.customers_products_proc
2018-04-17 14:23:11,778: Parsing model.agency_data_pipeline.segment_list_customers_products
2018-04-17 14:23:11,780: Parsing model.agency_data_pipeline.segment_proc_customers_products
2018-04-17 14:23:11,785: Parsing model.agency_data_pipeline.segment_stats_customers_products
2018-04-17 14:23:11,788: Parsing model.agency_data_pipeline.segment_stats_customers_products_agg
2018-04-17 14:23:11,791: Parsing model.agency_data_pipeline.frequency_proc
2018-04-17 14:23:11,794: Parsing model.agency_data_pipeline.frequency_stats
2018-04-17 14:23:11,796: Parsing model.agency_data_pipeline.order_paths_agg
2018-04-17 14:23:11,798: Parsing model.agency_data_pipeline.order_paths_proc
2018-04-17 14:23:11,802: Parsing model.agency_data_pipeline.order_paths_stats
2018-04-17 14:23:11,806: Parsing model.agency_data_pipeline.products_proc
2018-04-17 14:23:11,810: Parsing model.agency_data_pipeline.segment_proc_sku
2018-04-17 14:23:11,814: Parsing model.agency_data_pipeline.segment_stats_category
2018-04-17 14:23:11,823: Parsing model.agency_data_pipeline.segment_stats_sku
2018-04-17 14:23:11,881: Found 91 models, 0 tests, 0 archives, 0 analyses, 46 macros, 0 operations
2018-04-17 14:23:11,963: 
2018-04-17 14:23:13,794: 14:23:13 | Concurrency: 4 threads (target='prod')
2018-04-17 14:23:13,795: 14:23:13 | 
2018-04-17 14:23:14,400: 14:23:14 | 1 of 91 START table model agency_data_pipeline.adwords_campaigns..... [RUN]
2018-04-17 14:23:14,401: Compiling model.agency_data_pipeline.adwords_campaigns
2018-04-17 14:23:14,405: Writing injected SQL for node "model.agency_data_pipeline.adwords_campaigns"
2018-04-17 14:23:14,400: 14:23:14 | 2 of 91 START table model agency_data_pipeline.carts_proc............ [RUN]
2018-04-17 14:23:14,400: 14:23:14 | 3 of 91 START table model agency_data_pipeline.ga_conversions........ [RUN]
2018-04-17 14:23:14,406: Compiling model.agency_data_pipeline.carts_proc
2018-04-17 14:23:14,401: 14:23:14 | 4 of 91 START table model agency_data_pipeline.monthend_dates........ [RUN]
2018-04-17 14:23:14,406: Compiling model.agency_data_pipeline.ga_conversions
2018-04-17 14:23:14,411: Writing injected SQL for node "model.agency_data_pipeline.carts_proc"
2018-04-17 14:23:14,411: Compiling model.agency_data_pipeline.monthend_dates
2018-04-17 14:23:14,416: Writing injected SQL for node "model.agency_data_pipeline.ga_conversions"
2018-04-17 14:23:14,421: Writing injected SQL for node "model.agency_data_pipeline.monthend_dates"
2018-04-17 14:23:14,422: Acquiring new bigquery connection "adwords_campaigns".
2018-04-17 14:23:14,422: Opening a new connection (1 currently allocated)
2018-04-17 14:23:14,427: Acquiring new bigquery connection "ga_conversions".
2018-04-17 14:23:14,478: Acquiring new bigquery connection "carts_proc".
2018-04-17 14:23:14,482: Opening a new connection (2 currently allocated)
2018-04-17 14:23:14,482: Acquiring new bigquery connection "monthend_dates".
2018-04-17 14:23:14,488: Opening a new connection (3 currently allocated)
2018-04-17 14:23:14,548: Opening a new connection (4 currently allocated)
2018-04-17 14:23:16,042: Model SQL (monthend_dates):
SELECT
date_in_range,
date_in_range_bom,
date_in_range_bom_mom,
unix_date_in_range,
unix_date_in_range_bom,
unix_date(date_in_range_bom_mom) unix_date_in_range_bom_mom,
yyyymm,
date_in_range_yoy,
unix_date(date_in_range_yoy) unix_date_in_range_yoy

FROM
(
	SELECT 
	date_in_range,
	date_in_range_bom,
	date_sub(date_in_range_bom, INTERVAL 1 MONTH) date_in_range_bom_mom,
  date_sub(date_in_range, INTERVAL 1 YEAR) date_in_range_yoy,
	unix_date_in_range,
	unix_date(date_in_range_bom) unix_date_in_range_bom,
	yyyymm,
	first_value(date_in_range) over (partition by yyyymm order by date_in_range desc) monthend_date_in_range
	FROM
	( 
		SELECT 
		date_in_range,
		date_trunc( date_in_range, MONTH) date_in_range_bom,
		unix_date(date_in_range) unix_date_in_range,
		format_date("%Y-%m", date_in_range) AS yyyymm
		FROM UNNEST(
		    GENERATE_DATE_ARRAY(DATE('2016-01-31'), CURRENT_DATE(), INTERVAL 1 DAY)
		) AS date_in_range
	)
)
where date_in_range = monthend_date_in_range
2018-04-17 14:23:16,054: Model SQL (carts_proc):
select 
client,
client_name,
account,
platform
from  ( 

SELECT  
client,
client_name,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.accounts`
WHERE platform in ('Shopify', 'Custom cart')

) 

WHERE lv = time_of_entry
2018-04-17 14:23:16,073: Model SQL (ga_conversions):
select 
client,
client_name,
platform,
goal_name,
goal_type,
account,
time_of_entry
from  ( 

SELECT  
client,
client_name,
platform,
trim(goal_name) goal_name,
goal_type,
account,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform, goal_name ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.conversion_goals` 
WHERE platform = 'Google Analytics'

) 

WHERE lv = time_of_entry
2018-04-17 14:23:16,083: Model SQL (adwords_campaigns):
select
day,
campaignid, 
campaign,
account, 
channel,
platform,
sum(cost) cost,
sum(impressions) impressions,
sum(clicks) clicks,
sum(impression_share_num) impression_share_num,
sum(impression_share_den) impression_share_den
from 
  ( 
	SELECT  
	day,
	campaignid,
	campaign,
	account as account,
	'Paid' as channel,
	'Adwords' as platform,
	cost/1000000 cost, 
	impressions as impressions, 
	clicks, 
	case when searchimprshare is not null then impressions end as impression_share_num,
	case when searchimprshare is not null then impressions/(searchimprshare/100) end as impression_share_den,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY campaignid, day ORDER BY _sdc_sequence DESC) lv
	FROM `growth-engines-pipeline.adwords_2.CAMPAIGN_PERFORMANCE_REPORT`
  )
where lv = _sdc_sequence
group by day, campaignid, account, channel, platform, campaign
2018-04-17 14:23:17,169: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10877cb38>]}
2018-04-17 14:23:17,175: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108781dd8>]}
2018-04-17 14:23:17,549: 14:23:17 | 4 of 91 OK created table model agency_data_pipeline.monthend_dates... [CREATE TABLE in 2.76s]
2018-04-17 14:23:17,550: 14:23:17 | 5 of 91 START table model agency_data_pipeline.clients_proc.......... [RUN]
2018-04-17 14:23:17,550: Compiling model.agency_data_pipeline.clients_proc
2018-04-17 14:23:17,555: Writing injected SQL for node "model.agency_data_pipeline.clients_proc"
2018-04-17 14:23:17,559: Acquiring new bigquery connection "clients_proc".
2018-04-17 14:23:17,560: Re-using an available connection from the pool.
2018-04-17 14:23:17,837: 14:23:17 | 2 of 91 OK created table model agency_data_pipeline.carts_proc....... [CREATE TABLE in 2.77s]
2018-04-17 14:23:17,837: 14:23:17 | 6 of 91 START table model agency_data_pipeline.all_dates............. [RUN]
2018-04-17 14:23:17,837: Compiling model.agency_data_pipeline.all_dates
2018-04-17 14:23:17,841: Writing injected SQL for node "model.agency_data_pipeline.all_dates"
2018-04-17 14:23:17,842: Acquiring new bigquery connection "all_dates".
2018-04-17 14:23:17,842: Re-using an available connection from the pool.
2018-04-17 14:23:18,430: Model SQL (clients_proc):
select 
client,
client_name,
account,
platform
from  ( 

SELECT  
client,
client_name,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.accounts`
where client_name != ''
) 

WHERE lv = time_of_entry
2018-04-17 14:23:18,545: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105273710>]}
2018-04-17 14:23:18,773: Model SQL (all_dates):
SELECT 
date_in_range,
unix_date(date_in_range) unix_date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-04-17 14:23:18,884: 14:23:18 | 3 of 91 OK created table model agency_data_pipeline.ga_conversions... [CREATE TABLE in 4.14s]
2018-04-17 14:23:18,885: 14:23:18 | 7 of 91 START table model agency_data_pipeline.bing_ads_impression_share [RUN]
2018-04-17 14:23:18,885: Compiling model.agency_data_pipeline.bing_ads_impression_share
2018-04-17 14:23:18,894: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_impression_share"
2018-04-17 14:23:18,896: Acquiring new bigquery connection "bing_ads_impression_share".
2018-04-17 14:23:18,896: Re-using an available connection from the pool.
2018-04-17 14:23:19,537: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1087f4cc0>]}
2018-04-17 14:23:19,801: 14:23:19 | 5 of 91 OK created table model agency_data_pipeline.clients_proc..... [CREATE TABLE in 1.99s]
2018-04-17 14:23:19,802: 14:23:19 | 8 of 91 START table model agency_data_pipeline.bing_ads_ads.......... [RUN]
2018-04-17 14:23:19,802: Compiling model.agency_data_pipeline.bing_ads_ads
2018-04-17 14:23:19,812: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_ads"
2018-04-17 14:23:19,814: Acquiring new bigquery connection "bing_ads_ads".
2018-04-17 14:23:19,814: Re-using an available connection from the pool.
2018-04-17 14:23:19,917: Model SQL (bing_ads_impression_share):
SELECT 
date, 
account,
channel,
platform,
sum(impressions) impressions,
sum(available_impressions) available_impressions
FROM

(

SELECT  
cast(gregoriandate as date) date,
replace(accountname,',','') account,  
'Paid' as channel,
'Bing Ads' as platform,
case when impressionsharepercent is null then 0 else impressions end as impressions,
cast(round(case when ( impressionsharepercent is not null and impressionsharepercent > 0 ) then (impressions*100)/impressionsharepercent else 0 end) as int64) as available_impressions,
_sdc_sequence,
first_value(_sdc_sequence) OVER (PARTITION BY campaignid, gregoriandate ORDER BY _sdc_sequence DESC) lv
FROM `growth-engines-pipeline.bing_ads.campaign_performance_report` 

)

where lv = _sdc_sequence
group by date, account, channel, platform
2018-04-17 14:23:20,640: Model SQL (bing_ads_ads):
select
date, 
account, 
channel,
platform,
campaignid,
campaignname,
max(lower(trim(replace(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$','' ),'.html',''),'/'))) as url,
utm_campaign,
sum(cost) as cost,
sum(impressions) as impressions,
sum(clicks) as clicks,
sum(conversions) as conversions
from 
  ( 
SELECT  
cast(gregoriandate as date) date,
replace(accountname,',','') account,
'Paid' as channel,
'Bing Ads' as platform,
adid,
adtype,
campaignid, 
campaignname,
finalurl url,
case when regexp_contains(destinationurl, 'utm_campaign')
	then replace(lower(nullif(
  

    split(
        
  

    split(
        destinationurl,
        'utm_campaign='
        )[offset(1)]


,
        '&'
        )[offset(0)]


,'')),'+',' ') 
	else null end as utm_campaign,
spend cost, 
impressions, 
clicks, 
conversions,
_sdc_sequence,
first_value(_sdc_sequence) OVER (PARTITION BY adid, gregoriandate ORDER BY _sdc_sequence DESC) lv
FROM `growth-engines-pipeline.bing_ads.ad_performance_report` 
  )

where lv = _sdc_sequence
group by date, account, channel, platform, campaignid, campaignname, utm_campaign
2018-04-17 14:23:20,803: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1087b9eb8>]}
2018-04-17 14:23:21,042: 14:23:21 | 1 of 91 OK created table model agency_data_pipeline.adwords_campaigns [CREATE TABLE in 6.40s]
2018-04-17 14:23:21,042: 14:23:21 | 9 of 91 START table model agency_data_pipeline.adwords_urls.......... [RUN]
2018-04-17 14:23:21,043: Compiling model.agency_data_pipeline.adwords_urls
2018-04-17 14:23:21,052: Writing injected SQL for node "model.agency_data_pipeline.adwords_urls"
2018-04-17 14:23:21,053: Acquiring new bigquery connection "adwords_urls".
2018-04-17 14:23:21,054: Re-using an available connection from the pool.
2018-04-17 14:23:21,884: Model SQL (adwords_urls):
SELECT
campaignid,
lower(trim(regexp_replace(replace(replace(replace(replace(finalurl,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url

FROM (

SELECT  
campaignid,
finalurl,
first_value(finalurl) OVER (PARTITION BY campaignid ORDER BY day DESC) lv
FROM `growth-engines-pipeline.adwords_2.FINAL_URL_REPORT`
)

WHERE lv = finalurl
group by campaignid, url
order by campaignid asc
2018-04-17 14:23:22,132: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105273710>]}
2018-04-17 14:23:22,157: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10972efd0>]}
2018-04-17 14:23:22,395: 14:23:22 | 7 of 91 OK created table model agency_data_pipeline.bing_ads_impression_share [CREATE TABLE in 3.25s]
2018-04-17 14:23:22,395: 14:23:22 | 10 of 91 START table model agency_data_pipeline.accounts_proc........ [RUN]
2018-04-17 14:23:22,395: Compiling model.agency_data_pipeline.accounts_proc
2018-04-17 14:23:22,405: Writing injected SQL for node "model.agency_data_pipeline.accounts_proc"
2018-04-17 14:23:22,409: Acquiring new bigquery connection "accounts_proc".
2018-04-17 14:23:22,410: Re-using an available connection from the pool.
2018-04-17 14:23:22,680: 14:23:22 | 6 of 91 OK created table model agency_data_pipeline.all_dates........ [CREATE TABLE in 4.32s]
2018-04-17 14:23:22,681: 14:23:22 | 11 of 91 START table model agency_data_pipeline.conversion_goals_proc [RUN]
2018-04-17 14:23:22,681: Compiling model.agency_data_pipeline.conversion_goals_proc
2018-04-17 14:23:22,698: Writing injected SQL for node "model.agency_data_pipeline.conversion_goals_proc"
2018-04-17 14:23:22,701: Acquiring new bigquery connection "conversion_goals_proc".
2018-04-17 14:23:22,702: Re-using an available connection from the pool.
2018-04-17 14:23:23,235: Model SQL (accounts_proc):
select 
client,
account,
platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.accounts` 

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-04-17 14:23:23,505: Model SQL (conversion_goals_proc):
select 
client,
platform,
goal_name,
max(goal_type) goal_type,
account,
max(time_of_entry) time_of_entry
from  ( 

SELECT  
client,
platform,
trim(replace(replace(lower(goal_name),',',''),' ','')) goal_name,
goal_type,
account,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY platform ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.conversion_goals` 

) 

WHERE lv = time_of_entry
group by client, platform, account, goal_name
2018-04-17 14:23:23,964: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1087f4cc0>]}
2018-04-17 14:23:24,150: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1087b9eb8>]}
2018-04-17 14:23:24,199: 14:23:24 | 8 of 91 OK created table model agency_data_pipeline.bing_ads_ads..... [CREATE TABLE in 4.16s]
2018-04-17 14:23:24,200: 14:23:24 | 12 of 91 START table model agency_data_pipeline.adwords_conversions.. [RUN]
2018-04-17 14:23:24,200: Compiling model.agency_data_pipeline.adwords_conversions
2018-04-17 14:23:24,208: Writing injected SQL for node "model.agency_data_pipeline.adwords_conversions"
2018-04-17 14:23:24,210: Acquiring new bigquery connection "adwords_conversions".
2018-04-17 14:23:24,211: Re-using an available connection from the pool.
2018-04-17 14:23:24,386: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105273710>]}
2018-04-17 14:23:24,458: 14:23:24 | 9 of 91 OK created table model agency_data_pipeline.adwords_urls..... [CREATE TABLE in 3.11s]
2018-04-17 14:23:24,634: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10972efd0>]}
2018-04-17 14:23:24,691: 14:23:24 | 10 of 91 OK created table model agency_data_pipeline.accounts_proc... [CREATE TABLE in 1.99s]
2018-04-17 14:23:24,928: Model SQL (adwords_conversions):
select 
client,
client_name,
platform,
goal_name,
goal_type,
account,
time_of_entry
from  ( 

SELECT  
client,
client_name,
platform,
trim(lower(goal_name)) goal_name,
goal_type,
account,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform, goal_name ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.conversion_goals` 
WHERE platform = 'Adwords'

) 

WHERE lv = time_of_entry
2018-04-17 14:23:24,954: 14:23:24 | 11 of 91 OK created table model agency_data_pipeline.conversion_goals_proc [CREATE TABLE in 1.95s]
2018-04-17 14:23:26,046: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1087f4cc0>]}
2018-04-17 14:23:26,289: 14:23:26 | 12 of 91 OK created table model agency_data_pipeline.adwords_conversions [CREATE TABLE in 1.85s]
2018-04-17 14:23:26,289: 14:23:26 | 13 of 91 START table model agency_data_pipeline.shopify_refunds_proc. [RUN]
2018-04-17 14:23:26,290: Compiling model.agency_data_pipeline.shopify_refunds_proc
2018-04-17 14:23:26,302: Acquiring new bigquery connection "shopify_refunds_proc".
2018-04-17 14:23:26,291: 14:23:26 | 14 of 91 START table model agency_data_pipeline.ga_mcf_proc.......... [RUN]
2018-04-17 14:23:26,302: Compiling model.agency_data_pipeline.ga_mcf_proc
2018-04-17 14:23:26,293: 14:23:26 | 15 of 91 START table model agency_data_pipeline.mappings_ga_proc..... [RUN]
2018-04-17 14:23:26,303: Re-using an available connection from the pool.
2018-04-17 14:23:26,308: Writing injected SQL for node "model.agency_data_pipeline.ga_mcf_proc"
2018-04-17 14:23:26,293: 14:23:26 | 16 of 91 START table model agency_data_pipeline.fb_adcreative........ [RUN]
2018-04-17 14:23:26,308: Compiling model.agency_data_pipeline.mappings_ga_proc
2018-04-17 14:23:26,308: Fetching data for query shopify_refunds_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 14:23:26,308: Compiling model.agency_data_pipeline.fb_adcreative
2018-04-17 14:23:26,314: Writing injected SQL for node "model.agency_data_pipeline.mappings_ga_proc"
2018-04-17 14:23:26,323: Acquiring new bigquery connection "fb_adcreative".
2018-04-17 14:23:26,328: Acquiring new bigquery connection "ga_mcf_proc".
2018-04-17 14:23:26,328: Re-using an available connection from the pool.
2018-04-17 14:23:26,331: Acquiring new bigquery connection "mappings_ga_proc".
2018-04-17 14:23:26,332: Fetching data for query fb_adcreative:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 14:23:26,332: Re-using an available connection from the pool.
2018-04-17 14:23:26,338: Re-using an available connection from the pool.
2018-04-17 14:23:27,410: Model SQL (ga_mcf_proc):
SELECT 
date,
account,
'Google Analytics' as lookup_platform,
source_medium_path,
trim(lower(split(split(source_medium_path,'->')[SAFE_ORDINAL(1)],'/')[SAFE_ORDINAL(1)])) as source,
trim(lower(split(split(source_medium_path,'->')[SAFE_ORDINAL(1)],'/')[SAFE_ORDINAL(2)])) as medium,
first_interaction_campaign campaign,
cast(regexp_replace(transaction_id, r'#', '') as int64) transactionid,
max(first_interaction_conversions) transactions,
max(first_interaction_conversion_value) revenue
FROM `growth-engines-pipeline.agency_data_pipeline.ga_mcf`
where account in (select account from `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc` where platform = 'Google Analytics')
group by date, account, source, medium, campaign, source_medium_path, lookup_platform, transactionid
2018-04-17 14:23:27,560: Model SQL (mappings_ga_proc):
select 
client,
account,
client_name,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
account,
client_name,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.mappings_ga` 

) 

WHERE lv = time_of_entry
and client in (select client from `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc` )
group by client, account, client_name, source, medium, platform_n, channel_n, time_of_entry
2018-04-17 14:23:27,641: Writing injected SQL for node "model.agency_data_pipeline.shopify_refunds_proc"
2018-04-17 14:23:27,751: Writing injected SQL for node "model.agency_data_pipeline.fb_adcreative"
2018-04-17 14:23:28,480: Model SQL (shopify_refunds_proc):




with refunds as (

	
	SELECT
	order_number,
	checkout_id,
	financial_status,
	line_item_id,
	quantity,
	subtotal,
	line_item.variant_id variant_id,
	line_item.id refund_id,
 	_sdc_sequence
	FROM `growth-engines-pipeline.shopify_lucadanni.orders` 
	cross join unnest(refunds), unnest(refund_line_items)
  	where financial_status like '%refund%'
	
	

)

SELECT * 
FROM 
	(
    SELECT
	order_number,
	checkout_id,
	financial_status,
	line_item_id,
	quantity,
	subtotal refund_amount,
	variant_id,
	refund_id,
 	_sdc_sequence,
    first_value(_sdc_sequence) OVER (PARTITION BY order_number, line_item_id ORDER BY _sdc_sequence DESC) lv
    FROM refunds
   	) 
WHERE lv = _sdc_sequence


2018-04-17 14:23:28,624: Model SQL (fb_adcreative):




with fb_adcreative as (


	    
		   	SELECT 
			id,
			object_url,
			url_tags,
			_sdc_sequence
			FROM `growth-engines-pipeline.fb_ads_luca_danni.adcreative`
		    
	   
)

select creative_id, max(url) url
from (
  select
  id creative_id,
  lower(trim(regexp_replace(replace(replace(replace(replace(object_url,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
  first_value(_sdc_sequence) OVER (PARTITION BY id ORDER BY _sdc_sequence DESC) lv,
  _sdc_sequence
  from fb_adcreative
  )
where lv = _sdc_sequence
group by creative_id


2018-04-17 14:23:29,806: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1052cff98>]}
2018-04-17 14:23:30,061: 14:23:30 | 15 of 91 OK created table model agency_data_pipeline.mappings_ga_proc [CREATE TABLE in 3.50s]
2018-04-17 14:23:30,061: 14:23:30 | 17 of 91 START table model agency_data_pipeline.fb_ads_insights...... [RUN]
2018-04-17 14:23:30,062: Compiling model.agency_data_pipeline.fb_ads_insights
2018-04-17 14:23:30,071: Acquiring new bigquery connection "fb_ads_insights".
2018-04-17 14:23:30,071: Re-using an available connection from the pool.
2018-04-17 14:23:30,071: Fetching data for query fb_ads_insights:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 14:23:30,602: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_insights"
2018-04-17 14:23:30,732: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1086be3c8>]}
2018-04-17 14:23:30,870: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ab7e668>]}
2018-04-17 14:23:30,985: 14:23:30 | 13 of 91 OK created table model agency_data_pipeline.shopify_refunds_proc [CREATE TABLE in 4.44s]
2018-04-17 14:23:30,986: 14:23:30 | 18 of 91 START table model agency_data_pipeline.bing_ads_conversions. [RUN]
2018-04-17 14:23:30,986: Compiling model.agency_data_pipeline.bing_ads_conversions
2018-04-17 14:23:30,996: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_conversions"
2018-04-17 14:23:30,998: Acquiring new bigquery connection "bing_ads_conversions".
2018-04-17 14:23:30,998: Re-using an available connection from the pool.
2018-04-17 14:23:31,281: 14:23:31 | 16 of 91 OK created table model agency_data_pipeline.fb_adcreative... [CREATE TABLE in 4.56s]
2018-04-17 14:23:31,282: 14:23:31 | 19 of 91 START table model agency_data_pipeline.fb_ads_insights_conversions [RUN]
2018-04-17 14:23:31,283: Compiling model.agency_data_pipeline.fb_ads_insights_conversions
2018-04-17 14:23:31,295: Acquiring new bigquery connection "fb_ads_insights_conversions".
2018-04-17 14:23:31,295: Re-using an available connection from the pool.
2018-04-17 14:23:31,296: Fetching data for query fb_ads_insights_conversions:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 14:23:31,456: Model SQL (fb_ads_insights):




with fb_ads_insights as (

	    
		   	SELECT 
			date_start,
			campaign_id,
			campaign_name,
			ad_id,
			account_name,
			spend,
			reach,
			inline_link_clicks,
			_sdc_sequence,
			first_value(_sdc_sequence) OVER (PARTITION BY date_start, ad_id, campaign_id ORDER BY _sdc_sequence DESC) lv
			FROM `growth-engines-pipeline.fb_ads_luca_danni.ads_insights`
		    
	   

)

select
date_start date,
campaign_id,
campaign_name campaign,
ad_id,
account_name account,
max(spend) cost,
max(reach) impressions,
max(inline_link_clicks) clicks
from fb_ads_insights
where lv = _sdc_sequence
group by date, campaign_id, ad_id, account, campaign


2018-04-17 14:23:31,774: Model SQL (bing_ads_conversions):
SELECT
date, 
a.account account, 
a.channel channel,
a.platform platform,
campaignid,
campaignname,
sum( case when b.goal_type = 'Transactions' then conversions else 0 end ) as transactions
FROM

  ( 
SELECT  
cast(gregoriandate as date) date,
replace(accountname,',','') account,
'Paid' as channel,
'Bing Ads' as platform,
trim(replace(replace(lower(goal),',',''),' ','')) goal,
goalid,
campaignid,
campaignname,
conversions,
_sdc_sequence,
first_value(_sdc_sequence) OVER (PARTITION BY campaignid, goalid, gregoriandate ORDER BY _sdc_sequence DESC) lv
FROM `growth-engines-pipeline.bing_ads.goals_and_funnels_report` 

  ) a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`conversion_goals_proc` b
ON (
	a.account = b.account AND
	a.platform = b.platform AND
	a.goal = b.goal_name
)
where a.lv = a._sdc_sequence
group by date, account, channel, platform, campaignid, campaignname
2018-04-17 14:23:31,820: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_insights_conversions"
2018-04-17 14:23:31,862: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108781f28>]}
2018-04-17 14:23:32,116: 14:23:32 | 14 of 91 OK created table model agency_data_pipeline.ga_mcf_proc..... [CREATE TABLE in 5.56s]
2018-04-17 14:23:32,117: 14:23:32 | 20 of 91 START table model agency_data_pipeline.adwords_ads.......... [RUN]
2018-04-17 14:23:32,117: Compiling model.agency_data_pipeline.adwords_ads
2018-04-17 14:23:32,123: Writing injected SQL for node "model.agency_data_pipeline.adwords_ads"
2018-04-17 14:23:32,123: Acquiring new bigquery connection "adwords_ads".
2018-04-17 14:23:32,124: Re-using an available connection from the pool.
2018-04-17 14:23:32,636: Model SQL (fb_ads_insights_conversions):




with fb_ads_insights_conversions as (

	    
		   	SELECT 
			date_start,
			campaign_id,
			campaign_name,
			ad_id,
			account_name,
			spend,
			reach,
			inline_link_clicks,
			_sdc_sequence,
			action_type,
			value
			FROM `growth-engines-pipeline.fb_ads_luca_danni.ads_insights`
			cross join unnest(actions)
		    
	   

)

SELECT * 
FROM 
	(
    SELECT
    date_start date,
    campaign_id,
    campaign_name campaign,
    ad_id,
    account_name account,
    action_type,
    value conversions,
    first_value(_sdc_sequence) OVER (PARTITION BY ad_id, date_start ORDER BY _sdc_sequence DESC) lv,
    _sdc_sequence
    FROM fb_ads_insights_conversions
   	)
where lv = _sdc_sequence
and action_type like '%purchase%'


2018-04-17 14:23:32,947: Model SQL (adwords_ads):
SELECT  
day,
campaignid,
a.account as account,
utm_campaign,
sum( case when b.goal_type = 'Transaction' then conversions else 0 end ) as transactions
FROM (

	SELECT  
	day,
	adid,
	campaignid,
	account,
	lower(conversionname) conversionname,
	conversions,
	lower(campaign) utm_campaign,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY campaignid, day ORDER BY _sdc_sequence DESC) lv
	FROM
	`growth-engines-pipeline.adwords_2.AD_PERFORMANCE_REPORT`

) a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_conversions` b
ON ( a.conversionname = b.goal_name
	AND a.account = b.account )
WHERE lv = _sdc_sequence
group by day, campaignid, account, utm_campaign
2018-04-17 14:23:34,005: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1086be3c8>]}
2018-04-17 14:23:34,245: 14:23:34 | 18 of 91 OK created table model agency_data_pipeline.bing_ads_conversions [CREATE TABLE in 3.02s]
2018-04-17 14:23:34,803: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1087aaac8>]}
2018-04-17 14:23:35,037: 14:23:35 | 17 of 91 OK created table model agency_data_pipeline.fb_ads_insights. [CREATE TABLE in 4.74s]
2018-04-17 14:23:35,224: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108781f28>]}
2018-04-17 14:23:35,502: 14:23:35 | 20 of 91 OK created table model agency_data_pipeline.adwords_ads..... [CREATE TABLE in 3.11s]
2018-04-17 14:23:38,246: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10869aeb8>]}
2018-04-17 14:23:39,328: 14:23:39 | 19 of 91 OK created table model agency_data_pipeline.fb_ads_insights_conversions [CREATE TABLE in 6.96s]
2018-04-17 14:23:39,328: 14:23:39 | 21 of 91 START table model agency_data_pipeline.fb_ads............... [RUN]
2018-04-17 14:23:39,328: Compiling model.agency_data_pipeline.fb_ads
2018-04-17 14:23:39,334: 14:23:39 | 22 of 91 START table model agency_data_pipeline.shopify_customers_proc [RUN]
2018-04-17 14:23:39,339: Acquiring new bigquery connection "fb_ads".
2018-04-17 14:23:39,339: Compiling model.agency_data_pipeline.shopify_customers_proc
2018-04-17 14:23:39,339: Re-using an available connection from the pool.
2018-04-17 14:23:39,349: Acquiring new bigquery connection "shopify_customers_proc".
2018-04-17 14:23:39,349: Fetching data for query fb_ads:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 14:23:39,349: Re-using an available connection from the pool.
2018-04-17 14:23:39,350: Fetching data for query shopify_customers_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 14:23:39,835: Writing injected SQL for node "model.agency_data_pipeline.fb_ads"
2018-04-17 14:23:39,842: Writing injected SQL for node "model.agency_data_pipeline.shopify_customers_proc"
2018-04-17 14:23:40,655: Model SQL (shopify_customers_proc):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc`





with customers as (

	
	SELECT
	'lucadanni' client_name,
	'Shopify' as lookup_platform,
	cast(created_at as date) created_at,
	id,
	first_name,
	last_name,
	email,
	_sdc_sequence,
	first_value(_sdc_sequence) over (partition by id, _sdc_sequence order by _sdc_sequence desc) lv
	FROM `growth-engines-pipeline.shopify_lucadanni.customers` 
	
	

)

SELECT
account,
client,
platform,
id,
min(created_at) created_at,
max(first_name) first_name,
max(last_name) last_name,
max(email) email
FROM (
	SELECT
	b.account,
	b.client,
	b.platform,
	created_at,
	id,
	first_name,
	last_name,
	email
	FROM customers a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
	ON ( a.client_name = b.client_name
	  AND a.lookup_platform = b.platform )
	where a.lv = a._sdc_sequence
)
group by account, client, platform, id

2018-04-17 14:23:40,739: Model SQL (fb_ads):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`fb_adcreative`





with fb_ads as (

	    
		   	SELECT 
			id ad_id,
			creative.creative_id creative_id,
			_sdc_sequence
			FROM `growth-engines-pipeline.fb_ads_luca_danni.ads`
		     
	   

)

SELECT
a.ad_id,
b.creative_id,
b.url
FROM (
    SELECT
    ad_id,
    creative_id,
    first_value(_sdc_sequence) OVER (PARTITION BY ad_id ORDER BY _sdc_sequence DESC) lv,
    _sdc_sequence
    FROM fb_ads
    ) a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`fb_adcreative` b
ON (
	a.creative_id = b.creative_id 
)
WHERE a.lv = a._sdc_sequence


2018-04-17 14:23:42,954: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10877c4a8>]}
2018-04-17 14:23:43,191: 14:23:43 | 21 of 91 OK created table model agency_data_pipeline.fb_ads.......... [CREATE TABLE in 3.63s]
2018-04-17 14:23:46,265: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1052ec5f8>]}
2018-04-17 14:23:46,506: 14:23:46 | 22 of 91 OK created table model agency_data_pipeline.shopify_customers_proc [CREATE TABLE in 6.93s]
2018-04-17 14:23:46,507: 14:23:46 | 23 of 91 START table model agency_data_pipeline.agg_customers_union.. [RUN]
2018-04-17 14:23:46,507: 14:23:46 | 24 of 91 START table model agency_data_pipeline.bing_ads_stats....... [RUN]
2018-04-17 14:23:46,508: 14:23:46 | 25 of 91 START table model agency_data_pipeline.ga_mcf_stats......... [RUN]
2018-04-17 14:23:46,508: 14:23:46 | 26 of 91 START table model agency_data_pipeline.shopify_products_proc [RUN]
2018-04-17 14:23:46,508: Compiling model.agency_data_pipeline.agg_customers_union
2018-04-17 14:23:46,508: Compiling model.agency_data_pipeline.bing_ads_stats
2018-04-17 14:23:46,509: Compiling model.agency_data_pipeline.ga_mcf_stats
2018-04-17 14:23:46,509: Compiling model.agency_data_pipeline.shopify_products_proc
2018-04-17 14:23:46,524: Writing injected SQL for node "model.agency_data_pipeline.agg_customers_union"
2018-04-17 14:23:46,525: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_stats"
2018-04-17 14:23:46,542: Writing injected SQL for node "model.agency_data_pipeline.ga_mcf_stats"
2018-04-17 14:23:46,547: Acquiring new bigquery connection "shopify_products_proc".
2018-04-17 14:23:46,547: Re-using an available connection from the pool.
2018-04-17 14:23:46,547: Fetching data for query shopify_products_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 14:23:46,551: Acquiring new bigquery connection "agg_customers_union".
2018-04-17 14:23:46,553: Acquiring new bigquery connection "bing_ads_stats".
2018-04-17 14:23:46,553: Re-using an available connection from the pool.
2018-04-17 14:23:46,555: Acquiring new bigquery connection "ga_mcf_stats".
2018-04-17 14:23:46,560: Re-using an available connection from the pool.
2018-04-17 14:23:46,564: Re-using an available connection from the pool.
2018-04-17 14:23:47,032: Writing injected SQL for node "model.agency_data_pipeline.shopify_products_proc"
2018-04-17 14:23:47,385: Model SQL (bing_ads_stats):
select
a.date, 
a.account, 
a.channel,
a.platform,
url,
a.campaignname campaign,
utm_campaign,
cost,
clicks,
impressions,
transactions
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`bing_ads_ads` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`bing_ads_conversions` b
ON (
	a.date = b.date AND
	a.account = b.account AND
	a.campaignid = b.campaignid

)
2018-04-17 14:23:47,395: Model SQL (ga_mcf_stats):
SELECT  
date,
a.account account,
b.client client,
case when c.platform is null then "Unmapped" else c.platform end as platform,
case when c.channel is null then "Unmapped" else c.channel end as channel,
lower(a.source) source,
lower(a.medium) medium,
lower(campaign) campaign,
transactionid,
sum(transactions) first_touch_transactions,
sum(revenue) first_touch_revenue
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`ga_mcf_proc` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc` b 
ON ( a.account = b.account and
	a.lookup_platform = b.platform )
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc` c
ON ( lower(a.source) = c.source
  AND lower(a.medium) = c.medium 
  and a.account = c.account )
group by date, account, client, source, medium, campaign, platform, channel, transactionid
2018-04-17 14:23:47,399: Model SQL (agg_customers_union):
SELECT *
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`shopify_customers_proc`
2018-04-17 14:23:47,852: Model SQL (shopify_products_proc):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc`, `growth-engines-pipeline`.`agency_data_pipeline`.`shopify_refunds_proc`





with products as (

	
	SELECT
	'lucadanni' client_name,
	'Shopify' as lookup_platform,
	product_type,
	product_id,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY product_id ORDER BY _sdc_sequence DESC) lv
	FROM `growth-engines-pipeline.shopify_lucadanni.products` 
	cross join unnest(variants)
	
	

)

SELECT
b.account,
b.client,
b.platform,
max(product_type) product_type,
product_id
FROM products a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
ON ( a.client_name = b.client_name
  AND a.lookup_platform = b.platform )
where a.lv = a._sdc_sequence
group by product_id, account, client, platform


2018-04-17 14:23:49,608: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10973ada0>]}
2018-04-17 14:23:49,843: 14:23:49 | 24 of 91 OK created table model agency_data_pipeline.bing_ads_stats.. [CREATE TABLE in 3.10s]
2018-04-17 14:23:49,843: 14:23:49 | 27 of 91 START table model agency_data_pipeline.shopify_orders_proc.. [RUN]
2018-04-17 14:23:49,843: Compiling model.agency_data_pipeline.shopify_orders_proc
2018-04-17 14:23:49,854: Acquiring new bigquery connection "shopify_orders_proc".
2018-04-17 14:23:49,854: Re-using an available connection from the pool.
2018-04-17 14:23:49,854: Fetching data for query shopify_orders_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 14:23:50,064: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ab4cf98>]}
2018-04-17 14:23:50,178: Writing injected SQL for node "model.agency_data_pipeline.shopify_orders_proc"
2018-04-17 14:23:50,295: 14:23:50 | 26 of 91 OK created table model agency_data_pipeline.shopify_products_proc [CREATE TABLE in 3.55s]
2018-04-17 14:23:50,724: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10869aeb8>]}
2018-04-17 14:23:50,973: 14:23:50 | 23 of 91 OK created table model agency_data_pipeline.agg_customers_union [CREATE TABLE in 4.22s]
2018-04-17 14:23:51,054: Model SQL (shopify_orders_proc):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc`, `growth-engines-pipeline`.`agency_data_pipeline`.`shopify_refunds_proc`





with orders as (

	
	SELECT
	'lucadanni' client_name,
	'Shopify' as lookup_platform,
	created_at,
	order_number,
	quantity,
	cast(pre_tax_price as float64) price, 
	total_line_items_price total_order_price_undiscounted,
	total_discounts,
	cast(discounted_price as float64) total_order_shipping_price,
	total_price_usd total_order_price_incl_shipping,
	checkout_id,
	product_id, 
	landing_site,
	sku, 
	variant_title, 
	variant_id,
	_id line_item_id,
	customer.id customer_id,
	customer.orders_count orders_count,
	customer.created_at customer_created_at,
	customer.last_order_id last_order_id,
	financial_status,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY order_number, _id ORDER BY _sdc_sequence DESC) lv
	FROM `growth-engines-pipeline.shopify_lucadanni.orders` 
	cross join unnest(line_items), unnest(shipping_lines)
	where source_name != 'shopify_draft_order'
	
	

)

SELECT
b.account,
b.client,
b.platform,
created_at,
a.order_number,
a.quantity,
c.quantity refund_quantity,
case when c.quantity is not null then a.quantity - c.quantity else a.quantity end as final_quantity,
price, 
total_order_price_undiscounted,
total_discounts,
total_order_shipping_price,
total_order_price_incl_shipping,
refund_amount,
case when refund_amount is not null then price - refund_amount else price end as final_price,
a.checkout_id,
a.product_id, 
landing_site,
sku, 
variant_title, 
a.variant_id,
a.line_item_id,	
customer_id,
orders_count,
customer_created_at,
last_order_id,
a.financial_status
FROM orders a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
ON ( a.client_name = b.client_name
  AND a.lookup_platform = b.platform )
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`shopify_refunds_proc` c
ON ( a.order_number = c.order_number
	AND a.line_item_id = c.line_item_id )   	
where a.lv = a._sdc_sequence


2018-04-17 14:23:58,564: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ab56198>]}
2018-04-17 14:23:59,264: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ab56668>]}
2018-04-17 14:23:59,385: 14:23:59 | 25 of 91 OK created table model agency_data_pipeline.ga_mcf_stats.... [CREATE TABLE in 12.06s]
2018-04-17 14:23:59,627: 14:23:59 | 27 of 91 OK created table model agency_data_pipeline.shopify_orders_proc [CREATE TABLE in 9.42s]
2018-04-17 14:23:59,628: 14:23:59 | 28 of 91 START table model agency_data_pipeline.agg_products......... [RUN]
2018-04-17 14:23:59,628: Compiling model.agency_data_pipeline.agg_products
2018-04-17 14:23:59,633: 14:23:59 | 29 of 91 START table model agency_data_pipeline.ga_traffic........... [RUN]
2018-04-17 14:23:59,634: 14:23:59 | 30 of 91 START table model agency_data_pipeline.agg_orders_union..... [RUN]
2018-04-17 14:23:59,634: 14:23:59 | 31 of 91 START table model agency_data_pipeline.adwords_join......... [RUN]
2018-04-17 14:23:59,636: Writing injected SQL for node "model.agency_data_pipeline.agg_products"
2018-04-17 14:23:59,636: Compiling model.agency_data_pipeline.ga_traffic
2018-04-17 14:23:59,636: Compiling model.agency_data_pipeline.agg_orders_union
2018-04-17 14:23:59,636: Compiling model.agency_data_pipeline.adwords_join
2018-04-17 14:23:59,657: Acquiring new bigquery connection "ga_traffic".
2018-04-17 14:23:59,663: Writing injected SQL for node "model.agency_data_pipeline.agg_orders_union"
2018-04-17 14:23:59,670: Acquiring new bigquery connection "agg_products".
2018-04-17 14:23:59,674: Writing injected SQL for node "model.agency_data_pipeline.adwords_join"
2018-04-17 14:23:59,674: Re-using an available connection from the pool.
2018-04-17 14:23:59,675: Fetching data for query ga_traffic:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'GA Traffic'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 14:23:59,676: Acquiring new bigquery connection "agg_orders_union".
2018-04-17 14:23:59,676: Re-using an available connection from the pool.
2018-04-17 14:23:59,680: Re-using an available connection from the pool.
2018-04-17 14:23:59,684: Acquiring new bigquery connection "adwords_join".
2018-04-17 14:23:59,688: Re-using an available connection from the pool.
2018-04-17 14:24:00,694: Model SQL (agg_orders_union):
SELECT
account,
client,
platform,
created_at,
order_number,
quantity,
refund_quantity,
final_quantity,
price, 
total_order_price_undiscounted,
total_discounts,
total_order_shipping_price,
total_order_price_incl_shipping,
refund_amount,
final_price,
checkout_id,
product_id, 
landing_site,
sku, 
variant_title, 
variant_id,
line_item_id,	
customer_id,
orders_count,
customer_created_at,
last_order_id,
financial_status
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`shopify_orders_proc`
2018-04-17 14:24:00,695: Model SQL (adwords_join):
select
a.day,
a.campaignid, 
a.campaign,
a.account, 
channel,
platform,
url,
utm_campaign,
cost,
impressions,
clicks,
impression_share_num,
impression_share_den,
transactions
FROM ( 
	
	select
	day,
	a.campaign,
	a.campaignid, 
	account, 
	channel,
	platform,
	url,
	cost,
	impressions,
	clicks,
	impression_share_num,
	impression_share_den
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_campaigns` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_urls` b
	ON a.campaignid = b.campaignid

) a 
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_ads` b
ON ( a.campaignid = b.campaignid
	and a.day = b.day )
2018-04-17 14:24:00,790: Model SQL (agg_products):
SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`shopify_products_proc`
2018-04-17 14:24:00,895: Fetching data for query ga_traffic:


        select
            goal_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_conversions`

        
        ##where 1 = 1
        where goal_type = 'Conversion'
        
        
        
        ##and 2 = 2
        and client_name = 'lucadanni'
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 14:24:02,543: Writing injected SQL for node "model.agency_data_pipeline.ga_traffic"
2018-04-17 14:24:02,997: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1052ece48>]}
2018-04-17 14:24:03,234: 14:24:03 | 28 of 91 OK created table model agency_data_pipeline.agg_products.... [CREATE TABLE in 3.37s]
2018-04-17 14:24:03,234: 14:24:03 | 32 of 91 START table model agency_data_pipeline.ga_transactions...... [RUN]
2018-04-17 14:24:03,234: Compiling model.agency_data_pipeline.ga_transactions
2018-04-17 14:24:03,253: Acquiring new bigquery connection "ga_transactions".
2018-04-17 14:24:03,253: Re-using an available connection from the pool.
2018-04-17 14:24:03,254: Fetching data for query ga_transactions:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Google Analytics'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 14:24:03,435: Model SQL (ga_traffic):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc`, `growth-engines-pipeline`.`agency_data_pipeline`.`ga_conversions`


##`growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` 



with ga_report as (

	    

	    	
	    	
		   	SELECT
		   	'lucadanni' as client_name,
		   	'GA Traffic' as lookup_platform,
			lower(trim(regexp_replace(replace(replace(replace(replace(CONCAT(hostname,landingpagepath),'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
			date,
			lower(source) source,
			lower(medium) medium,
			lower(campaign) campaign,
			sessions,
			## goal completion columns
							
				goalcompletionsall as goal_completions,		
			
			_sdc_sequence,
			first_value(_sdc_sequence) OVER (PARTITION BY hostname, landingpagepath, date, source, medium, campaign ORDER BY _sdc_sequence DESC) lv
			FROM `growth-engines-pipeline.ga_lucadanni_traffic.report` 

		    
	   

)


SELECT  
cast(date as date) date,
b.account,
b.client client,
c.source source,
c.medium medium,
a.campaign campaign,
concat(a.source, ' / ', a.medium) source_medium,  
case when c.platform is null then "Unmapped" else c.platform end as platform,
case when c.channel is null then "Unmapped" else c.channel end as channel,
regexp_replace(url, r'offers.|offer.|get.|info.|pos.|go.|join.|pages.','') url,
max(sessions) sessions,
max(goal_completions) goal_completions
FROM ga_report a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
ON ( a.client_name = b.client_name 
	AND a.lookup_platform = b.platform )
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc` c
ON ( a.source = c.source
  AND a.medium = c.medium 
  AND a.client_name = c.client_name )
GROUP BY date, account, client, source, medium, campaign, source_medium, platform, channel, url


2018-04-17 14:24:04,466: Fetching data for query ga_transactions:


        select
            goal_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_conversions`

        
        ##where 1 = 1
        where goal_type = 'Conversion'
        
        
        
        ##and 2 = 2
        and client_name = 'lucadanni'
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 14:24:04,833: Writing injected SQL for node "model.agency_data_pipeline.ga_transactions"
2018-04-17 14:24:05,678: Model SQL (ga_transactions):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc`, `growth-engines-pipeline`.`agency_data_pipeline`.`ga_conversions`


##`growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` 



with ga_report as (

	    

	    	
	    	
		   	SELECT
		   	'lucadanni' as client_name,
		   	'Google Analytics' as lookup_platform,
			lower(trim(regexp_replace(replace(replace(replace(replace(CONCAT(hostname,landingpagepath),'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
			date,
			lower(source) source,
			lower(medium) medium,
			lower(campaign) campaign,
			cast(regexp_replace(transactionid, r'#', '') as int64) transactionid,
			transactions last_touch_transactions,
			(transactionrevenue - transactionshipping - transactiontax) as last_touch_revenue,
			transactionshipping,
			transactiontax,
			_sdc_sequence,
			first_value(_sdc_sequence) OVER (PARTITION BY hostname, landingpagepath, date, source, medium, transactionid ORDER BY _sdc_sequence DESC) lv
			FROM `growth-engines-pipeline.ga_lucadanni.report` 

		    
	   

)


SELECT  
cast(date as date) date,
b.account,
b.client client,
c.source source,
c.medium medium,
a.campaign campaign,
concat(a.source, ' / ', a.medium) source_medium,  
case when c.platform is null then "Unmapped" else c.platform end as platform,
case when c.channel is null then "Unmapped" else c.channel end as channel,
regexp_replace(url, r'offers.|offer.|get.|info.|pos.|go.|join.|pages.','') url,
transactionid,
max(last_touch_transactions) last_touch_transactions,
max(last_touch_revenue) last_touch_revenue,
max(transactionshipping) last_touch_shipping,
max(transactiontax) last_touch_tax
FROM ga_report a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
ON ( a.client_name = b.client_name 
	AND a.lookup_platform = b.platform )
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc` c
ON ( a.source = c.source
  AND a.medium = c.medium 
  AND a.client_name = c.client_name )
GROUP BY date, account, client, source, medium, campaign, source_medium, platform, channel, url, transactionid


2018-04-17 14:24:06,245: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10877c3c8>]}
2018-04-17 14:24:06,277: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10877ca90>]}
2018-04-17 14:24:06,592: 14:24:06 | 30 of 91 OK created table model agency_data_pipeline.agg_orders_union [CREATE TABLE in 6.61s]
2018-04-17 14:24:06,829: 14:24:06 | 31 of 91 OK created table model agency_data_pipeline.adwords_join.... [CREATE TABLE in 6.64s]
2018-04-17 14:24:11,635: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10877c7f0>]}
2018-04-17 14:24:11,881: 14:24:11 | 32 of 91 OK created table model agency_data_pipeline.ga_transactions. [CREATE TABLE in 8.40s]
2018-04-17 14:24:21,753: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10874aef0>]}
2018-04-17 14:24:22,020: 14:24:22 | 29 of 91 OK created table model agency_data_pipeline.ga_traffic...... [CREATE TABLE in 22.12s]
2018-04-17 14:24:22,021: 14:24:22 | 33 of 91 START table model agency_data_pipeline.adwords_impression_share [RUN]
2018-04-17 14:24:22,021: 14:24:22 | 34 of 91 START table model agency_data_pipeline.fb_ads_stats......... [RUN]
2018-04-17 14:24:22,022: Compiling model.agency_data_pipeline.adwords_impression_share
2018-04-17 14:24:22,021: 14:24:22 | 35 of 91 START table model agency_data_pipeline.agg_transaction_order_number [RUN]
2018-04-17 14:24:22,022: 14:24:22 | 36 of 91 START table model agency_data_pipeline.adwords_stats........ [RUN]
2018-04-17 14:24:22,022: Compiling model.agency_data_pipeline.fb_ads_stats
2018-04-17 14:24:22,029: Compiling model.agency_data_pipeline.agg_transaction_order_number
2018-04-17 14:24:22,032: Writing injected SQL for node "model.agency_data_pipeline.adwords_impression_share"
2018-04-17 14:24:22,032: Compiling model.agency_data_pipeline.adwords_stats
2018-04-17 14:24:22,038: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_stats"
2018-04-17 14:24:22,043: Writing injected SQL for node "model.agency_data_pipeline.agg_transaction_order_number"
2018-04-17 14:24:22,047: Writing injected SQL for node "model.agency_data_pipeline.adwords_stats"
2018-04-17 14:24:22,049: Acquiring new bigquery connection "adwords_impression_share".
2018-04-17 14:24:22,049: Re-using an available connection from the pool.
2018-04-17 14:24:22,050: Acquiring new bigquery connection "fb_ads_stats".
2018-04-17 14:24:22,050: Acquiring new bigquery connection "agg_transaction_order_number".
2018-04-17 14:24:22,053: Acquiring new bigquery connection "adwords_stats".
2018-04-17 14:24:22,053: Re-using an available connection from the pool.
2018-04-17 14:24:22,055: Re-using an available connection from the pool.
2018-04-17 14:24:22,057: Re-using an available connection from the pool.
2018-04-17 14:24:22,867: Model SQL (adwords_impression_share):
SELECT 
cast(day as date) date, 
account, 
channel,
platform,
sum(impression_share_num) impressions,
sum(impression_share_den) available_impressions
FROM 
  `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_join`
group by date, account, platform, channel
2018-04-17 14:24:22,894: Model SQL (agg_transaction_order_number):
SELECT
client,
cast(created_at as date) date,
order_number,
customer_id,
sum(final_quantity) final_quantity,
sum(final_price) final_price,
max(total_order_shipping_price) shipping_price
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`agg_orders_union`
GROUP BY client, created_at, order_number, customer_id
2018-04-17 14:24:22,929: Model SQL (fb_ads_stats):
with cost as (

    select 
        date, account, ad_id, campaign,
        cost, impressions, clicks, null as conversions
    from `growth-engines-pipeline`.`agency_data_pipeline`.`fb_ads_insights`
),

conversions as (

    select 
        date, account, ad_id, campaign,
        null as cost, null as impressions, null as clicks, conversions
    from `growth-engines-pipeline`.`agency_data_pipeline`.`fb_ads_insights_conversions`
),

urls as (

    select ad_id, url
    from `growth-engines-pipeline`.`agency_data_pipeline`.`fb_ads`
)


SELECT
    cast(date as date) date,
    'FB Ads' platform,
    'Paid' channel,
    account, 
    b.url url,
    campaign,
    lower(campaign) utm_campaign, 
    sum(cost) cost,
    sum(impressions) impressions,
    sum(clicks) clicks,
    sum(conversions) transactions
FROM
(
    SELECT *
    FROM 
      cost
    UNION ALL
    SELECT *
    FROM 
      conversions
) a
LEFT JOIN urls b
ON ( a.ad_id = b.ad_id )
group by date, platform, channel, account, url, campaign, utm_campaign
2018-04-17 14:24:22,990: Model SQL (adwords_stats):
SELECT 
cast(day as date) date, 
account, 
platform,
channel,
url,
utm_campaign,
campaign,
sum(cost) cost,
sum(impressions) impressions,
sum(clicks) clicks,
sum(transactions) transactions
FROM 
  `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_join`
group by date, account, platform, channel, url, campaign, utm_campaign
2018-04-17 14:24:24,019: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1087f4a20>]}
2018-04-17 14:24:24,275: 14:24:24 | 33 of 91 OK created table model agency_data_pipeline.adwords_impression_share [CREATE TABLE in 2.00s]
2018-04-17 14:24:24,275: 14:24:24 | 37 of 91 START table model agency_data_pipeline.agg_transaction_line_item [RUN]
2018-04-17 14:24:24,275: Compiling model.agency_data_pipeline.agg_transaction_line_item
2018-04-17 14:24:24,284: Writing injected SQL for node "model.agency_data_pipeline.agg_transaction_line_item"
2018-04-17 14:24:24,285: Acquiring new bigquery connection "agg_transaction_line_item".
2018-04-17 14:24:24,285: Re-using an available connection from the pool.
2018-04-17 14:24:25,085: Model SQL (agg_transaction_line_item):
SELECT
client,
created_at,
order_number,
quantity,
refund_quantity,
final_quantity,
price, 
total_order_price_undiscounted,
total_discounts,
total_order_shipping_price,
total_order_price_incl_shipping,
refund_amount,
final_price,
checkout_id,
product_id, 
landing_site,
sku, 
variant_title, 
variant_id,
line_item_id,	
customer_id,
orders_count,
customer_created_at,
last_order_id,
financial_status
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`agg_orders_union`
2018-04-17 14:24:25,161: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10532e898>]}
2018-04-17 14:24:25,423: 14:24:25 | 34 of 91 OK created table model agency_data_pipeline.fb_ads_stats.... [CREATE TABLE in 3.14s]
2018-04-17 14:24:26,225: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105318b70>]}
2018-04-17 14:24:26,524: 14:24:26 | 35 of 91 OK created table model agency_data_pipeline.agg_transaction_order_number [CREATE TABLE in 4.20s]
2018-04-17 14:24:28,658: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10530fc18>]}
2018-04-17 14:24:28,888: 14:24:28 | 36 of 91 OK created table model agency_data_pipeline.adwords_stats... [CREATE TABLE in 6.63s]
2018-04-17 14:24:33,992: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1087f4a20>]}
2018-04-17 14:24:34,236: 14:24:34 | 37 of 91 OK created table model agency_data_pipeline.agg_transaction_line_item [CREATE TABLE in 9.72s]
2018-04-17 14:24:34,237: 14:24:34 | 38 of 91 START table model agency_data_pipeline.customers_by_transaction [RUN]
2018-04-17 14:24:34,237: Compiling model.agency_data_pipeline.customers_by_transaction
2018-04-17 14:24:34,244: Writing injected SQL for node "model.agency_data_pipeline.customers_by_transaction"
2018-04-17 14:24:34,245: Acquiring new bigquery connection "customers_by_transaction".
2018-04-17 14:24:34,245: Re-using an available connection from the pool.
2018-04-17 14:24:35,103: Model SQL (customers_by_transaction):
SELECT
client,
customer_id,
order_number,
order_date,
first_order_date,
case when first_order_number = order_number then 'New' else 'Existing' end as order_type,
final_price,
first_order_revenue,
lifetime_revenue
FROM

(

	SELECT
	client,
	customer_id,
	order_number,
	date order_date,
	first_value(date) over w1 first_order_date,
	first_value(order_number) over w1 first_order_number,
	first_value(final_price) over w1 first_order_revenue,
    final_price,
	sum(final_price) over w2 lifetime_revenue
	FROM
    `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_order_number`
	WINDOW w1 as (PARTITION BY client, customer_id ORDER BY date desc),
	w2 as (PARTITION BY client, customer_id)
)
2018-04-17 14:24:38,446: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10874aef0>]}
2018-04-17 14:24:38,684: 14:24:38 | 38 of 91 OK created table model agency_data_pipeline.customers_by_transaction [CREATE TABLE in 4.21s]
2018-04-17 14:24:38,685: 14:24:38 | 39 of 91 START table model agency_data_pipeline.agg_ga_transaction_order_number [RUN]
2018-04-17 14:24:38,685: 14:24:38 | 40 of 91 START table model agency_data_pipeline.frequency_proc....... [RUN]
2018-04-17 14:24:38,686: Compiling model.agency_data_pipeline.agg_ga_transaction_order_number
2018-04-17 14:24:38,686: Compiling model.agency_data_pipeline.frequency_proc
2018-04-17 14:24:38,701: Writing injected SQL for node "model.agency_data_pipeline.agg_ga_transaction_order_number"
2018-04-17 14:24:38,703: Writing injected SQL for node "model.agency_data_pipeline.frequency_proc"
2018-04-17 14:24:38,706: Acquiring new bigquery connection "agg_ga_transaction_order_number".
2018-04-17 14:24:38,707: Re-using an available connection from the pool.
2018-04-17 14:24:38,707: Acquiring new bigquery connection "frequency_proc".
2018-04-17 14:24:38,709: Re-using an available connection from the pool.
2018-04-17 14:24:39,248: Model SQL (frequency_proc):
WITH transactions AS (

  	SELECT 
	client,
	customer_id,
	order_number,
	date,
	unix_date(date) d
	FROM
	`growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_order_number`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)

SELECT 
client,
'Rolling 365' as period,
date_in_range date,
unix_date_in_range, 
customer_id,
count(distinct(order_number)) frequency
FROM daterange
JOIN transactions
ON transactions.d > ( daterange.unix_date_in_range - 365 )
AND transactions.d <= daterange.unix_date_in_range
group by client, unix_date_in_range, customer_id
2018-04-17 14:24:39,248: Bad request while running:
WITH transactions AS (

  	SELECT 
	client,
	customer_id,
	order_number,
	date,
	unix_date(date) d
	FROM
	`growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_order_number`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)

SELECT 
client,
'Rolling 365' as period,
date_in_range date,
unix_date_in_range, 
customer_id,
count(distinct(order_number)) frequency
FROM daterange
JOIN transactions
ON transactions.d > ( daterange.unix_date_in_range - 365 )
AND transactions.d <= daterange.unix_date_in_range
group by client, unix_date_in_range, customer_id
2018-04-17 14:24:39,248: 400 SELECT list expression references column date_in_range which is neither grouped nor aggregated at [20:1]
2018-04-17 14:24:39,249: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1052f77f0>]}
2018-04-17 14:24:39,445: Model SQL (agg_ga_transaction_order_number):
with ga as (

    select 
        date, account, client, 
        channel as last_touch_channel, 
        platform as last_touch_platform, 
        url as last_touch_url, 
        campaign as last_touch_utm_campaign, 
        '' as first_touch_channel, 
        '' as first_touch_platform, 
        '' as first_touch_utm_campaign, 
        transactionid,
        last_touch_transactions, last_touch_revenue,
        last_touch_shipping, last_touch_tax,
        null as first_touch_transactions, null as first_touch_revenue
    from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_transactions`

),

ga_mcf as (

    select 
        date, account, client, 
        '' as last_touch_channel,
        '' as last_touch_platform,
        '' as last_touch_url,
        '' as last_touch_utm_campaign, 
        channel as first_touch_channel, 
        platform as first_touch_platform, 
        campaign as first_touch_utm_campaign, 
        transactionid, 
        null as last_touch_transactions, null as last_touch_revenue,
        null as last_touch_shipping, null as last_touch_tax,
        first_touch_transactions, first_touch_revenue
    from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_mcf_stats`

)


SELECT
    date, 
    client,
    transactionid,
    max(last_touch_channel) last_touch_channel, 
    max(last_touch_platform) last_touch_platform, 
    max(last_touch_url) last_touch_url, 
    max(last_touch_utm_campaign) last_touch_utm_campaign, 
    max(first_touch_channel) first_touch_channel, 
    max(first_touch_platform) first_touch_platform, 
    max(first_touch_utm_campaign) first_touch_utm_campaign,
    sum(last_touch_transactions) last_touch_transactions,
    sum(last_touch_revenue) last_touch_revenue,
    sum(last_touch_shipping) last_touch_shipping_revenue,
    sum(last_touch_tax) last_touch_tax_revenue,
    sum(first_touch_transactions) first_touch_transactions,
    sum(first_touch_revenue) - ifnull(sum(last_touch_shipping),0) - ifnull(sum(last_touch_tax),0) first_touch_revenue
FROM
(
    SELECT *
    FROM 
      ga
    UNION ALL
    SELECT *
    FROM 
      ga_mcf
) 
GROUP BY
    date, client, transactionid
2018-04-17 14:24:39,511: 14:24:39 | 40 of 91 ERROR creating table model agency_data_pipeline.frequency_proc [ERROR in 0.56s]
2018-04-17 14:24:44,076: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1087f4a20>]}
2018-04-17 14:24:44,369: 14:24:44 | 39 of 91 OK created table model agency_data_pipeline.agg_ga_transaction_order_number [CREATE TABLE in 5.39s]
2018-04-17 14:24:44,370: 14:24:44 | 41 of 91 START table model agency_data_pipeline.agg_transaction_line_item_type [RUN]
2018-04-17 14:24:44,370: 14:24:44 | 42 of 91 START table model agency_data_pipeline.agg_ga_campaign...... [RUN]
2018-04-17 14:24:44,371: Compiling model.agency_data_pipeline.agg_transaction_line_item_type
2018-04-17 14:24:44,371: 14:24:44 | 43 of 91 SKIP relation agency_data_pipeline.frequency_stats.......... [SKIP]
2018-04-17 14:24:44,371: Compiling model.agency_data_pipeline.agg_ga_campaign
2018-04-17 14:24:44,378: Writing injected SQL for node "model.agency_data_pipeline.agg_transaction_line_item_type"
2018-04-17 14:24:44,384: Writing injected SQL for node "model.agency_data_pipeline.agg_ga_campaign"
2018-04-17 14:24:44,385: Acquiring new bigquery connection "agg_ga_campaign".
2018-04-17 14:24:44,386: Acquiring new bigquery connection "agg_transaction_line_item_type".
2018-04-17 14:24:44,386: Re-using an available connection from the pool.
2018-04-17 14:24:44,386: Re-using an available connection from the pool.
2018-04-17 14:24:45,231: Model SQL (agg_ga_campaign):
with ga_transactions as (

	select 
		date, account, client, channel, platform, url, 
		campaign,
		null as sessions, null as goal_completions, last_touch_transactions, last_touch_revenue,
		last_touch_shipping, last_touch_tax,
		null as first_touch_transactions, null as first_touch_revenue
	from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_transactions`

),

ga_traffic as (

    select 
        date, account, client, channel, platform, url, 
        campaign,
        sessions, goal_completions, null as last_touch_transactions, null as last_touch_revenue,
        null as last_touch_shipping, null as last_touch_tax,
        null as first_touch_transactions, null as first_touch_revenue
    from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_traffic`

),

ga_mcf as (

	select 
		date, account, client, channel, platform, '' as url,
		campaign, 
		null as sessions, null as goal_completions, null as last_touch_transactions, null as last_touch_revenue,
		null as last_touch_shipping, null as last_touch_tax,
		first_touch_transactions, first_touch_revenue
	from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_mcf_stats`

)


SELECT
    date, 
    client,
    platform,
    channel, 
    url,
    campaign utm_campaign,
	sum(sessions) sessions,
	sum(goal_completions) goal_completions,
	sum(last_touch_transactions) last_touch_transactions,
	sum(last_touch_revenue) last_touch_revenue,
    sum(last_touch_shipping) last_touch_shipping_revenue,
    sum(last_touch_tax) last_touch_tax_revenue,
    sum(first_touch_transactions) first_touch_transactions,
    sum(first_touch_revenue) - sum(ifnull(last_touch_shipping,0)) - sum(ifnull(last_touch_tax,0)) first_touch_revenue

FROM
(
    SELECT *
    FROM 
      ga_transactions
    UNION ALL
    SELECT *
    FROM 
      ga_traffic
    UNION ALL
    SELECT *
    FROM 
      ga_mcf
) 
GROUP BY
    date, client, platform, channel, url, utm_campaign
2018-04-17 14:24:45,307: Model SQL (agg_transaction_line_item_type):
SELECT
client,
product_id,
product_type,
customer_id,
sku,
order_number,
created_at,
final_quantity,
final_price
FROM

( 
	SELECT 
	a.client, 
	a.product_id,
	product_type,
	customer_id,
	a.sku, 
	order_number,
	created_at,
	final_quantity,
	final_price
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_line_item` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`agg_products` b
	ON (
		a.product_id = b.product_id
	  and a.client = b.client
		)

)
2018-04-17 14:24:50,910: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10874aef0>]}
2018-04-17 14:24:51,240: 14:24:51 | 41 of 91 OK created table model agency_data_pipeline.agg_transaction_line_item_type [CREATE TABLE in 6.54s]
2018-04-17 14:24:54,116: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1052cf860>]}
2018-04-17 14:24:54,344: 14:24:54 | 42 of 91 OK created table model agency_data_pipeline.agg_ga_campaign. [CREATE TABLE in 9.74s]
2018-04-17 14:24:54,345: 14:24:54 | 44 of 91 START table model agency_data_pipeline.customers_first_purchase_product_type_proc [RUN]
2018-04-17 14:24:54,345: 14:24:54 | 45 of 91 START table model agency_data_pipeline.agg_transaction_product_type [RUN]
2018-04-17 14:24:54,345: Compiling model.agency_data_pipeline.customers_first_purchase_product_type_proc
2018-04-17 14:24:54,346: Compiling model.agency_data_pipeline.agg_transaction_product_type
2018-04-17 14:24:54,356: Writing injected SQL for node "model.agency_data_pipeline.agg_transaction_product_type"
2018-04-17 14:24:54,357: Writing injected SQL for node "model.agency_data_pipeline.customers_first_purchase_product_type_proc"
2018-04-17 14:24:54,359: Acquiring new bigquery connection "agg_transaction_product_type".
2018-04-17 14:24:54,359: Re-using an available connection from the pool.
2018-04-17 14:24:54,361: Acquiring new bigquery connection "customers_first_purchase_product_type_proc".
2018-04-17 14:24:54,361: Re-using an available connection from the pool.
2018-04-17 14:24:55,143: Model SQL (customers_first_purchase_product_type_proc):
SELECT 
client, 
customer_id, 
product_type,
min(cast(created_at as date)) first_order_date,
unix_date( min(cast(created_at as date))) first_order_unix_date
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_line_item_type`
GROUP BY client, customer_id, product_type
2018-04-17 14:24:55,163: Model SQL (agg_transaction_product_type):
SELECT
client,
product_type,
customer_id,
order_number,
created_at,
first_value(product_type) over (PARTITION BY client, customer_id, order_number, created_at ORDER BY final_price desc) as top_order_product_type,
final_quantity,
final_price,
sum(final_quantity) over (PARTITION BY client, customer_id, order_number) as total_order_quantity,
sum(final_price) over (PARTITION BY client, customer_id, order_number) as total_order_value
FROM
	(
		SELECT
		client,
		product_type,
		customer_id,
		order_number,
		created_at,
		sum(final_quantity) final_quantity,
		sum(final_price) final_price
		FROM
		`growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_line_item_type`
		GROUP BY
		client,
		product_type,
		customer_id,
		order_number,
		created_at
	)
2018-04-17 14:24:58,502: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1087f4a20>]}
2018-04-17 14:24:58,732: 14:24:58 | 44 of 91 OK created table model agency_data_pipeline.customers_first_purchase_product_type_proc [CREATE TABLE in 4.16s]
2018-04-17 14:24:59,661: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10530f278>]}
2018-04-17 14:25:00,317: 14:25:00 | 45 of 91 OK created table model agency_data_pipeline.agg_transaction_product_type [CREATE TABLE in 5.32s]
2018-04-17 14:25:00,318: 14:25:00 | 46 of 91 START table model agency_data_pipeline.order_paths_proc..... [RUN]
2018-04-17 14:25:00,319: Compiling model.agency_data_pipeline.order_paths_proc
2018-04-17 14:25:00,318: 14:25:00 | 47 of 91 START table model agency_data_pipeline.products_proc........ [RUN]
2018-04-17 14:25:00,328: Writing injected SQL for node "model.agency_data_pipeline.order_paths_proc"
2018-04-17 14:25:00,319: 14:25:00 | 48 of 91 START table model agency_data_pipeline.customers_products_proc [RUN]
2018-04-17 14:25:00,328: Compiling model.agency_data_pipeline.products_proc
2018-04-17 14:25:00,328: Compiling model.agency_data_pipeline.customers_products_proc
2018-04-17 14:25:00,334: Writing injected SQL for node "model.agency_data_pipeline.products_proc"
2018-04-17 14:25:00,340: Writing injected SQL for node "model.agency_data_pipeline.customers_products_proc"
2018-04-17 14:25:00,341: Acquiring new bigquery connection "order_paths_proc".
2018-04-17 14:25:00,342: Re-using an available connection from the pool.
2018-04-17 14:25:00,342: Acquiring new bigquery connection "products_proc".
2018-04-17 14:25:00,343: Acquiring new bigquery connection "customers_products_proc".
2018-04-17 14:25:00,344: Re-using an available connection from the pool.
2018-04-17 14:25:00,354: Re-using an available connection from the pool.
2018-04-17 14:25:01,163: Model SQL (products_proc):
WITH transactions AS (
  SELECT 
  client, 
  product_id,
  product_type,
  customer_id,
  sku, 
  order_number,
  unix_date(cast(created_at as date)) d, 
  final_quantity,
  final_price
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_line_item_type`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)

SELECT 
client,
'Last 30' as period,
sku, 
product_type,
date_in_range date,
unix_date_in_range, 
count(distinct(customer_id)) unique_customers,
count(distinct(order_number)) orders,
sum(final_quantity) quantity,
sum(final_price) revenue
FROM daterange
JOIN transactions
ON transactions.d > ( daterange.unix_date_in_range - 30 )
AND transactions.d <= daterange.unix_date_in_range
group by date_in_range, unix_date_in_range, client, sku, product_type

UNION ALL

SELECT 
client,
'Last 90' as period,
sku, 
product_type,
date_in_range date,
unix_date_in_range, 
count(distinct(customer_id)) unique_customers,
count(distinct(order_number)) orders,
sum(final_quantity) quantity,
sum(final_price) revenue
FROM daterange
JOIN transactions
ON transactions.d > ( daterange.unix_date_in_range - 90 )
AND transactions.d <= daterange.unix_date_in_range
group by date_in_range, unix_date_in_range, client, sku, product_type

UNION ALL

SELECT 
client,
'YoY 30' as date_range,
sku, 
product_type,
date_in_range date,
unix_date_in_range, 
count(distinct(customer_id)) unique_customers,
count(distinct(order_number)) orders,
sum(final_quantity) quantity,
sum(final_price) revenue
FROM daterange
JOIN transactions
ON transactions.d > ( daterange.unix_date_in_range - 395 )
AND transactions.d <= ( daterange.unix_date_in_range - 365 )
group by date_in_range, unix_date_in_range, client, sku, product_type
2018-04-17 14:25:01,167: Model SQL (customers_products_proc):
WITH customers AS (
  SELECT 
  client, 
  product_id,
  product_type,
  customer_id,
  sku, 
  order_number,
  cast(created_at as date) order_date,
  unix_date(cast(created_at as date)) unix_order_date, 
  final_quantity quantity,
  final_price revenue
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_line_item_type`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)

SELECT 
client,
period,
customer_id,
product_type,
date,
window_end_unix_date,
window_end_unix_date - 365 as window_start_unix_date,
window_end_unix_date - unix_date(recent_order) recency_days,
frequency,
quantity,
revenue,
case when frequency > 0 then revenue/frequency else 0 end as aov
FROM 
(  

  SELECT 
  client,
  'Rolling 365' as period,
  customer_id,
  product_type,
  date_in_range date,
  unix_date_in_range,
  unix_date_in_range window_end_unix_date, 
  max(order_date) recent_order,
  sum(quantity) as quantity,
  sum(revenue) as revenue,
  count(distinct(order_number)) as frequency
  FROM daterange
  JOIN customers
  ON customers.unix_order_date > ( daterange.unix_date_in_range - 365 )
  AND customers.unix_order_date <= daterange.unix_date_in_range
  GROUP BY client, customer_id, date, unix_date_in_range, product_type

  UNION ALL

  SELECT 
  client,
  'Rolling 365 (t-1mo)' as period,
  customer_id,
  product_type,
  date_in_range date,
  unix_date_in_range, 
  unix_date_in_range - 30 window_end_unix_date, 
  max(order_date) recent_order,
  sum(quantity) as quantity,
  sum(revenue) as revenue,
  count(distinct(order_number)) as frequency
  FROM daterange
  JOIN customers
  ON customers.unix_order_date > ( daterange.unix_date_in_range - 395 )
  AND customers.unix_order_date <= ( daterange.unix_date_in_range - 30 )
  GROUP BY client, customer_id, date, unix_date_in_range, product_type

  UNION ALL

  SELECT 
  client,
  'Rolling 365 (t-1yr)' as period,
  customer_id,
  product_type,
  date_in_range date,
  unix_date_in_range, 
  unix_date_in_range - 365 window_end_unix_date, 
  max(order_date) recent_order,
  sum(quantity) as quantity,
  sum(revenue) as revenue,
  count(distinct(order_number)) as frequency
  FROM daterange
  JOIN customers
  ON customers.unix_order_date > ( daterange.unix_date_in_range - 730 )
  AND customers.unix_order_date <= ( daterange.unix_date_in_range - 365 )
  GROUP BY client, customer_id, date, unix_date_in_range, product_type

)
2018-04-17 14:25:01,168: Model SQL (order_paths_proc):
SELECT
client, 
customer_id, 
first_value(product_type) OVER w1 as first_product_type,
nth_value(product_type, 2) OVER w1 as second_product_type,
cast(first_value(created_at) OVER w1 as date) as first_purchase_date,
cast(nth_value(created_at, 2) OVER w1 as date) as second_purchase_date,
cast(nth_value(created_at, 3) OVER w1 as date) as third_purchase_date,
cast(nth_value(created_at, 4) OVER w1 as date) as fourth_purchase_date,
cast(nth_value(created_at, 5) OVER w1 as date) as fifth_purchase_date,
first_value(order_number) OVER w1 as first_order_number,
nth_value(order_number, 2) OVER w1 as second_order_number,
nth_value(order_number, 3) OVER w1 as third_order_number,
nth_value(order_number, 4) OVER w1 as fourth_order_number,
nth_value(order_number, 5) OVER w1 as fifth_order_number,
first_value(total_order_value) OVER w1 as first_order_value,
nth_value(total_order_value, 2) OVER w1 as second_order_value
FROM (
	  
	  SELECT 
	  client, 
	  product_type,
	  customer_id,
	  order_number,
	  created_at, 
	  total_order_value
	  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_product_type`
	  WHERE product_type = top_order_product_type

)
WINDOW w1 as (PARTITION BY client, customer_id ORDER BY created_at asc)
2018-04-17 14:25:04,566: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ab56c18>]}
2018-04-17 14:25:04,805: 14:25:04 | 46 of 91 OK created table model agency_data_pipeline.order_paths_proc [CREATE TABLE in 4.25s]
2018-04-17 14:25:07,943: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10877c9b0>]}
2018-04-17 14:25:08,189: 14:25:08 | 47 of 91 OK created table model agency_data_pipeline.products_proc... [CREATE TABLE in 7.62s]
2018-04-17 14:25:34,683: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1052df6d8>]}
2018-04-17 14:25:36,510: 14:25:36 | 48 of 91 OK created table model agency_data_pipeline.customers_products_proc [CREATE TABLE in 34.35s]
2018-04-17 14:25:36,512: 14:25:36 | 49 of 91 START table model agency_data_pipeline.segment_proc_sku..... [RUN]
2018-04-17 14:25:36,512: 14:25:36 | 50 of 91 START table model agency_data_pipeline.order_paths_agg...... [RUN]
2018-04-17 14:25:36,513: Compiling model.agency_data_pipeline.segment_proc_sku
2018-04-17 14:25:36,513: Compiling model.agency_data_pipeline.order_paths_agg
2018-04-17 14:25:36,526: Writing injected SQL for node "model.agency_data_pipeline.order_paths_agg"
2018-04-17 14:25:36,529: Writing injected SQL for node "model.agency_data_pipeline.segment_proc_sku"
2018-04-17 14:25:36,533: Acquiring new bigquery connection "order_paths_agg".
2018-04-17 14:25:36,533: Acquiring new bigquery connection "segment_proc_sku".
2018-04-17 14:25:36,534: Re-using an available connection from the pool.
2018-04-17 14:25:36,536: Re-using an available connection from the pool.
2018-04-17 14:25:37,271: Model SQL (segment_proc_sku):
SELECT
client,
period,
sku, 
product_type,
date,
unique_customers,
orders,
quantity,
revenue,
case when orders > orders_90pct then 'Best Seller'
	when orders > orders_75pct then 'Good'
	when orders > orders_25pct then 'Average'
	else 'Poor' end as segment,
orders_90pct,
orders_75pct,
orders_25pct
FROM
(
	SELECT 
	client,
	period,
	sku, 
	product_type,
	date,
	unique_customers,
	orders,
	quantity,
	revenue,
	PERCENTILE_CONT(orders, 0.90) OVER w1 AS orders_90pct,
	PERCENTILE_CONT(orders, 0.75) OVER w1 AS orders_75pct,
	PERCENTILE_CONT(orders, 0.25) OVER w1 AS orders_25pct
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`products_proc`
	WINDOW w1 as (PARTITION BY client, period, date)
)
2018-04-17 14:25:37,331: Model SQL (order_paths_agg):
SELECT
client, 
first_product_type,
second_product_type,
first_purchase_date,
count(distinct(customer_id)) customer_count, 
count(distinct(second_order_number)) second_orders, 
count(distinct(third_order_number)) third_orders, 
count(distinct(fourth_order_number)) fourth_orders, 
count(distinct(fifth_order_number)) fifth_orders, 
sum(date_diff(second_purchase_date, first_purchase_date, DAY)) second_order_latency_days,
sum(date_diff(third_purchase_date, second_purchase_date, DAY)) third_order_latency_days,
sum(date_diff(fourth_purchase_date, third_purchase_date, DAY)) fourth_order_latency_days,
sum(date_diff(fifth_purchase_date, fourth_purchase_date, DAY)) fifth_order_latency_days,
sum(first_order_value) first_order_revenue,
sum(second_order_value) second_order_revenue
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`order_paths_proc`
where second_product_type is not null
GROUP BY client, first_product_type, second_product_type, first_purchase_date
2018-04-17 14:25:39,531: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1087997f0>]}
2018-04-17 14:25:39,569: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1052e3ba8>]}
2018-04-17 14:25:39,793: 14:25:39 | 49 of 91 OK created table model agency_data_pipeline.segment_proc_sku [CREATE TABLE in 3.02s]
2018-04-17 14:25:40,022: 14:25:40 | 50 of 91 OK created table model agency_data_pipeline.order_paths_agg. [CREATE TABLE in 3.06s]
2018-04-17 14:25:40,023: 14:25:40 | 51 of 91 START table model agency_data_pipeline.agg_ga_transaction... [RUN]
2018-04-17 14:25:40,023: Compiling model.agency_data_pipeline.agg_ga_transaction
2018-04-17 14:25:40,023: 14:25:40 | 52 of 91 START table model agency_data_pipeline.agg_transaction...... [RUN]
2018-04-17 14:25:40,029: Writing injected SQL for node "model.agency_data_pipeline.agg_ga_transaction"
2018-04-17 14:25:40,023: 14:25:40 | 53 of 91 START table model agency_data_pipeline.segment_stats_sku.... [RUN]
2018-04-17 14:25:40,023: 14:25:40 | 54 of 91 START table model agency_data_pipeline.segment_proc_customers_products [RUN]
2018-04-17 14:25:40,030: Compiling model.agency_data_pipeline.agg_transaction
2018-04-17 14:25:40,030: Compiling model.agency_data_pipeline.segment_stats_sku
2018-04-17 14:25:40,030: Compiling model.agency_data_pipeline.segment_proc_customers_products
2018-04-17 14:25:40,038: Writing injected SQL for node "model.agency_data_pipeline.agg_transaction"
2018-04-17 14:25:40,045: Writing injected SQL for node "model.agency_data_pipeline.segment_stats_sku"
2018-04-17 14:25:40,057: Acquiring new bigquery connection "agg_ga_transaction".
2018-04-17 14:25:40,057: Re-using an available connection from the pool.
2018-04-17 14:25:40,067: Acquiring new bigquery connection "segment_stats_sku".
2018-04-17 14:25:40,067: Re-using an available connection from the pool.
2018-04-17 14:25:40,079: Writing injected SQL for node "model.agency_data_pipeline.segment_proc_customers_products"
2018-04-17 14:25:40,086: Acquiring new bigquery connection "agg_transaction".
2018-04-17 14:25:40,090: Re-using an available connection from the pool.
2018-04-17 14:25:40,096: Acquiring new bigquery connection "segment_proc_customers_products".
2018-04-17 14:25:40,098: Re-using an available connection from the pool.
2018-04-17 14:25:40,773: Model SQL (segment_stats_sku):
WITH last_30 as (

	SELECT
	client,
	sku, 
	product_type,
	date,
	unique_customers as customers_30,
	orders as orders_30,
	revenue as revenue_30,
	segment as segment_30,
	0 as customers_90,
	0 as orders_90,
	0 as revenue_90,
	'' as segment_90,
	0 as customers_yoy_30,
	0 as orders_yoy_30,
	0 as revenue_yoy_30,
	'' as segment_yoy_30
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_sku`
	WHERE period = 'Last 30'

),

last_90 as (

	SELECT
	client,
	sku, 
	product_type,
	date,
	0 as customers_30,
	0 as orders_30,
	0 as revenue_30,
	'' as segment_30,
	unique_customers as customers_90,
	orders as orders_90,
	revenue as revenue_90,
	segment as segment_90,
	0 as customers_yoy_30,
	0 as orders_yoy_30,
	0 as revenue_yoy_30,
	'' as segment_yoy_30
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_sku`
	WHERE period = 'Last 90'

),

yoy_30 as (

	SELECT
	client,
	sku, 
	product_type,
	date,
	0 as customers_30,
	0 as orders_30,
	0 as revenue_30,
	'' as segment_30,
	0 as customers_90,
	0 as orders_90,
	0 as revenue_90,
	'' as segment_90,
	unique_customers as customers_yoy_30,
	orders as orders_yoy_30,
	revenue as revenue_yoy_30,
	segment as segment_yoy_30
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_sku`
	WHERE period = 'YoY 30'

)

SELECT
client,
sku, 
product_type,
date,
ifnull(sum(customers_30), 0) customers_30,
ifnull(sum(orders_30), 0) orders_30,
ifnull(sum(revenue_30), 0) revenue_30,
ifnull(max(segment_30), '') segment_30,
ifnull(sum(customers_90), 0) customers_90,
ifnull(sum(orders_90), 0) orders_90,
ifnull(sum(revenue_90), 0) revenue_90,
ifnull(max(segment_90), '') segment_90,
ifnull(sum(customers_yoy_30), 0) customers_yoy_30,
ifnull(sum(orders_yoy_30), 0) orders_yoy_30,
ifnull(sum(revenue_yoy_30), 0) revenue_yoy_30,
ifnull(max(segment_yoy_30), '') segment_yoy_30
FROM
(
	SELECT * FROM last_30
	UNION ALL
	SELECT * FROM last_90
	UNION ALL
	SELECT * FROM yoy_30

)
GROUP BY client, sku, product_type, date
2018-04-17 14:25:40,829: Model SQL (segment_proc_customers_products):
SELECT
client,
period,
date,
customer_id,
first_order_date,
first_order_unix_date,
product_type,
recency_days,
frequency,
revenue,
quantity,
aov,
case when frequency = 1 and recency_days <= 30 and first_order_unix_date >= window_start_unix_date then 'New'
	when frequency = 1 then 'One-time Purchaser'
	when frequency > frequency_90pct and recency_days < recency_90pct and aov > aov_50pct then 'Champion'
	when recency_days < recency_90pct and frequency > frequency_75pct then 'Potential Loyalists' 
	when frequency > frequency_75pct and recency_days <= recency_50pct then 'Cant Lose'
	when recency_days < recency_50pct and frequency > frequency_50pct then 'Loyal'
	when recency_days > recency_50pct and frequency > frequency_50pct then 'Frequent, not Recent'
	when recency_days < recency_50pct and frequency < frequency_50pct then 'Recent, not Frequent'
	else 'Unbucketed' end as segment,
aov_50pct,
frequency_90pct,
frequency_75pct,
frequency_50pct,
recency_90pct,
recency_75pct,
recency_50pct
FROM
(
	SELECT 
	a.client client,
	period,
	date,
	a.customer_id customer_id,
	a.product_type product_type,
	b.first_order_date first_order_date,
	b.first_order_unix_date first_order_unix_date,
	window_start_unix_date,
	window_end_unix_date,	
	recency_days,
	frequency,
	revenue,
	quantity,
	aov,
	PERCENTILE_CONT(aov, 0.50) OVER w1 AS aov_50pct,
	PERCENTILE_CONT(frequency, 0.90) OVER w1 AS frequency_90pct,
	PERCENTILE_CONT(frequency, 0.75) OVER w1 AS frequency_75pct,
	PERCENTILE_CONT(frequency, 0.90) OVER w1 AS frequency_50pct,
	PERCENTILE_CONT(recency_days, 0.10) OVER w1 AS recency_90pct,
	PERCENTILE_CONT(recency_days, 0.25) OVER w1 AS recency_75pct,
	PERCENTILE_CONT(recency_days, 0.5) OVER w1 AS recency_50pct
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`customers_products_proc` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`customers_first_purchase_product_type_proc` b
	ON (
		a.client = b.client and
		a.customer_id = b.customer_id and
		a.product_type = b.product_type
		)
	WINDOW w1 as (PARTITION BY a.client, period, date, a.product_type)
)
2018-04-17 14:25:40,892: Model SQL (agg_ga_transaction):
#done - lookup customer id from transaction id from orders
#done - tag an order as 'new' or 'existing' based on transaction id
#sum lifetime value of that customer id
#first order value for customer
#read from agg_ga_transaction into agg_ga_campaign instead of directly from ga_transactions and ga_mcf_stats


with ga as (

    select 
        date, 
        client, 
        'Last-touch' as attribution,
        channel, 
        platform, 
        url, 
        campaign, 
        transactionid,
        last_touch_transactions transactions, 
        last_touch_revenue + ifnull(last_touch_shipping, 0) + ifnull(last_touch_tax, 0) as revenue
    from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_transactions`

),

ga_mcf as (

    select 
        date, 
        client, 
        'First-touch' as attribution,
        channel, 
        platform, 
        '' as url,
        campaign, 
        transactionid, 
        first_touch_transactions as transactions,
        first_touch_revenue as revenue
    from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_mcf_stats`

)


SELECT
    date, 
    a.client client,
    attribution,
    transactionid,
    b.customer_id customer_id,
    b.order_type order_type,
    b.first_order_revenue first_order_revenue,
    b.lifetime_revenue lifetime_revenue,
    channel,
    platform,
    url,
    campaign,
    transactions,
    revenue
FROM (
    SELECT * FROM ga
    UNION ALL
    SELECT * FROM ga_mcf
) a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`customers_by_transaction` b
ON (
    a.client = b.client AND
    a.transactionid = b.order_number
)
2018-04-17 14:25:40,956: Model SQL (agg_transaction):
SELECT
client,
date,
customer_id,
order_number,
last_touch_channel,
last_touch_platform,
last_touch_url,
first_touch_channel, 
first_touch_platform, 
first_touch_utm_campaign,
ifnull( sum(last_touch_transactions), 0) last_touch_transactions, 
ifnull( sum(last_touch_revenue), 0) last_touch_revenue, 
ifnull( sum(first_touch_transactions), 0) first_touch_transactions, 
ifnull( sum(first_touch_revenue), 0) first_touch_revenue,
ifnull( sum(final_quantity), 0) quantity,
ifnull( sum(final_price), 0) revenue,
ifnull( sum(shipping_price), 0) shipping_revenue,
ROW_NUMBER() OVER (PARTITION BY client, customer_id, order_number ORDER BY date asc) AS order_sequence
FROM
(
	SELECT
	a.client,
	a.date date,
	b.date ga_date,
	a.customer_id,
	a.order_number,
	transactionid,
	b.last_touch_channel,
	b.last_touch_platform,
	b.last_touch_url,
	b.first_touch_channel, 
	b.first_touch_platform, 
	b.first_touch_utm_campaign, 
	last_touch_transactions, 
	last_touch_revenue, 
	first_touch_transactions, 
	first_touch_revenue,
	final_quantity,
	final_price,
	shipping_price
	FROM
	`growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_order_number` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`agg_ga_transaction_order_number` b
	ON (
		a.client = b.client and
		a.order_number = b.transactionid
	)

)
GROUP BY
client, 
date, 
customer_id,
order_number, 
last_touch_channel,
last_touch_platform,
last_touch_url,
first_touch_channel, 
first_touch_platform, 
first_touch_utm_campaign
2018-04-17 14:25:42,993: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109737fd0>]}
2018-04-17 14:25:43,237: 14:25:43 | 53 of 91 OK created table model agency_data_pipeline.segment_stats_sku [CREATE TABLE in 2.96s]
2018-04-17 14:25:46,611: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109737cf8>]}
2018-04-17 14:25:46,852: 14:25:46 | 52 of 91 OK created table model agency_data_pipeline.agg_transaction. [CREATE TABLE in 6.58s]
2018-04-17 14:25:47,960: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10973a470>]}
2018-04-17 14:25:48,204: 14:25:48 | 51 of 91 OK created table model agency_data_pipeline.agg_ga_transaction [CREATE TABLE in 7.94s]
2018-04-17 14:26:04,560: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109737d68>]}
2018-04-17 14:26:05,246: 14:26:05 | 54 of 91 OK created table model agency_data_pipeline.segment_proc_customers_products [CREATE TABLE in 24.53s]
2018-04-17 14:26:05,247: 14:26:05 | 55 of 91 START table model agency_data_pipeline.customers_first_purchase_proc [RUN]
2018-04-17 14:26:05,248: 14:26:05 | 56 of 91 START table model agency_data_pipeline.agg_transaction_daily [RUN]
2018-04-17 14:26:05,248: 14:26:05 | 57 of 91 START table model agency_data_pipeline.segment_stats_customers_products_agg [RUN]
2018-04-17 14:26:05,248: 14:26:05 | 58 of 91 START table model agency_data_pipeline.segment_stats_category [RUN]
2018-04-17 14:26:05,248: Compiling model.agency_data_pipeline.customers_first_purchase_proc
2018-04-17 14:26:05,249: Compiling model.agency_data_pipeline.agg_transaction_daily
2018-04-17 14:26:05,249: Compiling model.agency_data_pipeline.segment_stats_customers_products_agg
2018-04-17 14:26:05,249: Compiling model.agency_data_pipeline.segment_stats_category
2018-04-17 14:26:05,258: Writing injected SQL for node "model.agency_data_pipeline.customers_first_purchase_proc"
2018-04-17 14:26:05,272: Writing injected SQL for node "model.agency_data_pipeline.agg_transaction_daily"
2018-04-17 14:26:05,277: Writing injected SQL for node "model.agency_data_pipeline.segment_stats_category"
2018-04-17 14:26:05,278: Writing injected SQL for node "model.agency_data_pipeline.segment_stats_customers_products_agg"
2018-04-17 14:26:05,282: Acquiring new bigquery connection "segment_stats_category".
2018-04-17 14:26:05,282: Re-using an available connection from the pool.
2018-04-17 14:26:05,284: Acquiring new bigquery connection "agg_transaction_daily".
2018-04-17 14:26:05,285: Acquiring new bigquery connection "segment_stats_customers_products_agg".
2018-04-17 14:26:05,286: Re-using an available connection from the pool.
2018-04-17 14:26:05,286: Acquiring new bigquery connection "customers_first_purchase_proc".
2018-04-17 14:26:05,287: Re-using an available connection from the pool.
2018-04-17 14:26:05,288: Re-using an available connection from the pool.
2018-04-17 14:26:08,184: Model SQL (segment_stats_category):
SELECT
client,
product_type,
date,
segment_30,
segment_90,
segment_yoy_30,
ifnull(sum(customers_30), 0) customers_30,
ifnull(sum(orders_30), 0) orders_30,
ifnull(sum(revenue_30), 0) revenue_30,
ifnull(sum(customers_90), 0) customers_90,
ifnull(sum(orders_90), 0) orders_90,
ifnull(sum(revenue_90), 0) revenue_90,
ifnull(sum(customers_yoy_30), 0) customers_yoy_30,
ifnull(sum(orders_yoy_30), 0) orders_yoy_30,
ifnull(sum(revenue_yoy_30), 0) revenue_yoy_30
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`segment_stats_sku`
GROUP BY client, product_type, date, segment_30, segment_90, segment_yoy_30
2018-04-17 14:26:08,186: Model SQL (agg_transaction_daily):
SELECT
client,
date,
customer_id,
sum(last_touch_transactions) last_touch_transactions, 
sum(last_touch_revenue) last_touch_revenue, 
sum(first_touch_transactions) first_touch_transactions, 
sum(first_touch_revenue) first_touch_revenue,
sum(quantity) quantity,
sum(revenue) revenue,
count(distinct(order_number)) order_count
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction`
GROUP BY
client, 
date, 
customer_id
2018-04-17 14:26:08,186: Model SQL (segment_stats_customers_products_agg):
WITH ty as (

	SELECT
	client,
	date,
	customer_id,
	product_type,
	segment as segment_365,
	recency_days as recency_365,
	frequency as frequency_365,
	revenue as revenue_365,
	aov as aov_365,
	'' as segment_mom,
	0 as recency_mom,
	0 as frequency_mom,
	0 as revenue_mom,
	0 as aov_mom,
	'' as segment_yoy,
	0 as recency_yoy,
	0 as frequency_yoy,
	0 as revenue_yoy,
	0 as aov_yoy
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers_products`
	WHERE period = 'Rolling 365'

),

last_month as (

	SELECT
	client,
	date,
	customer_id,
	product_type,
	'' as segment_365,
	0 as recency_365,
	0 as frequency_365,
	0 as revenue_365,
	0 as aov_365,
	segment as segment_mom,
	recency_days as recency_mom,
	frequency as frequency_mom,
	revenue as revenue_mom,
	aov as aov_mom,
	'' as segment_yoy,
	0 as recency_yoy,
	0 as frequency_yoy,
	0 as revenue_yoy,
	0 as aov_yoy
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers_products`
	WHERE period = 'Rolling 365 (t-1mo)'

),

this_month_1yr as (

	SELECT
	client,
	date,
	customer_id,
	product_type,
	'' as segment_365,
	0 as recency_365,
	0 as frequency_365,
	0 as revenue_365,
	0 as aov_365,
	'' as segment_mom,
	0 as recency_mom,
	0 as frequency_mom,
	0 as revenue_mom,
	0 as aov_mom,
	segment as segment_yoy,
	recency_days as recency_yoy,
	frequency as frequency_yoy,
	revenue as revenue_yoy,
	aov as aov_yoy
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers_products`
	WHERE period = 'Rolling 365 (t-1yr)'


)

SELECT
client,
date, 
customer_id,
product_type,
ifnull(max(segment_365), '') segment_365,
ifnull(max(segment_mom), '') segment_mom,
ifnull(max(segment_yoy), '') segment_yoy,
ifnull(sum(recency_365), 0) recency_365,
ifnull(sum(frequency_365), 0) frequency_365,
ifnull(sum(revenue_365), 0) revenue_365,
ifnull(sum(aov_365), 0) aov_365,
ifnull(sum(recency_mom), 0) recency_mom,
ifnull(sum(frequency_mom), 0) frequency_mom,
ifnull(sum(revenue_mom), 0) revenue_mom,
ifnull(sum(aov_mom), 0) aov_mom,	
ifnull(sum(recency_yoy), 0) recency_yoy,
ifnull(sum(frequency_yoy), 0) frequency_yoy,
ifnull(sum(revenue_yoy), 0) revenue_yoy,
ifnull(sum(aov_yoy), 0) aov_yoy
FROM
(
	SELECT * FROM ty
	UNION ALL
	SELECT * FROM last_month
	UNION ALL
	SELECT * FROM this_month_1yr

)
GROUP BY client, date, customer_id, product_type
2018-04-17 14:26:08,187: Model SQL (customers_first_purchase_proc):
SELECT 
client, 
customer_id, 
min(cast(date as date)) first_order_date,
unix_date( min(cast(date as date))) first_order_unix_date
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction`
GROUP BY client, customer_id
2018-04-17 14:26:09,716: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ab566a0>]}
2018-04-17 14:26:09,952: 14:26:09 | 58 of 91 OK created table model agency_data_pipeline.segment_stats_category [CREATE TABLE in 4.47s]
2018-04-17 14:26:09,952: 14:26:09 | 59 of 91 START table model agency_data_pipeline.order_paths_stats.... [RUN]
2018-04-17 14:26:09,953: Compiling model.agency_data_pipeline.order_paths_stats
2018-04-17 14:26:09,965: Writing injected SQL for node "model.agency_data_pipeline.order_paths_stats"
2018-04-17 14:26:09,966: Acquiring new bigquery connection "order_paths_stats".
2018-04-17 14:26:09,966: Re-using an available connection from the pool.
2018-04-17 14:26:10,971: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1052dfe48>]}
2018-04-17 14:26:11,235: 14:26:11 | 55 of 91 OK created table model agency_data_pipeline.customers_first_purchase_proc [CREATE TABLE in 5.72s]
2018-04-17 14:26:11,236: 14:26:11 | 60 of 91 START table model agency_data_pipeline.agg_ga_campaign_by_type [RUN]
2018-04-17 14:26:11,236: Compiling model.agency_data_pipeline.agg_ga_campaign_by_type
2018-04-17 14:26:11,247: Writing injected SQL for node "model.agency_data_pipeline.agg_ga_campaign_by_type"
2018-04-17 14:26:11,250: Acquiring new bigquery connection "agg_ga_campaign_by_type".
2018-04-17 14:26:11,251: Re-using an available connection from the pool.
2018-04-17 14:26:12,225: Model SQL (order_paths_stats):
WITH transactions AS (
  SELECT 
  client, 
  first_product_type,
  second_product_type,
  first_purchase_date,
  customer_count,
  second_orders,
  third_orders,
  fourth_orders,
  fifth_orders,
  second_order_latency_days,
  third_order_latency_days,
  fourth_order_latency_days,
  fifth_order_latency_days,
  first_order_revenue,
  second_order_revenue,
  unix_date(cast(first_purchase_date as date)) d
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`order_paths_agg`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)

SELECT 
client,
'Rolling 365' as period,
first_product_type,
second_product_type,
date_in_range date,
unix_date_in_range, 
sum(customer_count) customer_count,
sum(second_orders) second_orders,
sum(third_orders) third_orders,
sum(fourth_orders) fourth_orders,
sum(fifth_orders) fifth_orders,
sum(second_order_latency_days) second_order_latency_days,
sum(third_order_latency_days) third_order_latency_days,
sum(fourth_order_latency_days) fourth_order_latency_days,
sum(fifth_order_latency_days) fifth_order_latency_days,
sum(first_order_revenue) first_order_revenue,
sum(second_order_revenue) second_order_revenue
FROM daterange
JOIN transactions
ON transactions.d > ( daterange.unix_date_in_range - 365 )
AND transactions.d <= daterange.unix_date_in_range
group by client, first_product_type, second_product_type, date_in_range, unix_date_in_range
2018-04-17 14:26:12,996: Model SQL (agg_ga_campaign_by_type):
with orders_new as (
    select 
    date, 
    client, 
    attribution,
    channel, 
    platform, 
    url, 
    campaign,
    count(distinct(customer_id)) customers_new,
    sum(transactions) transactions_new,
    sum(revenue) revenue_new,
    sum(first_order_revenue) first_order_revenue_new,
    sum(lifetime_revenue) lifetime_revenue_new,
    null as customers_total,
    null as transactions_total,
    null as revenue_total
    from `growth-engines-pipeline`.`agency_data_pipeline`.`agg_ga_transaction`
    where order_type = 'New'
    group by date, client, attribution, channel, platform, url, campaign
),
    
orders_total as (
    select 
    date, 
    client, 
    attribution,
    channel, 
    platform, 
    url, 
    campaign,
    null as customers_new,
    null as transactions_new,
    null as revenue_new,
    null as first_order_revenue_new,
    null as lifetime_revenue_new,
    count(distinct(customer_id)) customers_total,
    sum(transactions) transactions_total,
    sum(revenue) revenue_total
    from `growth-engines-pipeline`.`agency_data_pipeline`.`agg_ga_transaction`
    group by date, client, attribution, channel, platform, url, campaign

)

SELECT 
date, 
client, 
attribution,
channel, 
platform, 
url, 
campaign,
sum(customers_new) customers_new,
sum(transactions_new) transactions_new,
sum(revenue_new) revenue_new,
sum(first_order_revenue_new) first_order_revenue_new,
sum(lifetime_revenue_new) lifetime_revenue_new,
sum(customers_total) customers_total,
sum(transactions_total) transactions_total,
sum(revenue_total) revenue_total
from
    ( 
        SELECT * FROM orders_new
        UNION ALL 
        SELECT * FROM orders_total
    )
group by date, client, attribution, channel, platform, url, campaign
2018-04-17 14:26:14,469: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109728940>]}
2018-04-17 14:26:14,717: 14:26:14 | 59 of 91 OK created table model agency_data_pipeline.order_paths_stats [CREATE TABLE in 4.52s]
2018-04-17 14:26:15,831: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10871f710>]}
2018-04-17 14:26:16,127: 14:26:16 | 56 of 91 OK created table model agency_data_pipeline.agg_transaction_daily [CREATE TABLE in 10.58s]
2018-04-17 14:26:19,676: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1087f4a20>]}
2018-04-17 14:26:19,942: 14:26:19 | 60 of 91 OK created table model agency_data_pipeline.agg_ga_campaign_by_type [CREATE TABLE in 8.44s]
2018-04-17 14:26:35,936: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1052cfb00>]}
2018-04-17 14:26:36,203: 14:26:36 | 57 of 91 OK created table model agency_data_pipeline.segment_stats_customers_products_agg [CREATE TABLE in 30.69s]
2018-04-17 14:26:36,205: 14:26:36 | 61 of 91 START table model agency_data_pipeline.growth_customer_0_365 [RUN]
2018-04-17 14:26:36,206: 14:26:36 | 62 of 91 START table model agency_data_pipeline.customers_proc....... [RUN]
2018-04-17 14:26:36,206: Compiling model.agency_data_pipeline.growth_customer_0_365
2018-04-17 14:26:36,206: 14:26:36 | 63 of 91 START table model agency_data_pipeline.segment_stats_customers_products [RUN]
2018-04-17 14:26:36,207: Compiling model.agency_data_pipeline.customers_proc
2018-04-17 14:26:36,213: Compiling model.agency_data_pipeline.segment_stats_customers_products
2018-04-17 14:26:36,221: Writing injected SQL for node "model.agency_data_pipeline.growth_customer_0_365"
2018-04-17 14:26:36,228: Writing injected SQL for node "model.agency_data_pipeline.customers_proc"
2018-04-17 14:26:36,233: Writing injected SQL for node "model.agency_data_pipeline.segment_stats_customers_products"
2018-04-17 14:26:36,236: Acquiring new bigquery connection "customers_proc".
2018-04-17 14:26:36,236: Re-using an available connection from the pool.
2018-04-17 14:26:36,238: Acquiring new bigquery connection "growth_customer_0_365".
2018-04-17 14:26:36,238: Re-using an available connection from the pool.
2018-04-17 14:26:36,240: Acquiring new bigquery connection "segment_stats_customers_products".
2018-04-17 14:26:36,240: Re-using an available connection from the pool.
2018-04-17 14:26:37,047: Model SQL (growth_customer_0_365):
WITH transactions AS (
  SELECT 
  client, 
  customer_id, 
  order_number,
  unix_date(cast(date as date)) d, 
  quantity,
  revenue,
  shipping_revenue
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)

SELECT 
date_in_range date,
unix_date_in_range, 
unix_date_in_range_yoy, 
client, 
customer_id,
count(distinct(order_number)) orders,
sum(quantity) quantity,
sum(revenue) revenue,
sum(shipping_revenue) shipping_revenue
FROM daterange
JOIN transactions
ON transactions.d >= ( daterange.unix_date_in_range - 365 ) 
AND transactions.d <= daterange.unix_date_in_range
GROUP BY date, unix_date_in_range, unix_date_in_range_yoy, client, customer_id
2018-04-17 14:26:37,122: Model SQL (segment_stats_customers_products):
SELECT
client,
date,
product_type,
segment_365,
segment_mom,
segment_yoy,
count(distinct(customer_id)) customers,
avg(recency_365) recency_365,
sum(frequency_365) frequency_365,
sum(revenue_365) revenue_365,
case when sum(frequency_365) > 0 then sum(revenue_365)/sum(frequency_365) else null end as aov_365,
avg(recency_mom) recency_mom,
sum(frequency_mom) frequency_mom,
sum(revenue_mom) revenue_mom,
case when sum(frequency_mom) > 0 then sum(revenue_mom)/sum(frequency_mom) else null end as aov_mom,
avg(recency_yoy) recency_yoy,
sum(frequency_yoy) frequency_yoy,
sum(revenue_yoy) revenue_yoy,
case when sum(frequency_yoy) > 0 then sum(revenue_yoy)/sum(frequency_yoy) else null end as aov_yoy
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_stats_customers_products_agg`
GROUP BY client, date, product_type, segment_365, segment_mom, segment_yoy
2018-04-17 14:26:37,150: Model SQL (customers_proc):
WITH customers AS (
  SELECT 
  client, 
  customer_id, 
  order_number,
  cast(date as date) order_date,
  unix_date(cast(date as date)) unix_order_date, 
  quantity,
  revenue 
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)
 
SELECT 
client,
period,
customer_id,
date,
window_end_unix_date,
window_end_unix_date - 365 as window_start_unix_date,
window_end_unix_date - unix_date(recent_order) recency_days,
frequency,
quantity,
revenue,
case when frequency > 0 then revenue/frequency else 0 end as aov
FROM 
(  

  SELECT 
  client,
  'Rolling 365' as period,
  customer_id,
  date_in_range date,
  unix_date_in_range,
  unix_date_in_range window_end_unix_date,
  max(order_date) recent_order,
  sum(quantity) as quantity,
  sum(revenue) as revenue,
  count(distinct(order_number)) as frequency
  FROM daterange
  JOIN customers
  ON customers.unix_order_date > ( daterange.unix_date_in_range - 365 )
  AND customers.unix_order_date <= daterange.unix_date_in_range
  GROUP BY client, customer_id, date, unix_date_in_range

  UNION ALL

  SELECT 
  client,
  'Rolling 365 (t-1mo)' as period,
  customer_id,
  date_in_range date,
  unix_date_in_range,
  unix_date_in_range - 30 window_end_unix_date, 
  max(order_date) recent_order,
  sum(quantity) as quantity,
  sum(revenue) as revenue,
  count(distinct(order_number)) as frequency
  FROM daterange
  JOIN customers
  ON customers.unix_order_date > ( daterange.unix_date_in_range - 395 )
  AND customers.unix_order_date <= ( daterange.unix_date_in_range - 30 )
  GROUP BY client, customer_id, date, unix_date_in_range

  UNION ALL

  SELECT 
  client,
  'Rolling 365 (t-1yr)' as period,
  customer_id,
  date_in_range date,
  unix_date_in_range, 
  unix_date_in_range - 365 window_end_unix_date, 
  max(order_date) recent_order,
  sum(quantity) as quantity,
  sum(revenue) as revenue,
  count(distinct(order_number)) as frequency
  FROM daterange
  JOIN customers
  ON customers.unix_order_date > ( daterange.unix_date_in_range - 730 )
  AND customers.unix_order_date <= ( daterange.unix_date_in_range - 365 )
  GROUP BY client, customer_id, date, unix_date_in_range

)
2018-04-17 14:26:50,579: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10871f0f0>]}
2018-04-17 14:26:50,822: 14:26:50 | 63 of 91 OK created table model agency_data_pipeline.segment_stats_customers_products [CREATE TABLE in 14.37s]
2018-04-17 14:26:54,808: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ab4cc18>]}
2018-04-17 14:26:55,081: 14:26:55 | 61 of 91 OK created table model agency_data_pipeline.growth_customer_0_365 [CREATE TABLE in 18.60s]
2018-04-17 14:27:05,167: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108799208>]}
2018-04-17 14:27:05,914: 14:27:05 | 62 of 91 OK created table model agency_data_pipeline.customers_proc.. [CREATE TABLE in 28.96s]
2018-04-17 14:27:05,915: 14:27:05 | 64 of 91 START table model agency_data_pipeline.retention_0_365...... [RUN]
2018-04-17 14:27:05,916: Compiling model.agency_data_pipeline.retention_0_365
2018-04-17 14:27:05,926: Writing injected SQL for node "model.agency_data_pipeline.retention_0_365"
2018-04-17 14:27:05,915: 14:27:05 | 65 of 91 START table model agency_data_pipeline.retention_30_60...... [RUN]
2018-04-17 14:27:05,926: Compiling model.agency_data_pipeline.retention_30_60
2018-04-17 14:27:05,915: 14:27:05 | 66 of 91 START table model agency_data_pipeline.retention_730_plus... [RUN]
2018-04-17 14:27:05,934: Writing injected SQL for node "model.agency_data_pipeline.retention_30_60"
2018-04-17 14:27:05,934: Compiling model.agency_data_pipeline.retention_730_plus
2018-04-17 14:27:05,916: 14:27:05 | 67 of 91 START table model agency_data_pipeline.retention_0_30....... [RUN]
2018-04-17 14:27:05,944: Writing injected SQL for node "model.agency_data_pipeline.retention_730_plus"
2018-04-17 14:27:05,945: Acquiring new bigquery connection "retention_30_60".
2018-04-17 14:27:05,945: Compiling model.agency_data_pipeline.retention_0_30
2018-04-17 14:27:05,947: Acquiring new bigquery connection "retention_730_plus".
2018-04-17 14:27:05,947: Re-using an available connection from the pool.
2018-04-17 14:27:05,954: Acquiring new bigquery connection "retention_0_365".
2018-04-17 14:27:05,956: Writing injected SQL for node "model.agency_data_pipeline.retention_0_30"
2018-04-17 14:27:05,958: Re-using an available connection from the pool.
2018-04-17 14:27:05,964: Re-using an available connection from the pool.
2018-04-17 14:27:05,969: Acquiring new bigquery connection "retention_0_30".
2018-04-17 14:27:05,969: Re-using an available connection from the pool.
2018-04-17 14:27:06,918: Model SQL (retention_30_60):
WITH transactions AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_daily`
),

daterange AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`  	
),

temp AS (
  SELECT 
  client, 
  customer_id, 
  unix_date(date) d, 
  quantity,
  revenue,
  order_count
  FROM transactions
)

SELECT 
date_in_range date, 
unix_date_in_range,
client, 
customer_id,
sum(quantity) quantity,
sum(revenue) revenue,
sum(order_count) order_count
FROM daterange
JOIN temp
ON ( temp.d >= ( daterange.unix_date_in_range_bom_mom ) 
AND temp.d < ( daterange.unix_date_in_range_bom ) )
group by date_in_range, unix_date_in_range, client, customer_id
2018-04-17 14:27:06,961: Model SQL (retention_0_365):
WITH transactions AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_daily`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
),

temp AS (
  SELECT 
  client, 
  customer_id, 
  unix_date(date) d, 
  quantity,
  revenue,
  order_count
  FROM transactions
)

SELECT 
date_in_range date,
unix_date_in_range, 
client, 
customer_id,
sum(quantity) quantity,
sum(revenue) revenue,
sum(order_count) order_count
FROM daterange
JOIN temp
ON temp.d >= ( daterange.unix_date_in_range - 365 ) 
AND temp.d <= daterange.unix_date_in_range
group by date_in_range, unix_date_in_range, client, customer_id
2018-04-17 14:27:06,968: Model SQL (retention_0_30):
WITH transactions AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_daily`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
),

temp AS (
  SELECT 
  client, 
  customer_id, 
  unix_date(date) d, 
  quantity,
  revenue,
  order_count
  FROM transactions
)

SELECT 
date_in_range date,
unix_date_in_range, 
client, 
customer_id,
sum(quantity) quantity,
sum(revenue) revenue,
sum(order_count) order_count
FROM daterange
JOIN temp
ON temp.d >= ( daterange.unix_date_in_range_bom ) 
AND temp.d <= daterange.unix_date_in_range
group by date_in_range, unix_date_in_range, client, customer_id
2018-04-17 14:27:07,104: Model SQL (retention_730_plus):
WITH transactions AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_daily`
),

daterange AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`  	
),

temp AS (
  SELECT 
  client, 
  customer_id, 
  unix_date(date) d, 
  quantity,
  revenue,
  order_count
  FROM transactions
)

SELECT 
date_in_range date, 
unix_date_in_range,
client, 
customer_id,
sum(quantity) quantity,
sum(revenue) revenue,
sum(order_count) order_count
FROM daterange
JOIN temp
ON temp.d <= ( daterange.unix_date_in_range - 730 ) 
group by date_in_range, unix_date_in_range, client, customer_id
2018-04-17 14:27:09,461: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105324e48>]}
2018-04-17 14:27:09,770: 14:27:09 | 66 of 91 OK created table model agency_data_pipeline.retention_730_plus [CREATE TABLE in 3.53s]
2018-04-17 14:27:09,771: 14:27:09 | 68 of 91 START table model agency_data_pipeline.segment_list_customers_products [RUN]
2018-04-17 14:27:09,771: Compiling model.agency_data_pipeline.segment_list_customers_products
2018-04-17 14:27:09,781: Writing injected SQL for node "model.agency_data_pipeline.segment_list_customers_products"
2018-04-17 14:27:09,783: Acquiring new bigquery connection "segment_list_customers_products".
2018-04-17 14:27:09,783: Re-using an available connection from the pool.
2018-04-17 14:27:10,456: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105318a58>]}
2018-04-17 14:27:10,581: Model SQL (segment_list_customers_products):
SELECT
a.client,
period,
date,
customer_id,
product_type,
b.first_name,
b.last_name,
b.email,
recency_days,
frequency,
revenue,
quantity,
aov,
segment
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers_products` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`agg_customers_union` b
ON (
	a.client = b.client AND
	a.customer_id = b.id
)
2018-04-17 14:27:10,776: 14:27:10 | 67 of 91 OK created table model agency_data_pipeline.retention_0_30.. [CREATE TABLE in 4.51s]
2018-04-17 14:27:10,776: 14:27:10 | 69 of 91 START table model agency_data_pipeline.retention_365_730.... [RUN]
2018-04-17 14:27:10,777: Compiling model.agency_data_pipeline.retention_365_730
2018-04-17 14:27:10,784: Writing injected SQL for node "model.agency_data_pipeline.retention_365_730"
2018-04-17 14:27:10,785: Acquiring new bigquery connection "retention_365_730".
2018-04-17 14:27:10,785: Re-using an available connection from the pool.
2018-04-17 14:27:11,441: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1052c87f0>]}
2018-04-17 14:27:11,563: Model SQL (retention_365_730):
WITH transactions AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_daily`
),

daterange AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`  	
),

temp AS (
  SELECT 
  client, 
  customer_id, 
  unix_date(date) d, 
  quantity,
  revenue,
  order_count
  FROM transactions
)

SELECT 
date_in_range date, 
unix_date_in_range,
client, 
customer_id,
sum(quantity) quantity,
sum(revenue) revenue,
sum(order_count) order_count
FROM daterange
JOIN temp
ON ( temp.d >= ( daterange.unix_date_in_range - 730 ) 
AND temp.d < ( daterange.unix_date_in_range - 365 ) )
group by date_in_range, unix_date_in_range, client, customer_id
2018-04-17 14:27:11,769: 14:27:11 | 65 of 91 OK created table model agency_data_pipeline.retention_30_60. [CREATE TABLE in 5.51s]
2018-04-17 14:27:11,770: 14:27:11 | 70 of 91 START table model agency_data_pipeline.retention_60_plus.... [RUN]
2018-04-17 14:27:11,770: Compiling model.agency_data_pipeline.retention_60_plus
2018-04-17 14:27:11,779: Writing injected SQL for node "model.agency_data_pipeline.retention_60_plus"
2018-04-17 14:27:11,780: Acquiring new bigquery connection "retention_60_plus".
2018-04-17 14:27:11,780: Re-using an available connection from the pool.
2018-04-17 14:27:12,487: Model SQL (retention_60_plus):
WITH transactions AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_daily`
),

daterange AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`  	
),

temp AS (
  SELECT 
  client, 
  customer_id, 
  unix_date(date) d, 
  quantity,
  revenue,
  order_count
  FROM transactions
)

SELECT 
date_in_range date, 
unix_date_in_range,
client, 
customer_id,
sum(quantity) quantity,
sum(revenue) revenue,
sum(order_count) order_count
FROM daterange
JOIN temp
ON temp.d < ( daterange.unix_date_in_range_bom_mom ) 
group by date_in_range, unix_date_in_range, client, customer_id
2018-04-17 14:27:16,030: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10871f710>]}
2018-04-17 14:27:16,270: 14:27:16 | 69 of 91 OK created table model agency_data_pipeline.retention_365_730 [CREATE TABLE in 5.25s]
2018-04-17 14:27:18,239: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ab4d5c0>]}
2018-04-17 14:27:18,605: 14:27:18 | 64 of 91 OK created table model agency_data_pipeline.retention_0_365. [CREATE TABLE in 12.32s]
2018-04-17 14:27:23,756: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10972e7b8>]}
2018-04-17 14:27:24,007: 14:27:24 | 70 of 91 OK created table model agency_data_pipeline.retention_60_plus [CREATE TABLE in 11.99s]
2018-04-17 14:27:54,085: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105324e48>]}
2018-04-17 14:27:54,350: 14:27:54 | 68 of 91 OK created table model agency_data_pipeline.segment_list_customers_products [CREATE TABLE in 44.31s]
2018-04-17 14:27:54,353: 14:27:54 | 71 of 91 START table model agency_data_pipeline.agg_platforms_union.. [RUN]
2018-04-17 14:27:54,353: 14:27:54 | 72 of 91 START table model agency_data_pipeline.segment_proc_customers [RUN]
2018-04-17 14:27:54,353: Compiling model.agency_data_pipeline.agg_platforms_union
2018-04-17 14:27:54,354: Compiling model.agency_data_pipeline.segment_proc_customers
2018-04-17 14:27:54,366: Writing injected SQL for node "model.agency_data_pipeline.segment_proc_customers"
2018-04-17 14:27:54,371: Writing injected SQL for node "model.agency_data_pipeline.agg_platforms_union"
2018-04-17 14:27:54,375: Acquiring new bigquery connection "segment_proc_customers".
2018-04-17 14:27:54,375: Re-using an available connection from the pool.
2018-04-17 14:27:54,376: Acquiring new bigquery connection "agg_platforms_union".
2018-04-17 14:27:54,376: Re-using an available connection from the pool.
2018-04-17 14:27:55,291: Model SQL (agg_platforms_union):
SELECT 
date, 
account, 
channel,
platform,
url,
utm_campaign,
campaign,
cost,
impressions,
clicks,
transactions
FROM 
`growth-engines-pipeline`.`agency_data_pipeline`.`adwords_stats`

UNION ALL

SELECT 
date, 
account, 
channel,
platform,
url,
utm_campaign,
campaign,
cost,
impressions,
clicks,
transactions
FROM 
`growth-engines-pipeline`.`agency_data_pipeline`.`bing_ads_stats`

UNION ALL  

SELECT 
date, 
account, 
channel,
platform,
url,
utm_campaign,
campaign,
cost,
impressions,
clicks,
transactions
FROM 
`growth-engines-pipeline`.`agency_data_pipeline`.`fb_ads_stats`
2018-04-17 14:27:55,291: Model SQL (segment_proc_customers):
SELECT
client,
period,
date,
customer_id,
first_order_date,
first_order_unix_date,
recency_days,
frequency,
revenue,
quantity,
aov,
case when frequency = 1 and recency_days <= 30 and first_order_unix_date >= window_start_unix_date then 'New'
	when frequency = 1 then 'One-time Purchaser'
	when frequency > frequency_90pct and recency_days < recency_90pct and aov > aov_50pct then 'Champion'
	when recency_days < recency_90pct and frequency > frequency_75pct then 'Potential Loyalists' 
	when frequency > frequency_75pct and recency_days <= recency_50pct then 'Cant Lose'
	when recency_days < recency_50pct and frequency > frequency_50pct then 'Loyal'
	when recency_days > recency_50pct and frequency > frequency_50pct then 'Frequent, not Recent'
	when recency_days < recency_50pct and frequency < frequency_50pct then 'Recent, not Frequent'
	else 'Unbucketed' end as segment,
aov_50pct,
frequency_90pct,
frequency_75pct,
frequency_50pct,
recency_90pct,
recency_75pct,
recency_50pct
FROM
(
	SELECT 
	a.client client,
	period,
	date,
	a.customer_id customer_id,
	b.first_order_date first_order_date,
	b.first_order_unix_date first_order_unix_date,
	window_start_unix_date,
	window_end_unix_date,
	recency_days,
	frequency,
	revenue,
	quantity,
	aov,
	PERCENTILE_CONT(aov, 0.50) OVER w1 AS aov_50pct,
	PERCENTILE_CONT(frequency, 0.90) OVER w1 AS frequency_90pct,
	PERCENTILE_CONT(frequency, 0.75) OVER w1 AS frequency_75pct,
	PERCENTILE_CONT(frequency, 0.90) OVER w1 AS frequency_50pct,
	PERCENTILE_CONT(recency_days, 0.10) OVER w1 AS recency_90pct,
	PERCENTILE_CONT(recency_days, 0.25) OVER w1 AS recency_75pct,
	PERCENTILE_CONT(recency_days, 0.5) OVER w1 AS recency_50pct
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`customers_proc` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`customers_first_purchase_proc` b
	ON (
		a.client = b.client and
		a.customer_id = b.customer_id
		)
	WINDOW w1 as (PARTITION BY a.client, period, date)
)
2018-04-17 14:27:59,791: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1087f4a20>]}
2018-04-17 14:28:00,012: 14:28:00 | 71 of 91 OK created table model agency_data_pipeline.agg_platforms_union [CREATE TABLE in 5.44s]
2018-04-17 14:28:22,599: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1052dfb38>]}
2018-04-17 14:28:23,341: 14:28:23 | 72 of 91 OK created table model agency_data_pipeline.segment_proc_customers [CREATE TABLE in 28.25s]
2018-04-17 14:28:23,344: 14:28:23 | 73 of 91 START table model agency_data_pipeline.retention_0_30_rebuy. [RUN]
2018-04-17 14:28:23,345: 14:28:23 | 74 of 91 START table model agency_data_pipeline.segment_stats_customers_agg [RUN]
2018-04-17 14:28:23,345: Compiling model.agency_data_pipeline.retention_0_30_rebuy
2018-04-17 14:28:23,345: 14:28:23 | 75 of 91 START table model agency_data_pipeline.retention_0_365_rebuy [RUN]
2018-04-17 14:28:23,345: Compiling model.agency_data_pipeline.segment_stats_customers_agg
2018-04-17 14:28:23,359: Compiling model.agency_data_pipeline.retention_0_365_rebuy
2018-04-17 14:28:23,359: Writing injected SQL for node "model.agency_data_pipeline.retention_0_30_rebuy"
2018-04-17 14:28:23,374: Writing injected SQL for node "model.agency_data_pipeline.segment_stats_customers_agg"
2018-04-17 14:28:23,376: Writing injected SQL for node "model.agency_data_pipeline.retention_0_365_rebuy"
2018-04-17 14:28:23,380: Acquiring new bigquery connection "segment_stats_customers_agg".
2018-04-17 14:28:23,381: Re-using an available connection from the pool.
2018-04-17 14:28:23,381: Acquiring new bigquery connection "retention_0_365_rebuy".
2018-04-17 14:28:23,382: Acquiring new bigquery connection "retention_0_30_rebuy".
2018-04-17 14:28:23,384: Re-using an available connection from the pool.
2018-04-17 14:28:23,391: Re-using an available connection from the pool.
2018-04-17 14:28:24,345: Model SQL (segment_stats_customers_agg):
WITH ty as (

	SELECT
	client,
	date,
	customer_id,
	segment as segment_365,
	recency_days as recency_365,
	frequency as frequency_365,
	revenue as revenue_365,
	aov as aov_365,
	'' as segment_mom,
	0 as recency_mom,
	0 as frequency_mom,
	0 as revenue_mom,
	0 as aov_mom,
	'' as segment_yoy,
	0 as recency_yoy,
	0 as frequency_yoy,
	0 as revenue_yoy,
	0 as aov_yoy
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers`
	WHERE period = 'Rolling 365'

),

last_month as (

	SELECT
	client,
	date,
	customer_id,
	'' as segment_365,
	0 as recency_365,
	0 as frequency_365,
	0 as revenue_365,
	0 as aov_365,
	segment as segment_mom,
	recency_days as recency_mom,
	frequency as frequency_mom,
	revenue as revenue_mom,
	aov as aov_mom,
	'' as segment_yoy,
	0 as recency_yoy,
	0 as frequency_yoy,
	0 as revenue_yoy,
	0 as aov_yoy
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers`
	WHERE period = 'Rolling 365 (t-1mo)'

),

this_month_1yr as (

	SELECT
	client,
	date,
	customer_id,
	'' as segment_365,
	0 as recency_365,
	0 as frequency_365,
	0 as revenue_365,
	0 as aov_365,
	'' as segment_mom,
	0 as recency_mom,
	0 as frequency_mom,
	0 as revenue_mom,
	0 as aov_mom,
	segment as segment_yoy,
	recency_days as recency_yoy,
	frequency as frequency_yoy,
	revenue as revenue_yoy,
	aov as aov_yoy
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers`
	WHERE period = 'Rolling 365 (t-1yr)'


)

SELECT
client,
date, 
customer_id,
ifnull(max(segment_365), '') segment_365,
ifnull(max(segment_mom), '') segment_mom,
ifnull(max(segment_yoy), '') segment_yoy,
ifnull(sum(recency_365), 0) recency_365,
ifnull(sum(frequency_365), 0) frequency_365,
ifnull(sum(revenue_365), 0) revenue_365,
ifnull(sum(aov_365), 0) aov_365,
ifnull(sum(recency_mom), 0) recency_mom,
ifnull(sum(frequency_mom), 0) frequency_mom,
ifnull(sum(revenue_mom), 0) revenue_mom,
ifnull(sum(aov_mom), 0) aov_mom,	
ifnull(sum(recency_yoy), 0) recency_yoy,
ifnull(sum(frequency_yoy), 0) frequency_yoy,
ifnull(sum(revenue_yoy), 0) revenue_yoy,
ifnull(sum(aov_yoy), 0) aov_yoy
FROM
(
	SELECT * FROM ty
	UNION ALL
	SELECT * FROM last_month
	UNION ALL
	SELECT * FROM this_month_1yr

)
GROUP BY client, date, customer_id
2018-04-17 14:28:24,347: Model SQL (retention_0_365_rebuy):
SELECT 
r2.client,
r2.date,
r2.customer_id, 
r2.quantity,
r2.revenue
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_365_730` r1 
left join `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365` r2 
  on ( r1.customer_id = r2.customer_id 
  and r1.date = r2.date )
2018-04-17 14:28:24,386: Model SQL (retention_0_30_rebuy):
SELECT 
r2.client,
r2.date,
r2.customer_id, 
r2.quantity,
r2.revenue
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_30_60` r1 
left join `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30` r2 
  on ( r1.customer_id = r2.customer_id 
  and r1.date = r2.date )
2018-04-17 14:28:26,610: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10871f0f0>]}
2018-04-17 14:28:26,903: 14:28:26 | 73 of 91 OK created table model agency_data_pipeline.retention_0_30_rebuy [CREATE TABLE in 3.26s]
2018-04-17 14:28:29,925: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105318cc0>]}
2018-04-17 14:28:30,174: 14:28:30 | 75 of 91 OK created table model agency_data_pipeline.retention_0_365_rebuy [CREATE TABLE in 6.57s]
2018-04-17 14:28:48,906: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1052dfbe0>]}
2018-04-17 14:28:49,183: 14:28:49 | 74 of 91 OK created table model agency_data_pipeline.segment_stats_customers_agg [CREATE TABLE in 25.56s]
2018-04-17 14:28:49,186: 14:28:49 | 76 of 91 START table model agency_data_pipeline.retention_stats_rebuy_rate_month [RUN]
2018-04-17 14:28:49,188: Compiling model.agency_data_pipeline.retention_stats_rebuy_rate_month
2018-04-17 14:28:49,187: 14:28:49 | 77 of 91 START table model agency_data_pipeline.segment_stats_customers [RUN]
2018-04-17 14:28:49,195: Compiling model.agency_data_pipeline.segment_stats_customers
2018-04-17 14:28:49,204: Writing injected SQL for node "model.agency_data_pipeline.retention_stats_rebuy_rate_month"
2018-04-17 14:28:49,207: Writing injected SQL for node "model.agency_data_pipeline.segment_stats_customers"
2018-04-17 14:28:49,187: 14:28:49 | 78 of 91 START table model agency_data_pipeline.agg_platforms_client. [RUN]
2018-04-17 14:28:49,208: Compiling model.agency_data_pipeline.agg_platforms_client
2018-04-17 14:28:49,213: Writing injected SQL for node "model.agency_data_pipeline.agg_platforms_client"
2018-04-17 14:28:49,187: 14:28:49 | 79 of 91 START table model agency_data_pipeline.retention_stats_rebuy_rate [RUN]
2018-04-17 14:28:49,213: Compiling model.agency_data_pipeline.retention_stats_rebuy_rate
2018-04-17 14:28:49,222: Writing injected SQL for node "model.agency_data_pipeline.retention_stats_rebuy_rate"
2018-04-17 14:28:49,224: Acquiring new bigquery connection "retention_stats_rebuy_rate_month".
2018-04-17 14:28:49,224: Acquiring new bigquery connection "segment_stats_customers".
2018-04-17 14:28:49,225: Re-using an available connection from the pool.
2018-04-17 14:28:49,226: Acquiring new bigquery connection "agg_platforms_client".
2018-04-17 14:28:49,226: Re-using an available connection from the pool.
2018-04-17 14:28:49,227: Acquiring new bigquery connection "retention_stats_rebuy_rate".
2018-04-17 14:28:49,228: Re-using an available connection from the pool.
2018-04-17 14:28:49,232: Re-using an available connection from the pool.
2018-04-17 14:28:50,284: Model SQL (segment_stats_customers):
SELECT
client,
date,
segment_365,
segment_mom,
segment_yoy,
count(distinct(customer_id)) customers,
avg(recency_365) recency_365,
sum(frequency_365) frequency_365,
sum(revenue_365) revenue_365,
case when sum(frequency_365) > 0 then sum(revenue_365)/sum(frequency_365) else null end as aov_365,
avg(recency_mom) recency_mom,
sum(frequency_mom) frequency_mom,
sum(revenue_mom) revenue_mom,
case when sum(frequency_mom) > 0 then sum(revenue_mom)/sum(frequency_mom) else null end as aov_mom,
avg(recency_yoy) recency_yoy,
sum(frequency_yoy) frequency_yoy,
sum(revenue_yoy) revenue_yoy,
case when sum(frequency_yoy) > 0 then sum(revenue_yoy)/sum(frequency_yoy) else null end as aov_yoy
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_stats_customers_agg`
GROUP BY client, date, segment_365, segment_mom, segment_yoy
2018-04-17 14:28:50,288: Model SQL (retention_stats_rebuy_rate):
WITH r1 AS (
	SELECT 
	date,
	client,
	count(distinct customer_id) customers_prior_year,
	0 as customers_current_year, 
	sum(quantity) quantity_prior_year,
	0 as quantity_current_year,
	sum(revenue) revenue_prior_year,
	0 as revenue_current_year,
	case when sum(quantity) > 0 then sum(revenue)/sum(quantity) else null end as aov_prior_year,
	null as aov_current_year
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_365_730`
	group by date, client
),

r2 AS (
	SELECT 
	date,
	client,
	0 as customers_prior_year,
	count(distinct customer_id) customers_current_year, 
	0 as quantity_prior_year,
	sum(quantity) quantity_current_year,
	0 as revenue_prior_year,
	sum(revenue) revenue_current_year,
	null as aov_prior_year,
	case when sum(quantity) > 0 then sum(revenue)/sum(quantity) else null end as aov_current_year
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365_rebuy`
	group by date, client
)

SELECT 
date,
client,
sum(customers_prior_year) customers_prior_year, 
sum(customers_current_year) customers_current_year,
sum(quantity_prior_year) quantity_prior_year,
sum(quantity_current_year) quantity_current_year,
sum(revenue_prior_year) revenue_prior_year,
sum(revenue_current_year) revenue_current_year,
sum(aov_prior_year) aov_prior_year,
sum(aov_current_year) aov_current_year,
case when sum(revenue_prior_year) > 0 then sum(revenue_current_year)/sum(revenue_prior_year) else null end as revenue_retention,
case when sum(customers_prior_year) > 0 then sum(customers_current_year)/sum(customers_prior_year) else null end as customer_retention
FROM
(
	SELECT
	date,
	client,
	customers_prior_year,
	customers_current_year,
	quantity_prior_year,
	quantity_current_year,
	revenue_prior_year,
	revenue_current_year,
	aov_prior_year,
	aov_current_year
	FROM r1

	UNION ALL

	SELECT
	date,
	client,
	customers_prior_year,
	customers_current_year,
	quantity_prior_year,
	quantity_current_year,
	revenue_prior_year,
	revenue_current_year,
	aov_prior_year,
	aov_current_year
	FROM r2

) 
GROUP BY date, client
2018-04-17 14:28:50,289: Model SQL (retention_stats_rebuy_rate_month):
WITH r1 AS (
	SELECT 
	date,
	client,
	count(distinct customer_id) customers_prior_year,
	0 as customers_current_year, 
	sum(quantity) quantity_prior_year,
	0 as quantity_current_year,
	sum(revenue) revenue_prior_year,
	0 as revenue_current_year,
	case when sum(quantity) > 0 then sum(revenue)/sum(quantity) else null end as aov_prior_year,
	null as aov_current_year
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_30_60`
	group by date, client
),

r2 AS (
	SELECT 
	date,
	client,
	0 as customers_prior_year,
	count(distinct customer_id) customers_current_year, 
	0 as quantity_prior_year,
	sum(quantity) quantity_current_year,
	0 as revenue_prior_year,
	sum(revenue) revenue_current_year,
	null as aov_prior_year,
	case when sum(quantity) > 0 then sum(revenue)/sum(quantity) else null end as aov_current_year
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30_rebuy`
	group by date, client
)

SELECT 
date,
client,
sum(customers_prior_year) customers_prior_year, 
sum(customers_current_year) customers_current_year,
sum(quantity_prior_year) quantity_prior_year,
sum(quantity_current_year) quantity_current_year,
sum(revenue_prior_year) revenue_prior_year,
sum(revenue_current_year) revenue_current_year,
sum(aov_prior_year) aov_prior_year,
sum(aov_current_year) aov_current_year,
case when sum(revenue_prior_year) > 0 then sum(revenue_current_year)/sum(revenue_prior_year) else null end as revenue_retention,
case when sum(customers_prior_year) > 0 then sum(customers_current_year)/sum(customers_prior_year) else null end as customer_retention
FROM
(
	SELECT
	date,
	client,
	customers_prior_year,
	customers_current_year,
	quantity_prior_year,
	quantity_current_year,
	revenue_prior_year,
	revenue_current_year,
	aov_prior_year,
	aov_current_year
	FROM r1

	UNION ALL

	SELECT
	date,
	client,
	customers_prior_year,
	customers_current_year,
	quantity_prior_year,
	quantity_current_year,
	revenue_prior_year,
	revenue_current_year,
	aov_prior_year,
	aov_current_year
	FROM r2

) 
GROUP BY date, client
2018-04-17 14:28:50,290: Model SQL (agg_platforms_client):
SELECT 
date, 
a.account account, 
b.client client,
a.platform platform,
a.channel channel,
url,
utm_campaign,
campaign,
cost,
impressions,
clicks,
transactions ad_platform_transactions
FROM 
  `growth-engines-pipeline`.`agency_data_pipeline`.`agg_platforms_union` a
LEFT JOIN 
  `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc` b
ON ( 
  a.account = b.account AND
  a.platform = b.platform
)
2018-04-17 14:28:52,556: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1053b5d30>]}
2018-04-17 14:28:52,811: 14:28:52 | 79 of 91 OK created table model agency_data_pipeline.retention_stats_rebuy_rate [CREATE TABLE in 3.34s]
2018-04-17 14:28:52,811: 14:28:52 | 80 of 91 START table model agency_data_pipeline.retention_0_30_new... [RUN]
2018-04-17 14:28:52,811: Compiling model.agency_data_pipeline.retention_0_30_new
2018-04-17 14:28:52,820: Writing injected SQL for node "model.agency_data_pipeline.retention_0_30_new"
2018-04-17 14:28:52,825: Acquiring new bigquery connection "retention_0_30_new".
2018-04-17 14:28:52,825: Re-using an available connection from the pool.
2018-04-17 14:28:53,661: Model SQL (retention_0_30_new):
SELECT 
a.client,
a.date,
a.customer_id, 
a.quantity,
a.revenue,
a.order_count
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_60_plus` b
ON (
	a.client = b.client AND
	a.date = b.date AND
	a.customer_id = b.customer_id
)
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_30_60` c
ON (
	a.client = c.client AND
	a.date = c.date AND
	a.customer_id = c.customer_id
)
WHERE b.customer_id is null 
and c.customer_id is null
2018-04-17 14:28:53,677: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10530f7f0>]}
2018-04-17 14:28:53,924: 14:28:53 | 76 of 91 OK created table model agency_data_pipeline.retention_stats_rebuy_rate_month [CREATE TABLE in 4.49s]
2018-04-17 14:28:53,925: 14:28:53 | 81 of 91 START table model agency_data_pipeline.retention_0_365_new.. [RUN]
2018-04-17 14:28:53,925: Compiling model.agency_data_pipeline.retention_0_365_new
2018-04-17 14:28:53,931: Writing injected SQL for node "model.agency_data_pipeline.retention_0_365_new"
2018-04-17 14:28:53,932: Acquiring new bigquery connection "retention_0_365_new".
2018-04-17 14:28:53,933: Re-using an available connection from the pool.
2018-04-17 14:28:54,684: Model SQL (retention_0_365_new):
SELECT 
a.client,
a.date,
a.customer_id, 
a.quantity,
a.revenue,
a.order_count
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_730_plus` b
ON (
	a.client = b.client AND
	a.date = b.date AND
	a.customer_id = b.customer_id
)
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_365_730` c
ON (
	a.client = c.client AND
	a.date = c.date AND
	a.customer_id = c.customer_id
)
WHERE b.customer_id is null 
and c.customer_id is null
2018-04-17 14:28:54,920: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1087f4a20>]}
2018-04-17 14:28:55,160: 14:28:55 | 78 of 91 OK created table model agency_data_pipeline.agg_platforms_client [CREATE TABLE in 5.71s]
2018-04-17 14:28:55,160: 14:28:55 | 82 of 91 START table model agency_data_pipeline.retention_0_30_reactivated [RUN]
2018-04-17 14:28:55,160: Compiling model.agency_data_pipeline.retention_0_30_reactivated
2018-04-17 14:28:55,168: Writing injected SQL for node "model.agency_data_pipeline.retention_0_30_reactivated"
2018-04-17 14:28:55,169: Acquiring new bigquery connection "retention_0_30_reactivated".
2018-04-17 14:28:55,169: Re-using an available connection from the pool.
2018-04-17 14:28:55,902: Model SQL (retention_0_30_reactivated):
SELECT 
a.client,
a.date,
a.customer_id, 
a.quantity,
a.revenue
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_60_plus` b
ON (
	a.client = b.client AND
	a.date = b.date AND
	a.customer_id = b.customer_id
)
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_30_60` c
ON (
	a.client = c.client AND
	a.date = c.date AND
	a.customer_id = c.customer_id
)
WHERE b.customer_id is not null 
AND c.customer_id is null
2018-04-17 14:28:59,179: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105324128>]}
2018-04-17 14:28:59,485: 14:28:59 | 80 of 91 OK created table model agency_data_pipeline.retention_0_30_new [CREATE TABLE in 6.37s]
2018-04-17 14:28:59,485: 14:28:59 | 83 of 91 START table model agency_data_pipeline.retention_0_365_reactivated [RUN]
2018-04-17 14:28:59,486: Compiling model.agency_data_pipeline.retention_0_365_reactivated
2018-04-17 14:28:59,493: Writing injected SQL for node "model.agency_data_pipeline.retention_0_365_reactivated"
2018-04-17 14:28:59,494: Acquiring new bigquery connection "retention_0_365_reactivated".
2018-04-17 14:28:59,495: Re-using an available connection from the pool.
2018-04-17 14:29:00,239: Model SQL (retention_0_365_reactivated):
SELECT 
a.client,
a.date,
a.customer_id, 
a.quantity,
a.revenue
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_730_plus` b
ON (
	a.client = b.client AND
	a.date = b.date AND
	a.customer_id = b.customer_id
)
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_365_730` c
ON (
	a.client = c.client AND
	a.date = c.date AND
	a.customer_id = c.customer_id
)
WHERE b.customer_id is not null 
AND c.customer_id is null
2018-04-17 14:29:00,346: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1087f4a20>]}
2018-04-17 14:29:00,632: 14:29:00 | 82 of 91 OK created table model agency_data_pipeline.retention_0_30_reactivated [CREATE TABLE in 5.19s]
2018-04-17 14:29:03,544: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1053b5128>]}
2018-04-17 14:29:03,820: 14:29:03 | 81 of 91 OK created table model agency_data_pipeline.retention_0_365_new [CREATE TABLE in 9.62s]
2018-04-17 14:29:04,660: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1087aa828>]}
2018-04-17 14:29:04,896: 14:29:04 | 83 of 91 OK created table model agency_data_pipeline.retention_0_365_reactivated [CREATE TABLE in 5.17s]
2018-04-17 14:29:05,895: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105398160>]}
2018-04-17 14:29:06,638: 14:29:06 | 77 of 91 OK created table model agency_data_pipeline.segment_stats_customers [CREATE TABLE in 16.70s]
2018-04-17 14:29:06,640: 14:29:06 | 84 of 91 START table model agency_data_pipeline.segment_list_customers [RUN]
2018-04-17 14:29:06,640: Compiling model.agency_data_pipeline.segment_list_customers
2018-04-17 14:29:06,650: Writing injected SQL for node "model.agency_data_pipeline.segment_list_customers"
2018-04-17 14:29:06,651: Acquiring new bigquery connection "segment_list_customers".
2018-04-17 14:29:06,652: Re-using an available connection from the pool.
2018-04-17 14:29:07,513: Model SQL (segment_list_customers):
SELECT
a.client,
period,
date,
customer_id,
b.first_name,
b.last_name,
b.email,
recency_days,
frequency,
revenue,
quantity,
aov,
segment
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`agg_customers_union` b
ON (
	a.client = b.client AND
	a.customer_id = b.id
)
2018-04-17 14:29:48,633: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1052dfbe0>]}
2018-04-17 14:29:49,354: 14:29:49 | 84 of 91 OK created table model agency_data_pipeline.segment_list_customers [CREATE TABLE in 41.99s]
2018-04-17 14:29:49,357: 14:29:49 | 85 of 91 START table model agency_data_pipeline.growth_customer_0_365_segment [RUN]
2018-04-17 14:29:49,357: Compiling model.agency_data_pipeline.growth_customer_0_365_segment
2018-04-17 14:29:49,380: Writing injected SQL for node "model.agency_data_pipeline.growth_customer_0_365_segment"
2018-04-17 14:29:49,384: Acquiring new bigquery connection "growth_customer_0_365_segment".
2018-04-17 14:29:49,385: Re-using an available connection from the pool.
2018-04-17 14:29:50,387: Model SQL (growth_customer_0_365_segment):
with segment as (

	SELECT 
	a.date,
	unix_date_in_range,
	unix_date_in_range_yoy,
	a.client client,
	a.customer_id customer_id,
	case when b.customer_id is not null then 'New' else 'Existing' end as segment,
	a.orders,
	a.quantity,
	a.revenue,
	a.shipping_revenue
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_customer_0_365` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365_new` b
	ON (
	  a.customer_id = b.customer_id AND
	  a.date  = b.date AND
	  a.client = b.client
	)
),

total as (

	SELECT 
	date,
	unix_date_in_range,
	unix_date_in_range_yoy,
	client,
	customer_id,
	'Total' as segment,
	orders,
	quantity,
	revenue,
	shipping_revenue
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_customer_0_365`

)

SELECT 
date,
unix_date_in_range,
unix_date_in_range_yoy,
client,
segment,
count(distinct(customer_id)) customers,
sum(orders) orders,
sum(quantity) quantity,
sum(revenue) revenue,
sum(shipping_revenue) shipping_revenue
FROM
( 
	SELECT * FROM segment
	UNION ALL
	SELECT * FROM total
) 
GROUP BY date, unix_date_in_range, unix_date_in_range_yoy, client, segment
2018-04-17 14:30:02,697: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1053bd470>]}
2018-04-17 14:30:02,950: 14:30:02 | 85 of 91 OK created table model agency_data_pipeline.growth_customer_0_365_segment [CREATE TABLE in 13.34s]
2018-04-17 14:30:02,951: 14:30:02 | 86 of 91 START table model agency_data_pipeline.growth_date_union.... [RUN]
2018-04-17 14:30:02,951: Compiling model.agency_data_pipeline.growth_date_union
2018-04-17 14:30:02,960: Writing injected SQL for node "model.agency_data_pipeline.growth_date_union"
2018-04-17 14:30:02,961: Acquiring new bigquery connection "growth_date_union".
2018-04-17 14:30:02,961: Re-using an available connection from the pool.
2018-04-17 14:30:04,521: Model SQL (growth_date_union):
with ty as (

  SELECT 
  date,
  unix_date_in_range, 
  unix_date_in_range_yoy, 
  client, 
  segment,
  customers customers_ty,
  orders orders_ty,
  quantity quantity_ty,
  revenue revenue_ty,
  shipping_revenue shipping_revenue_ty,
  null as customers_ly,
  null as orders_ly,
  null as quantity_ly,
  null as revenue_ly,
  null as shipping_revenue_ly
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_customer_0_365_segment`

),

ly as (

  SELECT 
  date,
  0 as unix_date_in_range, 
  unix_date_in_range unix_date_in_range_yoy, 
  client, 
  segment,
  null as customers_ty,
  null as orders_ty,
  null as quantity_ty,
  null as revenue_ty,
  null as shipping_revenue_ty,
  customers customers_ly,
  orders orders_ly,
  quantity quantity_ly,
  revenue revenue_ly,
  shipping_revenue shipping_revenue_ly
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_customer_0_365_segment`

)


SELECT
max(date) date,
max(unix_date_in_range) unix_date_in_range,
unix_date_in_range_yoy,
client,
segment,
ifnull(sum(customers_ty), 0) customers_ty,
ifnull(sum(orders_ty), 0) orders_ty,
ifnull(sum(quantity_ty), 0) quantity_ty,
ifnull(sum(revenue_ty), 0) revenue_ty,
ifnull(sum(shipping_revenue_ty), 0) shipping_revenue_ty,
case when sum(orders_ty) > 0 then sum(revenue_ty)/sum(orders_ty) else null end as aov_ty,
ifnull(sum(customers_ly), 0) customers_ly,
ifnull(sum(orders_ly), 0) orders_ly,
ifnull(sum(quantity_ly), 0) quantity_ly,
ifnull(sum(revenue_ly), 0) revenue_ly,
ifnull(sum(shipping_revenue_ly), 0) shipping_revenue_ly,
case when sum(orders_ly) > 0 then sum(revenue_ly)/sum(orders_ly) else null end as aov_ly,
case when sum(orders_ly) > 0 then ( sum(orders_ty) - sum(orders_ly) ) / sum(orders_ly) else null end as order_growth,
case when sum(revenue_ly) > 0 then ( sum(revenue_ty) - sum(revenue_ly) ) / sum(revenue_ly) else null end as revenue_growth,
case when sum(customers_ly) > 0 then ( sum(customers_ty) - sum(customers_ly) ) / sum(customers_ly) else null end as customer_growth,
case when sum(orders_ly) > 0 then ( sum(revenue_ty)/sum(orders_ty) - sum(revenue_ly)/sum(orders_ly) ) / ( sum(revenue_ly)/sum(orders_ly) ) else null end as aov_growth
FROM (

  SELECT * FROM ty
  UNION ALL
  SELECT * FROM ly

)
where unix_date_in_range is not null
group by unix_date_in_range_yoy, client, segment
2018-04-17 14:30:05,647: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1052dfbe0>]}
2018-04-17 14:30:05,884: 14:30:05 | 86 of 91 OK created table model agency_data_pipeline.growth_date_union [CREATE TABLE in 2.70s]
2018-04-17 14:30:05,885: 14:30:05 | 87 of 91 START table model agency_data_pipeline.retention_stats...... [RUN]
2018-04-17 14:30:05,886: Compiling model.agency_data_pipeline.retention_stats
2018-04-17 14:30:05,886: 14:30:05 | 88 of 91 START table model agency_data_pipeline.growth_stats......... [RUN]
2018-04-17 14:30:05,893: 14:30:05 | 89 of 91 START table model agency_data_pipeline.retention_stats_month [RUN]
2018-04-17 14:30:05,901: Writing injected SQL for node "model.agency_data_pipeline.retention_stats"
2018-04-17 14:30:05,902: Compiling model.agency_data_pipeline.growth_stats
2018-04-17 14:30:05,902: Compiling model.agency_data_pipeline.retention_stats_month
2018-04-17 14:30:05,910: Acquiring new bigquery connection "retention_stats".
2018-04-17 14:30:05,926: Re-using an available connection from the pool.
2018-04-17 14:30:05,914: Writing injected SQL for node "model.agency_data_pipeline.growth_stats"
2018-04-17 14:30:05,937: Writing injected SQL for node "model.agency_data_pipeline.retention_stats_month"
2018-04-17 14:30:05,947: Acquiring new bigquery connection "retention_stats_month".
2018-04-17 14:30:05,949: Acquiring new bigquery connection "growth_stats".
2018-04-17 14:30:05,949: Re-using an available connection from the pool.
2018-04-17 14:30:05,951: Re-using an available connection from the pool.
2018-04-17 14:30:06,875: Model SQL (retention_stats):
WITH last_year_buyers AS (
	SELECT 
	date,
	client,
	'Last year buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_365_730`
	group by date, client
),

rebuy_rate AS (
	SELECT 
	date,
	client,
	'Rebuy rate' as metric,
	customer_retention value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_stats_rebuy_rate`
),

repeat_buyers AS (
	SELECT 
	date,
	client,
	'Repeat buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365_rebuy`
	group by date, client
),

reactivated_buyers AS (
	SELECT 
	date,
	client,
	'Reactivated buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365_reactivated`
	group by date, client
),

new_buyers AS (
	SELECT 
	date,
	client,
	'New buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365_new`
	group by date, client
),

this_year_buyers AS (
	SELECT 
	date,
	client,
	'This year buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365`
	group by date, client
),

this_year_revenue AS (
	SELECT 
	date,
	client,
	'This year revenue' as metric,
	sum(revenue) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365`
	group by date, client
),

this_year_aov AS (
	SELECT 
	date,
	client,
	'This year AOV' as metric,
	case when sum(order_count) > 0 then sum(revenue)/sum(order_count) else 0 end as value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365`
	group by date, client
),

this_year_frequency AS (
	SELECT 
	date,
	client,
	'This year frequency' as metric,
	case when count(distinct customer_id) > 0 then sum(order_count)/count(distinct customer_id) else 0 end as value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365`
	group by date, client
)

SELECT 
date,
client,
metric,
ifnull(value, 0) value
FROM
(
	SELECT
	date,
	client,
	metric,
	value
	FROM last_year_buyers

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM rebuy_rate

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM repeat_buyers

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM reactivated_buyers	

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM new_buyers	

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_year_buyers	

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_year_revenue

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_year_aov

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_year_frequency

	UNION ALL

	SELECT
	a.date,
	a.client,
	'Dormant buyers' as metric,
	a.value - ifnull(b.value, 0) as value
	FROM last_year_buyers a
	LEFT JOIN repeat_buyers b
	ON ( a.date = b.date AND
		a.client = b.client )							

)
2018-04-17 14:30:06,886: Model SQL (growth_stats):
with orders as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'Orders' as metric,
  orders_ty as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`
),

order_growth as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'Order Growth' as metric,
  order_growth as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`
),

revenue as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'Revenue' as metric,
  revenue_ty as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`
),

revenue_growth as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'Revenue Growth' as metric,
  revenue_growth as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`
),

customers as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'Customers' as metric,
  customers_ty as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`
),

customer_growth as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'Customer Growth' as metric,
  customer_growth as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`

),

aov as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'AOV' as metric,
  aov_ty as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`

),

aov_growth as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'AOV Growth' as metric,
  aov_growth as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`

)

SELECT * FROM orders
UNION ALL 
SELECT * FROM order_growth
UNION ALL
SELECT * FROM revenue
UNION ALL 
SELECT * FROM revenue_growth
UNION ALL
SELECT * FROM customers
UNION ALL 
SELECT * FROM customer_growth
UNION ALL
SELECT * FROM aov
UNION ALL 
SELECT * FROM aov_growth
2018-04-17 14:30:06,934: Model SQL (retention_stats_month):
WITH last_month_buyers AS (
	SELECT 
	date,
	client,
	'Last month buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_30_60`
	group by date, client
),

rebuy_rate AS (
	SELECT 
	date,
	client,
	'Rebuy rate' as metric,
	customer_retention value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_stats_rebuy_rate_month`
),

repeat_buyers AS (
	SELECT 
	date,
	client,
	'Repeat buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30_rebuy`
	group by date, client
),

reactivated_buyers AS (
	SELECT 
	date,
	client,
	'Reactivated buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30_reactivated`
	group by date, client
),

new_buyers AS (
	SELECT 
	date,
	client,
	'New buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30_new`
	group by date, client
),

this_month_buyers AS (
	SELECT 
	date,
	client,
	'This month buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30`
	group by date, client
),

this_month_revenue AS (
	SELECT 
	date,
	client,
	'This month revenue' as metric,
	sum(revenue) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30`
	group by date, client
),

this_month_aov AS (
	SELECT 
	date,
	client,
	'This month AOV' as metric,
	case when sum(order_count) > 0 then sum(revenue)/sum(order_count) else 0 end as value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30`
	group by date, client
),

this_month_frequency AS (
	SELECT 
	date,
	client,
	'This month frequency' as metric,
	case when count(distinct customer_id) > 0 then sum(order_count)/count(distinct customer_id) else 0 end as value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30`
	group by date, client
)

SELECT 
date,
client,
metric,
ifnull(value, 0) value
FROM
(
	SELECT
	date,
	client,
	metric,
	value
	FROM last_month_buyers

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM rebuy_rate

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM repeat_buyers

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM reactivated_buyers	

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM new_buyers	

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_month_buyers	

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_month_revenue

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_month_aov

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_month_frequency

	UNION ALL

	SELECT
	a.date,
	a.client,
	'Dormant buyers' as metric,
	a.value - ifnull(b.value, 0) as value
	FROM last_month_buyers a
	LEFT JOIN repeat_buyers b
	ON ( a.date = b.date AND
		a.client = b.client )							

)
2018-04-17 14:30:07,995: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1087aaf28>]}
2018-04-17 14:30:08,314: 14:30:08 | 88 of 91 OK created table model agency_data_pipeline.growth_stats.... [CREATE TABLE in 2.09s]
2018-04-17 14:30:10,300: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10972e7b8>]}
2018-04-17 14:30:10,581: 14:30:10 | 89 of 91 OK created table model agency_data_pipeline.retention_stats_month [CREATE TABLE in 4.40s]
2018-04-17 14:30:14,692: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1053bd470>]}
2018-04-17 14:30:14,941: 14:30:14 | 87 of 91 OK created table model agency_data_pipeline.retention_stats. [CREATE TABLE in 8.81s]
2018-04-17 14:30:14,942: 14:30:14 | 90 of 91 START table model agency_data_pipeline.agg_campaign......... [RUN]
2018-04-17 14:30:14,942: Compiling model.agency_data_pipeline.agg_campaign
2018-04-17 14:30:14,952: Writing injected SQL for node "model.agency_data_pipeline.agg_campaign"
2018-04-17 14:30:14,955: Acquiring new bigquery connection "agg_campaign".
2018-04-17 14:30:14,955: Re-using an available connection from the pool.
2018-04-17 14:30:15,998: Model SQL (agg_campaign):
with ga as (

	select 
		date, client, attribution, channel, platform, url, campaign as utm_campaign, '' as campaign,
    	customers_new,
    	transactions_new,
    	revenue_new,
    	first_order_revenue_new,
    	lifetime_revenue_new,
    	customers_total,
    	transactions_total,
    	revenue_total,
		null as cost, null as impressions, null as clicks, null as ad_platform_transactions
	from `growth-engines-pipeline`.`agency_data_pipeline`.`agg_ga_campaign_by_type`

),

platforms_last_touch as (

	select 
		date, client, 'Last-touch' as attribution, channel, platform, url, utm_campaign, campaign,
		null as customers_new,
    	null as transactions_new,
    	null as revenue_new,
    	null as first_order_revenue_new,
    	null as lifetime_revenue_new,
    	null as customers_total,
    	null as transactions_total,
    	null as revenue_total,
		cost, impressions, clicks, ad_platform_transactions
	from `growth-engines-pipeline`.`agency_data_pipeline`.`agg_platforms_client`

),

platforms_first_touch as (

    select 
        date, client, 'First-touch' as attribution, channel, platform, url, utm_campaign, campaign,
        null as customers_new,
        null as transactions_new,
        null as revenue_new,
        null as first_order_revenue_new,
        null as lifetime_revenue_new,
        null as customers_total,
        null as transactions_total,
        null as revenue_total,
        cost, impressions, clicks, ad_platform_transactions
    from `growth-engines-pipeline`.`agency_data_pipeline`.`agg_platforms_client`

)


SELECT
    date, 
    client,
    attribution,
    platform,
    channel, 
    url,
    utm_campaign,
    max(campaign) campaign,
    ifnull( sum(cost), 0) cost,
	ifnull( sum(impressions), 0) impressions,
	ifnull( sum(clicks), 0) clicks,
	ifnull( sum(ad_platform_transactions), 0) ad_platform_transactions,
	ifnull( sum(customers_new), 0) customers_new,
	ifnull( sum(transactions_new), 0) transactions_new,
	ifnull( sum(revenue_new), 0) revenue_new,
	ifnull( sum(first_order_revenue_new), 0) first_order_revenue_new,
	ifnull( sum(lifetime_revenue_new), 0) lifetime_revenue_new,
	ifnull( sum(customers_total), 0) customers_total,
	ifnull( sum(transactions_total), 0) transactions_total,
	ifnull( sum(revenue_total), 0) revenue_total	
FROM 
(
    SELECT *
    FROM 
      ga
    UNION ALL
    SELECT *
    FROM 
      platforms_first_touch
    UNION ALL
    SELECT *
    FROM 
      platforms_last_touch      
) 
GROUP BY
    date, client, attribution, platform, channel, url, utm_campaign
2018-04-17 14:30:23,818: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108799208>]}
2018-04-17 14:30:24,057: 14:30:24 | 90 of 91 OK created table model agency_data_pipeline.agg_campaign.... [CREATE TABLE in 8.88s]
2018-04-17 14:30:24,058: 14:30:24 | 91 of 91 START table model agency_data_pipeline.agg_platform_monthly. [RUN]
2018-04-17 14:30:24,058: Compiling model.agency_data_pipeline.agg_platform_monthly
2018-04-17 14:30:24,064: Writing injected SQL for node "model.agency_data_pipeline.agg_platform_monthly"
2018-04-17 14:30:24,064: Acquiring new bigquery connection "agg_platform_monthly".
2018-04-17 14:30:24,064: Re-using an available connection from the pool.
2018-04-17 14:30:25,002: Model SQL (agg_platform_monthly):
SELECT
    FORMAT_DATE("%Y-%m", date) AS yyyymm,
    client,
    attribution,
    platform,
    channel, 
    sum(cost) cost,
	sum(clicks) clicks,
	sum(customers_new) customers_new,
	sum(first_order_revenue_new) first_order_revenue_new,
	sum(lifetime_revenue_new) lifetime_revenue_new,
	sum(transactions_new) transactions_new,
	sum(revenue_new) revenue_new,
    sum(customers_total) customers_total,
    sum(transactions_total) transactions_total,
    sum(revenue_total) revenue_total
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_campaign`
GROUP BY
    yyyymm, client, attribution, platform, channel
2018-04-17 14:30:26,151: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aa874cd3-b202-462b-ba88-6fea65322fdb', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105318c18>]}
2018-04-17 14:30:26,425: 14:30:26 | 91 of 91 OK created table model agency_data_pipeline.agg_platform_monthly [CREATE TABLE in 2.09s]
2018-04-17 14:30:26,527: 14:30:26 | 
2018-04-17 14:30:26,527: 14:30:26 | Finished running 91 table models in 432.74s.
2018-04-17 14:30:26,527: Connection 'master' was left open.
2018-04-17 14:30:26,528: 
2018-04-17 14:30:26,528: Completed with 1 errors:
2018-04-17 14:30:26,528: 
2018-04-17 14:30:26,529: Database Error in model frequency_proc (models/segmentation/frequency/frequency_proc.sql)
2018-04-17 14:30:26,529:   SELECT list expression references column date_in_range which is neither grouped nor aggregated at [20:1]
2018-04-17 14:30:26,529:   compiled SQL at target/compiled/agency_data_pipeline/segmentation/frequency/frequency_proc.sql
2018-04-17 14:30:26,529: 
Done. PASS=89 ERROR=1 SKIP=1 TOTAL=91
2018-04-17 14:30:26,530: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1086d1780>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10869ab00>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10869ada0>]}
2018-04-17 14:30:26,843: Flushing usage events
2018-04-17 15:28:50,663: Tracking: tracking
2018-04-17 15:28:50,664: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104b8d588>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104b8d828>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104b8dba8>]}
2018-04-17 15:28:51,417: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-04-17 15:28:51,438: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/growth-engines/dbt_modules
2018-04-17 15:28:51,444: Parsing get_column_values.sql
2018-04-17 15:28:51,460: Parsing get_url_parameter.sql
2018-04-17 15:28:51,467: Parsing split_part.sql
2018-04-17 15:28:51,479: Parsing table_exists.sql
2018-04-17 15:28:51,496: Parsing core.sql
2018-04-17 15:28:51,514: Parsing adapters/bigquery.sql
2018-04-17 15:28:51,524: Parsing adapters/common.sql
2018-04-17 15:28:51,546: Parsing adapters/postgres.sql
2018-04-17 15:28:51,552: Parsing adapters/redshift.sql
2018-04-17 15:28:51,580: Parsing etc/get_custom_schema.sql
2018-04-17 15:28:51,602: Parsing materializations/archive.sql
2018-04-17 15:28:51,723: Parsing materializations/bigquery.sql
2018-04-17 15:28:51,746: Parsing materializations/helpers.sql
2018-04-17 15:28:51,771: Parsing materializations/incremental.sql
2018-04-17 15:28:51,805: Parsing materializations/table.sql
2018-04-17 15:28:51,829: Parsing materializations/view.sql
2018-04-17 15:28:51,850: Parsing materializations/wrapper.sql
2018-04-17 15:28:51,856: Parsing schema_tests/accepted_values.sql
2018-04-17 15:28:51,864: Parsing schema_tests/not_null.sql
2018-04-17 15:28:51,869: Parsing schema_tests/relationships.sql
2018-04-17 15:28:51,873: Parsing schema_tests/unique.sql
2018-04-17 15:28:51,943: Parsing model.agency_data_pipeline.accounts_proc
2018-04-17 15:28:51,945: Parsing model.agency_data_pipeline.all_dates
2018-04-17 15:28:51,946: Parsing model.agency_data_pipeline.carts_proc
2018-04-17 15:28:51,948: Parsing model.agency_data_pipeline.clients_proc
2018-04-17 15:28:51,950: Parsing model.agency_data_pipeline.conversion_goals_proc
2018-04-17 15:28:51,953: Parsing model.agency_data_pipeline.mappings_ga_proc
2018-04-17 15:28:51,955: Acquiring new bigquery connection "master".
2018-04-17 15:28:51,955: Opening a new connection (0 currently allocated)
2018-04-17 15:28:51,963: Parsing model.agency_data_pipeline.monthend_dates
2018-04-17 15:28:51,965: Parsing model.agency_data_pipeline.adwords_ads
2018-04-17 15:28:51,967: Parsing model.agency_data_pipeline.adwords_campaigns
2018-04-17 15:28:51,969: Parsing model.agency_data_pipeline.adwords_conversions
2018-04-17 15:28:51,971: Parsing model.agency_data_pipeline.adwords_impression_share
2018-04-17 15:28:51,973: Parsing model.agency_data_pipeline.adwords_join
2018-04-17 15:28:51,976: Parsing model.agency_data_pipeline.adwords_stats
2018-04-17 15:28:51,978: Parsing model.agency_data_pipeline.adwords_urls
2018-04-17 15:28:51,981: Parsing model.agency_data_pipeline.bing_ads_ads
2018-04-17 15:28:51,987: Parsing model.agency_data_pipeline.bing_ads_conversions
2018-04-17 15:28:51,990: Parsing model.agency_data_pipeline.bing_ads_impression_share
2018-04-17 15:28:51,993: Parsing model.agency_data_pipeline.bing_ads_stats
2018-04-17 15:28:51,995: Parsing model.agency_data_pipeline.fb_adcreative
2018-04-17 15:28:52,003: Parsing model.agency_data_pipeline.fb_ads
2018-04-17 15:28:52,011: Parsing model.agency_data_pipeline.fb_ads_insights
2018-04-17 15:28:52,016: Parsing model.agency_data_pipeline.fb_ads_insights_conversions
2018-04-17 15:28:52,023: Parsing model.agency_data_pipeline.fb_ads_stats
2018-04-17 15:28:52,026: Parsing model.agency_data_pipeline.ga_conversions
2018-04-17 15:28:52,029: Parsing model.agency_data_pipeline.ga_traffic
2018-04-17 15:28:52,074: Parsing model.agency_data_pipeline.ga_transactions
2018-04-17 15:28:52,128: Parsing model.agency_data_pipeline.ga_mcf_proc
2018-04-17 15:28:52,131: Parsing model.agency_data_pipeline.ga_mcf_stats
2018-04-17 15:28:52,137: Parsing model.agency_data_pipeline.shopify_customers_proc
2018-04-17 15:28:52,154: Parsing model.agency_data_pipeline.shopify_orders_proc
2018-04-17 15:28:52,180: Parsing model.agency_data_pipeline.shopify_products_proc
2018-04-17 15:28:52,202: Parsing model.agency_data_pipeline.shopify_refunds_proc
2018-04-17 15:28:52,235: Parsing model.agency_data_pipeline.agg_campaign
2018-04-17 15:28:52,240: Parsing model.agency_data_pipeline.agg_customers_union
2018-04-17 15:28:52,243: Parsing model.agency_data_pipeline.agg_ga_campaign
2018-04-17 15:28:52,260: Parsing model.agency_data_pipeline.agg_ga_campaign_by_type
2018-04-17 15:28:52,282: Parsing model.agency_data_pipeline.agg_ga_transaction
2018-04-17 15:28:52,287: Parsing model.agency_data_pipeline.agg_ga_transaction_order_number
2018-04-17 15:28:52,309: Parsing model.agency_data_pipeline.agg_orders_union
2018-04-17 15:28:52,319: Parsing model.agency_data_pipeline.agg_platform_monthly
2018-04-17 15:28:52,324: Parsing model.agency_data_pipeline.agg_platforms_client
2018-04-17 15:28:52,339: Parsing model.agency_data_pipeline.agg_platforms_union
2018-04-17 15:28:52,367: Parsing model.agency_data_pipeline.agg_products
2018-04-17 15:28:52,371: Parsing model.agency_data_pipeline.agg_transaction
2018-04-17 15:28:52,376: Parsing model.agency_data_pipeline.agg_transaction_daily
2018-04-17 15:28:52,379: Parsing model.agency_data_pipeline.agg_transaction_line_item
2018-04-17 15:28:52,382: Parsing model.agency_data_pipeline.agg_transaction_line_item_type
2018-04-17 15:28:52,387: Parsing model.agency_data_pipeline.agg_transaction_order_number
2018-04-17 15:28:52,390: Parsing model.agency_data_pipeline.agg_transaction_product_type
2018-04-17 15:28:52,394: Parsing model.agency_data_pipeline.customers_by_transaction
2018-04-17 15:28:52,397: Parsing model.agency_data_pipeline.growth_customer_0_365
2018-04-17 15:28:52,406: Parsing model.agency_data_pipeline.growth_customer_0_365_segment
2018-04-17 15:28:52,420: Parsing model.agency_data_pipeline.growth_date_union
2018-04-17 15:28:52,433: Parsing model.agency_data_pipeline.growth_stats
2018-04-17 15:28:52,467: Parsing model.agency_data_pipeline.retention_0_365
2018-04-17 15:28:52,471: Parsing model.agency_data_pipeline.retention_0_365_new
2018-04-17 15:28:52,480: Parsing model.agency_data_pipeline.retention_0_365_reactivated
2018-04-17 15:28:52,484: Parsing model.agency_data_pipeline.retention_0_365_rebuy
2018-04-17 15:28:52,493: Parsing model.agency_data_pipeline.retention_365_730
2018-04-17 15:28:52,497: Parsing model.agency_data_pipeline.retention_730_plus
2018-04-17 15:28:52,500: Parsing model.agency_data_pipeline.retention_stats
2018-04-17 15:28:52,509: Parsing model.agency_data_pipeline.retention_stats_rebuy_rate
2018-04-17 15:28:52,513: Parsing model.agency_data_pipeline.retention_0_30
2018-04-17 15:28:52,518: Parsing model.agency_data_pipeline.retention_0_30_new
2018-04-17 15:28:52,532: Parsing model.agency_data_pipeline.retention_0_30_reactivated
2018-04-17 15:28:52,537: Parsing model.agency_data_pipeline.retention_0_30_rebuy
2018-04-17 15:28:52,541: Parsing model.agency_data_pipeline.retention_30_60
2018-04-17 15:28:52,550: Parsing model.agency_data_pipeline.retention_60_plus
2018-04-17 15:28:52,556: Parsing model.agency_data_pipeline.retention_stats_month
2018-04-17 15:28:52,568: Parsing model.agency_data_pipeline.retention_stats_rebuy_rate_month
2018-04-17 15:28:52,572: Parsing model.agency_data_pipeline.customers_first_purchase_proc
2018-04-17 15:28:52,577: Parsing model.agency_data_pipeline.customers_proc
2018-04-17 15:28:52,582: Parsing model.agency_data_pipeline.segment_list_customers
2018-04-17 15:28:52,588: Parsing model.agency_data_pipeline.segment_proc_customers
2018-04-17 15:28:52,595: Parsing model.agency_data_pipeline.segment_stats_customers
2018-04-17 15:28:52,598: Parsing model.agency_data_pipeline.segment_stats_customers_agg
2018-04-17 15:28:52,604: Parsing model.agency_data_pipeline.customers_first_purchase_product_type_proc
2018-04-17 15:28:52,607: Parsing model.agency_data_pipeline.customers_products_proc
2018-04-17 15:28:52,616: Parsing model.agency_data_pipeline.segment_list_customers_products
2018-04-17 15:28:52,631: Parsing model.agency_data_pipeline.segment_proc_customers_products
2018-04-17 15:28:52,643: Parsing model.agency_data_pipeline.segment_stats_customers_products
2018-04-17 15:28:52,647: Parsing model.agency_data_pipeline.segment_stats_customers_products_agg
2018-04-17 15:28:52,661: Parsing model.agency_data_pipeline.frequency_proc
2018-04-17 15:28:52,666: Parsing model.agency_data_pipeline.frequency_stats
2018-04-17 15:28:52,668: Parsing model.agency_data_pipeline.order_paths_agg
2018-04-17 15:28:52,672: Parsing model.agency_data_pipeline.order_paths_proc
2018-04-17 15:28:52,676: Parsing model.agency_data_pipeline.order_paths_stats
2018-04-17 15:28:52,679: Parsing model.agency_data_pipeline.products_proc
2018-04-17 15:28:52,683: Parsing model.agency_data_pipeline.segment_proc_sku
2018-04-17 15:28:52,686: Parsing model.agency_data_pipeline.segment_stats_category
2018-04-17 15:28:52,689: Parsing model.agency_data_pipeline.segment_stats_sku
2018-04-17 15:28:52,746: Found 91 models, 0 tests, 0 archives, 0 analyses, 46 macros, 0 operations
2018-04-17 15:28:53,046: 
2018-04-17 15:28:54,616: 15:28:54 | Concurrency: 4 threads (target='prod')
2018-04-17 15:28:54,617: 15:28:54 | 
2018-04-17 15:28:55,794: 15:28:55 | 1 of 91 START table model agency_data_pipeline.conversion_goals_proc. [RUN]
2018-04-17 15:28:55,795: Compiling model.agency_data_pipeline.conversion_goals_proc
2018-04-17 15:28:55,794: 15:28:55 | 2 of 91 START table model agency_data_pipeline.adwords_campaigns..... [RUN]
2018-04-17 15:28:55,806: Writing injected SQL for node "model.agency_data_pipeline.conversion_goals_proc"
2018-04-17 15:28:55,806: Compiling model.agency_data_pipeline.adwords_campaigns
2018-04-17 15:28:55,795: 15:28:55 | 3 of 91 START table model agency_data_pipeline.accounts_proc......... [RUN]
2018-04-17 15:28:55,823: Compiling model.agency_data_pipeline.accounts_proc
2018-04-17 15:28:55,795: 15:28:55 | 4 of 91 START table model agency_data_pipeline.all_dates............. [RUN]
2018-04-17 15:28:55,841: Compiling model.agency_data_pipeline.all_dates
2018-04-17 15:28:55,823: Writing injected SQL for node "model.agency_data_pipeline.adwords_campaigns"
2018-04-17 15:28:55,840: Writing injected SQL for node "model.agency_data_pipeline.accounts_proc"
2018-04-17 15:28:55,816: Acquiring new bigquery connection "conversion_goals_proc".
2018-04-17 15:28:55,853: Opening a new connection (1 currently allocated)
2018-04-17 15:28:55,852: Writing injected SQL for node "model.agency_data_pipeline.all_dates"
2018-04-17 15:28:55,955: Acquiring new bigquery connection "accounts_proc".
2018-04-17 15:28:55,956: Opening a new connection (2 currently allocated)
2018-04-17 15:28:55,960: Acquiring new bigquery connection "adwords_campaigns".
2018-04-17 15:28:56,027: Opening a new connection (3 currently allocated)
2018-04-17 15:28:56,033: Acquiring new bigquery connection "all_dates".
2018-04-17 15:28:56,040: Opening a new connection (4 currently allocated)
2018-04-17 15:28:57,605: Model SQL (all_dates):
SELECT 
date_in_range,
unix_date(date_in_range) unix_date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-04-17 15:28:57,628: Model SQL (conversion_goals_proc):
select 
client,
platform,
goal_name,
max(goal_type) goal_type,
account,
max(time_of_entry) time_of_entry
from  ( 

SELECT  
client,
platform,
trim(replace(replace(lower(goal_name),',',''),' ','')) goal_name,
goal_type,
account,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY platform ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.conversion_goals` 

) 

WHERE lv = time_of_entry
group by client, platform, account, goal_name
2018-04-17 15:28:57,629: Model SQL (accounts_proc):
select 
client,
account,
platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.accounts` 

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-04-17 15:28:57,644: Model SQL (adwords_campaigns):
select
day,
campaignid, 
campaign,
account, 
channel,
platform,
sum(cost) cost,
sum(impressions) impressions,
sum(clicks) clicks,
sum(impression_share_num) impression_share_num,
sum(impression_share_den) impression_share_den
from 
  ( 
	SELECT  
	day,
	campaignid,
	campaign,
	account as account,
	'Paid' as channel,
	'Adwords' as platform,
	cost/1000000 cost, 
	impressions as impressions, 
	clicks, 
	case when searchimprshare is not null then impressions end as impression_share_num,
	case when searchimprshare is not null then impressions/(searchimprshare/100) end as impression_share_den,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY campaignid, day ORDER BY _sdc_sequence DESC) lv
	FROM `growth-engines-pipeline.adwords_2.CAMPAIGN_PERFORMANCE_REPORT`
  )
where lv = _sdc_sequence
group by day, campaignid, account, channel, platform, campaign
2018-04-17 15:28:58,765: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '884364d4-2ee1-4493-a0fc-89964b698240', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1070f3b00>]}
2018-04-17 15:28:59,116: 15:28:59 | 4 of 91 OK created table model agency_data_pipeline.all_dates........ [CREATE TABLE in 2.92s]
2018-04-17 15:28:59,116: 15:28:59 | 5 of 91 START table model agency_data_pipeline.ga_conversions........ [RUN]
2018-04-17 15:28:59,116: Compiling model.agency_data_pipeline.ga_conversions
2018-04-17 15:28:59,122: Writing injected SQL for node "model.agency_data_pipeline.ga_conversions"
2018-04-17 15:28:59,125: Acquiring new bigquery connection "ga_conversions".
2018-04-17 15:28:59,125: Re-using an available connection from the pool.
2018-04-17 15:28:59,897: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '884364d4-2ee1-4493-a0fc-89964b698240', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104d790b8>]}
2018-04-17 15:28:59,913: Model SQL (ga_conversions):
select 
client,
client_name,
platform,
goal_name,
goal_type,
account,
time_of_entry
from  ( 

SELECT  
client,
client_name,
platform,
trim(goal_name) goal_name,
goal_type,
account,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform, goal_name ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.conversion_goals` 
WHERE platform = 'Google Analytics'

) 

WHERE lv = time_of_entry
2018-04-17 15:28:59,922: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '884364d4-2ee1-4493-a0fc-89964b698240', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1070fa3c8>]}
2018-04-17 15:29:00,162: 15:29:00 | 1 of 91 OK created table model agency_data_pipeline.conversion_goals_proc [CREATE TABLE in 4.10s]
2018-04-17 15:29:00,164: 15:29:00 | 6 of 91 START table model agency_data_pipeline.monthend_dates........ [RUN]
2018-04-17 15:29:00,166: Compiling model.agency_data_pipeline.monthend_dates
2018-04-17 15:29:00,173: Writing injected SQL for node "model.agency_data_pipeline.monthend_dates"
2018-04-17 15:29:00,174: Acquiring new bigquery connection "monthend_dates".
2018-04-17 15:29:00,175: Re-using an available connection from the pool.
2018-04-17 15:29:00,419: 15:29:00 | 3 of 91 OK created table model agency_data_pipeline.accounts_proc.... [CREATE TABLE in 4.10s]
2018-04-17 15:29:00,420: 15:29:00 | 7 of 91 START table model agency_data_pipeline.bing_ads_impression_share [RUN]
2018-04-17 15:29:00,420: Compiling model.agency_data_pipeline.bing_ads_impression_share
2018-04-17 15:29:00,435: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_impression_share"
2018-04-17 15:29:00,439: Acquiring new bigquery connection "bing_ads_impression_share".
2018-04-17 15:29:00,439: Re-using an available connection from the pool.
2018-04-17 15:29:01,006: Model SQL (monthend_dates):
SELECT
date_in_range,
date_in_range_bom,
date_in_range_bom_mom,
unix_date_in_range,
unix_date_in_range_bom,
unix_date(date_in_range_bom_mom) unix_date_in_range_bom_mom,
yyyymm,
date_in_range_yoy,
unix_date(date_in_range_yoy) unix_date_in_range_yoy

FROM
(
	SELECT 
	date_in_range,
	date_in_range_bom,
	date_sub(date_in_range_bom, INTERVAL 1 MONTH) date_in_range_bom_mom,
  date_sub(date_in_range, INTERVAL 1 YEAR) date_in_range_yoy,
	unix_date_in_range,
	unix_date(date_in_range_bom) unix_date_in_range_bom,
	yyyymm,
	first_value(date_in_range) over (partition by yyyymm order by date_in_range desc) monthend_date_in_range
	FROM
	( 
		SELECT 
		date_in_range,
		date_trunc( date_in_range, MONTH) date_in_range_bom,
		unix_date(date_in_range) unix_date_in_range,
		format_date("%Y-%m", date_in_range) AS yyyymm
		FROM UNNEST(
		    GENERATE_DATE_ARRAY(DATE('2016-01-31'), CURRENT_DATE(), INTERVAL 1 DAY)
		) AS date_in_range
	)
)
where date_in_range = monthend_date_in_range
2018-04-17 15:29:01,052: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '884364d4-2ee1-4493-a0fc-89964b698240', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1070f3b00>]}
2018-04-17 15:29:01,281: Model SQL (bing_ads_impression_share):
SELECT 
date, 
account,
channel,
platform,
sum(impressions) impressions,
sum(available_impressions) available_impressions
FROM

(

SELECT  
cast(gregoriandate as date) date,
replace(accountname,',','') account,  
'Paid' as channel,
'Bing Ads' as platform,
case when impressionsharepercent is null then 0 else impressions end as impressions,
cast(round(case when ( impressionsharepercent is not null and impressionsharepercent > 0 ) then (impressions*100)/impressionsharepercent else 0 end) as int64) as available_impressions,
_sdc_sequence,
first_value(_sdc_sequence) OVER (PARTITION BY campaignid, gregoriandate ORDER BY _sdc_sequence DESC) lv
FROM `growth-engines-pipeline.bing_ads.campaign_performance_report` 

)

where lv = _sdc_sequence
group by date, account, channel, platform
2018-04-17 15:29:01,711: 15:29:01 | 5 of 91 OK created table model agency_data_pipeline.ga_conversions... [CREATE TABLE in 1.94s]
2018-04-17 15:29:01,711: 15:29:01 | 8 of 91 START table model agency_data_pipeline.adwords_conversions... [RUN]
2018-04-17 15:29:01,711: Compiling model.agency_data_pipeline.adwords_conversions
2018-04-17 15:29:01,718: Writing injected SQL for node "model.agency_data_pipeline.adwords_conversions"
2018-04-17 15:29:01,719: Acquiring new bigquery connection "adwords_conversions".
2018-04-17 15:29:01,719: Re-using an available connection from the pool.
2018-04-17 15:29:02,302: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '884364d4-2ee1-4493-a0fc-89964b698240', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1070f3e80>]}
2018-04-17 15:29:02,561: Model SQL (adwords_conversions):
select 
client,
client_name,
platform,
goal_name,
goal_type,
account,
time_of_entry
from  ( 

SELECT  
client,
client_name,
platform,
trim(lower(goal_name)) goal_name,
goal_type,
account,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform, goal_name ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.conversion_goals` 
WHERE platform = 'Adwords'

) 

WHERE lv = time_of_entry
2018-04-17 15:29:02,564: 15:29:02 | 2 of 91 OK created table model agency_data_pipeline.adwords_campaigns [CREATE TABLE in 6.50s]
2018-04-17 15:29:02,565: 15:29:02 | 9 of 91 START table model agency_data_pipeline.carts_proc............ [RUN]
2018-04-17 15:29:02,565: Compiling model.agency_data_pipeline.carts_proc
2018-04-17 15:29:02,571: Writing injected SQL for node "model.agency_data_pipeline.carts_proc"
2018-04-17 15:29:02,572: Acquiring new bigquery connection "carts_proc".
2018-04-17 15:29:02,572: Re-using an available connection from the pool.
2018-04-17 15:29:02,578: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '884364d4-2ee1-4493-a0fc-89964b698240', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104d79dd8>]}
2018-04-17 15:29:02,817: 15:29:02 | 7 of 91 OK created table model agency_data_pipeline.bing_ads_impression_share [CREATE TABLE in 2.16s]
2018-04-17 15:29:02,818: 15:29:02 | 10 of 91 START table model agency_data_pipeline.adwords_urls......... [RUN]
2018-04-17 15:29:02,818: Compiling model.agency_data_pipeline.adwords_urls
2018-04-17 15:29:02,824: Writing injected SQL for node "model.agency_data_pipeline.adwords_urls"
2018-04-17 15:29:02,825: Acquiring new bigquery connection "adwords_urls".
2018-04-17 15:29:02,825: Re-using an available connection from the pool.
2018-04-17 15:29:03,270: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '884364d4-2ee1-4493-a0fc-89964b698240', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1070f35c0>]}
2018-04-17 15:29:03,361: Model SQL (carts_proc):
select 
client,
client_name,
account,
platform
from  ( 

SELECT  
client,
client_name,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.accounts`
WHERE platform in ('Shopify', 'Custom cart')

) 

WHERE lv = time_of_entry
2018-04-17 15:29:03,530: 15:29:03 | 6 of 91 OK created table model agency_data_pipeline.monthend_dates... [CREATE TABLE in 3.10s]
2018-04-17 15:29:03,531: 15:29:03 | 11 of 91 START table model agency_data_pipeline.bing_ads_ads......... [RUN]
2018-04-17 15:29:03,531: Compiling model.agency_data_pipeline.bing_ads_ads
2018-04-17 15:29:03,540: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_ads"
2018-04-17 15:29:03,540: Acquiring new bigquery connection "bing_ads_ads".
2018-04-17 15:29:03,540: Re-using an available connection from the pool.
2018-04-17 15:29:03,658: Model SQL (adwords_urls):
SELECT
campaignid,
lower(trim(regexp_replace(replace(replace(replace(replace(finalurl,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url

FROM (

SELECT  
campaignid,
finalurl,
first_value(finalurl) OVER (PARTITION BY campaignid ORDER BY day DESC) lv
FROM `growth-engines-pipeline.adwords_2.FINAL_URL_REPORT`
)

WHERE lv = finalurl
group by campaignid, url
order by campaignid asc
2018-04-17 15:29:03,699: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '884364d4-2ee1-4493-a0fc-89964b698240', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1070f3b00>]}
2018-04-17 15:29:04,004: 15:29:04 | 8 of 91 OK created table model agency_data_pipeline.adwords_conversions [CREATE TABLE in 1.99s]
2018-04-17 15:29:04,004: 15:29:04 | 12 of 91 START table model agency_data_pipeline.clients_proc......... [RUN]
2018-04-17 15:29:04,005: Compiling model.agency_data_pipeline.clients_proc
2018-04-17 15:29:04,010: Writing injected SQL for node "model.agency_data_pipeline.clients_proc"
2018-04-17 15:29:04,011: Acquiring new bigquery connection "clients_proc".
2018-04-17 15:29:04,011: Re-using an available connection from the pool.
2018-04-17 15:29:04,392: Model SQL (bing_ads_ads):
select
date, 
account, 
channel,
platform,
campaignid,
campaignname,
max(lower(trim(replace(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$','' ),'.html',''),'/'))) as url,
utm_campaign,
sum(cost) as cost,
sum(impressions) as impressions,
sum(clicks) as clicks,
sum(conversions) as conversions
from 
  ( 
SELECT  
cast(gregoriandate as date) date,
replace(accountname,',','') account,
'Paid' as channel,
'Bing Ads' as platform,
adid,
adtype,
campaignid, 
campaignname,
finalurl url,
case when regexp_contains(destinationurl, 'utm_campaign')
	then replace(lower(nullif(
  

    split(
        
  

    split(
        destinationurl,
        'utm_campaign='
        )[offset(1)]


,
        '&'
        )[offset(0)]


,'')),'+',' ') 
	else null end as utm_campaign,
spend cost, 
impressions, 
clicks, 
conversions,
_sdc_sequence,
first_value(_sdc_sequence) OVER (PARTITION BY adid, gregoriandate ORDER BY _sdc_sequence DESC) lv
FROM `growth-engines-pipeline.bing_ads.ad_performance_report` 
  )

where lv = _sdc_sequence
group by date, account, channel, platform, campaignid, campaignname, utm_campaign
2018-04-17 15:29:04,483: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '884364d4-2ee1-4493-a0fc-89964b698240', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1070f3e80>]}
2018-04-17 15:29:04,777: Model SQL (clients_proc):
select 
client,
client_name,
account,
platform
from  ( 

SELECT  
client,
client_name,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.accounts`
where client_name != ''
) 

WHERE lv = time_of_entry
2018-04-17 15:29:04,860: 15:29:04 | 9 of 91 OK created table model agency_data_pipeline.carts_proc....... [CREATE TABLE in 1.92s]
2018-04-17 15:29:05,919: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '884364d4-2ee1-4493-a0fc-89964b698240', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104d79dd8>]}
2018-04-17 15:29:06,168: 15:29:06 | 10 of 91 OK created table model agency_data_pipeline.adwords_urls.... [CREATE TABLE in 3.10s]
2018-04-17 15:29:06,717: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '884364d4-2ee1-4493-a0fc-89964b698240', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1071370b8>]}
2018-04-17 15:29:07,032: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '884364d4-2ee1-4493-a0fc-89964b698240', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1070f3b00>]}
2018-04-17 15:29:07,068: 15:29:07 | 11 of 91 OK created table model agency_data_pipeline.bing_ads_ads.... [CREATE TABLE in 3.19s]
2018-04-17 15:29:07,393: 15:29:07 | 12 of 91 OK created table model agency_data_pipeline.clients_proc.... [CREATE TABLE in 3.03s]
2018-04-17 15:29:07,394: 15:29:07 | 13 of 91 START table model agency_data_pipeline.fb_ads_insights...... [RUN]
2018-04-17 15:29:07,394: 15:29:07 | 14 of 91 START table model agency_data_pipeline.fb_ads_insights_conversions [RUN]
2018-04-17 15:29:07,394: 15:29:07 | 15 of 91 START table model agency_data_pipeline.shopify_refunds_proc. [RUN]
2018-04-17 15:29:07,394: 15:29:07 | 16 of 91 START table model agency_data_pipeline.mappings_ga_proc..... [RUN]
2018-04-17 15:29:07,394: Compiling model.agency_data_pipeline.fb_ads_insights
2018-04-17 15:29:07,395: Compiling model.agency_data_pipeline.fb_ads_insights_conversions
2018-04-17 15:29:07,395: Compiling model.agency_data_pipeline.shopify_refunds_proc
2018-04-17 15:29:07,395: Compiling model.agency_data_pipeline.mappings_ga_proc
2018-04-17 15:29:07,406: Acquiring new bigquery connection "fb_ads_insights_conversions".
2018-04-17 15:29:07,407: Acquiring new bigquery connection "fb_ads_insights".
2018-04-17 15:29:07,412: Acquiring new bigquery connection "shopify_refunds_proc".
2018-04-17 15:29:07,418: Writing injected SQL for node "model.agency_data_pipeline.mappings_ga_proc"
2018-04-17 15:29:07,418: Re-using an available connection from the pool.
2018-04-17 15:29:07,419: Fetching data for query fb_ads_insights_conversions:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 15:29:07,419: Re-using an available connection from the pool.
2018-04-17 15:29:07,421: Fetching data for query fb_ads_insights:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 15:29:07,421: Re-using an available connection from the pool.
2018-04-17 15:29:07,422: Acquiring new bigquery connection "mappings_ga_proc".
2018-04-17 15:29:07,422: Fetching data for query shopify_refunds_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 15:29:07,424: Re-using an available connection from the pool.
2018-04-17 15:29:08,408: Model SQL (mappings_ga_proc):
select 
client,
account,
client_name,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
account,
client_name,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.mappings_ga` 

) 

WHERE lv = time_of_entry
and client in (select client from `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc` )
group by client, account, client_name, source, medium, platform_n, channel_n, time_of_entry
2018-04-17 15:29:08,684: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_insights"
2018-04-17 15:29:08,806: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_insights_conversions"
2018-04-17 15:29:08,905: Writing injected SQL for node "model.agency_data_pipeline.shopify_refunds_proc"
2018-04-17 15:29:09,512: Model SQL (fb_ads_insights):




with fb_ads_insights as (

	    
		   	SELECT 
			date_start,
			campaign_id,
			campaign_name,
			ad_id,
			account_name,
			spend,
			reach,
			inline_link_clicks,
			_sdc_sequence,
			first_value(_sdc_sequence) OVER (PARTITION BY date_start, ad_id, campaign_id ORDER BY _sdc_sequence DESC) lv
			FROM `growth-engines-pipeline.fb_ads_luca_danni.ads_insights`
		    
	   

)

select
date_start date,
campaign_id,
campaign_name campaign,
ad_id,
account_name account,
max(spend) cost,
max(reach) impressions,
max(inline_link_clicks) clicks
from fb_ads_insights
where lv = _sdc_sequence
group by date, campaign_id, ad_id, account, campaign


2018-04-17 15:29:09,564: Model SQL (fb_ads_insights_conversions):




with fb_ads_insights_conversions as (

	    
		   	SELECT 
			date_start,
			campaign_id,
			campaign_name,
			ad_id,
			account_name,
			spend,
			reach,
			inline_link_clicks,
			_sdc_sequence,
			action_type,
			value
			FROM `growth-engines-pipeline.fb_ads_luca_danni.ads_insights`
			cross join unnest(actions)
		    
	   

)

SELECT * 
FROM 
	(
    SELECT
    date_start date,
    campaign_id,
    campaign_name campaign,
    ad_id,
    account_name account,
    action_type,
    value conversions,
    first_value(_sdc_sequence) OVER (PARTITION BY ad_id, date_start ORDER BY _sdc_sequence DESC) lv,
    _sdc_sequence
    FROM fb_ads_insights_conversions
   	)
where lv = _sdc_sequence
and action_type like '%purchase%'


2018-04-17 15:29:09,848: Model SQL (shopify_refunds_proc):




with refunds as (

	
	SELECT
	order_number,
	checkout_id,
	financial_status,
	line_item_id,
	quantity,
	subtotal,
	line_item.variant_id variant_id,
	line_item.id refund_id,
 	_sdc_sequence
	FROM `growth-engines-pipeline.shopify_lucadanni.orders` 
	cross join unnest(refunds), unnest(refund_line_items)
  	where financial_status like '%refund%'
	
	

)

SELECT * 
FROM 
	(
    SELECT
	order_number,
	checkout_id,
	financial_status,
	line_item_id,
	quantity,
	subtotal refund_amount,
	variant_id,
	refund_id,
 	_sdc_sequence,
    first_value(_sdc_sequence) OVER (PARTITION BY order_number, line_item_id ORDER BY _sdc_sequence DESC) lv
    FROM refunds
   	) 
WHERE lv = _sdc_sequence


2018-04-17 15:29:10,684: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '884364d4-2ee1-4493-a0fc-89964b698240', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104c812b0>]}
2018-04-17 15:29:10,945: 15:29:10 | 16 of 91 OK created table model agency_data_pipeline.mappings_ga_proc [CREATE TABLE in 3.29s]
2018-04-17 15:29:10,946: 15:29:10 | 17 of 91 START table model agency_data_pipeline.adwords_ads.......... [RUN]
2018-04-17 15:29:10,946: Compiling model.agency_data_pipeline.adwords_ads
2018-04-17 15:29:10,953: Writing injected SQL for node "model.agency_data_pipeline.adwords_ads"
2018-04-17 15:29:10,955: Acquiring new bigquery connection "adwords_ads".
2018-04-17 15:29:10,955: Re-using an available connection from the pool.
2018-04-17 15:29:11,563: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '884364d4-2ee1-4493-a0fc-89964b698240', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107108fd0>]}
2018-04-17 15:29:11,818: 15:29:11 | 15 of 91 OK created table model agency_data_pipeline.shopify_refunds_proc [CREATE TABLE in 4.17s]
2018-04-17 15:29:11,818: 15:29:11 | 18 of 91 START table model agency_data_pipeline.fb_adcreative........ [RUN]
2018-04-17 15:29:11,819: Compiling model.agency_data_pipeline.fb_adcreative
2018-04-17 15:29:11,830: Acquiring new bigquery connection "fb_adcreative".
2018-04-17 15:29:11,831: Re-using an available connection from the pool.
2018-04-17 15:29:11,831: Fetching data for query fb_adcreative:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 15:29:12,299: Model SQL (adwords_ads):
SELECT  
day,
campaignid,
a.account as account,
utm_campaign,
sum( case when b.goal_type = 'Transaction' then conversions else 0 end ) as transactions
FROM (

	SELECT  
	day,
	adid,
	campaignid,
	account,
	lower(conversionname) conversionname,
	conversions,
	lower(campaign) utm_campaign,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY campaignid, day ORDER BY _sdc_sequence DESC) lv
	FROM
	`growth-engines-pipeline.adwords_2.AD_PERFORMANCE_REPORT`

) a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_conversions` b
ON ( a.conversionname = b.goal_name
	AND a.account = b.account )
WHERE lv = _sdc_sequence
group by day, campaignid, account, utm_campaign
2018-04-17 15:29:12,306: Writing injected SQL for node "model.agency_data_pipeline.fb_adcreative"
2018-04-17 15:29:12,922: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '884364d4-2ee1-4493-a0fc-89964b698240', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104d79e10>]}
2018-04-17 15:29:13,148: Model SQL (fb_adcreative):




with fb_adcreative as (


	    
		   	SELECT 
			id,
			object_url,
			url_tags,
			_sdc_sequence
			FROM `growth-engines-pipeline.fb_ads_luca_danni.adcreative`
		    
	   
)

select creative_id, max(url) url
from (
  select
  id creative_id,
  lower(trim(regexp_replace(replace(replace(replace(replace(object_url,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
  first_value(_sdc_sequence) OVER (PARTITION BY id ORDER BY _sdc_sequence DESC) lv,
  _sdc_sequence
  from fb_adcreative
  )
where lv = _sdc_sequence
group by creative_id


2018-04-17 15:29:13,180: 15:29:13 | 13 of 91 OK created table model agency_data_pipeline.fb_ads_insights. [CREATE TABLE in 5.53s]
2018-04-17 15:29:13,181: 15:29:13 | 19 of 91 START table model agency_data_pipeline.bing_ads_conversions. [RUN]
2018-04-17 15:29:13,181: Compiling model.agency_data_pipeline.bing_ads_conversions
2018-04-17 15:29:13,191: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_conversions"
2018-04-17 15:29:13,192: Acquiring new bigquery connection "bing_ads_conversions".
2018-04-17 15:29:13,192: Re-using an available connection from the pool.
2018-04-17 15:29:13,973: Model SQL (bing_ads_conversions):
SELECT
date, 
a.account account, 
a.channel channel,
a.platform platform,
campaignid,
campaignname,
sum( case when b.goal_type = 'Transactions' then conversions else 0 end ) as transactions
FROM

  ( 
SELECT  
cast(gregoriandate as date) date,
replace(accountname,',','') account,
'Paid' as channel,
'Bing Ads' as platform,
trim(replace(replace(lower(goal),',',''),' ','')) goal,
goalid,
campaignid,
campaignname,
conversions,
_sdc_sequence,
first_value(_sdc_sequence) OVER (PARTITION BY campaignid, goalid, gregoriandate ORDER BY _sdc_sequence DESC) lv
FROM `growth-engines-pipeline.bing_ads.goals_and_funnels_report` 

  ) a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`conversion_goals_proc` b
ON (
	a.account = b.account AND
	a.platform = b.platform AND
	a.goal = b.goal_name
)
where a.lv = a._sdc_sequence
group by date, account, channel, platform, campaignid, campaignname
2018-04-17 15:29:14,149: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '884364d4-2ee1-4493-a0fc-89964b698240', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107116ef0>]}
2018-04-17 15:29:14,393: 15:29:14 | 14 of 91 OK created table model agency_data_pipeline.fb_ads_insights_conversions [CREATE TABLE in 6.75s]
2018-04-17 15:29:14,394: 15:29:14 | 20 of 91 START table model agency_data_pipeline.ga_mcf_proc.......... [RUN]
2018-04-17 15:29:14,394: Compiling model.agency_data_pipeline.ga_mcf_proc
2018-04-17 15:29:14,403: Writing injected SQL for node "model.agency_data_pipeline.ga_mcf_proc"
2018-04-17 15:29:14,405: Acquiring new bigquery connection "ga_mcf_proc".
2018-04-17 15:29:14,405: Re-using an available connection from the pool.
2018-04-17 15:29:15,255: Model SQL (ga_mcf_proc):
SELECT 
date,
account,
'Google Analytics' as lookup_platform,
source_medium_path,
trim(lower(split(split(source_medium_path,'->')[SAFE_ORDINAL(1)],'/')[SAFE_ORDINAL(1)])) as source,
trim(lower(split(split(source_medium_path,'->')[SAFE_ORDINAL(1)],'/')[SAFE_ORDINAL(2)])) as medium,
first_interaction_campaign campaign,
cast(regexp_replace(transaction_id, r'#', '') as int64) transactionid,
max(first_interaction_conversions) transactions,
max(first_interaction_conversion_value) revenue
FROM `growth-engines-pipeline.agency_data_pipeline.ga_mcf`
where account in (select account from `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc` where platform = 'Google Analytics')
group by date, account, source, medium, campaign, source_medium_path, lookup_platform, transactionid
2018-04-17 15:29:15,399: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '884364d4-2ee1-4493-a0fc-89964b698240', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104d9efd0>]}
2018-04-17 15:29:15,656: 15:29:15 | 18 of 91 OK created table model agency_data_pipeline.fb_adcreative... [CREATE TABLE in 3.58s]
2018-04-17 15:29:15,685: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '884364d4-2ee1-4493-a0fc-89964b698240', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104c812b0>]}
2018-04-17 15:29:15,919: 15:29:15 | 17 of 91 OK created table model agency_data_pipeline.adwords_ads..... [CREATE TABLE in 4.74s]
2018-04-17 15:29:16,242: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '884364d4-2ee1-4493-a0fc-89964b698240', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104d80d30>]}
2018-04-17 15:29:16,591: 15:29:16 | 19 of 91 OK created table model agency_data_pipeline.bing_ads_conversions [CREATE TABLE in 3.06s]
2018-04-17 15:29:20,885: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '884364d4-2ee1-4493-a0fc-89964b698240', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107116ef0>]}
2018-04-17 15:29:21,125: 15:29:21 | 20 of 91 OK created table model agency_data_pipeline.ga_mcf_proc..... [CREATE TABLE in 6.49s]
2018-04-17 15:29:21,126: 15:29:21 | 21 of 91 START table model agency_data_pipeline.shopify_customers_proc [RUN]
2018-04-17 15:29:21,127: Compiling model.agency_data_pipeline.shopify_customers_proc
2018-04-17 15:29:21,127: 15:29:21 | 22 of 91 START table model agency_data_pipeline.fb_ads............... [RUN]
2018-04-17 15:29:21,133: Compiling model.agency_data_pipeline.fb_ads
2018-04-17 15:29:21,149: Acquiring new bigquery connection "fb_ads".
2018-04-17 15:29:21,149: Re-using an available connection from the pool.
2018-04-17 15:29:21,150: Fetching data for query fb_ads:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 15:29:21,151: Acquiring new bigquery connection "shopify_customers_proc".
2018-04-17 15:29:21,151: Re-using an available connection from the pool.
2018-04-17 15:29:21,152: Fetching data for query shopify_customers_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 15:29:21,555: Writing injected SQL for node "model.agency_data_pipeline.fb_ads"
2018-04-17 15:29:21,624: Writing injected SQL for node "model.agency_data_pipeline.shopify_customers_proc"
2018-04-17 15:29:24,708: Model SQL (fb_ads):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`fb_adcreative`





with fb_ads as (

	    
		   	SELECT 
			id ad_id,
			creative.creative_id creative_id,
			_sdc_sequence
			FROM `growth-engines-pipeline.fb_ads_luca_danni.ads`
		     
	   

)

SELECT
a.ad_id,
b.creative_id,
b.url
FROM (
    SELECT
    ad_id,
    creative_id,
    first_value(_sdc_sequence) OVER (PARTITION BY ad_id ORDER BY _sdc_sequence DESC) lv,
    _sdc_sequence
    FROM fb_ads
    ) a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`fb_adcreative` b
ON (
	a.creative_id = b.creative_id 
)
WHERE a.lv = a._sdc_sequence


2018-04-17 15:29:24,709: Model SQL (shopify_customers_proc):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc`





with customers as (

	
	SELECT
	'lucadanni' client_name,
	'Shopify' as lookup_platform,
	cast(created_at as date) created_at,
	id,
	first_name,
	last_name,
	email,
	_sdc_sequence,
	first_value(_sdc_sequence) over (partition by id, _sdc_sequence order by _sdc_sequence desc) lv
	FROM `growth-engines-pipeline.shopify_lucadanni.customers` 
	
	

)

SELECT
account,
client,
platform,
id,
min(created_at) created_at,
max(first_name) first_name,
max(last_name) last_name,
max(email) email
FROM (
	SELECT
	b.account,
	b.client,
	b.platform,
	created_at,
	id,
	first_name,
	last_name,
	email
	FROM customers a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
	ON ( a.client_name = b.client_name
	  AND a.lookup_platform = b.platform )
	where a.lv = a._sdc_sequence
)
group by account, client, platform, id

2018-04-17 15:29:26,457: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '884364d4-2ee1-4493-a0fc-89964b698240', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104d80f28>]}
2018-04-17 15:29:26,739: 15:29:26 | 22 of 91 OK created table model agency_data_pipeline.fb_ads.......... [CREATE TABLE in 5.32s]
2018-04-17 15:29:29,856: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '884364d4-2ee1-4493-a0fc-89964b698240', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104d79ef0>]}
2018-04-17 15:29:30,102: 15:29:30 | 21 of 91 OK created table model agency_data_pipeline.shopify_customers_proc [CREATE TABLE in 8.73s]
2018-04-17 15:29:30,103: 15:29:30 | 23 of 91 START table model agency_data_pipeline.agg_customers_union.. [RUN]
2018-04-17 15:29:30,104: Compiling model.agency_data_pipeline.agg_customers_union
2018-04-17 15:29:30,104: 15:29:30 | 24 of 91 START table model agency_data_pipeline.bing_ads_stats....... [RUN]
2018-04-17 15:29:30,113: Writing injected SQL for node "model.agency_data_pipeline.agg_customers_union"
2018-04-17 15:29:30,104: 15:29:30 | 25 of 91 START table model agency_data_pipeline.shopify_products_proc [RUN]
2018-04-17 15:29:30,114: Compiling model.agency_data_pipeline.bing_ads_stats
2018-04-17 15:29:30,104: 15:29:30 | 26 of 91 START table model agency_data_pipeline.ga_mcf_stats......... [RUN]
2018-04-17 15:29:30,114: Compiling model.agency_data_pipeline.shopify_products_proc
2018-04-17 15:29:30,120: Compiling model.agency_data_pipeline.ga_mcf_stats
2018-04-17 15:29:30,124: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_stats"
2018-04-17 15:29:30,137: Acquiring new bigquery connection "agg_customers_union".
2018-04-17 15:29:30,152: Re-using an available connection from the pool.
2018-04-17 15:29:30,152: Writing injected SQL for node "model.agency_data_pipeline.ga_mcf_stats"
2018-04-17 15:29:30,145: Acquiring new bigquery connection "shopify_products_proc".
2018-04-17 15:29:30,160: Re-using an available connection from the pool.
2018-04-17 15:29:30,160: Fetching data for query shopify_products_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 15:29:30,154: Acquiring new bigquery connection "bing_ads_stats".
2018-04-17 15:29:30,155: Acquiring new bigquery connection "ga_mcf_stats".
2018-04-17 15:29:30,165: Re-using an available connection from the pool.
2018-04-17 15:29:30,167: Re-using an available connection from the pool.
2018-04-17 15:29:30,558: Writing injected SQL for node "model.agency_data_pipeline.shopify_products_proc"
2018-04-17 15:29:31,096: Model SQL (agg_customers_union):
SELECT *
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`shopify_customers_proc`
2018-04-17 15:29:31,163: Model SQL (ga_mcf_stats):
SELECT  
date,
a.account account,
b.client client,
case when c.platform is null then "Unmapped" else c.platform end as platform,
case when c.channel is null then "Unmapped" else c.channel end as channel,
lower(a.source) source,
lower(a.medium) medium,
lower(campaign) campaign,
transactionid,
sum(transactions) first_touch_transactions,
sum(revenue) first_touch_revenue
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`ga_mcf_proc` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc` b 
ON ( a.account = b.account and
	a.lookup_platform = b.platform )
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc` c
ON ( lower(a.source) = c.source
  AND lower(a.medium) = c.medium 
  and a.account = c.account )
group by date, account, client, source, medium, campaign, platform, channel, transactionid
2018-04-17 15:29:31,211: Model SQL (bing_ads_stats):
select
a.date, 
a.account, 
a.channel,
a.platform,
url,
a.campaignname campaign,
utm_campaign,
cost,
clicks,
impressions,
transactions
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`bing_ads_ads` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`bing_ads_conversions` b
ON (
	a.date = b.date AND
	a.account = b.account AND
	a.campaignid = b.campaignid

)
2018-04-17 15:29:31,546: Model SQL (shopify_products_proc):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc`, `growth-engines-pipeline`.`agency_data_pipeline`.`shopify_refunds_proc`





with products as (

	
	SELECT
	'lucadanni' client_name,
	'Shopify' as lookup_platform,
	product_type,
	product_id,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY product_id ORDER BY _sdc_sequence DESC) lv
	FROM `growth-engines-pipeline.shopify_lucadanni.products` 
	cross join unnest(variants)
	
	

)

SELECT
b.account,
b.client,
b.platform,
max(product_type) product_type,
product_id
FROM products a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
ON ( a.client_name = b.client_name
  AND a.lookup_platform = b.platform )
where a.lv = a._sdc_sequence
group by product_id, account, client, platform


2018-04-17 15:29:34,017: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '884364d4-2ee1-4493-a0fc-89964b698240', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104c67f28>]}
2018-04-17 15:29:35,079: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '884364d4-2ee1-4493-a0fc-89964b698240', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107174b38>]}
2018-04-17 15:29:35,571: 15:29:35 | 25 of 91 OK created table model agency_data_pipeline.shopify_products_proc [CREATE TABLE in 3.90s]
2018-04-17 15:29:35,572: 15:29:35 | 27 of 91 START table model agency_data_pipeline.shopify_orders_proc.. [RUN]
2018-04-17 15:29:35,574: Compiling model.agency_data_pipeline.shopify_orders_proc
2018-04-17 15:29:35,583: Acquiring new bigquery connection "shopify_orders_proc".
2018-04-17 15:29:35,584: Re-using an available connection from the pool.
2018-04-17 15:29:35,584: Fetching data for query shopify_orders_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 15:29:35,839: 15:29:35 | 23 of 91 OK created table model agency_data_pipeline.agg_customers_union [CREATE TABLE in 4.98s]
2018-04-17 15:29:36,073: Writing injected SQL for node "model.agency_data_pipeline.shopify_orders_proc"
2018-04-17 15:29:36,213: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '884364d4-2ee1-4493-a0fc-89964b698240', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104d80f28>]}
2018-04-17 15:29:36,465: 15:29:36 | 26 of 91 OK created table model agency_data_pipeline.ga_mcf_stats.... [CREATE TABLE in 6.09s]
2018-04-17 15:29:36,951: Model SQL (shopify_orders_proc):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc`, `growth-engines-pipeline`.`agency_data_pipeline`.`shopify_refunds_proc`





with orders as (

	
	SELECT
	'lucadanni' client_name,
	'Shopify' as lookup_platform,
	created_at,
	order_number,
	quantity,
	cast(pre_tax_price as float64) price, 
	total_line_items_price total_order_price_undiscounted,
	total_discounts,
	cast(discounted_price as float64) total_order_shipping_price,
	total_price_usd total_order_price_incl_shipping,
	checkout_id,
	product_id, 
	landing_site,
	sku, 
	variant_title, 
	variant_id,
	_id line_item_id,
	customer.id customer_id,
	customer.orders_count orders_count,
	customer.created_at customer_created_at,
	customer.last_order_id last_order_id,
	financial_status,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY order_number, _id ORDER BY _sdc_sequence DESC) lv
	FROM `growth-engines-pipeline.shopify_lucadanni.orders` 
	cross join unnest(line_items), unnest(shipping_lines)
	where source_name != 'shopify_draft_order'
	
	

)

SELECT
b.account,
b.client,
b.platform,
created_at,
a.order_number,
a.quantity,
c.quantity refund_quantity,
case when c.quantity is not null then a.quantity - c.quantity else a.quantity end as final_quantity,
price, 
total_order_price_undiscounted,
total_discounts,
total_order_shipping_price,
total_order_price_incl_shipping,
refund_amount,
case when refund_amount is not null then price - refund_amount else price end as final_price,
a.checkout_id,
a.product_id, 
landing_site,
sku, 
variant_title, 
a.variant_id,
a.line_item_id,	
customer_id,
orders_count,
customer_created_at,
last_order_id,
a.financial_status
FROM orders a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
ON ( a.client_name = b.client_name
  AND a.lookup_platform = b.platform )
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`shopify_refunds_proc` c
ON ( a.order_number = c.order_number
	AND a.line_item_id = c.line_item_id )   	
where a.lv = a._sdc_sequence


2018-04-17 15:29:37,367: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '884364d4-2ee1-4493-a0fc-89964b698240', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104d79320>]}
2018-04-17 15:29:37,619: 15:29:37 | 24 of 91 OK created table model agency_data_pipeline.bing_ads_stats.. [CREATE TABLE in 7.25s]
2018-04-17 15:29:44,881: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '884364d4-2ee1-4493-a0fc-89964b698240', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104c67f28>]}
2018-04-17 15:29:45,133: 15:29:45 | 27 of 91 OK created table model agency_data_pipeline.shopify_orders_proc [CREATE TABLE in 9.31s]
2018-04-17 15:29:45,134: 15:29:45 | 28 of 91 START table model agency_data_pipeline.ga_traffic........... [RUN]
2018-04-17 15:29:45,135: 15:29:45 | 29 of 91 START table model agency_data_pipeline.agg_orders_union..... [RUN]
2018-04-17 15:29:45,135: 15:29:45 | 30 of 91 START table model agency_data_pipeline.agg_products......... [RUN]
2018-04-17 15:29:45,135: 15:29:45 | 31 of 91 START table model agency_data_pipeline.adwords_join......... [RUN]
2018-04-17 15:29:45,135: Compiling model.agency_data_pipeline.ga_traffic
2018-04-17 15:29:45,136: Compiling model.agency_data_pipeline.agg_orders_union
2018-04-17 15:29:45,136: Compiling model.agency_data_pipeline.agg_products
2018-04-17 15:29:45,136: Compiling model.agency_data_pipeline.adwords_join
2018-04-17 15:29:45,162: Writing injected SQL for node "model.agency_data_pipeline.agg_orders_union"
2018-04-17 15:29:45,179: Writing injected SQL for node "model.agency_data_pipeline.adwords_join"
2018-04-17 15:29:45,180: Acquiring new bigquery connection "ga_traffic".
2018-04-17 15:29:45,182: Writing injected SQL for node "model.agency_data_pipeline.agg_products"
2018-04-17 15:29:45,183: Re-using an available connection from the pool.
2018-04-17 15:29:45,183: Fetching data for query ga_traffic:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'GA Traffic'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 15:29:45,186: Acquiring new bigquery connection "agg_products".
2018-04-17 15:29:45,186: Re-using an available connection from the pool.
2018-04-17 15:29:45,188: Acquiring new bigquery connection "adwords_join".
2018-04-17 15:29:45,189: Re-using an available connection from the pool.
2018-04-17 15:29:45,192: Acquiring new bigquery connection "agg_orders_union".
2018-04-17 15:29:45,193: Re-using an available connection from the pool.
2018-04-17 15:29:46,195: Model SQL (adwords_join):
select
a.day,
a.campaignid, 
a.campaign,
a.account, 
channel,
platform,
url,
utm_campaign,
cost,
impressions,
clicks,
impression_share_num,
impression_share_den,
transactions
FROM ( 
	
	select
	day,
	a.campaign,
	a.campaignid, 
	account, 
	channel,
	platform,
	url,
	cost,
	impressions,
	clicks,
	impression_share_num,
	impression_share_den
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_campaigns` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_urls` b
	ON a.campaignid = b.campaignid

) a 
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_ads` b
ON ( a.campaignid = b.campaignid
	and a.day = b.day )
2018-04-17 15:29:46,196: Model SQL (agg_products):
SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`shopify_products_proc`
2018-04-17 15:29:46,205: Model SQL (agg_orders_union):
SELECT
account,
client,
platform,
created_at,
order_number,
quantity,
refund_quantity,
final_quantity,
price, 
total_order_price_undiscounted,
total_discounts,
total_order_shipping_price,
total_order_price_incl_shipping,
refund_amount,
final_price,
checkout_id,
product_id, 
landing_site,
sku, 
variant_title, 
variant_id,
line_item_id,	
customer_id,
orders_count,
customer_created_at,
last_order_id,
financial_status
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`shopify_orders_proc`
2018-04-17 15:29:46,418: Fetching data for query ga_traffic:


        select
            goal_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_conversions`

        
        ##where 1 = 1
        where goal_type = 'Conversion'
        
        
        
        ##and 2 = 2
        and client_name = 'lucadanni'
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 15:29:47,329: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '884364d4-2ee1-4493-a0fc-89964b698240', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1070d9080>]}
2018-04-17 15:29:47,594: Writing injected SQL for node "model.agency_data_pipeline.ga_traffic"
2018-04-17 15:29:47,600: 15:29:47 | 30 of 91 OK created table model agency_data_pipeline.agg_products.... [CREATE TABLE in 2.19s]
2018-04-17 15:29:47,603: 15:29:47 | 32 of 91 START table model agency_data_pipeline.ga_transactions...... [RUN]
2018-04-17 15:29:47,603: Compiling model.agency_data_pipeline.ga_transactions
2018-04-17 15:29:47,628: Acquiring new bigquery connection "ga_transactions".
2018-04-17 15:29:47,629: Re-using an available connection from the pool.
2018-04-17 15:29:47,629: Fetching data for query ga_transactions:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Google Analytics'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 15:29:48,430: Model SQL (ga_traffic):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc`, `growth-engines-pipeline`.`agency_data_pipeline`.`ga_conversions`


##`growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` 



with ga_report as (

	    

	    	
	    	
		   	SELECT
		   	'lucadanni' as client_name,
		   	'GA Traffic' as lookup_platform,
			lower(trim(regexp_replace(replace(replace(replace(replace(CONCAT(hostname,landingpagepath),'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
			date,
			lower(source) source,
			lower(medium) medium,
			lower(campaign) campaign,
			sessions,
			## goal completion columns
							
				goalcompletionsall as goal_completions,		
			
			_sdc_sequence,
			first_value(_sdc_sequence) OVER (PARTITION BY hostname, landingpagepath, date, source, medium, campaign ORDER BY _sdc_sequence DESC) lv
			FROM `growth-engines-pipeline.ga_lucadanni_traffic.report` 

		    
	   

)


SELECT  
cast(date as date) date,
b.account,
b.client client,
c.source source,
c.medium medium,
a.campaign campaign,
concat(a.source, ' / ', a.medium) source_medium,  
case when c.platform is null then "Unmapped" else c.platform end as platform,
case when c.channel is null then "Unmapped" else c.channel end as channel,
regexp_replace(url, r'offers.|offer.|get.|info.|pos.|go.|join.|pages.','') url,
max(sessions) sessions,
max(goal_completions) goal_completions
FROM ga_report a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
ON ( a.client_name = b.client_name 
	AND a.lookup_platform = b.platform )
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc` c
ON ( a.source = c.source
  AND a.medium = c.medium 
  AND a.client_name = c.client_name )
GROUP BY date, account, client, source, medium, campaign, source_medium, platform, channel, url


2018-04-17 15:29:49,064: Fetching data for query ga_transactions:


        select
            goal_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_conversions`

        
        ##where 1 = 1
        where goal_type = 'Conversion'
        
        
        
        ##and 2 = 2
        and client_name = 'lucadanni'
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 15:29:49,459: Writing injected SQL for node "model.agency_data_pipeline.ga_transactions"
2018-04-17 15:29:50,367: Model SQL (ga_transactions):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc`, `growth-engines-pipeline`.`agency_data_pipeline`.`ga_conversions`


##`growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` 



with ga_report as (

	    

	    	
	    	
		   	SELECT
		   	'lucadanni' as client_name,
		   	'Google Analytics' as lookup_platform,
			lower(trim(regexp_replace(replace(replace(replace(replace(CONCAT(hostname,landingpagepath),'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
			date,
			lower(source) source,
			lower(medium) medium,
			lower(campaign) campaign,
			cast(regexp_replace(transactionid, r'#', '') as int64) transactionid,
			transactions last_touch_transactions,
			(transactionrevenue - transactionshipping - transactiontax) as last_touch_revenue,
			transactionshipping,
			transactiontax,
			_sdc_sequence,
			first_value(_sdc_sequence) OVER (PARTITION BY hostname, landingpagepath, date, source, medium, transactionid ORDER BY _sdc_sequence DESC) lv
			FROM `growth-engines-pipeline.ga_lucadanni.report` 

		    
	   

)


SELECT  
cast(date as date) date,
b.account,
b.client client,
c.source source,
c.medium medium,
a.campaign campaign,
concat(a.source, ' / ', a.medium) source_medium,  
case when c.platform is null then "Unmapped" else c.platform end as platform,
case when c.channel is null then "Unmapped" else c.channel end as channel,
regexp_replace(url, r'offers.|offer.|get.|info.|pos.|go.|join.|pages.','') url,
transactionid,
max(last_touch_transactions) last_touch_transactions,
max(last_touch_revenue) last_touch_revenue,
max(transactionshipping) last_touch_shipping,
max(transactiontax) last_touch_tax
FROM ga_report a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
ON ( a.client_name = b.client_name 
	AND a.lookup_platform = b.platform )
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc` c
ON ( a.source = c.source
  AND a.medium = c.medium 
  AND a.client_name = c.client_name )
GROUP BY date, account, client, source, medium, campaign, source_medium, platform, channel, url, transactionid


2018-04-17 15:29:51,994: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '884364d4-2ee1-4493-a0fc-89964b698240', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10716beb8>]}
2018-04-17 15:29:52,238: 15:29:52 | 31 of 91 OK created table model agency_data_pipeline.adwords_join.... [CREATE TABLE in 6.86s]
2018-04-17 15:29:53,039: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '884364d4-2ee1-4493-a0fc-89964b698240', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10716b668>]}
2018-04-17 15:29:53,310: 15:29:53 | 29 of 91 OK created table model agency_data_pipeline.agg_orders_union [CREATE TABLE in 7.90s]
2018-04-17 15:29:57,159: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '884364d4-2ee1-4493-a0fc-89964b698240', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1070d9080>]}
2018-04-17 15:29:57,399: 15:29:57 | 32 of 91 OK created table model agency_data_pipeline.ga_transactions. [CREATE TABLE in 9.56s]
2018-04-17 15:29:58,516: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '884364d4-2ee1-4493-a0fc-89964b698240', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104d76b38>]}
2018-04-17 15:29:58,770: 15:29:58 | 28 of 91 OK created table model agency_data_pipeline.ga_traffic...... [CREATE TABLE in 13.38s]
2018-04-17 15:29:58,771: 15:29:58 | 33 of 91 START table model agency_data_pipeline.fb_ads_stats......... [RUN]
2018-04-17 15:29:58,772: 15:29:58 | 34 of 91 START table model agency_data_pipeline.adwords_impression_share [RUN]
2018-04-17 15:29:58,772: 15:29:58 | 35 of 91 START table model agency_data_pipeline.adwords_stats........ [RUN]
2018-04-17 15:29:58,772: 15:29:58 | 36 of 91 START table model agency_data_pipeline.agg_transaction_order_number [RUN]
2018-04-17 15:29:58,772: Compiling model.agency_data_pipeline.fb_ads_stats
2018-04-17 15:29:58,773: Compiling model.agency_data_pipeline.adwords_impression_share
2018-04-17 15:29:58,773: Compiling model.agency_data_pipeline.adwords_stats
2018-04-17 15:29:58,773: Compiling model.agency_data_pipeline.agg_transaction_order_number
2018-04-17 15:29:58,784: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_stats"
2018-04-17 15:29:58,799: Writing injected SQL for node "model.agency_data_pipeline.adwords_impression_share"
2018-04-17 15:29:58,806: Writing injected SQL for node "model.agency_data_pipeline.adwords_stats"
2018-04-17 15:29:58,808: Writing injected SQL for node "model.agency_data_pipeline.agg_transaction_order_number"
2018-04-17 15:29:58,809: Acquiring new bigquery connection "adwords_impression_share".
2018-04-17 15:29:58,810: Acquiring new bigquery connection "fb_ads_stats".
2018-04-17 15:29:58,810: Re-using an available connection from the pool.
2018-04-17 15:29:58,811: Acquiring new bigquery connection "adwords_stats".
2018-04-17 15:29:58,811: Re-using an available connection from the pool.
2018-04-17 15:29:58,812: Acquiring new bigquery connection "agg_transaction_order_number".
2018-04-17 15:29:58,815: Re-using an available connection from the pool.
2018-04-17 15:29:58,818: Re-using an available connection from the pool.
2018-04-17 15:29:59,816: Model SQL (fb_ads_stats):
with cost as (

    select 
        date, account, ad_id, campaign,
        cost, impressions, clicks, null as conversions
    from `growth-engines-pipeline`.`agency_data_pipeline`.`fb_ads_insights`
),

conversions as (

    select 
        date, account, ad_id, campaign,
        null as cost, null as impressions, null as clicks, conversions
    from `growth-engines-pipeline`.`agency_data_pipeline`.`fb_ads_insights_conversions`
),

urls as (

    select ad_id, url
    from `growth-engines-pipeline`.`agency_data_pipeline`.`fb_ads`
)


SELECT
    cast(date as date) date,
    'FB Ads' platform,
    'Paid' channel,
    account, 
    b.url url,
    campaign,
    lower(campaign) utm_campaign, 
    sum(cost) cost,
    sum(impressions) impressions,
    sum(clicks) clicks,
    sum(conversions) transactions
FROM
(
    SELECT *
    FROM 
      cost
    UNION ALL
    SELECT *
    FROM 
      conversions
) a
LEFT JOIN urls b
ON ( a.ad_id = b.ad_id )
group by date, platform, channel, account, url, campaign, utm_campaign
2018-04-17 15:29:59,817: Model SQL (agg_transaction_order_number):
SELECT
client,
cast(created_at as date) date,
order_number,
customer_id,
sum(final_quantity) final_quantity,
sum(final_price) final_price,
max(total_order_shipping_price) shipping_price
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`agg_orders_union`
GROUP BY client, created_at, order_number, customer_id
2018-04-17 15:29:59,818: Model SQL (adwords_impression_share):
SELECT 
cast(day as date) date, 
account, 
channel,
platform,
sum(impression_share_num) impressions,
sum(impression_share_den) available_impressions
FROM 
  `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_join`
group by date, account, platform, channel
2018-04-17 15:29:59,819: Model SQL (adwords_stats):
SELECT 
cast(day as date) date, 
account, 
platform,
channel,
url,
utm_campaign,
campaign,
sum(cost) cost,
sum(impressions) impressions,
sum(clicks) clicks,
sum(transactions) transactions
FROM 
  `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_join`
group by date, account, platform, channel, url, campaign, utm_campaign
2018-04-17 15:30:00,949: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '884364d4-2ee1-4493-a0fc-89964b698240', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104d80f28>]}
2018-04-17 15:30:01,211: 15:30:01 | 34 of 91 OK created table model agency_data_pipeline.adwords_impression_share [CREATE TABLE in 2.18s]
2018-04-17 15:30:01,212: 15:30:01 | 37 of 91 START table model agency_data_pipeline.agg_transaction_line_item [RUN]
2018-04-17 15:30:01,212: Compiling model.agency_data_pipeline.agg_transaction_line_item
2018-04-17 15:30:01,221: Writing injected SQL for node "model.agency_data_pipeline.agg_transaction_line_item"
2018-04-17 15:30:01,224: Acquiring new bigquery connection "agg_transaction_line_item".
2018-04-17 15:30:01,224: Re-using an available connection from the pool.
2018-04-17 15:30:02,111: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '884364d4-2ee1-4493-a0fc-89964b698240', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104c67f28>]}
2018-04-17 15:30:02,232: Model SQL (agg_transaction_line_item):
SELECT
client,
created_at,
order_number,
quantity,
refund_quantity,
final_quantity,
price, 
total_order_price_undiscounted,
total_discounts,
total_order_shipping_price,
total_order_price_incl_shipping,
refund_amount,
final_price,
checkout_id,
product_id, 
landing_site,
sku, 
variant_title, 
variant_id,
line_item_id,	
customer_id,
orders_count,
customer_created_at,
last_order_id,
financial_status
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`agg_orders_union`
2018-04-17 15:30:02,778: 15:30:02 | 33 of 91 OK created table model agency_data_pipeline.fb_ads_stats.... [CREATE TABLE in 3.34s]
2018-04-17 15:30:03,250: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '884364d4-2ee1-4493-a0fc-89964b698240', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104d95eb8>]}
2018-04-17 15:30:03,492: 15:30:03 | 36 of 91 OK created table model agency_data_pipeline.agg_transaction_order_number [CREATE TABLE in 4.48s]
2018-04-17 15:30:05,464: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '884364d4-2ee1-4493-a0fc-89964b698240', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104d9e5c0>]}
2018-04-17 15:30:05,704: 15:30:05 | 35 of 91 OK created table model agency_data_pipeline.adwords_stats... [CREATE TABLE in 6.69s]
2018-04-17 15:30:08,981: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '884364d4-2ee1-4493-a0fc-89964b698240', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104d80f28>]}
2018-04-17 15:30:09,288: 15:30:09 | 37 of 91 OK created table model agency_data_pipeline.agg_transaction_line_item [CREATE TABLE in 7.77s]
2018-04-17 15:30:09,289: 15:30:09 | 38 of 91 START table model agency_data_pipeline.customers_by_transaction [RUN]
2018-04-17 15:30:09,289: Compiling model.agency_data_pipeline.customers_by_transaction
2018-04-17 15:30:09,298: Writing injected SQL for node "model.agency_data_pipeline.customers_by_transaction"
2018-04-17 15:30:09,299: Acquiring new bigquery connection "customers_by_transaction".
2018-04-17 15:30:09,299: Re-using an available connection from the pool.
2018-04-17 15:30:10,360: Model SQL (customers_by_transaction):
SELECT
client,
customer_id,
order_number,
order_date,
first_order_date,
case when first_order_number = order_number then 'New' else 'Existing' end as order_type,
final_price,
first_order_revenue,
lifetime_revenue
FROM

(

	SELECT
	client,
	customer_id,
	order_number,
	date order_date,
	first_value(date) over w1 first_order_date,
	first_value(order_number) over w1 first_order_number,
	first_value(final_price) over w1 first_order_revenue,
    final_price,
	sum(final_price) over w2 lifetime_revenue
	FROM
    `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_order_number`
	WINDOW w1 as (PARTITION BY client, customer_id ORDER BY date desc),
	w2 as (PARTITION BY client, customer_id)
)
2018-04-17 15:30:14,862: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '884364d4-2ee1-4493-a0fc-89964b698240', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104d76b38>]}
2018-04-17 15:30:15,497: 15:30:15 | 38 of 91 OK created table model agency_data_pipeline.customers_by_transaction [CREATE TABLE in 5.57s]
2018-04-17 15:30:15,498: 15:30:15 | 39 of 91 START table model agency_data_pipeline.agg_ga_transaction_order_number [RUN]
2018-04-17 15:30:15,498: 15:30:15 | 40 of 91 START table model agency_data_pipeline.frequency_proc....... [RUN]
2018-04-17 15:30:15,499: Compiling model.agency_data_pipeline.agg_ga_transaction_order_number
2018-04-17 15:30:15,499: Compiling model.agency_data_pipeline.frequency_proc
2018-04-17 15:30:15,511: Writing injected SQL for node "model.agency_data_pipeline.agg_ga_transaction_order_number"
2018-04-17 15:30:15,520: Writing injected SQL for node "model.agency_data_pipeline.frequency_proc"
2018-04-17 15:30:15,524: Acquiring new bigquery connection "agg_ga_transaction_order_number".
2018-04-17 15:30:15,524: Re-using an available connection from the pool.
2018-04-17 15:30:15,530: Acquiring new bigquery connection "frequency_proc".
2018-04-17 15:30:15,531: Re-using an available connection from the pool.
2018-04-17 15:30:16,397: Model SQL (frequency_proc):
WITH transactions AS (

  	SELECT 
	client,
	customer_id,
	order_number,
	date,
	unix_date(date) d
	FROM
	`growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_order_number`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)

SELECT 
client,
'Rolling 365' as period,
date_in_range date,
unix_date_in_range, 
customer_id,
count(distinct(order_number)) frequency
FROM daterange
JOIN transactions
ON transactions.d > ( daterange.unix_date_in_range - 365 )
AND transactions.d <= daterange.unix_date_in_range
group by client, unix_date_in_range, customer_id, date
2018-04-17 15:30:16,603: Model SQL (agg_ga_transaction_order_number):
with ga as (

    select 
        date, account, client, 
        channel as last_touch_channel, 
        platform as last_touch_platform, 
        url as last_touch_url, 
        campaign as last_touch_utm_campaign, 
        '' as first_touch_channel, 
        '' as first_touch_platform, 
        '' as first_touch_utm_campaign, 
        transactionid,
        last_touch_transactions, last_touch_revenue,
        last_touch_shipping, last_touch_tax,
        null as first_touch_transactions, null as first_touch_revenue
    from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_transactions`

),

ga_mcf as (

    select 
        date, account, client, 
        '' as last_touch_channel,
        '' as last_touch_platform,
        '' as last_touch_url,
        '' as last_touch_utm_campaign, 
        channel as first_touch_channel, 
        platform as first_touch_platform, 
        campaign as first_touch_utm_campaign, 
        transactionid, 
        null as last_touch_transactions, null as last_touch_revenue,
        null as last_touch_shipping, null as last_touch_tax,
        first_touch_transactions, first_touch_revenue
    from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_mcf_stats`

)


SELECT
    date, 
    client,
    transactionid,
    max(last_touch_channel) last_touch_channel, 
    max(last_touch_platform) last_touch_platform, 
    max(last_touch_url) last_touch_url, 
    max(last_touch_utm_campaign) last_touch_utm_campaign, 
    max(first_touch_channel) first_touch_channel, 
    max(first_touch_platform) first_touch_platform, 
    max(first_touch_utm_campaign) first_touch_utm_campaign,
    sum(last_touch_transactions) last_touch_transactions,
    sum(last_touch_revenue) last_touch_revenue,
    sum(last_touch_shipping) last_touch_shipping_revenue,
    sum(last_touch_tax) last_touch_tax_revenue,
    sum(first_touch_transactions) first_touch_transactions,
    sum(first_touch_revenue) - ifnull(sum(last_touch_shipping),0) - ifnull(sum(last_touch_tax),0) first_touch_revenue
FROM
(
    SELECT *
    FROM 
      ga
    UNION ALL
    SELECT *
    FROM 
      ga_mcf
) 
GROUP BY
    date, client, transactionid
2018-04-17 15:30:22,249: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '884364d4-2ee1-4493-a0fc-89964b698240', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104d80f28>]}
2018-04-17 15:30:22,518: 15:30:22 | 39 of 91 OK created table model agency_data_pipeline.agg_ga_transaction_order_number [CREATE TABLE in 6.75s]
2018-04-17 15:30:29,783: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '884364d4-2ee1-4493-a0fc-89964b698240', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10717b390>]}
2018-04-17 15:30:30,070: 15:30:30 | 40 of 91 OK created table model agency_data_pipeline.frequency_proc.. [CREATE TABLE in 14.28s]
2018-04-17 15:30:30,071: 15:30:30 | 41 of 91 START table model agency_data_pipeline.agg_transaction_line_item_type [RUN]
2018-04-17 15:30:30,072: Compiling model.agency_data_pipeline.agg_transaction_line_item_type
2018-04-17 15:30:30,072: 15:30:30 | 42 of 91 START table model agency_data_pipeline.frequency_stats...... [RUN]
2018-04-17 15:30:30,084: Writing injected SQL for node "model.agency_data_pipeline.agg_transaction_line_item_type"
2018-04-17 15:30:30,079: 15:30:30 | 43 of 91 START table model agency_data_pipeline.agg_ga_campaign...... [RUN]
2018-04-17 15:30:30,084: Compiling model.agency_data_pipeline.frequency_stats
2018-04-17 15:30:30,085: Compiling model.agency_data_pipeline.agg_ga_campaign
2018-04-17 15:30:30,097: Writing injected SQL for node "model.agency_data_pipeline.frequency_stats"
2018-04-17 15:30:30,102: Writing injected SQL for node "model.agency_data_pipeline.agg_ga_campaign"
2018-04-17 15:30:30,104: Acquiring new bigquery connection "agg_transaction_line_item_type".
2018-04-17 15:30:30,104: Re-using an available connection from the pool.
2018-04-17 15:30:30,107: Acquiring new bigquery connection "agg_ga_campaign".
2018-04-17 15:30:30,109: Acquiring new bigquery connection "frequency_stats".
2018-04-17 15:30:30,111: Re-using an available connection from the pool.
2018-04-17 15:30:30,113: Re-using an available connection from the pool.
2018-04-17 15:30:30,809: Model SQL (frequency_stats):
SELECT
client,
period,
date,
unix_date_in_range,
case when frequency = 1 then '1' 
	when frequency = 2 then '2'
	when frequency > 2 then '2+'
	else null as frequency_segment,
sum(customers) customers 
FROM (

	SELECT 
	client,
	period,
	date,
	unix_date_in_range, 
	frequency,
	count(distinct(customer_id)) customers
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`frequency_proc`
	group by client, period, date, unix_date_in_range, frequency
)
group by client, period, date, unix_date_in_range, frequency_segment
2018-04-17 15:30:30,810: Bad request while running:
SELECT
client,
period,
date,
unix_date_in_range,
case when frequency = 1 then '1' 
	when frequency = 2 then '2'
	when frequency > 2 then '2+'
	else null as frequency_segment,
sum(customers) customers 
FROM (

	SELECT 
	client,
	period,
	date,
	unix_date_in_range, 
	frequency,
	count(distinct(customer_id)) customers
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`frequency_proc`
	group by client, period, date, unix_date_in_range, frequency
)
group by client, period, date, unix_date_in_range, frequency_segment
2018-04-17 15:30:30,810: 400 Syntax error: Unexpected keyword AS at [9:19]
2018-04-17 15:30:30,810: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '884364d4-2ee1-4493-a0fc-89964b698240', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107127710>]}
2018-04-17 15:30:31,043: Model SQL (agg_ga_campaign):
with ga_transactions as (

	select 
		date, account, client, channel, platform, url, 
		campaign,
		null as sessions, null as goal_completions, last_touch_transactions, last_touch_revenue,
		last_touch_shipping, last_touch_tax,
		null as first_touch_transactions, null as first_touch_revenue
	from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_transactions`

),

ga_traffic as (

    select 
        date, account, client, channel, platform, url, 
        campaign,
        sessions, goal_completions, null as last_touch_transactions, null as last_touch_revenue,
        null as last_touch_shipping, null as last_touch_tax,
        null as first_touch_transactions, null as first_touch_revenue
    from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_traffic`

),

ga_mcf as (

	select 
		date, account, client, channel, platform, '' as url,
		campaign, 
		null as sessions, null as goal_completions, null as last_touch_transactions, null as last_touch_revenue,
		null as last_touch_shipping, null as last_touch_tax,
		first_touch_transactions, first_touch_revenue
	from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_mcf_stats`

)


SELECT
    date, 
    client,
    platform,
    channel, 
    url,
    campaign utm_campaign,
	sum(sessions) sessions,
	sum(goal_completions) goal_completions,
	sum(last_touch_transactions) last_touch_transactions,
	sum(last_touch_revenue) last_touch_revenue,
    sum(last_touch_shipping) last_touch_shipping_revenue,
    sum(last_touch_tax) last_touch_tax_revenue,
    sum(first_touch_transactions) first_touch_transactions,
    sum(first_touch_revenue) - sum(ifnull(last_touch_shipping,0)) - sum(ifnull(last_touch_tax,0)) first_touch_revenue

FROM
(
    SELECT *
    FROM 
      ga_transactions
    UNION ALL
    SELECT *
    FROM 
      ga_traffic
    UNION ALL
    SELECT *
    FROM 
      ga_mcf
) 
GROUP BY
    date, client, platform, channel, url, utm_campaign
2018-04-17 15:30:31,079: Model SQL (agg_transaction_line_item_type):
SELECT
client,
product_id,
product_type,
customer_id,
sku,
order_number,
created_at,
final_quantity,
final_price
FROM

( 
	SELECT 
	a.client, 
	a.product_id,
	product_type,
	customer_id,
	a.sku, 
	order_number,
	created_at,
	final_quantity,
	final_price
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_line_item` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`agg_products` b
	ON (
		a.product_id = b.product_id
	  and a.client = b.client
		)

)
2018-04-17 15:30:31,089: 15:30:31 | 42 of 91 ERROR creating table model agency_data_pipeline.frequency_stats [ERROR in 0.73s]
2018-04-17 15:30:35,736: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '884364d4-2ee1-4493-a0fc-89964b698240', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104d76b38>]}
2018-04-17 15:30:36,105: 15:30:36 | 41 of 91 OK created table model agency_data_pipeline.agg_transaction_line_item_type [CREATE TABLE in 5.66s]
2018-04-17 15:30:41,163: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '884364d4-2ee1-4493-a0fc-89964b698240', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107127f28>]}
2018-04-17 15:30:41,420: 15:30:41 | 43 of 91 OK created table model agency_data_pipeline.agg_ga_campaign. [CREATE TABLE in 11.08s]
2018-04-17 15:30:41,422: 15:30:41 | 44 of 91 START table model agency_data_pipeline.customers_first_purchase_product_type_proc [RUN]
2018-04-17 15:30:41,422: Compiling model.agency_data_pipeline.customers_first_purchase_product_type_proc
2018-04-17 15:30:41,428: 15:30:41 | 45 of 91 START table model agency_data_pipeline.agg_transaction_product_type [RUN]
2018-04-17 15:30:41,432: Writing injected SQL for node "model.agency_data_pipeline.customers_first_purchase_product_type_proc"
2018-04-17 15:30:41,432: Compiling model.agency_data_pipeline.agg_transaction_product_type
2018-04-17 15:30:41,437: Writing injected SQL for node "model.agency_data_pipeline.agg_transaction_product_type"
2018-04-17 15:30:41,439: Acquiring new bigquery connection "customers_first_purchase_product_type_proc".
2018-04-17 15:30:41,440: Acquiring new bigquery connection "agg_transaction_product_type".
2018-04-17 15:30:41,440: Re-using an available connection from the pool.
2018-04-17 15:30:41,441: Re-using an available connection from the pool.
2018-04-17 15:30:42,516: Model SQL (agg_transaction_product_type):
SELECT
client,
product_type,
customer_id,
order_number,
created_at,
first_value(product_type) over (PARTITION BY client, customer_id, order_number, created_at ORDER BY final_price desc) as top_order_product_type,
final_quantity,
final_price,
sum(final_quantity) over (PARTITION BY client, customer_id, order_number) as total_order_quantity,
sum(final_price) over (PARTITION BY client, customer_id, order_number) as total_order_value
FROM
	(
		SELECT
		client,
		product_type,
		customer_id,
		order_number,
		created_at,
		sum(final_quantity) final_quantity,
		sum(final_price) final_price
		FROM
		`growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_line_item_type`
		GROUP BY
		client,
		product_type,
		customer_id,
		order_number,
		created_at
	)
2018-04-17 15:30:42,517: Model SQL (customers_first_purchase_product_type_proc):
SELECT 
client, 
customer_id, 
product_type,
min(cast(created_at as date)) first_order_date,
unix_date( min(cast(created_at as date))) first_order_unix_date
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_line_item_type`
GROUP BY client, customer_id, product_type
2018-04-17 15:30:45,645: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '884364d4-2ee1-4493-a0fc-89964b698240', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104d80f28>]}
2018-04-17 15:30:45,890: 15:30:45 | 44 of 91 OK created table model agency_data_pipeline.customers_first_purchase_product_type_proc [CREATE TABLE in 4.22s]
2018-04-17 15:30:46,772: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '884364d4-2ee1-4493-a0fc-89964b698240', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104d95208>]}
2018-04-17 15:30:47,063: 15:30:47 | 45 of 91 OK created table model agency_data_pipeline.agg_transaction_product_type [CREATE TABLE in 5.34s]
2018-04-17 15:30:47,064: 15:30:47 | 46 of 91 START table model agency_data_pipeline.customers_products_proc [RUN]
2018-04-17 15:30:47,064: Compiling model.agency_data_pipeline.customers_products_proc
2018-04-17 15:30:47,070: 15:30:47 | 47 of 91 START table model agency_data_pipeline.products_proc........ [RUN]
2018-04-17 15:30:47,083: Compiling model.agency_data_pipeline.products_proc
2018-04-17 15:30:47,079: 15:30:47 | 48 of 91 START table model agency_data_pipeline.order_paths_proc..... [RUN]
2018-04-17 15:30:47,082: Writing injected SQL for node "model.agency_data_pipeline.customers_products_proc"
2018-04-17 15:30:47,099: Compiling model.agency_data_pipeline.order_paths_proc
2018-04-17 15:30:47,117: Writing injected SQL for node "model.agency_data_pipeline.products_proc"
2018-04-17 15:30:47,124: Writing injected SQL for node "model.agency_data_pipeline.order_paths_proc"
2018-04-17 15:30:47,125: Acquiring new bigquery connection "customers_products_proc".
2018-04-17 15:30:47,126: Re-using an available connection from the pool.
2018-04-17 15:30:47,128: Acquiring new bigquery connection "order_paths_proc".
2018-04-17 15:30:47,134: Acquiring new bigquery connection "products_proc".
2018-04-17 15:30:47,134: Re-using an available connection from the pool.
2018-04-17 15:30:47,140: Re-using an available connection from the pool.
2018-04-17 15:30:48,048: Model SQL (products_proc):
WITH transactions AS (
  SELECT 
  client, 
  product_id,
  product_type,
  customer_id,
  sku, 
  order_number,
  unix_date(cast(created_at as date)) d, 
  final_quantity,
  final_price,
  unix_date(first_value(cast(created_at) as date)) over (partition by client, product_id, sku order by created_at desc) first_purchase_unix_date
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_line_item_type`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)

SELECT 
client,
'Last 30' as period,
sku,
product_type,
date_in_range date,
unix_date_in_range, 
case when 
  ( first_purchase_unix_date > ( daterange.unix_date_in_range - 365 ) and first_purchase_unix_date <= daterange.unix_date_in_range )
  then 'New' else 'Existing' as newness,  
count(distinct(customer_id)) unique_customers,
count(distinct(order_number)) orders,
sum(final_quantity) quantity,
sum(final_price) revenue
FROM daterange
JOIN transactions
ON transactions.d > ( daterange.unix_date_in_range - 30 )
AND transactions.d <= daterange.unix_date_in_range
group by date_in_range, unix_date_in_range, client, sku, product_type, newness

UNION ALL

SELECT 
client,
'Last 90' as period,
sku, 
case when first_purchase_date 
first_purchase_date,
product_type,
date_in_range date,
unix_date_in_range, 
case when 
  ( first_purchase_unix_date > ( daterange.unix_date_in_range - 365 ) and first_purchase_unix_date <= daterange.unix_date_in_range )
  then 'New' else 'Existing' as newness,  
count(distinct(customer_id)) unique_customers,
count(distinct(order_number)) orders,
sum(final_quantity) quantity,
sum(final_price) revenue
FROM daterange
JOIN transactions
ON transactions.d > ( daterange.unix_date_in_range - 90 )
AND transactions.d <= daterange.unix_date_in_range
group by date_in_range, unix_date_in_range, client, sku, product_type, newness

UNION ALL

SELECT 
client,
'YoY 30' as date_range,
sku, 
first_purchase_date,
product_type,
date_in_range date,
unix_date_in_range,
case when 
  ( first_purchase_unix_date > ( daterange.unix_date_in_range - 730 ) and first_purchase_unix_date <= ( daterange.unix_date_in_range - 365 ))
  then 'New' else 'Existing' as newness,   
count(distinct(customer_id)) unique_customers,
count(distinct(order_number)) orders,
sum(final_quantity) quantity,
sum(final_price) revenue
FROM daterange
JOIN transactions
ON transactions.d > ( daterange.unix_date_in_range - 395 )
AND transactions.d <= ( daterange.unix_date_in_range - 365 )
group by date_in_range, unix_date_in_range, client, sku, product_type, newness
2018-04-17 15:30:48,049: Bad request while running:
WITH transactions AS (
  SELECT 
  client, 
  product_id,
  product_type,
  customer_id,
  sku, 
  order_number,
  unix_date(cast(created_at as date)) d, 
  final_quantity,
  final_price,
  unix_date(first_value(cast(created_at) as date)) over (partition by client, product_id, sku order by created_at desc) first_purchase_unix_date
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_line_item_type`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)

SELECT 
client,
'Last 30' as period,
sku,
product_type,
date_in_range date,
unix_date_in_range, 
case when 
  ( first_purchase_unix_date > ( daterange.unix_date_in_range - 365 ) and first_purchase_unix_date <= daterange.unix_date_in_range )
  then 'New' else 'Existing' as newness,  
count(distinct(customer_id)) unique_customers,
count(distinct(order_number)) orders,
sum(final_quantity) quantity,
sum(final_price) revenue
FROM daterange
JOIN transactions
ON transactions.d > ( daterange.unix_date_in_range - 30 )
AND transactions.d <= daterange.unix_date_in_range
group by date_in_range, unix_date_in_range, client, sku, product_type, newness

UNION ALL

SELECT 
client,
'Last 90' as period,
sku, 
case when first_purchase_date 
first_purchase_date,
product_type,
date_in_range date,
unix_date_in_range, 
case when 
  ( first_purchase_unix_date > ( daterange.unix_date_in_range - 365 ) and first_purchase_unix_date <= daterange.unix_date_in_range )
  then 'New' else 'Existing' as newness,  
count(distinct(customer_id)) unique_customers,
count(distinct(order_number)) orders,
sum(final_quantity) quantity,
sum(final_price) revenue
FROM daterange
JOIN transactions
ON transactions.d > ( daterange.unix_date_in_range - 90 )
AND transactions.d <= daterange.unix_date_in_range
group by date_in_range, unix_date_in_range, client, sku, product_type, newness

UNION ALL

SELECT 
client,
'YoY 30' as date_range,
sku, 
first_purchase_date,
product_type,
date_in_range date,
unix_date_in_range,
case when 
  ( first_purchase_unix_date > ( daterange.unix_date_in_range - 730 ) and first_purchase_unix_date <= ( daterange.unix_date_in_range - 365 ))
  then 'New' else 'Existing' as newness,   
count(distinct(customer_id)) unique_customers,
count(distinct(order_number)) orders,
sum(final_quantity) quantity,
sum(final_price) revenue
FROM daterange
JOIN transactions
ON transactions.d > ( daterange.unix_date_in_range - 395 )
AND transactions.d <= ( daterange.unix_date_in_range - 365 )
group by date_in_range, unix_date_in_range, client, sku, product_type, newness
2018-04-17 15:30:48,050: 400 Syntax error: Unexpected ")" at [12:40]
2018-04-17 15:30:48,050: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '884364d4-2ee1-4493-a0fc-89964b698240', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107170630>]}
2018-04-17 15:30:48,101: Model SQL (order_paths_proc):
SELECT
client, 
customer_id, 
first_value(product_type) OVER w1 as first_product_type,
nth_value(product_type, 2) OVER w1 as second_product_type,
cast(first_value(created_at) OVER w1 as date) as first_purchase_date,
cast(nth_value(created_at, 2) OVER w1 as date) as second_purchase_date,
cast(nth_value(created_at, 3) OVER w1 as date) as third_purchase_date,
cast(nth_value(created_at, 4) OVER w1 as date) as fourth_purchase_date,
cast(nth_value(created_at, 5) OVER w1 as date) as fifth_purchase_date,
first_value(order_number) OVER w1 as first_order_number,
nth_value(order_number, 2) OVER w1 as second_order_number,
nth_value(order_number, 3) OVER w1 as third_order_number,
nth_value(order_number, 4) OVER w1 as fourth_order_number,
nth_value(order_number, 5) OVER w1 as fifth_order_number,
first_value(total_order_value) OVER w1 as first_order_value,
nth_value(total_order_value, 2) OVER w1 as second_order_value
FROM (
	  
	  SELECT 
	  client, 
	  product_type,
	  customer_id,
	  order_number,
	  created_at, 
	  total_order_value
	  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_product_type`
	  WHERE product_type = top_order_product_type

)
WINDOW w1 as (PARTITION BY client, customer_id ORDER BY created_at asc)
2018-04-17 15:30:48,319: Model SQL (customers_products_proc):
WITH customers AS (
  SELECT 
  client, 
  product_id,
  product_type,
  customer_id,
  sku, 
  order_number,
  cast(created_at as date) order_date,
  unix_date(cast(created_at as date)) unix_order_date, 
  final_quantity quantity,
  final_price revenue
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_line_item_type`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)

SELECT 
client,
period,
customer_id,
product_type,
date,
window_end_unix_date,
window_end_unix_date - 365 as window_start_unix_date,
window_end_unix_date - unix_date(recent_order) recency_days,
frequency,
quantity,
revenue,
case when frequency > 0 then revenue/frequency else 0 end as aov
FROM 
(  

  SELECT 
  client,
  'Rolling 365' as period,
  customer_id,
  product_type,
  date_in_range date,
  unix_date_in_range,
  unix_date_in_range window_end_unix_date, 
  max(order_date) recent_order,
  sum(quantity) as quantity,
  sum(revenue) as revenue,
  count(distinct(order_number)) as frequency
  FROM daterange
  JOIN customers
  ON customers.unix_order_date > ( daterange.unix_date_in_range - 365 )
  AND customers.unix_order_date <= daterange.unix_date_in_range
  GROUP BY client, customer_id, date, unix_date_in_range, product_type

  UNION ALL

  SELECT 
  client,
  'Rolling 365 (t-1mo)' as period,
  customer_id,
  product_type,
  date_in_range date,
  unix_date_in_range, 
  unix_date_in_range - 30 window_end_unix_date, 
  max(order_date) recent_order,
  sum(quantity) as quantity,
  sum(revenue) as revenue,
  count(distinct(order_number)) as frequency
  FROM daterange
  JOIN customers
  ON customers.unix_order_date > ( daterange.unix_date_in_range - 395 )
  AND customers.unix_order_date <= ( daterange.unix_date_in_range - 30 )
  GROUP BY client, customer_id, date, unix_date_in_range, product_type

  UNION ALL

  SELECT 
  client,
  'Rolling 365 (t-1yr)' as period,
  customer_id,
  product_type,
  date_in_range date,
  unix_date_in_range, 
  unix_date_in_range - 365 window_end_unix_date, 
  max(order_date) recent_order,
  sum(quantity) as quantity,
  sum(revenue) as revenue,
  count(distinct(order_number)) as frequency
  FROM daterange
  JOIN customers
  ON customers.unix_order_date > ( daterange.unix_date_in_range - 730 )
  AND customers.unix_order_date <= ( daterange.unix_date_in_range - 365 )
  GROUP BY client, customer_id, date, unix_date_in_range, product_type

)
2018-04-17 15:30:48,389: 15:30:48 | 47 of 91 ERROR creating table model agency_data_pipeline.products_proc [ERROR in 0.97s]
2018-04-17 15:30:51,453: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '884364d4-2ee1-4493-a0fc-89964b698240', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104c67f28>]}
2018-04-17 15:30:51,749: 15:30:51 | 48 of 91 OK created table model agency_data_pipeline.order_paths_proc [CREATE TABLE in 4.35s]
2018-04-17 15:32:02,695: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '884364d4-2ee1-4493-a0fc-89964b698240', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107127e80>]}
2018-04-17 15:32:03,347: 15:32:03 | 46 of 91 OK created table model agency_data_pipeline.customers_products_proc [CREATE TABLE in 75.63s]
2018-04-17 15:32:03,351: 15:32:03 | 49 of 91 START table model agency_data_pipeline.order_paths_agg...... [RUN]
2018-04-17 15:32:03,352: 15:32:03 | 50 of 91 SKIP relation agency_data_pipeline.segment_proc_sku......... [SKIP]
2018-04-17 15:32:03,352: Compiling model.agency_data_pipeline.order_paths_agg
2018-04-17 15:32:03,363: Writing injected SQL for node "model.agency_data_pipeline.order_paths_agg"
2018-04-17 15:32:03,368: Acquiring new bigquery connection "order_paths_agg".
2018-04-17 15:32:03,368: Re-using an available connection from the pool.
2018-04-17 15:32:04,437: Model SQL (order_paths_agg):
SELECT
client, 
first_product_type,
second_product_type,
first_purchase_date,
count(distinct(customer_id)) customer_count, 
count(distinct(second_order_number)) second_orders, 
count(distinct(third_order_number)) third_orders, 
count(distinct(fourth_order_number)) fourth_orders, 
count(distinct(fifth_order_number)) fifth_orders, 
sum(date_diff(second_purchase_date, first_purchase_date, DAY)) second_order_latency_days,
sum(date_diff(third_purchase_date, second_purchase_date, DAY)) third_order_latency_days,
sum(date_diff(fourth_purchase_date, third_purchase_date, DAY)) fourth_order_latency_days,
sum(date_diff(fifth_purchase_date, fourth_purchase_date, DAY)) fifth_order_latency_days,
sum(first_order_value) first_order_revenue,
sum(second_order_value) second_order_revenue
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`order_paths_proc`
where second_product_type is not null
GROUP BY client, first_product_type, second_product_type, first_purchase_date
2018-04-17 15:32:06,695: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '884364d4-2ee1-4493-a0fc-89964b698240', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104d795f8>]}
2018-04-17 15:32:06,970: 15:32:06 | 49 of 91 OK created table model agency_data_pipeline.order_paths_agg. [CREATE TABLE in 3.34s]
2018-04-17 15:32:06,970: 15:32:06 | 51 of 91 START table model agency_data_pipeline.segment_proc_customers_products [RUN]
2018-04-17 15:32:06,971: Compiling model.agency_data_pipeline.segment_proc_customers_products
2018-04-17 15:32:06,971: 15:32:06 | 52 of 91 SKIP relation agency_data_pipeline.segment_stats_sku........ [SKIP]
2018-04-17 15:32:06,982: Writing injected SQL for node "model.agency_data_pipeline.segment_proc_customers_products"
2018-04-17 15:32:06,971: 15:32:06 | 53 of 91 START table model agency_data_pipeline.agg_ga_transaction... [RUN]
2018-04-17 15:32:06,983: Compiling model.agency_data_pipeline.agg_ga_transaction
2018-04-17 15:32:06,971: 15:32:06 | 54 of 91 START table model agency_data_pipeline.agg_transaction...... [RUN]
2018-04-17 15:32:06,989: Compiling model.agency_data_pipeline.agg_transaction
2018-04-17 15:32:06,993: Writing injected SQL for node "model.agency_data_pipeline.agg_ga_transaction"
2018-04-17 15:32:07,012: Writing injected SQL for node "model.agency_data_pipeline.agg_transaction"
2018-04-17 15:32:07,014: Acquiring new bigquery connection "segment_proc_customers_products".
2018-04-17 15:32:07,016: Re-using an available connection from the pool.
2018-04-17 15:32:07,019: Acquiring new bigquery connection "agg_transaction".
2018-04-17 15:32:07,020: Re-using an available connection from the pool.
2018-04-17 15:32:07,041: Acquiring new bigquery connection "agg_ga_transaction".
2018-04-17 15:32:07,041: Re-using an available connection from the pool.
2018-04-17 15:32:08,015: Model SQL (segment_proc_customers_products):
SELECT
client,
period,
date,
customer_id,
first_order_date,
first_order_unix_date,
product_type,
recency_days,
frequency,
revenue,
quantity,
aov,
case when frequency = 1 and recency_days <= 30 and first_order_unix_date >= window_start_unix_date then 'New'
	when frequency = 1 then 'One-time Purchaser'
	when frequency > frequency_90pct and recency_days < recency_90pct and aov > aov_50pct then 'Champion'
	when recency_days < recency_90pct and frequency > frequency_75pct then 'Potential Loyalists' 
	when frequency > frequency_75pct and recency_days <= recency_50pct then 'Cant Lose'
	when recency_days < recency_50pct and frequency > frequency_50pct then 'Loyal'
	when recency_days > recency_50pct and frequency > frequency_50pct then 'Frequent, not Recent'
	when recency_days < recency_50pct and frequency < frequency_50pct then 'Recent, not Frequent'
	else 'Unbucketed' end as segment,
aov_50pct,
frequency_90pct,
frequency_75pct,
frequency_50pct,
recency_90pct,
recency_75pct,
recency_50pct
FROM
(
	SELECT 
	a.client client,
	period,
	date,
	a.customer_id customer_id,
	a.product_type product_type,
	b.first_order_date first_order_date,
	b.first_order_unix_date first_order_unix_date,
	window_start_unix_date,
	window_end_unix_date,	
	recency_days,
	frequency,
	revenue,
	quantity,
	aov,
	PERCENTILE_CONT(aov, 0.50) OVER w1 AS aov_50pct,
	PERCENTILE_CONT(frequency, 0.90) OVER w1 AS frequency_90pct,
	PERCENTILE_CONT(frequency, 0.75) OVER w1 AS frequency_75pct,
	PERCENTILE_CONT(frequency, 0.90) OVER w1 AS frequency_50pct,
	PERCENTILE_CONT(recency_days, 0.10) OVER w1 AS recency_90pct,
	PERCENTILE_CONT(recency_days, 0.25) OVER w1 AS recency_75pct,
	PERCENTILE_CONT(recency_days, 0.5) OVER w1 AS recency_50pct
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`customers_products_proc` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`customers_first_purchase_product_type_proc` b
	ON (
		a.client = b.client and
		a.customer_id = b.customer_id and
		a.product_type = b.product_type
		)
	WINDOW w1 as (PARTITION BY a.client, period, date, a.product_type)
)
2018-04-17 15:32:08,022: Model SQL (agg_ga_transaction):
#done - lookup customer id from transaction id from orders
#done - tag an order as 'new' or 'existing' based on transaction id
#sum lifetime value of that customer id
#first order value for customer
#read from agg_ga_transaction into agg_ga_campaign instead of directly from ga_transactions and ga_mcf_stats


with ga as (

    select 
        date, 
        client, 
        'Last-touch' as attribution,
        channel, 
        platform, 
        url, 
        campaign, 
        transactionid,
        last_touch_transactions transactions, 
        last_touch_revenue + ifnull(last_touch_shipping, 0) + ifnull(last_touch_tax, 0) as revenue
    from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_transactions`

),

ga_mcf as (

    select 
        date, 
        client, 
        'First-touch' as attribution,
        channel, 
        platform, 
        '' as url,
        campaign, 
        transactionid, 
        first_touch_transactions as transactions,
        first_touch_revenue as revenue
    from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_mcf_stats`

)


SELECT
    date, 
    a.client client,
    attribution,
    transactionid,
    b.customer_id customer_id,
    b.order_type order_type,
    b.first_order_revenue first_order_revenue,
    b.lifetime_revenue lifetime_revenue,
    channel,
    platform,
    url,
    campaign,
    transactions,
    revenue
FROM (
    SELECT * FROM ga
    UNION ALL
    SELECT * FROM ga_mcf
) a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`customers_by_transaction` b
ON (
    a.client = b.client AND
    a.transactionid = b.order_number
)
2018-04-17 15:32:08,255: Model SQL (agg_transaction):
SELECT
client,
date,
customer_id,
order_number,
last_touch_channel,
last_touch_platform,
last_touch_url,
first_touch_channel, 
first_touch_platform, 
first_touch_utm_campaign,
ifnull( sum(last_touch_transactions), 0) last_touch_transactions, 
ifnull( sum(last_touch_revenue), 0) last_touch_revenue, 
ifnull( sum(first_touch_transactions), 0) first_touch_transactions, 
ifnull( sum(first_touch_revenue), 0) first_touch_revenue,
ifnull( sum(final_quantity), 0) quantity,
ifnull( sum(final_price), 0) revenue,
ifnull( sum(shipping_price), 0) shipping_revenue,
ROW_NUMBER() OVER (PARTITION BY client, customer_id, order_number ORDER BY date asc) AS order_sequence
FROM
(
	SELECT
	a.client,
	a.date date,
	b.date ga_date,
	a.customer_id,
	a.order_number,
	transactionid,
	b.last_touch_channel,
	b.last_touch_platform,
	b.last_touch_url,
	b.first_touch_channel, 
	b.first_touch_platform, 
	b.first_touch_utm_campaign, 
	last_touch_transactions, 
	last_touch_revenue, 
	first_touch_transactions, 
	first_touch_revenue,
	final_quantity,
	final_price,
	shipping_price
	FROM
	`growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_order_number` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`agg_ga_transaction_order_number` b
	ON (
		a.client = b.client and
		a.order_number = b.transactionid
	)

)
GROUP BY
client, 
date, 
customer_id,
order_number, 
last_touch_channel,
last_touch_platform,
last_touch_url,
first_touch_channel, 
first_touch_platform, 
first_touch_utm_campaign
2018-04-17 15:32:14,772: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '884364d4-2ee1-4493-a0fc-89964b698240', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107174b38>]}
2018-04-17 15:32:14,984: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '884364d4-2ee1-4493-a0fc-89964b698240', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10713a828>]}
2018-04-17 15:32:15,018: 15:32:15 | 53 of 91 OK created table model agency_data_pipeline.agg_ga_transaction [CREATE TABLE in 7.79s]
2018-04-17 15:32:15,255: 15:32:15 | 54 of 91 OK created table model agency_data_pipeline.agg_transaction. [CREATE TABLE in 7.99s]
2018-04-17 15:32:45,369: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '884364d4-2ee1-4493-a0fc-89964b698240', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1070f3630>]}
2018-04-17 15:32:45,786: 15:32:45 | 51 of 91 OK created table model agency_data_pipeline.segment_proc_customers_products [CREATE TABLE in 38.40s]
2018-04-17 15:32:45,787: 15:32:45 | 55 of 91 START table model agency_data_pipeline.segment_stats_customers_products_agg [RUN]
2018-04-17 15:32:45,788: Compiling model.agency_data_pipeline.segment_stats_customers_products_agg
2018-04-17 15:32:45,787: 15:32:45 | 56 of 91 START table model agency_data_pipeline.agg_transaction_daily [RUN]
2018-04-17 15:32:45,800: Compiling model.agency_data_pipeline.agg_transaction_daily
2018-04-17 15:32:45,805: Writing injected SQL for node "model.agency_data_pipeline.agg_transaction_daily"
2018-04-17 15:32:45,805: Writing injected SQL for node "model.agency_data_pipeline.segment_stats_customers_products_agg"
2018-04-17 15:32:45,787: 15:32:45 | 57 of 91 START table model agency_data_pipeline.customers_first_purchase_proc [RUN]
2018-04-17 15:32:45,787: 15:32:45 | 58 of 91 START table model agency_data_pipeline.agg_ga_campaign_by_type [RUN]
2018-04-17 15:32:45,806: Compiling model.agency_data_pipeline.customers_first_purchase_proc
2018-04-17 15:32:45,807: Acquiring new bigquery connection "segment_stats_customers_products_agg".
2018-04-17 15:32:45,808: Acquiring new bigquery connection "agg_transaction_daily".
2018-04-17 15:32:45,808: Compiling model.agency_data_pipeline.agg_ga_campaign_by_type
2018-04-17 15:32:45,813: Writing injected SQL for node "model.agency_data_pipeline.customers_first_purchase_proc"
2018-04-17 15:32:45,813: Re-using an available connection from the pool.
2018-04-17 15:32:45,820: Writing injected SQL for node "model.agency_data_pipeline.agg_ga_campaign_by_type"
2018-04-17 15:32:45,821: Re-using an available connection from the pool.
2018-04-17 15:32:45,831: Acquiring new bigquery connection "customers_first_purchase_proc".
2018-04-17 15:32:45,832: Re-using an available connection from the pool.
2018-04-17 15:32:45,834: Acquiring new bigquery connection "agg_ga_campaign_by_type".
2018-04-17 15:32:45,838: Re-using an available connection from the pool.
2018-04-17 15:32:46,785: Model SQL (agg_transaction_daily):
SELECT
client,
date,
customer_id,
sum(last_touch_transactions) last_touch_transactions, 
sum(last_touch_revenue) last_touch_revenue, 
sum(first_touch_transactions) first_touch_transactions, 
sum(first_touch_revenue) first_touch_revenue,
sum(quantity) quantity,
sum(revenue) revenue,
count(distinct(order_number)) order_count
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction`
GROUP BY
client, 
date, 
customer_id
2018-04-17 15:32:46,788: Model SQL (segment_stats_customers_products_agg):
WITH ty as (

	SELECT
	client,
	date,
	customer_id,
	product_type,
	segment as segment_365,
	recency_days as recency_365,
	frequency as frequency_365,
	revenue as revenue_365,
	aov as aov_365,
	'' as segment_mom,
	0 as recency_mom,
	0 as frequency_mom,
	0 as revenue_mom,
	0 as aov_mom,
	'' as segment_yoy,
	0 as recency_yoy,
	0 as frequency_yoy,
	0 as revenue_yoy,
	0 as aov_yoy
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers_products`
	WHERE period = 'Rolling 365'

),

last_month as (

	SELECT
	client,
	date,
	customer_id,
	product_type,
	'' as segment_365,
	0 as recency_365,
	0 as frequency_365,
	0 as revenue_365,
	0 as aov_365,
	segment as segment_mom,
	recency_days as recency_mom,
	frequency as frequency_mom,
	revenue as revenue_mom,
	aov as aov_mom,
	'' as segment_yoy,
	0 as recency_yoy,
	0 as frequency_yoy,
	0 as revenue_yoy,
	0 as aov_yoy
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers_products`
	WHERE period = 'Rolling 365 (t-1mo)'

),

this_month_1yr as (

	SELECT
	client,
	date,
	customer_id,
	product_type,
	'' as segment_365,
	0 as recency_365,
	0 as frequency_365,
	0 as revenue_365,
	0 as aov_365,
	'' as segment_mom,
	0 as recency_mom,
	0 as frequency_mom,
	0 as revenue_mom,
	0 as aov_mom,
	segment as segment_yoy,
	recency_days as recency_yoy,
	frequency as frequency_yoy,
	revenue as revenue_yoy,
	aov as aov_yoy
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers_products`
	WHERE period = 'Rolling 365 (t-1yr)'


)

SELECT
client,
date, 
customer_id,
product_type,
ifnull(max(segment_365), '') segment_365,
ifnull(max(segment_mom), '') segment_mom,
ifnull(max(segment_yoy), '') segment_yoy,
ifnull(sum(recency_365), 0) recency_365,
ifnull(sum(frequency_365), 0) frequency_365,
ifnull(sum(revenue_365), 0) revenue_365,
ifnull(sum(aov_365), 0) aov_365,
ifnull(sum(recency_mom), 0) recency_mom,
ifnull(sum(frequency_mom), 0) frequency_mom,
ifnull(sum(revenue_mom), 0) revenue_mom,
ifnull(sum(aov_mom), 0) aov_mom,	
ifnull(sum(recency_yoy), 0) recency_yoy,
ifnull(sum(frequency_yoy), 0) frequency_yoy,
ifnull(sum(revenue_yoy), 0) revenue_yoy,
ifnull(sum(aov_yoy), 0) aov_yoy
FROM
(
	SELECT * FROM ty
	UNION ALL
	SELECT * FROM last_month
	UNION ALL
	SELECT * FROM this_month_1yr

)
GROUP BY client, date, customer_id, product_type
2018-04-17 15:32:46,934: Model SQL (agg_ga_campaign_by_type):
with orders_new as (
    select 
    date, 
    client, 
    attribution,
    channel, 
    platform, 
    url, 
    campaign,
    count(distinct(customer_id)) customers_new,
    sum(transactions) transactions_new,
    sum(revenue) revenue_new,
    sum(first_order_revenue) first_order_revenue_new,
    sum(lifetime_revenue) lifetime_revenue_new,
    null as customers_total,
    null as transactions_total,
    null as revenue_total
    from `growth-engines-pipeline`.`agency_data_pipeline`.`agg_ga_transaction`
    where order_type = 'New'
    group by date, client, attribution, channel, platform, url, campaign
),
    
orders_total as (
    select 
    date, 
    client, 
    attribution,
    channel, 
    platform, 
    url, 
    campaign,
    null as customers_new,
    null as transactions_new,
    null as revenue_new,
    null as first_order_revenue_new,
    null as lifetime_revenue_new,
    count(distinct(customer_id)) customers_total,
    sum(transactions) transactions_total,
    sum(revenue) revenue_total
    from `growth-engines-pipeline`.`agency_data_pipeline`.`agg_ga_transaction`
    group by date, client, attribution, channel, platform, url, campaign

)

SELECT 
date, 
client, 
attribution,
channel, 
platform, 
url, 
campaign,
sum(customers_new) customers_new,
sum(transactions_new) transactions_new,
sum(revenue_new) revenue_new,
sum(first_order_revenue_new) first_order_revenue_new,
sum(lifetime_revenue_new) lifetime_revenue_new,
sum(customers_total) customers_total,
sum(transactions_total) transactions_total,
sum(revenue_total) revenue_total
from
    ( 
        SELECT * FROM orders_new
        UNION ALL 
        SELECT * FROM orders_total
    )
group by date, client, attribution, channel, platform, url, campaign
2018-04-17 15:32:46,958: Model SQL (customers_first_purchase_proc):
SELECT 
client, 
customer_id, 
min(cast(date as date)) first_order_date,
unix_date( min(cast(date as date))) first_order_unix_date
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction`
GROUP BY client, customer_id
2018-04-17 15:32:49,188: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '884364d4-2ee1-4493-a0fc-89964b698240', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107119160>]}
2018-04-17 15:32:49,434: 15:32:49 | 57 of 91 OK created table model agency_data_pipeline.customers_first_purchase_proc [CREATE TABLE in 3.38s]
2018-04-17 15:32:49,434: 15:32:49 | 59 of 91 SKIP relation agency_data_pipeline.segment_stats_category... [SKIP]
2018-04-17 15:32:49,435: 15:32:49 | 60 of 91 START table model agency_data_pipeline.order_paths_stats.... [RUN]
2018-04-17 15:32:49,435: Compiling model.agency_data_pipeline.order_paths_stats
2018-04-17 15:32:49,440: Writing injected SQL for node "model.agency_data_pipeline.order_paths_stats"
2018-04-17 15:32:49,441: Acquiring new bigquery connection "order_paths_stats".
2018-04-17 15:32:49,441: Re-using an available connection from the pool.
2018-04-17 15:32:50,465: Model SQL (order_paths_stats):
WITH transactions AS (
  SELECT 
  client, 
  first_product_type,
  second_product_type,
  first_purchase_date,
  customer_count,
  second_orders,
  third_orders,
  fourth_orders,
  fifth_orders,
  second_order_latency_days,
  third_order_latency_days,
  fourth_order_latency_days,
  fifth_order_latency_days,
  first_order_revenue,
  second_order_revenue,
  unix_date(cast(first_purchase_date as date)) d
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`order_paths_agg`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)

SELECT 
client,
'Rolling 365' as period,
first_product_type,
second_product_type,
date_in_range date,
unix_date_in_range, 
sum(customer_count) customer_count,
sum(second_orders) second_orders,
sum(third_orders) third_orders,
sum(fourth_orders) fourth_orders,
sum(fifth_orders) fifth_orders,
sum(second_order_latency_days) second_order_latency_days,
sum(third_order_latency_days) third_order_latency_days,
sum(fourth_order_latency_days) fourth_order_latency_days,
sum(fifth_order_latency_days) fifth_order_latency_days,
sum(first_order_revenue) first_order_revenue,
sum(second_order_revenue) second_order_revenue
FROM daterange
JOIN transactions
ON transactions.d > ( daterange.unix_date_in_range - 365 )
AND transactions.d <= daterange.unix_date_in_range
group by client, first_product_type, second_product_type, date_in_range, unix_date_in_range
2018-04-17 15:32:52,847: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '884364d4-2ee1-4493-a0fc-89964b698240', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1070d9048>]}
2018-04-17 15:32:53,278: 15:32:53 | 60 of 91 OK created table model agency_data_pipeline.order_paths_stats [CREATE TABLE in 3.41s]
2018-04-17 15:32:53,642: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '884364d4-2ee1-4493-a0fc-89964b698240', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107108240>]}
2018-04-17 15:32:53,981: 15:32:53 | 58 of 91 OK created table model agency_data_pipeline.agg_ga_campaign_by_type [CREATE TABLE in 7.83s]
2018-04-17 15:32:54,631: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '884364d4-2ee1-4493-a0fc-89964b698240', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1070f3080>]}
2018-04-17 15:32:55,054: 15:32:55 | 56 of 91 OK created table model agency_data_pipeline.agg_transaction_daily [CREATE TABLE in 8.83s]
2018-04-17 15:33:12,532: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '884364d4-2ee1-4493-a0fc-89964b698240', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104d76b38>]}
2018-04-17 15:33:13,224: 15:33:13 | 55 of 91 OK created table model agency_data_pipeline.segment_stats_customers_products_agg [CREATE TABLE in 26.74s]
2018-04-17 15:33:13,225: 15:33:13 | 61 of 91 START table model agency_data_pipeline.segment_stats_customers_products [RUN]
2018-04-17 15:33:13,226: Compiling model.agency_data_pipeline.segment_stats_customers_products
2018-04-17 15:33:13,225: 15:33:13 | 62 of 91 START table model agency_data_pipeline.customers_proc....... [RUN]
2018-04-17 15:33:13,226: 15:33:13 | 63 of 91 START table model agency_data_pipeline.growth_customer_0_365 [RUN]
2018-04-17 15:33:13,234: Writing injected SQL for node "model.agency_data_pipeline.segment_stats_customers_products"
2018-04-17 15:33:13,234: Compiling model.agency_data_pipeline.customers_proc
2018-04-17 15:33:13,234: Compiling model.agency_data_pipeline.growth_customer_0_365
2018-04-17 15:33:13,241: Writing injected SQL for node "model.agency_data_pipeline.customers_proc"
2018-04-17 15:33:13,246: Writing injected SQL for node "model.agency_data_pipeline.growth_customer_0_365"
2018-04-17 15:33:13,250: Acquiring new bigquery connection "customers_proc".
2018-04-17 15:33:13,251: Acquiring new bigquery connection "segment_stats_customers_products".
2018-04-17 15:33:13,253: Acquiring new bigquery connection "growth_customer_0_365".
2018-04-17 15:33:13,253: Re-using an available connection from the pool.
2018-04-17 15:33:13,254: Re-using an available connection from the pool.
2018-04-17 15:33:13,258: Re-using an available connection from the pool.
2018-04-17 15:33:14,193: Model SQL (growth_customer_0_365):
WITH transactions AS (
  SELECT 
  client, 
  customer_id, 
  order_number,
  unix_date(cast(date as date)) d, 
  quantity,
  revenue,
  shipping_revenue
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)

SELECT 
date_in_range date,
unix_date_in_range, 
unix_date_in_range_yoy, 
client, 
customer_id,
count(distinct(order_number)) orders,
sum(quantity) quantity,
sum(revenue) revenue,
sum(shipping_revenue) shipping_revenue
FROM daterange
JOIN transactions
ON transactions.d >= ( daterange.unix_date_in_range - 365 ) 
AND transactions.d <= daterange.unix_date_in_range
GROUP BY date, unix_date_in_range, unix_date_in_range_yoy, client, customer_id
2018-04-17 15:33:14,271: Model SQL (customers_proc):
WITH customers AS (
  SELECT 
  client, 
  customer_id, 
  order_number,
  cast(date as date) order_date,
  unix_date(cast(date as date)) unix_order_date, 
  quantity,
  revenue 
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)
 
SELECT 
client,
period,
customer_id,
date,
window_end_unix_date,
window_end_unix_date - 365 as window_start_unix_date,
window_end_unix_date - unix_date(recent_order) recency_days,
frequency,
quantity,
revenue,
case when frequency > 0 then revenue/frequency else 0 end as aov
FROM 
(  

  SELECT 
  client,
  'Rolling 365' as period,
  customer_id,
  date_in_range date,
  unix_date_in_range,
  unix_date_in_range window_end_unix_date,
  max(order_date) recent_order,
  sum(quantity) as quantity,
  sum(revenue) as revenue,
  count(distinct(order_number)) as frequency
  FROM daterange
  JOIN customers
  ON customers.unix_order_date > ( daterange.unix_date_in_range - 365 )
  AND customers.unix_order_date <= daterange.unix_date_in_range
  GROUP BY client, customer_id, date, unix_date_in_range

  UNION ALL

  SELECT 
  client,
  'Rolling 365 (t-1mo)' as period,
  customer_id,
  date_in_range date,
  unix_date_in_range,
  unix_date_in_range - 30 window_end_unix_date, 
  max(order_date) recent_order,
  sum(quantity) as quantity,
  sum(revenue) as revenue,
  count(distinct(order_number)) as frequency
  FROM daterange
  JOIN customers
  ON customers.unix_order_date > ( daterange.unix_date_in_range - 395 )
  AND customers.unix_order_date <= ( daterange.unix_date_in_range - 30 )
  GROUP BY client, customer_id, date, unix_date_in_range

  UNION ALL

  SELECT 
  client,
  'Rolling 365 (t-1yr)' as period,
  customer_id,
  date_in_range date,
  unix_date_in_range, 
  unix_date_in_range - 365 window_end_unix_date, 
  max(order_date) recent_order,
  sum(quantity) as quantity,
  sum(revenue) as revenue,
  count(distinct(order_number)) as frequency
  FROM daterange
  JOIN customers
  ON customers.unix_order_date > ( daterange.unix_date_in_range - 730 )
  AND customers.unix_order_date <= ( daterange.unix_date_in_range - 365 )
  GROUP BY client, customer_id, date, unix_date_in_range

)
2018-04-17 15:33:14,336: Model SQL (segment_stats_customers_products):
SELECT
client,
date,
product_type,
segment_365,
segment_mom,
segment_yoy,
count(distinct(customer_id)) customers,
avg(recency_365) recency_365,
sum(frequency_365) frequency_365,
sum(revenue_365) revenue_365,
case when sum(frequency_365) > 0 then sum(revenue_365)/sum(frequency_365) else null end as aov_365,
avg(recency_mom) recency_mom,
sum(frequency_mom) frequency_mom,
sum(revenue_mom) revenue_mom,
case when sum(frequency_mom) > 0 then sum(revenue_mom)/sum(frequency_mom) else null end as aov_mom,
avg(recency_yoy) recency_yoy,
sum(frequency_yoy) frequency_yoy,
sum(revenue_yoy) revenue_yoy,
case when sum(frequency_yoy) > 0 then sum(revenue_yoy)/sum(frequency_yoy) else null end as aov_yoy
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_stats_customers_products_agg`
GROUP BY client, date, product_type, segment_365, segment_mom, segment_yoy
2018-04-17 15:33:24,915: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '884364d4-2ee1-4493-a0fc-89964b698240', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1070f3630>]}
2018-04-17 15:33:25,150: 15:33:25 | 61 of 91 OK created table model agency_data_pipeline.segment_stats_customers_products [CREATE TABLE in 11.69s]
2018-04-17 15:33:32,681: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '884364d4-2ee1-4493-a0fc-89964b698240', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1070e7da0>]}
2018-04-17 15:33:33,300: 15:33:33 | 63 of 91 OK created table model agency_data_pipeline.growth_customer_0_365 [CREATE TABLE in 19.45s]
2018-04-17 15:33:43,201: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '884364d4-2ee1-4493-a0fc-89964b698240', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1070e7b70>]}
2018-04-17 15:33:43,456: 15:33:43 | 62 of 91 OK created table model agency_data_pipeline.customers_proc.. [CREATE TABLE in 29.97s]
2018-04-17 15:33:43,457: 15:33:43 | 64 of 91 START table model agency_data_pipeline.retention_365_730.... [RUN]
2018-04-17 15:33:43,458: Compiling model.agency_data_pipeline.retention_365_730
2018-04-17 15:33:43,471: Writing injected SQL for node "model.agency_data_pipeline.retention_365_730"
2018-04-17 15:33:43,464: 15:33:43 | 65 of 91 START table model agency_data_pipeline.retention_0_365...... [RUN]
2018-04-17 15:33:43,472: Compiling model.agency_data_pipeline.retention_0_365
2018-04-17 15:33:43,476: Writing injected SQL for node "model.agency_data_pipeline.retention_0_365"
2018-04-17 15:33:43,464: 15:33:43 | 66 of 91 START table model agency_data_pipeline.retention_0_30....... [RUN]
2018-04-17 15:33:43,477: Compiling model.agency_data_pipeline.retention_0_30
2018-04-17 15:33:43,464: 15:33:43 | 67 of 91 START table model agency_data_pipeline.retention_730_plus... [RUN]
2018-04-17 15:33:43,482: Compiling model.agency_data_pipeline.retention_730_plus
2018-04-17 15:33:43,482: Writing injected SQL for node "model.agency_data_pipeline.retention_0_30"
2018-04-17 15:33:43,487: Writing injected SQL for node "model.agency_data_pipeline.retention_730_plus"
2018-04-17 15:33:43,491: Acquiring new bigquery connection "retention_0_365".
2018-04-17 15:33:43,492: Re-using an available connection from the pool.
2018-04-17 15:33:43,494: Acquiring new bigquery connection "retention_365_730".
2018-04-17 15:33:43,495: Re-using an available connection from the pool.
2018-04-17 15:33:43,497: Acquiring new bigquery connection "retention_0_30".
2018-04-17 15:33:43,498: Re-using an available connection from the pool.
2018-04-17 15:33:43,499: Acquiring new bigquery connection "retention_730_plus".
2018-04-17 15:33:43,502: Re-using an available connection from the pool.
2018-04-17 15:33:44,687: Model SQL (retention_0_30):
WITH transactions AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_daily`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
),

temp AS (
  SELECT 
  client, 
  customer_id, 
  unix_date(date) d, 
  quantity,
  revenue,
  order_count
  FROM transactions
)

SELECT 
date_in_range date,
unix_date_in_range, 
client, 
customer_id,
sum(quantity) quantity,
sum(revenue) revenue,
sum(order_count) order_count
FROM daterange
JOIN temp
ON temp.d >= ( daterange.unix_date_in_range_bom ) 
AND temp.d <= daterange.unix_date_in_range
group by date_in_range, unix_date_in_range, client, customer_id
2018-04-17 15:33:44,732: Model SQL (retention_0_365):
WITH transactions AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_daily`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
),

temp AS (
  SELECT 
  client, 
  customer_id, 
  unix_date(date) d, 
  quantity,
  revenue,
  order_count
  FROM transactions
)

SELECT 
date_in_range date,
unix_date_in_range, 
client, 
customer_id,
sum(quantity) quantity,
sum(revenue) revenue,
sum(order_count) order_count
FROM daterange
JOIN temp
ON temp.d >= ( daterange.unix_date_in_range - 365 ) 
AND temp.d <= daterange.unix_date_in_range
group by date_in_range, unix_date_in_range, client, customer_id
2018-04-17 15:33:44,783: Model SQL (retention_730_plus):
WITH transactions AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_daily`
),

daterange AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`  	
),

temp AS (
  SELECT 
  client, 
  customer_id, 
  unix_date(date) d, 
  quantity,
  revenue,
  order_count
  FROM transactions
)

SELECT 
date_in_range date, 
unix_date_in_range,
client, 
customer_id,
sum(quantity) quantity,
sum(revenue) revenue,
sum(order_count) order_count
FROM daterange
JOIN temp
ON temp.d <= ( daterange.unix_date_in_range - 730 ) 
group by date_in_range, unix_date_in_range, client, customer_id
2018-04-17 15:33:44,815: Model SQL (retention_365_730):
WITH transactions AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_daily`
),

daterange AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`  	
),

temp AS (
  SELECT 
  client, 
  customer_id, 
  unix_date(date) d, 
  quantity,
  revenue,
  order_count
  FROM transactions
)

SELECT 
date_in_range date, 
unix_date_in_range,
client, 
customer_id,
sum(quantity) quantity,
sum(revenue) revenue,
sum(order_count) order_count
FROM daterange
JOIN temp
ON ( temp.d >= ( daterange.unix_date_in_range - 730 ) 
AND temp.d < ( daterange.unix_date_in_range - 365 ) )
group by date_in_range, unix_date_in_range, client, customer_id
2018-04-17 15:33:47,031: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '884364d4-2ee1-4493-a0fc-89964b698240', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1070fef28>]}
2018-04-17 15:33:47,312: 15:33:47 | 67 of 91 OK created table model agency_data_pipeline.retention_730_plus [CREATE TABLE in 3.55s]
2018-04-17 15:33:47,313: 15:33:47 | 68 of 91 START table model agency_data_pipeline.segment_list_customers_products [RUN]
2018-04-17 15:33:47,313: Compiling model.agency_data_pipeline.segment_list_customers_products
2018-04-17 15:33:47,320: Writing injected SQL for node "model.agency_data_pipeline.segment_list_customers_products"
2018-04-17 15:33:47,321: Acquiring new bigquery connection "segment_list_customers_products".
2018-04-17 15:33:47,321: Re-using an available connection from the pool.
2018-04-17 15:33:48,074: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '884364d4-2ee1-4493-a0fc-89964b698240', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10717b7f0>]}
2018-04-17 15:33:48,346: Model SQL (segment_list_customers_products):
SELECT
a.client,
period,
date,
customer_id,
product_type,
b.first_name,
b.last_name,
b.email,
recency_days,
frequency,
revenue,
quantity,
aov,
segment
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers_products` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`agg_customers_union` b
ON (
	a.client = b.client AND
	a.customer_id = b.id
)
2018-04-17 15:33:48,458: 15:33:48 | 66 of 91 OK created table model agency_data_pipeline.retention_0_30.. [CREATE TABLE in 4.60s]
2018-04-17 15:33:48,459: 15:33:48 | 69 of 91 START table model agency_data_pipeline.retention_30_60...... [RUN]
2018-04-17 15:33:48,459: Compiling model.agency_data_pipeline.retention_30_60
2018-04-17 15:33:48,466: Writing injected SQL for node "model.agency_data_pipeline.retention_30_60"
2018-04-17 15:33:48,467: Acquiring new bigquery connection "retention_30_60".
2018-04-17 15:33:48,467: Re-using an available connection from the pool.
2018-04-17 15:33:49,286: Model SQL (retention_30_60):
WITH transactions AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_daily`
),

daterange AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`  	
),

temp AS (
  SELECT 
  client, 
  customer_id, 
  unix_date(date) d, 
  quantity,
  revenue,
  order_count
  FROM transactions
)

SELECT 
date_in_range date, 
unix_date_in_range,
client, 
customer_id,
sum(quantity) quantity,
sum(revenue) revenue,
sum(order_count) order_count
FROM daterange
JOIN temp
ON ( temp.d >= ( daterange.unix_date_in_range_bom_mom ) 
AND temp.d < ( daterange.unix_date_in_range_bom ) )
group by date_in_range, unix_date_in_range, client, customer_id
2018-04-17 15:33:49,339: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '884364d4-2ee1-4493-a0fc-89964b698240', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104d76b38>]}
2018-04-17 15:33:49,594: 15:33:49 | 64 of 91 OK created table model agency_data_pipeline.retention_365_730 [CREATE TABLE in 5.88s]
2018-04-17 15:33:49,594: 15:33:49 | 70 of 91 START table model agency_data_pipeline.retention_60_plus.... [RUN]
2018-04-17 15:33:49,595: Compiling model.agency_data_pipeline.retention_60_plus
2018-04-17 15:33:49,603: Writing injected SQL for node "model.agency_data_pipeline.retention_60_plus"
2018-04-17 15:33:49,605: Acquiring new bigquery connection "retention_60_plus".
2018-04-17 15:33:49,605: Re-using an available connection from the pool.
2018-04-17 15:33:50,489: Model SQL (retention_60_plus):
WITH transactions AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_daily`
),

daterange AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`  	
),

temp AS (
  SELECT 
  client, 
  customer_id, 
  unix_date(date) d, 
  quantity,
  revenue,
  order_count
  FROM transactions
)

SELECT 
date_in_range date, 
unix_date_in_range,
client, 
customer_id,
sum(quantity) quantity,
sum(revenue) revenue,
sum(order_count) order_count
FROM daterange
JOIN temp
ON temp.d < ( daterange.unix_date_in_range_bom_mom ) 
group by date_in_range, unix_date_in_range, client, customer_id
2018-04-17 15:33:54,885: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '884364d4-2ee1-4493-a0fc-89964b698240', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1070e77b8>]}
2018-04-17 15:33:55,154: 15:33:55 | 69 of 91 OK created table model agency_data_pipeline.retention_30_60. [CREATE TABLE in 6.43s]
2018-04-17 15:33:55,945: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '884364d4-2ee1-4493-a0fc-89964b698240', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107116d30>]}
2018-04-17 15:33:56,196: 15:33:56 | 65 of 91 OK created table model agency_data_pipeline.retention_0_365. [CREATE TABLE in 12.47s]
2018-04-17 15:34:03,839: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '884364d4-2ee1-4493-a0fc-89964b698240', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1070d9048>]}
2018-04-17 15:34:04,099: 15:34:04 | 70 of 91 OK created table model agency_data_pipeline.retention_60_plus [CREATE TABLE in 14.24s]
2018-04-17 15:34:32,037: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '884364d4-2ee1-4493-a0fc-89964b698240', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107138898>]}
2018-04-17 15:34:32,728: 15:34:32 | 68 of 91 OK created table model agency_data_pipeline.segment_list_customers_products [CREATE TABLE in 44.72s]
2018-04-17 15:34:32,730: 15:34:32 | 71 of 91 START table model agency_data_pipeline.agg_platforms_union.. [RUN]
2018-04-17 15:34:32,732: Compiling model.agency_data_pipeline.agg_platforms_union
2018-04-17 15:34:32,731: 15:34:32 | 72 of 91 START table model agency_data_pipeline.segment_proc_customers [RUN]
2018-04-17 15:34:32,738: Compiling model.agency_data_pipeline.segment_proc_customers
2018-04-17 15:34:32,750: Writing injected SQL for node "model.agency_data_pipeline.agg_platforms_union"
2018-04-17 15:34:32,754: Writing injected SQL for node "model.agency_data_pipeline.segment_proc_customers"
2018-04-17 15:34:32,758: Acquiring new bigquery connection "segment_proc_customers".
2018-04-17 15:34:32,759: Acquiring new bigquery connection "agg_platforms_union".
2018-04-17 15:34:32,759: Re-using an available connection from the pool.
2018-04-17 15:34:32,762: Re-using an available connection from the pool.
2018-04-17 15:34:33,858: Model SQL (agg_platforms_union):
SELECT 
date, 
account, 
channel,
platform,
url,
utm_campaign,
campaign,
cost,
impressions,
clicks,
transactions
FROM 
`growth-engines-pipeline`.`agency_data_pipeline`.`adwords_stats`

UNION ALL

SELECT 
date, 
account, 
channel,
platform,
url,
utm_campaign,
campaign,
cost,
impressions,
clicks,
transactions
FROM 
`growth-engines-pipeline`.`agency_data_pipeline`.`bing_ads_stats`

UNION ALL  

SELECT 
date, 
account, 
channel,
platform,
url,
utm_campaign,
campaign,
cost,
impressions,
clicks,
transactions
FROM 
`growth-engines-pipeline`.`agency_data_pipeline`.`fb_ads_stats`
2018-04-17 15:34:33,858: Model SQL (segment_proc_customers):
SELECT
client,
period,
date,
customer_id,
first_order_date,
first_order_unix_date,
recency_days,
frequency,
revenue,
quantity,
aov,
case when frequency = 1 and recency_days <= 30 and first_order_unix_date >= window_start_unix_date then 'New'
	when frequency = 1 then 'One-time Purchaser'
	when frequency > frequency_90pct and recency_days < recency_90pct and aov > aov_50pct then 'Champion'
	when recency_days < recency_90pct and frequency > frequency_75pct then 'Potential Loyalists' 
	when frequency > frequency_75pct and recency_days <= recency_50pct then 'Cant Lose'
	when recency_days < recency_50pct and frequency > frequency_50pct then 'Loyal'
	when recency_days > recency_50pct and frequency > frequency_50pct then 'Frequent, not Recent'
	when recency_days < recency_50pct and frequency < frequency_50pct then 'Recent, not Frequent'
	else 'Unbucketed' end as segment,
aov_50pct,
frequency_90pct,
frequency_75pct,
frequency_50pct,
recency_90pct,
recency_75pct,
recency_50pct
FROM
(
	SELECT 
	a.client client,
	period,
	date,
	a.customer_id customer_id,
	b.first_order_date first_order_date,
	b.first_order_unix_date first_order_unix_date,
	window_start_unix_date,
	window_end_unix_date,
	recency_days,
	frequency,
	revenue,
	quantity,
	aov,
	PERCENTILE_CONT(aov, 0.50) OVER w1 AS aov_50pct,
	PERCENTILE_CONT(frequency, 0.90) OVER w1 AS frequency_90pct,
	PERCENTILE_CONT(frequency, 0.75) OVER w1 AS frequency_75pct,
	PERCENTILE_CONT(frequency, 0.90) OVER w1 AS frequency_50pct,
	PERCENTILE_CONT(recency_days, 0.10) OVER w1 AS recency_90pct,
	PERCENTILE_CONT(recency_days, 0.25) OVER w1 AS recency_75pct,
	PERCENTILE_CONT(recency_days, 0.5) OVER w1 AS recency_50pct
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`customers_proc` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`customers_first_purchase_proc` b
	ON (
		a.client = b.client and
		a.customer_id = b.customer_id
		)
	WINDOW w1 as (PARTITION BY a.client, period, date)
)
2018-04-17 15:34:34,755: 15:34:34 | The bigquery adapter does not support query cancellation. Some queries may still be running!
2018-04-17 15:34:34,755: Connection 'master' was left open.
2018-04-17 15:34:34,756: ctrl-c
2018-04-17 15:40:29,103: Tracking: tracking
2018-04-17 15:40:29,106: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105740048>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10574dc18>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10574dfd0>]}
2018-04-17 15:40:29,949: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-04-17 15:40:29,974: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/growth-engines/dbt_modules
2018-04-17 15:40:29,980: Parsing get_column_values.sql
2018-04-17 15:40:29,997: Parsing get_url_parameter.sql
2018-04-17 15:40:30,003: Parsing split_part.sql
2018-04-17 15:40:30,011: Parsing table_exists.sql
2018-04-17 15:40:30,024: Parsing core.sql
2018-04-17 15:40:30,045: Parsing adapters/bigquery.sql
2018-04-17 15:40:30,055: Parsing adapters/common.sql
2018-04-17 15:40:30,081: Parsing adapters/postgres.sql
2018-04-17 15:40:30,087: Parsing adapters/redshift.sql
2018-04-17 15:40:30,112: Parsing etc/get_custom_schema.sql
2018-04-17 15:40:30,120: Parsing materializations/archive.sql
2018-04-17 15:40:30,152: Parsing materializations/bigquery.sql
2018-04-17 15:40:30,174: Parsing materializations/helpers.sql
2018-04-17 15:40:30,205: Parsing materializations/incremental.sql
2018-04-17 15:40:30,238: Parsing materializations/table.sql
2018-04-17 15:40:30,264: Parsing materializations/view.sql
2018-04-17 15:40:30,283: Parsing materializations/wrapper.sql
2018-04-17 15:40:30,291: Parsing schema_tests/accepted_values.sql
2018-04-17 15:40:30,299: Parsing schema_tests/not_null.sql
2018-04-17 15:40:30,305: Parsing schema_tests/relationships.sql
2018-04-17 15:40:30,312: Parsing schema_tests/unique.sql
2018-04-17 15:40:30,394: Parsing model.agency_data_pipeline.accounts_proc
2018-04-17 15:40:30,396: Parsing model.agency_data_pipeline.all_dates
2018-04-17 15:40:30,397: Parsing model.agency_data_pipeline.carts_proc
2018-04-17 15:40:30,399: Parsing model.agency_data_pipeline.clients_proc
2018-04-17 15:40:30,401: Parsing model.agency_data_pipeline.conversion_goals_proc
2018-04-17 15:40:30,403: Parsing model.agency_data_pipeline.mappings_ga_proc
2018-04-17 15:40:30,404: Acquiring new bigquery connection "master".
2018-04-17 15:40:30,405: Opening a new connection (0 currently allocated)
2018-04-17 15:40:30,411: Parsing model.agency_data_pipeline.monthend_dates
2018-04-17 15:40:30,414: Parsing model.agency_data_pipeline.adwords_ads
2018-04-17 15:40:30,416: Parsing model.agency_data_pipeline.adwords_campaigns
2018-04-17 15:40:30,418: Parsing model.agency_data_pipeline.adwords_conversions
2018-04-17 15:40:30,419: Parsing model.agency_data_pipeline.adwords_impression_share
2018-04-17 15:40:30,421: Parsing model.agency_data_pipeline.adwords_join
2018-04-17 15:40:30,423: Parsing model.agency_data_pipeline.adwords_stats
2018-04-17 15:40:30,425: Parsing model.agency_data_pipeline.adwords_urls
2018-04-17 15:40:30,426: Parsing model.agency_data_pipeline.bing_ads_ads
2018-04-17 15:40:30,429: Parsing model.agency_data_pipeline.bing_ads_conversions
2018-04-17 15:40:30,432: Parsing model.agency_data_pipeline.bing_ads_impression_share
2018-04-17 15:40:30,433: Parsing model.agency_data_pipeline.bing_ads_stats
2018-04-17 15:40:30,435: Parsing model.agency_data_pipeline.fb_adcreative
2018-04-17 15:40:30,440: Parsing model.agency_data_pipeline.fb_ads
2018-04-17 15:40:30,447: Parsing model.agency_data_pipeline.fb_ads_insights
2018-04-17 15:40:30,456: Parsing model.agency_data_pipeline.fb_ads_insights_conversions
2018-04-17 15:40:30,464: Parsing model.agency_data_pipeline.fb_ads_stats
2018-04-17 15:40:30,466: Parsing model.agency_data_pipeline.ga_conversions
2018-04-17 15:40:30,468: Parsing model.agency_data_pipeline.ga_traffic
2018-04-17 15:40:30,480: Parsing model.agency_data_pipeline.ga_transactions
2018-04-17 15:40:30,489: Parsing model.agency_data_pipeline.ga_mcf_proc
2018-04-17 15:40:30,491: Parsing model.agency_data_pipeline.ga_mcf_stats
2018-04-17 15:40:30,494: Parsing model.agency_data_pipeline.shopify_customers_proc
2018-04-17 15:40:30,500: Parsing model.agency_data_pipeline.shopify_orders_proc
2018-04-17 15:40:30,507: Parsing model.agency_data_pipeline.shopify_products_proc
2018-04-17 15:40:30,514: Parsing model.agency_data_pipeline.shopify_refunds_proc
2018-04-17 15:40:30,519: Parsing model.agency_data_pipeline.agg_campaign
2018-04-17 15:40:30,522: Parsing model.agency_data_pipeline.agg_customers_union
2018-04-17 15:40:30,523: Parsing model.agency_data_pipeline.agg_ga_campaign
2018-04-17 15:40:30,526: Parsing model.agency_data_pipeline.agg_ga_campaign_by_type
2018-04-17 15:40:30,528: Parsing model.agency_data_pipeline.agg_ga_transaction
2018-04-17 15:40:30,532: Parsing model.agency_data_pipeline.agg_ga_transaction_order_number
2018-04-17 15:40:30,536: Parsing model.agency_data_pipeline.agg_orders_union
2018-04-17 15:40:30,539: Parsing model.agency_data_pipeline.agg_platform_monthly
2018-04-17 15:40:30,541: Parsing model.agency_data_pipeline.agg_platforms_client
2018-04-17 15:40:30,544: Parsing model.agency_data_pipeline.agg_platforms_union
2018-04-17 15:40:30,546: Parsing model.agency_data_pipeline.agg_products
2018-04-17 15:40:30,548: Parsing model.agency_data_pipeline.agg_transaction
2018-04-17 15:40:30,550: Parsing model.agency_data_pipeline.agg_transaction_daily
2018-04-17 15:40:30,552: Parsing model.agency_data_pipeline.agg_transaction_line_item
2018-04-17 15:40:30,553: Parsing model.agency_data_pipeline.agg_transaction_line_item_type
2018-04-17 15:40:30,556: Parsing model.agency_data_pipeline.agg_transaction_order_number
2018-04-17 15:40:30,557: Parsing model.agency_data_pipeline.agg_transaction_product_type
2018-04-17 15:40:30,559: Parsing model.agency_data_pipeline.customers_by_transaction
2018-04-17 15:40:30,561: Parsing model.agency_data_pipeline.growth_customer_0_365
2018-04-17 15:40:30,563: Parsing model.agency_data_pipeline.growth_customer_0_365_segment
2018-04-17 15:40:30,565: Parsing model.agency_data_pipeline.growth_date_union
2018-04-17 15:40:30,568: Parsing model.agency_data_pipeline.growth_stats
2018-04-17 15:40:30,573: Parsing model.agency_data_pipeline.retention_0_365
2018-04-17 15:40:30,575: Parsing model.agency_data_pipeline.retention_0_365_new
2018-04-17 15:40:30,577: Parsing model.agency_data_pipeline.retention_0_365_reactivated
2018-04-17 15:40:30,580: Parsing model.agency_data_pipeline.retention_0_365_rebuy
2018-04-17 15:40:30,582: Parsing model.agency_data_pipeline.retention_365_730
2018-04-17 15:40:30,584: Parsing model.agency_data_pipeline.retention_730_plus
2018-04-17 15:40:30,586: Parsing model.agency_data_pipeline.retention_stats
2018-04-17 15:40:30,591: Parsing model.agency_data_pipeline.retention_stats_rebuy_rate
2018-04-17 15:40:30,594: Parsing model.agency_data_pipeline.retention_0_30
2018-04-17 15:40:30,597: Parsing model.agency_data_pipeline.retention_0_30_new
2018-04-17 15:40:30,600: Parsing model.agency_data_pipeline.retention_0_30_reactivated
2018-04-17 15:40:30,602: Parsing model.agency_data_pipeline.retention_0_30_rebuy
2018-04-17 15:40:30,604: Parsing model.agency_data_pipeline.retention_30_60
2018-04-17 15:40:30,606: Parsing model.agency_data_pipeline.retention_60_plus
2018-04-17 15:40:30,608: Parsing model.agency_data_pipeline.retention_stats_month
2018-04-17 15:40:30,615: Parsing model.agency_data_pipeline.retention_stats_rebuy_rate_month
2018-04-17 15:40:30,617: Parsing model.agency_data_pipeline.customers_first_purchase_proc
2018-04-17 15:40:30,619: Parsing model.agency_data_pipeline.customers_proc
2018-04-17 15:40:30,622: Parsing model.agency_data_pipeline.segment_list_customers
2018-04-17 15:40:30,623: Parsing model.agency_data_pipeline.segment_proc_customers
2018-04-17 15:40:30,626: Parsing model.agency_data_pipeline.segment_stats_customers
2018-04-17 15:40:30,628: Parsing model.agency_data_pipeline.segment_stats_customers_agg
2018-04-17 15:40:30,631: Parsing model.agency_data_pipeline.customers_first_purchase_product_type_proc
2018-04-17 15:40:30,632: Parsing model.agency_data_pipeline.customers_products_proc
2018-04-17 15:40:30,635: Parsing model.agency_data_pipeline.segment_list_customers_products
2018-04-17 15:40:30,637: Parsing model.agency_data_pipeline.segment_proc_customers_products
2018-04-17 15:40:30,640: Parsing model.agency_data_pipeline.segment_stats_customers_products
2018-04-17 15:40:30,642: Parsing model.agency_data_pipeline.segment_stats_customers_products_agg
2018-04-17 15:40:30,645: Parsing model.agency_data_pipeline.frequency_proc
2018-04-17 15:40:30,647: Parsing model.agency_data_pipeline.frequency_stats
2018-04-17 15:40:30,649: Parsing model.agency_data_pipeline.order_paths_agg
2018-04-17 15:40:30,651: Parsing model.agency_data_pipeline.order_paths_proc
2018-04-17 15:40:30,653: Parsing model.agency_data_pipeline.order_paths_stats
2018-04-17 15:40:30,655: Parsing model.agency_data_pipeline.products_proc
2018-04-17 15:40:30,658: Parsing model.agency_data_pipeline.segment_proc_sku
2018-04-17 15:40:30,660: Parsing model.agency_data_pipeline.segment_stats_category
2018-04-17 15:40:30,661: Parsing model.agency_data_pipeline.segment_stats_sku
2018-04-17 15:40:30,692: Found 91 models, 0 tests, 0 archives, 0 analyses, 46 macros, 0 operations
2018-04-17 15:40:30,749: 
2018-04-17 15:40:32,369: 15:40:32 | Concurrency: 4 threads (target='prod')
2018-04-17 15:40:32,369: 15:40:32 | 
2018-04-17 15:40:33,076: 15:40:33 | 1 of 91 START table model agency_data_pipeline.bing_ads_ads.......... [RUN]
2018-04-17 15:40:33,077: 15:40:33 | 2 of 91 START table model agency_data_pipeline.ga_conversions........ [RUN]
2018-04-17 15:40:33,077: 15:40:33 | 3 of 91 START table model agency_data_pipeline.adwords_conversions... [RUN]
2018-04-17 15:40:33,077: 15:40:33 | 4 of 91 START table model agency_data_pipeline.clients_proc.......... [RUN]
2018-04-17 15:40:33,078: Compiling model.agency_data_pipeline.bing_ads_ads
2018-04-17 15:40:33,078: Compiling model.agency_data_pipeline.ga_conversions
2018-04-17 15:40:33,078: Compiling model.agency_data_pipeline.adwords_conversions
2018-04-17 15:40:33,078: Compiling model.agency_data_pipeline.clients_proc
2018-04-17 15:40:33,089: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_ads"
2018-04-17 15:40:33,096: Writing injected SQL for node "model.agency_data_pipeline.ga_conversions"
2018-04-17 15:40:33,100: Writing injected SQL for node "model.agency_data_pipeline.adwords_conversions"
2018-04-17 15:40:33,105: Writing injected SQL for node "model.agency_data_pipeline.clients_proc"
2018-04-17 15:40:33,109: Acquiring new bigquery connection "ga_conversions".
2018-04-17 15:40:33,109: Acquiring new bigquery connection "bing_ads_ads".
2018-04-17 15:40:33,110: Acquiring new bigquery connection "clients_proc".
2018-04-17 15:40:33,111: Acquiring new bigquery connection "adwords_conversions".
2018-04-17 15:40:33,111: Opening a new connection (1 currently allocated)
2018-04-17 15:40:33,114: Opening a new connection (2 currently allocated)
2018-04-17 15:40:33,117: Opening a new connection (3 currently allocated)
2018-04-17 15:40:33,324: Opening a new connection (4 currently allocated)
2018-04-17 15:40:34,923: Model SQL (bing_ads_ads):
select
date, 
account, 
channel,
platform,
campaignid,
campaignname,
max(lower(trim(replace(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$','' ),'.html',''),'/'))) as url,
utm_campaign,
sum(cost) as cost,
sum(impressions) as impressions,
sum(clicks) as clicks,
sum(conversions) as conversions
from 
  ( 
SELECT  
cast(gregoriandate as date) date,
replace(accountname,',','') account,
'Paid' as channel,
'Bing Ads' as platform,
adid,
adtype,
campaignid, 
campaignname,
finalurl url,
case when regexp_contains(destinationurl, 'utm_campaign')
	then replace(lower(nullif(
  

    split(
        
  

    split(
        destinationurl,
        'utm_campaign='
        )[offset(1)]


,
        '&'
        )[offset(0)]


,'')),'+',' ') 
	else null end as utm_campaign,
spend cost, 
impressions, 
clicks, 
conversions,
_sdc_sequence,
first_value(_sdc_sequence) OVER (PARTITION BY adid, gregoriandate ORDER BY _sdc_sequence DESC) lv
FROM `growth-engines-pipeline.bing_ads.ad_performance_report` 
  )

where lv = _sdc_sequence
group by date, account, channel, platform, campaignid, campaignname, utm_campaign
2018-04-17 15:40:34,924: Model SQL (ga_conversions):
select 
client,
client_name,
platform,
goal_name,
goal_type,
account,
time_of_entry
from  ( 

SELECT  
client,
client_name,
platform,
trim(goal_name) goal_name,
goal_type,
account,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform, goal_name ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.conversion_goals` 
WHERE platform = 'Google Analytics'

) 

WHERE lv = time_of_entry
2018-04-17 15:40:34,925: Model SQL (adwords_conversions):
select 
client,
client_name,
platform,
goal_name,
goal_type,
account,
time_of_entry
from  ( 

SELECT  
client,
client_name,
platform,
trim(lower(goal_name)) goal_name,
goal_type,
account,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform, goal_name ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.conversion_goals` 
WHERE platform = 'Adwords'

) 

WHERE lv = time_of_entry
2018-04-17 15:40:34,925: Model SQL (clients_proc):
select 
client,
client_name,
account,
platform
from  ( 

SELECT  
client,
client_name,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.accounts`
where client_name != ''
) 

WHERE lv = time_of_entry
2018-04-17 15:40:36,064: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1022e9b38>]}
2018-04-17 15:40:36,082: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1022e9748>]}
2018-04-17 15:40:36,356: 15:40:36 | 2 of 91 OK created table model agency_data_pipeline.ga_conversions... [CREATE TABLE in 2.99s]
2018-04-17 15:40:36,357: 15:40:36 | 5 of 91 START table model agency_data_pipeline.adwords_urls.......... [RUN]
2018-04-17 15:40:36,358: Compiling model.agency_data_pipeline.adwords_urls
2018-04-17 15:40:36,363: Writing injected SQL for node "model.agency_data_pipeline.adwords_urls"
2018-04-17 15:40:36,366: Acquiring new bigquery connection "adwords_urls".
2018-04-17 15:40:36,367: Re-using an available connection from the pool.
2018-04-17 15:40:36,656: 15:40:36 | 4 of 91 OK created table model agency_data_pipeline.clients_proc..... [CREATE TABLE in 3.00s]
2018-04-17 15:40:36,656: 15:40:36 | 6 of 91 START table model agency_data_pipeline.all_dates............. [RUN]
2018-04-17 15:40:36,657: Compiling model.agency_data_pipeline.all_dates
2018-04-17 15:40:36,667: Writing injected SQL for node "model.agency_data_pipeline.all_dates"
2018-04-17 15:40:36,673: Acquiring new bigquery connection "all_dates".
2018-04-17 15:40:36,673: Re-using an available connection from the pool.
2018-04-17 15:40:37,179: Model SQL (adwords_urls):
SELECT
campaignid,
lower(trim(regexp_replace(replace(replace(replace(replace(finalurl,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url

FROM (

SELECT  
campaignid,
finalurl,
first_value(finalurl) OVER (PARTITION BY campaignid ORDER BY day DESC) lv
FROM `growth-engines-pipeline.adwords_2.FINAL_URL_REPORT`
)

WHERE lv = finalurl
group by campaignid, url
order by campaignid asc
2018-04-17 15:40:37,360: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1022e9e10>]}
2018-04-17 15:40:37,435: Model SQL (all_dates):
SELECT 
date_in_range,
unix_date(date_in_range) unix_date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-04-17 15:40:37,665: 15:40:37 | 3 of 91 OK created table model agency_data_pipeline.adwords_conversions [CREATE TABLE in 4.28s]
2018-04-17 15:40:37,666: 15:40:37 | 7 of 91 START table model agency_data_pipeline.monthend_dates........ [RUN]
2018-04-17 15:40:37,666: Compiling model.agency_data_pipeline.monthend_dates
2018-04-17 15:40:37,673: Writing injected SQL for node "model.agency_data_pipeline.monthend_dates"
2018-04-17 15:40:37,673: Acquiring new bigquery connection "monthend_dates".
2018-04-17 15:40:37,674: Re-using an available connection from the pool.
2018-04-17 15:40:38,346: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105904278>]}
2018-04-17 15:40:38,392: Model SQL (monthend_dates):
SELECT
date_in_range,
date_in_range_bom,
date_in_range_bom_mom,
unix_date_in_range,
unix_date_in_range_bom,
unix_date(date_in_range_bom_mom) unix_date_in_range_bom_mom,
yyyymm,
date_in_range_yoy,
unix_date(date_in_range_yoy) unix_date_in_range_yoy

FROM
(
	SELECT 
	date_in_range,
	date_in_range_bom,
	date_sub(date_in_range_bom, INTERVAL 1 MONTH) date_in_range_bom_mom,
  date_sub(date_in_range, INTERVAL 1 YEAR) date_in_range_yoy,
	unix_date_in_range,
	unix_date(date_in_range_bom) unix_date_in_range_bom,
	yyyymm,
	first_value(date_in_range) over (partition by yyyymm order by date_in_range desc) monthend_date_in_range
	FROM
	( 
		SELECT 
		date_in_range,
		date_trunc( date_in_range, MONTH) date_in_range_bom,
		unix_date(date_in_range) unix_date_in_range,
		format_date("%Y-%m", date_in_range) AS yyyymm
		FROM UNNEST(
		    GENERATE_DATE_ARRAY(DATE('2016-01-31'), CURRENT_DATE(), INTERVAL 1 DAY)
		) AS date_in_range
	)
)
where date_in_range = monthend_date_in_range
2018-04-17 15:40:38,542: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1022e9748>]}
2018-04-17 15:40:38,717: 15:40:38 | 1 of 91 OK created table model agency_data_pipeline.bing_ads_ads..... [CREATE TABLE in 5.27s]
2018-04-17 15:40:38,718: 15:40:38 | 8 of 91 START table model agency_data_pipeline.bing_ads_impression_share [RUN]
2018-04-17 15:40:38,720: Compiling model.agency_data_pipeline.bing_ads_impression_share
2018-04-17 15:40:38,732: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_impression_share"
2018-04-17 15:40:38,734: Acquiring new bigquery connection "bing_ads_impression_share".
2018-04-17 15:40:38,735: Re-using an available connection from the pool.
2018-04-17 15:40:38,986: 15:40:38 | 6 of 91 OK created table model agency_data_pipeline.all_dates........ [CREATE TABLE in 1.88s]
2018-04-17 15:40:38,986: 15:40:38 | 9 of 91 START table model agency_data_pipeline.adwords_campaigns..... [RUN]
2018-04-17 15:40:38,987: Compiling model.agency_data_pipeline.adwords_campaigns
2018-04-17 15:40:38,998: Writing injected SQL for node "model.agency_data_pipeline.adwords_campaigns"
2018-04-17 15:40:39,001: Acquiring new bigquery connection "adwords_campaigns".
2018-04-17 15:40:39,001: Re-using an available connection from the pool.
2018-04-17 15:40:39,596: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1022e9b38>]}
2018-04-17 15:40:39,598: Model SQL (bing_ads_impression_share):
SELECT 
date, 
account,
channel,
platform,
sum(impressions) impressions,
sum(available_impressions) available_impressions
FROM

(

SELECT  
cast(gregoriandate as date) date,
replace(accountname,',','') account,  
'Paid' as channel,
'Bing Ads' as platform,
case when impressionsharepercent is null then 0 else impressions end as impressions,
cast(round(case when ( impressionsharepercent is not null and impressionsharepercent > 0 ) then (impressions*100)/impressionsharepercent else 0 end) as int64) as available_impressions,
_sdc_sequence,
first_value(_sdc_sequence) OVER (PARTITION BY campaignid, gregoriandate ORDER BY _sdc_sequence DESC) lv
FROM `growth-engines-pipeline.bing_ads.campaign_performance_report` 

)

where lv = _sdc_sequence
group by date, account, channel, platform
2018-04-17 15:40:39,602: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1022e9e10>]}
2018-04-17 15:40:39,731: Model SQL (adwords_campaigns):
select
day,
campaignid, 
campaign,
account, 
channel,
platform,
sum(cost) cost,
sum(impressions) impressions,
sum(clicks) clicks,
sum(impression_share_num) impression_share_num,
sum(impression_share_den) impression_share_den
from 
  ( 
	SELECT  
	day,
	campaignid,
	campaign,
	account as account,
	'Paid' as channel,
	'Adwords' as platform,
	cost/1000000 cost, 
	impressions as impressions, 
	clicks, 
	case when searchimprshare is not null then impressions end as impression_share_num,
	case when searchimprshare is not null then impressions/(searchimprshare/100) end as impression_share_den,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY campaignid, day ORDER BY _sdc_sequence DESC) lv
	FROM `growth-engines-pipeline.adwords_2.CAMPAIGN_PERFORMANCE_REPORT`
  )
where lv = _sdc_sequence
group by day, campaignid, account, channel, platform, campaign
2018-04-17 15:40:39,847: 15:40:39 | 5 of 91 OK created table model agency_data_pipeline.adwords_urls..... [CREATE TABLE in 3.24s]
2018-04-17 15:40:39,848: 15:40:39 | 10 of 91 START table model agency_data_pipeline.accounts_proc........ [RUN]
2018-04-17 15:40:39,848: Compiling model.agency_data_pipeline.accounts_proc
2018-04-17 15:40:39,857: Writing injected SQL for node "model.agency_data_pipeline.accounts_proc"
2018-04-17 15:40:39,861: Acquiring new bigquery connection "accounts_proc".
2018-04-17 15:40:39,861: Re-using an available connection from the pool.
2018-04-17 15:40:40,118: 15:40:40 | 7 of 91 OK created table model agency_data_pipeline.monthend_dates... [CREATE TABLE in 1.94s]
2018-04-17 15:40:40,119: 15:40:40 | 11 of 91 START table model agency_data_pipeline.carts_proc........... [RUN]
2018-04-17 15:40:40,119: Compiling model.agency_data_pipeline.carts_proc
2018-04-17 15:40:40,123: Writing injected SQL for node "model.agency_data_pipeline.carts_proc"
2018-04-17 15:40:40,124: Acquiring new bigquery connection "carts_proc".
2018-04-17 15:40:40,124: Re-using an available connection from the pool.
2018-04-17 15:40:40,722: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105904278>]}
2018-04-17 15:40:40,743: Model SQL (accounts_proc):
select 
client,
account,
platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.accounts` 

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-04-17 15:40:40,959: Model SQL (carts_proc):
select 
client,
client_name,
account,
platform
from  ( 

SELECT  
client,
client_name,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.accounts`
WHERE platform in ('Shopify', 'Custom cart')

) 

WHERE lv = time_of_entry
2018-04-17 15:40:41,021: 15:40:41 | 8 of 91 OK created table model agency_data_pipeline.bing_ads_impression_share [CREATE TABLE in 2.00s]
2018-04-17 15:40:41,021: 15:40:41 | 12 of 91 START table model agency_data_pipeline.conversion_goals_proc [RUN]
2018-04-17 15:40:41,022: Compiling model.agency_data_pipeline.conversion_goals_proc
2018-04-17 15:40:41,028: Writing injected SQL for node "model.agency_data_pipeline.conversion_goals_proc"
2018-04-17 15:40:41,029: Acquiring new bigquery connection "conversion_goals_proc".
2018-04-17 15:40:41,029: Re-using an available connection from the pool.
2018-04-17 15:40:41,807: Model SQL (conversion_goals_proc):
select 
client,
platform,
goal_name,
max(goal_type) goal_type,
account,
max(time_of_entry) time_of_entry
from  ( 

SELECT  
client,
platform,
trim(replace(replace(lower(goal_name),',',''),' ','')) goal_name,
goal_type,
account,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY platform ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.conversion_goals` 

) 

WHERE lv = time_of_entry
group by client, platform, account, goal_name
2018-04-17 15:40:41,857: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1022e9b38>]}
2018-04-17 15:40:42,079: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1022e9e10>]}
2018-04-17 15:40:42,117: 15:40:42 | 10 of 91 OK created table model agency_data_pipeline.accounts_proc... [CREATE TABLE in 2.01s]
2018-04-17 15:40:42,401: 15:40:42 | 11 of 91 OK created table model agency_data_pipeline.carts_proc...... [CREATE TABLE in 1.96s]
2018-04-17 15:40:44,046: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105904278>]}
2018-04-17 15:40:44,376: 15:40:44 | 12 of 91 OK created table model agency_data_pipeline.conversion_goals_proc [CREATE TABLE in 3.02s]
2018-04-17 15:40:45,319: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105917a90>]}
2018-04-17 15:40:45,563: 15:40:45 | 9 of 91 OK created table model agency_data_pipeline.adwords_campaigns [CREATE TABLE in 6.33s]
2018-04-17 15:40:45,564: 15:40:45 | 13 of 91 START table model agency_data_pipeline.fb_ads_insights_conversions [RUN]
2018-04-17 15:40:45,564: 15:40:45 | 14 of 91 START table model agency_data_pipeline.bing_ads_conversions. [RUN]
2018-04-17 15:40:45,565: Compiling model.agency_data_pipeline.fb_ads_insights_conversions
2018-04-17 15:40:45,564: 15:40:45 | 15 of 91 START table model agency_data_pipeline.shopify_refunds_proc. [RUN]
2018-04-17 15:40:45,565: 15:40:45 | 16 of 91 START table model agency_data_pipeline.adwords_ads.......... [RUN]
2018-04-17 15:40:45,565: Compiling model.agency_data_pipeline.bing_ads_conversions
2018-04-17 15:40:45,571: Compiling model.agency_data_pipeline.shopify_refunds_proc
2018-04-17 15:40:45,575: Acquiring new bigquery connection "fb_ads_insights_conversions".
2018-04-17 15:40:45,575: Compiling model.agency_data_pipeline.adwords_ads
2018-04-17 15:40:45,592: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_conversions"
2018-04-17 15:40:45,595: Acquiring new bigquery connection "shopify_refunds_proc".
2018-04-17 15:40:45,595: Re-using an available connection from the pool.
2018-04-17 15:40:45,604: Writing injected SQL for node "model.agency_data_pipeline.adwords_ads"
2018-04-17 15:40:45,605: Fetching data for query fb_ads_insights_conversions:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 15:40:45,605: Re-using an available connection from the pool.
2018-04-17 15:40:45,605: Acquiring new bigquery connection "bing_ads_conversions".
2018-04-17 15:40:45,606: Fetching data for query shopify_refunds_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 15:40:45,606: Re-using an available connection from the pool.
2018-04-17 15:40:45,608: Acquiring new bigquery connection "adwords_ads".
2018-04-17 15:40:45,611: Re-using an available connection from the pool.
2018-04-17 15:40:46,798: Model SQL (bing_ads_conversions):
SELECT
date, 
a.account account, 
a.channel channel,
a.platform platform,
campaignid,
campaignname,
sum( case when b.goal_type = 'Transactions' then conversions else 0 end ) as transactions
FROM

  ( 
SELECT  
cast(gregoriandate as date) date,
replace(accountname,',','') account,
'Paid' as channel,
'Bing Ads' as platform,
trim(replace(replace(lower(goal),',',''),' ','')) goal,
goalid,
campaignid,
campaignname,
conversions,
_sdc_sequence,
first_value(_sdc_sequence) OVER (PARTITION BY campaignid, goalid, gregoriandate ORDER BY _sdc_sequence DESC) lv
FROM `growth-engines-pipeline.bing_ads.goals_and_funnels_report` 

  ) a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`conversion_goals_proc` b
ON (
	a.account = b.account AND
	a.platform = b.platform AND
	a.goal = b.goal_name
)
where a.lv = a._sdc_sequence
group by date, account, channel, platform, campaignid, campaignname
2018-04-17 15:40:46,799: Model SQL (adwords_ads):
SELECT  
day,
campaignid,
a.account as account,
utm_campaign,
sum( case when b.goal_type = 'Transaction' then conversions else 0 end ) as transactions
FROM (

	SELECT  
	day,
	adid,
	campaignid,
	account,
	lower(conversionname) conversionname,
	conversions,
	lower(campaign) utm_campaign,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY campaignid, day ORDER BY _sdc_sequence DESC) lv
	FROM
	`growth-engines-pipeline.adwords_2.AD_PERFORMANCE_REPORT`

) a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_conversions` b
ON ( a.conversionname = b.goal_name
	AND a.account = b.account )
WHERE lv = _sdc_sequence
group by day, campaignid, account, utm_campaign
2018-04-17 15:40:46,840: Writing injected SQL for node "model.agency_data_pipeline.shopify_refunds_proc"
2018-04-17 15:40:46,921: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_insights_conversions"
2018-04-17 15:40:47,819: Model SQL (fb_ads_insights_conversions):




with fb_ads_insights_conversions as (

	    
		   	SELECT 
			date_start,
			campaign_id,
			campaign_name,
			ad_id,
			account_name,
			spend,
			reach,
			inline_link_clicks,
			_sdc_sequence,
			action_type,
			value
			FROM `growth-engines-pipeline.fb_ads_luca_danni.ads_insights`
			cross join unnest(actions)
		    
	   

)

SELECT * 
FROM 
	(
    SELECT
    date_start date,
    campaign_id,
    campaign_name campaign,
    ad_id,
    account_name account,
    action_type,
    value conversions,
    first_value(_sdc_sequence) OVER (PARTITION BY ad_id, date_start ORDER BY _sdc_sequence DESC) lv,
    _sdc_sequence
    FROM fb_ads_insights_conversions
   	)
where lv = _sdc_sequence
and action_type like '%purchase%'


2018-04-17 15:40:47,819: Model SQL (shopify_refunds_proc):




with refunds as (

	
	SELECT
	order_number,
	checkout_id,
	financial_status,
	line_item_id,
	quantity,
	subtotal,
	line_item.variant_id variant_id,
	line_item.id refund_id,
 	_sdc_sequence
	FROM `growth-engines-pipeline.shopify_lucadanni.orders` 
	cross join unnest(refunds), unnest(refund_line_items)
  	where financial_status like '%refund%'
	
	

)

SELECT * 
FROM 
	(
    SELECT
	order_number,
	checkout_id,
	financial_status,
	line_item_id,
	quantity,
	subtotal refund_amount,
	variant_id,
	refund_id,
 	_sdc_sequence,
    first_value(_sdc_sequence) OVER (PARTITION BY order_number, line_item_id ORDER BY _sdc_sequence DESC) lv
    FROM refunds
   	) 
WHERE lv = _sdc_sequence


2018-04-17 15:40:49,050: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1058272e8>]}
2018-04-17 15:40:49,064: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10235ba90>]}
2018-04-17 15:40:49,321: 15:40:49 | 16 of 91 OK created table model agency_data_pipeline.adwords_ads..... [CREATE TABLE in 3.47s]
2018-04-17 15:40:49,322: 15:40:49 | 17 of 91 START table model agency_data_pipeline.mappings_ga_proc..... [RUN]
2018-04-17 15:40:49,323: Compiling model.agency_data_pipeline.mappings_ga_proc
2018-04-17 15:40:49,331: Writing injected SQL for node "model.agency_data_pipeline.mappings_ga_proc"
2018-04-17 15:40:49,333: Acquiring new bigquery connection "mappings_ga_proc".
2018-04-17 15:40:49,334: Re-using an available connection from the pool.
2018-04-17 15:40:49,584: 15:40:49 | 14 of 91 OK created table model agency_data_pipeline.bing_ads_conversions [CREATE TABLE in 3.50s]
2018-04-17 15:40:49,584: 15:40:49 | 18 of 91 START table model agency_data_pipeline.fb_adcreative........ [RUN]
2018-04-17 15:40:49,584: Compiling model.agency_data_pipeline.fb_adcreative
2018-04-17 15:40:49,596: Acquiring new bigquery connection "fb_adcreative".
2018-04-17 15:40:49,597: Re-using an available connection from the pool.
2018-04-17 15:40:49,597: Fetching data for query fb_adcreative:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 15:40:49,941: Writing injected SQL for node "model.agency_data_pipeline.fb_adcreative"
2018-04-17 15:40:50,079: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10596e518>]}
2018-04-17 15:40:50,079: Model SQL (mappings_ga_proc):
select 
client,
account,
client_name,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
account,
client_name,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.mappings_ga` 

) 

WHERE lv = time_of_entry
and client in (select client from `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc` )
group by client, account, client_name, source, medium, platform_n, channel_n, time_of_entry
2018-04-17 15:40:50,334: 15:40:50 | 15 of 91 OK created table model agency_data_pipeline.shopify_refunds_proc [CREATE TABLE in 4.51s]
2018-04-17 15:40:50,334: 15:40:50 | 19 of 91 START table model agency_data_pipeline.ga_mcf_proc.......... [RUN]
2018-04-17 15:40:50,334: Compiling model.agency_data_pipeline.ga_mcf_proc
2018-04-17 15:40:50,339: Writing injected SQL for node "model.agency_data_pipeline.ga_mcf_proc"
2018-04-17 15:40:50,343: Acquiring new bigquery connection "ga_mcf_proc".
2018-04-17 15:40:50,343: Re-using an available connection from the pool.
2018-04-17 15:40:50,707: Model SQL (fb_adcreative):




with fb_adcreative as (


	    
		   	SELECT 
			id,
			object_url,
			url_tags,
			_sdc_sequence
			FROM `growth-engines-pipeline.fb_ads_luca_danni.adcreative`
		    
	   
)

select creative_id, max(url) url
from (
  select
  id creative_id,
  lower(trim(regexp_replace(replace(replace(replace(replace(object_url,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
  first_value(_sdc_sequence) OVER (PARTITION BY id ORDER BY _sdc_sequence DESC) lv,
  _sdc_sequence
  from fb_adcreative
  )
where lv = _sdc_sequence
group by creative_id


2018-04-17 15:40:51,131: Model SQL (ga_mcf_proc):
SELECT 
date,
account,
'Google Analytics' as lookup_platform,
source_medium_path,
trim(lower(split(split(source_medium_path,'->')[SAFE_ORDINAL(1)],'/')[SAFE_ORDINAL(1)])) as source,
trim(lower(split(split(source_medium_path,'->')[SAFE_ORDINAL(1)],'/')[SAFE_ORDINAL(2)])) as medium,
first_interaction_campaign campaign,
cast(regexp_replace(transaction_id, r'#', '') as int64) transactionid,
max(first_interaction_conversions) transactions,
max(first_interaction_conversion_value) revenue
FROM `growth-engines-pipeline.agency_data_pipeline.ga_mcf`
where account in (select account from `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc` where platform = 'Google Analytics')
group by date, account, source, medium, campaign, source_medium_path, lookup_platform, transactionid
2018-04-17 15:40:52,334: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105904908>]}
2018-04-17 15:40:52,339: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1058272e8>]}
2018-04-17 15:40:52,596: 15:40:52 | 13 of 91 OK created table model agency_data_pipeline.fb_ads_insights_conversions [CREATE TABLE in 6.77s]
2018-04-17 15:40:52,597: 15:40:52 | 20 of 91 START table model agency_data_pipeline.fb_ads_insights...... [RUN]
2018-04-17 15:40:52,599: Compiling model.agency_data_pipeline.fb_ads_insights
2018-04-17 15:40:52,612: Acquiring new bigquery connection "fb_ads_insights".
2018-04-17 15:40:52,613: Re-using an available connection from the pool.
2018-04-17 15:40:52,613: Fetching data for query fb_ads_insights:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 15:40:52,885: 15:40:52 | 17 of 91 OK created table model agency_data_pipeline.mappings_ga_proc [CREATE TABLE in 3.02s]
2018-04-17 15:40:52,999: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10235ba90>]}
2018-04-17 15:40:53,007: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_insights"
2018-04-17 15:40:53,286: 15:40:53 | 18 of 91 OK created table model agency_data_pipeline.fb_adcreative... [CREATE TABLE in 3.41s]
2018-04-17 15:40:53,835: Model SQL (fb_ads_insights):




with fb_ads_insights as (

	    
		   	SELECT 
			date_start,
			campaign_id,
			campaign_name,
			ad_id,
			account_name,
			spend,
			reach,
			inline_link_clicks,
			_sdc_sequence,
			first_value(_sdc_sequence) OVER (PARTITION BY date_start, ad_id, campaign_id ORDER BY _sdc_sequence DESC) lv
			FROM `growth-engines-pipeline.fb_ads_luca_danni.ads_insights`
		    
	   

)

select
date_start date,
campaign_id,
campaign_name campaign,
ad_id,
account_name account,
max(spend) cost,
max(reach) impressions,
max(inline_link_clicks) clicks
from fb_ads_insights
where lv = _sdc_sequence
group by date, campaign_id, ad_id, account, campaign


2018-04-17 15:40:55,704: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10596e518>]}
2018-04-17 15:40:55,968: 15:40:55 | 19 of 91 OK created table model agency_data_pipeline.ga_mcf_proc..... [CREATE TABLE in 5.37s]
2018-04-17 15:40:57,370: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105904908>]}
2018-04-17 15:40:59,056: 15:40:59 | 20 of 91 OK created table model agency_data_pipeline.fb_ads_insights. [CREATE TABLE in 4.77s]
2018-04-17 15:40:59,057: 15:40:59 | 21 of 91 START table model agency_data_pipeline.shopify_customers_proc [RUN]
2018-04-17 15:40:59,058: 15:40:59 | 22 of 91 START table model agency_data_pipeline.fb_ads............... [RUN]
2018-04-17 15:40:59,058: Compiling model.agency_data_pipeline.shopify_customers_proc
2018-04-17 15:40:59,058: Compiling model.agency_data_pipeline.fb_ads
2018-04-17 15:40:59,074: Acquiring new bigquery connection "shopify_customers_proc".
2018-04-17 15:40:59,077: Acquiring new bigquery connection "fb_ads".
2018-04-17 15:40:59,077: Re-using an available connection from the pool.
2018-04-17 15:40:59,077: Fetching data for query shopify_customers_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 15:40:59,077: Re-using an available connection from the pool.
2018-04-17 15:40:59,078: Fetching data for query fb_ads:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 15:40:59,502: Writing injected SQL for node "model.agency_data_pipeline.fb_ads"
2018-04-17 15:40:59,507: Writing injected SQL for node "model.agency_data_pipeline.shopify_customers_proc"
2018-04-17 15:41:00,374: Model SQL (fb_ads):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`fb_adcreative`





with fb_ads as (

	    
		   	SELECT 
			id ad_id,
			creative.creative_id creative_id,
			_sdc_sequence
			FROM `growth-engines-pipeline.fb_ads_luca_danni.ads`
		     
	   

)

SELECT
a.ad_id,
b.creative_id,
b.url
FROM (
    SELECT
    ad_id,
    creative_id,
    first_value(_sdc_sequence) OVER (PARTITION BY ad_id ORDER BY _sdc_sequence DESC) lv,
    _sdc_sequence
    FROM fb_ads
    ) a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`fb_adcreative` b
ON (
	a.creative_id = b.creative_id 
)
WHERE a.lv = a._sdc_sequence


2018-04-17 15:41:00,476: Model SQL (shopify_customers_proc):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc`





with customers as (

	
	SELECT
	'lucadanni' client_name,
	'Shopify' as lookup_platform,
	cast(created_at as date) created_at,
	id,
	first_name,
	last_name,
	email,
	_sdc_sequence,
	first_value(_sdc_sequence) over (partition by id, _sdc_sequence order by _sdc_sequence desc) lv
	FROM `growth-engines-pipeline.shopify_lucadanni.customers` 
	
	

)

SELECT
account,
client,
platform,
id,
min(created_at) created_at,
max(first_name) first_name,
max(last_name) last_name,
max(email) email
FROM (
	SELECT
	b.account,
	b.client,
	b.platform,
	created_at,
	id,
	first_name,
	last_name,
	email
	FROM customers a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
	ON ( a.client_name = b.client_name
	  AND a.lookup_platform = b.platform )
	where a.lv = a._sdc_sequence
)
group by account, client, platform, id

2018-04-17 15:41:03,103: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10235b1d0>]}
2018-04-17 15:41:03,370: 15:41:03 | 22 of 91 OK created table model agency_data_pipeline.fb_ads.......... [CREATE TABLE in 4.04s]
2018-04-17 15:41:05,312: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105917a90>]}
2018-04-17 15:41:05,593: 15:41:05 | 21 of 91 OK created table model agency_data_pipeline.shopify_customers_proc [CREATE TABLE in 6.25s]
2018-04-17 15:41:05,594: 15:41:05 | 23 of 91 START table model agency_data_pipeline.ga_mcf_stats......... [RUN]
2018-04-17 15:41:05,595: Compiling model.agency_data_pipeline.ga_mcf_stats
2018-04-17 15:41:05,595: 15:41:05 | 24 of 91 START table model agency_data_pipeline.shopify_orders_proc.. [RUN]
2018-04-17 15:41:05,602: Compiling model.agency_data_pipeline.shopify_orders_proc
2018-04-17 15:41:05,612: Writing injected SQL for node "model.agency_data_pipeline.ga_mcf_stats"
2018-04-17 15:41:05,620: Acquiring new bigquery connection "shopify_orders_proc".
2018-04-17 15:41:05,620: Re-using an available connection from the pool.
2018-04-17 15:41:05,620: Fetching data for query shopify_orders_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 15:41:05,595: 15:41:05 | 25 of 91 START table model agency_data_pipeline.agg_customers_union.. [RUN]
2018-04-17 15:41:05,621: Compiling model.agency_data_pipeline.agg_customers_union
2018-04-17 15:41:05,625: Writing injected SQL for node "model.agency_data_pipeline.agg_customers_union"
2018-04-17 15:41:05,595: 15:41:05 | 26 of 91 START table model agency_data_pipeline.shopify_products_proc [RUN]
2018-04-17 15:41:05,627: Compiling model.agency_data_pipeline.shopify_products_proc
2018-04-17 15:41:05,628: Acquiring new bigquery connection "ga_mcf_stats".
2018-04-17 15:41:05,631: Acquiring new bigquery connection "agg_customers_union".
2018-04-17 15:41:05,648: Acquiring new bigquery connection "shopify_products_proc".
2018-04-17 15:41:05,649: Re-using an available connection from the pool.
2018-04-17 15:41:05,650: Re-using an available connection from the pool.
2018-04-17 15:41:05,650: Re-using an available connection from the pool.
2018-04-17 15:41:05,651: Fetching data for query shopify_products_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 15:41:06,082: Writing injected SQL for node "model.agency_data_pipeline.shopify_orders_proc"
2018-04-17 15:41:06,088: Writing injected SQL for node "model.agency_data_pipeline.shopify_products_proc"
2018-04-17 15:41:06,519: Model SQL (ga_mcf_stats):
SELECT  
date,
a.account account,
b.client client,
case when c.platform is null then "Unmapped" else c.platform end as platform,
case when c.channel is null then "Unmapped" else c.channel end as channel,
lower(a.source) source,
lower(a.medium) medium,
lower(campaign) campaign,
transactionid,
sum(transactions) first_touch_transactions,
sum(revenue) first_touch_revenue
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`ga_mcf_proc` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc` b 
ON ( a.account = b.account and
	a.lookup_platform = b.platform )
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc` c
ON ( lower(a.source) = c.source
  AND lower(a.medium) = c.medium 
  and a.account = c.account )
group by date, account, client, source, medium, campaign, platform, channel, transactionid
2018-04-17 15:41:06,550: Model SQL (agg_customers_union):
SELECT *
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`shopify_customers_proc`
2018-04-17 15:41:06,972: Model SQL (shopify_products_proc):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc`, `growth-engines-pipeline`.`agency_data_pipeline`.`shopify_refunds_proc`





with products as (

	
	SELECT
	'lucadanni' client_name,
	'Shopify' as lookup_platform,
	product_type,
	product_id,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY product_id ORDER BY _sdc_sequence DESC) lv
	FROM `growth-engines-pipeline.shopify_lucadanni.products` 
	cross join unnest(variants)
	
	

)

SELECT
b.account,
b.client,
b.platform,
max(product_type) product_type,
product_id
FROM products a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
ON ( a.client_name = b.client_name
  AND a.lookup_platform = b.platform )
where a.lv = a._sdc_sequence
group by product_id, account, client, platform


2018-04-17 15:41:06,973: Model SQL (shopify_orders_proc):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc`, `growth-engines-pipeline`.`agency_data_pipeline`.`shopify_refunds_proc`





with orders as (

	
	SELECT
	'lucadanni' client_name,
	'Shopify' as lookup_platform,
	created_at,
	order_number,
	quantity,
	cast(pre_tax_price as float64) price, 
	total_line_items_price total_order_price_undiscounted,
	total_discounts,
	cast(discounted_price as float64) total_order_shipping_price,
	total_price_usd total_order_price_incl_shipping,
	checkout_id,
	product_id, 
	landing_site,
	sku, 
	variant_title, 
	variant_id,
	_id line_item_id,
	customer.id customer_id,
	customer.orders_count orders_count,
	customer.created_at customer_created_at,
	customer.last_order_id last_order_id,
	financial_status,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY order_number, _id ORDER BY _sdc_sequence DESC) lv
	FROM `growth-engines-pipeline.shopify_lucadanni.orders` 
	cross join unnest(line_items), unnest(shipping_lines)
	where source_name != 'shopify_draft_order'
	
	

)

SELECT
b.account,
b.client,
b.platform,
created_at,
a.order_number,
a.quantity,
c.quantity refund_quantity,
case when c.quantity is not null then a.quantity - c.quantity else a.quantity end as final_quantity,
price, 
total_order_price_undiscounted,
total_discounts,
total_order_shipping_price,
total_order_price_incl_shipping,
refund_amount,
case when refund_amount is not null then price - refund_amount else price end as final_price,
a.checkout_id,
a.product_id, 
landing_site,
sku, 
variant_title, 
a.variant_id,
a.line_item_id,	
customer_id,
orders_count,
customer_created_at,
last_order_id,
a.financial_status
FROM orders a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
ON ( a.client_name = b.client_name
  AND a.lookup_platform = b.platform )
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`shopify_refunds_proc` c
ON ( a.order_number = c.order_number
	AND a.line_item_id = c.line_item_id )   	
where a.lv = a._sdc_sequence


2018-04-17 15:41:09,903: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10593d390>]}
2018-04-17 15:41:10,146: 15:41:10 | 25 of 91 OK created table model agency_data_pipeline.agg_customers_union [CREATE TABLE in 4.28s]
2018-04-17 15:41:10,147: 15:41:10 | 27 of 91 START table model agency_data_pipeline.bing_ads_stats....... [RUN]
2018-04-17 15:41:10,147: Compiling model.agency_data_pipeline.bing_ads_stats
2018-04-17 15:41:10,155: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_stats"
2018-04-17 15:41:10,156: Acquiring new bigquery connection "bing_ads_stats".
2018-04-17 15:41:10,156: Re-using an available connection from the pool.
2018-04-17 15:41:10,993: Model SQL (bing_ads_stats):
select
a.date, 
a.account, 
a.channel,
a.platform,
url,
a.campaignname campaign,
utm_campaign,
cost,
clicks,
impressions,
transactions
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`bing_ads_ads` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`bing_ads_conversions` b
ON (
	a.date = b.date AND
	a.account = b.account AND
	a.campaignid = b.campaignid

)
2018-04-17 15:41:11,435: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105962710>]}
2018-04-17 15:41:12,107: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105904908>]}
2018-04-17 15:41:12,130: 15:41:12 | 26 of 91 OK created table model agency_data_pipeline.shopify_products_proc [CREATE TABLE in 5.81s]
2018-04-17 15:41:12,389: 15:41:12 | 23 of 91 OK created table model agency_data_pipeline.ga_mcf_stats.... [CREATE TABLE in 6.51s]
2018-04-17 15:41:14,311: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x102317198>]}
2018-04-17 15:41:14,576: 15:41:14 | 27 of 91 OK created table model agency_data_pipeline.bing_ads_stats.. [CREATE TABLE in 4.16s]
2018-04-17 15:41:17,060: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1022dea20>]}
2018-04-17 15:41:17,335: 15:41:17 | 24 of 91 OK created table model agency_data_pipeline.shopify_orders_proc [CREATE TABLE in 11.46s]
2018-04-17 15:41:17,336: 15:41:17 | 28 of 91 START table model agency_data_pipeline.agg_orders_union..... [RUN]
2018-04-17 15:41:17,336: Compiling model.agency_data_pipeline.agg_orders_union
2018-04-17 15:41:17,350: Writing injected SQL for node "model.agency_data_pipeline.agg_orders_union"
2018-04-17 15:41:17,345: 15:41:17 | 29 of 91 START table model agency_data_pipeline.adwords_join......... [RUN]
2018-04-17 15:41:17,346: 15:41:17 | 30 of 91 START table model agency_data_pipeline.ga_traffic........... [RUN]
2018-04-17 15:41:17,350: Compiling model.agency_data_pipeline.adwords_join
2018-04-17 15:41:17,346: 15:41:17 | 31 of 91 START table model agency_data_pipeline.agg_products......... [RUN]
2018-04-17 15:41:17,351: Compiling model.agency_data_pipeline.ga_traffic
2018-04-17 15:41:17,357: Acquiring new bigquery connection "agg_orders_union".
2018-04-17 15:41:17,360: Writing injected SQL for node "model.agency_data_pipeline.adwords_join"
2018-04-17 15:41:17,360: Compiling model.agency_data_pipeline.agg_products
2018-04-17 15:41:17,383: Acquiring new bigquery connection "adwords_join".
2018-04-17 15:41:17,383: Re-using an available connection from the pool.
2018-04-17 15:41:17,408: Acquiring new bigquery connection "ga_traffic".
2018-04-17 15:41:17,410: Writing injected SQL for node "model.agency_data_pipeline.agg_products"
2018-04-17 15:41:17,411: Re-using an available connection from the pool.
2018-04-17 15:41:17,414: Re-using an available connection from the pool.
2018-04-17 15:41:17,416: Acquiring new bigquery connection "agg_products".
2018-04-17 15:41:17,416: Fetching data for query ga_traffic:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'GA Traffic'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 15:41:17,417: Re-using an available connection from the pool.
2018-04-17 15:41:18,300: Model SQL (agg_products):
SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`shopify_products_proc`
2018-04-17 15:41:18,329: Model SQL (agg_orders_union):
SELECT
account,
client,
platform,
created_at,
order_number,
quantity,
refund_quantity,
final_quantity,
price, 
total_order_price_undiscounted,
total_discounts,
total_order_shipping_price,
total_order_price_incl_shipping,
refund_amount,
final_price,
checkout_id,
product_id, 
landing_site,
sku, 
variant_title, 
variant_id,
line_item_id,	
customer_id,
orders_count,
customer_created_at,
last_order_id,
financial_status
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`shopify_orders_proc`
2018-04-17 15:41:18,391: Model SQL (adwords_join):
select
a.day,
a.campaignid, 
a.campaign,
a.account, 
channel,
platform,
url,
utm_campaign,
cost,
impressions,
clicks,
impression_share_num,
impression_share_den,
transactions
FROM ( 
	
	select
	day,
	a.campaign,
	a.campaignid, 
	account, 
	channel,
	platform,
	url,
	cost,
	impressions,
	clicks,
	impression_share_num,
	impression_share_den
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_campaigns` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_urls` b
	ON a.campaignid = b.campaignid

) a 
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_ads` b
ON ( a.campaignid = b.campaignid
	and a.day = b.day )
2018-04-17 15:41:18,575: Fetching data for query ga_traffic:


        select
            goal_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_conversions`

        
        ##where 1 = 1
        where goal_type = 'Conversion'
        
        
        
        ##and 2 = 2
        and client_name = 'lucadanni'
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 15:41:19,424: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1023105f8>]}
2018-04-17 15:41:19,684: 15:41:19 | 31 of 91 OK created table model agency_data_pipeline.agg_products.... [CREATE TABLE in 2.06s]
2018-04-17 15:41:19,685: 15:41:19 | 32 of 91 START table model agency_data_pipeline.ga_transactions...... [RUN]
2018-04-17 15:41:19,685: Compiling model.agency_data_pipeline.ga_transactions
2018-04-17 15:41:19,705: Acquiring new bigquery connection "ga_transactions".
2018-04-17 15:41:19,705: Re-using an available connection from the pool.
2018-04-17 15:41:19,706: Fetching data for query ga_transactions:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Google Analytics'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 15:41:20,112: Writing injected SQL for node "model.agency_data_pipeline.ga_traffic"
2018-04-17 15:41:20,962: Fetching data for query ga_transactions:


        select
            goal_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_conversions`

        
        ##where 1 = 1
        where goal_type = 'Conversion'
        
        
        
        ##and 2 = 2
        and client_name = 'lucadanni'
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 15:41:21,027: Model SQL (ga_traffic):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc`, `growth-engines-pipeline`.`agency_data_pipeline`.`ga_conversions`


##`growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` 



with ga_report as (

	    

	    	
	    	
		   	SELECT
		   	'lucadanni' as client_name,
		   	'GA Traffic' as lookup_platform,
			lower(trim(regexp_replace(replace(replace(replace(replace(CONCAT(hostname,landingpagepath),'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
			date,
			lower(source) source,
			lower(medium) medium,
			lower(campaign) campaign,
			sessions,
			## goal completion columns
							
				goalcompletionsall as goal_completions,		
			
			_sdc_sequence,
			first_value(_sdc_sequence) OVER (PARTITION BY hostname, landingpagepath, date, source, medium, campaign ORDER BY _sdc_sequence DESC) lv
			FROM `growth-engines-pipeline.ga_lucadanni_traffic.report` 

		    
	   

)


SELECT  
cast(date as date) date,
b.account,
b.client client,
c.source source,
c.medium medium,
a.campaign campaign,
concat(a.source, ' / ', a.medium) source_medium,  
case when c.platform is null then "Unmapped" else c.platform end as platform,
case when c.channel is null then "Unmapped" else c.channel end as channel,
regexp_replace(url, r'offers.|offer.|get.|info.|pos.|go.|join.|pages.','') url,
max(sessions) sessions,
max(goal_completions) goal_completions
FROM ga_report a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
ON ( a.client_name = b.client_name 
	AND a.lookup_platform = b.platform )
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc` c
ON ( a.source = c.source
  AND a.medium = c.medium 
  AND a.client_name = c.client_name )
GROUP BY date, account, client, source, medium, campaign, source_medium, platform, channel, url


2018-04-17 15:41:21,415: Writing injected SQL for node "model.agency_data_pipeline.ga_transactions"
2018-04-17 15:41:22,247: Model SQL (ga_transactions):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc`, `growth-engines-pipeline`.`agency_data_pipeline`.`ga_conversions`


##`growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` 



with ga_report as (

	    

	    	
	    	
		   	SELECT
		   	'lucadanni' as client_name,
		   	'Google Analytics' as lookup_platform,
			lower(trim(regexp_replace(replace(replace(replace(replace(CONCAT(hostname,landingpagepath),'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
			date,
			lower(source) source,
			lower(medium) medium,
			lower(campaign) campaign,
			cast(regexp_replace(transactionid, r'#', '') as int64) transactionid,
			transactions last_touch_transactions,
			(transactionrevenue - transactionshipping - transactiontax) as last_touch_revenue,
			transactionshipping,
			transactiontax,
			_sdc_sequence,
			first_value(_sdc_sequence) OVER (PARTITION BY hostname, landingpagepath, date, source, medium, transactionid ORDER BY _sdc_sequence DESC) lv
			FROM `growth-engines-pipeline.ga_lucadanni.report` 

		    
	   

)


SELECT  
cast(date as date) date,
b.account,
b.client client,
c.source source,
c.medium medium,
a.campaign campaign,
concat(a.source, ' / ', a.medium) source_medium,  
case when c.platform is null then "Unmapped" else c.platform end as platform,
case when c.channel is null then "Unmapped" else c.channel end as channel,
regexp_replace(url, r'offers.|offer.|get.|info.|pos.|go.|join.|pages.','') url,
transactionid,
max(last_touch_transactions) last_touch_transactions,
max(last_touch_revenue) last_touch_revenue,
max(transactionshipping) last_touch_shipping,
max(transactiontax) last_touch_tax
FROM ga_report a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
ON ( a.client_name = b.client_name 
	AND a.lookup_platform = b.platform )
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc` c
ON ( a.source = c.source
  AND a.medium = c.medium 
  AND a.client_name = c.client_name )
GROUP BY date, account, client, source, medium, campaign, source_medium, platform, channel, url, transactionid


2018-04-17 15:41:24,259: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1022d53c8>]}
2018-04-17 15:41:24,542: 15:41:24 | 29 of 91 OK created table model agency_data_pipeline.adwords_join.... [CREATE TABLE in 6.91s]
2018-04-17 15:41:24,986: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x102327c50>]}
2018-04-17 15:41:25,239: 15:41:25 | 28 of 91 OK created table model agency_data_pipeline.agg_orders_union [CREATE TABLE in 7.65s]
2018-04-17 15:41:27,839: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1059203c8>]}
2018-04-17 15:41:28,131: 15:41:28 | 32 of 91 OK created table model agency_data_pipeline.ga_transactions. [CREATE TABLE in 8.15s]
2018-04-17 15:41:33,305: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10233d828>]}
2018-04-17 15:41:34,026: 15:41:34 | 30 of 91 OK created table model agency_data_pipeline.ga_traffic...... [CREATE TABLE in 15.95s]
2018-04-17 15:41:34,027: 15:41:34 | 33 of 91 START table model agency_data_pipeline.fb_ads_stats......... [RUN]
2018-04-17 15:41:34,027: 15:41:34 | 34 of 91 START table model agency_data_pipeline.agg_transaction_order_number [RUN]
2018-04-17 15:41:34,028: Compiling model.agency_data_pipeline.fb_ads_stats
2018-04-17 15:41:34,028: 15:41:34 | 35 of 91 START table model agency_data_pipeline.adwords_impression_share [RUN]
2018-04-17 15:41:34,028: 15:41:34 | 36 of 91 START table model agency_data_pipeline.adwords_stats........ [RUN]
2018-04-17 15:41:34,029: Compiling model.agency_data_pipeline.agg_transaction_order_number
2018-04-17 15:41:34,039: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_stats"
2018-04-17 15:41:34,039: Compiling model.agency_data_pipeline.adwords_impression_share
2018-04-17 15:41:34,039: Compiling model.agency_data_pipeline.adwords_stats
2018-04-17 15:41:34,044: Writing injected SQL for node "model.agency_data_pipeline.agg_transaction_order_number"
2018-04-17 15:41:34,049: Writing injected SQL for node "model.agency_data_pipeline.adwords_impression_share"
2018-04-17 15:41:34,053: Writing injected SQL for node "model.agency_data_pipeline.adwords_stats"
2018-04-17 15:41:34,055: Acquiring new bigquery connection "fb_ads_stats".
2018-04-17 15:41:34,055: Re-using an available connection from the pool.
2018-04-17 15:41:34,059: Acquiring new bigquery connection "adwords_stats".
2018-04-17 15:41:34,059: Re-using an available connection from the pool.
2018-04-17 15:41:34,062: Acquiring new bigquery connection "agg_transaction_order_number".
2018-04-17 15:41:34,062: Re-using an available connection from the pool.
2018-04-17 15:41:34,065: Acquiring new bigquery connection "adwords_impression_share".
2018-04-17 15:41:34,068: Re-using an available connection from the pool.
2018-04-17 15:41:35,047: Model SQL (fb_ads_stats):
with cost as (

    select 
        date, account, ad_id, campaign,
        cost, impressions, clicks, null as conversions
    from `growth-engines-pipeline`.`agency_data_pipeline`.`fb_ads_insights`
),

conversions as (

    select 
        date, account, ad_id, campaign,
        null as cost, null as impressions, null as clicks, conversions
    from `growth-engines-pipeline`.`agency_data_pipeline`.`fb_ads_insights_conversions`
),

urls as (

    select ad_id, url
    from `growth-engines-pipeline`.`agency_data_pipeline`.`fb_ads`
)


SELECT
    cast(date as date) date,
    'FB Ads' platform,
    'Paid' channel,
    account, 
    b.url url,
    campaign,
    lower(campaign) utm_campaign, 
    sum(cost) cost,
    sum(impressions) impressions,
    sum(clicks) clicks,
    sum(conversions) transactions
FROM
(
    SELECT *
    FROM 
      cost
    UNION ALL
    SELECT *
    FROM 
      conversions
) a
LEFT JOIN urls b
ON ( a.ad_id = b.ad_id )
group by date, platform, channel, account, url, campaign, utm_campaign
2018-04-17 15:41:35,047: Model SQL (adwords_impression_share):
SELECT 
cast(day as date) date, 
account, 
channel,
platform,
sum(impression_share_num) impressions,
sum(impression_share_den) available_impressions
FROM 
  `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_join`
group by date, account, platform, channel
2018-04-17 15:41:35,092: Model SQL (adwords_stats):
SELECT 
cast(day as date) date, 
account, 
platform,
channel,
url,
utm_campaign,
campaign,
sum(cost) cost,
sum(impressions) impressions,
sum(clicks) clicks,
sum(transactions) transactions
FROM 
  `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_join`
group by date, account, platform, channel, url, campaign, utm_campaign
2018-04-17 15:41:35,454: Model SQL (agg_transaction_order_number):
SELECT
client,
cast(created_at as date) date,
order_number,
customer_id,
sum(final_quantity) final_quantity,
sum(final_price) final_price,
max(total_order_shipping_price) shipping_price
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`agg_orders_union`
GROUP BY client, created_at, order_number, customer_id
2018-04-17 15:41:37,284: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105917da0>]}
2018-04-17 15:41:37,544: 15:41:37 | 35 of 91 OK created table model agency_data_pipeline.adwords_impression_share [CREATE TABLE in 3.24s]
2018-04-17 15:41:37,545: 15:41:37 | 37 of 91 START table model agency_data_pipeline.agg_transaction_line_item [RUN]
2018-04-17 15:41:37,545: Compiling model.agency_data_pipeline.agg_transaction_line_item
2018-04-17 15:41:37,554: Writing injected SQL for node "model.agency_data_pipeline.agg_transaction_line_item"
2018-04-17 15:41:37,555: Acquiring new bigquery connection "agg_transaction_line_item".
2018-04-17 15:41:37,555: Re-using an available connection from the pool.
2018-04-17 15:41:38,347: Model SQL (agg_transaction_line_item):
SELECT
client,
created_at,
order_number,
quantity,
refund_quantity,
final_quantity,
price, 
total_order_price_undiscounted,
total_discounts,
total_order_shipping_price,
total_order_price_incl_shipping,
refund_amount,
final_price,
checkout_id,
product_id, 
landing_site,
sku, 
variant_title, 
variant_id,
line_item_id,	
customer_id,
orders_count,
customer_created_at,
last_order_id,
financial_status
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`agg_orders_union`
2018-04-17 15:41:38,410: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1058422b0>]}
2018-04-17 15:41:38,784: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10230a940>]}
2018-04-17 15:41:38,788: 15:41:38 | 33 of 91 OK created table model agency_data_pipeline.fb_ads_stats.... [CREATE TABLE in 4.38s]
2018-04-17 15:41:39,103: 15:41:39 | 34 of 91 OK created table model agency_data_pipeline.agg_transaction_order_number [CREATE TABLE in 4.76s]
2018-04-17 15:41:39,541: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10593df60>]}
2018-04-17 15:41:39,806: 15:41:39 | 36 of 91 OK created table model agency_data_pipeline.adwords_stats... [CREATE TABLE in 5.50s]
2018-04-17 15:41:43,961: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10596e908>]}
2018-04-17 15:41:44,213: 15:41:44 | 37 of 91 OK created table model agency_data_pipeline.agg_transaction_line_item [CREATE TABLE in 6.42s]
2018-04-17 15:41:44,214: 15:41:44 | 38 of 91 START table model agency_data_pipeline.customers_by_transaction [RUN]
2018-04-17 15:41:44,214: Compiling model.agency_data_pipeline.customers_by_transaction
2018-04-17 15:41:44,223: Writing injected SQL for node "model.agency_data_pipeline.customers_by_transaction"
2018-04-17 15:41:44,224: Acquiring new bigquery connection "customers_by_transaction".
2018-04-17 15:41:44,224: Re-using an available connection from the pool.
2018-04-17 15:41:45,168: Model SQL (customers_by_transaction):
SELECT
client,
customer_id,
order_number,
order_date,
first_order_date,
case when first_order_number = order_number then 'New' else 'Existing' end as order_type,
final_price,
first_order_revenue,
lifetime_revenue
FROM

(

	SELECT
	client,
	customer_id,
	order_number,
	date order_date,
	first_value(date) over w1 first_order_date,
	first_value(order_number) over w1 first_order_number,
	first_value(final_price) over w1 first_order_revenue,
    final_price,
	sum(final_price) over w2 lifetime_revenue
	FROM
    `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_order_number`
	WINDOW w1 as (PARTITION BY client, customer_id ORDER BY date desc),
	w2 as (PARTITION BY client, customer_id)
)
2018-04-17 15:41:48,564: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105962a20>]}
2018-04-17 15:41:48,822: 15:41:48 | 38 of 91 OK created table model agency_data_pipeline.customers_by_transaction [CREATE TABLE in 4.35s]
2018-04-17 15:41:48,823: 15:41:48 | 39 of 91 START table model agency_data_pipeline.frequency_proc....... [RUN]
2018-04-17 15:41:48,824: Compiling model.agency_data_pipeline.frequency_proc
2018-04-17 15:41:48,823: 15:41:48 | 40 of 91 START table model agency_data_pipeline.agg_ga_transaction_order_number [RUN]
2018-04-17 15:41:48,831: Compiling model.agency_data_pipeline.agg_ga_transaction_order_number
2018-04-17 15:41:48,840: Writing injected SQL for node "model.agency_data_pipeline.frequency_proc"
2018-04-17 15:41:48,842: Writing injected SQL for node "model.agency_data_pipeline.agg_ga_transaction_order_number"
2018-04-17 15:41:48,846: Acquiring new bigquery connection "frequency_proc".
2018-04-17 15:41:48,847: Re-using an available connection from the pool.
2018-04-17 15:41:48,851: Acquiring new bigquery connection "agg_ga_transaction_order_number".
2018-04-17 15:41:48,851: Re-using an available connection from the pool.
2018-04-17 15:41:49,693: Model SQL (frequency_proc):
WITH transactions AS (

  	SELECT 
	client,
	customer_id,
	order_number,
	date,
	unix_date(date) d
	FROM
	`growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_order_number`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)

SELECT 
client,
'Rolling 365' as period,
date_in_range date,
unix_date_in_range, 
customer_id,
count(distinct(order_number)) frequency
FROM daterange
JOIN transactions
ON transactions.d > ( daterange.unix_date_in_range - 365 )
AND transactions.d <= daterange.unix_date_in_range
group by client, unix_date_in_range, customer_id, date
2018-04-17 15:41:49,851: Model SQL (agg_ga_transaction_order_number):
with ga as (

    select 
        date, account, client, 
        channel as last_touch_channel, 
        platform as last_touch_platform, 
        url as last_touch_url, 
        campaign as last_touch_utm_campaign, 
        '' as first_touch_channel, 
        '' as first_touch_platform, 
        '' as first_touch_utm_campaign, 
        transactionid,
        last_touch_transactions, last_touch_revenue,
        last_touch_shipping, last_touch_tax,
        null as first_touch_transactions, null as first_touch_revenue
    from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_transactions`

),

ga_mcf as (

    select 
        date, account, client, 
        '' as last_touch_channel,
        '' as last_touch_platform,
        '' as last_touch_url,
        '' as last_touch_utm_campaign, 
        channel as first_touch_channel, 
        platform as first_touch_platform, 
        campaign as first_touch_utm_campaign, 
        transactionid, 
        null as last_touch_transactions, null as last_touch_revenue,
        null as last_touch_shipping, null as last_touch_tax,
        first_touch_transactions, first_touch_revenue
    from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_mcf_stats`

)


SELECT
    date, 
    client,
    transactionid,
    max(last_touch_channel) last_touch_channel, 
    max(last_touch_platform) last_touch_platform, 
    max(last_touch_url) last_touch_url, 
    max(last_touch_utm_campaign) last_touch_utm_campaign, 
    max(first_touch_channel) first_touch_channel, 
    max(first_touch_platform) first_touch_platform, 
    max(first_touch_utm_campaign) first_touch_utm_campaign,
    sum(last_touch_transactions) last_touch_transactions,
    sum(last_touch_revenue) last_touch_revenue,
    sum(last_touch_shipping) last_touch_shipping_revenue,
    sum(last_touch_tax) last_touch_tax_revenue,
    sum(first_touch_transactions) first_touch_transactions,
    sum(first_touch_revenue) - ifnull(sum(last_touch_shipping),0) - ifnull(sum(last_touch_tax),0) first_touch_revenue
FROM
(
    SELECT *
    FROM 
      ga
    UNION ALL
    SELECT *
    FROM 
      ga_mcf
) 
GROUP BY
    date, client, transactionid
2018-04-17 15:41:54,390: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10593d978>]}
2018-04-17 15:41:55,070: 15:41:55 | 40 of 91 OK created table model agency_data_pipeline.agg_ga_transaction_order_number [CREATE TABLE in 5.56s]
2018-04-17 15:42:03,070: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10596e908>]}
2018-04-17 15:42:03,896: 15:42:03 | 39 of 91 OK created table model agency_data_pipeline.frequency_proc.. [CREATE TABLE in 14.25s]
2018-04-17 15:42:03,897: 15:42:03 | 41 of 91 START table model agency_data_pipeline.agg_ga_campaign...... [RUN]
2018-04-17 15:42:03,898: Compiling model.agency_data_pipeline.agg_ga_campaign
2018-04-17 15:42:03,897: 15:42:03 | 42 of 91 START table model agency_data_pipeline.agg_transaction_line_item_type [RUN]
2018-04-17 15:42:03,905: Compiling model.agency_data_pipeline.agg_transaction_line_item_type
2018-04-17 15:42:03,914: Writing injected SQL for node "model.agency_data_pipeline.agg_ga_campaign"
2018-04-17 15:42:03,916: Writing injected SQL for node "model.agency_data_pipeline.agg_transaction_line_item_type"
2018-04-17 15:42:03,897: 15:42:03 | 43 of 91 START table model agency_data_pipeline.frequency_stats...... [RUN]
2018-04-17 15:42:03,916: Compiling model.agency_data_pipeline.frequency_stats
2018-04-17 15:42:03,921: Writing injected SQL for node "model.agency_data_pipeline.frequency_stats"
2018-04-17 15:42:03,922: Acquiring new bigquery connection "agg_transaction_line_item_type".
2018-04-17 15:42:03,922: Acquiring new bigquery connection "agg_ga_campaign".
2018-04-17 15:42:03,923: Acquiring new bigquery connection "frequency_stats".
2018-04-17 15:42:03,923: Re-using an available connection from the pool.
2018-04-17 15:42:03,924: Re-using an available connection from the pool.
2018-04-17 15:42:03,924: Re-using an available connection from the pool.
2018-04-17 15:42:04,631: Model SQL (frequency_stats):
SELECT
client,
period,
date,
unix_date_in_range,
case when frequency = 1 then '1' 
	when frequency = 2 then '2'
	when frequency > 2 then '2+'
	else null end as frequency_segment,
sum(customers) customers 
FROM (

	SELECT 
	client,
	period,
	date,
	unix_date_in_range, 
	frequency,
	count(distinct(customer_id)) customers
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`frequency_proc`
	group by client, period, date, unix_date_in_range, frequency
)
group by client, period, date, unix_date_in_range, frequency_segment
2018-04-17 15:42:04,785: Model SQL (agg_ga_campaign):
with ga_transactions as (

	select 
		date, account, client, channel, platform, url, 
		campaign,
		null as sessions, null as goal_completions, last_touch_transactions, last_touch_revenue,
		last_touch_shipping, last_touch_tax,
		null as first_touch_transactions, null as first_touch_revenue
	from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_transactions`

),

ga_traffic as (

    select 
        date, account, client, channel, platform, url, 
        campaign,
        sessions, goal_completions, null as last_touch_transactions, null as last_touch_revenue,
        null as last_touch_shipping, null as last_touch_tax,
        null as first_touch_transactions, null as first_touch_revenue
    from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_traffic`

),

ga_mcf as (

	select 
		date, account, client, channel, platform, '' as url,
		campaign, 
		null as sessions, null as goal_completions, null as last_touch_transactions, null as last_touch_revenue,
		null as last_touch_shipping, null as last_touch_tax,
		first_touch_transactions, first_touch_revenue
	from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_mcf_stats`

)


SELECT
    date, 
    client,
    platform,
    channel, 
    url,
    campaign utm_campaign,
	sum(sessions) sessions,
	sum(goal_completions) goal_completions,
	sum(last_touch_transactions) last_touch_transactions,
	sum(last_touch_revenue) last_touch_revenue,
    sum(last_touch_shipping) last_touch_shipping_revenue,
    sum(last_touch_tax) last_touch_tax_revenue,
    sum(first_touch_transactions) first_touch_transactions,
    sum(first_touch_revenue) - sum(ifnull(last_touch_shipping,0)) - sum(ifnull(last_touch_tax,0)) first_touch_revenue

FROM
(
    SELECT *
    FROM 
      ga_transactions
    UNION ALL
    SELECT *
    FROM 
      ga_traffic
    UNION ALL
    SELECT *
    FROM 
      ga_mcf
) 
GROUP BY
    date, client, platform, channel, url, utm_campaign
2018-04-17 15:42:04,909: Model SQL (agg_transaction_line_item_type):
SELECT
client,
product_id,
product_type,
customer_id,
sku,
order_number,
created_at,
final_quantity,
final_price
FROM

( 
	SELECT 
	a.client, 
	a.product_id,
	product_type,
	customer_id,
	a.sku, 
	order_number,
	created_at,
	final_quantity,
	final_price
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_line_item` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`agg_products` b
	ON (
		a.product_id = b.product_id
	  and a.client = b.client
		)

)
2018-04-17 15:42:09,460: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105917630>]}
2018-04-17 15:42:09,727: 15:42:09 | 42 of 91 OK created table model agency_data_pipeline.agg_transaction_line_item_type [CREATE TABLE in 5.55s]
2018-04-17 15:42:11,314: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1022d5a58>]}
2018-04-17 15:42:11,588: 15:42:11 | 43 of 91 OK created table model agency_data_pipeline.frequency_stats. [CREATE TABLE in 7.40s]
2018-04-17 15:42:12,587: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105962a20>]}
2018-04-17 15:42:13,397: 15:42:13 | 41 of 91 OK created table model agency_data_pipeline.agg_ga_campaign. [CREATE TABLE in 8.69s]
2018-04-17 15:42:13,398: 15:42:13 | 44 of 91 START table model agency_data_pipeline.agg_transaction_product_type [RUN]
2018-04-17 15:42:13,398: 15:42:13 | 45 of 91 START table model agency_data_pipeline.customers_first_purchase_product_type_proc [RUN]
2018-04-17 15:42:13,399: Compiling model.agency_data_pipeline.agg_transaction_product_type
2018-04-17 15:42:13,399: Compiling model.agency_data_pipeline.customers_first_purchase_product_type_proc
2018-04-17 15:42:13,408: Writing injected SQL for node "model.agency_data_pipeline.agg_transaction_product_type"
2018-04-17 15:42:13,419: Writing injected SQL for node "model.agency_data_pipeline.customers_first_purchase_product_type_proc"
2018-04-17 15:42:13,422: Acquiring new bigquery connection "agg_transaction_product_type".
2018-04-17 15:42:13,423: Re-using an available connection from the pool.
2018-04-17 15:42:13,427: Acquiring new bigquery connection "customers_first_purchase_product_type_proc".
2018-04-17 15:42:13,427: Re-using an available connection from the pool.
2018-04-17 15:42:14,452: Model SQL (agg_transaction_product_type):
SELECT
client,
product_type,
customer_id,
order_number,
created_at,
first_value(product_type) over (PARTITION BY client, customer_id, order_number, created_at ORDER BY final_price desc) as top_order_product_type,
final_quantity,
final_price,
sum(final_quantity) over (PARTITION BY client, customer_id, order_number) as total_order_quantity,
sum(final_price) over (PARTITION BY client, customer_id, order_number) as total_order_value
FROM
	(
		SELECT
		client,
		product_type,
		customer_id,
		order_number,
		created_at,
		sum(final_quantity) final_quantity,
		sum(final_price) final_price
		FROM
		`growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_line_item_type`
		GROUP BY
		client,
		product_type,
		customer_id,
		order_number,
		created_at
	)
2018-04-17 15:42:14,605: Model SQL (customers_first_purchase_product_type_proc):
SELECT 
client, 
customer_id, 
product_type,
min(cast(created_at as date)) first_order_date,
unix_date( min(cast(created_at as date))) first_order_unix_date
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_line_item_type`
GROUP BY client, customer_id, product_type
2018-04-17 15:42:17,928: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1022f4fd0>]}
2018-04-17 15:42:18,937: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10596e908>]}
2018-04-17 15:42:19,116: 15:42:19 | 45 of 91 OK created table model agency_data_pipeline.customers_first_purchase_product_type_proc [CREATE TABLE in 4.53s]
2018-04-17 15:42:19,365: 15:42:19 | 44 of 91 OK created table model agency_data_pipeline.agg_transaction_product_type [CREATE TABLE in 5.54s]
2018-04-17 15:42:19,365: 15:42:19 | 46 of 91 START table model agency_data_pipeline.products_proc........ [RUN]
2018-04-17 15:42:19,366: Compiling model.agency_data_pipeline.products_proc
2018-04-17 15:42:19,366: 15:42:19 | 47 of 91 START table model agency_data_pipeline.customers_products_proc [RUN]
2018-04-17 15:42:19,375: Writing injected SQL for node "model.agency_data_pipeline.products_proc"
2018-04-17 15:42:19,366: 15:42:19 | 48 of 91 START table model agency_data_pipeline.order_paths_proc..... [RUN]
2018-04-17 15:42:19,375: Compiling model.agency_data_pipeline.customers_products_proc
2018-04-17 15:42:19,375: Compiling model.agency_data_pipeline.order_paths_proc
2018-04-17 15:42:19,382: Writing injected SQL for node "model.agency_data_pipeline.customers_products_proc"
2018-04-17 15:42:19,388: Writing injected SQL for node "model.agency_data_pipeline.order_paths_proc"
2018-04-17 15:42:19,389: Acquiring new bigquery connection "products_proc".
2018-04-17 15:42:19,390: Re-using an available connection from the pool.
2018-04-17 15:42:19,390: Acquiring new bigquery connection "customers_products_proc".
2018-04-17 15:42:19,391: Acquiring new bigquery connection "order_paths_proc".
2018-04-17 15:42:19,392: Re-using an available connection from the pool.
2018-04-17 15:42:19,394: Re-using an available connection from the pool.
2018-04-17 15:42:20,104: Model SQL (products_proc):
WITH transactions AS (
  SELECT 
  client, 
  product_id,
  product_type,
  customer_id,
  sku, 
  order_number,
  unix_date(cast(created_at as date)) d, 
  final_quantity,
  final_price,
  first_value(unix_date(cast(created_at as date))) over (partition by client, product_id, sku order by created_at desc) first_purchase_unix_date
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_line_item_type`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)

SELECT 
client,
'Last 30' as period,
sku,
product_type,
date_in_range date,
unix_date_in_range, 
case when 
  ( first_purchase_unix_date > ( daterange.unix_date_in_range - 365 ) and first_purchase_unix_date <= daterange.unix_date_in_range )
  then 'New' else 'Existing' end as newness,  
count(distinct(customer_id)) unique_customers,
count(distinct(order_number)) orders,
sum(final_quantity) quantity,
sum(final_price) revenue
FROM daterange
JOIN transactions
ON transactions.d > ( daterange.unix_date_in_range - 30 )
AND transactions.d <= daterange.unix_date_in_range
group by date_in_range, unix_date_in_range, client, sku, product_type, newness

UNION ALL

SELECT 
client,
'Last 90' as period,
sku, 
product_type,
date_in_range date,
unix_date_in_range, 
case when 
  ( first_purchase_unix_date > ( daterange.unix_date_in_range - 365 ) and first_purchase_unix_date <= daterange.unix_date_in_range )
  then 'New' else 'Existing' end as newness,  
count(distinct(customer_id)) unique_customers,
count(distinct(order_number)) orders,
sum(final_quantity) quantity,
sum(final_price) revenue
FROM daterange
JOIN transactions
ON transactions.d > ( daterange.unix_date_in_range - 90 )
AND transactions.d <= daterange.unix_date_in_range
group by date_in_range, unix_date_in_range, client, sku, product_type, newness

UNION ALL

SELECT 
client,
'YoY 30' as date_range,
sku, 
product_type,
date_in_range date,
unix_date_in_range,
case when 
  ( first_purchase_unix_date > ( daterange.unix_date_in_range - 730 ) and first_purchase_unix_date <= ( daterange.unix_date_in_range - 365 ))
  then 'New' else 'Existing' end as newness,   
count(distinct(customer_id)) unique_customers,
count(distinct(order_number)) orders,
sum(final_quantity) quantity,
sum(final_price) revenue
FROM daterange
JOIN transactions
ON transactions.d > ( daterange.unix_date_in_range - 395 )
AND transactions.d <= ( daterange.unix_date_in_range - 365 )
group by date_in_range, unix_date_in_range, client, sku, product_type, newness
2018-04-17 15:42:20,495: Model SQL (order_paths_proc):
SELECT
client, 
customer_id, 
first_value(product_type) OVER w1 as first_product_type,
nth_value(product_type, 2) OVER w1 as second_product_type,
cast(first_value(created_at) OVER w1 as date) as first_purchase_date,
cast(nth_value(created_at, 2) OVER w1 as date) as second_purchase_date,
cast(nth_value(created_at, 3) OVER w1 as date) as third_purchase_date,
cast(nth_value(created_at, 4) OVER w1 as date) as fourth_purchase_date,
cast(nth_value(created_at, 5) OVER w1 as date) as fifth_purchase_date,
first_value(order_number) OVER w1 as first_order_number,
nth_value(order_number, 2) OVER w1 as second_order_number,
nth_value(order_number, 3) OVER w1 as third_order_number,
nth_value(order_number, 4) OVER w1 as fourth_order_number,
nth_value(order_number, 5) OVER w1 as fifth_order_number,
first_value(total_order_value) OVER w1 as first_order_value,
nth_value(total_order_value, 2) OVER w1 as second_order_value
FROM (
	  
	  SELECT 
	  client, 
	  product_type,
	  customer_id,
	  order_number,
	  created_at, 
	  total_order_value
	  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_product_type`
	  WHERE product_type = top_order_product_type

)
WINDOW w1 as (PARTITION BY client, customer_id ORDER BY created_at asc)
2018-04-17 15:42:20,497: Model SQL (customers_products_proc):
WITH customers AS (
  SELECT 
  client, 
  product_id,
  product_type,
  customer_id,
  sku, 
  order_number,
  cast(created_at as date) order_date,
  unix_date(cast(created_at as date)) unix_order_date, 
  final_quantity quantity,
  final_price revenue
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_line_item_type`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)

SELECT 
client,
period,
customer_id,
product_type,
date,
window_end_unix_date,
window_end_unix_date - 365 as window_start_unix_date,
window_end_unix_date - unix_date(recent_order) recency_days,
frequency,
quantity,
revenue,
case when frequency > 0 then revenue/frequency else 0 end as aov
FROM 
(  

  SELECT 
  client,
  'Rolling 365' as period,
  customer_id,
  product_type,
  date_in_range date,
  unix_date_in_range,
  unix_date_in_range window_end_unix_date, 
  max(order_date) recent_order,
  sum(quantity) as quantity,
  sum(revenue) as revenue,
  count(distinct(order_number)) as frequency
  FROM daterange
  JOIN customers
  ON customers.unix_order_date > ( daterange.unix_date_in_range - 365 )
  AND customers.unix_order_date <= daterange.unix_date_in_range
  GROUP BY client, customer_id, date, unix_date_in_range, product_type

  UNION ALL

  SELECT 
  client,
  'Rolling 365 (t-1mo)' as period,
  customer_id,
  product_type,
  date_in_range date,
  unix_date_in_range, 
  unix_date_in_range - 30 window_end_unix_date, 
  max(order_date) recent_order,
  sum(quantity) as quantity,
  sum(revenue) as revenue,
  count(distinct(order_number)) as frequency
  FROM daterange
  JOIN customers
  ON customers.unix_order_date > ( daterange.unix_date_in_range - 395 )
  AND customers.unix_order_date <= ( daterange.unix_date_in_range - 30 )
  GROUP BY client, customer_id, date, unix_date_in_range, product_type

  UNION ALL

  SELECT 
  client,
  'Rolling 365 (t-1yr)' as period,
  customer_id,
  product_type,
  date_in_range date,
  unix_date_in_range, 
  unix_date_in_range - 365 window_end_unix_date, 
  max(order_date) recent_order,
  sum(quantity) as quantity,
  sum(revenue) as revenue,
  count(distinct(order_number)) as frequency
  FROM daterange
  JOIN customers
  ON customers.unix_order_date > ( daterange.unix_date_in_range - 730 )
  AND customers.unix_order_date <= ( daterange.unix_date_in_range - 365 )
  GROUP BY client, customer_id, date, unix_date_in_range, product_type

)
2018-04-17 15:42:22,734: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x102302080>]}
2018-04-17 15:42:22,994: 15:42:22 | 48 of 91 OK created table model agency_data_pipeline.order_paths_proc [CREATE TABLE in 3.36s]
2018-04-17 15:42:27,909: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105962a20>]}
2018-04-17 15:42:28,157: 15:42:28 | 46 of 91 OK created table model agency_data_pipeline.products_proc... [CREATE TABLE in 8.54s]
2018-04-17 15:42:56,421: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10593df60>]}
2018-04-17 15:42:56,691: 15:42:56 | 47 of 91 OK created table model agency_data_pipeline.customers_products_proc [CREATE TABLE in 37.05s]
2018-04-17 15:42:56,692: 15:42:56 | 49 of 91 START table model agency_data_pipeline.segment_proc_sku..... [RUN]
2018-04-17 15:42:56,692: 15:42:56 | 50 of 91 START table model agency_data_pipeline.order_paths_agg...... [RUN]
2018-04-17 15:42:56,693: Compiling model.agency_data_pipeline.segment_proc_sku
2018-04-17 15:42:56,693: Compiling model.agency_data_pipeline.order_paths_agg
2018-04-17 15:42:56,697: Writing injected SQL for node "model.agency_data_pipeline.segment_proc_sku"
2018-04-17 15:42:56,705: Writing injected SQL for node "model.agency_data_pipeline.order_paths_agg"
2018-04-17 15:42:56,707: Acquiring new bigquery connection "order_paths_agg".
2018-04-17 15:42:56,707: Re-using an available connection from the pool.
2018-04-17 15:42:56,709: Acquiring new bigquery connection "segment_proc_sku".
2018-04-17 15:42:56,709: Re-using an available connection from the pool.
2018-04-17 15:42:57,569: Model SQL (segment_proc_sku):
SELECT
client,
period,
sku, 
product_type,
date,
unique_customers,
orders,
quantity,
revenue,
case when newness = 'New' then 'New' 
	when orders > orders_90pct then 'Best Seller'
	when orders > orders_75pct then 'Good'
	when orders > orders_25pct then 'Average'
	else 'Poor' end as segment,
newness,	
orders_90pct,
orders_75pct,
orders_25pct
FROM
(
	SELECT 
	client,
	period,
	sku, 
	product_type,
	newness,
	date,
	unique_customers,
	orders,
	quantity,
	revenue,
	PERCENTILE_CONT(orders, 0.90) OVER w1 AS orders_90pct,
	PERCENTILE_CONT(orders, 0.75) OVER w1 AS orders_75pct,
	PERCENTILE_CONT(orders, 0.25) OVER w1 AS orders_25pct
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`products_proc`

	WINDOW w1 as (PARTITION BY client, period, date)
)
2018-04-17 15:42:57,670: Model SQL (order_paths_agg):
SELECT
client, 
first_product_type,
second_product_type,
first_purchase_date,
count(distinct(customer_id)) customer_count, 
count(distinct(second_order_number)) second_orders, 
count(distinct(third_order_number)) third_orders, 
count(distinct(fourth_order_number)) fourth_orders, 
count(distinct(fifth_order_number)) fifth_orders, 
sum(date_diff(second_purchase_date, first_purchase_date, DAY)) second_order_latency_days,
sum(date_diff(third_purchase_date, second_purchase_date, DAY)) third_order_latency_days,
sum(date_diff(fourth_purchase_date, third_purchase_date, DAY)) fourth_order_latency_days,
sum(date_diff(fifth_purchase_date, fourth_purchase_date, DAY)) fifth_order_latency_days,
sum(first_order_value) first_order_revenue,
sum(second_order_value) second_order_revenue
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`order_paths_proc`
where second_product_type is not null
GROUP BY client, first_product_type, second_product_type, first_purchase_date
2018-04-17 15:42:59,827: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10596e908>]}
2018-04-17 15:42:59,900: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10233da90>]}
2018-04-17 15:43:00,176: 15:43:00 | 49 of 91 OK created table model agency_data_pipeline.segment_proc_sku [CREATE TABLE in 3.13s]
2018-04-17 15:43:00,460: 15:43:00 | 50 of 91 OK created table model agency_data_pipeline.order_paths_agg. [CREATE TABLE in 3.21s]
2018-04-17 15:43:00,461: 15:43:00 | 51 of 91 START table model agency_data_pipeline.segment_stats_sku.... [RUN]
2018-04-17 15:43:00,462: Compiling model.agency_data_pipeline.segment_stats_sku
2018-04-17 15:43:00,461: 15:43:00 | 52 of 91 START table model agency_data_pipeline.agg_transaction...... [RUN]
2018-04-17 15:43:00,469: Compiling model.agency_data_pipeline.agg_transaction
2018-04-17 15:43:00,462: 15:43:00 | 53 of 91 START table model agency_data_pipeline.segment_proc_customers_products [RUN]
2018-04-17 15:43:00,480: Writing injected SQL for node "model.agency_data_pipeline.agg_transaction"
2018-04-17 15:43:00,486: Writing injected SQL for node "model.agency_data_pipeline.segment_stats_sku"
2018-04-17 15:43:00,486: Compiling model.agency_data_pipeline.segment_proc_customers_products
2018-04-17 15:43:00,462: 15:43:00 | 54 of 91 START table model agency_data_pipeline.agg_ga_transaction... [RUN]
2018-04-17 15:43:00,494: Writing injected SQL for node "model.agency_data_pipeline.segment_proc_customers_products"
2018-04-17 15:43:00,494: Compiling model.agency_data_pipeline.agg_ga_transaction
2018-04-17 15:43:00,495: Acquiring new bigquery connection "agg_transaction".
2018-04-17 15:43:00,505: Writing injected SQL for node "model.agency_data_pipeline.agg_ga_transaction"
2018-04-17 15:43:00,506: Acquiring new bigquery connection "segment_stats_sku".
2018-04-17 15:43:00,507: Re-using an available connection from the pool.
2018-04-17 15:43:00,507: Re-using an available connection from the pool.
2018-04-17 15:43:00,514: Acquiring new bigquery connection "agg_ga_transaction".
2018-04-17 15:43:00,514: Re-using an available connection from the pool.
2018-04-17 15:43:00,531: Acquiring new bigquery connection "segment_proc_customers_products".
2018-04-17 15:43:00,531: Re-using an available connection from the pool.
2018-04-17 15:43:01,408: Model SQL (agg_ga_transaction):
#done - lookup customer id from transaction id from orders
#done - tag an order as 'new' or 'existing' based on transaction id
#sum lifetime value of that customer id
#first order value for customer
#read from agg_ga_transaction into agg_ga_campaign instead of directly from ga_transactions and ga_mcf_stats


with ga as (

    select 
        date, 
        client, 
        'Last-touch' as attribution,
        channel, 
        platform, 
        url, 
        campaign, 
        transactionid,
        last_touch_transactions transactions, 
        last_touch_revenue + ifnull(last_touch_shipping, 0) + ifnull(last_touch_tax, 0) as revenue
    from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_transactions`

),

ga_mcf as (

    select 
        date, 
        client, 
        'First-touch' as attribution,
        channel, 
        platform, 
        '' as url,
        campaign, 
        transactionid, 
        first_touch_transactions as transactions,
        first_touch_revenue as revenue
    from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_mcf_stats`

)


SELECT
    date, 
    a.client client,
    attribution,
    transactionid,
    b.customer_id customer_id,
    b.order_type order_type,
    b.first_order_revenue first_order_revenue,
    b.lifetime_revenue lifetime_revenue,
    channel,
    platform,
    url,
    campaign,
    transactions,
    revenue
FROM (
    SELECT * FROM ga
    UNION ALL
    SELECT * FROM ga_mcf
) a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`customers_by_transaction` b
ON (
    a.client = b.client AND
    a.transactionid = b.order_number
)
2018-04-17 15:43:01,429: Model SQL (agg_transaction):
SELECT
client,
date,
customer_id,
order_number,
last_touch_channel,
last_touch_platform,
last_touch_url,
first_touch_channel, 
first_touch_platform, 
first_touch_utm_campaign,
ifnull( sum(last_touch_transactions), 0) last_touch_transactions, 
ifnull( sum(last_touch_revenue), 0) last_touch_revenue, 
ifnull( sum(first_touch_transactions), 0) first_touch_transactions, 
ifnull( sum(first_touch_revenue), 0) first_touch_revenue,
ifnull( sum(final_quantity), 0) quantity,
ifnull( sum(final_price), 0) revenue,
ifnull( sum(shipping_price), 0) shipping_revenue,
ROW_NUMBER() OVER (PARTITION BY client, customer_id, order_number ORDER BY date asc) AS order_sequence
FROM
(
	SELECT
	a.client,
	a.date date,
	b.date ga_date,
	a.customer_id,
	a.order_number,
	transactionid,
	b.last_touch_channel,
	b.last_touch_platform,
	b.last_touch_url,
	b.first_touch_channel, 
	b.first_touch_platform, 
	b.first_touch_utm_campaign, 
	last_touch_transactions, 
	last_touch_revenue, 
	first_touch_transactions, 
	first_touch_revenue,
	final_quantity,
	final_price,
	shipping_price
	FROM
	`growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_order_number` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`agg_ga_transaction_order_number` b
	ON (
		a.client = b.client and
		a.order_number = b.transactionid
	)

)
GROUP BY
client, 
date, 
customer_id,
order_number, 
last_touch_channel,
last_touch_platform,
last_touch_url,
first_touch_channel, 
first_touch_platform, 
first_touch_utm_campaign
2018-04-17 15:43:01,463: Model SQL (segment_stats_sku):
WITH last_30 as (

	SELECT
	client,
	sku, 
	product_type,
	date,
	unique_customers as customers_30,
	orders as orders_30,
	revenue as revenue_30,
	segment as segment_30,
	0 as customers_90,
	0 as orders_90,
	0 as revenue_90,
	'' as segment_90,
	0 as customers_yoy_30,
	0 as orders_yoy_30,
	0 as revenue_yoy_30,
	'' as segment_yoy_30
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_sku`
	WHERE period = 'Last 30'

),

last_90 as (

	SELECT
	client,
	sku, 
	product_type,
	date,
	0 as customers_30,
	0 as orders_30,
	0 as revenue_30,
	'' as segment_30,
	unique_customers as customers_90,
	orders as orders_90,
	revenue as revenue_90,
	segment as segment_90,
	0 as customers_yoy_30,
	0 as orders_yoy_30,
	0 as revenue_yoy_30,
	'' as segment_yoy_30
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_sku`
	WHERE period = 'Last 90'

),

yoy_30 as (

	SELECT
	client,
	sku, 
	product_type,
	date,
	0 as customers_30,
	0 as orders_30,
	0 as revenue_30,
	'' as segment_30,
	0 as customers_90,
	0 as orders_90,
	0 as revenue_90,
	'' as segment_90,
	unique_customers as customers_yoy_30,
	orders as orders_yoy_30,
	revenue as revenue_yoy_30,
	segment as segment_yoy_30
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_sku`
	WHERE period = 'YoY 30'

)

SELECT
client,
sku, 
product_type,
date,
ifnull(sum(customers_30), 0) customers_30,
ifnull(sum(orders_30), 0) orders_30,
ifnull(sum(revenue_30), 0) revenue_30,
ifnull(max(segment_30), '') segment_30,
ifnull(sum(customers_90), 0) customers_90,
ifnull(sum(orders_90), 0) orders_90,
ifnull(sum(revenue_90), 0) revenue_90,
ifnull(max(segment_90), '') segment_90,
ifnull(sum(customers_yoy_30), 0) customers_yoy_30,
ifnull(sum(orders_yoy_30), 0) orders_yoy_30,
ifnull(sum(revenue_yoy_30), 0) revenue_yoy_30,
ifnull(max(segment_yoy_30), '') segment_yoy_30
FROM
(
	SELECT * FROM last_30
	UNION ALL
	SELECT * FROM last_90
	UNION ALL
	SELECT * FROM yoy_30

)
GROUP BY client, sku, product_type, date
2018-04-17 15:43:01,528: Model SQL (segment_proc_customers_products):
SELECT
client,
period,
date,
customer_id,
first_order_date,
first_order_unix_date,
product_type,
recency_days,
frequency,
revenue,
quantity,
aov,
case when frequency = 1 and recency_days <= 30 and first_order_unix_date >= window_start_unix_date then 'New'
	when frequency = 1 then 'One-time Purchaser'
	when frequency > frequency_90pct and recency_days < recency_90pct and aov > aov_50pct then 'Champion'
	when recency_days < recency_90pct and frequency > frequency_75pct then 'Potential Loyalists' 
	when frequency > frequency_75pct and recency_days <= recency_50pct then 'Cant Lose'
	when recency_days < recency_50pct and frequency > frequency_50pct then 'Loyal'
	when recency_days > recency_50pct and frequency > frequency_50pct then 'Frequent, not Recent'
	when recency_days < recency_50pct and frequency < frequency_50pct then 'Recent, not Frequent'
	else 'Unbucketed' end as segment,
aov_50pct,
frequency_90pct,
frequency_75pct,
frequency_50pct,
recency_90pct,
recency_75pct,
recency_50pct
FROM
(
	SELECT 
	a.client client,
	period,
	date,
	a.customer_id customer_id,
	a.product_type product_type,
	b.first_order_date first_order_date,
	b.first_order_unix_date first_order_unix_date,
	window_start_unix_date,
	window_end_unix_date,	
	recency_days,
	frequency,
	revenue,
	quantity,
	aov,
	PERCENTILE_CONT(aov, 0.50) OVER w1 AS aov_50pct,
	PERCENTILE_CONT(frequency, 0.90) OVER w1 AS frequency_90pct,
	PERCENTILE_CONT(frequency, 0.75) OVER w1 AS frequency_75pct,
	PERCENTILE_CONT(frequency, 0.90) OVER w1 AS frequency_50pct,
	PERCENTILE_CONT(recency_days, 0.10) OVER w1 AS recency_90pct,
	PERCENTILE_CONT(recency_days, 0.25) OVER w1 AS recency_75pct,
	PERCENTILE_CONT(recency_days, 0.5) OVER w1 AS recency_50pct
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`customers_products_proc` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`customers_first_purchase_product_type_proc` b
	ON (
		a.client = b.client and
		a.customer_id = b.customer_id and
		a.product_type = b.product_type
		)
	WINDOW w1 as (PARTITION BY a.client, period, date, a.product_type)
)
2018-04-17 15:43:04,796: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1058422b0>]}
2018-04-17 15:43:05,077: 15:43:05 | 51 of 91 OK created table model agency_data_pipeline.segment_stats_sku [CREATE TABLE in 4.33s]
2018-04-17 15:43:08,089: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10231dda0>]}
2018-04-17 15:43:08,347: 15:43:08 | 54 of 91 OK created table model agency_data_pipeline.agg_ga_transaction [CREATE TABLE in 7.59s]
2018-04-17 15:43:09,211: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1022decc0>]}
2018-04-17 15:43:09,460: 15:43:09 | 52 of 91 OK created table model agency_data_pipeline.agg_transaction. [CREATE TABLE in 8.74s]
2018-04-17 15:43:37,440: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1022e93c8>]}
2018-04-17 15:43:38,202: 15:43:38 | 53 of 91 OK created table model agency_data_pipeline.segment_proc_customers_products [CREATE TABLE in 36.95s]
2018-04-17 15:43:38,203: 15:43:38 | 55 of 91 START table model agency_data_pipeline.agg_ga_campaign_by_type [RUN]
2018-04-17 15:43:38,203: 15:43:38 | 56 of 91 START table model agency_data_pipeline.order_paths_stats.... [RUN]
2018-04-17 15:43:38,204: 15:43:38 | 57 of 91 START table model agency_data_pipeline.segment_stats_customers_products_agg [RUN]
2018-04-17 15:43:38,204: 15:43:38 | 58 of 91 START table model agency_data_pipeline.agg_transaction_daily [RUN]
2018-04-17 15:43:38,204: Compiling model.agency_data_pipeline.agg_ga_campaign_by_type
2018-04-17 15:43:38,205: Compiling model.agency_data_pipeline.order_paths_stats
2018-04-17 15:43:38,205: Compiling model.agency_data_pipeline.segment_stats_customers_products_agg
2018-04-17 15:43:38,205: Compiling model.agency_data_pipeline.agg_transaction_daily
2018-04-17 15:43:38,214: Writing injected SQL for node "model.agency_data_pipeline.agg_ga_campaign_by_type"
2018-04-17 15:43:38,230: Writing injected SQL for node "model.agency_data_pipeline.agg_transaction_daily"
2018-04-17 15:43:38,232: Writing injected SQL for node "model.agency_data_pipeline.segment_stats_customers_products_agg"
2018-04-17 15:43:38,234: Writing injected SQL for node "model.agency_data_pipeline.order_paths_stats"
2018-04-17 15:43:38,236: Acquiring new bigquery connection "agg_ga_campaign_by_type".
2018-04-17 15:43:38,236: Re-using an available connection from the pool.
2018-04-17 15:43:38,237: Acquiring new bigquery connection "order_paths_stats".
2018-04-17 15:43:38,239: Acquiring new bigquery connection "agg_transaction_daily".
2018-04-17 15:43:38,241: Acquiring new bigquery connection "segment_stats_customers_products_agg".
2018-04-17 15:43:38,242: Re-using an available connection from the pool.
2018-04-17 15:43:38,244: Re-using an available connection from the pool.
2018-04-17 15:43:38,244: Re-using an available connection from the pool.
2018-04-17 15:43:41,189: Model SQL (segment_stats_customers_products_agg):
WITH ty as (

	SELECT
	client,
	date,
	customer_id,
	product_type,
	segment as segment_365,
	recency_days as recency_365,
	frequency as frequency_365,
	revenue as revenue_365,
	aov as aov_365,
	'' as segment_mom,
	0 as recency_mom,
	0 as frequency_mom,
	0 as revenue_mom,
	0 as aov_mom,
	'' as segment_yoy,
	0 as recency_yoy,
	0 as frequency_yoy,
	0 as revenue_yoy,
	0 as aov_yoy
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers_products`
	WHERE period = 'Rolling 365'

),

last_month as (

	SELECT
	client,
	date,
	customer_id,
	product_type,
	'' as segment_365,
	0 as recency_365,
	0 as frequency_365,
	0 as revenue_365,
	0 as aov_365,
	segment as segment_mom,
	recency_days as recency_mom,
	frequency as frequency_mom,
	revenue as revenue_mom,
	aov as aov_mom,
	'' as segment_yoy,
	0 as recency_yoy,
	0 as frequency_yoy,
	0 as revenue_yoy,
	0 as aov_yoy
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers_products`
	WHERE period = 'Rolling 365 (t-1mo)'

),

this_month_1yr as (

	SELECT
	client,
	date,
	customer_id,
	product_type,
	'' as segment_365,
	0 as recency_365,
	0 as frequency_365,
	0 as revenue_365,
	0 as aov_365,
	'' as segment_mom,
	0 as recency_mom,
	0 as frequency_mom,
	0 as revenue_mom,
	0 as aov_mom,
	segment as segment_yoy,
	recency_days as recency_yoy,
	frequency as frequency_yoy,
	revenue as revenue_yoy,
	aov as aov_yoy
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers_products`
	WHERE period = 'Rolling 365 (t-1yr)'


)

SELECT
client,
date, 
customer_id,
product_type,
ifnull(max(segment_365), '') segment_365,
ifnull(max(segment_mom), '') segment_mom,
ifnull(max(segment_yoy), '') segment_yoy,
ifnull(sum(recency_365), 0) recency_365,
ifnull(sum(frequency_365), 0) frequency_365,
ifnull(sum(revenue_365), 0) revenue_365,
ifnull(sum(aov_365), 0) aov_365,
ifnull(sum(recency_mom), 0) recency_mom,
ifnull(sum(frequency_mom), 0) frequency_mom,
ifnull(sum(revenue_mom), 0) revenue_mom,
ifnull(sum(aov_mom), 0) aov_mom,	
ifnull(sum(recency_yoy), 0) recency_yoy,
ifnull(sum(frequency_yoy), 0) frequency_yoy,
ifnull(sum(revenue_yoy), 0) revenue_yoy,
ifnull(sum(aov_yoy), 0) aov_yoy
FROM
(
	SELECT * FROM ty
	UNION ALL
	SELECT * FROM last_month
	UNION ALL
	SELECT * FROM this_month_1yr

)
GROUP BY client, date, customer_id, product_type
2018-04-17 15:43:41,191: Model SQL (agg_transaction_daily):
SELECT
client,
date,
customer_id,
sum(last_touch_transactions) last_touch_transactions, 
sum(last_touch_revenue) last_touch_revenue, 
sum(first_touch_transactions) first_touch_transactions, 
sum(first_touch_revenue) first_touch_revenue,
sum(quantity) quantity,
sum(revenue) revenue,
count(distinct(order_number)) order_count
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction`
GROUP BY
client, 
date, 
customer_id
2018-04-17 15:43:41,192: Model SQL (order_paths_stats):
WITH transactions AS (
  SELECT 
  client, 
  first_product_type,
  second_product_type,
  first_purchase_date,
  customer_count,
  second_orders,
  third_orders,
  fourth_orders,
  fifth_orders,
  second_order_latency_days,
  third_order_latency_days,
  fourth_order_latency_days,
  fifth_order_latency_days,
  first_order_revenue,
  second_order_revenue,
  unix_date(cast(first_purchase_date as date)) d
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`order_paths_agg`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)

SELECT 
client,
'Rolling 365' as period,
first_product_type,
second_product_type,
date_in_range date,
unix_date_in_range, 
sum(customer_count) customer_count,
sum(second_orders) second_orders,
sum(third_orders) third_orders,
sum(fourth_orders) fourth_orders,
sum(fifth_orders) fifth_orders,
sum(second_order_latency_days) second_order_latency_days,
sum(third_order_latency_days) third_order_latency_days,
sum(fourth_order_latency_days) fourth_order_latency_days,
sum(fifth_order_latency_days) fifth_order_latency_days,
sum(first_order_revenue) first_order_revenue,
sum(second_order_revenue) second_order_revenue
FROM daterange
JOIN transactions
ON transactions.d > ( daterange.unix_date_in_range - 365 )
AND transactions.d <= daterange.unix_date_in_range
group by client, first_product_type, second_product_type, date_in_range, unix_date_in_range
2018-04-17 15:43:41,608: Model SQL (agg_ga_campaign_by_type):
with orders_new as (
    select 
    date, 
    client, 
    attribution,
    channel, 
    platform, 
    url, 
    campaign,
    count(distinct(customer_id)) customers_new,
    sum(transactions) transactions_new,
    sum(revenue) revenue_new,
    sum(first_order_revenue) first_order_revenue_new,
    sum(lifetime_revenue) lifetime_revenue_new,
    null as customers_total,
    null as transactions_total,
    null as revenue_total
    from `growth-engines-pipeline`.`agency_data_pipeline`.`agg_ga_transaction`
    where order_type = 'New'
    group by date, client, attribution, channel, platform, url, campaign
),
    
orders_total as (
    select 
    date, 
    client, 
    attribution,
    channel, 
    platform, 
    url, 
    campaign,
    null as customers_new,
    null as transactions_new,
    null as revenue_new,
    null as first_order_revenue_new,
    null as lifetime_revenue_new,
    count(distinct(customer_id)) customers_total,
    sum(transactions) transactions_total,
    sum(revenue) revenue_total
    from `growth-engines-pipeline`.`agency_data_pipeline`.`agg_ga_transaction`
    group by date, client, attribution, channel, platform, url, campaign

)

SELECT 
date, 
client, 
attribution,
channel, 
platform, 
url, 
campaign,
sum(customers_new) customers_new,
sum(transactions_new) transactions_new,
sum(revenue_new) revenue_new,
sum(first_order_revenue_new) first_order_revenue_new,
sum(lifetime_revenue_new) lifetime_revenue_new,
sum(customers_total) customers_total,
sum(transactions_total) transactions_total,
sum(revenue_total) revenue_total
from
    ( 
        SELECT * FROM orders_new
        UNION ALL 
        SELECT * FROM orders_total
    )
group by date, client, attribution, channel, platform, url, campaign
2018-04-17 15:43:42,731: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10593d390>]}
2018-04-17 15:43:42,985: 15:43:42 | 56 of 91 OK created table model agency_data_pipeline.order_paths_stats [CREATE TABLE in 4.53s]
2018-04-17 15:43:42,986: 15:43:42 | 59 of 91 START table model agency_data_pipeline.segment_stats_category [RUN]
2018-04-17 15:43:42,986: Compiling model.agency_data_pipeline.segment_stats_category
2018-04-17 15:43:42,995: Writing injected SQL for node "model.agency_data_pipeline.segment_stats_category"
2018-04-17 15:43:42,998: Acquiring new bigquery connection "segment_stats_category".
2018-04-17 15:43:42,998: Re-using an available connection from the pool.
2018-04-17 15:43:45,386: Model SQL (segment_stats_category):
SELECT
client,
product_type,
date,
segment_30,
segment_90,
segment_yoy_30,
ifnull(sum(customers_30), 0) customers_30,
ifnull(sum(orders_30), 0) orders_30,
ifnull(sum(revenue_30), 0) revenue_30,
ifnull(sum(customers_90), 0) customers_90,
ifnull(sum(orders_90), 0) orders_90,
ifnull(sum(revenue_90), 0) revenue_90,
ifnull(sum(customers_yoy_30), 0) customers_yoy_30,
ifnull(sum(orders_yoy_30), 0) orders_yoy_30,
ifnull(sum(revenue_yoy_30), 0) revenue_yoy_30
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`segment_stats_sku`
GROUP BY client, product_type, date, segment_30, segment_90, segment_yoy_30
2018-04-17 15:43:46,918: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105920f98>]}
2018-04-17 15:43:47,172: 15:43:47 | 59 of 91 OK created table model agency_data_pipeline.segment_stats_category [CREATE TABLE in 3.93s]
2018-04-17 15:43:47,173: 15:43:47 | 60 of 91 START table model agency_data_pipeline.customers_first_purchase_proc [RUN]
2018-04-17 15:43:47,173: Compiling model.agency_data_pipeline.customers_first_purchase_proc
2018-04-17 15:43:47,184: Writing injected SQL for node "model.agency_data_pipeline.customers_first_purchase_proc"
2018-04-17 15:43:47,188: Acquiring new bigquery connection "customers_first_purchase_proc".
2018-04-17 15:43:47,188: Re-using an available connection from the pool.
2018-04-17 15:43:47,591: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10596e908>]}
2018-04-17 15:43:47,842: 15:43:47 | 55 of 91 OK created table model agency_data_pipeline.agg_ga_campaign_by_type [CREATE TABLE in 9.39s]
2018-04-17 15:43:49,218: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105920358>]}
2018-04-17 15:43:49,496: 15:43:49 | 58 of 91 OK created table model agency_data_pipeline.agg_transaction_daily [CREATE TABLE in 11.01s]
2018-04-17 15:43:50,095: Model SQL (customers_first_purchase_proc):
SELECT 
client, 
customer_id, 
min(cast(date as date)) first_order_date,
unix_date( min(cast(date as date))) first_order_unix_date
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction`
GROUP BY client, customer_id
2018-04-17 15:43:53,122: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10593dba8>]}
2018-04-17 15:43:53,374: 15:43:53 | 60 of 91 OK created table model agency_data_pipeline.customers_first_purchase_proc [CREATE TABLE in 5.95s]
2018-04-17 15:44:10,823: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105962a20>]}
2018-04-17 15:44:11,075: 15:44:11 | 57 of 91 OK created table model agency_data_pipeline.segment_stats_customers_products_agg [CREATE TABLE in 32.62s]
2018-04-17 15:44:11,076: 15:44:11 | 61 of 91 START table model agency_data_pipeline.growth_customer_0_365 [RUN]
2018-04-17 15:44:11,076: Compiling model.agency_data_pipeline.growth_customer_0_365
2018-04-17 15:44:11,076: 15:44:11 | 62 of 91 START table model agency_data_pipeline.segment_stats_customers_products [RUN]
2018-04-17 15:44:11,083: Compiling model.agency_data_pipeline.segment_stats_customers_products
2018-04-17 15:44:11,076: 15:44:11 | 63 of 91 START table model agency_data_pipeline.customers_proc....... [RUN]
2018-04-17 15:44:11,092: Writing injected SQL for node "model.agency_data_pipeline.segment_stats_customers_products"
2018-04-17 15:44:11,095: Writing injected SQL for node "model.agency_data_pipeline.growth_customer_0_365"
2018-04-17 15:44:11,095: Compiling model.agency_data_pipeline.customers_proc
2018-04-17 15:44:11,101: Writing injected SQL for node "model.agency_data_pipeline.customers_proc"
2018-04-17 15:44:11,104: Acquiring new bigquery connection "segment_stats_customers_products".
2018-04-17 15:44:11,105: Acquiring new bigquery connection "customers_proc".
2018-04-17 15:44:11,105: Re-using an available connection from the pool.
2018-04-17 15:44:11,108: Re-using an available connection from the pool.
2018-04-17 15:44:11,109: Acquiring new bigquery connection "growth_customer_0_365".
2018-04-17 15:44:11,111: Re-using an available connection from the pool.
2018-04-17 15:44:12,001: Model SQL (growth_customer_0_365):
WITH transactions AS (
  SELECT 
  client, 
  customer_id, 
  order_number,
  unix_date(cast(date as date)) d, 
  quantity,
  revenue,
  shipping_revenue
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)

SELECT 
date_in_range date,
unix_date_in_range, 
unix_date_in_range_yoy, 
client, 
customer_id,
count(distinct(order_number)) orders,
sum(quantity) quantity,
sum(revenue) revenue,
sum(shipping_revenue) shipping_revenue
FROM daterange
JOIN transactions
ON transactions.d >= ( daterange.unix_date_in_range - 365 ) 
AND transactions.d <= daterange.unix_date_in_range
GROUP BY date, unix_date_in_range, unix_date_in_range_yoy, client, customer_id
2018-04-17 15:44:12,055: Model SQL (segment_stats_customers_products):
SELECT
client,
date,
product_type,
segment_365,
segment_mom,
segment_yoy,
count(distinct(customer_id)) customers,
avg(recency_365) recency_365,
sum(frequency_365) frequency_365,
sum(revenue_365) revenue_365,
case when sum(frequency_365) > 0 then sum(revenue_365)/sum(frequency_365) else null end as aov_365,
avg(recency_mom) recency_mom,
sum(frequency_mom) frequency_mom,
sum(revenue_mom) revenue_mom,
case when sum(frequency_mom) > 0 then sum(revenue_mom)/sum(frequency_mom) else null end as aov_mom,
avg(recency_yoy) recency_yoy,
sum(frequency_yoy) frequency_yoy,
sum(revenue_yoy) revenue_yoy,
case when sum(frequency_yoy) > 0 then sum(revenue_yoy)/sum(frequency_yoy) else null end as aov_yoy
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_stats_customers_products_agg`
GROUP BY client, date, product_type, segment_365, segment_mom, segment_yoy
2018-04-17 15:44:12,090: Model SQL (customers_proc):
WITH customers AS (
  SELECT 
  client, 
  customer_id, 
  order_number,
  cast(date as date) order_date,
  unix_date(cast(date as date)) unix_order_date, 
  quantity,
  revenue 
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)
 
SELECT 
client,
period,
customer_id,
date,
window_end_unix_date,
window_end_unix_date - 365 as window_start_unix_date,
window_end_unix_date - unix_date(recent_order) recency_days,
frequency,
quantity,
revenue,
case when frequency > 0 then revenue/frequency else 0 end as aov
FROM 
(  

  SELECT 
  client,
  'Rolling 365' as period,
  customer_id,
  date_in_range date,
  unix_date_in_range,
  unix_date_in_range window_end_unix_date,
  max(order_date) recent_order,
  sum(quantity) as quantity,
  sum(revenue) as revenue,
  count(distinct(order_number)) as frequency
  FROM daterange
  JOIN customers
  ON customers.unix_order_date > ( daterange.unix_date_in_range - 365 )
  AND customers.unix_order_date <= daterange.unix_date_in_range
  GROUP BY client, customer_id, date, unix_date_in_range

  UNION ALL

  SELECT 
  client,
  'Rolling 365 (t-1mo)' as period,
  customer_id,
  date_in_range date,
  unix_date_in_range,
  unix_date_in_range - 30 window_end_unix_date, 
  max(order_date) recent_order,
  sum(quantity) as quantity,
  sum(revenue) as revenue,
  count(distinct(order_number)) as frequency
  FROM daterange
  JOIN customers
  ON customers.unix_order_date > ( daterange.unix_date_in_range - 395 )
  AND customers.unix_order_date <= ( daterange.unix_date_in_range - 30 )
  GROUP BY client, customer_id, date, unix_date_in_range

  UNION ALL

  SELECT 
  client,
  'Rolling 365 (t-1yr)' as period,
  customer_id,
  date_in_range date,
  unix_date_in_range, 
  unix_date_in_range - 365 window_end_unix_date, 
  max(order_date) recent_order,
  sum(quantity) as quantity,
  sum(revenue) as revenue,
  count(distinct(order_number)) as frequency
  FROM daterange
  JOIN customers
  ON customers.unix_order_date > ( daterange.unix_date_in_range - 730 )
  AND customers.unix_order_date <= ( daterange.unix_date_in_range - 365 )
  GROUP BY client, customer_id, date, unix_date_in_range

)
2018-04-17 15:44:24,774: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10237fdd8>]}
2018-04-17 15:44:25,040: 15:44:25 | 62 of 91 OK created table model agency_data_pipeline.segment_stats_customers_products [CREATE TABLE in 13.69s]
2018-04-17 15:44:30,821: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1022f4cf8>]}
2018-04-17 15:44:31,084: 15:44:31 | 61 of 91 OK created table model agency_data_pipeline.growth_customer_0_365 [CREATE TABLE in 19.74s]
2018-04-17 15:44:42,208: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10235b048>]}
2018-04-17 15:44:42,921: 15:44:42 | 63 of 91 OK created table model agency_data_pipeline.customers_proc.. [CREATE TABLE in 31.11s]
2018-04-17 15:44:42,921: 15:44:42 | 64 of 91 START table model agency_data_pipeline.retention_0_30....... [RUN]
2018-04-17 15:44:42,922: Compiling model.agency_data_pipeline.retention_0_30
2018-04-17 15:44:42,922: 15:44:42 | 65 of 91 START table model agency_data_pipeline.retention_0_365...... [RUN]
2018-04-17 15:44:42,927: Writing injected SQL for node "model.agency_data_pipeline.retention_0_30"
2018-04-17 15:44:42,922: 15:44:42 | 66 of 91 START table model agency_data_pipeline.retention_30_60...... [RUN]
2018-04-17 15:44:42,928: Compiling model.agency_data_pipeline.retention_30_60
2018-04-17 15:44:42,928: Compiling model.agency_data_pipeline.retention_0_365
2018-04-17 15:44:42,940: Writing injected SQL for node "model.agency_data_pipeline.retention_0_365"
2018-04-17 15:44:42,922: 15:44:42 | 67 of 91 START table model agency_data_pipeline.retention_365_730.... [RUN]
2018-04-17 15:44:42,942: Writing injected SQL for node "model.agency_data_pipeline.retention_30_60"
2018-04-17 15:44:42,942: Compiling model.agency_data_pipeline.retention_365_730
2018-04-17 15:44:42,949: Acquiring new bigquery connection "retention_0_365".
2018-04-17 15:44:42,950: Acquiring new bigquery connection "retention_0_30".
2018-04-17 15:44:42,954: Writing injected SQL for node "model.agency_data_pipeline.retention_365_730"
2018-04-17 15:44:42,954: Re-using an available connection from the pool.
2018-04-17 15:44:42,955: Acquiring new bigquery connection "retention_30_60".
2018-04-17 15:44:42,960: Re-using an available connection from the pool.
2018-04-17 15:44:42,961: Acquiring new bigquery connection "retention_365_730".
2018-04-17 15:44:42,970: Re-using an available connection from the pool.
2018-04-17 15:44:42,974: Re-using an available connection from the pool.
2018-04-17 15:44:44,854: Model SQL (retention_30_60):
WITH transactions AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_daily`
),

daterange AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`  	
),

temp AS (
  SELECT 
  client, 
  customer_id, 
  unix_date(date) d, 
  quantity,
  revenue,
  order_count
  FROM transactions
)

SELECT 
date_in_range date, 
unix_date_in_range,
client, 
customer_id,
sum(quantity) quantity,
sum(revenue) revenue,
sum(order_count) order_count
FROM daterange
JOIN temp
ON ( temp.d >= ( daterange.unix_date_in_range_bom_mom ) 
AND temp.d < ( daterange.unix_date_in_range_bom ) )
group by date_in_range, unix_date_in_range, client, customer_id
2018-04-17 15:44:44,855: Model SQL (retention_0_30):
WITH transactions AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_daily`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
),

temp AS (
  SELECT 
  client, 
  customer_id, 
  unix_date(date) d, 
  quantity,
  revenue,
  order_count
  FROM transactions
)

SELECT 
date_in_range date,
unix_date_in_range, 
client, 
customer_id,
sum(quantity) quantity,
sum(revenue) revenue,
sum(order_count) order_count
FROM daterange
JOIN temp
ON temp.d >= ( daterange.unix_date_in_range_bom ) 
AND temp.d <= daterange.unix_date_in_range
group by date_in_range, unix_date_in_range, client, customer_id
2018-04-17 15:44:44,855: Model SQL (retention_365_730):
WITH transactions AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_daily`
),

daterange AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`  	
),

temp AS (
  SELECT 
  client, 
  customer_id, 
  unix_date(date) d, 
  quantity,
  revenue,
  order_count
  FROM transactions
)

SELECT 
date_in_range date, 
unix_date_in_range,
client, 
customer_id,
sum(quantity) quantity,
sum(revenue) revenue,
sum(order_count) order_count
FROM daterange
JOIN temp
ON ( temp.d >= ( daterange.unix_date_in_range - 730 ) 
AND temp.d < ( daterange.unix_date_in_range - 365 ) )
group by date_in_range, unix_date_in_range, client, customer_id
2018-04-17 15:44:44,856: Model SQL (retention_0_365):
WITH transactions AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_daily`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
),

temp AS (
  SELECT 
  client, 
  customer_id, 
  unix_date(date) d, 
  quantity,
  revenue,
  order_count
  FROM transactions
)

SELECT 
date_in_range date,
unix_date_in_range, 
client, 
customer_id,
sum(quantity) quantity,
sum(revenue) revenue,
sum(order_count) order_count
FROM daterange
JOIN temp
ON temp.d >= ( daterange.unix_date_in_range - 365 ) 
AND temp.d <= daterange.unix_date_in_range
group by date_in_range, unix_date_in_range, client, customer_id
2018-04-17 15:44:48,224: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10231d898>]}
2018-04-17 15:44:48,240: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105962a20>]}
2018-04-17 15:44:48,494: 15:44:48 | 66 of 91 OK created table model agency_data_pipeline.retention_30_60. [CREATE TABLE in 5.30s]
2018-04-17 15:44:48,496: 15:44:48 | 68 of 91 START table model agency_data_pipeline.retention_60_plus.... [RUN]
2018-04-17 15:44:48,496: Compiling model.agency_data_pipeline.retention_60_plus
2018-04-17 15:44:48,504: Writing injected SQL for node "model.agency_data_pipeline.retention_60_plus"
2018-04-17 15:44:48,508: Acquiring new bigquery connection "retention_60_plus".
2018-04-17 15:44:48,508: Re-using an available connection from the pool.
2018-04-17 15:44:48,750: 15:44:48 | 64 of 91 OK created table model agency_data_pipeline.retention_0_30.. [CREATE TABLE in 5.32s]
2018-04-17 15:44:48,750: 15:44:48 | 69 of 91 START table model agency_data_pipeline.retention_730_plus... [RUN]
2018-04-17 15:44:48,750: Compiling model.agency_data_pipeline.retention_730_plus
2018-04-17 15:44:48,756: Writing injected SQL for node "model.agency_data_pipeline.retention_730_plus"
2018-04-17 15:44:48,757: Acquiring new bigquery connection "retention_730_plus".
2018-04-17 15:44:48,757: Re-using an available connection from the pool.
2018-04-17 15:44:49,325: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x102c41080>]}
2018-04-17 15:44:49,386: Model SQL (retention_60_plus):
WITH transactions AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_daily`
),

daterange AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`  	
),

temp AS (
  SELECT 
  client, 
  customer_id, 
  unix_date(date) d, 
  quantity,
  revenue,
  order_count
  FROM transactions
)

SELECT 
date_in_range date, 
unix_date_in_range,
client, 
customer_id,
sum(quantity) quantity,
sum(revenue) revenue,
sum(order_count) order_count
FROM daterange
JOIN temp
ON temp.d < ( daterange.unix_date_in_range_bom_mom ) 
group by date_in_range, unix_date_in_range, client, customer_id
2018-04-17 15:44:49,588: Model SQL (retention_730_plus):
WITH transactions AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_daily`
),

daterange AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`  	
),

temp AS (
  SELECT 
  client, 
  customer_id, 
  unix_date(date) d, 
  quantity,
  revenue,
  order_count
  FROM transactions
)

SELECT 
date_in_range date, 
unix_date_in_range,
client, 
customer_id,
sum(quantity) quantity,
sum(revenue) revenue,
sum(order_count) order_count
FROM daterange
JOIN temp
ON temp.d <= ( daterange.unix_date_in_range - 730 ) 
group by date_in_range, unix_date_in_range, client, customer_id
2018-04-17 15:44:49,593: 15:44:49 | 67 of 91 OK created table model agency_data_pipeline.retention_365_730 [CREATE TABLE in 6.38s]
2018-04-17 15:44:49,593: 15:44:49 | 70 of 91 START table model agency_data_pipeline.segment_list_customers_products [RUN]
2018-04-17 15:44:49,593: Compiling model.agency_data_pipeline.segment_list_customers_products
2018-04-17 15:44:49,601: Writing injected SQL for node "model.agency_data_pipeline.segment_list_customers_products"
2018-04-17 15:44:49,602: Acquiring new bigquery connection "segment_list_customers_products".
2018-04-17 15:44:49,602: Re-using an available connection from the pool.
2018-04-17 15:44:50,324: Model SQL (segment_list_customers_products):
SELECT
a.client,
period,
date,
customer_id,
product_type,
b.first_name,
b.last_name,
b.email,
recency_days,
frequency,
revenue,
quantity,
aov,
segment
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers_products` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`agg_customers_union` b
ON (
	a.client = b.client AND
	a.customer_id = b.id
)
2018-04-17 15:44:51,809: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105962a20>]}
2018-04-17 15:44:52,049: 15:44:52 | 69 of 91 OK created table model agency_data_pipeline.retention_730_plus [CREATE TABLE in 3.06s]
2018-04-17 15:44:56,008: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10235b3c8>]}
2018-04-17 15:44:56,255: 15:44:56 | 65 of 91 OK created table model agency_data_pipeline.retention_0_365. [CREATE TABLE in 13.08s]
2018-04-17 15:45:01,589: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10593d898>]}
2018-04-17 15:45:01,845: 15:45:01 | 68 of 91 OK created table model agency_data_pipeline.retention_60_plus [CREATE TABLE in 13.09s]
2018-04-17 15:45:36,044: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x102c41080>]}
2018-04-17 15:45:36,748: 15:45:36 | 70 of 91 OK created table model agency_data_pipeline.segment_list_customers_products [CREATE TABLE in 46.45s]
2018-04-17 15:45:36,750: 15:45:36 | 71 of 91 START table model agency_data_pipeline.segment_proc_customers [RUN]
2018-04-17 15:45:36,750: 15:45:36 | 72 of 91 START table model agency_data_pipeline.agg_platforms_union.. [RUN]
2018-04-17 15:45:36,751: Compiling model.agency_data_pipeline.segment_proc_customers
2018-04-17 15:45:36,751: Compiling model.agency_data_pipeline.agg_platforms_union
2018-04-17 15:45:36,767: Writing injected SQL for node "model.agency_data_pipeline.segment_proc_customers"
2018-04-17 15:45:36,768: Writing injected SQL for node "model.agency_data_pipeline.agg_platforms_union"
2018-04-17 15:45:36,772: Acquiring new bigquery connection "agg_platforms_union".
2018-04-17 15:45:36,772: Re-using an available connection from the pool.
2018-04-17 15:45:36,773: Acquiring new bigquery connection "segment_proc_customers".
2018-04-17 15:45:36,774: Re-using an available connection from the pool.
2018-04-17 15:45:37,718: Model SQL (agg_platforms_union):
SELECT 
date, 
account, 
channel,
platform,
url,
utm_campaign,
campaign,
cost,
impressions,
clicks,
transactions
FROM 
`growth-engines-pipeline`.`agency_data_pipeline`.`adwords_stats`

UNION ALL

SELECT 
date, 
account, 
channel,
platform,
url,
utm_campaign,
campaign,
cost,
impressions,
clicks,
transactions
FROM 
`growth-engines-pipeline`.`agency_data_pipeline`.`bing_ads_stats`

UNION ALL  

SELECT 
date, 
account, 
channel,
platform,
url,
utm_campaign,
campaign,
cost,
impressions,
clicks,
transactions
FROM 
`growth-engines-pipeline`.`agency_data_pipeline`.`fb_ads_stats`
2018-04-17 15:45:37,719: Model SQL (segment_proc_customers):
SELECT
client,
period,
date,
customer_id,
first_order_date,
first_order_unix_date,
recency_days,
frequency,
revenue,
quantity,
aov,
case when frequency = 1 and recency_days <= 30 and first_order_unix_date >= window_start_unix_date then 'New'
	when frequency = 1 then 'One-time Purchaser'
	when frequency > frequency_90pct and recency_days < recency_90pct and aov > aov_50pct then 'Champion'
	when recency_days < recency_90pct and frequency > frequency_75pct then 'Potential Loyalists' 
	when frequency > frequency_75pct and recency_days <= recency_50pct then 'Cant Lose'
	when recency_days < recency_50pct and frequency > frequency_50pct then 'Loyal'
	when recency_days > recency_50pct and frequency > frequency_50pct then 'Frequent, not Recent'
	when recency_days < recency_50pct and frequency < frequency_50pct then 'Recent, not Frequent'
	else 'Unbucketed' end as segment,
aov_50pct,
frequency_90pct,
frequency_75pct,
frequency_50pct,
recency_90pct,
recency_75pct,
recency_50pct
FROM
(
	SELECT 
	a.client client,
	period,
	date,
	a.customer_id customer_id,
	b.first_order_date first_order_date,
	b.first_order_unix_date first_order_unix_date,
	window_start_unix_date,
	window_end_unix_date,
	recency_days,
	frequency,
	revenue,
	quantity,
	aov,
	PERCENTILE_CONT(aov, 0.50) OVER w1 AS aov_50pct,
	PERCENTILE_CONT(frequency, 0.90) OVER w1 AS frequency_90pct,
	PERCENTILE_CONT(frequency, 0.75) OVER w1 AS frequency_75pct,
	PERCENTILE_CONT(frequency, 0.90) OVER w1 AS frequency_50pct,
	PERCENTILE_CONT(recency_days, 0.10) OVER w1 AS recency_90pct,
	PERCENTILE_CONT(recency_days, 0.25) OVER w1 AS recency_75pct,
	PERCENTILE_CONT(recency_days, 0.5) OVER w1 AS recency_50pct
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`customers_proc` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`customers_first_purchase_proc` b
	ON (
		a.client = b.client and
		a.customer_id = b.customer_id
		)
	WINDOW w1 as (PARTITION BY a.client, period, date)
)
2018-04-17 15:45:42,184: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1022f4cf8>]}
2018-04-17 15:45:42,448: 15:45:42 | 72 of 91 OK created table model agency_data_pipeline.agg_platforms_union [CREATE TABLE in 5.43s]
2018-04-17 15:46:05,627: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1022d5b70>]}
2018-04-17 15:46:06,545: 15:46:06 | 71 of 91 OK created table model agency_data_pipeline.segment_proc_customers [CREATE TABLE in 28.88s]
2018-04-17 15:46:06,547: 15:46:06 | 73 of 91 START table model agency_data_pipeline.retention_0_30_rebuy. [RUN]
2018-04-17 15:46:06,547: 15:46:06 | 74 of 91 START table model agency_data_pipeline.retention_0_365_rebuy [RUN]
2018-04-17 15:46:06,548: Compiling model.agency_data_pipeline.retention_0_30_rebuy
2018-04-17 15:46:06,548: 15:46:06 | 75 of 91 START table model agency_data_pipeline.segment_stats_customers_agg [RUN]
2018-04-17 15:46:06,548: Compiling model.agency_data_pipeline.retention_0_365_rebuy
2018-04-17 15:46:06,560: Compiling model.agency_data_pipeline.segment_stats_customers_agg
2018-04-17 15:46:06,563: Writing injected SQL for node "model.agency_data_pipeline.retention_0_30_rebuy"
2018-04-17 15:46:06,568: Writing injected SQL for node "model.agency_data_pipeline.retention_0_365_rebuy"
2018-04-17 15:46:06,574: Writing injected SQL for node "model.agency_data_pipeline.segment_stats_customers_agg"
2018-04-17 15:46:06,581: Acquiring new bigquery connection "retention_0_365_rebuy".
2018-04-17 15:46:06,585: Acquiring new bigquery connection "segment_stats_customers_agg".
2018-04-17 15:46:06,585: Re-using an available connection from the pool.
2018-04-17 15:46:06,585: Acquiring new bigquery connection "retention_0_30_rebuy".
2018-04-17 15:46:06,587: Re-using an available connection from the pool.
2018-04-17 15:46:06,588: Re-using an available connection from the pool.
2018-04-17 15:46:07,727: Model SQL (retention_0_365_rebuy):
SELECT 
r2.client,
r2.date,
r2.customer_id, 
r2.quantity,
r2.revenue
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_365_730` r1 
left join `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365` r2 
  on ( r1.customer_id = r2.customer_id 
  and r1.date = r2.date )
2018-04-17 15:46:07,729: Model SQL (segment_stats_customers_agg):
WITH ty as (

	SELECT
	client,
	date,
	customer_id,
	segment as segment_365,
	recency_days as recency_365,
	frequency as frequency_365,
	revenue as revenue_365,
	aov as aov_365,
	'' as segment_mom,
	0 as recency_mom,
	0 as frequency_mom,
	0 as revenue_mom,
	0 as aov_mom,
	'' as segment_yoy,
	0 as recency_yoy,
	0 as frequency_yoy,
	0 as revenue_yoy,
	0 as aov_yoy
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers`
	WHERE period = 'Rolling 365'

),

last_month as (

	SELECT
	client,
	date,
	customer_id,
	'' as segment_365,
	0 as recency_365,
	0 as frequency_365,
	0 as revenue_365,
	0 as aov_365,
	segment as segment_mom,
	recency_days as recency_mom,
	frequency as frequency_mom,
	revenue as revenue_mom,
	aov as aov_mom,
	'' as segment_yoy,
	0 as recency_yoy,
	0 as frequency_yoy,
	0 as revenue_yoy,
	0 as aov_yoy
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers`
	WHERE period = 'Rolling 365 (t-1mo)'

),

this_month_1yr as (

	SELECT
	client,
	date,
	customer_id,
	'' as segment_365,
	0 as recency_365,
	0 as frequency_365,
	0 as revenue_365,
	0 as aov_365,
	'' as segment_mom,
	0 as recency_mom,
	0 as frequency_mom,
	0 as revenue_mom,
	0 as aov_mom,
	segment as segment_yoy,
	recency_days as recency_yoy,
	frequency as frequency_yoy,
	revenue as revenue_yoy,
	aov as aov_yoy
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers`
	WHERE period = 'Rolling 365 (t-1yr)'


)

SELECT
client,
date, 
customer_id,
ifnull(max(segment_365), '') segment_365,
ifnull(max(segment_mom), '') segment_mom,
ifnull(max(segment_yoy), '') segment_yoy,
ifnull(sum(recency_365), 0) recency_365,
ifnull(sum(frequency_365), 0) frequency_365,
ifnull(sum(revenue_365), 0) revenue_365,
ifnull(sum(aov_365), 0) aov_365,
ifnull(sum(recency_mom), 0) recency_mom,
ifnull(sum(frequency_mom), 0) frequency_mom,
ifnull(sum(revenue_mom), 0) revenue_mom,
ifnull(sum(aov_mom), 0) aov_mom,	
ifnull(sum(recency_yoy), 0) recency_yoy,
ifnull(sum(frequency_yoy), 0) frequency_yoy,
ifnull(sum(revenue_yoy), 0) revenue_yoy,
ifnull(sum(aov_yoy), 0) aov_yoy
FROM
(
	SELECT * FROM ty
	UNION ALL
	SELECT * FROM last_month
	UNION ALL
	SELECT * FROM this_month_1yr

)
GROUP BY client, date, customer_id
2018-04-17 15:46:07,729: Model SQL (retention_0_30_rebuy):
SELECT 
r2.client,
r2.date,
r2.customer_id, 
r2.quantity,
r2.revenue
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_30_60` r1 
left join `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30` r2 
  on ( r1.customer_id = r2.customer_id 
  and r1.date = r2.date )
2018-04-17 15:46:09,978: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x102c41080>]}
2018-04-17 15:46:10,261: 15:46:10 | 73 of 91 OK created table model agency_data_pipeline.retention_0_30_rebuy [CREATE TABLE in 3.43s]
2018-04-17 15:46:13,291: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x102c3ada0>]}
2018-04-17 15:46:13,570: 15:46:13 | 74 of 91 OK created table model agency_data_pipeline.retention_0_365_rebuy [CREATE TABLE in 6.74s]
2018-04-17 15:46:30,150: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x102c41400>]}
2018-04-17 15:46:30,403: 15:46:30 | 75 of 91 OK created table model agency_data_pipeline.segment_stats_customers_agg [CREATE TABLE in 23.59s]
2018-04-17 15:46:30,404: 15:46:30 | 76 of 91 START table model agency_data_pipeline.segment_stats_customers [RUN]
2018-04-17 15:46:30,404: Compiling model.agency_data_pipeline.segment_stats_customers
2018-04-17 15:46:30,405: 15:46:30 | 77 of 91 START table model agency_data_pipeline.agg_platforms_client. [RUN]
2018-04-17 15:46:30,405: 15:46:30 | 78 of 91 START table model agency_data_pipeline.retention_0_30_reactivated [RUN]
2018-04-17 15:46:30,405: 15:46:30 | 79 of 91 START table model agency_data_pipeline.retention_stats_rebuy_rate_month [RUN]
2018-04-17 15:46:30,415: Writing injected SQL for node "model.agency_data_pipeline.segment_stats_customers"
2018-04-17 15:46:30,415: Compiling model.agency_data_pipeline.agg_platforms_client
2018-04-17 15:46:30,416: Compiling model.agency_data_pipeline.retention_0_30_reactivated
2018-04-17 15:46:30,416: Compiling model.agency_data_pipeline.retention_stats_rebuy_rate_month
2018-04-17 15:46:30,432: Writing injected SQL for node "model.agency_data_pipeline.agg_platforms_client"
2018-04-17 15:46:30,449: Acquiring new bigquery connection "segment_stats_customers".
2018-04-17 15:46:30,456: Writing injected SQL for node "model.agency_data_pipeline.retention_stats_rebuy_rate_month"
2018-04-17 15:46:30,459: Writing injected SQL for node "model.agency_data_pipeline.retention_0_30_reactivated"
2018-04-17 15:46:30,460: Re-using an available connection from the pool.
2018-04-17 15:46:30,461: Acquiring new bigquery connection "agg_platforms_client".
2018-04-17 15:46:30,462: Acquiring new bigquery connection "retention_stats_rebuy_rate_month".
2018-04-17 15:46:30,466: Re-using an available connection from the pool.
2018-04-17 15:46:30,467: Acquiring new bigquery connection "retention_0_30_reactivated".
2018-04-17 15:46:30,468: Re-using an available connection from the pool.
2018-04-17 15:46:30,469: Re-using an available connection from the pool.
2018-04-17 15:46:31,374: Model SQL (segment_stats_customers):
SELECT
client,
date,
segment_365,
segment_mom,
segment_yoy,
count(distinct(customer_id)) customers,
avg(recency_365) recency_365,
sum(frequency_365) frequency_365,
sum(revenue_365) revenue_365,
case when sum(frequency_365) > 0 then sum(revenue_365)/sum(frequency_365) else null end as aov_365,
avg(recency_mom) recency_mom,
sum(frequency_mom) frequency_mom,
sum(revenue_mom) revenue_mom,
case when sum(frequency_mom) > 0 then sum(revenue_mom)/sum(frequency_mom) else null end as aov_mom,
avg(recency_yoy) recency_yoy,
sum(frequency_yoy) frequency_yoy,
sum(revenue_yoy) revenue_yoy,
case when sum(frequency_yoy) > 0 then sum(revenue_yoy)/sum(frequency_yoy) else null end as aov_yoy
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_stats_customers_agg`
GROUP BY client, date, segment_365, segment_mom, segment_yoy
2018-04-17 15:46:31,375: Model SQL (agg_platforms_client):
SELECT 
date, 
a.account account, 
b.client client,
a.platform platform,
a.channel channel,
url,
utm_campaign,
campaign,
cost,
impressions,
clicks,
transactions ad_platform_transactions
FROM 
  `growth-engines-pipeline`.`agency_data_pipeline`.`agg_platforms_union` a
LEFT JOIN 
  `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc` b
ON ( 
  a.account = b.account AND
  a.platform = b.platform
)
2018-04-17 15:46:31,379: Model SQL (retention_stats_rebuy_rate_month):
WITH r1 AS (
	SELECT 
	date,
	client,
	count(distinct customer_id) customers_prior_year,
	0 as customers_current_year, 
	sum(quantity) quantity_prior_year,
	0 as quantity_current_year,
	sum(revenue) revenue_prior_year,
	0 as revenue_current_year,
	case when sum(quantity) > 0 then sum(revenue)/sum(quantity) else null end as aov_prior_year,
	null as aov_current_year
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_30_60`
	group by date, client
),

r2 AS (
	SELECT 
	date,
	client,
	0 as customers_prior_year,
	count(distinct customer_id) customers_current_year, 
	0 as quantity_prior_year,
	sum(quantity) quantity_current_year,
	0 as revenue_prior_year,
	sum(revenue) revenue_current_year,
	null as aov_prior_year,
	case when sum(quantity) > 0 then sum(revenue)/sum(quantity) else null end as aov_current_year
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30_rebuy`
	group by date, client
)

SELECT 
date,
client,
sum(customers_prior_year) customers_prior_year, 
sum(customers_current_year) customers_current_year,
sum(quantity_prior_year) quantity_prior_year,
sum(quantity_current_year) quantity_current_year,
sum(revenue_prior_year) revenue_prior_year,
sum(revenue_current_year) revenue_current_year,
sum(aov_prior_year) aov_prior_year,
sum(aov_current_year) aov_current_year,
case when sum(revenue_prior_year) > 0 then sum(revenue_current_year)/sum(revenue_prior_year) else null end as revenue_retention,
case when sum(customers_prior_year) > 0 then sum(customers_current_year)/sum(customers_prior_year) else null end as customer_retention
FROM
(
	SELECT
	date,
	client,
	customers_prior_year,
	customers_current_year,
	quantity_prior_year,
	quantity_current_year,
	revenue_prior_year,
	revenue_current_year,
	aov_prior_year,
	aov_current_year
	FROM r1

	UNION ALL

	SELECT
	date,
	client,
	customers_prior_year,
	customers_current_year,
	quantity_prior_year,
	quantity_current_year,
	revenue_prior_year,
	revenue_current_year,
	aov_prior_year,
	aov_current_year
	FROM r2

) 
GROUP BY date, client
2018-04-17 15:46:31,519: Model SQL (retention_0_30_reactivated):
SELECT 
a.client,
a.date,
a.customer_id, 
a.quantity,
a.revenue
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_60_plus` b
ON (
	a.client = b.client AND
	a.date = b.date AND
	a.customer_id = b.customer_id
)
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_30_60` c
ON (
	a.client = c.client AND
	a.date = c.date AND
	a.customer_id = c.customer_id
)
WHERE b.customer_id is not null 
AND c.customer_id is null
2018-04-17 15:46:33,628: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10237f710>]}
2018-04-17 15:46:33,896: 15:46:33 | 79 of 91 OK created table model agency_data_pipeline.retention_stats_rebuy_rate_month [CREATE TABLE in 3.21s]
2018-04-17 15:46:33,896: 15:46:33 | 80 of 91 START table model agency_data_pipeline.retention_stats_rebuy_rate [RUN]
2018-04-17 15:46:33,896: Compiling model.agency_data_pipeline.retention_stats_rebuy_rate
2018-04-17 15:46:33,905: Writing injected SQL for node "model.agency_data_pipeline.retention_stats_rebuy_rate"
2018-04-17 15:46:33,906: Acquiring new bigquery connection "retention_stats_rebuy_rate".
2018-04-17 15:46:33,907: Re-using an available connection from the pool.
2018-04-17 15:46:34,668: Model SQL (retention_stats_rebuy_rate):
WITH r1 AS (
	SELECT 
	date,
	client,
	count(distinct customer_id) customers_prior_year,
	0 as customers_current_year, 
	sum(quantity) quantity_prior_year,
	0 as quantity_current_year,
	sum(revenue) revenue_prior_year,
	0 as revenue_current_year,
	case when sum(quantity) > 0 then sum(revenue)/sum(quantity) else null end as aov_prior_year,
	null as aov_current_year
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_365_730`
	group by date, client
),

r2 AS (
	SELECT 
	date,
	client,
	0 as customers_prior_year,
	count(distinct customer_id) customers_current_year, 
	0 as quantity_prior_year,
	sum(quantity) quantity_current_year,
	0 as revenue_prior_year,
	sum(revenue) revenue_current_year,
	null as aov_prior_year,
	case when sum(quantity) > 0 then sum(revenue)/sum(quantity) else null end as aov_current_year
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365_rebuy`
	group by date, client
)

SELECT 
date,
client,
sum(customers_prior_year) customers_prior_year, 
sum(customers_current_year) customers_current_year,
sum(quantity_prior_year) quantity_prior_year,
sum(quantity_current_year) quantity_current_year,
sum(revenue_prior_year) revenue_prior_year,
sum(revenue_current_year) revenue_current_year,
sum(aov_prior_year) aov_prior_year,
sum(aov_current_year) aov_current_year,
case when sum(revenue_prior_year) > 0 then sum(revenue_current_year)/sum(revenue_prior_year) else null end as revenue_retention,
case when sum(customers_prior_year) > 0 then sum(customers_current_year)/sum(customers_prior_year) else null end as customer_retention
FROM
(
	SELECT
	date,
	client,
	customers_prior_year,
	customers_current_year,
	quantity_prior_year,
	quantity_current_year,
	revenue_prior_year,
	revenue_current_year,
	aov_prior_year,
	aov_current_year
	FROM r1

	UNION ALL

	SELECT
	date,
	client,
	customers_prior_year,
	customers_current_year,
	quantity_prior_year,
	quantity_current_year,
	revenue_prior_year,
	revenue_current_year,
	aov_prior_year,
	aov_current_year
	FROM r2

) 
GROUP BY date, client
2018-04-17 15:46:34,874: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10233d5c0>]}
2018-04-17 15:46:35,127: 15:46:35 | 78 of 91 OK created table model agency_data_pipeline.retention_0_30_reactivated [CREATE TABLE in 4.46s]
2018-04-17 15:46:35,127: 15:46:35 | 81 of 91 START table model agency_data_pipeline.retention_0_30_new... [RUN]
2018-04-17 15:46:35,128: Compiling model.agency_data_pipeline.retention_0_30_new
2018-04-17 15:46:35,138: Writing injected SQL for node "model.agency_data_pipeline.retention_0_30_new"
2018-04-17 15:46:35,140: Acquiring new bigquery connection "retention_0_30_new".
2018-04-17 15:46:35,140: Re-using an available connection from the pool.
2018-04-17 15:46:35,847: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105917630>]}
2018-04-17 15:46:36,091: Model SQL (retention_0_30_new):
SELECT 
a.client,
a.date,
a.customer_id, 
a.quantity,
a.revenue,
a.order_count
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_60_plus` b
ON (
	a.client = b.client AND
	a.date = b.date AND
	a.customer_id = b.customer_id
)
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_30_60` c
ON (
	a.client = c.client AND
	a.date = c.date AND
	a.customer_id = c.customer_id
)
WHERE b.customer_id is null 
and c.customer_id is null
2018-04-17 15:46:36,095: 15:46:36 | 77 of 91 OK created table model agency_data_pipeline.agg_platforms_client [CREATE TABLE in 5.43s]
2018-04-17 15:46:36,095: 15:46:36 | 82 of 91 START table model agency_data_pipeline.retention_0_365_new.. [RUN]
2018-04-17 15:46:36,096: Compiling model.agency_data_pipeline.retention_0_365_new
2018-04-17 15:46:36,106: Writing injected SQL for node "model.agency_data_pipeline.retention_0_365_new"
2018-04-17 15:46:36,108: Acquiring new bigquery connection "retention_0_365_new".
2018-04-17 15:46:36,109: Re-using an available connection from the pool.
2018-04-17 15:46:36,897: Model SQL (retention_0_365_new):
SELECT 
a.client,
a.date,
a.customer_id, 
a.quantity,
a.revenue,
a.order_count
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_730_plus` b
ON (
	a.client = b.client AND
	a.date = b.date AND
	a.customer_id = b.customer_id
)
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_365_730` c
ON (
	a.client = c.client AND
	a.date = c.date AND
	a.customer_id = c.customer_id
)
WHERE b.customer_id is null 
and c.customer_id is null
2018-04-17 15:46:37,509: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10235b588>]}
2018-04-17 15:46:37,753: 15:46:37 | 80 of 91 OK created table model agency_data_pipeline.retention_stats_rebuy_rate [CREATE TABLE in 3.61s]
2018-04-17 15:46:37,753: 15:46:37 | 83 of 91 START table model agency_data_pipeline.retention_0_365_reactivated [RUN]
2018-04-17 15:46:37,754: Compiling model.agency_data_pipeline.retention_0_365_reactivated
2018-04-17 15:46:37,760: Writing injected SQL for node "model.agency_data_pipeline.retention_0_365_reactivated"
2018-04-17 15:46:37,761: Acquiring new bigquery connection "retention_0_365_reactivated".
2018-04-17 15:46:37,761: Re-using an available connection from the pool.
2018-04-17 15:46:38,745: Model SQL (retention_0_365_reactivated):
SELECT 
a.client,
a.date,
a.customer_id, 
a.quantity,
a.revenue
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_730_plus` b
ON (
	a.client = b.client AND
	a.date = b.date AND
	a.customer_id = b.customer_id
)
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_365_730` c
ON (
	a.client = c.client AND
	a.date = c.date AND
	a.customer_id = c.customer_id
)
WHERE b.customer_id is not null 
AND c.customer_id is null
2018-04-17 15:46:40,565: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10233d5c0>]}
2018-04-17 15:46:40,816: 15:46:40 | 81 of 91 OK created table model agency_data_pipeline.retention_0_30_new [CREATE TABLE in 5.44s]
2018-04-17 15:46:41,003: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10235b588>]}
2018-04-17 15:46:41,253: 15:46:41 | 83 of 91 OK created table model agency_data_pipeline.retention_0_365_reactivated [CREATE TABLE in 3.25s]
2018-04-17 15:46:44,717: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105917630>]}
2018-04-17 15:46:44,922: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1022d5b70>]}
2018-04-17 15:46:44,956: 15:46:44 | 82 of 91 OK created table model agency_data_pipeline.retention_0_365_new [CREATE TABLE in 8.62s]
2018-04-17 15:46:45,212: 15:46:45 | 76 of 91 OK created table model agency_data_pipeline.segment_stats_customers [CREATE TABLE in 14.52s]
2018-04-17 15:46:45,213: 15:46:45 | 84 of 91 START table model agency_data_pipeline.segment_list_customers [RUN]
2018-04-17 15:46:45,213: Compiling model.agency_data_pipeline.segment_list_customers
2018-04-17 15:46:45,221: Writing injected SQL for node "model.agency_data_pipeline.segment_list_customers"
2018-04-17 15:46:45,221: Acquiring new bigquery connection "segment_list_customers".
2018-04-17 15:46:45,222: Re-using an available connection from the pool.
2018-04-17 15:46:46,278: Model SQL (segment_list_customers):
SELECT
a.client,
period,
date,
customer_id,
b.first_name,
b.last_name,
b.email,
recency_days,
frequency,
revenue,
quantity,
aov,
segment
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`agg_customers_union` b
ON (
	a.client = b.client AND
	a.customer_id = b.id
)
2018-04-17 15:47:26,520: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x102310438>]}
2018-04-17 15:47:27,215: 15:47:27 | 84 of 91 OK created table model agency_data_pipeline.segment_list_customers [CREATE TABLE in 41.31s]
2018-04-17 15:47:27,218: 15:47:27 | 85 of 91 START table model agency_data_pipeline.growth_customer_0_365_segment [RUN]
2018-04-17 15:47:27,219: Compiling model.agency_data_pipeline.growth_customer_0_365_segment
2018-04-17 15:47:27,226: Writing injected SQL for node "model.agency_data_pipeline.growth_customer_0_365_segment"
2018-04-17 15:47:27,228: Acquiring new bigquery connection "growth_customer_0_365_segment".
2018-04-17 15:47:27,228: Re-using an available connection from the pool.
2018-04-17 15:47:28,208: Model SQL (growth_customer_0_365_segment):
with segment as (

	SELECT 
	a.date,
	unix_date_in_range,
	unix_date_in_range_yoy,
	a.client client,
	a.customer_id customer_id,
	case when b.customer_id is not null then 'New' else 'Existing' end as segment,
	a.orders,
	a.quantity,
	a.revenue,
	a.shipping_revenue
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_customer_0_365` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365_new` b
	ON (
	  a.customer_id = b.customer_id AND
	  a.date  = b.date AND
	  a.client = b.client
	)
),

total as (

	SELECT 
	date,
	unix_date_in_range,
	unix_date_in_range_yoy,
	client,
	customer_id,
	'Total' as segment,
	orders,
	quantity,
	revenue,
	shipping_revenue
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_customer_0_365`

)

SELECT 
date,
unix_date_in_range,
unix_date_in_range_yoy,
client,
segment,
count(distinct(customer_id)) customers,
sum(orders) orders,
sum(quantity) quantity,
sum(revenue) revenue,
sum(shipping_revenue) shipping_revenue
FROM
( 
	SELECT * FROM segment
	UNION ALL
	SELECT * FROM total
) 
GROUP BY date, unix_date_in_range, unix_date_in_range_yoy, client, segment
2018-04-17 15:47:39,395: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1022d5b70>]}
2018-04-17 15:47:39,910: 15:47:39 | 85 of 91 OK created table model agency_data_pipeline.growth_customer_0_365_segment [CREATE TABLE in 12.18s]
2018-04-17 15:47:39,911: 15:47:39 | 86 of 91 START table model agency_data_pipeline.growth_date_union.... [RUN]
2018-04-17 15:47:39,912: Compiling model.agency_data_pipeline.growth_date_union
2018-04-17 15:47:39,921: Writing injected SQL for node "model.agency_data_pipeline.growth_date_union"
2018-04-17 15:47:39,925: Acquiring new bigquery connection "growth_date_union".
2018-04-17 15:47:39,925: Re-using an available connection from the pool.
2018-04-17 15:47:40,848: Model SQL (growth_date_union):
with ty as (

  SELECT 
  date,
  unix_date_in_range, 
  unix_date_in_range_yoy, 
  client, 
  segment,
  customers customers_ty,
  orders orders_ty,
  quantity quantity_ty,
  revenue revenue_ty,
  shipping_revenue shipping_revenue_ty,
  null as customers_ly,
  null as orders_ly,
  null as quantity_ly,
  null as revenue_ly,
  null as shipping_revenue_ly
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_customer_0_365_segment`

),

ly as (

  SELECT 
  date,
  0 as unix_date_in_range, 
  unix_date_in_range unix_date_in_range_yoy, 
  client, 
  segment,
  null as customers_ty,
  null as orders_ty,
  null as quantity_ty,
  null as revenue_ty,
  null as shipping_revenue_ty,
  customers customers_ly,
  orders orders_ly,
  quantity quantity_ly,
  revenue revenue_ly,
  shipping_revenue shipping_revenue_ly
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_customer_0_365_segment`

)


SELECT
max(date) date,
max(unix_date_in_range) unix_date_in_range,
unix_date_in_range_yoy,
client,
segment,
ifnull(sum(customers_ty), 0) customers_ty,
ifnull(sum(orders_ty), 0) orders_ty,
ifnull(sum(quantity_ty), 0) quantity_ty,
ifnull(sum(revenue_ty), 0) revenue_ty,
ifnull(sum(shipping_revenue_ty), 0) shipping_revenue_ty,
case when sum(orders_ty) > 0 then sum(revenue_ty)/sum(orders_ty) else null end as aov_ty,
ifnull(sum(customers_ly), 0) customers_ly,
ifnull(sum(orders_ly), 0) orders_ly,
ifnull(sum(quantity_ly), 0) quantity_ly,
ifnull(sum(revenue_ly), 0) revenue_ly,
ifnull(sum(shipping_revenue_ly), 0) shipping_revenue_ly,
case when sum(orders_ly) > 0 then sum(revenue_ly)/sum(orders_ly) else null end as aov_ly,
case when sum(orders_ly) > 0 then ( sum(orders_ty) - sum(orders_ly) ) / sum(orders_ly) else null end as order_growth,
case when sum(revenue_ly) > 0 then ( sum(revenue_ty) - sum(revenue_ly) ) / sum(revenue_ly) else null end as revenue_growth,
case when sum(customers_ly) > 0 then ( sum(customers_ty) - sum(customers_ly) ) / sum(customers_ly) else null end as customer_growth,
case when sum(orders_ly) > 0 then ( sum(revenue_ty)/sum(orders_ty) - sum(revenue_ly)/sum(orders_ly) ) / ( sum(revenue_ly)/sum(orders_ly) ) else null end as aov_growth
FROM (

  SELECT * FROM ty
  UNION ALL
  SELECT * FROM ly

)
where unix_date_in_range is not null
group by unix_date_in_range_yoy, client, segment
2018-04-17 15:47:42,002: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10235b438>]}
2018-04-17 15:47:42,262: 15:47:42 | 86 of 91 OK created table model agency_data_pipeline.growth_date_union [CREATE TABLE in 2.09s]
2018-04-17 15:47:42,263: 15:47:42 | 87 of 91 START table model agency_data_pipeline.growth_stats......... [RUN]
2018-04-17 15:47:42,263: 15:47:42 | 88 of 91 START table model agency_data_pipeline.retention_stats_month [RUN]
2018-04-17 15:47:42,263: Compiling model.agency_data_pipeline.growth_stats
2018-04-17 15:47:42,263: 15:47:42 | 89 of 91 START table model agency_data_pipeline.retention_stats...... [RUN]
2018-04-17 15:47:42,264: Compiling model.agency_data_pipeline.retention_stats_month
2018-04-17 15:47:42,271: Compiling model.agency_data_pipeline.retention_stats
2018-04-17 15:47:42,279: Writing injected SQL for node "model.agency_data_pipeline.growth_stats"
2018-04-17 15:47:42,291: Writing injected SQL for node "model.agency_data_pipeline.retention_stats_month"
2018-04-17 15:47:42,304: Writing injected SQL for node "model.agency_data_pipeline.retention_stats"
2018-04-17 15:47:42,307: Acquiring new bigquery connection "growth_stats".
2018-04-17 15:47:42,307: Acquiring new bigquery connection "retention_stats_month".
2018-04-17 15:47:42,308: Re-using an available connection from the pool.
2018-04-17 15:47:42,308: Re-using an available connection from the pool.
2018-04-17 15:47:42,309: Acquiring new bigquery connection "retention_stats".
2018-04-17 15:47:42,311: Re-using an available connection from the pool.
2018-04-17 15:47:43,360: Model SQL (retention_stats):
WITH last_year_buyers AS (
	SELECT 
	date,
	client,
	'Last year buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_365_730`
	group by date, client
),

rebuy_rate AS (
	SELECT 
	date,
	client,
	'Rebuy rate' as metric,
	customer_retention value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_stats_rebuy_rate`
),

repeat_buyers AS (
	SELECT 
	date,
	client,
	'Repeat buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365_rebuy`
	group by date, client
),

reactivated_buyers AS (
	SELECT 
	date,
	client,
	'Reactivated buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365_reactivated`
	group by date, client
),

new_buyers AS (
	SELECT 
	date,
	client,
	'New buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365_new`
	group by date, client
),

this_year_buyers AS (
	SELECT 
	date,
	client,
	'This year buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365`
	group by date, client
),

this_year_revenue AS (
	SELECT 
	date,
	client,
	'This year revenue' as metric,
	sum(revenue) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365`
	group by date, client
),

this_year_aov AS (
	SELECT 
	date,
	client,
	'This year AOV' as metric,
	case when sum(order_count) > 0 then sum(revenue)/sum(order_count) else 0 end as value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365`
	group by date, client
),

this_year_frequency AS (
	SELECT 
	date,
	client,
	'This year frequency' as metric,
	case when count(distinct customer_id) > 0 then sum(order_count)/count(distinct customer_id) else 0 end as value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365`
	group by date, client
)

SELECT 
date,
client,
metric,
ifnull(value, 0) value
FROM
(
	SELECT
	date,
	client,
	metric,
	value
	FROM last_year_buyers

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM rebuy_rate

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM repeat_buyers

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM reactivated_buyers	

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM new_buyers	

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_year_buyers	

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_year_revenue

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_year_aov

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_year_frequency

	UNION ALL

	SELECT
	a.date,
	a.client,
	'Dormant buyers' as metric,
	a.value - ifnull(b.value, 0) as value
	FROM last_year_buyers a
	LEFT JOIN repeat_buyers b
	ON ( a.date = b.date AND
		a.client = b.client )							

)
2018-04-17 15:47:43,432: Model SQL (retention_stats_month):
WITH last_month_buyers AS (
	SELECT 
	date,
	client,
	'Last month buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_30_60`
	group by date, client
),

rebuy_rate AS (
	SELECT 
	date,
	client,
	'Rebuy rate' as metric,
	customer_retention value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_stats_rebuy_rate_month`
),

repeat_buyers AS (
	SELECT 
	date,
	client,
	'Repeat buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30_rebuy`
	group by date, client
),

reactivated_buyers AS (
	SELECT 
	date,
	client,
	'Reactivated buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30_reactivated`
	group by date, client
),

new_buyers AS (
	SELECT 
	date,
	client,
	'New buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30_new`
	group by date, client
),

this_month_buyers AS (
	SELECT 
	date,
	client,
	'This month buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30`
	group by date, client
),

this_month_revenue AS (
	SELECT 
	date,
	client,
	'This month revenue' as metric,
	sum(revenue) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30`
	group by date, client
),

this_month_aov AS (
	SELECT 
	date,
	client,
	'This month AOV' as metric,
	case when sum(order_count) > 0 then sum(revenue)/sum(order_count) else 0 end as value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30`
	group by date, client
),

this_month_frequency AS (
	SELECT 
	date,
	client,
	'This month frequency' as metric,
	case when count(distinct customer_id) > 0 then sum(order_count)/count(distinct customer_id) else 0 end as value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30`
	group by date, client
)

SELECT 
date,
client,
metric,
ifnull(value, 0) value
FROM
(
	SELECT
	date,
	client,
	metric,
	value
	FROM last_month_buyers

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM rebuy_rate

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM repeat_buyers

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM reactivated_buyers	

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM new_buyers	

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_month_buyers	

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_month_revenue

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_month_aov

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_month_frequency

	UNION ALL

	SELECT
	a.date,
	a.client,
	'Dormant buyers' as metric,
	a.value - ifnull(b.value, 0) as value
	FROM last_month_buyers a
	LEFT JOIN repeat_buyers b
	ON ( a.date = b.date AND
		a.client = b.client )							

)
2018-04-17 15:47:43,482: Model SQL (growth_stats):
with orders as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'Orders' as metric,
  orders_ty as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`
),

order_growth as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'Order Growth' as metric,
  order_growth as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`
),

revenue as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'Revenue' as metric,
  revenue_ty as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`
),

revenue_growth as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'Revenue Growth' as metric,
  revenue_growth as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`
),

customers as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'Customers' as metric,
  customers_ty as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`
),

customer_growth as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'Customer Growth' as metric,
  customer_growth as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`

),

aov as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'AOV' as metric,
  aov_ty as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`

),

aov_growth as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'AOV Growth' as metric,
  aov_growth as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`

)

SELECT * FROM orders
UNION ALL 
SELECT * FROM order_growth
UNION ALL
SELECT * FROM revenue
UNION ALL 
SELECT * FROM revenue_growth
UNION ALL
SELECT * FROM customers
UNION ALL 
SELECT * FROM customer_growth
UNION ALL
SELECT * FROM aov
UNION ALL 
SELECT * FROM aov_growth
2018-04-17 15:47:44,624: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1022d5b70>]}
2018-04-17 15:47:44,879: 15:47:44 | 87 of 91 OK created table model agency_data_pipeline.growth_stats.... [CREATE TABLE in 2.36s]
2018-04-17 15:47:45,680: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x102368a58>]}
2018-04-17 15:47:45,930: 15:47:45 | 88 of 91 OK created table model agency_data_pipeline.retention_stats_month [CREATE TABLE in 3.42s]
2018-04-17 15:47:50,062: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105917e80>]}
2018-04-17 15:47:50,338: 15:47:50 | 89 of 91 OK created table model agency_data_pipeline.retention_stats. [CREATE TABLE in 7.79s]
2018-04-17 15:47:50,338: 15:47:50 | 90 of 91 START table model agency_data_pipeline.agg_campaign......... [RUN]
2018-04-17 15:47:50,339: Compiling model.agency_data_pipeline.agg_campaign
2018-04-17 15:47:50,350: Writing injected SQL for node "model.agency_data_pipeline.agg_campaign"
2018-04-17 15:47:50,353: Acquiring new bigquery connection "agg_campaign".
2018-04-17 15:47:50,353: Re-using an available connection from the pool.
2018-04-17 15:47:51,254: Model SQL (agg_campaign):
with ga as (

	select 
		date, client, attribution, channel, platform, url, campaign as utm_campaign, '' as campaign,
    	customers_new,
    	transactions_new,
    	revenue_new,
    	first_order_revenue_new,
    	lifetime_revenue_new,
    	customers_total,
    	transactions_total,
    	revenue_total,
		null as cost, null as impressions, null as clicks, null as ad_platform_transactions
	from `growth-engines-pipeline`.`agency_data_pipeline`.`agg_ga_campaign_by_type`

),

platforms_last_touch as (

	select 
		date, client, 'Last-touch' as attribution, channel, platform, url, utm_campaign, campaign,
		null as customers_new,
    	null as transactions_new,
    	null as revenue_new,
    	null as first_order_revenue_new,
    	null as lifetime_revenue_new,
    	null as customers_total,
    	null as transactions_total,
    	null as revenue_total,
		cost, impressions, clicks, ad_platform_transactions
	from `growth-engines-pipeline`.`agency_data_pipeline`.`agg_platforms_client`

),

platforms_first_touch as (

    select 
        date, client, 'First-touch' as attribution, channel, platform, url, utm_campaign, campaign,
        null as customers_new,
        null as transactions_new,
        null as revenue_new,
        null as first_order_revenue_new,
        null as lifetime_revenue_new,
        null as customers_total,
        null as transactions_total,
        null as revenue_total,
        cost, impressions, clicks, ad_platform_transactions
    from `growth-engines-pipeline`.`agency_data_pipeline`.`agg_platforms_client`

)


SELECT
    date, 
    client,
    attribution,
    platform,
    channel, 
    url,
    utm_campaign,
    max(campaign) campaign,
    ifnull( sum(cost), 0) cost,
	ifnull( sum(impressions), 0) impressions,
	ifnull( sum(clicks), 0) clicks,
	ifnull( sum(ad_platform_transactions), 0) ad_platform_transactions,
	ifnull( sum(customers_new), 0) customers_new,
	ifnull( sum(transactions_new), 0) transactions_new,
	ifnull( sum(revenue_new), 0) revenue_new,
	ifnull( sum(first_order_revenue_new), 0) first_order_revenue_new,
	ifnull( sum(lifetime_revenue_new), 0) lifetime_revenue_new,
	ifnull( sum(customers_total), 0) customers_total,
	ifnull( sum(transactions_total), 0) transactions_total,
	ifnull( sum(revenue_total), 0) revenue_total	
FROM 
(
    SELECT *
    FROM 
      ga
    UNION ALL
    SELECT *
    FROM 
      platforms_first_touch
    UNION ALL
    SELECT *
    FROM 
      platforms_last_touch      
) 
GROUP BY
    date, client, attribution, platform, channel, url, utm_campaign
2018-04-17 15:48:00,145: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10235b400>]}
2018-04-17 15:48:00,507: 15:48:00 | 90 of 91 OK created table model agency_data_pipeline.agg_campaign.... [CREATE TABLE in 9.81s]
2018-04-17 15:48:00,508: 15:48:00 | 91 of 91 START table model agency_data_pipeline.agg_platform_monthly. [RUN]
2018-04-17 15:48:00,508: Compiling model.agency_data_pipeline.agg_platform_monthly
2018-04-17 15:48:00,517: Writing injected SQL for node "model.agency_data_pipeline.agg_platform_monthly"
2018-04-17 15:48:00,519: Acquiring new bigquery connection "agg_platform_monthly".
2018-04-17 15:48:00,519: Re-using an available connection from the pool.
2018-04-17 15:48:01,544: Model SQL (agg_platform_monthly):
SELECT
    FORMAT_DATE("%Y-%m", date) AS yyyymm,
    client,
    attribution,
    platform,
    channel, 
    sum(cost) cost,
	sum(clicks) clicks,
	sum(customers_new) customers_new,
	sum(first_order_revenue_new) first_order_revenue_new,
	sum(lifetime_revenue_new) lifetime_revenue_new,
	sum(transactions_new) transactions_new,
	sum(revenue_new) revenue_new,
    sum(customers_total) customers_total,
    sum(transactions_total) transactions_total,
    sum(revenue_total) revenue_total
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_campaign`
GROUP BY
    yyyymm, client, attribution, platform, channel
2018-04-17 15:48:03,789: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '2194bc3b-e561-4aff-b962-54239eac6c6b', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1022e9d30>]}
2018-04-17 15:48:04,106: 15:48:04 | 91 of 91 OK created table model agency_data_pipeline.agg_platform_monthly [CREATE TABLE in 3.28s]
2018-04-17 15:48:04,141: 15:48:04 | 
2018-04-17 15:48:04,142: 15:48:04 | Finished running 91 table models in 451.77s.
2018-04-17 15:48:04,142: Connection 'master' was left open.
2018-04-17 15:48:04,143: 
2018-04-17 15:48:04,144: Completed successfully
2018-04-17 15:48:04,144: 
Done. PASS=91 ERROR=0 SKIP=0 TOTAL=91
2018-04-17 15:48:04,145: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10574dc18>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10581ba20>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10581bc50>]}
2018-04-17 15:48:04,459: Flushing usage events
2018-04-17 15:55:57,574: Tracking: tracking
2018-04-17 15:55:57,577: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b246f60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b246e80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b246dd8>]}
2018-04-17 15:55:58,397: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-04-17 15:55:58,432: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/growth-engines/dbt_modules
2018-04-17 15:55:58,438: Parsing get_column_values.sql
2018-04-17 15:55:58,456: Parsing get_url_parameter.sql
2018-04-17 15:55:58,462: Parsing split_part.sql
2018-04-17 15:55:58,471: Parsing table_exists.sql
2018-04-17 15:55:58,481: Parsing core.sql
2018-04-17 15:55:58,497: Parsing adapters/bigquery.sql
2018-04-17 15:55:58,508: Parsing adapters/common.sql
2018-04-17 15:55:58,530: Parsing adapters/postgres.sql
2018-04-17 15:55:58,538: Parsing adapters/redshift.sql
2018-04-17 15:55:58,568: Parsing etc/get_custom_schema.sql
2018-04-17 15:55:58,578: Parsing materializations/archive.sql
2018-04-17 15:55:58,615: Parsing materializations/bigquery.sql
2018-04-17 15:55:58,643: Parsing materializations/helpers.sql
2018-04-17 15:55:58,668: Parsing materializations/incremental.sql
2018-04-17 15:55:58,699: Parsing materializations/table.sql
2018-04-17 15:55:58,729: Parsing materializations/view.sql
2018-04-17 15:55:58,749: Parsing materializations/wrapper.sql
2018-04-17 15:55:58,759: Parsing schema_tests/accepted_values.sql
2018-04-17 15:55:58,767: Parsing schema_tests/not_null.sql
2018-04-17 15:55:58,773: Parsing schema_tests/relationships.sql
2018-04-17 15:55:58,780: Parsing schema_tests/unique.sql
2018-04-17 15:55:58,857: Parsing model.agency_data_pipeline.accounts_proc
2018-04-17 15:55:58,859: Parsing model.agency_data_pipeline.all_dates
2018-04-17 15:55:58,860: Parsing model.agency_data_pipeline.carts_proc
2018-04-17 15:55:58,861: Parsing model.agency_data_pipeline.clients_proc
2018-04-17 15:55:58,864: Parsing model.agency_data_pipeline.conversion_goals_proc
2018-04-17 15:55:58,865: Parsing model.agency_data_pipeline.mappings_ga_proc
2018-04-17 15:55:58,867: Acquiring new bigquery connection "master".
2018-04-17 15:55:58,867: Opening a new connection (0 currently allocated)
2018-04-17 15:55:58,874: Parsing model.agency_data_pipeline.monthend_dates
2018-04-17 15:55:58,877: Parsing model.agency_data_pipeline.adwords_ads
2018-04-17 15:55:58,881: Parsing model.agency_data_pipeline.adwords_campaigns
2018-04-17 15:55:58,883: Parsing model.agency_data_pipeline.adwords_conversions
2018-04-17 15:55:58,886: Parsing model.agency_data_pipeline.adwords_impression_share
2018-04-17 15:55:58,888: Parsing model.agency_data_pipeline.adwords_join
2018-04-17 15:55:58,890: Parsing model.agency_data_pipeline.adwords_stats
2018-04-17 15:55:58,891: Parsing model.agency_data_pipeline.adwords_urls
2018-04-17 15:55:58,893: Parsing model.agency_data_pipeline.bing_ads_ads
2018-04-17 15:55:58,896: Parsing model.agency_data_pipeline.bing_ads_conversions
2018-04-17 15:55:58,898: Parsing model.agency_data_pipeline.bing_ads_impression_share
2018-04-17 15:55:58,899: Parsing model.agency_data_pipeline.bing_ads_stats
2018-04-17 15:55:58,901: Parsing model.agency_data_pipeline.fb_adcreative
2018-04-17 15:55:58,907: Parsing model.agency_data_pipeline.fb_ads
2018-04-17 15:55:58,912: Parsing model.agency_data_pipeline.fb_ads_insights
2018-04-17 15:55:58,917: Parsing model.agency_data_pipeline.fb_ads_insights_conversions
2018-04-17 15:55:58,923: Parsing model.agency_data_pipeline.fb_ads_stats
2018-04-17 15:55:58,928: Parsing model.agency_data_pipeline.ga_conversions
2018-04-17 15:55:58,931: Parsing model.agency_data_pipeline.ga_traffic
2018-04-17 15:55:58,946: Parsing model.agency_data_pipeline.ga_transactions
2018-04-17 15:55:58,957: Parsing model.agency_data_pipeline.ga_mcf_proc
2018-04-17 15:55:58,959: Parsing model.agency_data_pipeline.ga_mcf_stats
2018-04-17 15:55:58,961: Parsing model.agency_data_pipeline.shopify_customers_proc
2018-04-17 15:55:58,967: Parsing model.agency_data_pipeline.shopify_orders_proc
2018-04-17 15:55:58,975: Parsing model.agency_data_pipeline.shopify_products_proc
2018-04-17 15:55:58,981: Parsing model.agency_data_pipeline.shopify_refunds_proc
2018-04-17 15:55:58,987: Parsing model.agency_data_pipeline.agg_campaign
2018-04-17 15:55:58,991: Parsing model.agency_data_pipeline.agg_customers_union
2018-04-17 15:55:58,992: Parsing model.agency_data_pipeline.agg_ga_campaign
2018-04-17 15:55:58,995: Parsing model.agency_data_pipeline.agg_ga_campaign_by_type
2018-04-17 15:55:58,997: Parsing model.agency_data_pipeline.agg_ga_transaction
2018-04-17 15:55:59,000: Parsing model.agency_data_pipeline.agg_ga_transaction_order_number
2018-04-17 15:55:59,003: Parsing model.agency_data_pipeline.agg_orders_union
2018-04-17 15:55:59,007: Parsing model.agency_data_pipeline.agg_platform_monthly
2018-04-17 15:55:59,011: Parsing model.agency_data_pipeline.agg_platforms_client
2018-04-17 15:55:59,014: Parsing model.agency_data_pipeline.agg_platforms_union
2018-04-17 15:55:59,017: Parsing model.agency_data_pipeline.agg_products
2018-04-17 15:55:59,018: Parsing model.agency_data_pipeline.agg_transaction
2018-04-17 15:55:59,021: Parsing model.agency_data_pipeline.agg_transaction_daily
2018-04-17 15:55:59,023: Parsing model.agency_data_pipeline.agg_transaction_line_item
2018-04-17 15:55:59,024: Parsing model.agency_data_pipeline.agg_transaction_line_item_type
2018-04-17 15:55:59,026: Parsing model.agency_data_pipeline.agg_transaction_order_number
2018-04-17 15:55:59,029: Parsing model.agency_data_pipeline.agg_transaction_product_type
2018-04-17 15:55:59,031: Parsing model.agency_data_pipeline.customers_by_transaction
2018-04-17 15:55:59,034: Parsing model.agency_data_pipeline.growth_customer_0_365
2018-04-17 15:55:59,036: Parsing model.agency_data_pipeline.growth_customer_0_365_segment
2018-04-17 15:55:59,038: Parsing model.agency_data_pipeline.growth_date_union
2018-04-17 15:55:59,041: Parsing model.agency_data_pipeline.growth_stats
2018-04-17 15:55:59,045: Parsing model.agency_data_pipeline.retention_0_365
2018-04-17 15:55:59,047: Parsing model.agency_data_pipeline.retention_0_365_new
2018-04-17 15:55:59,050: Parsing model.agency_data_pipeline.retention_0_365_reactivated
2018-04-17 15:55:59,053: Parsing model.agency_data_pipeline.retention_0_365_rebuy
2018-04-17 15:55:59,055: Parsing model.agency_data_pipeline.retention_365_730
2018-04-17 15:55:59,057: Parsing model.agency_data_pipeline.retention_730_plus
2018-04-17 15:55:59,059: Parsing model.agency_data_pipeline.retention_stats
2018-04-17 15:55:59,064: Parsing model.agency_data_pipeline.retention_stats_rebuy_rate
2018-04-17 15:55:59,066: Parsing model.agency_data_pipeline.retention_0_30
2018-04-17 15:55:59,068: Parsing model.agency_data_pipeline.retention_0_30_new
2018-04-17 15:55:59,072: Parsing model.agency_data_pipeline.retention_0_30_reactivated
2018-04-17 15:55:59,075: Parsing model.agency_data_pipeline.retention_0_30_rebuy
2018-04-17 15:55:59,077: Parsing model.agency_data_pipeline.retention_30_60
2018-04-17 15:55:59,081: Parsing model.agency_data_pipeline.retention_60_plus
2018-04-17 15:55:59,083: Parsing model.agency_data_pipeline.retention_stats_month
2018-04-17 15:55:59,089: Parsing model.agency_data_pipeline.retention_stats_rebuy_rate_month
2018-04-17 15:55:59,091: Parsing model.agency_data_pipeline.customers_first_purchase_proc
2018-04-17 15:55:59,093: Parsing model.agency_data_pipeline.customers_proc
2018-04-17 15:55:59,095: Parsing model.agency_data_pipeline.segment_list_customers
2018-04-17 15:55:59,097: Parsing model.agency_data_pipeline.segment_proc_customers
2018-04-17 15:55:59,100: Parsing model.agency_data_pipeline.segment_stats_customers
2018-04-17 15:55:59,102: Parsing model.agency_data_pipeline.segment_stats_customers_agg
2018-04-17 15:55:59,105: Parsing model.agency_data_pipeline.customers_first_purchase_product_type_proc
2018-04-17 15:55:59,106: Parsing model.agency_data_pipeline.customers_products_proc
2018-04-17 15:55:59,109: Parsing model.agency_data_pipeline.segment_list_customers_products
2018-04-17 15:55:59,111: Parsing model.agency_data_pipeline.segment_proc_customers_products
2018-04-17 15:55:59,113: Parsing model.agency_data_pipeline.segment_stats_customers_products
2018-04-17 15:55:59,116: Parsing model.agency_data_pipeline.segment_stats_customers_products_agg
2018-04-17 15:55:59,118: Parsing model.agency_data_pipeline.frequency_proc
2018-04-17 15:55:59,122: Parsing model.agency_data_pipeline.frequency_stats
2018-04-17 15:55:59,125: Parsing model.agency_data_pipeline.order_paths_agg
2018-04-17 15:55:59,129: Parsing model.agency_data_pipeline.order_paths_proc
2018-04-17 15:55:59,132: Parsing model.agency_data_pipeline.order_paths_stats
2018-04-17 15:55:59,134: Parsing model.agency_data_pipeline.products_proc
2018-04-17 15:55:59,138: Parsing model.agency_data_pipeline.segment_proc_sku
2018-04-17 15:55:59,142: Parsing model.agency_data_pipeline.segment_stats_category
2018-04-17 15:55:59,145: Parsing model.agency_data_pipeline.segment_stats_sku
2018-04-17 15:55:59,174: Found 91 models, 0 tests, 0 archives, 0 analyses, 46 macros, 0 operations
2018-04-17 15:55:59,257: 
2018-04-17 15:56:00,952: 15:56:00 | Concurrency: 4 threads (target='prod')
2018-04-17 15:56:00,952: 15:56:00 | 
2018-04-17 15:56:01,923: 15:56:01 | 1 of 91 START table model agency_data_pipeline.conversion_goals_proc. [RUN]
2018-04-17 15:56:01,924: Compiling model.agency_data_pipeline.conversion_goals_proc
2018-04-17 15:56:01,928: Writing injected SQL for node "model.agency_data_pipeline.conversion_goals_proc"
2018-04-17 15:56:01,923: 15:56:01 | 2 of 91 START table model agency_data_pipeline.bing_ads_ads.......... [RUN]
2018-04-17 15:56:01,923: 15:56:01 | 3 of 91 START table model agency_data_pipeline.adwords_conversions... [RUN]
2018-04-17 15:56:01,928: Compiling model.agency_data_pipeline.bing_ads_ads
2018-04-17 15:56:01,929: Acquiring new bigquery connection "conversion_goals_proc".
2018-04-17 15:56:01,929: Compiling model.agency_data_pipeline.adwords_conversions
2018-04-17 15:56:01,923: 15:56:01 | 4 of 91 START table model agency_data_pipeline.accounts_proc......... [RUN]
2018-04-17 15:56:01,935: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_ads"
2018-04-17 15:56:01,935: Opening a new connection (1 currently allocated)
2018-04-17 15:56:01,941: Writing injected SQL for node "model.agency_data_pipeline.adwords_conversions"
2018-04-17 15:56:01,941: Compiling model.agency_data_pipeline.accounts_proc
2018-04-17 15:56:01,951: Writing injected SQL for node "model.agency_data_pipeline.accounts_proc"
2018-04-17 15:56:01,952: Acquiring new bigquery connection "adwords_conversions".
2018-04-17 15:56:01,954: Opening a new connection (2 currently allocated)
2018-04-17 15:56:01,955: Acquiring new bigquery connection "accounts_proc".
2018-04-17 15:56:01,955: Acquiring new bigquery connection "bing_ads_ads".
2018-04-17 15:56:02,015: Opening a new connection (3 currently allocated)
2018-04-17 15:56:02,071: Opening a new connection (4 currently allocated)
2018-04-17 15:56:04,035: Model SQL (bing_ads_ads):
select
date, 
account, 
channel,
platform,
campaignid,
campaignname,
max(lower(trim(replace(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$','' ),'.html',''),'/'))) as url,
utm_campaign,
sum(cost) as cost,
sum(impressions) as impressions,
sum(clicks) as clicks,
sum(conversions) as conversions
from 
  ( 
SELECT  
cast(gregoriandate as date) date,
replace(accountname,',','') account,
'Paid' as channel,
'Bing Ads' as platform,
adid,
adtype,
campaignid, 
campaignname,
finalurl url,
case when regexp_contains(destinationurl, 'utm_campaign')
	then replace(lower(nullif(
  

    split(
        
  

    split(
        destinationurl,
        'utm_campaign='
        )[offset(1)]


,
        '&'
        )[offset(0)]


,'')),'+',' ') 
	else null end as utm_campaign,
spend cost, 
impressions, 
clicks, 
conversions,
_sdc_sequence,
first_value(_sdc_sequence) OVER (PARTITION BY adid, gregoriandate ORDER BY _sdc_sequence DESC) lv
FROM `growth-engines-pipeline.bing_ads.ad_performance_report` 
  )

where lv = _sdc_sequence
group by date, account, channel, platform, campaignid, campaignname, utm_campaign
2018-04-17 15:56:04,050: Model SQL (conversion_goals_proc):
select 
client,
platform,
goal_name,
max(goal_type) goal_type,
account,
max(time_of_entry) time_of_entry
from  ( 

SELECT  
client,
platform,
trim(replace(replace(lower(goal_name),',',''),' ','')) goal_name,
goal_type,
account,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY platform ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.conversion_goals` 

) 

WHERE lv = time_of_entry
group by client, platform, account, goal_name
2018-04-17 15:56:04,135: Model SQL (adwords_conversions):
select 
client,
client_name,
platform,
goal_name,
goal_type,
account,
time_of_entry
from  ( 

SELECT  
client,
client_name,
platform,
trim(lower(goal_name)) goal_name,
goal_type,
account,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform, goal_name ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.conversion_goals` 
WHERE platform = 'Adwords'

) 

WHERE lv = time_of_entry
2018-04-17 15:56:04,135: Model SQL (accounts_proc):
select 
client,
account,
platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.accounts` 

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-04-17 15:56:05,337: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b4eda20>]}
2018-04-17 15:56:05,339: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b501a58>]}
2018-04-17 15:56:06,698: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b529d30>]}
2018-04-17 15:56:06,699: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b4eda58>]}
2018-04-17 15:56:13,078: 15:56:13 | 1 of 91 OK created table model agency_data_pipeline.conversion_goals_proc [CREATE TABLE in 3.41s]
2018-04-17 15:56:13,079: 15:56:13 | 5 of 91 START table model agency_data_pipeline.adwords_campaigns..... [RUN]
2018-04-17 15:56:13,080: Compiling model.agency_data_pipeline.adwords_campaigns
2018-04-17 15:56:13,090: Writing injected SQL for node "model.agency_data_pipeline.adwords_campaigns"
2018-04-17 15:56:13,094: Acquiring new bigquery connection "adwords_campaigns".
2018-04-17 15:56:13,094: Re-using an available connection from the pool.
2018-04-17 15:56:13,729: 15:56:13 | 3 of 91 OK created table model agency_data_pipeline.adwords_conversions [CREATE TABLE in 3.41s]
2018-04-17 15:56:13,734: 15:56:13 | 6 of 91 START table model agency_data_pipeline.monthend_dates........ [RUN]
2018-04-17 15:56:13,736: Compiling model.agency_data_pipeline.monthend_dates
2018-04-17 15:56:13,744: Writing injected SQL for node "model.agency_data_pipeline.monthend_dates"
2018-04-17 15:56:13,746: Acquiring new bigquery connection "monthend_dates".
2018-04-17 15:56:13,746: Re-using an available connection from the pool.
2018-04-17 15:56:14,072: 15:56:14 | 4 of 91 OK created table model agency_data_pipeline.accounts_proc.... [CREATE TABLE in 4.76s]
2018-04-17 15:56:14,074: 15:56:14 | 7 of 91 START table model agency_data_pipeline.carts_proc............ [RUN]
2018-04-17 15:56:14,074: Compiling model.agency_data_pipeline.carts_proc
2018-04-17 15:56:14,082: Writing injected SQL for node "model.agency_data_pipeline.carts_proc"
2018-04-17 15:56:14,085: Acquiring new bigquery connection "carts_proc".
2018-04-17 15:56:14,086: Re-using an available connection from the pool.
2018-04-17 15:56:14,327: 15:56:14 | 2 of 91 OK created table model agency_data_pipeline.bing_ads_ads..... [CREATE TABLE in 4.77s]
2018-04-17 15:56:14,327: 15:56:14 | 8 of 91 START table model agency_data_pipeline.adwords_urls.......... [RUN]
2018-04-17 15:56:14,328: Compiling model.agency_data_pipeline.adwords_urls
2018-04-17 15:56:14,337: Writing injected SQL for node "model.agency_data_pipeline.adwords_urls"
2018-04-17 15:56:14,338: Acquiring new bigquery connection "adwords_urls".
2018-04-17 15:56:14,338: Re-using an available connection from the pool.
2018-04-17 15:56:16,538: Model SQL (monthend_dates):
SELECT
date_in_range,
date_in_range_bom,
date_in_range_bom_mom,
unix_date_in_range,
unix_date_in_range_bom,
unix_date(date_in_range_bom_mom) unix_date_in_range_bom_mom,
yyyymm,
date_in_range_yoy,
unix_date(date_in_range_yoy) unix_date_in_range_yoy

FROM
(
	SELECT 
	date_in_range,
	date_in_range_bom,
	date_sub(date_in_range_bom, INTERVAL 1 MONTH) date_in_range_bom_mom,
  date_sub(date_in_range, INTERVAL 1 YEAR) date_in_range_yoy,
	unix_date_in_range,
	unix_date(date_in_range_bom) unix_date_in_range_bom,
	yyyymm,
	first_value(date_in_range) over (partition by yyyymm order by date_in_range desc) monthend_date_in_range
	FROM
	( 
		SELECT 
		date_in_range,
		date_trunc( date_in_range, MONTH) date_in_range_bom,
		unix_date(date_in_range) unix_date_in_range,
		format_date("%Y-%m", date_in_range) AS yyyymm
		FROM UNNEST(
		    GENERATE_DATE_ARRAY(DATE('2016-01-31'), CURRENT_DATE(), INTERVAL 1 DAY)
		) AS date_in_range
	)
)
where date_in_range = monthend_date_in_range
2018-04-17 15:56:16,624: Model SQL (carts_proc):
select 
client,
client_name,
account,
platform
from  ( 

SELECT  
client,
client_name,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.accounts`
WHERE platform in ('Shopify', 'Custom cart')

) 

WHERE lv = time_of_entry
2018-04-17 15:56:16,779: Model SQL (adwords_campaigns):
select
day,
campaignid, 
campaign,
account, 
channel,
platform,
sum(cost) cost,
sum(impressions) impressions,
sum(clicks) clicks,
sum(impression_share_num) impression_share_num,
sum(impression_share_den) impression_share_den
from 
  ( 
	SELECT  
	day,
	campaignid,
	campaign,
	account as account,
	'Paid' as channel,
	'Adwords' as platform,
	cost/1000000 cost, 
	impressions as impressions, 
	clicks, 
	case when searchimprshare is not null then impressions end as impression_share_num,
	case when searchimprshare is not null then impressions/(searchimprshare/100) end as impression_share_den,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY campaignid, day ORDER BY _sdc_sequence DESC) lv
	FROM `growth-engines-pipeline.adwords_2.CAMPAIGN_PERFORMANCE_REPORT`
  )
where lv = _sdc_sequence
group by day, campaignid, account, channel, platform, campaign
2018-04-17 15:56:17,304: Model SQL (adwords_urls):
SELECT
campaignid,
lower(trim(regexp_replace(replace(replace(replace(replace(finalurl,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url

FROM (

SELECT  
campaignid,
finalurl,
first_value(finalurl) OVER (PARTITION BY campaignid ORDER BY day DESC) lv
FROM `growth-engines-pipeline.adwords_2.FINAL_URL_REPORT`
)

WHERE lv = finalurl
group by campaignid, url
order by campaignid asc
2018-04-17 15:56:17,669: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107fa7710>]}
2018-04-17 15:56:17,768: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b529d30>]}
2018-04-17 15:56:18,035: 15:56:18 | 6 of 91 OK created table model agency_data_pipeline.monthend_dates... [CREATE TABLE in 3.93s]
2018-04-17 15:56:18,037: 15:56:18 | 9 of 91 START table model agency_data_pipeline.ga_conversions........ [RUN]
2018-04-17 15:56:18,040: Compiling model.agency_data_pipeline.ga_conversions
2018-04-17 15:56:18,051: Writing injected SQL for node "model.agency_data_pipeline.ga_conversions"
2018-04-17 15:56:18,055: Acquiring new bigquery connection "ga_conversions".
2018-04-17 15:56:18,055: Re-using an available connection from the pool.
2018-04-17 15:56:18,521: 15:56:18 | 7 of 91 OK created table model agency_data_pipeline.carts_proc....... [CREATE TABLE in 3.69s]
2018-04-17 15:56:18,522: 15:56:18 | 10 of 91 START table model agency_data_pipeline.all_dates............ [RUN]
2018-04-17 15:56:18,522: Compiling model.agency_data_pipeline.all_dates
2018-04-17 15:56:18,531: Writing injected SQL for node "model.agency_data_pipeline.all_dates"
2018-04-17 15:56:18,532: Acquiring new bigquery connection "all_dates".
2018-04-17 15:56:18,533: Re-using an available connection from the pool.
2018-04-17 15:56:19,125: Model SQL (ga_conversions):
select 
client,
client_name,
platform,
goal_name,
goal_type,
account,
time_of_entry
from  ( 

SELECT  
client,
client_name,
platform,
trim(goal_name) goal_name,
goal_type,
account,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform, goal_name ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.conversion_goals` 
WHERE platform = 'Google Analytics'

) 

WHERE lv = time_of_entry
2018-04-17 15:56:19,126: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b4eda58>]}
2018-04-17 15:56:19,546: Model SQL (all_dates):
SELECT 
date_in_range,
unix_date(date_in_range) unix_date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-04-17 15:56:19,704: 15:56:19 | 8 of 91 OK created table model agency_data_pipeline.adwords_urls..... [CREATE TABLE in 4.80s]
2018-04-17 15:56:19,704: 15:56:19 | 11 of 91 START table model agency_data_pipeline.bing_ads_impression_share [RUN]
2018-04-17 15:56:19,705: Compiling model.agency_data_pipeline.bing_ads_impression_share
2018-04-17 15:56:19,714: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_impression_share"
2018-04-17 15:56:19,715: Acquiring new bigquery connection "bing_ads_impression_share".
2018-04-17 15:56:19,715: Re-using an available connection from the pool.
2018-04-17 15:56:20,318: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107fa7710>]}
2018-04-17 15:56:20,670: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b529d30>]}
2018-04-17 15:56:20,671: Model SQL (bing_ads_impression_share):
SELECT 
date, 
account,
channel,
platform,
sum(impressions) impressions,
sum(available_impressions) available_impressions
FROM

(

SELECT  
cast(gregoriandate as date) date,
replace(accountname,',','') account,  
'Paid' as channel,
'Bing Ads' as platform,
case when impressionsharepercent is null then 0 else impressions end as impressions,
cast(round(case when ( impressionsharepercent is not null and impressionsharepercent > 0 ) then (impressions*100)/impressionsharepercent else 0 end) as int64) as available_impressions,
_sdc_sequence,
first_value(_sdc_sequence) OVER (PARTITION BY campaignid, gregoriandate ORDER BY _sdc_sequence DESC) lv
FROM `growth-engines-pipeline.bing_ads.campaign_performance_report` 

)

where lv = _sdc_sequence
group by date, account, channel, platform
2018-04-17 15:56:20,766: 15:56:20 | 9 of 91 OK created table model agency_data_pipeline.ga_conversions... [CREATE TABLE in 2.28s]
2018-04-17 15:56:20,767: 15:56:20 | 12 of 91 START table model agency_data_pipeline.clients_proc......... [RUN]
2018-04-17 15:56:20,768: Compiling model.agency_data_pipeline.clients_proc
2018-04-17 15:56:20,779: Writing injected SQL for node "model.agency_data_pipeline.clients_proc"
2018-04-17 15:56:20,782: Acquiring new bigquery connection "clients_proc".
2018-04-17 15:56:20,782: Re-using an available connection from the pool.
2018-04-17 15:56:21,127: 15:56:21 | 10 of 91 OK created table model agency_data_pipeline.all_dates....... [CREATE TABLE in 2.15s]
2018-04-17 15:56:21,816: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b4eda58>]}
2018-04-17 15:56:21,899: Model SQL (clients_proc):
select 
client,
client_name,
account,
platform
from  ( 

SELECT  
client,
client_name,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.accounts`
where client_name != ''
) 

WHERE lv = time_of_entry
2018-04-17 15:56:22,279: 15:56:22 | 11 of 91 OK created table model agency_data_pipeline.bing_ads_impression_share [CREATE TABLE in 2.11s]
2018-04-17 15:56:23,015: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107fa7710>]}
2018-04-17 15:56:23,416: 15:56:23 | 12 of 91 OK created table model agency_data_pipeline.clients_proc.... [CREATE TABLE in 2.25s]
2018-04-17 15:56:23,869: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b529940>]}
2018-04-17 15:56:24,256: 15:56:24 | 5 of 91 OK created table model agency_data_pipeline.adwords_campaigns [CREATE TABLE in 10.79s]
2018-04-17 15:56:24,257: 15:56:24 | 13 of 91 START table model agency_data_pipeline.adwords_ads.......... [RUN]
2018-04-17 15:56:24,258: Compiling model.agency_data_pipeline.adwords_ads
2018-04-17 15:56:24,267: Writing injected SQL for node "model.agency_data_pipeline.adwords_ads"
2018-04-17 15:56:24,257: 15:56:24 | 14 of 91 START table model agency_data_pipeline.ga_mcf_proc.......... [RUN]
2018-04-17 15:56:24,268: Compiling model.agency_data_pipeline.ga_mcf_proc
2018-04-17 15:56:24,258: 15:56:24 | 15 of 91 START table model agency_data_pipeline.shopify_refunds_proc. [RUN]
2018-04-17 15:56:24,258: 15:56:24 | 16 of 91 START table model agency_data_pipeline.fb_ads_insights_conversions [RUN]
2018-04-17 15:56:24,275: Writing injected SQL for node "model.agency_data_pipeline.ga_mcf_proc"
2018-04-17 15:56:24,275: Compiling model.agency_data_pipeline.shopify_refunds_proc
2018-04-17 15:56:24,275: Acquiring new bigquery connection "adwords_ads".
2018-04-17 15:56:24,275: Compiling model.agency_data_pipeline.fb_ads_insights_conversions
2018-04-17 15:56:24,282: Acquiring new bigquery connection "shopify_refunds_proc".
2018-04-17 15:56:24,283: Re-using an available connection from the pool.
2018-04-17 15:56:24,291: Acquiring new bigquery connection "ga_mcf_proc".
2018-04-17 15:56:24,302: Acquiring new bigquery connection "fb_ads_insights_conversions".
2018-04-17 15:56:24,302: Re-using an available connection from the pool.
2018-04-17 15:56:24,306: Fetching data for query shopify_refunds_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 15:56:24,309: Re-using an available connection from the pool.
2018-04-17 15:56:24,311: Re-using an available connection from the pool.
2018-04-17 15:56:24,312: Fetching data for query fb_ads_insights_conversions:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 15:56:25,456: Model SQL (adwords_ads):
SELECT  
day,
campaignid,
a.account as account,
utm_campaign,
sum( case when b.goal_type = 'Transaction' then conversions else 0 end ) as transactions
FROM (

	SELECT  
	day,
	adid,
	campaignid,
	account,
	lower(conversionname) conversionname,
	conversions,
	lower(campaign) utm_campaign,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY campaignid, day ORDER BY _sdc_sequence DESC) lv
	FROM
	`growth-engines-pipeline.adwords_2.AD_PERFORMANCE_REPORT`

) a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_conversions` b
ON ( a.conversionname = b.goal_name
	AND a.account = b.account )
WHERE lv = _sdc_sequence
group by day, campaignid, account, utm_campaign
2018-04-17 15:56:25,476: Model SQL (ga_mcf_proc):
SELECT 
date,
account,
'Google Analytics' as lookup_platform,
source_medium_path,
trim(lower(split(split(source_medium_path,'->')[SAFE_ORDINAL(1)],'/')[SAFE_ORDINAL(1)])) as source,
trim(lower(split(split(source_medium_path,'->')[SAFE_ORDINAL(1)],'/')[SAFE_ORDINAL(2)])) as medium,
first_interaction_campaign campaign,
cast(regexp_replace(transaction_id, r'#', '') as int64) transactionid,
max(first_interaction_conversions) transactions,
max(first_interaction_conversion_value) revenue
FROM `growth-engines-pipeline.agency_data_pipeline.ga_mcf`
where account in (select account from `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc` where platform = 'Google Analytics')
group by date, account, source, medium, campaign, source_medium_path, lookup_platform, transactionid
2018-04-17 15:56:25,502: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_insights_conversions"
2018-04-17 15:56:26,100: Writing injected SQL for node "model.agency_data_pipeline.shopify_refunds_proc"
2018-04-17 15:56:26,910: Model SQL (fb_ads_insights_conversions):




with fb_ads_insights_conversions as (

	    
		   	SELECT 
			date_start,
			campaign_id,
			campaign_name,
			ad_id,
			account_name,
			spend,
			reach,
			inline_link_clicks,
			_sdc_sequence,
			action_type,
			value
			FROM `growth-engines-pipeline.fb_ads_luca_danni.ads_insights`
			cross join unnest(actions)
		    
	   

)

SELECT * 
FROM 
	(
    SELECT
    date_start date,
    campaign_id,
    campaign_name campaign,
    ad_id,
    account_name account,
    action_type,
    value conversions,
    first_value(_sdc_sequence) OVER (PARTITION BY ad_id, date_start ORDER BY _sdc_sequence DESC) lv,
    _sdc_sequence
    FROM fb_ads_insights_conversions
   	)
where lv = _sdc_sequence
and action_type like '%purchase%'


2018-04-17 15:56:27,344: Model SQL (shopify_refunds_proc):




with refunds as (

	
	SELECT
	order_number,
	checkout_id,
	financial_status,
	line_item_id,
	quantity,
	subtotal,
	line_item.variant_id variant_id,
	line_item.id refund_id,
 	_sdc_sequence
	FROM `growth-engines-pipeline.shopify_lucadanni.orders` 
	cross join unnest(refunds), unnest(refund_line_items)
  	where financial_status like '%refund%'
	
	

)

SELECT * 
FROM 
	(
    SELECT
	order_number,
	checkout_id,
	financial_status,
	line_item_id,
	quantity,
	subtotal refund_amount,
	variant_id,
	refund_id,
 	_sdc_sequence,
    first_value(_sdc_sequence) OVER (PARTITION BY order_number, line_item_id ORDER BY _sdc_sequence DESC) lv
    FROM refunds
   	) 
WHERE lv = _sdc_sequence


2018-04-17 15:56:28,909: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b4952b0>]}
2018-04-17 15:56:29,187: 15:56:29 | 13 of 91 OK created table model agency_data_pipeline.adwords_ads..... [CREATE TABLE in 4.65s]
2018-04-17 15:56:29,188: 15:56:29 | 17 of 91 START table model agency_data_pipeline.fb_adcreative........ [RUN]
2018-04-17 15:56:29,188: Compiling model.agency_data_pipeline.fb_adcreative
2018-04-17 15:56:29,199: Acquiring new bigquery connection "fb_adcreative".
2018-04-17 15:56:29,199: Re-using an available connection from the pool.
2018-04-17 15:56:29,199: Fetching data for query fb_adcreative:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 15:56:29,595: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ceaacc0>]}
2018-04-17 15:56:29,625: Writing injected SQL for node "model.agency_data_pipeline.fb_adcreative"
2018-04-17 15:56:29,907: 15:56:29 | 15 of 91 OK created table model agency_data_pipeline.shopify_refunds_proc [CREATE TABLE in 5.32s]
2018-04-17 15:56:29,910: 15:56:29 | 18 of 91 START table model agency_data_pipeline.fb_ads_insights...... [RUN]
2018-04-17 15:56:29,910: Compiling model.agency_data_pipeline.fb_ads_insights
2018-04-17 15:56:29,916: Acquiring new bigquery connection "fb_ads_insights".
2018-04-17 15:56:29,916: Re-using an available connection from the pool.
2018-04-17 15:56:29,916: Fetching data for query fb_ads_insights:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 15:56:30,364: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_insights"
2018-04-17 15:56:30,714: Model SQL (fb_adcreative):




with fb_adcreative as (


	    
		   	SELECT 
			id,
			object_url,
			url_tags,
			_sdc_sequence
			FROM `growth-engines-pipeline.fb_ads_luca_danni.adcreative`
		    
	   
)

select creative_id, max(url) url
from (
  select
  id creative_id,
  lower(trim(regexp_replace(replace(replace(replace(replace(object_url,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
  first_value(_sdc_sequence) OVER (PARTITION BY id ORDER BY _sdc_sequence DESC) lv,
  _sdc_sequence
  from fb_adcreative
  )
where lv = _sdc_sequence
group by creative_id


2018-04-17 15:56:30,934: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b501b38>]}
2018-04-17 15:56:31,163: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b4eda20>]}
2018-04-17 15:56:31,296: 15:56:31 | 16 of 91 OK created table model agency_data_pipeline.fb_ads_insights_conversions [CREATE TABLE in 6.66s]
2018-04-17 15:56:31,297: 15:56:31 | 19 of 91 START table model agency_data_pipeline.bing_ads_conversions. [RUN]
2018-04-17 15:56:31,300: Compiling model.agency_data_pipeline.bing_ads_conversions
2018-04-17 15:56:31,307: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_conversions"
2018-04-17 15:56:31,308: Model SQL (fb_ads_insights):




with fb_ads_insights as (

	    
		   	SELECT 
			date_start,
			campaign_id,
			campaign_name,
			ad_id,
			account_name,
			spend,
			reach,
			inline_link_clicks,
			_sdc_sequence,
			first_value(_sdc_sequence) OVER (PARTITION BY date_start, ad_id, campaign_id ORDER BY _sdc_sequence DESC) lv
			FROM `growth-engines-pipeline.fb_ads_luca_danni.ads_insights`
		    
	   

)

select
date_start date,
campaign_id,
campaign_name campaign,
ad_id,
account_name account,
max(spend) cost,
max(reach) impressions,
max(inline_link_clicks) clicks
from fb_ads_insights
where lv = _sdc_sequence
group by date, campaign_id, ad_id, account, campaign


2018-04-17 15:56:31,311: Acquiring new bigquery connection "bing_ads_conversions".
2018-04-17 15:56:31,311: Re-using an available connection from the pool.
2018-04-17 15:56:31,590: 15:56:31 | 14 of 91 OK created table model agency_data_pipeline.ga_mcf_proc..... [CREATE TABLE in 6.90s]
2018-04-17 15:56:31,590: 15:56:31 | 20 of 91 START table model agency_data_pipeline.mappings_ga_proc..... [RUN]
2018-04-17 15:56:31,591: Compiling model.agency_data_pipeline.mappings_ga_proc
2018-04-17 15:56:31,601: Writing injected SQL for node "model.agency_data_pipeline.mappings_ga_proc"
2018-04-17 15:56:31,602: Acquiring new bigquery connection "mappings_ga_proc".
2018-04-17 15:56:31,602: Re-using an available connection from the pool.
2018-04-17 15:56:32,357: Model SQL (bing_ads_conversions):
SELECT
date, 
a.account account, 
a.channel channel,
a.platform platform,
campaignid,
campaignname,
sum( case when b.goal_type = 'Transactions' then conversions else 0 end ) as transactions
FROM

  ( 
SELECT  
cast(gregoriandate as date) date,
replace(accountname,',','') account,
'Paid' as channel,
'Bing Ads' as platform,
trim(replace(replace(lower(goal),',',''),' ','')) goal,
goalid,
campaignid,
campaignname,
conversions,
_sdc_sequence,
first_value(_sdc_sequence) OVER (PARTITION BY campaignid, goalid, gregoriandate ORDER BY _sdc_sequence DESC) lv
FROM `growth-engines-pipeline.bing_ads.goals_and_funnels_report` 

  ) a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`conversion_goals_proc` b
ON (
	a.account = b.account AND
	a.platform = b.platform AND
	a.goal = b.goal_name
)
where a.lv = a._sdc_sequence
group by date, account, channel, platform, campaignid, campaignname
2018-04-17 15:56:32,571: Model SQL (mappings_ga_proc):
select 
client,
account,
client_name,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
account,
client_name,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.mappings_ga` 

) 

WHERE lv = time_of_entry
and client in (select client from `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc` )
group by client, account, client_name, source, medium, platform_n, channel_n, time_of_entry
2018-04-17 15:56:32,984: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b4952b0>]}
2018-04-17 15:56:33,237: 15:56:33 | 17 of 91 OK created table model agency_data_pipeline.fb_adcreative... [CREATE TABLE in 3.80s]
2018-04-17 15:56:33,547: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cea3d68>]}
2018-04-17 15:56:33,804: 15:56:33 | 18 of 91 OK created table model agency_data_pipeline.fb_ads_insights. [CREATE TABLE in 3.64s]
2018-04-17 15:56:34,621: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ce980b8>]}
2018-04-17 15:56:34,870: 15:56:34 | 19 of 91 OK created table model agency_data_pipeline.bing_ads_conversions [CREATE TABLE in 3.32s]
2018-04-17 15:56:35,933: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b305400>]}
2018-04-17 15:56:36,169: 15:56:36 | 20 of 91 OK created table model agency_data_pipeline.mappings_ga_proc [CREATE TABLE in 4.34s]
2018-04-17 15:56:36,170: 15:56:36 | 21 of 91 START table model agency_data_pipeline.shopify_customers_proc [RUN]
2018-04-17 15:56:36,171: 15:56:36 | 22 of 91 START table model agency_data_pipeline.fb_ads............... [RUN]
2018-04-17 15:56:36,171: Compiling model.agency_data_pipeline.shopify_customers_proc
2018-04-17 15:56:36,171: Compiling model.agency_data_pipeline.fb_ads
2018-04-17 15:56:36,190: Acquiring new bigquery connection "shopify_customers_proc".
2018-04-17 15:56:36,191: Re-using an available connection from the pool.
2018-04-17 15:56:36,191: Fetching data for query shopify_customers_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 15:56:36,198: Acquiring new bigquery connection "fb_ads".
2018-04-17 15:56:36,199: Re-using an available connection from the pool.
2018-04-17 15:56:36,199: Fetching data for query fb_ads:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 15:56:36,674: Writing injected SQL for node "model.agency_data_pipeline.fb_ads"
2018-04-17 15:56:36,681: Writing injected SQL for node "model.agency_data_pipeline.shopify_customers_proc"
2018-04-17 15:56:37,790: Model SQL (fb_ads):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`fb_adcreative`





with fb_ads as (

	    
		   	SELECT 
			id ad_id,
			creative.creative_id creative_id,
			_sdc_sequence
			FROM `growth-engines-pipeline.fb_ads_luca_danni.ads`
		     
	   

)

SELECT
a.ad_id,
b.creative_id,
b.url
FROM (
    SELECT
    ad_id,
    creative_id,
    first_value(_sdc_sequence) OVER (PARTITION BY ad_id ORDER BY _sdc_sequence DESC) lv,
    _sdc_sequence
    FROM fb_ads
    ) a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`fb_adcreative` b
ON (
	a.creative_id = b.creative_id 
)
WHERE a.lv = a._sdc_sequence


2018-04-17 15:56:37,847: Model SQL (shopify_customers_proc):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc`





with customers as (

	
	SELECT
	'lucadanni' client_name,
	'Shopify' as lookup_platform,
	cast(created_at as date) created_at,
	id,
	first_name,
	last_name,
	email,
	_sdc_sequence,
	first_value(_sdc_sequence) over (partition by id, _sdc_sequence order by _sdc_sequence desc) lv
	FROM `growth-engines-pipeline.shopify_lucadanni.customers` 
	
	

)

SELECT
account,
client,
platform,
id,
min(created_at) created_at,
max(first_name) first_name,
max(last_name) last_name,
max(email) email
FROM (
	SELECT
	b.account,
	b.client,
	b.platform,
	created_at,
	id,
	first_name,
	last_name,
	email
	FROM customers a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
	ON ( a.client_name = b.client_name
	  AND a.lookup_platform = b.platform )
	where a.lv = a._sdc_sequence
)
group by account, client, platform, id

2018-04-17 15:56:40,062: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d8ba208>]}
2018-04-17 15:56:40,347: 15:56:40 | 22 of 91 OK created table model agency_data_pipeline.fb_ads.......... [CREATE TABLE in 3.89s]
2018-04-17 15:56:42,366: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b529940>]}
2018-04-17 15:56:42,609: 15:56:42 | 21 of 91 OK created table model agency_data_pipeline.shopify_customers_proc [CREATE TABLE in 6.20s]
2018-04-17 15:56:42,610: 15:56:42 | 23 of 91 START table model agency_data_pipeline.shopify_products_proc [RUN]
2018-04-17 15:56:42,610: 15:56:42 | 24 of 91 START table model agency_data_pipeline.agg_customers_union.. [RUN]
2018-04-17 15:56:42,611: 15:56:42 | 25 of 91 START table model agency_data_pipeline.bing_ads_stats....... [RUN]
2018-04-17 15:56:42,611: 15:56:42 | 26 of 91 START table model agency_data_pipeline.shopify_orders_proc.. [RUN]
2018-04-17 15:56:42,611: Compiling model.agency_data_pipeline.shopify_products_proc
2018-04-17 15:56:42,612: Compiling model.agency_data_pipeline.agg_customers_union
2018-04-17 15:56:42,612: Compiling model.agency_data_pipeline.bing_ads_stats
2018-04-17 15:56:42,612: Compiling model.agency_data_pipeline.shopify_orders_proc
2018-04-17 15:56:42,633: Writing injected SQL for node "model.agency_data_pipeline.agg_customers_union"
2018-04-17 15:56:42,638: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_stats"
2018-04-17 15:56:42,639: Acquiring new bigquery connection "shopify_products_proc".
2018-04-17 15:56:42,649: Acquiring new bigquery connection "shopify_orders_proc".
2018-04-17 15:56:42,650: Re-using an available connection from the pool.
2018-04-17 15:56:42,650: Fetching data for query shopify_products_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 15:56:42,650: Re-using an available connection from the pool.
2018-04-17 15:56:42,651: Acquiring new bigquery connection "bing_ads_stats".
2018-04-17 15:56:42,652: Acquiring new bigquery connection "agg_customers_union".
2018-04-17 15:56:42,652: Fetching data for query shopify_orders_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 15:56:42,653: Re-using an available connection from the pool.
2018-04-17 15:56:42,655: Re-using an available connection from the pool.
2018-04-17 15:56:43,085: Writing injected SQL for node "model.agency_data_pipeline.shopify_products_proc"
2018-04-17 15:56:43,099: Writing injected SQL for node "model.agency_data_pipeline.shopify_orders_proc"
2018-04-17 15:56:43,665: Model SQL (agg_customers_union):
SELECT *
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`shopify_customers_proc`
2018-04-17 15:56:43,726: Model SQL (bing_ads_stats):
select
a.date, 
a.account, 
a.channel,
a.platform,
url,
a.campaignname campaign,
utm_campaign,
cost,
clicks,
impressions,
transactions
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`bing_ads_ads` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`bing_ads_conversions` b
ON (
	a.date = b.date AND
	a.account = b.account AND
	a.campaignid = b.campaignid

)
2018-04-17 15:56:44,135: Model SQL (shopify_products_proc):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc`, `growth-engines-pipeline`.`agency_data_pipeline`.`shopify_refunds_proc`





with products as (

	
	SELECT
	'lucadanni' client_name,
	'Shopify' as lookup_platform,
	product_type,
	product_id,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY product_id ORDER BY _sdc_sequence DESC) lv
	FROM `growth-engines-pipeline.shopify_lucadanni.products` 
	cross join unnest(variants)
	
	

)

SELECT
b.account,
b.client,
b.platform,
max(product_type) product_type,
product_id
FROM products a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
ON ( a.client_name = b.client_name
  AND a.lookup_platform = b.platform )
where a.lv = a._sdc_sequence
group by product_id, account, client, platform


2018-04-17 15:56:44,136: Model SQL (shopify_orders_proc):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc`, `growth-engines-pipeline`.`agency_data_pipeline`.`shopify_refunds_proc`





with orders as (

	
	SELECT
	'lucadanni' client_name,
	'Shopify' as lookup_platform,
	created_at,
	order_number,
	quantity,
	cast(pre_tax_price as float64) price, 
	total_line_items_price total_order_price_undiscounted,
	total_discounts,
	cast(discounted_price as float64) total_order_shipping_price,
	total_price_usd total_order_price_incl_shipping,
	checkout_id,
	product_id, 
	landing_site,
	sku, 
	variant_title, 
	variant_id,
	_id line_item_id,
	customer.id customer_id,
	customer.orders_count orders_count,
	customer.created_at customer_created_at,
	customer.last_order_id last_order_id,
	financial_status,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY order_number, _id ORDER BY _sdc_sequence DESC) lv
	FROM `growth-engines-pipeline.shopify_lucadanni.orders` 
	cross join unnest(line_items), unnest(shipping_lines)
	where source_name != 'shopify_draft_order'
	
	

)

SELECT
b.account,
b.client,
b.platform,
created_at,
a.order_number,
a.quantity,
c.quantity refund_quantity,
case when c.quantity is not null then a.quantity - c.quantity else a.quantity end as final_quantity,
price, 
total_order_price_undiscounted,
total_discounts,
total_order_shipping_price,
total_order_price_incl_shipping,
refund_amount,
case when refund_amount is not null then price - refund_amount else price end as final_price,
a.checkout_id,
a.product_id, 
landing_site,
sku, 
variant_title, 
a.variant_id,
a.line_item_id,	
customer_id,
orders_count,
customer_created_at,
last_order_id,
a.financial_status
FROM orders a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
ON ( a.client_name = b.client_name
  AND a.lookup_platform = b.platform )
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`shopify_refunds_proc` c
ON ( a.order_number = c.order_number
	AND a.line_item_id = c.line_item_id )   	
where a.lv = a._sdc_sequence


2018-04-17 15:56:45,965: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d8ceda0>]}
2018-04-17 15:56:46,242: 15:56:46 | 25 of 91 OK created table model agency_data_pipeline.bing_ads_stats.. [CREATE TABLE in 3.35s]
2018-04-17 15:56:46,243: 15:56:46 | 27 of 91 START table model agency_data_pipeline.ga_mcf_stats......... [RUN]
2018-04-17 15:56:46,244: Compiling model.agency_data_pipeline.ga_mcf_stats
2018-04-17 15:56:46,256: Writing injected SQL for node "model.agency_data_pipeline.ga_mcf_stats"
2018-04-17 15:56:46,257: Acquiring new bigquery connection "ga_mcf_stats".
2018-04-17 15:56:46,258: Re-using an available connection from the pool.
2018-04-17 15:56:46,426: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b305400>]}
2018-04-17 15:56:46,666: 15:56:46 | 23 of 91 OK created table model agency_data_pipeline.shopify_products_proc [CREATE TABLE in 3.81s]
2018-04-17 15:56:47,039: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b4952b0>]}
2018-04-17 15:56:47,184: Model SQL (ga_mcf_stats):
SELECT  
date,
a.account account,
b.client client,
case when c.platform is null then "Unmapped" else c.platform end as platform,
case when c.channel is null then "Unmapped" else c.channel end as channel,
lower(a.source) source,
lower(a.medium) medium,
lower(campaign) campaign,
transactionid,
sum(transactions) first_touch_transactions,
sum(revenue) first_touch_revenue
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`ga_mcf_proc` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc` b 
ON ( a.account = b.account and
	a.lookup_platform = b.platform )
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc` c
ON ( lower(a.source) = c.source
  AND lower(a.medium) = c.medium 
  and a.account = c.account )
group by date, account, client, source, medium, campaign, platform, channel, transactionid
2018-04-17 15:56:47,296: 15:56:47 | 24 of 91 OK created table model agency_data_pipeline.agg_customers_union [CREATE TABLE in 4.43s]
2018-04-17 15:56:52,796: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ce98080>]}
2018-04-17 15:56:53,044: 15:56:53 | 27 of 91 OK created table model agency_data_pipeline.ga_mcf_stats.... [CREATE TABLE in 6.55s]
2018-04-17 15:56:54,241: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d8df0f0>]}
2018-04-17 15:56:54,487: 15:56:54 | 26 of 91 OK created table model agency_data_pipeline.shopify_orders_proc [CREATE TABLE in 11.63s]
2018-04-17 15:56:54,489: 15:56:54 | 28 of 91 START table model agency_data_pipeline.adwords_join......... [RUN]
2018-04-17 15:56:54,489: 15:56:54 | 29 of 91 START table model agency_data_pipeline.agg_orders_union..... [RUN]
2018-04-17 15:56:54,490: 15:56:54 | 30 of 91 START table model agency_data_pipeline.agg_products......... [RUN]
2018-04-17 15:56:54,490: 15:56:54 | 31 of 91 START table model agency_data_pipeline.ga_transactions...... [RUN]
2018-04-17 15:56:54,490: Compiling model.agency_data_pipeline.adwords_join
2018-04-17 15:56:54,491: Compiling model.agency_data_pipeline.agg_orders_union
2018-04-17 15:56:54,491: Compiling model.agency_data_pipeline.agg_products
2018-04-17 15:56:54,491: Compiling model.agency_data_pipeline.ga_transactions
2018-04-17 15:56:54,504: Writing injected SQL for node "model.agency_data_pipeline.agg_orders_union"
2018-04-17 15:56:54,505: Writing injected SQL for node "model.agency_data_pipeline.adwords_join"
2018-04-17 15:56:54,510: Writing injected SQL for node "model.agency_data_pipeline.agg_products"
2018-04-17 15:56:54,520: Acquiring new bigquery connection "ga_transactions".
2018-04-17 15:56:54,521: Acquiring new bigquery connection "adwords_join".
2018-04-17 15:56:54,522: Re-using an available connection from the pool.
2018-04-17 15:56:54,522: Acquiring new bigquery connection "agg_products".
2018-04-17 15:56:54,523: Acquiring new bigquery connection "agg_orders_union".
2018-04-17 15:56:54,524: Fetching data for query ga_transactions:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Google Analytics'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 15:56:54,524: Re-using an available connection from the pool.
2018-04-17 15:56:54,525: Re-using an available connection from the pool.
2018-04-17 15:56:54,527: Re-using an available connection from the pool.
2018-04-17 15:56:55,374: Model SQL (agg_products):
SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`shopify_products_proc`
2018-04-17 15:56:55,425: Model SQL (adwords_join):
select
a.day,
a.campaignid, 
a.campaign,
a.account, 
channel,
platform,
url,
utm_campaign,
cost,
impressions,
clicks,
impression_share_num,
impression_share_den,
transactions
FROM ( 
	
	select
	day,
	a.campaign,
	a.campaignid, 
	account, 
	channel,
	platform,
	url,
	cost,
	impressions,
	clicks,
	impression_share_num,
	impression_share_den
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_campaigns` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_urls` b
	ON a.campaignid = b.campaignid

) a 
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_ads` b
ON ( a.campaignid = b.campaignid
	and a.day = b.day )
2018-04-17 15:56:55,482: Model SQL (agg_orders_union):
SELECT
account,
client,
platform,
created_at,
order_number,
quantity,
refund_quantity,
final_quantity,
price, 
total_order_price_undiscounted,
total_discounts,
total_order_shipping_price,
total_order_price_incl_shipping,
refund_amount,
final_price,
checkout_id,
product_id, 
landing_site,
sku, 
variant_title, 
variant_id,
line_item_id,	
customer_id,
orders_count,
customer_created_at,
last_order_id,
financial_status
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`shopify_orders_proc`
2018-04-17 15:56:55,708: Fetching data for query ga_transactions:


        select
            goal_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_conversions`

        
        ##where 1 = 1
        where goal_type = 'Conversion'
        
        
        
        ##and 2 = 2
        and client_name = 'lucadanni'
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 15:56:56,507: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d8ce940>]}
2018-04-17 15:56:56,750: 15:56:56 | 30 of 91 OK created table model agency_data_pipeline.agg_products.... [CREATE TABLE in 2.02s]
2018-04-17 15:56:56,750: 15:56:56 | 32 of 91 START table model agency_data_pipeline.ga_traffic........... [RUN]
2018-04-17 15:56:56,751: Compiling model.agency_data_pipeline.ga_traffic
2018-04-17 15:56:56,767: Acquiring new bigquery connection "ga_traffic".
2018-04-17 15:56:56,768: Re-using an available connection from the pool.
2018-04-17 15:56:56,768: Fetching data for query ga_traffic:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'GA Traffic'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 15:56:56,922: Writing injected SQL for node "model.agency_data_pipeline.ga_transactions"
2018-04-17 15:56:57,882: Model SQL (ga_transactions):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc`, `growth-engines-pipeline`.`agency_data_pipeline`.`ga_conversions`


##`growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` 



with ga_report as (

	    

	    	
	    	
		   	SELECT
		   	'lucadanni' as client_name,
		   	'Google Analytics' as lookup_platform,
			lower(trim(regexp_replace(replace(replace(replace(replace(CONCAT(hostname,landingpagepath),'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
			date,
			lower(source) source,
			lower(medium) medium,
			lower(campaign) campaign,
			cast(regexp_replace(transactionid, r'#', '') as int64) transactionid,
			transactions last_touch_transactions,
			(transactionrevenue - transactionshipping - transactiontax) as last_touch_revenue,
			transactionshipping,
			transactiontax,
			_sdc_sequence,
			first_value(_sdc_sequence) OVER (PARTITION BY hostname, landingpagepath, date, source, medium, transactionid ORDER BY _sdc_sequence DESC) lv
			FROM `growth-engines-pipeline.ga_lucadanni.report` 

		    
	   

)


SELECT  
cast(date as date) date,
b.account,
b.client client,
c.source source,
c.medium medium,
a.campaign campaign,
concat(a.source, ' / ', a.medium) source_medium,  
case when c.platform is null then "Unmapped" else c.platform end as platform,
case when c.channel is null then "Unmapped" else c.channel end as channel,
regexp_replace(url, r'offers.|offer.|get.|info.|pos.|go.|join.|pages.','') url,
transactionid,
max(last_touch_transactions) last_touch_transactions,
max(last_touch_revenue) last_touch_revenue,
max(transactionshipping) last_touch_shipping,
max(transactiontax) last_touch_tax
FROM ga_report a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
ON ( a.client_name = b.client_name 
	AND a.lookup_platform = b.platform )
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc` c
ON ( a.source = c.source
  AND a.medium = c.medium 
  AND a.client_name = c.client_name )
GROUP BY date, account, client, source, medium, campaign, source_medium, platform, channel, url, transactionid


2018-04-17 15:56:57,920: Fetching data for query ga_traffic:


        select
            goal_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_conversions`

        
        ##where 1 = 1
        where goal_type = 'Conversion'
        
        
        
        ##and 2 = 2
        and client_name = 'lucadanni'
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-17 15:56:58,323: Writing injected SQL for node "model.agency_data_pipeline.ga_traffic"
2018-04-17 15:56:59,392: Model SQL (ga_traffic):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc`, `growth-engines-pipeline`.`agency_data_pipeline`.`ga_conversions`


##`growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` 



with ga_report as (

	    

	    	
	    	
		   	SELECT
		   	'lucadanni' as client_name,
		   	'GA Traffic' as lookup_platform,
			lower(trim(regexp_replace(replace(replace(replace(replace(CONCAT(hostname,landingpagepath),'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
			date,
			lower(source) source,
			lower(medium) medium,
			lower(campaign) campaign,
			sessions,
			## goal completion columns
							
				goalcompletionsall as goal_completions,		
			
			_sdc_sequence,
			first_value(_sdc_sequence) OVER (PARTITION BY hostname, landingpagepath, date, source, medium, campaign ORDER BY _sdc_sequence DESC) lv
			FROM `growth-engines-pipeline.ga_lucadanni_traffic.report` 

		    
	   

)


SELECT  
cast(date as date) date,
b.account,
b.client client,
c.source source,
c.medium medium,
a.campaign campaign,
concat(a.source, ' / ', a.medium) source_medium,  
case when c.platform is null then "Unmapped" else c.platform end as platform,
case when c.channel is null then "Unmapped" else c.channel end as channel,
regexp_replace(url, r'offers.|offer.|get.|info.|pos.|go.|join.|pages.','') url,
max(sessions) sessions,
max(goal_completions) goal_completions
FROM ga_report a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
ON ( a.client_name = b.client_name 
	AND a.lookup_platform = b.platform )
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc` c
ON ( a.source = c.source
  AND a.medium = c.medium 
  AND a.client_name = c.client_name )
GROUP BY date, account, client, source, medium, campaign, source_medium, platform, channel, url


2018-04-17 15:57:01,205: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cea3d68>]}
2018-04-17 15:57:01,893: 15:57:01 | 28 of 91 OK created table model agency_data_pipeline.adwords_join.... [CREATE TABLE in 6.71s]
2018-04-17 15:57:02,226: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b4eda20>]}
2018-04-17 15:57:02,516: 15:57:02 | 29 of 91 OK created table model agency_data_pipeline.agg_orders_union [CREATE TABLE in 7.74s]
2018-04-17 15:57:03,455: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d8cea58>]}
2018-04-17 15:57:03,700: 15:57:03 | 31 of 91 OK created table model agency_data_pipeline.ga_transactions. [CREATE TABLE in 8.96s]
2018-04-17 15:57:10,489: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d8ce940>]}
2018-04-17 15:57:10,732: 15:57:10 | 32 of 91 OK created table model agency_data_pipeline.ga_traffic...... [CREATE TABLE in 13.74s]
2018-04-17 15:57:10,733: 15:57:10 | 33 of 91 START table model agency_data_pipeline.fb_ads_stats......... [RUN]
2018-04-17 15:57:10,733: 15:57:10 | 34 of 91 START table model agency_data_pipeline.agg_transaction_line_item [RUN]
2018-04-17 15:57:10,733: 15:57:10 | 35 of 91 START table model agency_data_pipeline.adwords_impression_share [RUN]
2018-04-17 15:57:10,734: 15:57:10 | 36 of 91 START table model agency_data_pipeline.adwords_stats........ [RUN]
2018-04-17 15:57:10,734: Compiling model.agency_data_pipeline.fb_ads_stats
2018-04-17 15:57:10,734: Compiling model.agency_data_pipeline.agg_transaction_line_item
2018-04-17 15:57:10,735: Compiling model.agency_data_pipeline.adwords_impression_share
2018-04-17 15:57:10,735: Compiling model.agency_data_pipeline.adwords_stats
2018-04-17 15:57:10,745: Writing injected SQL for node "model.agency_data_pipeline.agg_transaction_line_item"
2018-04-17 15:57:10,746: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_stats"
2018-04-17 15:57:10,751: Writing injected SQL for node "model.agency_data_pipeline.adwords_impression_share"
2018-04-17 15:57:10,755: Writing injected SQL for node "model.agency_data_pipeline.adwords_stats"
2018-04-17 15:57:10,758: Acquiring new bigquery connection "agg_transaction_line_item".
2018-04-17 15:57:10,758: Re-using an available connection from the pool.
2018-04-17 15:57:10,759: Acquiring new bigquery connection "adwords_stats".
2018-04-17 15:57:10,759: Re-using an available connection from the pool.
2018-04-17 15:57:10,761: Acquiring new bigquery connection "adwords_impression_share".
2018-04-17 15:57:10,761: Re-using an available connection from the pool.
2018-04-17 15:57:10,769: Acquiring new bigquery connection "fb_ads_stats".
2018-04-17 15:57:10,769: Re-using an available connection from the pool.
2018-04-17 15:57:11,665: Model SQL (agg_transaction_line_item):
SELECT
client,
created_at,
order_number,
quantity,
refund_quantity,
final_quantity,
price, 
total_order_price_undiscounted,
total_discounts,
total_order_shipping_price,
total_order_price_incl_shipping,
refund_amount,
final_price,
checkout_id,
product_id, 
landing_site,
sku, 
variant_title, 
variant_id,
line_item_id,	
customer_id,
orders_count,
customer_created_at,
last_order_id,
financial_status
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`agg_orders_union`
2018-04-17 15:57:11,720: Model SQL (fb_ads_stats):
with cost as (

    select 
        date, account, ad_id, campaign,
        cost, impressions, clicks, null as conversions
    from `growth-engines-pipeline`.`agency_data_pipeline`.`fb_ads_insights`
),

conversions as (

    select 
        date, account, ad_id, campaign,
        null as cost, null as impressions, null as clicks, conversions
    from `growth-engines-pipeline`.`agency_data_pipeline`.`fb_ads_insights_conversions`
),

urls as (

    select ad_id, url
    from `growth-engines-pipeline`.`agency_data_pipeline`.`fb_ads`
)


SELECT
    cast(date as date) date,
    'FB Ads' platform,
    'Paid' channel,
    account, 
    b.url url,
    campaign,
    lower(campaign) utm_campaign, 
    sum(cost) cost,
    sum(impressions) impressions,
    sum(clicks) clicks,
    sum(conversions) transactions
FROM
(
    SELECT *
    FROM 
      cost
    UNION ALL
    SELECT *
    FROM 
      conversions
) a
LEFT JOIN urls b
ON ( a.ad_id = b.ad_id )
group by date, platform, channel, account, url, campaign, utm_campaign
2018-04-17 15:57:11,721: Model SQL (adwords_stats):
SELECT 
cast(day as date) date, 
account, 
platform,
channel,
url,
utm_campaign,
campaign,
sum(cost) cost,
sum(impressions) impressions,
sum(clicks) clicks,
sum(transactions) transactions
FROM 
  `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_join`
group by date, account, platform, channel, url, campaign, utm_campaign
2018-04-17 15:57:11,986: Model SQL (adwords_impression_share):
SELECT 
cast(day as date) date, 
account, 
channel,
platform,
sum(impression_share_num) impressions,
sum(impression_share_den) available_impressions
FROM 
  `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_join`
group by date, account, platform, channel
2018-04-17 15:57:13,943: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d8cfb00>]}
2018-04-17 15:57:14,272: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b4956d8>]}
2018-04-17 15:57:14,935: 15:57:14 | 33 of 91 OK created table model agency_data_pipeline.fb_ads_stats.... [CREATE TABLE in 3.21s]
2018-04-17 15:57:14,936: 15:57:14 | 37 of 91 START table model agency_data_pipeline.agg_transaction_order_number [RUN]
2018-04-17 15:57:14,936: Compiling model.agency_data_pipeline.agg_transaction_order_number
2018-04-17 15:57:14,946: Writing injected SQL for node "model.agency_data_pipeline.agg_transaction_order_number"
2018-04-17 15:57:14,950: Acquiring new bigquery connection "agg_transaction_order_number".
2018-04-17 15:57:14,951: Re-using an available connection from the pool.
2018-04-17 15:57:15,187: 15:57:15 | 35 of 91 OK created table model agency_data_pipeline.adwords_impression_share [CREATE TABLE in 3.54s]
2018-04-17 15:57:15,984: Model SQL (agg_transaction_order_number):
SELECT
client,
cast(created_at as date) date,
order_number,
customer_id,
sum(final_quantity) final_quantity,
sum(final_price) final_price,
max(total_order_shipping_price) shipping_price
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`agg_orders_union`
GROUP BY client, created_at, order_number, customer_id
2018-04-17 15:57:17,335: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b4a6d30>]}
2018-04-17 15:57:17,578: 15:57:17 | 36 of 91 OK created table model agency_data_pipeline.adwords_stats... [CREATE TABLE in 6.60s]
2018-04-17 15:57:19,511: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d93b048>]}
2018-04-17 15:57:19,759: 15:57:19 | 34 of 91 OK created table model agency_data_pipeline.agg_transaction_line_item [CREATE TABLE in 8.78s]
2018-04-17 15:57:20,451: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b495710>]}
2018-04-17 15:57:20,722: 15:57:20 | 37 of 91 OK created table model agency_data_pipeline.agg_transaction_order_number [CREATE TABLE in 5.51s]
2018-04-17 15:57:20,722: 15:57:20 | 38 of 91 START table model agency_data_pipeline.customers_by_transaction [RUN]
2018-04-17 15:57:20,723: Compiling model.agency_data_pipeline.customers_by_transaction
2018-04-17 15:57:20,731: Writing injected SQL for node "model.agency_data_pipeline.customers_by_transaction"
2018-04-17 15:57:20,732: Acquiring new bigquery connection "customers_by_transaction".
2018-04-17 15:57:20,733: Re-using an available connection from the pool.
2018-04-17 15:57:21,818: Model SQL (customers_by_transaction):
SELECT
client,
customer_id,
order_number,
order_date,
first_order_date,
case when first_order_number = order_number then 'New' else 'Existing' end as order_type,
final_price,
first_order_revenue,
lifetime_revenue
FROM

(

	SELECT
	client,
	customer_id,
	order_number,
	date order_date,
	first_value(date) over w1 first_order_date,
	first_value(order_number) over w1 first_order_number,
	first_value(final_price) over w1 first_order_revenue,
    final_price,
	sum(final_price) over w2 lifetime_revenue
	FROM
    `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_order_number`
	WINDOW w1 as (PARTITION BY client, customer_id ORDER BY date desc),
	w2 as (PARTITION BY client, customer_id)
)
2018-04-17 15:57:25,172: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b559a90>]}
2018-04-17 15:57:25,434: 15:57:25 | 38 of 91 OK created table model agency_data_pipeline.customers_by_transaction [CREATE TABLE in 4.45s]
2018-04-17 15:57:25,435: 15:57:25 | 39 of 91 START table model agency_data_pipeline.agg_ga_transaction_order_number [RUN]
2018-04-17 15:57:25,435: 15:57:25 | 40 of 91 START table model agency_data_pipeline.frequency_proc....... [RUN]
2018-04-17 15:57:25,435: Compiling model.agency_data_pipeline.agg_ga_transaction_order_number
2018-04-17 15:57:25,435: Compiling model.agency_data_pipeline.frequency_proc
2018-04-17 15:57:25,442: Writing injected SQL for node "model.agency_data_pipeline.agg_ga_transaction_order_number"
2018-04-17 15:57:25,447: Writing injected SQL for node "model.agency_data_pipeline.frequency_proc"
2018-04-17 15:57:25,450: Acquiring new bigquery connection "agg_ga_transaction_order_number".
2018-04-17 15:57:25,450: Re-using an available connection from the pool.
2018-04-17 15:57:25,451: Acquiring new bigquery connection "frequency_proc".
2018-04-17 15:57:25,452: Re-using an available connection from the pool.
2018-04-17 15:57:26,439: Model SQL (agg_ga_transaction_order_number):
with ga as (

    select 
        date, account, client, 
        channel as last_touch_channel, 
        platform as last_touch_platform, 
        url as last_touch_url, 
        campaign as last_touch_utm_campaign, 
        '' as first_touch_channel, 
        '' as first_touch_platform, 
        '' as first_touch_utm_campaign, 
        transactionid,
        last_touch_transactions, last_touch_revenue,
        last_touch_shipping, last_touch_tax,
        null as first_touch_transactions, null as first_touch_revenue
    from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_transactions`

),

ga_mcf as (

    select 
        date, account, client, 
        '' as last_touch_channel,
        '' as last_touch_platform,
        '' as last_touch_url,
        '' as last_touch_utm_campaign, 
        channel as first_touch_channel, 
        platform as first_touch_platform, 
        campaign as first_touch_utm_campaign, 
        transactionid, 
        null as last_touch_transactions, null as last_touch_revenue,
        null as last_touch_shipping, null as last_touch_tax,
        first_touch_transactions, first_touch_revenue
    from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_mcf_stats`

)


SELECT
    date, 
    client,
    transactionid,
    max(last_touch_channel) last_touch_channel, 
    max(last_touch_platform) last_touch_platform, 
    max(last_touch_url) last_touch_url, 
    max(last_touch_utm_campaign) last_touch_utm_campaign, 
    max(first_touch_channel) first_touch_channel, 
    max(first_touch_platform) first_touch_platform, 
    max(first_touch_utm_campaign) first_touch_utm_campaign,
    sum(last_touch_transactions) last_touch_transactions,
    sum(last_touch_revenue) last_touch_revenue,
    sum(last_touch_shipping) last_touch_shipping_revenue,
    sum(last_touch_tax) last_touch_tax_revenue,
    sum(first_touch_transactions) first_touch_transactions,
    sum(first_touch_revenue) - ifnull(sum(last_touch_shipping),0) - ifnull(sum(last_touch_tax),0) first_touch_revenue
FROM
(
    SELECT *
    FROM 
      ga
    UNION ALL
    SELECT *
    FROM 
      ga_mcf
) 
GROUP BY
    date, client, transactionid
2018-04-17 15:57:26,475: Model SQL (frequency_proc):
WITH transactions AS (

  	SELECT 
	client,
	customer_id,
	order_number,
	date,
	unix_date(date) d
	FROM
	`growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_order_number`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)

SELECT 
client,
'Rolling 365' as period,
date_in_range date,
unix_date_in_range, 
customer_id,
count(distinct(order_number)) frequency
FROM daterange
JOIN transactions
ON transactions.d > ( daterange.unix_date_in_range - 365 )
AND transactions.d <= daterange.unix_date_in_range
group by client, unix_date_in_range, customer_id, date
2018-04-17 15:57:33,138: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b495710>]}
2018-04-17 15:57:33,403: 15:57:33 | 39 of 91 OK created table model agency_data_pipeline.agg_ga_transaction_order_number [CREATE TABLE in 7.70s]
2018-04-17 15:57:38,830: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d8baeb8>]}
2018-04-17 15:57:39,112: 15:57:39 | 40 of 91 OK created table model agency_data_pipeline.frequency_proc.. [CREATE TABLE in 13.39s]
2018-04-17 15:57:39,113: 15:57:39 | 41 of 91 START table model agency_data_pipeline.agg_ga_campaign...... [RUN]
2018-04-17 15:57:39,113: 15:57:39 | 42 of 91 START table model agency_data_pipeline.agg_transaction_line_item_type [RUN]
2018-04-17 15:57:39,113: Compiling model.agency_data_pipeline.agg_ga_campaign
2018-04-17 15:57:39,114: 15:57:39 | 43 of 91 START table model agency_data_pipeline.frequency_stats...... [RUN]
2018-04-17 15:57:39,114: Compiling model.agency_data_pipeline.agg_transaction_line_item_type
2018-04-17 15:57:39,121: Compiling model.agency_data_pipeline.frequency_stats
2018-04-17 15:57:39,122: Writing injected SQL for node "model.agency_data_pipeline.agg_ga_campaign"
2018-04-17 15:57:39,135: Writing injected SQL for node "model.agency_data_pipeline.agg_transaction_line_item_type"
2018-04-17 15:57:39,137: Writing injected SQL for node "model.agency_data_pipeline.frequency_stats"
2018-04-17 15:57:39,138: Acquiring new bigquery connection "agg_ga_campaign".
2018-04-17 15:57:39,138: Re-using an available connection from the pool.
2018-04-17 15:57:39,141: Acquiring new bigquery connection "agg_transaction_line_item_type".
2018-04-17 15:57:39,141: Re-using an available connection from the pool.
2018-04-17 15:57:39,147: Acquiring new bigquery connection "frequency_stats".
2018-04-17 15:57:39,147: Re-using an available connection from the pool.
2018-04-17 15:57:40,156: Model SQL (agg_transaction_line_item_type):
SELECT
client,
product_id,
product_type,
customer_id,
sku,
order_number,
created_at,
final_quantity,
final_price
FROM

( 
	SELECT 
	a.client, 
	a.product_id,
	product_type,
	customer_id,
	a.sku, 
	order_number,
	created_at,
	final_quantity,
	final_price
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_line_item` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`agg_products` b
	ON (
		a.product_id = b.product_id
	  and a.client = b.client
		)

)
2018-04-17 15:57:40,162: Model SQL (frequency_stats):
SELECT
client,
period,
date,
unix_date_in_range,
case when frequency = 1 then '1' 
	when frequency = 2 then '2'
	when frequency > 2 then '2+'
	else null end as frequency_segment,
sum(customers) customers 
FROM (

	SELECT 
	client,
	period,
	date,
	unix_date_in_range, 
	frequency,
	count(distinct(customer_id)) customers
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`frequency_proc`
	group by client, period, date, unix_date_in_range, frequency
)
group by client, period, date, unix_date_in_range, frequency_segment
2018-04-17 15:57:40,167: Model SQL (agg_ga_campaign):
with ga_transactions as (

	select 
		date, account, client, channel, platform, url, 
		campaign,
		null as sessions, null as goal_completions, last_touch_transactions, last_touch_revenue,
		last_touch_shipping, last_touch_tax,
		null as first_touch_transactions, null as first_touch_revenue
	from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_transactions`

),

ga_traffic as (

    select 
        date, account, client, channel, platform, url, 
        campaign,
        sessions, goal_completions, null as last_touch_transactions, null as last_touch_revenue,
        null as last_touch_shipping, null as last_touch_tax,
        null as first_touch_transactions, null as first_touch_revenue
    from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_traffic`

),

ga_mcf as (

	select 
		date, account, client, channel, platform, '' as url,
		campaign, 
		null as sessions, null as goal_completions, null as last_touch_transactions, null as last_touch_revenue,
		null as last_touch_shipping, null as last_touch_tax,
		first_touch_transactions, first_touch_revenue
	from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_mcf_stats`

)


SELECT
    date, 
    client,
    platform,
    channel, 
    url,
    campaign utm_campaign,
	sum(sessions) sessions,
	sum(goal_completions) goal_completions,
	sum(last_touch_transactions) last_touch_transactions,
	sum(last_touch_revenue) last_touch_revenue,
    sum(last_touch_shipping) last_touch_shipping_revenue,
    sum(last_touch_tax) last_touch_tax_revenue,
    sum(first_touch_transactions) first_touch_transactions,
    sum(first_touch_revenue) - sum(ifnull(last_touch_shipping,0)) - sum(ifnull(last_touch_tax,0)) first_touch_revenue

FROM
(
    SELECT *
    FROM 
      ga_transactions
    UNION ALL
    SELECT *
    FROM 
      ga_traffic
    UNION ALL
    SELECT *
    FROM 
      ga_mcf
) 
GROUP BY
    date, client, platform, channel, url, utm_campaign
2018-04-17 15:57:44,625: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b5590b8>]}
2018-04-17 15:57:44,875: 15:57:44 | 42 of 91 OK created table model agency_data_pipeline.agg_transaction_line_item_type [CREATE TABLE in 5.51s]
2018-04-17 15:57:45,780: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d8df518>]}
2018-04-17 15:57:46,027: 15:57:46 | 43 of 91 OK created table model agency_data_pipeline.frequency_stats. [CREATE TABLE in 6.66s]
2018-04-17 15:57:51,356: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d8b7e10>]}
2018-04-17 15:57:51,628: 15:57:51 | 41 of 91 OK created table model agency_data_pipeline.agg_ga_campaign. [CREATE TABLE in 12.24s]
2018-04-17 15:57:51,629: 15:57:51 | 44 of 91 START table model agency_data_pipeline.customers_first_purchase_product_type_proc [RUN]
2018-04-17 15:57:51,629: Compiling model.agency_data_pipeline.customers_first_purchase_product_type_proc
2018-04-17 15:57:51,629: 15:57:51 | 45 of 91 START table model agency_data_pipeline.agg_transaction_product_type [RUN]
2018-04-17 15:57:51,636: Compiling model.agency_data_pipeline.agg_transaction_product_type
2018-04-17 15:57:51,647: Writing injected SQL for node "model.agency_data_pipeline.customers_first_purchase_product_type_proc"
2018-04-17 15:57:51,647: Writing injected SQL for node "model.agency_data_pipeline.agg_transaction_product_type"
2018-04-17 15:57:51,651: Acquiring new bigquery connection "customers_first_purchase_product_type_proc".
2018-04-17 15:57:51,651: Re-using an available connection from the pool.
2018-04-17 15:57:51,655: Acquiring new bigquery connection "agg_transaction_product_type".
2018-04-17 15:57:51,655: Re-using an available connection from the pool.
2018-04-17 15:57:52,589: Model SQL (agg_transaction_product_type):
SELECT
client,
product_type,
customer_id,
order_number,
created_at,
first_value(product_type) over (PARTITION BY client, customer_id, order_number, created_at ORDER BY final_price desc) as top_order_product_type,
final_quantity,
final_price,
sum(final_quantity) over (PARTITION BY client, customer_id, order_number) as total_order_quantity,
sum(final_price) over (PARTITION BY client, customer_id, order_number) as total_order_value
FROM
	(
		SELECT
		client,
		product_type,
		customer_id,
		order_number,
		created_at,
		sum(final_quantity) final_quantity,
		sum(final_price) final_price
		FROM
		`growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_line_item_type`
		GROUP BY
		client,
		product_type,
		customer_id,
		order_number,
		created_at
	)
2018-04-17 15:57:52,628: Model SQL (customers_first_purchase_product_type_proc):
SELECT 
client, 
customer_id, 
product_type,
min(cast(created_at as date)) first_order_date,
unix_date( min(cast(created_at as date))) first_order_unix_date
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_line_item_type`
GROUP BY client, customer_id, product_type
2018-04-17 15:57:55,992: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b529b00>]}
2018-04-17 15:57:56,243: 15:57:56 | 44 of 91 OK created table model agency_data_pipeline.customers_first_purchase_product_type_proc [CREATE TABLE in 4.36s]
2018-04-17 15:57:57,038: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b495320>]}
2018-04-17 15:57:57,306: 15:57:57 | 45 of 91 OK created table model agency_data_pipeline.agg_transaction_product_type [CREATE TABLE in 5.40s]
2018-04-17 15:57:57,307: 15:57:57 | 46 of 91 START table model agency_data_pipeline.order_paths_proc..... [RUN]
2018-04-17 15:57:57,308: Compiling model.agency_data_pipeline.order_paths_proc
2018-04-17 15:57:57,308: 15:57:57 | 47 of 91 START table model agency_data_pipeline.products_proc........ [RUN]
2018-04-17 15:57:57,317: Writing injected SQL for node "model.agency_data_pipeline.order_paths_proc"
2018-04-17 15:57:57,308: 15:57:57 | 48 of 91 START table model agency_data_pipeline.customers_products_proc [RUN]
2018-04-17 15:57:57,317: Compiling model.agency_data_pipeline.products_proc
2018-04-17 15:57:57,318: Compiling model.agency_data_pipeline.customers_products_proc
2018-04-17 15:57:57,334: Writing injected SQL for node "model.agency_data_pipeline.customers_products_proc"
2018-04-17 15:57:57,336: Writing injected SQL for node "model.agency_data_pipeline.products_proc"
2018-04-17 15:57:57,338: Acquiring new bigquery connection "customers_products_proc".
2018-04-17 15:57:57,339: Acquiring new bigquery connection "order_paths_proc".
2018-04-17 15:57:57,339: Re-using an available connection from the pool.
2018-04-17 15:57:57,340: Acquiring new bigquery connection "products_proc".
2018-04-17 15:57:57,346: Re-using an available connection from the pool.
2018-04-17 15:57:57,349: Re-using an available connection from the pool.
2018-04-17 15:57:58,272: Model SQL (customers_products_proc):
WITH customers AS (
  SELECT 
  client, 
  product_id,
  product_type,
  customer_id,
  sku, 
  order_number,
  cast(created_at as date) order_date,
  unix_date(cast(created_at as date)) unix_order_date, 
  final_quantity quantity,
  final_price revenue
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_line_item_type`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)

SELECT 
client,
period,
customer_id,
product_type,
date,
window_end_unix_date,
window_end_unix_date - 365 as window_start_unix_date,
window_end_unix_date - unix_date(recent_order) recency_days,
frequency,
quantity,
revenue,
case when frequency > 0 then revenue/frequency else 0 end as aov
FROM 
(  

  SELECT 
  client,
  'Rolling 365' as period,
  customer_id,
  product_type,
  date_in_range date,
  unix_date_in_range,
  unix_date_in_range window_end_unix_date, 
  max(order_date) recent_order,
  sum(quantity) as quantity,
  sum(revenue) as revenue,
  count(distinct(order_number)) as frequency
  FROM daterange
  JOIN customers
  ON customers.unix_order_date > ( daterange.unix_date_in_range - 365 )
  AND customers.unix_order_date <= daterange.unix_date_in_range
  GROUP BY client, customer_id, date, unix_date_in_range, product_type

  UNION ALL

  SELECT 
  client,
  'Rolling 365 (t-1mo)' as period,
  customer_id,
  product_type,
  date_in_range date,
  unix_date_in_range, 
  unix_date_in_range - 30 window_end_unix_date, 
  max(order_date) recent_order,
  sum(quantity) as quantity,
  sum(revenue) as revenue,
  count(distinct(order_number)) as frequency
  FROM daterange
  JOIN customers
  ON customers.unix_order_date > ( daterange.unix_date_in_range - 395 )
  AND customers.unix_order_date <= ( daterange.unix_date_in_range - 30 )
  GROUP BY client, customer_id, date, unix_date_in_range, product_type

  UNION ALL

  SELECT 
  client,
  'Rolling 365 (t-1yr)' as period,
  customer_id,
  product_type,
  date_in_range date,
  unix_date_in_range, 
  unix_date_in_range - 365 window_end_unix_date, 
  max(order_date) recent_order,
  sum(quantity) as quantity,
  sum(revenue) as revenue,
  count(distinct(order_number)) as frequency
  FROM daterange
  JOIN customers
  ON customers.unix_order_date > ( daterange.unix_date_in_range - 730 )
  AND customers.unix_order_date <= ( daterange.unix_date_in_range - 365 )
  GROUP BY client, customer_id, date, unix_date_in_range, product_type

)
2018-04-17 15:57:58,321: Model SQL (order_paths_proc):
SELECT
client, 
customer_id, 
first_value(product_type) OVER w1 as first_product_type,
nth_value(product_type, 2) OVER w1 as second_product_type,
cast(first_value(created_at) OVER w1 as date) as first_purchase_date,
cast(nth_value(created_at, 2) OVER w1 as date) as second_purchase_date,
cast(nth_value(created_at, 3) OVER w1 as date) as third_purchase_date,
cast(nth_value(created_at, 4) OVER w1 as date) as fourth_purchase_date,
cast(nth_value(created_at, 5) OVER w1 as date) as fifth_purchase_date,
first_value(order_number) OVER w1 as first_order_number,
nth_value(order_number, 2) OVER w1 as second_order_number,
nth_value(order_number, 3) OVER w1 as third_order_number,
nth_value(order_number, 4) OVER w1 as fourth_order_number,
nth_value(order_number, 5) OVER w1 as fifth_order_number,
first_value(total_order_value) OVER w1 as first_order_value,
nth_value(total_order_value, 2) OVER w1 as second_order_value
FROM (
	  
	  SELECT 
	  client, 
	  product_type,
	  customer_id,
	  order_number,
	  created_at, 
	  total_order_value
	  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_product_type`
	  WHERE product_type = top_order_product_type

)
WINDOW w1 as (PARTITION BY client, customer_id ORDER BY created_at asc)
2018-04-17 15:57:58,576: Model SQL (products_proc):
WITH transactions AS (
  SELECT 
  client, 
  product_id,
  product_type,
  customer_id,
  sku, 
  order_number,
  unix_date(cast(created_at as date)) d, 
  final_quantity,
  final_price,
  first_value(unix_date(cast(created_at as date))) over (partition by client, product_id, sku order by created_at desc) first_purchase_unix_date
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_line_item_type`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)

SELECT 
client,
'Last 30' as period,
sku,
product_type,
date_in_range date,
unix_date_in_range, 
case when 
  ( first_purchase_unix_date > ( daterange.unix_date_in_range - 365 ) and first_purchase_unix_date <= daterange.unix_date_in_range )
  then 'New' else 'Existing' end as newness,  
count(distinct(customer_id)) unique_customers,
count(distinct(order_number)) orders,
sum(final_quantity) quantity,
sum(final_price) revenue
FROM daterange
JOIN transactions
ON transactions.d > ( daterange.unix_date_in_range - 30 )
AND transactions.d <= daterange.unix_date_in_range
group by date_in_range, unix_date_in_range, client, sku, product_type, newness

UNION ALL

SELECT 
client,
'Last 90' as period,
sku, 
product_type,
date_in_range date,
unix_date_in_range, 
case when 
  ( first_purchase_unix_date > ( daterange.unix_date_in_range - 365 ) and first_purchase_unix_date <= daterange.unix_date_in_range )
  then 'New' else 'Existing' end as newness,  
count(distinct(customer_id)) unique_customers,
count(distinct(order_number)) orders,
sum(final_quantity) quantity,
sum(final_price) revenue
FROM daterange
JOIN transactions
ON transactions.d > ( daterange.unix_date_in_range - 90 )
AND transactions.d <= daterange.unix_date_in_range
group by date_in_range, unix_date_in_range, client, sku, product_type, newness

UNION ALL

SELECT 
client,
'YoY 30' as date_range,
sku, 
product_type,
date_in_range date,
unix_date_in_range,
case when 
  ( first_purchase_unix_date > ( daterange.unix_date_in_range - 730 ) and first_purchase_unix_date <= ( daterange.unix_date_in_range - 365 ))
  then 'New' else 'Existing' end as newness,   
count(distinct(customer_id)) unique_customers,
count(distinct(order_number)) orders,
sum(final_quantity) quantity,
sum(final_price) revenue
FROM daterange
JOIN transactions
ON transactions.d > ( daterange.unix_date_in_range - 395 )
AND transactions.d <= ( daterange.unix_date_in_range - 365 )
group by date_in_range, unix_date_in_range, client, sku, product_type, newness
2018-04-17 15:58:00,521: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b5593c8>]}
2018-04-17 15:58:01,155: 15:58:01 | 46 of 91 OK created table model agency_data_pipeline.order_paths_proc [CREATE TABLE in 3.21s]
2018-04-17 15:58:07,502: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ce8ee10>]}
2018-04-17 15:58:07,741: 15:58:07 | 47 of 91 OK created table model agency_data_pipeline.products_proc... [CREATE TABLE in 10.18s]
2018-04-17 15:58:33,990: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b4ed1d0>]}
2018-04-17 15:58:34,763: 15:58:34 | 48 of 91 OK created table model agency_data_pipeline.customers_products_proc [CREATE TABLE in 36.67s]
2018-04-17 15:58:34,764: 15:58:34 | 49 of 91 START table model agency_data_pipeline.segment_proc_sku..... [RUN]
2018-04-17 15:58:34,764: 15:58:34 | 50 of 91 START table model agency_data_pipeline.order_paths_agg...... [RUN]
2018-04-17 15:58:34,765: Compiling model.agency_data_pipeline.segment_proc_sku
2018-04-17 15:58:34,765: Compiling model.agency_data_pipeline.order_paths_agg
2018-04-17 15:58:34,775: Writing injected SQL for node "model.agency_data_pipeline.segment_proc_sku"
2018-04-17 15:58:34,780: Writing injected SQL for node "model.agency_data_pipeline.order_paths_agg"
2018-04-17 15:58:34,782: Acquiring new bigquery connection "segment_proc_sku".
2018-04-17 15:58:34,782: Re-using an available connection from the pool.
2018-04-17 15:58:34,783: Acquiring new bigquery connection "order_paths_agg".
2018-04-17 15:58:34,783: Re-using an available connection from the pool.
2018-04-17 15:58:35,698: Model SQL (segment_proc_sku):
SELECT
client,
period,
sku, 
product_type,
date,
unique_customers,
orders,
quantity,
revenue,
case 
	when orders > orders_90pct then 'Best Seller'
	when orders > orders_75pct then 'Good'
	when orders > orders_25pct then 'Average'
	else 'Poor' end as segment,
newness,	
orders_90pct,
orders_75pct,
orders_25pct
FROM
(
	SELECT 
	client,
	period,
	sku, 
	product_type,
	newness,
	date,
	unique_customers,
	orders,
	quantity,
	revenue,
	PERCENTILE_CONT(orders, 0.90) OVER w1 AS orders_90pct,
	PERCENTILE_CONT(orders, 0.75) OVER w1 AS orders_75pct,
	PERCENTILE_CONT(orders, 0.25) OVER w1 AS orders_25pct
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`products_proc`

	WINDOW w1 as (PARTITION BY client, period, date)
)
2018-04-17 15:58:35,788: Model SQL (order_paths_agg):
SELECT
client, 
first_product_type,
second_product_type,
first_purchase_date,
count(distinct(customer_id)) customer_count, 
count(distinct(second_order_number)) second_orders, 
count(distinct(third_order_number)) third_orders, 
count(distinct(fourth_order_number)) fourth_orders, 
count(distinct(fifth_order_number)) fifth_orders, 
sum(date_diff(second_purchase_date, first_purchase_date, DAY)) second_order_latency_days,
sum(date_diff(third_purchase_date, second_purchase_date, DAY)) third_order_latency_days,
sum(date_diff(fourth_purchase_date, third_purchase_date, DAY)) fourth_order_latency_days,
sum(date_diff(fifth_purchase_date, fourth_purchase_date, DAY)) fifth_order_latency_days,
sum(first_order_value) first_order_revenue,
sum(second_order_value) second_order_revenue
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`order_paths_proc`
where second_product_type is not null
GROUP BY client, first_product_type, second_product_type, first_purchase_date
2018-04-17 15:58:37,944: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ce987f0>]}
2018-04-17 15:58:38,004: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ce98470>]}
2018-04-17 15:58:38,205: 15:58:38 | 49 of 91 OK created table model agency_data_pipeline.segment_proc_sku [CREATE TABLE in 3.18s]
2018-04-17 15:58:38,579: 15:58:38 | 50 of 91 OK created table model agency_data_pipeline.order_paths_agg. [CREATE TABLE in 3.24s]
2018-04-17 15:58:38,580: 15:58:38 | 51 of 91 START table model agency_data_pipeline.segment_proc_customers_products [RUN]
2018-04-17 15:58:38,581: 15:58:38 | 52 of 91 START table model agency_data_pipeline.segment_stats_sku.... [RUN]
2018-04-17 15:58:38,581: 15:58:38 | 53 of 91 START table model agency_data_pipeline.agg_ga_transaction... [RUN]
2018-04-17 15:58:38,581: 15:58:38 | 54 of 91 START table model agency_data_pipeline.agg_transaction...... [RUN]
2018-04-17 15:58:38,581: Compiling model.agency_data_pipeline.segment_proc_customers_products
2018-04-17 15:58:38,582: Compiling model.agency_data_pipeline.segment_stats_sku
2018-04-17 15:58:38,582: Compiling model.agency_data_pipeline.agg_ga_transaction
2018-04-17 15:58:38,582: Compiling model.agency_data_pipeline.agg_transaction
2018-04-17 15:58:38,605: Writing injected SQL for node "model.agency_data_pipeline.segment_proc_customers_products"
2018-04-17 15:58:38,607: Writing injected SQL for node "model.agency_data_pipeline.segment_stats_sku"
2018-04-17 15:58:38,616: Writing injected SQL for node "model.agency_data_pipeline.agg_ga_transaction"
2018-04-17 15:58:38,618: Writing injected SQL for node "model.agency_data_pipeline.agg_transaction"
2018-04-17 15:58:38,619: Acquiring new bigquery connection "segment_stats_sku".
2018-04-17 15:58:38,620: Re-using an available connection from the pool.
2018-04-17 15:58:38,621: Acquiring new bigquery connection "agg_transaction".
2018-04-17 15:58:38,621: Re-using an available connection from the pool.
2018-04-17 15:58:38,623: Acquiring new bigquery connection "agg_ga_transaction".
2018-04-17 15:58:38,623: Re-using an available connection from the pool.
2018-04-17 15:58:38,626: Acquiring new bigquery connection "segment_proc_customers_products".
2018-04-17 15:58:38,626: Re-using an available connection from the pool.
2018-04-17 15:58:39,535: Model SQL (agg_ga_transaction):
#done - lookup customer id from transaction id from orders
#done - tag an order as 'new' or 'existing' based on transaction id
#sum lifetime value of that customer id
#first order value for customer
#read from agg_ga_transaction into agg_ga_campaign instead of directly from ga_transactions and ga_mcf_stats


with ga as (

    select 
        date, 
        client, 
        'Last-touch' as attribution,
        channel, 
        platform, 
        url, 
        campaign, 
        transactionid,
        last_touch_transactions transactions, 
        last_touch_revenue + ifnull(last_touch_shipping, 0) + ifnull(last_touch_tax, 0) as revenue
    from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_transactions`

),

ga_mcf as (

    select 
        date, 
        client, 
        'First-touch' as attribution,
        channel, 
        platform, 
        '' as url,
        campaign, 
        transactionid, 
        first_touch_transactions as transactions,
        first_touch_revenue as revenue
    from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_mcf_stats`

)


SELECT
    date, 
    a.client client,
    attribution,
    transactionid,
    b.customer_id customer_id,
    b.order_type order_type,
    b.first_order_revenue first_order_revenue,
    b.lifetime_revenue lifetime_revenue,
    channel,
    platform,
    url,
    campaign,
    transactions,
    revenue
FROM (
    SELECT * FROM ga
    UNION ALL
    SELECT * FROM ga_mcf
) a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`customers_by_transaction` b
ON (
    a.client = b.client AND
    a.transactionid = b.order_number
)
2018-04-17 15:58:39,542: Model SQL (segment_stats_sku):
WITH last_30 as (

	SELECT
	client,
	sku, 
	product_type,
	date,
	unique_customers as customers_30,
	orders as orders_30,
	revenue as revenue_30,
	segment as segment_30,
	newness as newness_30,
	0 as customers_90,
	0 as orders_90,
	0 as revenue_90,
	'' as segment_90,
	0 as customers_yoy_30,
	0 as orders_yoy_30,
	0 as revenue_yoy_30,
	'' as segment_yoy_30
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_sku`
	WHERE period = 'Last 30'

),

last_90 as (

	SELECT
	client,
	sku, 
	product_type,
	date,
	0 as customers_30,
	0 as orders_30,
	0 as revenue_30,
	'' as segment_30,
	'' as newness_30,
	unique_customers as customers_90,
	orders as orders_90,
	revenue as revenue_90,
	segment as segment_90,
	0 as customers_yoy_30,
	0 as orders_yoy_30,
	0 as revenue_yoy_30,
	'' as segment_yoy_30
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_sku`
	WHERE period = 'Last 90'

),

yoy_30 as (

	SELECT
	client,
	sku, 
	product_type,
	date,
	0 as customers_30,
	0 as orders_30,
	0 as revenue_30,
	'' as segment_30,
	'' as newness_30,
	0 as customers_90,
	0 as orders_90,
	0 as revenue_90,
	'' as segment_90,
	unique_customers as customers_yoy_30,
	orders as orders_yoy_30,
	revenue as revenue_yoy_30,
	segment as segment_yoy_30
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_sku`
	WHERE period = 'YoY 30'

)

SELECT
client,
sku, 
product_type,
date,
ifnull(sum(customers_30), 0) customers_30,
ifnull(sum(orders_30), 0) orders_30,
ifnull(sum(revenue_30), 0) revenue_30,
ifnull(max(segment_30), '') segment_30,
ifnull(sum(customers_90), 0) customers_90,
ifnull(sum(orders_90), 0) orders_90,
ifnull(sum(revenue_90), 0) revenue_90,
ifnull(max(segment_90),'') segment_90,
ifnull(sum(customers_yoy_30), 0) customers_yoy_30,
ifnull(sum(orders_yoy_30), 0) orders_yoy_30,
ifnull(sum(revenue_yoy_30), 0) revenue_yoy_30,
case when max(newness_30) = 'New' then 'New'
	else ifnull(max(segment_yoy_30), '') end as segment_yoy_30
FROM
(
	SELECT * FROM last_30
	UNION ALL
	SELECT * FROM last_90
	UNION ALL
	SELECT * FROM yoy_30

)
GROUP BY client, sku, product_type, date
2018-04-17 15:58:39,544: Model SQL (agg_transaction):
SELECT
client,
date,
customer_id,
order_number,
last_touch_channel,
last_touch_platform,
last_touch_url,
first_touch_channel, 
first_touch_platform, 
first_touch_utm_campaign,
ifnull( sum(last_touch_transactions), 0) last_touch_transactions, 
ifnull( sum(last_touch_revenue), 0) last_touch_revenue, 
ifnull( sum(first_touch_transactions), 0) first_touch_transactions, 
ifnull( sum(first_touch_revenue), 0) first_touch_revenue,
ifnull( sum(final_quantity), 0) quantity,
ifnull( sum(final_price), 0) revenue,
ifnull( sum(shipping_price), 0) shipping_revenue,
ROW_NUMBER() OVER (PARTITION BY client, customer_id, order_number ORDER BY date asc) AS order_sequence
FROM
(
	SELECT
	a.client,
	a.date date,
	b.date ga_date,
	a.customer_id,
	a.order_number,
	transactionid,
	b.last_touch_channel,
	b.last_touch_platform,
	b.last_touch_url,
	b.first_touch_channel, 
	b.first_touch_platform, 
	b.first_touch_utm_campaign, 
	last_touch_transactions, 
	last_touch_revenue, 
	first_touch_transactions, 
	first_touch_revenue,
	final_quantity,
	final_price,
	shipping_price
	FROM
	`growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_order_number` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`agg_ga_transaction_order_number` b
	ON (
		a.client = b.client and
		a.order_number = b.transactionid
	)

)
GROUP BY
client, 
date, 
customer_id,
order_number, 
last_touch_channel,
last_touch_platform,
last_touch_url,
first_touch_channel, 
first_touch_platform, 
first_touch_utm_campaign
2018-04-17 15:58:39,649: Model SQL (segment_proc_customers_products):
SELECT
client,
period,
date,
customer_id,
first_order_date,
first_order_unix_date,
product_type,
recency_days,
frequency,
revenue,
quantity,
aov,
case when frequency = 1 and recency_days <= 30 and first_order_unix_date >= window_start_unix_date then 'New'
	when frequency = 1 then 'One-time Purchaser'
	when frequency > frequency_90pct and recency_days < recency_90pct and aov > aov_50pct then 'Champion'
	when recency_days < recency_90pct and frequency > frequency_75pct then 'Potential Loyalists' 
	when frequency > frequency_75pct and recency_days <= recency_50pct then 'Cant Lose'
	when recency_days < recency_50pct and frequency > frequency_50pct then 'Loyal'
	when recency_days > recency_50pct and frequency > frequency_50pct then 'Frequent, not Recent'
	when recency_days < recency_50pct and frequency < frequency_50pct then 'Recent, not Frequent'
	else 'Unbucketed' end as segment,
aov_50pct,
frequency_90pct,
frequency_75pct,
frequency_50pct,
recency_90pct,
recency_75pct,
recency_50pct
FROM
(
	SELECT 
	a.client client,
	period,
	date,
	a.customer_id customer_id,
	a.product_type product_type,
	b.first_order_date first_order_date,
	b.first_order_unix_date first_order_unix_date,
	window_start_unix_date,
	window_end_unix_date,	
	recency_days,
	frequency,
	revenue,
	quantity,
	aov,
	PERCENTILE_CONT(aov, 0.50) OVER w1 AS aov_50pct,
	PERCENTILE_CONT(frequency, 0.90) OVER w1 AS frequency_90pct,
	PERCENTILE_CONT(frequency, 0.75) OVER w1 AS frequency_75pct,
	PERCENTILE_CONT(frequency, 0.90) OVER w1 AS frequency_50pct,
	PERCENTILE_CONT(recency_days, 0.10) OVER w1 AS recency_90pct,
	PERCENTILE_CONT(recency_days, 0.25) OVER w1 AS recency_75pct,
	PERCENTILE_CONT(recency_days, 0.5) OVER w1 AS recency_50pct
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`customers_products_proc` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`customers_first_purchase_product_type_proc` b
	ON (
		a.client = b.client and
		a.customer_id = b.customer_id and
		a.product_type = b.product_type
		)
	WINDOW w1 as (PARTITION BY a.client, period, date, a.product_type)
)
2018-04-17 15:58:42,903: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b4956a0>]}
2018-04-17 15:58:43,160: 15:58:43 | 52 of 91 OK created table model agency_data_pipeline.segment_stats_sku [CREATE TABLE in 4.32s]
2018-04-17 15:58:45,119: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d928320>]}
2018-04-17 15:58:45,126: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d8baf60>]}
2018-04-17 15:58:45,360: 15:58:45 | 54 of 91 OK created table model agency_data_pipeline.agg_transaction. [CREATE TABLE in 6.54s]
2018-04-17 15:58:45,615: 15:58:45 | 53 of 91 OK created table model agency_data_pipeline.agg_ga_transaction [CREATE TABLE in 6.54s]
2018-04-17 15:59:04,011: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b4ed1d0>]}
2018-04-17 15:59:04,839: 15:59:04 | 51 of 91 OK created table model agency_data_pipeline.segment_proc_customers_products [CREATE TABLE in 25.43s]
2018-04-17 15:59:04,840: 15:59:04 | 55 of 91 START table model agency_data_pipeline.agg_ga_campaign_by_type [RUN]
2018-04-17 15:59:04,841: 15:59:04 | 56 of 91 START table model agency_data_pipeline.segment_stats_category [RUN]
2018-04-17 15:59:04,841: 15:59:04 | 57 of 91 START table model agency_data_pipeline.customers_first_purchase_proc [RUN]
2018-04-17 15:59:04,841: 15:59:04 | 58 of 91 START table model agency_data_pipeline.agg_transaction_daily [RUN]
2018-04-17 15:59:04,841: Compiling model.agency_data_pipeline.agg_ga_campaign_by_type
2018-04-17 15:59:04,841: Compiling model.agency_data_pipeline.segment_stats_category
2018-04-17 15:59:04,842: Compiling model.agency_data_pipeline.customers_first_purchase_proc
2018-04-17 15:59:04,842: Compiling model.agency_data_pipeline.agg_transaction_daily
2018-04-17 15:59:04,855: Writing injected SQL for node "model.agency_data_pipeline.agg_ga_campaign_by_type"
2018-04-17 15:59:04,855: Writing injected SQL for node "model.agency_data_pipeline.segment_stats_category"
2018-04-17 15:59:04,860: Writing injected SQL for node "model.agency_data_pipeline.customers_first_purchase_proc"
2018-04-17 15:59:04,864: Writing injected SQL for node "model.agency_data_pipeline.agg_transaction_daily"
2018-04-17 15:59:04,868: Acquiring new bigquery connection "segment_stats_category".
2018-04-17 15:59:04,868: Re-using an available connection from the pool.
2018-04-17 15:59:04,869: Acquiring new bigquery connection "agg_ga_campaign_by_type".
2018-04-17 15:59:04,869: Re-using an available connection from the pool.
2018-04-17 15:59:04,874: Acquiring new bigquery connection "agg_transaction_daily".
2018-04-17 15:59:04,874: Re-using an available connection from the pool.
2018-04-17 15:59:04,876: Acquiring new bigquery connection "customers_first_purchase_proc".
2018-04-17 15:59:04,877: Re-using an available connection from the pool.
2018-04-17 15:59:05,873: Model SQL (segment_stats_category):
SELECT
client,
product_type,
date,
segment_30,
segment_90,
segment_yoy_30,
ifnull(sum(customers_30), 0) customers_30,
ifnull(sum(orders_30), 0) orders_30,
ifnull(sum(revenue_30), 0) revenue_30,
ifnull(sum(customers_90), 0) customers_90,
ifnull(sum(orders_90), 0) orders_90,
ifnull(sum(revenue_90), 0) revenue_90,
ifnull(sum(customers_yoy_30), 0) customers_yoy_30,
ifnull(sum(orders_yoy_30), 0) orders_yoy_30,
ifnull(sum(revenue_yoy_30), 0) revenue_yoy_30
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`segment_stats_sku`
GROUP BY client, product_type, date, segment_30, segment_90, segment_yoy_30
2018-04-17 15:59:05,874: Model SQL (agg_ga_campaign_by_type):
with orders_new as (
    select 
    date, 
    client, 
    attribution,
    channel, 
    platform, 
    url, 
    campaign,
    count(distinct(customer_id)) customers_new,
    sum(transactions) transactions_new,
    sum(revenue) revenue_new,
    sum(first_order_revenue) first_order_revenue_new,
    sum(lifetime_revenue) lifetime_revenue_new,
    null as customers_total,
    null as transactions_total,
    null as revenue_total
    from `growth-engines-pipeline`.`agency_data_pipeline`.`agg_ga_transaction`
    where order_type = 'New'
    group by date, client, attribution, channel, platform, url, campaign
),
    
orders_total as (
    select 
    date, 
    client, 
    attribution,
    channel, 
    platform, 
    url, 
    campaign,
    null as customers_new,
    null as transactions_new,
    null as revenue_new,
    null as first_order_revenue_new,
    null as lifetime_revenue_new,
    count(distinct(customer_id)) customers_total,
    sum(transactions) transactions_total,
    sum(revenue) revenue_total
    from `growth-engines-pipeline`.`agency_data_pipeline`.`agg_ga_transaction`
    group by date, client, attribution, channel, platform, url, campaign

)

SELECT 
date, 
client, 
attribution,
channel, 
platform, 
url, 
campaign,
sum(customers_new) customers_new,
sum(transactions_new) transactions_new,
sum(revenue_new) revenue_new,
sum(first_order_revenue_new) first_order_revenue_new,
sum(lifetime_revenue_new) lifetime_revenue_new,
sum(customers_total) customers_total,
sum(transactions_total) transactions_total,
sum(revenue_total) revenue_total
from
    ( 
        SELECT * FROM orders_new
        UNION ALL 
        SELECT * FROM orders_total
    )
group by date, client, attribution, channel, platform, url, campaign
2018-04-17 15:59:05,874: Model SQL (customers_first_purchase_proc):
SELECT 
client, 
customer_id, 
min(cast(date as date)) first_order_date,
unix_date( min(cast(date as date))) first_order_unix_date
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction`
GROUP BY client, customer_id
2018-04-17 15:59:05,875: Model SQL (agg_transaction_daily):
SELECT
client,
date,
customer_id,
sum(last_touch_transactions) last_touch_transactions, 
sum(last_touch_revenue) last_touch_revenue, 
sum(first_touch_transactions) first_touch_transactions, 
sum(first_touch_revenue) first_touch_revenue,
sum(quantity) quantity,
sum(revenue) revenue,
count(distinct(order_number)) order_count
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction`
GROUP BY
client, 
date, 
customer_id
2018-04-17 15:59:06,998: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b495320>]}
2018-04-17 15:59:07,358: 15:59:07 | 56 of 91 OK created table model agency_data_pipeline.segment_stats_category [CREATE TABLE in 2.16s]
2018-04-17 15:59:07,359: 15:59:07 | 59 of 91 START table model agency_data_pipeline.segment_stats_customers_products_agg [RUN]
2018-04-17 15:59:07,359: Compiling model.agency_data_pipeline.segment_stats_customers_products_agg
2018-04-17 15:59:07,370: Writing injected SQL for node "model.agency_data_pipeline.segment_stats_customers_products_agg"
2018-04-17 15:59:07,371: Acquiring new bigquery connection "segment_stats_customers_products_agg".
2018-04-17 15:59:07,371: Re-using an available connection from the pool.
2018-04-17 15:59:08,090: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d93be48>]}
2018-04-17 15:59:08,347: Model SQL (segment_stats_customers_products_agg):
WITH ty as (

	SELECT
	client,
	date,
	customer_id,
	product_type,
	segment as segment_365,
	recency_days as recency_365,
	frequency as frequency_365,
	revenue as revenue_365,
	aov as aov_365,
	'' as segment_mom,
	0 as recency_mom,
	0 as frequency_mom,
	0 as revenue_mom,
	0 as aov_mom,
	'' as segment_yoy,
	0 as recency_yoy,
	0 as frequency_yoy,
	0 as revenue_yoy,
	0 as aov_yoy
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers_products`
	WHERE period = 'Rolling 365'

),

last_month as (

	SELECT
	client,
	date,
	customer_id,
	product_type,
	'' as segment_365,
	0 as recency_365,
	0 as frequency_365,
	0 as revenue_365,
	0 as aov_365,
	segment as segment_mom,
	recency_days as recency_mom,
	frequency as frequency_mom,
	revenue as revenue_mom,
	aov as aov_mom,
	'' as segment_yoy,
	0 as recency_yoy,
	0 as frequency_yoy,
	0 as revenue_yoy,
	0 as aov_yoy
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers_products`
	WHERE period = 'Rolling 365 (t-1mo)'

),

this_month_1yr as (

	SELECT
	client,
	date,
	customer_id,
	product_type,
	'' as segment_365,
	0 as recency_365,
	0 as frequency_365,
	0 as revenue_365,
	0 as aov_365,
	'' as segment_mom,
	0 as recency_mom,
	0 as frequency_mom,
	0 as revenue_mom,
	0 as aov_mom,
	segment as segment_yoy,
	recency_days as recency_yoy,
	frequency as frequency_yoy,
	revenue as revenue_yoy,
	aov as aov_yoy
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers_products`
	WHERE period = 'Rolling 365 (t-1yr)'


)

SELECT
client,
date, 
customer_id,
product_type,
ifnull(max(segment_365), '') segment_365,
ifnull(max(segment_mom), '') segment_mom,
ifnull(max(segment_yoy), '') segment_yoy,
ifnull(sum(recency_365), 0) recency_365,
ifnull(sum(frequency_365), 0) frequency_365,
ifnull(sum(revenue_365), 0) revenue_365,
ifnull(sum(aov_365), 0) aov_365,
ifnull(sum(recency_mom), 0) recency_mom,
ifnull(sum(frequency_mom), 0) frequency_mom,
ifnull(sum(revenue_mom), 0) revenue_mom,
ifnull(sum(aov_mom), 0) aov_mom,	
ifnull(sum(recency_yoy), 0) recency_yoy,
ifnull(sum(frequency_yoy), 0) frequency_yoy,
ifnull(sum(revenue_yoy), 0) revenue_yoy,
ifnull(sum(aov_yoy), 0) aov_yoy
FROM
(
	SELECT * FROM ty
	UNION ALL
	SELECT * FROM last_month
	UNION ALL
	SELECT * FROM this_month_1yr

)
GROUP BY client, date, customer_id, product_type
2018-04-17 15:59:08,452: 15:59:08 | 57 of 91 OK created table model agency_data_pipeline.customers_first_purchase_proc [CREATE TABLE in 3.25s]
2018-04-17 15:59:08,453: 15:59:08 | 60 of 91 START table model agency_data_pipeline.order_paths_stats.... [RUN]
2018-04-17 15:59:08,453: Compiling model.agency_data_pipeline.order_paths_stats
2018-04-17 15:59:08,462: Writing injected SQL for node "model.agency_data_pipeline.order_paths_stats"
2018-04-17 15:59:08,463: Acquiring new bigquery connection "order_paths_stats".
2018-04-17 15:59:08,463: Re-using an available connection from the pool.
2018-04-17 15:59:09,261: Model SQL (order_paths_stats):
WITH transactions AS (
  SELECT 
  client, 
  first_product_type,
  second_product_type,
  first_purchase_date,
  customer_count,
  second_orders,
  third_orders,
  fourth_orders,
  fifth_orders,
  second_order_latency_days,
  third_order_latency_days,
  fourth_order_latency_days,
  fifth_order_latency_days,
  first_order_revenue,
  second_order_revenue,
  unix_date(cast(first_purchase_date as date)) d
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`order_paths_agg`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)

SELECT 
client,
'Rolling 365' as period,
first_product_type,
second_product_type,
date_in_range date,
unix_date_in_range, 
sum(customer_count) customer_count,
sum(second_orders) second_orders,
sum(third_orders) third_orders,
sum(fourth_orders) fourth_orders,
sum(fifth_orders) fifth_orders,
sum(second_order_latency_days) second_order_latency_days,
sum(third_order_latency_days) third_order_latency_days,
sum(fourth_order_latency_days) fourth_order_latency_days,
sum(fifth_order_latency_days) fifth_order_latency_days,
sum(first_order_revenue) first_order_revenue,
sum(second_order_revenue) second_order_revenue
FROM daterange
JOIN transactions
ON transactions.d > ( daterange.unix_date_in_range - 365 )
AND transactions.d <= daterange.unix_date_in_range
group by client, first_product_type, second_product_type, date_in_range, unix_date_in_range
2018-04-17 15:59:11,579: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d929dd8>]}
2018-04-17 15:59:11,842: 15:59:11 | 60 of 91 OK created table model agency_data_pipeline.order_paths_stats [CREATE TABLE in 3.13s]
2018-04-17 15:59:12,510: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b508828>]}
2018-04-17 15:59:12,810: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ceaa438>]}
2018-04-17 15:59:12,818: 15:59:12 | 55 of 91 OK created table model agency_data_pipeline.agg_ga_campaign_by_type [CREATE TABLE in 7.67s]
2018-04-17 15:59:13,091: 15:59:13 | 58 of 91 OK created table model agency_data_pipeline.agg_transaction_daily [CREATE TABLE in 7.97s]
2018-04-17 15:59:33,294: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d948860>]}
2018-04-17 15:59:33,581: 15:59:33 | 59 of 91 OK created table model agency_data_pipeline.segment_stats_customers_products_agg [CREATE TABLE in 25.93s]
2018-04-17 15:59:33,583: 15:59:33 | 61 of 91 START table model agency_data_pipeline.segment_stats_customers_products [RUN]
2018-04-17 15:59:33,583: Compiling model.agency_data_pipeline.segment_stats_customers_products
2018-04-17 15:59:33,591: 15:59:33 | 62 of 91 START table model agency_data_pipeline.customers_proc....... [RUN]
2018-04-17 15:59:33,591: Compiling model.agency_data_pipeline.customers_proc
2018-04-17 15:59:33,591: 15:59:33 | 63 of 91 START table model agency_data_pipeline.growth_customer_0_365 [RUN]
2018-04-17 15:59:33,605: Compiling model.agency_data_pipeline.growth_customer_0_365
2018-04-17 15:59:33,614: Writing injected SQL for node "model.agency_data_pipeline.segment_stats_customers_products"
2018-04-17 15:59:33,620: Acquiring new bigquery connection "segment_stats_customers_products".
2018-04-17 15:59:33,621: Re-using an available connection from the pool.
2018-04-17 15:59:33,628: Writing injected SQL for node "model.agency_data_pipeline.growth_customer_0_365"
2018-04-17 15:59:33,629: Writing injected SQL for node "model.agency_data_pipeline.customers_proc"
2018-04-17 15:59:33,633: Acquiring new bigquery connection "growth_customer_0_365".
2018-04-17 15:59:33,633: Re-using an available connection from the pool.
2018-04-17 15:59:33,634: Acquiring new bigquery connection "customers_proc".
2018-04-17 15:59:33,635: Re-using an available connection from the pool.
2018-04-17 15:59:34,623: Model SQL (segment_stats_customers_products):
SELECT
client,
date,
product_type,
segment_365,
segment_mom,
segment_yoy,
count(distinct(customer_id)) customers,
avg(recency_365) recency_365,
sum(frequency_365) frequency_365,
sum(revenue_365) revenue_365,
case when sum(frequency_365) > 0 then sum(revenue_365)/sum(frequency_365) else null end as aov_365,
avg(recency_mom) recency_mom,
sum(frequency_mom) frequency_mom,
sum(revenue_mom) revenue_mom,
case when sum(frequency_mom) > 0 then sum(revenue_mom)/sum(frequency_mom) else null end as aov_mom,
avg(recency_yoy) recency_yoy,
sum(frequency_yoy) frequency_yoy,
sum(revenue_yoy) revenue_yoy,
case when sum(frequency_yoy) > 0 then sum(revenue_yoy)/sum(frequency_yoy) else null end as aov_yoy
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_stats_customers_products_agg`
GROUP BY client, date, product_type, segment_365, segment_mom, segment_yoy
2018-04-17 15:59:34,624: Model SQL (customers_proc):
WITH customers AS (
  SELECT 
  client, 
  customer_id, 
  order_number,
  cast(date as date) order_date,
  unix_date(cast(date as date)) unix_order_date, 
  quantity,
  revenue 
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)
 
SELECT 
client,
period,
customer_id,
date,
window_end_unix_date,
window_end_unix_date - 365 as window_start_unix_date,
window_end_unix_date - unix_date(recent_order) recency_days,
frequency,
quantity,
revenue,
case when frequency > 0 then revenue/frequency else 0 end as aov
FROM 
(  

  SELECT 
  client,
  'Rolling 365' as period,
  customer_id,
  date_in_range date,
  unix_date_in_range,
  unix_date_in_range window_end_unix_date,
  max(order_date) recent_order,
  sum(quantity) as quantity,
  sum(revenue) as revenue,
  count(distinct(order_number)) as frequency
  FROM daterange
  JOIN customers
  ON customers.unix_order_date > ( daterange.unix_date_in_range - 365 )
  AND customers.unix_order_date <= daterange.unix_date_in_range
  GROUP BY client, customer_id, date, unix_date_in_range

  UNION ALL

  SELECT 
  client,
  'Rolling 365 (t-1mo)' as period,
  customer_id,
  date_in_range date,
  unix_date_in_range,
  unix_date_in_range - 30 window_end_unix_date, 
  max(order_date) recent_order,
  sum(quantity) as quantity,
  sum(revenue) as revenue,
  count(distinct(order_number)) as frequency
  FROM daterange
  JOIN customers
  ON customers.unix_order_date > ( daterange.unix_date_in_range - 395 )
  AND customers.unix_order_date <= ( daterange.unix_date_in_range - 30 )
  GROUP BY client, customer_id, date, unix_date_in_range

  UNION ALL

  SELECT 
  client,
  'Rolling 365 (t-1yr)' as period,
  customer_id,
  date_in_range date,
  unix_date_in_range, 
  unix_date_in_range - 365 window_end_unix_date, 
  max(order_date) recent_order,
  sum(quantity) as quantity,
  sum(revenue) as revenue,
  count(distinct(order_number)) as frequency
  FROM daterange
  JOIN customers
  ON customers.unix_order_date > ( daterange.unix_date_in_range - 730 )
  AND customers.unix_order_date <= ( daterange.unix_date_in_range - 365 )
  GROUP BY client, customer_id, date, unix_date_in_range

)
2018-04-17 15:59:34,771: Model SQL (growth_customer_0_365):
WITH transactions AS (
  SELECT 
  client, 
  customer_id, 
  order_number,
  unix_date(cast(date as date)) d, 
  quantity,
  revenue,
  shipping_revenue
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)

SELECT 
date_in_range date,
unix_date_in_range, 
unix_date_in_range_yoy, 
client, 
customer_id,
count(distinct(order_number)) orders,
sum(quantity) quantity,
sum(revenue) revenue,
sum(shipping_revenue) shipping_revenue
FROM daterange
JOIN transactions
ON transactions.d >= ( daterange.unix_date_in_range - 365 ) 
AND transactions.d <= daterange.unix_date_in_range
GROUP BY date, unix_date_in_range, unix_date_in_range_yoy, client, customer_id
2018-04-17 15:59:47,002: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b4ed1d0>]}
2018-04-17 15:59:47,943: 15:59:47 | 61 of 91 OK created table model agency_data_pipeline.segment_stats_customers_products [CREATE TABLE in 13.42s]
2018-04-17 15:59:53,238: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b5593c8>]}
2018-04-17 15:59:53,502: 15:59:53 | 63 of 91 OK created table model agency_data_pipeline.growth_customer_0_365 [CREATE TABLE in 19.63s]
2018-04-17 16:00:36,654: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d8cfac8>]}
2018-04-17 16:00:37,324: 16:00:37 | 62 of 91 OK created table model agency_data_pipeline.customers_proc.. [CREATE TABLE in 63.06s]
2018-04-17 16:00:37,326: 16:00:37 | 64 of 91 START table model agency_data_pipeline.retention_730_plus... [RUN]
2018-04-17 16:00:37,328: Compiling model.agency_data_pipeline.retention_730_plus
2018-04-17 16:00:37,327: 16:00:37 | 65 of 91 START table model agency_data_pipeline.retention_365_730.... [RUN]
2018-04-17 16:00:37,333: Compiling model.agency_data_pipeline.retention_365_730
2018-04-17 16:00:37,327: 16:00:37 | 66 of 91 START table model agency_data_pipeline.retention_0_30....... [RUN]
2018-04-17 16:00:37,342: Writing injected SQL for node "model.agency_data_pipeline.retention_730_plus"
2018-04-17 16:00:37,347: Writing injected SQL for node "model.agency_data_pipeline.retention_365_730"
2018-04-17 16:00:37,348: Compiling model.agency_data_pipeline.retention_0_30
2018-04-17 16:00:37,327: 16:00:37 | 67 of 91 START table model agency_data_pipeline.retention_60_plus.... [RUN]
2018-04-17 16:00:37,354: Writing injected SQL for node "model.agency_data_pipeline.retention_0_30"
2018-04-17 16:00:37,355: Compiling model.agency_data_pipeline.retention_60_plus
2018-04-17 16:00:37,361: Writing injected SQL for node "model.agency_data_pipeline.retention_60_plus"
2018-04-17 16:00:37,363: Acquiring new bigquery connection "retention_365_730".
2018-04-17 16:00:37,364: Acquiring new bigquery connection "retention_730_plus".
2018-04-17 16:00:37,364: Re-using an available connection from the pool.
2018-04-17 16:00:37,365: Acquiring new bigquery connection "retention_60_plus".
2018-04-17 16:00:37,366: Acquiring new bigquery connection "retention_0_30".
2018-04-17 16:00:37,370: Re-using an available connection from the pool.
2018-04-17 16:00:37,373: Re-using an available connection from the pool.
2018-04-17 16:00:37,374: Re-using an available connection from the pool.
2018-04-17 16:00:38,842: Model SQL (retention_730_plus):
WITH transactions AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_daily`
),

daterange AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`  	
),

temp AS (
  SELECT 
  client, 
  customer_id, 
  unix_date(date) d, 
  quantity,
  revenue,
  order_count
  FROM transactions
)

SELECT 
date_in_range date, 
unix_date_in_range,
client, 
customer_id,
sum(quantity) quantity,
sum(revenue) revenue,
sum(order_count) order_count
FROM daterange
JOIN temp
ON temp.d <= ( daterange.unix_date_in_range - 730 ) 
group by date_in_range, unix_date_in_range, client, customer_id
2018-04-17 16:00:38,844: Model SQL (retention_60_plus):
WITH transactions AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_daily`
),

daterange AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`  	
),

temp AS (
  SELECT 
  client, 
  customer_id, 
  unix_date(date) d, 
  quantity,
  revenue,
  order_count
  FROM transactions
)

SELECT 
date_in_range date, 
unix_date_in_range,
client, 
customer_id,
sum(quantity) quantity,
sum(revenue) revenue,
sum(order_count) order_count
FROM daterange
JOIN temp
ON temp.d < ( daterange.unix_date_in_range_bom_mom ) 
group by date_in_range, unix_date_in_range, client, customer_id
2018-04-17 16:00:38,844: Model SQL (retention_0_30):
WITH transactions AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_daily`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
),

temp AS (
  SELECT 
  client, 
  customer_id, 
  unix_date(date) d, 
  quantity,
  revenue,
  order_count
  FROM transactions
)

SELECT 
date_in_range date,
unix_date_in_range, 
client, 
customer_id,
sum(quantity) quantity,
sum(revenue) revenue,
sum(order_count) order_count
FROM daterange
JOIN temp
ON temp.d >= ( daterange.unix_date_in_range_bom ) 
AND temp.d <= daterange.unix_date_in_range
group by date_in_range, unix_date_in_range, client, customer_id
2018-04-17 16:00:38,845: Model SQL (retention_365_730):
WITH transactions AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_daily`
),

daterange AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`  	
),

temp AS (
  SELECT 
  client, 
  customer_id, 
  unix_date(date) d, 
  quantity,
  revenue,
  order_count
  FROM transactions
)

SELECT 
date_in_range date, 
unix_date_in_range,
client, 
customer_id,
sum(quantity) quantity,
sum(revenue) revenue,
sum(order_count) order_count
FROM daterange
JOIN temp
ON ( temp.d >= ( daterange.unix_date_in_range - 730 ) 
AND temp.d < ( daterange.unix_date_in_range - 365 ) )
group by date_in_range, unix_date_in_range, client, customer_id
2018-04-17 16:00:41,077: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b501a20>]}
2018-04-17 16:00:41,632: 16:00:41 | 64 of 91 OK created table model agency_data_pipeline.retention_730_plus [CREATE TABLE in 3.75s]
2018-04-17 16:00:41,639: 16:00:41 | 68 of 91 START table model agency_data_pipeline.retention_0_365...... [RUN]
2018-04-17 16:00:41,639: Compiling model.agency_data_pipeline.retention_0_365
2018-04-17 16:00:41,653: Writing injected SQL for node "model.agency_data_pipeline.retention_0_365"
2018-04-17 16:00:41,658: Acquiring new bigquery connection "retention_0_365".
2018-04-17 16:00:41,658: Re-using an available connection from the pool.
2018-04-17 16:00:42,591: Model SQL (retention_0_365):
WITH transactions AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_daily`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
),

temp AS (
  SELECT 
  client, 
  customer_id, 
  unix_date(date) d, 
  quantity,
  revenue,
  order_count
  FROM transactions
)

SELECT 
date_in_range date,
unix_date_in_range, 
client, 
customer_id,
sum(quantity) quantity,
sum(revenue) revenue,
sum(order_count) order_count
FROM daterange
JOIN temp
ON temp.d >= ( daterange.unix_date_in_range - 365 ) 
AND temp.d <= daterange.unix_date_in_range
group by date_in_range, unix_date_in_range, client, customer_id
2018-04-17 16:00:43,335: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d8cfe10>]}
2018-04-17 16:00:43,388: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b529cc0>]}
2018-04-17 16:00:43,620: 16:00:43 | 66 of 91 OK created table model agency_data_pipeline.retention_0_30.. [CREATE TABLE in 5.99s]
2018-04-17 16:00:43,621: 16:00:43 | 69 of 91 START table model agency_data_pipeline.segment_list_customers_products [RUN]
2018-04-17 16:00:43,622: Compiling model.agency_data_pipeline.segment_list_customers_products
2018-04-17 16:00:43,631: Writing injected SQL for node "model.agency_data_pipeline.segment_list_customers_products"
2018-04-17 16:00:43,633: Acquiring new bigquery connection "segment_list_customers_products".
2018-04-17 16:00:43,634: Re-using an available connection from the pool.
2018-04-17 16:00:43,890: 16:00:43 | 65 of 91 OK created table model agency_data_pipeline.retention_365_730 [CREATE TABLE in 6.05s]
2018-04-17 16:00:43,890: 16:00:43 | 70 of 91 START table model agency_data_pipeline.retention_30_60...... [RUN]
2018-04-17 16:00:43,891: Compiling model.agency_data_pipeline.retention_30_60
2018-04-17 16:00:43,901: Writing injected SQL for node "model.agency_data_pipeline.retention_30_60"
2018-04-17 16:00:43,902: Acquiring new bigquery connection "retention_30_60".
2018-04-17 16:00:43,903: Re-using an available connection from the pool.
2018-04-17 16:00:44,819: Model SQL (segment_list_customers_products):
SELECT
a.client,
period,
date,
customer_id,
product_type,
b.first_name,
b.last_name,
b.email,
recency_days,
frequency,
revenue,
quantity,
aov,
segment
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers_products` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`agg_customers_union` b
ON (
	a.client = b.client AND
	a.customer_id = b.id
)
2018-04-17 16:00:44,954: Model SQL (retention_30_60):
WITH transactions AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_daily`
),

daterange AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`  	
),

temp AS (
  SELECT 
  client, 
  customer_id, 
  unix_date(date) d, 
  quantity,
  revenue,
  order_count
  FROM transactions
)

SELECT 
date_in_range date, 
unix_date_in_range,
client, 
customer_id,
sum(quantity) quantity,
sum(revenue) revenue,
sum(order_count) order_count
FROM daterange
JOIN temp
ON ( temp.d >= ( daterange.unix_date_in_range_bom_mom ) 
AND temp.d < ( daterange.unix_date_in_range_bom ) )
group by date_in_range, unix_date_in_range, client, customer_id
2018-04-17 16:00:48,318: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b529cc0>]}
2018-04-17 16:00:48,739: 16:00:48 | 70 of 91 OK created table model agency_data_pipeline.retention_30_60. [CREATE TABLE in 4.43s]
2018-04-17 16:00:51,193: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b559a90>]}
2018-04-17 16:00:51,467: 16:00:51 | 67 of 91 OK created table model agency_data_pipeline.retention_60_plus [CREATE TABLE in 13.84s]
2018-04-17 16:00:53,910: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b501a20>]}
2018-04-17 16:00:54,274: 16:00:54 | 68 of 91 OK created table model agency_data_pipeline.retention_0_365. [CREATE TABLE in 12.27s]
2018-04-17 16:01:24,747: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d8cfe10>]}
2018-04-17 16:01:25,019: 16:01:25 | 69 of 91 OK created table model agency_data_pipeline.segment_list_customers_products [CREATE TABLE in 41.13s]
2018-04-17 16:01:25,020: 16:01:25 | 71 of 91 START table model agency_data_pipeline.agg_platforms_union.. [RUN]
2018-04-17 16:01:25,020: 16:01:25 | 72 of 91 START table model agency_data_pipeline.segment_proc_customers [RUN]
2018-04-17 16:01:25,020: Compiling model.agency_data_pipeline.agg_platforms_union
2018-04-17 16:01:25,021: Compiling model.agency_data_pipeline.segment_proc_customers
2018-04-17 16:01:25,031: Writing injected SQL for node "model.agency_data_pipeline.agg_platforms_union"
2018-04-17 16:01:25,045: Writing injected SQL for node "model.agency_data_pipeline.segment_proc_customers"
2018-04-17 16:01:25,048: Acquiring new bigquery connection "agg_platforms_union".
2018-04-17 16:01:25,049: Acquiring new bigquery connection "segment_proc_customers".
2018-04-17 16:01:25,049: Re-using an available connection from the pool.
2018-04-17 16:01:25,050: Re-using an available connection from the pool.
2018-04-17 16:01:28,091: Model SQL (agg_platforms_union):
SELECT 
date, 
account, 
channel,
platform,
url,
utm_campaign,
campaign,
cost,
impressions,
clicks,
transactions
FROM 
`growth-engines-pipeline`.`agency_data_pipeline`.`adwords_stats`

UNION ALL

SELECT 
date, 
account, 
channel,
platform,
url,
utm_campaign,
campaign,
cost,
impressions,
clicks,
transactions
FROM 
`growth-engines-pipeline`.`agency_data_pipeline`.`bing_ads_stats`

UNION ALL  

SELECT 
date, 
account, 
channel,
platform,
url,
utm_campaign,
campaign,
cost,
impressions,
clicks,
transactions
FROM 
`growth-engines-pipeline`.`agency_data_pipeline`.`fb_ads_stats`
2018-04-17 16:01:28,091: Model SQL (segment_proc_customers):
SELECT
client,
period,
date,
customer_id,
first_order_date,
first_order_unix_date,
recency_days,
frequency,
revenue,
quantity,
aov,
case when frequency = 1 and recency_days <= 30 and first_order_unix_date >= window_start_unix_date then 'New'
	when frequency = 1 then 'One-time Purchaser'
	when frequency > frequency_90pct and recency_days < recency_90pct and aov > aov_50pct then 'Champion'
	when recency_days < recency_90pct and frequency > frequency_75pct then 'Potential Loyalists' 
	when frequency > frequency_75pct and recency_days <= recency_50pct then 'Cant Lose'
	when recency_days < recency_50pct and frequency > frequency_50pct then 'Loyal'
	when recency_days > recency_50pct and frequency > frequency_50pct then 'Frequent, not Recent'
	when recency_days < recency_50pct and frequency < frequency_50pct then 'Recent, not Frequent'
	else 'Unbucketed' end as segment,
aov_50pct,
frequency_90pct,
frequency_75pct,
frequency_50pct,
recency_90pct,
recency_75pct,
recency_50pct
FROM
(
	SELECT 
	a.client client,
	period,
	date,
	a.customer_id customer_id,
	b.first_order_date first_order_date,
	b.first_order_unix_date first_order_unix_date,
	window_start_unix_date,
	window_end_unix_date,
	recency_days,
	frequency,
	revenue,
	quantity,
	aov,
	PERCENTILE_CONT(aov, 0.50) OVER w1 AS aov_50pct,
	PERCENTILE_CONT(frequency, 0.90) OVER w1 AS frequency_90pct,
	PERCENTILE_CONT(frequency, 0.75) OVER w1 AS frequency_75pct,
	PERCENTILE_CONT(frequency, 0.90) OVER w1 AS frequency_50pct,
	PERCENTILE_CONT(recency_days, 0.10) OVER w1 AS recency_90pct,
	PERCENTILE_CONT(recency_days, 0.25) OVER w1 AS recency_75pct,
	PERCENTILE_CONT(recency_days, 0.5) OVER w1 AS recency_50pct
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`customers_proc` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`customers_first_purchase_proc` b
	ON (
		a.client = b.client and
		a.customer_id = b.customer_id
		)
	WINDOW w1 as (PARTITION BY a.client, period, date)
)
2018-04-17 16:01:32,620: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b501a20>]}
2018-04-17 16:01:32,881: 16:01:32 | 71 of 91 OK created table model agency_data_pipeline.agg_platforms_union [CREATE TABLE in 7.60s]
2018-04-17 16:01:50,854: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ce98080>]}
2018-04-17 16:01:51,686: 16:01:51 | 72 of 91 OK created table model agency_data_pipeline.segment_proc_customers [CREATE TABLE in 25.83s]
2018-04-17 16:01:51,687: 16:01:51 | 73 of 91 START table model agency_data_pipeline.retention_0_30_rebuy. [RUN]
2018-04-17 16:01:51,688: Compiling model.agency_data_pipeline.retention_0_30_rebuy
2018-04-17 16:01:51,687: 16:01:51 | 74 of 91 START table model agency_data_pipeline.segment_stats_customers_agg [RUN]
2018-04-17 16:01:51,688: 16:01:51 | 75 of 91 START table model agency_data_pipeline.retention_0_365_rebuy [RUN]
2018-04-17 16:01:51,697: Writing injected SQL for node "model.agency_data_pipeline.retention_0_30_rebuy"
2018-04-17 16:01:51,697: Compiling model.agency_data_pipeline.segment_stats_customers_agg
2018-04-17 16:01:51,697: Compiling model.agency_data_pipeline.retention_0_365_rebuy
2018-04-17 16:01:51,704: Writing injected SQL for node "model.agency_data_pipeline.segment_stats_customers_agg"
2018-04-17 16:01:51,709: Writing injected SQL for node "model.agency_data_pipeline.retention_0_365_rebuy"
2018-04-17 16:01:51,710: Acquiring new bigquery connection "retention_0_30_rebuy".
2018-04-17 16:01:51,710: Re-using an available connection from the pool.
2018-04-17 16:01:51,713: Acquiring new bigquery connection "retention_0_365_rebuy".
2018-04-17 16:01:51,713: Re-using an available connection from the pool.
2018-04-17 16:01:51,714: Acquiring new bigquery connection "segment_stats_customers_agg".
2018-04-17 16:01:51,717: Re-using an available connection from the pool.
2018-04-17 16:01:54,822: Model SQL (retention_0_365_rebuy):
SELECT 
r2.client,
r2.date,
r2.customer_id, 
r2.quantity,
r2.revenue
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_365_730` r1 
left join `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365` r2 
  on ( r1.customer_id = r2.customer_id 
  and r1.date = r2.date )
2018-04-17 16:01:54,823: Model SQL (segment_stats_customers_agg):
WITH ty as (

	SELECT
	client,
	date,
	customer_id,
	segment as segment_365,
	recency_days as recency_365,
	frequency as frequency_365,
	revenue as revenue_365,
	aov as aov_365,
	'' as segment_mom,
	0 as recency_mom,
	0 as frequency_mom,
	0 as revenue_mom,
	0 as aov_mom,
	'' as segment_yoy,
	0 as recency_yoy,
	0 as frequency_yoy,
	0 as revenue_yoy,
	0 as aov_yoy
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers`
	WHERE period = 'Rolling 365'

),

last_month as (

	SELECT
	client,
	date,
	customer_id,
	'' as segment_365,
	0 as recency_365,
	0 as frequency_365,
	0 as revenue_365,
	0 as aov_365,
	segment as segment_mom,
	recency_days as recency_mom,
	frequency as frequency_mom,
	revenue as revenue_mom,
	aov as aov_mom,
	'' as segment_yoy,
	0 as recency_yoy,
	0 as frequency_yoy,
	0 as revenue_yoy,
	0 as aov_yoy
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers`
	WHERE period = 'Rolling 365 (t-1mo)'

),

this_month_1yr as (

	SELECT
	client,
	date,
	customer_id,
	'' as segment_365,
	0 as recency_365,
	0 as frequency_365,
	0 as revenue_365,
	0 as aov_365,
	'' as segment_mom,
	0 as recency_mom,
	0 as frequency_mom,
	0 as revenue_mom,
	0 as aov_mom,
	segment as segment_yoy,
	recency_days as recency_yoy,
	frequency as frequency_yoy,
	revenue as revenue_yoy,
	aov as aov_yoy
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers`
	WHERE period = 'Rolling 365 (t-1yr)'


)

SELECT
client,
date, 
customer_id,
ifnull(max(segment_365), '') segment_365,
ifnull(max(segment_mom), '') segment_mom,
ifnull(max(segment_yoy), '') segment_yoy,
ifnull(sum(recency_365), 0) recency_365,
ifnull(sum(frequency_365), 0) frequency_365,
ifnull(sum(revenue_365), 0) revenue_365,
ifnull(sum(aov_365), 0) aov_365,
ifnull(sum(recency_mom), 0) recency_mom,
ifnull(sum(frequency_mom), 0) frequency_mom,
ifnull(sum(revenue_mom), 0) revenue_mom,
ifnull(sum(aov_mom), 0) aov_mom,	
ifnull(sum(recency_yoy), 0) recency_yoy,
ifnull(sum(frequency_yoy), 0) frequency_yoy,
ifnull(sum(revenue_yoy), 0) revenue_yoy,
ifnull(sum(aov_yoy), 0) aov_yoy
FROM
(
	SELECT * FROM ty
	UNION ALL
	SELECT * FROM last_month
	UNION ALL
	SELECT * FROM this_month_1yr

)
GROUP BY client, date, customer_id
2018-04-17 16:02:01,062: Model SQL (retention_0_30_rebuy):
SELECT 
r2.client,
r2.date,
r2.customer_id, 
r2.quantity,
r2.revenue
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_30_60` r1 
left join `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30` r2 
  on ( r1.customer_id = r2.customer_id 
  and r1.date = r2.date )
2018-04-17 16:02:03,545: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d8cfeb8>]}
2018-04-17 16:02:03,798: 16:02:03 | 75 of 91 OK created table model agency_data_pipeline.retention_0_365_rebuy [CREATE TABLE in 11.85s]
2018-04-17 16:02:04,067: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b5018d0>]}
2018-04-17 16:02:04,353: 16:02:04 | 73 of 91 OK created table model agency_data_pipeline.retention_0_30_rebuy [CREATE TABLE in 12.38s]
2018-04-17 16:02:17,361: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b4956a0>]}
2018-04-17 16:02:17,674: 16:02:17 | 74 of 91 OK created table model agency_data_pipeline.segment_stats_customers_agg [CREATE TABLE in 25.66s]
2018-04-17 16:02:17,674: 16:02:17 | 76 of 91 START table model agency_data_pipeline.retention_0_365_reactivated [RUN]
2018-04-17 16:02:17,675: Compiling model.agency_data_pipeline.retention_0_365_reactivated
2018-04-17 16:02:17,675: 16:02:17 | 77 of 91 START table model agency_data_pipeline.retention_0_30_reactivated [RUN]
2018-04-17 16:02:17,682: Writing injected SQL for node "model.agency_data_pipeline.retention_0_365_reactivated"
2018-04-17 16:02:17,675: 16:02:17 | 78 of 91 START table model agency_data_pipeline.retention_stats_rebuy_rate [RUN]
2018-04-17 16:02:17,682: Compiling model.agency_data_pipeline.retention_0_30_reactivated
2018-04-17 16:02:17,675: 16:02:17 | 79 of 91 START table model agency_data_pipeline.retention_stats_rebuy_rate_month [RUN]
2018-04-17 16:02:17,683: Compiling model.agency_data_pipeline.retention_stats_rebuy_rate
2018-04-17 16:02:17,689: Acquiring new bigquery connection "retention_0_365_reactivated".
2018-04-17 16:02:17,693: Writing injected SQL for node "model.agency_data_pipeline.retention_0_30_reactivated"
2018-04-17 16:02:17,694: Compiling model.agency_data_pipeline.retention_stats_rebuy_rate_month
2018-04-17 16:02:17,704: Writing injected SQL for node "model.agency_data_pipeline.retention_stats_rebuy_rate"
2018-04-17 16:02:17,705: Re-using an available connection from the pool.
2018-04-17 16:02:17,714: Writing injected SQL for node "model.agency_data_pipeline.retention_stats_rebuy_rate_month"
2018-04-17 16:02:17,717: Acquiring new bigquery connection "retention_stats_rebuy_rate_month".
2018-04-17 16:02:17,718: Acquiring new bigquery connection "retention_0_30_reactivated".
2018-04-17 16:02:17,719: Re-using an available connection from the pool.
2018-04-17 16:02:17,723: Re-using an available connection from the pool.
2018-04-17 16:02:17,725: Acquiring new bigquery connection "retention_stats_rebuy_rate".
2018-04-17 16:02:17,725: Re-using an available connection from the pool.
2018-04-17 16:02:21,339: Model SQL (retention_stats_rebuy_rate):
WITH r1 AS (
	SELECT 
	date,
	client,
	count(distinct customer_id) customers_prior_year,
	0 as customers_current_year, 
	sum(quantity) quantity_prior_year,
	0 as quantity_current_year,
	sum(revenue) revenue_prior_year,
	0 as revenue_current_year,
	case when sum(quantity) > 0 then sum(revenue)/sum(quantity) else null end as aov_prior_year,
	null as aov_current_year
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_365_730`
	group by date, client
),

r2 AS (
	SELECT 
	date,
	client,
	0 as customers_prior_year,
	count(distinct customer_id) customers_current_year, 
	0 as quantity_prior_year,
	sum(quantity) quantity_current_year,
	0 as revenue_prior_year,
	sum(revenue) revenue_current_year,
	null as aov_prior_year,
	case when sum(quantity) > 0 then sum(revenue)/sum(quantity) else null end as aov_current_year
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365_rebuy`
	group by date, client
)

SELECT 
date,
client,
sum(customers_prior_year) customers_prior_year, 
sum(customers_current_year) customers_current_year,
sum(quantity_prior_year) quantity_prior_year,
sum(quantity_current_year) quantity_current_year,
sum(revenue_prior_year) revenue_prior_year,
sum(revenue_current_year) revenue_current_year,
sum(aov_prior_year) aov_prior_year,
sum(aov_current_year) aov_current_year,
case when sum(revenue_prior_year) > 0 then sum(revenue_current_year)/sum(revenue_prior_year) else null end as revenue_retention,
case when sum(customers_prior_year) > 0 then sum(customers_current_year)/sum(customers_prior_year) else null end as customer_retention
FROM
(
	SELECT
	date,
	client,
	customers_prior_year,
	customers_current_year,
	quantity_prior_year,
	quantity_current_year,
	revenue_prior_year,
	revenue_current_year,
	aov_prior_year,
	aov_current_year
	FROM r1

	UNION ALL

	SELECT
	date,
	client,
	customers_prior_year,
	customers_current_year,
	quantity_prior_year,
	quantity_current_year,
	revenue_prior_year,
	revenue_current_year,
	aov_prior_year,
	aov_current_year
	FROM r2

) 
GROUP BY date, client
2018-04-17 16:02:21,340: Model SQL (retention_0_365_reactivated):
SELECT 
a.client,
a.date,
a.customer_id, 
a.quantity,
a.revenue
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_730_plus` b
ON (
	a.client = b.client AND
	a.date = b.date AND
	a.customer_id = b.customer_id
)
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_365_730` c
ON (
	a.client = c.client AND
	a.date = c.date AND
	a.customer_id = c.customer_id
)
WHERE b.customer_id is not null 
AND c.customer_id is null
2018-04-17 16:02:21,446: Model SQL (retention_0_30_reactivated):
SELECT 
a.client,
a.date,
a.customer_id, 
a.quantity,
a.revenue
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_60_plus` b
ON (
	a.client = b.client AND
	a.date = b.date AND
	a.customer_id = b.customer_id
)
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_30_60` c
ON (
	a.client = c.client AND
	a.date = c.date AND
	a.customer_id = c.customer_id
)
WHERE b.customer_id is not null 
AND c.customer_id is null
2018-04-17 16:02:23,602: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d8ba550>]}
2018-04-17 16:02:23,884: 16:02:23 | 78 of 91 OK created table model agency_data_pipeline.retention_stats_rebuy_rate [CREATE TABLE in 5.92s]
2018-04-17 16:02:23,885: 16:02:23 | 80 of 91 START table model agency_data_pipeline.agg_platforms_client. [RUN]
2018-04-17 16:02:23,885: Compiling model.agency_data_pipeline.agg_platforms_client
2018-04-17 16:02:23,895: Writing injected SQL for node "model.agency_data_pipeline.agg_platforms_client"
2018-04-17 16:02:23,898: Acquiring new bigquery connection "agg_platforms_client".
2018-04-17 16:02:23,899: Re-using an available connection from the pool.
2018-04-17 16:02:24,121: Model SQL (retention_stats_rebuy_rate_month):
WITH r1 AS (
	SELECT 
	date,
	client,
	count(distinct customer_id) customers_prior_year,
	0 as customers_current_year, 
	sum(quantity) quantity_prior_year,
	0 as quantity_current_year,
	sum(revenue) revenue_prior_year,
	0 as revenue_current_year,
	case when sum(quantity) > 0 then sum(revenue)/sum(quantity) else null end as aov_prior_year,
	null as aov_current_year
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_30_60`
	group by date, client
),

r2 AS (
	SELECT 
	date,
	client,
	0 as customers_prior_year,
	count(distinct customer_id) customers_current_year, 
	0 as quantity_prior_year,
	sum(quantity) quantity_current_year,
	0 as revenue_prior_year,
	sum(revenue) revenue_current_year,
	null as aov_prior_year,
	case when sum(quantity) > 0 then sum(revenue)/sum(quantity) else null end as aov_current_year
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30_rebuy`
	group by date, client
)

SELECT 
date,
client,
sum(customers_prior_year) customers_prior_year, 
sum(customers_current_year) customers_current_year,
sum(quantity_prior_year) quantity_prior_year,
sum(quantity_current_year) quantity_current_year,
sum(revenue_prior_year) revenue_prior_year,
sum(revenue_current_year) revenue_current_year,
sum(aov_prior_year) aov_prior_year,
sum(aov_current_year) aov_current_year,
case when sum(revenue_prior_year) > 0 then sum(revenue_current_year)/sum(revenue_prior_year) else null end as revenue_retention,
case when sum(customers_prior_year) > 0 then sum(customers_current_year)/sum(customers_prior_year) else null end as customer_retention
FROM
(
	SELECT
	date,
	client,
	customers_prior_year,
	customers_current_year,
	quantity_prior_year,
	quantity_current_year,
	revenue_prior_year,
	revenue_current_year,
	aov_prior_year,
	aov_current_year
	FROM r1

	UNION ALL

	SELECT
	date,
	client,
	customers_prior_year,
	customers_current_year,
	quantity_prior_year,
	quantity_current_year,
	revenue_prior_year,
	revenue_current_year,
	aov_prior_year,
	aov_current_year
	FROM r2

) 
GROUP BY date, client
2018-04-17 16:02:24,722: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ce98080>]}
2018-04-17 16:02:24,924: Model SQL (agg_platforms_client):
SELECT 
date, 
a.account account, 
b.client client,
a.platform platform,
a.channel channel,
url,
utm_campaign,
campaign,
cost,
impressions,
clicks,
transactions ad_platform_transactions
FROM 
  `growth-engines-pipeline`.`agency_data_pipeline`.`agg_platforms_union` a
LEFT JOIN 
  `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc` b
ON ( 
  a.account = b.account AND
  a.platform = b.platform
)
2018-04-17 16:02:24,991: 16:02:24 | 76 of 91 OK created table model agency_data_pipeline.retention_0_365_reactivated [CREATE TABLE in 7.05s]
2018-04-17 16:02:24,992: 16:02:24 | 81 of 91 START table model agency_data_pipeline.segment_stats_customers [RUN]
2018-04-17 16:02:24,992: Compiling model.agency_data_pipeline.segment_stats_customers
2018-04-17 16:02:25,002: Writing injected SQL for node "model.agency_data_pipeline.segment_stats_customers"
2018-04-17 16:02:25,003: Acquiring new bigquery connection "segment_stats_customers".
2018-04-17 16:02:25,003: Re-using an available connection from the pool.
2018-04-17 16:02:25,844: Model SQL (segment_stats_customers):
SELECT
client,
date,
segment_365,
segment_mom,
segment_yoy,
count(distinct(customer_id)) customers,
avg(recency_365) recency_365,
sum(frequency_365) frequency_365,
sum(revenue_365) revenue_365,
case when sum(frequency_365) > 0 then sum(revenue_365)/sum(frequency_365) else null end as aov_365,
avg(recency_mom) recency_mom,
sum(frequency_mom) frequency_mom,
sum(revenue_mom) revenue_mom,
case when sum(frequency_mom) > 0 then sum(revenue_mom)/sum(frequency_mom) else null end as aov_mom,
avg(recency_yoy) recency_yoy,
sum(frequency_yoy) frequency_yoy,
sum(revenue_yoy) revenue_yoy,
case when sum(frequency_yoy) > 0 then sum(revenue_yoy)/sum(frequency_yoy) else null end as aov_yoy
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_stats_customers_agg`
GROUP BY client, date, segment_365, segment_mom, segment_yoy
2018-04-17 16:02:26,584: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d948e80>]}
2018-04-17 16:02:26,841: 16:02:26 | 77 of 91 OK created table model agency_data_pipeline.retention_0_30_reactivated [CREATE TABLE in 8.90s]
2018-04-17 16:02:26,842: 16:02:26 | 82 of 91 START table model agency_data_pipeline.retention_0_365_new.. [RUN]
2018-04-17 16:02:26,842: Compiling model.agency_data_pipeline.retention_0_365_new
2018-04-17 16:02:26,853: Writing injected SQL for node "model.agency_data_pipeline.retention_0_365_new"
2018-04-17 16:02:26,856: Acquiring new bigquery connection "retention_0_365_new".
2018-04-17 16:02:26,857: Re-using an available connection from the pool.
2018-04-17 16:02:27,507: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ceaa390>]}
2018-04-17 16:02:27,784: 16:02:27 | 79 of 91 OK created table model agency_data_pipeline.retention_stats_rebuy_rate_month [CREATE TABLE in 9.81s]
2018-04-17 16:02:27,785: 16:02:27 | 83 of 91 START table model agency_data_pipeline.retention_0_30_new... [RUN]
2018-04-17 16:02:27,785: Compiling model.agency_data_pipeline.retention_0_30_new
2018-04-17 16:02:27,797: Writing injected SQL for node "model.agency_data_pipeline.retention_0_30_new"
2018-04-17 16:02:27,798: Acquiring new bigquery connection "retention_0_30_new".
2018-04-17 16:02:27,799: Re-using an available connection from the pool.
2018-04-17 16:02:27,997: Model SQL (retention_0_365_new):
SELECT 
a.client,
a.date,
a.customer_id, 
a.quantity,
a.revenue,
a.order_count
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_730_plus` b
ON (
	a.client = b.client AND
	a.date = b.date AND
	a.customer_id = b.customer_id
)
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_365_730` c
ON (
	a.client = c.client AND
	a.date = c.date AND
	a.customer_id = c.customer_id
)
WHERE b.customer_id is null 
and c.customer_id is null
2018-04-17 16:02:28,780: Model SQL (retention_0_30_new):
SELECT 
a.client,
a.date,
a.customer_id, 
a.quantity,
a.revenue,
a.order_count
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_60_plus` b
ON (
	a.client = b.client AND
	a.date = b.date AND
	a.customer_id = b.customer_id
)
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_30_60` c
ON (
	a.client = c.client AND
	a.date = c.date AND
	a.customer_id = c.customer_id
)
WHERE b.customer_id is null 
and c.customer_id is null
2018-04-17 16:02:34,426: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ceaa390>]}
2018-04-17 16:02:34,670: 16:02:34 | 83 of 91 OK created table model agency_data_pipeline.retention_0_30_new [CREATE TABLE in 6.64s]
2018-04-17 16:02:37,063: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d948e80>]}
2018-04-17 16:02:37,447: 16:02:37 | 82 of 91 OK created table model agency_data_pipeline.retention_0_365_new [CREATE TABLE in 10.22s]
2018-04-17 16:02:38,363: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ce98080>]}
2018-04-17 16:02:38,626: 16:02:38 | 81 of 91 OK created table model agency_data_pipeline.segment_stats_customers [CREATE TABLE in 13.37s]
2018-04-17 16:03:07,660: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d8b7e10>]}
2018-04-17 16:03:08,410: 16:03:08 | 80 of 91 OK created table model agency_data_pipeline.agg_platforms_client [CREATE TABLE in 43.78s]
2018-04-17 16:03:08,411: 16:03:08 | 84 of 91 START table model agency_data_pipeline.segment_list_customers [RUN]
2018-04-17 16:03:08,411: Compiling model.agency_data_pipeline.segment_list_customers
2018-04-17 16:03:08,419: Writing injected SQL for node "model.agency_data_pipeline.segment_list_customers"
2018-04-17 16:03:08,425: Acquiring new bigquery connection "segment_list_customers".
2018-04-17 16:03:08,426: Re-using an available connection from the pool.
2018-04-17 16:03:09,578: Model SQL (segment_list_customers):
SELECT
a.client,
period,
date,
customer_id,
b.first_name,
b.last_name,
b.email,
recency_days,
frequency,
revenue,
quantity,
aov,
segment
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`agg_customers_union` b
ON (
	a.client = b.client AND
	a.customer_id = b.id
)
2018-04-17 16:03:43,445: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b4956a0>]}
2018-04-17 16:03:43,754: 16:03:43 | 84 of 91 OK created table model agency_data_pipeline.segment_list_customers [CREATE TABLE in 35.03s]
2018-04-17 16:03:43,755: 16:03:43 | 85 of 91 START table model agency_data_pipeline.growth_customer_0_365_segment [RUN]
2018-04-17 16:03:43,755: Compiling model.agency_data_pipeline.growth_customer_0_365_segment
2018-04-17 16:03:43,767: Writing injected SQL for node "model.agency_data_pipeline.growth_customer_0_365_segment"
2018-04-17 16:03:43,769: Acquiring new bigquery connection "growth_customer_0_365_segment".
2018-04-17 16:03:43,769: Re-using an available connection from the pool.
2018-04-17 16:03:45,186: Model SQL (growth_customer_0_365_segment):
with segment as (

	SELECT 
	a.date,
	unix_date_in_range,
	unix_date_in_range_yoy,
	a.client client,
	a.customer_id customer_id,
	case when b.customer_id is not null then 'New' else 'Existing' end as segment,
	a.orders,
	a.quantity,
	a.revenue,
	a.shipping_revenue
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_customer_0_365` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365_new` b
	ON (
	  a.customer_id = b.customer_id AND
	  a.date  = b.date AND
	  a.client = b.client
	)
),

total as (

	SELECT 
	date,
	unix_date_in_range,
	unix_date_in_range_yoy,
	client,
	customer_id,
	'Total' as segment,
	orders,
	quantity,
	revenue,
	shipping_revenue
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_customer_0_365`

)

SELECT 
date,
unix_date_in_range,
unix_date_in_range_yoy,
client,
segment,
count(distinct(customer_id)) customers,
sum(orders) orders,
sum(quantity) quantity,
sum(revenue) revenue,
sum(shipping_revenue) shipping_revenue
FROM
( 
	SELECT * FROM segment
	UNION ALL
	SELECT * FROM total
) 
GROUP BY date, unix_date_in_range, unix_date_in_range_yoy, client, segment
2018-04-17 16:03:57,594: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cea3588>]}
2018-04-17 16:03:58,248: 16:03:58 | 85 of 91 OK created table model agency_data_pipeline.growth_customer_0_365_segment [CREATE TABLE in 13.84s]
2018-04-17 16:03:58,249: 16:03:58 | 86 of 91 START table model agency_data_pipeline.growth_date_union.... [RUN]
2018-04-17 16:03:58,249: Compiling model.agency_data_pipeline.growth_date_union
2018-04-17 16:03:58,266: Writing injected SQL for node "model.agency_data_pipeline.growth_date_union"
2018-04-17 16:03:58,270: Acquiring new bigquery connection "growth_date_union".
2018-04-17 16:03:58,270: Re-using an available connection from the pool.
2018-04-17 16:03:59,338: Model SQL (growth_date_union):
with ty as (

  SELECT 
  date,
  unix_date_in_range, 
  unix_date_in_range_yoy, 
  client, 
  segment,
  customers customers_ty,
  orders orders_ty,
  quantity quantity_ty,
  revenue revenue_ty,
  shipping_revenue shipping_revenue_ty,
  null as customers_ly,
  null as orders_ly,
  null as quantity_ly,
  null as revenue_ly,
  null as shipping_revenue_ly
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_customer_0_365_segment`

),

ly as (

  SELECT 
  date,
  0 as unix_date_in_range, 
  unix_date_in_range unix_date_in_range_yoy, 
  client, 
  segment,
  null as customers_ty,
  null as orders_ty,
  null as quantity_ty,
  null as revenue_ty,
  null as shipping_revenue_ty,
  customers customers_ly,
  orders orders_ly,
  quantity quantity_ly,
  revenue revenue_ly,
  shipping_revenue shipping_revenue_ly
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_customer_0_365_segment`

)


SELECT
max(date) date,
max(unix_date_in_range) unix_date_in_range,
unix_date_in_range_yoy,
client,
segment,
ifnull(sum(customers_ty), 0) customers_ty,
ifnull(sum(orders_ty), 0) orders_ty,
ifnull(sum(quantity_ty), 0) quantity_ty,
ifnull(sum(revenue_ty), 0) revenue_ty,
ifnull(sum(shipping_revenue_ty), 0) shipping_revenue_ty,
case when sum(orders_ty) > 0 then sum(revenue_ty)/sum(orders_ty) else null end as aov_ty,
ifnull(sum(customers_ly), 0) customers_ly,
ifnull(sum(orders_ly), 0) orders_ly,
ifnull(sum(quantity_ly), 0) quantity_ly,
ifnull(sum(revenue_ly), 0) revenue_ly,
ifnull(sum(shipping_revenue_ly), 0) shipping_revenue_ly,
case when sum(orders_ly) > 0 then sum(revenue_ly)/sum(orders_ly) else null end as aov_ly,
case when sum(orders_ly) > 0 then ( sum(orders_ty) - sum(orders_ly) ) / sum(orders_ly) else null end as order_growth,
case when sum(revenue_ly) > 0 then ( sum(revenue_ty) - sum(revenue_ly) ) / sum(revenue_ly) else null end as revenue_growth,
case when sum(customers_ly) > 0 then ( sum(customers_ty) - sum(customers_ly) ) / sum(customers_ly) else null end as customer_growth,
case when sum(orders_ly) > 0 then ( sum(revenue_ty)/sum(orders_ty) - sum(revenue_ly)/sum(orders_ly) ) / ( sum(revenue_ly)/sum(orders_ly) ) else null end as aov_growth
FROM (

  SELECT * FROM ty
  UNION ALL
  SELECT * FROM ly

)
where unix_date_in_range is not null
group by unix_date_in_range_yoy, client, segment
2018-04-17 16:04:00,473: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ce8e2e8>]}
2018-04-17 16:04:00,834: 16:04:00 | 86 of 91 OK created table model agency_data_pipeline.growth_date_union [CREATE TABLE in 2.22s]
2018-04-17 16:04:00,835: 16:04:00 | 87 of 91 START table model agency_data_pipeline.retention_stats_month [RUN]
2018-04-17 16:04:00,835: Compiling model.agency_data_pipeline.retention_stats_month
2018-04-17 16:04:00,841: 16:04:00 | 88 of 91 START table model agency_data_pipeline.retention_stats...... [RUN]
2018-04-17 16:04:00,841: Compiling model.agency_data_pipeline.retention_stats
2018-04-17 16:04:00,854: 16:04:00 | 89 of 91 START table model agency_data_pipeline.growth_stats......... [RUN]
2018-04-17 16:04:00,854: Compiling model.agency_data_pipeline.growth_stats
2018-04-17 16:04:00,866: Writing injected SQL for node "model.agency_data_pipeline.retention_stats_month"
2018-04-17 16:04:00,879: Writing injected SQL for node "model.agency_data_pipeline.retention_stats"
2018-04-17 16:04:00,898: Acquiring new bigquery connection "retention_stats".
2018-04-17 16:04:00,898: Re-using an available connection from the pool.
2018-04-17 16:04:00,897: Acquiring new bigquery connection "retention_stats_month".
2018-04-17 16:04:00,901: Re-using an available connection from the pool.
2018-04-17 16:04:00,897: Writing injected SQL for node "model.agency_data_pipeline.growth_stats"
2018-04-17 16:04:00,908: Acquiring new bigquery connection "growth_stats".
2018-04-17 16:04:00,908: Re-using an available connection from the pool.
2018-04-17 16:04:02,003: Model SQL (retention_stats):
WITH last_year_buyers AS (
	SELECT 
	date,
	client,
	'Last year buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_365_730`
	group by date, client
),

rebuy_rate AS (
	SELECT 
	date,
	client,
	'Rebuy rate' as metric,
	customer_retention value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_stats_rebuy_rate`
),

repeat_buyers AS (
	SELECT 
	date,
	client,
	'Repeat buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365_rebuy`
	group by date, client
),

reactivated_buyers AS (
	SELECT 
	date,
	client,
	'Reactivated buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365_reactivated`
	group by date, client
),

new_buyers AS (
	SELECT 
	date,
	client,
	'New buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365_new`
	group by date, client
),

this_year_buyers AS (
	SELECT 
	date,
	client,
	'This year buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365`
	group by date, client
),

this_year_revenue AS (
	SELECT 
	date,
	client,
	'This year revenue' as metric,
	sum(revenue) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365`
	group by date, client
),

this_year_aov AS (
	SELECT 
	date,
	client,
	'This year AOV' as metric,
	case when sum(order_count) > 0 then sum(revenue)/sum(order_count) else 0 end as value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365`
	group by date, client
),

this_year_frequency AS (
	SELECT 
	date,
	client,
	'This year frequency' as metric,
	case when count(distinct customer_id) > 0 then sum(order_count)/count(distinct customer_id) else 0 end as value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365`
	group by date, client
)

SELECT 
date,
client,
metric,
ifnull(value, 0) value
FROM
(
	SELECT
	date,
	client,
	metric,
	value
	FROM last_year_buyers

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM rebuy_rate

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM repeat_buyers

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM reactivated_buyers	

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM new_buyers	

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_year_buyers	

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_year_revenue

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_year_aov

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_year_frequency

	UNION ALL

	SELECT
	a.date,
	a.client,
	'Dormant buyers' as metric,
	a.value - ifnull(b.value, 0) as value
	FROM last_year_buyers a
	LEFT JOIN repeat_buyers b
	ON ( a.date = b.date AND
		a.client = b.client )							

)
2018-04-17 16:04:02,004: Model SQL (retention_stats_month):
WITH last_month_buyers AS (
	SELECT 
	date,
	client,
	'Last month buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_30_60`
	group by date, client
),

rebuy_rate AS (
	SELECT 
	date,
	client,
	'Rebuy rate' as metric,
	customer_retention value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_stats_rebuy_rate_month`
),

repeat_buyers AS (
	SELECT 
	date,
	client,
	'Repeat buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30_rebuy`
	group by date, client
),

reactivated_buyers AS (
	SELECT 
	date,
	client,
	'Reactivated buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30_reactivated`
	group by date, client
),

new_buyers AS (
	SELECT 
	date,
	client,
	'New buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30_new`
	group by date, client
),

this_month_buyers AS (
	SELECT 
	date,
	client,
	'This month buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30`
	group by date, client
),

this_month_revenue AS (
	SELECT 
	date,
	client,
	'This month revenue' as metric,
	sum(revenue) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30`
	group by date, client
),

this_month_aov AS (
	SELECT 
	date,
	client,
	'This month AOV' as metric,
	case when sum(order_count) > 0 then sum(revenue)/sum(order_count) else 0 end as value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30`
	group by date, client
),

this_month_frequency AS (
	SELECT 
	date,
	client,
	'This month frequency' as metric,
	case when count(distinct customer_id) > 0 then sum(order_count)/count(distinct customer_id) else 0 end as value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30`
	group by date, client
)

SELECT 
date,
client,
metric,
ifnull(value, 0) value
FROM
(
	SELECT
	date,
	client,
	metric,
	value
	FROM last_month_buyers

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM rebuy_rate

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM repeat_buyers

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM reactivated_buyers	

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM new_buyers	

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_month_buyers	

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_month_revenue

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_month_aov

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_month_frequency

	UNION ALL

	SELECT
	a.date,
	a.client,
	'Dormant buyers' as metric,
	a.value - ifnull(b.value, 0) as value
	FROM last_month_buyers a
	LEFT JOIN repeat_buyers b
	ON ( a.date = b.date AND
		a.client = b.client )							

)
2018-04-17 16:04:02,005: Model SQL (growth_stats):
with orders as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'Orders' as metric,
  orders_ty as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`
),

order_growth as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'Order Growth' as metric,
  order_growth as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`
),

revenue as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'Revenue' as metric,
  revenue_ty as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`
),

revenue_growth as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'Revenue Growth' as metric,
  revenue_growth as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`
),

customers as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'Customers' as metric,
  customers_ty as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`
),

customer_growth as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'Customer Growth' as metric,
  customer_growth as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`

),

aov as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'AOV' as metric,
  aov_ty as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`

),

aov_growth as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'AOV Growth' as metric,
  aov_growth as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`

)

SELECT * FROM orders
UNION ALL 
SELECT * FROM order_growth
UNION ALL
SELECT * FROM revenue
UNION ALL 
SELECT * FROM revenue_growth
UNION ALL
SELECT * FROM customers
UNION ALL 
SELECT * FROM customer_growth
UNION ALL
SELECT * FROM aov
UNION ALL 
SELECT * FROM aov_growth
2018-04-17 16:04:03,129: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b5085c0>]}
2018-04-17 16:04:03,394: 16:04:03 | 89 of 91 OK created table model agency_data_pipeline.growth_stats.... [CREATE TABLE in 2.27s]
2018-04-17 16:04:05,379: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cea3588>]}
2018-04-17 16:04:05,648: 16:04:05 | 87 of 91 OK created table model agency_data_pipeline.retention_stats_month [CREATE TABLE in 4.54s]
2018-04-17 16:04:09,840: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b33edd8>]}
2018-04-17 16:04:10,516: 16:04:10 | 88 of 91 OK created table model agency_data_pipeline.retention_stats. [CREATE TABLE in 9.00s]
2018-04-17 16:04:10,517: 16:04:10 | 90 of 91 START table model agency_data_pipeline.agg_campaign......... [RUN]
2018-04-17 16:04:10,517: Compiling model.agency_data_pipeline.agg_campaign
2018-04-17 16:04:10,535: Writing injected SQL for node "model.agency_data_pipeline.agg_campaign"
2018-04-17 16:04:10,537: Acquiring new bigquery connection "agg_campaign".
2018-04-17 16:04:10,537: Re-using an available connection from the pool.
2018-04-17 16:04:11,586: Model SQL (agg_campaign):
with ga as (

	select 
		date, client, attribution, channel, platform, url, campaign as utm_campaign, '' as campaign,
    	customers_new,
    	transactions_new,
    	revenue_new,
    	first_order_revenue_new,
    	lifetime_revenue_new,
    	customers_total,
    	transactions_total,
    	revenue_total,
		null as cost, null as impressions, null as clicks, null as ad_platform_transactions
	from `growth-engines-pipeline`.`agency_data_pipeline`.`agg_ga_campaign_by_type`

),

platforms_last_touch as (

	select 
		date, client, 'Last-touch' as attribution, channel, platform, url, utm_campaign, campaign,
		null as customers_new,
    	null as transactions_new,
    	null as revenue_new,
    	null as first_order_revenue_new,
    	null as lifetime_revenue_new,
    	null as customers_total,
    	null as transactions_total,
    	null as revenue_total,
		cost, impressions, clicks, ad_platform_transactions
	from `growth-engines-pipeline`.`agency_data_pipeline`.`agg_platforms_client`

),

platforms_first_touch as (

    select 
        date, client, 'First-touch' as attribution, channel, platform, url, utm_campaign, campaign,
        null as customers_new,
        null as transactions_new,
        null as revenue_new,
        null as first_order_revenue_new,
        null as lifetime_revenue_new,
        null as customers_total,
        null as transactions_total,
        null as revenue_total,
        cost, impressions, clicks, ad_platform_transactions
    from `growth-engines-pipeline`.`agency_data_pipeline`.`agg_platforms_client`

)


SELECT
    date, 
    client,
    attribution,
    platform,
    channel, 
    url,
    utm_campaign,
    max(campaign) campaign,
    ifnull( sum(cost), 0) cost,
	ifnull( sum(impressions), 0) impressions,
	ifnull( sum(clicks), 0) clicks,
	ifnull( sum(ad_platform_transactions), 0) ad_platform_transactions,
	ifnull( sum(customers_new), 0) customers_new,
	ifnull( sum(transactions_new), 0) transactions_new,
	ifnull( sum(revenue_new), 0) revenue_new,
	ifnull( sum(first_order_revenue_new), 0) first_order_revenue_new,
	ifnull( sum(lifetime_revenue_new), 0) lifetime_revenue_new,
	ifnull( sum(customers_total), 0) customers_total,
	ifnull( sum(transactions_total), 0) transactions_total,
	ifnull( sum(revenue_total), 0) revenue_total	
FROM 
(
    SELECT *
    FROM 
      ga
    UNION ALL
    SELECT *
    FROM 
      platforms_first_touch
    UNION ALL
    SELECT *
    FROM 
      platforms_last_touch      
) 
GROUP BY
    date, client, attribution, platform, channel, url, utm_campaign
2018-04-17 16:04:19,809: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b501710>]}
2018-04-17 16:04:20,059: 16:04:20 | 90 of 91 OK created table model agency_data_pipeline.agg_campaign.... [CREATE TABLE in 9.29s]
2018-04-17 16:04:20,060: 16:04:20 | 91 of 91 START table model agency_data_pipeline.agg_platform_monthly. [RUN]
2018-04-17 16:04:20,061: Compiling model.agency_data_pipeline.agg_platform_monthly
2018-04-17 16:04:20,067: Writing injected SQL for node "model.agency_data_pipeline.agg_platform_monthly"
2018-04-17 16:04:20,068: Acquiring new bigquery connection "agg_platform_monthly".
2018-04-17 16:04:20,068: Re-using an available connection from the pool.
2018-04-17 16:04:21,029: Model SQL (agg_platform_monthly):
SELECT
    FORMAT_DATE("%Y-%m", date) AS yyyymm,
    client,
    attribution,
    platform,
    channel, 
    sum(cost) cost,
	sum(clicks) clicks,
	sum(customers_new) customers_new,
	sum(first_order_revenue_new) first_order_revenue_new,
	sum(lifetime_revenue_new) lifetime_revenue_new,
	sum(transactions_new) transactions_new,
	sum(revenue_new) revenue_new,
    sum(customers_total) customers_total,
    sum(transactions_total) transactions_total,
    sum(revenue_total) revenue_total
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_campaign`
GROUP BY
    yyyymm, client, attribution, platform, channel
2018-04-17 16:04:23,256: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1e1e441-38a5-4718-8cb5-7a43ff528463', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b501a20>]}
2018-04-17 16:04:23,500: 16:04:23 | 91 of 91 OK created table model agency_data_pipeline.agg_platform_monthly [CREATE TABLE in 3.20s]
2018-04-17 16:04:23,608: 16:04:23 | 
2018-04-17 16:04:23,608: 16:04:23 | Finished running 91 table models in 502.66s.
2018-04-17 16:04:23,608: Connection 'master' was left open.
2018-04-17 16:04:23,609: 
2018-04-17 16:04:23,609: Completed successfully
2018-04-17 16:04:23,609: 
Done. PASS=91 ERROR=0 SKIP=0 TOTAL=91
2018-04-17 16:04:23,610: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b4397b8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b2fab38>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b2fad68>]}
2018-04-17 16:04:23,902: Flushing usage events
2018-04-18 08:39:22,437: Tracking: tracking
2018-04-18 08:39:22,440: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106fb8d68>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106fb8e80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106fb8940>]}
2018-04-18 08:39:23,294: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-04-18 08:39:23,314: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/growth-engines/dbt_modules
2018-04-18 08:39:23,320: Parsing get_column_values.sql
2018-04-18 08:39:23,340: Parsing get_url_parameter.sql
2018-04-18 08:39:23,346: Parsing split_part.sql
2018-04-18 08:39:23,354: Parsing table_exists.sql
2018-04-18 08:39:23,367: Parsing core.sql
2018-04-18 08:39:23,385: Parsing adapters/bigquery.sql
2018-04-18 08:39:23,396: Parsing adapters/common.sql
2018-04-18 08:39:23,415: Parsing adapters/postgres.sql
2018-04-18 08:39:23,420: Parsing adapters/redshift.sql
2018-04-18 08:39:23,441: Parsing etc/get_custom_schema.sql
2018-04-18 08:39:23,453: Parsing materializations/archive.sql
2018-04-18 08:39:23,490: Parsing materializations/bigquery.sql
2018-04-18 08:39:23,512: Parsing materializations/helpers.sql
2018-04-18 08:39:23,541: Parsing materializations/incremental.sql
2018-04-18 08:39:23,578: Parsing materializations/table.sql
2018-04-18 08:39:23,601: Parsing materializations/view.sql
2018-04-18 08:39:23,618: Parsing materializations/wrapper.sql
2018-04-18 08:39:23,626: Parsing schema_tests/accepted_values.sql
2018-04-18 08:39:23,634: Parsing schema_tests/not_null.sql
2018-04-18 08:39:23,639: Parsing schema_tests/relationships.sql
2018-04-18 08:39:23,646: Parsing schema_tests/unique.sql
2018-04-18 08:39:23,951: Parsing model.agency_data_pipeline.accounts_proc
2018-04-18 08:39:23,953: Parsing model.agency_data_pipeline.all_dates
2018-04-18 08:39:23,955: Parsing model.agency_data_pipeline.carts_proc
2018-04-18 08:39:23,956: Parsing model.agency_data_pipeline.clients_proc
2018-04-18 08:39:23,959: Parsing model.agency_data_pipeline.conversion_goals_proc
2018-04-18 08:39:23,960: Parsing model.agency_data_pipeline.mappings_ga_proc
2018-04-18 08:39:23,962: Acquiring new bigquery connection "master".
2018-04-18 08:39:23,962: Opening a new connection (0 currently allocated)
2018-04-18 08:39:23,970: Parsing model.agency_data_pipeline.monthend_dates
2018-04-18 08:39:23,973: Parsing model.agency_data_pipeline.adwords_ads
2018-04-18 08:39:23,977: Parsing model.agency_data_pipeline.adwords_campaigns
2018-04-18 08:39:23,979: Parsing model.agency_data_pipeline.adwords_conversions
2018-04-18 08:39:23,981: Parsing model.agency_data_pipeline.adwords_impression_share
2018-04-18 08:39:23,983: Parsing model.agency_data_pipeline.adwords_join
2018-04-18 08:39:23,985: Parsing model.agency_data_pipeline.adwords_stats
2018-04-18 08:39:23,987: Parsing model.agency_data_pipeline.adwords_urls
2018-04-18 08:39:23,988: Parsing model.agency_data_pipeline.bing_ads_ads
2018-04-18 08:39:23,991: Parsing model.agency_data_pipeline.bing_ads_conversions
2018-04-18 08:39:23,993: Parsing model.agency_data_pipeline.bing_ads_impression_share
2018-04-18 08:39:23,995: Parsing model.agency_data_pipeline.bing_ads_stats
2018-04-18 08:39:23,997: Parsing model.agency_data_pipeline.fb_adcreative
2018-04-18 08:39:24,002: Parsing model.agency_data_pipeline.fb_ads
2018-04-18 08:39:24,008: Parsing model.agency_data_pipeline.fb_ads_insights
2018-04-18 08:39:24,015: Parsing model.agency_data_pipeline.fb_ads_insights_conversions
2018-04-18 08:39:24,024: Parsing model.agency_data_pipeline.fb_ads_stats
2018-04-18 08:39:24,027: Parsing model.agency_data_pipeline.ga_conversions
2018-04-18 08:39:24,030: Parsing model.agency_data_pipeline.ga_traffic
2018-04-18 08:39:24,045: Parsing model.agency_data_pipeline.ga_transactions
2018-04-18 08:39:24,054: Parsing model.agency_data_pipeline.ga_mcf_proc
2018-04-18 08:39:24,056: Parsing model.agency_data_pipeline.ga_mcf_stats
2018-04-18 08:39:24,058: Parsing model.agency_data_pipeline.shopify_customers_proc
2018-04-18 08:39:24,064: Parsing model.agency_data_pipeline.shopify_orders_proc
2018-04-18 08:39:24,071: Parsing model.agency_data_pipeline.shopify_products_proc
2018-04-18 08:39:24,077: Parsing model.agency_data_pipeline.shopify_refunds_proc
2018-04-18 08:39:24,087: Parsing model.agency_data_pipeline.agg_campaign
2018-04-18 08:39:24,091: Parsing model.agency_data_pipeline.agg_customers_union
2018-04-18 08:39:24,093: Parsing model.agency_data_pipeline.agg_ga_campaign
2018-04-18 08:39:24,095: Parsing model.agency_data_pipeline.agg_ga_campaign_by_type
2018-04-18 08:39:24,098: Parsing model.agency_data_pipeline.agg_ga_transaction
2018-04-18 08:39:24,101: Parsing model.agency_data_pipeline.agg_ga_transaction_order_number
2018-04-18 08:39:24,103: Parsing model.agency_data_pipeline.agg_orders_union
2018-04-18 08:39:24,106: Parsing model.agency_data_pipeline.agg_platform_monthly
2018-04-18 08:39:24,107: Parsing model.agency_data_pipeline.agg_platforms_client
2018-04-18 08:39:24,109: Parsing model.agency_data_pipeline.agg_platforms_union
2018-04-18 08:39:24,112: Parsing model.agency_data_pipeline.agg_products
2018-04-18 08:39:24,114: Parsing model.agency_data_pipeline.agg_transaction
2018-04-18 08:39:24,117: Parsing model.agency_data_pipeline.agg_transaction_daily
2018-04-18 08:39:24,119: Parsing model.agency_data_pipeline.agg_transaction_line_item
2018-04-18 08:39:24,121: Parsing model.agency_data_pipeline.agg_transaction_line_item_type
2018-04-18 08:39:24,123: Parsing model.agency_data_pipeline.agg_transaction_order_number
2018-04-18 08:39:24,125: Parsing model.agency_data_pipeline.agg_transaction_product_type
2018-04-18 08:39:24,128: Parsing model.agency_data_pipeline.customers_by_transaction
2018-04-18 08:39:24,131: Parsing model.agency_data_pipeline.growth_customer_0_365
2018-04-18 08:39:24,133: Parsing model.agency_data_pipeline.growth_customer_0_365_segment
2018-04-18 08:39:24,135: Parsing model.agency_data_pipeline.growth_date_union
2018-04-18 08:39:24,138: Parsing model.agency_data_pipeline.growth_stats
2018-04-18 08:39:24,145: Parsing model.agency_data_pipeline.retention_0_365
2018-04-18 08:39:24,149: Parsing model.agency_data_pipeline.retention_0_365_new
2018-04-18 08:39:24,152: Parsing model.agency_data_pipeline.retention_0_365_reactivated
2018-04-18 08:39:24,155: Parsing model.agency_data_pipeline.retention_0_365_rebuy
2018-04-18 08:39:24,157: Parsing model.agency_data_pipeline.retention_365_730
2018-04-18 08:39:24,159: Parsing model.agency_data_pipeline.retention_730_plus
2018-04-18 08:39:24,161: Parsing model.agency_data_pipeline.retention_stats
2018-04-18 08:39:24,166: Parsing model.agency_data_pipeline.retention_stats_rebuy_rate
2018-04-18 08:39:24,169: Parsing model.agency_data_pipeline.retention_0_30
2018-04-18 08:39:24,171: Parsing model.agency_data_pipeline.retention_0_30_new
2018-04-18 08:39:24,173: Parsing model.agency_data_pipeline.retention_0_30_reactivated
2018-04-18 08:39:24,176: Parsing model.agency_data_pipeline.retention_0_30_rebuy
2018-04-18 08:39:24,178: Parsing model.agency_data_pipeline.retention_30_60
2018-04-18 08:39:24,180: Parsing model.agency_data_pipeline.retention_60_plus
2018-04-18 08:39:24,183: Parsing model.agency_data_pipeline.retention_stats_month
2018-04-18 08:39:24,188: Parsing model.agency_data_pipeline.retention_stats_rebuy_rate_month
2018-04-18 08:39:24,191: Parsing model.agency_data_pipeline.customers_first_purchase_proc
2018-04-18 08:39:24,193: Parsing model.agency_data_pipeline.customers_proc
2018-04-18 08:39:24,196: Parsing model.agency_data_pipeline.segment_list_customers
2018-04-18 08:39:24,198: Parsing model.agency_data_pipeline.segment_proc_customers
2018-04-18 08:39:24,200: Parsing model.agency_data_pipeline.segment_stats_customers
2018-04-18 08:39:24,203: Parsing model.agency_data_pipeline.segment_stats_customers_agg
2018-04-18 08:39:24,205: Parsing model.agency_data_pipeline.customers_first_purchase_product_type_proc
2018-04-18 08:39:24,207: Parsing model.agency_data_pipeline.customers_products_proc
2018-04-18 08:39:24,209: Parsing model.agency_data_pipeline.segment_list_customers_products
2018-04-18 08:39:24,212: Parsing model.agency_data_pipeline.segment_proc_customers_products
2018-04-18 08:39:24,214: Parsing model.agency_data_pipeline.segment_stats_customers_products
2018-04-18 08:39:24,216: Parsing model.agency_data_pipeline.segment_stats_customers_products_agg
2018-04-18 08:39:24,219: Parsing model.agency_data_pipeline.frequency_proc
2018-04-18 08:39:24,221: Parsing model.agency_data_pipeline.frequency_stats
2018-04-18 08:39:24,223: Parsing model.agency_data_pipeline.order_paths_agg
2018-04-18 08:39:24,225: Parsing model.agency_data_pipeline.order_paths_proc
2018-04-18 08:39:24,226: Parsing model.agency_data_pipeline.order_paths_stats
2018-04-18 08:39:24,229: Parsing model.agency_data_pipeline.products_proc
2018-04-18 08:39:24,231: Parsing model.agency_data_pipeline.segment_proc_sku
2018-04-18 08:39:24,233: Parsing model.agency_data_pipeline.segment_stats_category
2018-04-18 08:39:24,235: Parsing model.agency_data_pipeline.segment_stats_sku
2018-04-18 08:39:24,264: Found 91 models, 0 tests, 0 archives, 0 analyses, 46 macros, 0 operations
2018-04-18 08:39:24,344: 
2018-04-18 08:39:25,587: 08:39:25 | Concurrency: 4 threads (target='prod')
2018-04-18 08:39:25,587: 08:39:25 | 
2018-04-18 08:39:26,344: 08:39:26 | 1 of 91 START table model agency_data_pipeline.adwords_conversions... [RUN]
2018-04-18 08:39:26,344: Compiling model.agency_data_pipeline.adwords_conversions
2018-04-18 08:39:26,348: Writing injected SQL for node "model.agency_data_pipeline.adwords_conversions"
2018-04-18 08:39:26,344: 08:39:26 | 2 of 91 START table model agency_data_pipeline.clients_proc.......... [RUN]
2018-04-18 08:39:26,349: Compiling model.agency_data_pipeline.clients_proc
2018-04-18 08:39:26,353: Writing injected SQL for node "model.agency_data_pipeline.clients_proc"
2018-04-18 08:39:26,344: 08:39:26 | 3 of 91 START table model agency_data_pipeline.ga_conversions........ [RUN]
2018-04-18 08:39:26,353: Compiling model.agency_data_pipeline.ga_conversions
2018-04-18 08:39:26,344: 08:39:26 | 4 of 91 START table model agency_data_pipeline.bing_ads_impression_share [RUN]
2018-04-18 08:39:26,357: Writing injected SQL for node "model.agency_data_pipeline.ga_conversions"
2018-04-18 08:39:26,358: Compiling model.agency_data_pipeline.bing_ads_impression_share
2018-04-18 08:39:26,359: Acquiring new bigquery connection "adwords_conversions".
2018-04-18 08:39:26,359: Acquiring new bigquery connection "clients_proc".
2018-04-18 08:39:26,364: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_impression_share"
2018-04-18 08:39:26,364: Opening a new connection (1 currently allocated)
2018-04-18 08:39:26,367: Acquiring new bigquery connection "ga_conversions".
2018-04-18 08:39:26,370: Acquiring new bigquery connection "bing_ads_impression_share".
2018-04-18 08:39:26,370: Opening a new connection (2 currently allocated)
2018-04-18 08:39:26,431: Opening a new connection (3 currently allocated)
2018-04-18 08:39:26,488: Opening a new connection (4 currently allocated)
2018-04-18 08:39:27,911: Model SQL (ga_conversions):
select 
client,
client_name,
platform,
goal_name,
goal_type,
account,
time_of_entry
from  ( 

SELECT  
client,
client_name,
platform,
trim(goal_name) goal_name,
goal_type,
account,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform, goal_name ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.conversion_goals` 
WHERE platform = 'Google Analytics'

) 

WHERE lv = time_of_entry
2018-04-18 08:39:27,913: Model SQL (clients_proc):
select 
client,
client_name,
account,
platform
from  ( 

SELECT  
client,
client_name,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.accounts`
where client_name != ''
) 

WHERE lv = time_of_entry
2018-04-18 08:39:27,918: Model SQL (adwords_conversions):
select 
client,
client_name,
platform,
goal_name,
goal_type,
account,
time_of_entry
from  ( 

SELECT  
client,
client_name,
platform,
trim(lower(goal_name)) goal_name,
goal_type,
account,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform, goal_name ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.conversion_goals` 
WHERE platform = 'Adwords'

) 

WHERE lv = time_of_entry
2018-04-18 08:39:27,945: Model SQL (bing_ads_impression_share):
SELECT 
date, 
account,
channel,
platform,
sum(impressions) impressions,
sum(available_impressions) available_impressions
FROM

(

SELECT  
cast(gregoriandate as date) date,
replace(accountname,',','') account,  
'Paid' as channel,
'Bing Ads' as platform,
case when impressionsharepercent is null then 0 else impressions end as impressions,
cast(round(case when ( impressionsharepercent is not null and impressionsharepercent > 0 ) then (impressions*100)/impressionsharepercent else 0 end) as int64) as available_impressions,
_sdc_sequence,
first_value(_sdc_sequence) OVER (PARTITION BY campaignid, gregoriandate ORDER BY _sdc_sequence DESC) lv
FROM `growth-engines-pipeline.bing_ads.campaign_performance_report` 

)

where lv = _sdc_sequence
group by date, account, channel, platform
2018-04-18 08:39:29,040: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107111a20>]}
2018-04-18 08:39:29,047: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1045657b8>]}
2018-04-18 08:39:29,349: 08:39:29 | 3 of 91 OK created table model agency_data_pipeline.ga_conversions... [CREATE TABLE in 2.69s]
2018-04-18 08:39:29,351: 08:39:29 | 5 of 91 START table model agency_data_pipeline.all_dates............. [RUN]
2018-04-18 08:39:29,351: Compiling model.agency_data_pipeline.all_dates
2018-04-18 08:39:29,362: Writing injected SQL for node "model.agency_data_pipeline.all_dates"
2018-04-18 08:39:29,364: Acquiring new bigquery connection "all_dates".
2018-04-18 08:39:29,364: Re-using an available connection from the pool.
2018-04-18 08:39:29,643: 08:39:29 | 2 of 91 OK created table model agency_data_pipeline.clients_proc..... [CREATE TABLE in 2.70s]
2018-04-18 08:39:29,643: 08:39:29 | 6 of 91 START table model agency_data_pipeline.carts_proc............ [RUN]
2018-04-18 08:39:29,644: Compiling model.agency_data_pipeline.carts_proc
2018-04-18 08:39:29,650: Writing injected SQL for node "model.agency_data_pipeline.carts_proc"
2018-04-18 08:39:29,652: Acquiring new bigquery connection "carts_proc".
2018-04-18 08:39:29,652: Re-using an available connection from the pool.
2018-04-18 08:39:30,191: Model SQL (all_dates):
SELECT 
date_in_range,
unix_date(date_in_range) unix_date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-04-18 08:39:30,259: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1070cdef0>]}
2018-04-18 08:39:30,302: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107171278>]}
2018-04-18 08:39:30,471: Model SQL (carts_proc):
select 
client,
client_name,
account,
platform
from  ( 

SELECT  
client,
client_name,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.accounts`
WHERE platform in ('Shopify', 'Custom cart')

) 

WHERE lv = time_of_entry
2018-04-18 08:39:30,518: 08:39:30 | 4 of 91 OK created table model agency_data_pipeline.bing_ads_impression_share [CREATE TABLE in 3.90s]
2018-04-18 08:39:30,520: 08:39:30 | 7 of 91 START table model agency_data_pipeline.monthend_dates........ [RUN]
2018-04-18 08:39:30,522: Compiling model.agency_data_pipeline.monthend_dates
2018-04-18 08:39:30,532: Writing injected SQL for node "model.agency_data_pipeline.monthend_dates"
2018-04-18 08:39:30,533: Acquiring new bigquery connection "monthend_dates".
2018-04-18 08:39:30,533: Re-using an available connection from the pool.
2018-04-18 08:39:30,766: 08:39:30 | 1 of 91 OK created table model agency_data_pipeline.adwords_conversions [CREATE TABLE in 3.96s]
2018-04-18 08:39:30,767: 08:39:30 | 8 of 91 START table model agency_data_pipeline.accounts_proc......... [RUN]
2018-04-18 08:39:30,767: Compiling model.agency_data_pipeline.accounts_proc
2018-04-18 08:39:30,773: Writing injected SQL for node "model.agency_data_pipeline.accounts_proc"
2018-04-18 08:39:30,774: Acquiring new bigquery connection "accounts_proc".
2018-04-18 08:39:30,774: Re-using an available connection from the pool.
2018-04-18 08:39:31,312: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107111a20>]}
2018-04-18 08:39:31,417: Model SQL (monthend_dates):
SELECT
date_in_range,
date_in_range_bom,
date_in_range_bom_mom,
unix_date_in_range,
unix_date_in_range_bom,
unix_date(date_in_range_bom_mom) unix_date_in_range_bom_mom,
yyyymm,
date_in_range_yoy,
unix_date(date_in_range_yoy) unix_date_in_range_yoy

FROM
(
	SELECT 
	date_in_range,
	date_in_range_bom,
	date_sub(date_in_range_bom, INTERVAL 1 MONTH) date_in_range_bom_mom,
  date_sub(date_in_range, INTERVAL 1 YEAR) date_in_range_yoy,
	unix_date_in_range,
	unix_date(date_in_range_bom) unix_date_in_range_bom,
	yyyymm,
	first_value(date_in_range) over (partition by yyyymm order by date_in_range desc) monthend_date_in_range
	FROM
	( 
		SELECT 
		date_in_range,
		date_trunc( date_in_range, MONTH) date_in_range_bom,
		unix_date(date_in_range) unix_date_in_range,
		format_date("%Y-%m", date_in_range) AS yyyymm
		FROM UNNEST(
		    GENERATE_DATE_ARRAY(DATE('2016-01-31'), CURRENT_DATE(), INTERVAL 1 DAY)
		) AS date_in_range
	)
)
where date_in_range = monthend_date_in_range
2018-04-18 08:39:31,597: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107111a90>]}
2018-04-18 08:39:31,620: 08:39:31 | 5 of 91 OK created table model agency_data_pipeline.all_dates........ [CREATE TABLE in 1.96s]
2018-04-18 08:39:31,622: 08:39:31 | 9 of 91 START table model agency_data_pipeline.conversion_goals_proc. [RUN]
2018-04-18 08:39:31,624: Compiling model.agency_data_pipeline.conversion_goals_proc
2018-04-18 08:39:31,632: Writing injected SQL for node "model.agency_data_pipeline.conversion_goals_proc"
2018-04-18 08:39:31,635: Acquiring new bigquery connection "conversion_goals_proc".
2018-04-18 08:39:31,635: Re-using an available connection from the pool.
2018-04-18 08:39:31,757: Model SQL (accounts_proc):
select 
client,
account,
platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.accounts` 

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-04-18 08:39:31,943: 08:39:31 | 6 of 91 OK created table model agency_data_pipeline.carts_proc....... [CREATE TABLE in 1.95s]
2018-04-18 08:39:31,943: 08:39:31 | 10 of 91 START table model agency_data_pipeline.adwords_urls......... [RUN]
2018-04-18 08:39:31,944: Compiling model.agency_data_pipeline.adwords_urls
2018-04-18 08:39:31,952: Writing injected SQL for node "model.agency_data_pipeline.adwords_urls"
2018-04-18 08:39:31,953: Acquiring new bigquery connection "adwords_urls".
2018-04-18 08:39:31,954: Re-using an available connection from the pool.
2018-04-18 08:39:32,513: Model SQL (conversion_goals_proc):
select 
client,
platform,
goal_name,
max(goal_type) goal_type,
account,
max(time_of_entry) time_of_entry
from  ( 

SELECT  
client,
platform,
trim(replace(replace(lower(goal_name),',',''),' ','')) goal_name,
goal_type,
account,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY platform ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.conversion_goals` 

) 

WHERE lv = time_of_entry
group by client, platform, account, goal_name
2018-04-18 08:39:32,522: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1070cdef0>]}
2018-04-18 08:39:32,827: 08:39:32 | 7 of 91 OK created table model agency_data_pipeline.monthend_dates... [CREATE TABLE in 2.00s]
2018-04-18 08:39:32,828: 08:39:32 | 11 of 91 START table model agency_data_pipeline.bing_ads_ads......... [RUN]
2018-04-18 08:39:32,828: Compiling model.agency_data_pipeline.bing_ads_ads
2018-04-18 08:39:32,835: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_ads"
2018-04-18 08:39:32,836: Acquiring new bigquery connection "bing_ads_ads".
2018-04-18 08:39:32,836: Re-using an available connection from the pool.
2018-04-18 08:39:32,892: Model SQL (adwords_urls):
SELECT
campaignid,
lower(trim(regexp_replace(replace(replace(replace(replace(finalurl,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url

FROM (

SELECT  
campaignid,
finalurl,
first_value(finalurl) OVER (PARTITION BY campaignid ORDER BY day DESC) lv
FROM `growth-engines-pipeline.adwords_2.FINAL_URL_REPORT`
)

WHERE lv = finalurl
group by campaignid, url
order by campaignid asc
2018-04-18 08:39:33,723: Model SQL (bing_ads_ads):
select
date, 
account, 
channel,
platform,
campaignid,
campaignname,
max(lower(trim(replace(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$','' ),'.html',''),'/'))) as url,
utm_campaign,
sum(cost) as cost,
sum(impressions) as impressions,
sum(clicks) as clicks,
sum(conversions) as conversions
from 
  ( 
SELECT  
cast(gregoriandate as date) date,
replace(accountname,',','') account,
'Paid' as channel,
'Bing Ads' as platform,
adid,
adtype,
campaignid, 
campaignname,
finalurl url,
case when regexp_contains(destinationurl, 'utm_campaign')
	then replace(lower(nullif(
  

    split(
        
  

    split(
        destinationurl,
        'utm_campaign='
        )[offset(1)]


,
        '&'
        )[offset(0)]


,'')),'+',' ') 
	else null end as utm_campaign,
spend cost, 
impressions, 
clicks, 
conversions,
_sdc_sequence,
first_value(_sdc_sequence) OVER (PARTITION BY adid, gregoriandate ORDER BY _sdc_sequence DESC) lv
FROM `growth-engines-pipeline.bing_ads.ad_performance_report` 
  )

where lv = _sdc_sequence
group by date, account, channel, platform, campaignid, campaignname, utm_campaign
2018-04-18 08:39:33,976: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107171278>]}
2018-04-18 08:39:34,261: 08:39:34 | 8 of 91 OK created table model agency_data_pipeline.accounts_proc.... [CREATE TABLE in 3.21s]
2018-04-18 08:39:34,262: 08:39:34 | 12 of 91 START table model agency_data_pipeline.adwords_campaigns.... [RUN]
2018-04-18 08:39:34,262: Compiling model.agency_data_pipeline.adwords_campaigns
2018-04-18 08:39:34,270: Writing injected SQL for node "model.agency_data_pipeline.adwords_campaigns"
2018-04-18 08:39:34,271: Acquiring new bigquery connection "adwords_campaigns".
2018-04-18 08:39:34,271: Re-using an available connection from the pool.
2018-04-18 08:39:34,738: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107111a20>]}
2018-04-18 08:39:35,112: 08:39:35 | 9 of 91 OK created table model agency_data_pipeline.conversion_goals_proc [CREATE TABLE in 3.11s]
2018-04-18 08:39:35,119: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107111a90>]}
2018-04-18 08:39:35,409: 08:39:35 | 10 of 91 OK created table model agency_data_pipeline.adwords_urls.... [CREATE TABLE in 3.17s]
2018-04-18 08:39:35,538: Model SQL (adwords_campaigns):
select
day,
campaignid, 
campaign,
account, 
channel,
platform,
sum(cost) cost,
sum(impressions) impressions,
sum(clicks) clicks,
sum(impression_share_num) impression_share_num,
sum(impression_share_den) impression_share_den
from 
  ( 
	SELECT  
	day,
	campaignid,
	campaign,
	account as account,
	'Paid' as channel,
	'Adwords' as platform,
	cost/1000000 cost, 
	impressions as impressions, 
	clicks, 
	case when searchimprshare is not null then impressions end as impression_share_num,
	case when searchimprshare is not null then impressions/(searchimprshare/100) end as impression_share_den,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY campaignid, day ORDER BY _sdc_sequence DESC) lv
	FROM `growth-engines-pipeline.adwords_2.CAMPAIGN_PERFORMANCE_REPORT`
  )
where lv = _sdc_sequence
group by day, campaignid, account, channel, platform, campaign
2018-04-18 08:39:36,277: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1070cdef0>]}
2018-04-18 08:39:36,568: 08:39:36 | 11 of 91 OK created table model agency_data_pipeline.bing_ads_ads.... [CREATE TABLE in 3.45s]
2018-04-18 08:39:41,078: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107171278>]}
2018-04-18 08:39:41,290: 08:39:41 | 12 of 91 OK created table model agency_data_pipeline.adwords_campaigns [CREATE TABLE in 6.82s]
2018-04-18 08:39:41,291: 08:39:41 | 13 of 91 START table model agency_data_pipeline.bing_ads_conversions. [RUN]
2018-04-18 08:39:41,292: Compiling model.agency_data_pipeline.bing_ads_conversions
2018-04-18 08:39:41,291: 08:39:41 | 14 of 91 START table model agency_data_pipeline.adwords_ads.......... [RUN]
2018-04-18 08:39:41,302: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_conversions"
2018-04-18 08:39:41,292: 08:39:41 | 15 of 91 START table model agency_data_pipeline.fb_ads_insights_conversions [RUN]
2018-04-18 08:39:41,302: Compiling model.agency_data_pipeline.adwords_ads
2018-04-18 08:39:41,292: 08:39:41 | 16 of 91 START table model agency_data_pipeline.shopify_refunds_proc. [RUN]
2018-04-18 08:39:41,303: Compiling model.agency_data_pipeline.fb_ads_insights_conversions
2018-04-18 08:39:41,311: Writing injected SQL for node "model.agency_data_pipeline.adwords_ads"
2018-04-18 08:39:41,312: Compiling model.agency_data_pipeline.shopify_refunds_proc
2018-04-18 08:39:41,323: Acquiring new bigquery connection "fb_ads_insights_conversions".
2018-04-18 08:39:41,324: Acquiring new bigquery connection "bing_ads_conversions".
2018-04-18 08:39:41,340: Re-using an available connection from the pool.
2018-04-18 08:39:41,352: Acquiring new bigquery connection "shopify_refunds_proc".
2018-04-18 08:39:41,355: Acquiring new bigquery connection "adwords_ads".
2018-04-18 08:39:41,370: Re-using an available connection from the pool.
2018-04-18 08:39:41,371: Fetching data for query fb_ads_insights_conversions:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 08:39:41,371: Re-using an available connection from the pool.
2018-04-18 08:39:41,374: Fetching data for query shopify_refunds_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 08:39:41,376: Re-using an available connection from the pool.
2018-04-18 08:39:42,511: Model SQL (bing_ads_conversions):
SELECT
date, 
a.account account, 
a.channel channel,
a.platform platform,
campaignid,
campaignname,
sum( case when b.goal_type = 'Transactions' then conversions else 0 end ) as transactions
FROM

  ( 
SELECT  
cast(gregoriandate as date) date,
replace(accountname,',','') account,
'Paid' as channel,
'Bing Ads' as platform,
trim(replace(replace(lower(goal),',',''),' ','')) goal,
goalid,
campaignid,
campaignname,
conversions,
_sdc_sequence,
first_value(_sdc_sequence) OVER (PARTITION BY campaignid, goalid, gregoriandate ORDER BY _sdc_sequence DESC) lv
FROM `growth-engines-pipeline.bing_ads.goals_and_funnels_report` 

  ) a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`conversion_goals_proc` b
ON (
	a.account = b.account AND
	a.platform = b.platform AND
	a.goal = b.goal_name
)
where a.lv = a._sdc_sequence
group by date, account, channel, platform, campaignid, campaignname
2018-04-18 08:39:42,512: Model SQL (adwords_ads):
SELECT  
day,
campaignid,
a.account as account,
utm_campaign,
sum( case when b.goal_type = 'Transaction' then conversions else 0 end ) as transactions
FROM (

	SELECT  
	day,
	adid,
	campaignid,
	account,
	lower(conversionname) conversionname,
	conversions,
	lower(campaign) utm_campaign,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY campaignid, day ORDER BY _sdc_sequence DESC) lv
	FROM
	`growth-engines-pipeline.adwords_2.AD_PERFORMANCE_REPORT`

) a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_conversions` b
ON ( a.conversionname = b.goal_name
	AND a.account = b.account )
WHERE lv = _sdc_sequence
group by day, campaignid, account, utm_campaign
2018-04-18 08:39:42,866: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_insights_conversions"
2018-04-18 08:39:43,051: Writing injected SQL for node "model.agency_data_pipeline.shopify_refunds_proc"
2018-04-18 08:39:43,771: Model SQL (fb_ads_insights_conversions):




with fb_ads_insights_conversions as (

	    
		   	SELECT 
			date_start,
			campaign_id,
			campaign_name,
			ad_id,
			account_name,
			spend,
			reach,
			inline_link_clicks,
			_sdc_sequence,
			action_type,
			value
			FROM `growth-engines-pipeline.fb_ads_luca_danni.ads_insights`
			cross join unnest(actions)
		    
	   

)

SELECT * 
FROM 
	(
    SELECT
    date_start date,
    campaign_id,
    campaign_name campaign,
    ad_id,
    account_name account,
    action_type,
    value conversions,
    first_value(_sdc_sequence) OVER (PARTITION BY ad_id, date_start ORDER BY _sdc_sequence DESC) lv,
    _sdc_sequence
    FROM fb_ads_insights_conversions
   	)
where lv = _sdc_sequence
and action_type like '%purchase%'


2018-04-18 08:39:43,905: Model SQL (shopify_refunds_proc):




with refunds as (

	
	SELECT
	order_number,
	checkout_id,
	financial_status,
	line_item_id,
	quantity,
	subtotal,
	line_item.variant_id variant_id,
	line_item.id refund_id,
 	_sdc_sequence
	FROM `growth-engines-pipeline.shopify_lucadanni.orders` 
	cross join unnest(refunds), unnest(refund_line_items)
  	where financial_status like '%refund%'
	
	

)

SELECT * 
FROM 
	(
    SELECT
	order_number,
	checkout_id,
	financial_status,
	line_item_id,
	quantity,
	subtotal refund_amount,
	variant_id,
	refund_id,
 	_sdc_sequence,
    first_value(_sdc_sequence) OVER (PARTITION BY order_number, line_item_id ORDER BY _sdc_sequence DESC) lv
    FROM refunds
   	) 
WHERE lv = _sdc_sequence


2018-04-18 08:39:44,728: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107171160>]}
2018-04-18 08:39:44,948: 08:39:44 | 13 of 91 OK created table model agency_data_pipeline.bing_ads_conversions [CREATE TABLE in 3.44s]
2018-04-18 08:39:44,948: 08:39:44 | 17 of 91 START table model agency_data_pipeline.fb_ads_insights...... [RUN]
2018-04-18 08:39:44,949: Compiling model.agency_data_pipeline.fb_ads_insights
2018-04-18 08:39:44,959: Acquiring new bigquery connection "fb_ads_insights".
2018-04-18 08:39:44,959: Re-using an available connection from the pool.
2018-04-18 08:39:44,960: Fetching data for query fb_ads_insights:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 08:39:45,620: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_insights"
2018-04-18 08:39:45,856: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1095222e8>]}
2018-04-18 08:39:46,085: 08:39:46 | 14 of 91 OK created table model agency_data_pipeline.adwords_ads..... [CREATE TABLE in 4.55s]
2018-04-18 08:39:46,086: 08:39:46 | 18 of 91 START table model agency_data_pipeline.ga_mcf_proc.......... [RUN]
2018-04-18 08:39:46,087: Compiling model.agency_data_pipeline.ga_mcf_proc
2018-04-18 08:39:46,093: Writing injected SQL for node "model.agency_data_pipeline.ga_mcf_proc"
2018-04-18 08:39:46,094: Acquiring new bigquery connection "ga_mcf_proc".
2018-04-18 08:39:46,094: Re-using an available connection from the pool.
2018-04-18 08:39:46,109: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1070cdef0>]}
2018-04-18 08:39:46,334: 08:39:46 | 16 of 91 OK created table model agency_data_pipeline.shopify_refunds_proc [CREATE TABLE in 4.80s]
2018-04-18 08:39:46,335: 08:39:46 | 19 of 91 START table model agency_data_pipeline.fb_adcreative........ [RUN]
2018-04-18 08:39:46,337: Compiling model.agency_data_pipeline.fb_adcreative
2018-04-18 08:39:46,347: Acquiring new bigquery connection "fb_adcreative".
2018-04-18 08:39:46,347: Re-using an available connection from the pool.
2018-04-18 08:39:46,347: Fetching data for query fb_adcreative:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 08:39:46,475: Model SQL (fb_ads_insights):




with fb_ads_insights as (

	    
		   	SELECT 
			date_start,
			campaign_id,
			campaign_name,
			ad_id,
			account_name,
			spend,
			reach,
			inline_link_clicks,
			_sdc_sequence,
			first_value(_sdc_sequence) OVER (PARTITION BY date_start, ad_id, campaign_id ORDER BY _sdc_sequence DESC) lv
			FROM `growth-engines-pipeline.fb_ads_luca_danni.ads_insights`
		    
	   

)

select
date_start date,
campaign_id,
campaign_name campaign,
ad_id,
account_name account,
max(spend) cost,
max(reach) impressions,
max(inline_link_clicks) clicks
from fb_ads_insights
where lv = _sdc_sequence
group by date, campaign_id, ad_id, account, campaign


2018-04-18 08:39:46,709: Writing injected SQL for node "model.agency_data_pipeline.fb_adcreative"
2018-04-18 08:39:46,908: Model SQL (ga_mcf_proc):
SELECT 
date,
account,
'Google Analytics' as lookup_platform,
source_medium_path,
trim(lower(split(split(source_medium_path,'->')[SAFE_ORDINAL(1)],'/')[SAFE_ORDINAL(1)])) as source,
trim(lower(split(split(source_medium_path,'->')[SAFE_ORDINAL(1)],'/')[SAFE_ORDINAL(2)])) as medium,
first_interaction_campaign campaign,
cast(regexp_replace(transaction_id, r'#', '') as int64) transactionid,
max(first_interaction_conversions) transactions,
max(first_interaction_conversion_value) revenue
FROM `growth-engines-pipeline.agency_data_pipeline.ga_mcf`
where account in (select account from `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc` where platform = 'Google Analytics')
group by date, account, source, medium, campaign, source_medium_path, lookup_platform, transactionid
2018-04-18 08:39:47,140: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104583a58>]}
2018-04-18 08:39:47,359: 08:39:47 | 15 of 91 OK created table model agency_data_pipeline.fb_ads_insights_conversions [CREATE TABLE in 5.84s]
2018-04-18 08:39:47,360: 08:39:47 | 20 of 91 START table model agency_data_pipeline.mappings_ga_proc..... [RUN]
2018-04-18 08:39:47,360: Compiling model.agency_data_pipeline.mappings_ga_proc
2018-04-18 08:39:47,369: Writing injected SQL for node "model.agency_data_pipeline.mappings_ga_proc"
2018-04-18 08:39:47,370: Acquiring new bigquery connection "mappings_ga_proc".
2018-04-18 08:39:47,370: Re-using an available connection from the pool.
2018-04-18 08:39:47,442: Model SQL (fb_adcreative):




with fb_adcreative as (


	    
		   	SELECT 
			id,
			object_url,
			url_tags,
			_sdc_sequence
			FROM `growth-engines-pipeline.fb_ads_luca_danni.adcreative`
		    
	   
)

select creative_id, max(url) url
from (
  select
  id creative_id,
  lower(trim(regexp_replace(replace(replace(replace(replace(object_url,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
  first_value(_sdc_sequence) OVER (PARTITION BY id ORDER BY _sdc_sequence DESC) lv,
  _sdc_sequence
  from fb_adcreative
  )
where lv = _sdc_sequence
group by creative_id


2018-04-18 08:39:47,988: Model SQL (mappings_ga_proc):
select 
client,
account,
client_name,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
account,
client_name,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.mappings_ga` 

) 

WHERE lv = time_of_entry
and client in (select client from `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc` )
group by client, account, client_name, source, medium, platform_n, channel_n, time_of_entry
2018-04-18 08:39:49,631: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1070cdef0>]}
2018-04-18 08:39:49,781: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107171160>]}
2018-04-18 08:39:49,970: 08:39:49 | 19 of 91 OK created table model agency_data_pipeline.fb_adcreative... [CREATE TABLE in 3.29s]
2018-04-18 08:39:50,213: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104583a58>]}
2018-04-18 08:39:50,257: 08:39:50 | 17 of 91 OK created table model agency_data_pipeline.fb_ads_insights. [CREATE TABLE in 4.83s]
2018-04-18 08:39:50,518: 08:39:50 | 20 of 91 OK created table model agency_data_pipeline.mappings_ga_proc [CREATE TABLE in 2.85s]
2018-04-18 08:39:51,356: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10451a5c0>]}
2018-04-18 08:39:51,655: 08:39:51 | 18 of 91 OK created table model agency_data_pipeline.ga_mcf_proc..... [CREATE TABLE in 5.27s]
2018-04-18 08:39:51,656: 08:39:51 | 21 of 91 START table model agency_data_pipeline.shopify_customers_proc [RUN]
2018-04-18 08:39:51,656: 08:39:51 | 22 of 91 START table model agency_data_pipeline.fb_ads............... [RUN]
2018-04-18 08:39:51,656: Compiling model.agency_data_pipeline.shopify_customers_proc
2018-04-18 08:39:51,657: Compiling model.agency_data_pipeline.fb_ads
2018-04-18 08:39:51,674: Acquiring new bigquery connection "shopify_customers_proc".
2018-04-18 08:39:51,675: Re-using an available connection from the pool.
2018-04-18 08:39:51,675: Fetching data for query shopify_customers_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 08:39:51,684: Acquiring new bigquery connection "fb_ads".
2018-04-18 08:39:51,685: Re-using an available connection from the pool.
2018-04-18 08:39:51,685: Fetching data for query fb_ads:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 08:39:52,083: Writing injected SQL for node "model.agency_data_pipeline.shopify_customers_proc"
2018-04-18 08:39:52,112: Writing injected SQL for node "model.agency_data_pipeline.fb_ads"
2018-04-18 08:39:52,868: Model SQL (fb_ads):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`fb_adcreative`





with fb_ads as (

	    
		   	SELECT 
			id ad_id,
			creative.creative_id creative_id,
			_sdc_sequence
			FROM `growth-engines-pipeline.fb_ads_luca_danni.ads`
		     
	   

)

SELECT
a.ad_id,
b.creative_id,
b.url
FROM (
    SELECT
    ad_id,
    creative_id,
    first_value(_sdc_sequence) OVER (PARTITION BY ad_id ORDER BY _sdc_sequence DESC) lv,
    _sdc_sequence
    FROM fb_ads
    ) a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`fb_adcreative` b
ON (
	a.creative_id = b.creative_id 
)
WHERE a.lv = a._sdc_sequence


2018-04-18 08:39:52,960: Model SQL (shopify_customers_proc):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc`





with customers as (

	
	SELECT
	'lucadanni' client_name,
	'Shopify' as lookup_platform,
	cast(created_at as date) created_at,
	id,
	first_name,
	last_name,
	email,
	_sdc_sequence,
	first_value(_sdc_sequence) over (partition by id, _sdc_sequence order by _sdc_sequence desc) lv
	FROM `growth-engines-pipeline.shopify_lucadanni.customers` 
	
	

)

SELECT
account,
client,
platform,
id,
min(created_at) created_at,
max(first_name) first_name,
max(last_name) last_name,
max(email) email
FROM (
	SELECT
	b.account,
	b.client,
	b.platform,
	created_at,
	id,
	first_name,
	last_name,
	email
	FROM customers a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
	ON ( a.client_name = b.client_name
	  AND a.lookup_platform = b.platform )
	where a.lv = a._sdc_sequence
)
group by account, client, platform, id

2018-04-18 08:39:55,075: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109524e80>]}
2018-04-18 08:39:55,365: 08:39:55 | 22 of 91 OK created table model agency_data_pipeline.fb_ads.......... [CREATE TABLE in 3.42s]
2018-04-18 08:39:57,369: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1094fecf8>]}
2018-04-18 08:39:57,658: 08:39:57 | 21 of 91 OK created table model agency_data_pipeline.shopify_customers_proc [CREATE TABLE in 5.71s]
2018-04-18 08:39:57,658: 08:39:57 | 23 of 91 START table model agency_data_pipeline.bing_ads_stats....... [RUN]
2018-04-18 08:39:57,659: Compiling model.agency_data_pipeline.bing_ads_stats
2018-04-18 08:39:57,659: 08:39:57 | 24 of 91 START table model agency_data_pipeline.ga_mcf_stats......... [RUN]
2018-04-18 08:39:57,666: Compiling model.agency_data_pipeline.ga_mcf_stats
2018-04-18 08:39:57,675: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_stats"
2018-04-18 08:39:57,680: Writing injected SQL for node "model.agency_data_pipeline.ga_mcf_stats"
2018-04-18 08:39:57,659: 08:39:57 | 25 of 91 START table model agency_data_pipeline.shopify_orders_proc.. [RUN]
2018-04-18 08:39:57,680: Compiling model.agency_data_pipeline.shopify_orders_proc
2018-04-18 08:39:57,659: 08:39:57 | 26 of 91 START table model agency_data_pipeline.shopify_products_proc [RUN]
2018-04-18 08:39:57,687: Compiling model.agency_data_pipeline.shopify_products_proc
2018-04-18 08:39:57,713: Acquiring new bigquery connection "ga_mcf_stats".
2018-04-18 08:39:57,716: Acquiring new bigquery connection "shopify_orders_proc".
2018-04-18 08:39:57,717: Acquiring new bigquery connection "bing_ads_stats".
2018-04-18 08:39:57,723: Acquiring new bigquery connection "shopify_products_proc".
2018-04-18 08:39:57,723: Re-using an available connection from the pool.
2018-04-18 08:39:57,724: Re-using an available connection from the pool.
2018-04-18 08:39:57,725: Fetching data for query shopify_orders_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 08:39:57,728: Re-using an available connection from the pool.
2018-04-18 08:39:57,732: Re-using an available connection from the pool.
2018-04-18 08:39:57,733: Fetching data for query shopify_products_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 08:39:58,125: Writing injected SQL for node "model.agency_data_pipeline.shopify_products_proc"
2018-04-18 08:39:58,177: Writing injected SQL for node "model.agency_data_pipeline.shopify_orders_proc"
2018-04-18 08:39:58,655: Model SQL (bing_ads_stats):
select
a.date, 
a.account, 
a.channel,
a.platform,
url,
a.campaignname campaign,
utm_campaign,
cost,
clicks,
impressions,
transactions
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`bing_ads_ads` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`bing_ads_conversions` b
ON (
	a.date = b.date AND
	a.account = b.account AND
	a.campaignid = b.campaignid

)
2018-04-18 08:39:58,743: Model SQL (ga_mcf_stats):
SELECT  
date,
a.account account,
b.client client,
case when c.platform is null then "Unmapped" else c.platform end as platform,
case when c.channel is null then "Unmapped" else c.channel end as channel,
lower(a.source) source,
lower(a.medium) medium,
lower(campaign) campaign,
transactionid,
sum(transactions) first_touch_transactions,
sum(revenue) first_touch_revenue
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`ga_mcf_proc` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc` b 
ON ( a.account = b.account and
	a.lookup_platform = b.platform )
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc` c
ON ( lower(a.source) = c.source
  AND lower(a.medium) = c.medium 
  and a.account = c.account )
group by date, account, client, source, medium, campaign, platform, channel, transactionid
2018-04-18 08:39:59,089: Model SQL (shopify_products_proc):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc`, `growth-engines-pipeline`.`agency_data_pipeline`.`shopify_refunds_proc`





with products as (

	
	SELECT
	'lucadanni' client_name,
	'Shopify' as lookup_platform,
	product_type,
	product_id,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY product_id ORDER BY _sdc_sequence DESC) lv
	FROM `growth-engines-pipeline.shopify_lucadanni.products` 
	cross join unnest(variants)
	
	

)

SELECT
b.account,
b.client,
b.platform,
max(product_type) product_type,
product_id
FROM products a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
ON ( a.client_name = b.client_name
  AND a.lookup_platform = b.platform )
where a.lv = a._sdc_sequence
group by product_id, account, client, platform


2018-04-18 08:39:59,204: Model SQL (shopify_orders_proc):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc`, `growth-engines-pipeline`.`agency_data_pipeline`.`shopify_refunds_proc`





with orders as (

	
	SELECT
	'lucadanni' client_name,
	'Shopify' as lookup_platform,
	created_at,
	order_number,
	quantity,
	cast(pre_tax_price as float64) price, 
	total_line_items_price total_order_price_undiscounted,
	total_discounts,
	cast(discounted_price as float64) total_order_shipping_price,
	total_price_usd total_order_price_incl_shipping,
	checkout_id,
	product_id, 
	landing_site,
	sku, 
	variant_title, 
	variant_id,
	_id line_item_id,
	customer.id customer_id,
	customer.orders_count orders_count,
	customer.created_at customer_created_at,
	customer.last_order_id last_order_id,
	financial_status,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY order_number, _id ORDER BY _sdc_sequence DESC) lv
	FROM `growth-engines-pipeline.shopify_lucadanni.orders` 
	cross join unnest(line_items), unnest(shipping_lines)
	where source_name != 'shopify_draft_order'
	
	

)

SELECT
b.account,
b.client,
b.platform,
created_at,
a.order_number,
a.quantity,
c.quantity refund_quantity,
case when c.quantity is not null then a.quantity - c.quantity else a.quantity end as final_quantity,
price, 
total_order_price_undiscounted,
total_discounts,
total_order_shipping_price,
total_order_price_incl_shipping,
refund_amount,
case when refund_amount is not null then price - refund_amount else price end as final_price,
a.checkout_id,
a.product_id, 
landing_site,
sku, 
variant_title, 
a.variant_id,
a.line_item_id,	
customer_id,
orders_count,
customer_created_at,
last_order_id,
a.financial_status
FROM orders a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
ON ( a.client_name = b.client_name
  AND a.lookup_platform = b.platform )
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`shopify_refunds_proc` c
ON ( a.order_number = c.order_number
	AND a.line_item_id = c.line_item_id )   	
where a.lv = a._sdc_sequence


2018-04-18 08:40:00,857: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1071848d0>]}
2018-04-18 08:40:01,155: 08:40:01 | 23 of 91 OK created table model agency_data_pipeline.bing_ads_stats.. [CREATE TABLE in 3.20s]
2018-04-18 08:40:01,155: 08:40:01 | 27 of 91 START table model agency_data_pipeline.agg_customers_union.. [RUN]
2018-04-18 08:40:01,156: Compiling model.agency_data_pipeline.agg_customers_union
2018-04-18 08:40:01,164: Writing injected SQL for node "model.agency_data_pipeline.agg_customers_union"
2018-04-18 08:40:01,165: Acquiring new bigquery connection "agg_customers_union".
2018-04-18 08:40:01,166: Re-using an available connection from the pool.
2018-04-18 08:40:02,017: Model SQL (agg_customers_union):
SELECT *
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`shopify_customers_proc`
2018-04-18 08:40:02,327: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10452e438>]}
2018-04-18 08:40:02,627: 08:40:02 | 26 of 91 OK created table model agency_data_pipeline.shopify_products_proc [CREATE TABLE in 4.64s]
2018-04-18 08:40:04,250: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10712c550>]}
2018-04-18 08:40:04,766: 08:40:04 | 24 of 91 OK created table model agency_data_pipeline.ga_mcf_stats.... [CREATE TABLE in 6.58s]
2018-04-18 08:40:06,426: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10452e0b8>]}
2018-04-18 08:40:06,725: 08:40:06 | 27 of 91 OK created table model agency_data_pipeline.agg_customers_union [CREATE TABLE in 5.27s]
2018-04-18 08:40:09,227: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1070ab320>]}
2018-04-18 08:40:09,450: 08:40:09 | 25 of 91 OK created table model agency_data_pipeline.shopify_orders_proc [CREATE TABLE in 11.55s]
2018-04-18 08:40:09,451: 08:40:09 | 28 of 91 START table model agency_data_pipeline.ga_transactions...... [RUN]
2018-04-18 08:40:09,452: Compiling model.agency_data_pipeline.ga_transactions
2018-04-18 08:40:09,451: 08:40:09 | 29 of 91 START table model agency_data_pipeline.ga_traffic........... [RUN]
2018-04-18 08:40:09,459: Compiling model.agency_data_pipeline.ga_traffic
2018-04-18 08:40:09,452: 08:40:09 | 30 of 91 START table model agency_data_pipeline.agg_products......... [RUN]
2018-04-18 08:40:09,452: 08:40:09 | 31 of 91 START table model agency_data_pipeline.adwords_join......... [RUN]
2018-04-18 08:40:09,479: Acquiring new bigquery connection "ga_transactions".
2018-04-18 08:40:09,485: Acquiring new bigquery connection "ga_traffic".
2018-04-18 08:40:09,485: Compiling model.agency_data_pipeline.agg_products
2018-04-18 08:40:09,485: Compiling model.agency_data_pipeline.adwords_join
2018-04-18 08:40:09,486: Re-using an available connection from the pool.
2018-04-18 08:40:09,493: Writing injected SQL for node "model.agency_data_pipeline.agg_products"
2018-04-18 08:40:09,499: Writing injected SQL for node "model.agency_data_pipeline.adwords_join"
2018-04-18 08:40:09,499: Fetching data for query ga_transactions:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Google Analytics'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 08:40:09,500: Re-using an available connection from the pool.
2018-04-18 08:40:09,501: Fetching data for query ga_traffic:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'GA Traffic'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 08:40:09,504: Acquiring new bigquery connection "agg_products".
2018-04-18 08:40:09,504: Re-using an available connection from the pool.
2018-04-18 08:40:09,511: Acquiring new bigquery connection "adwords_join".
2018-04-18 08:40:09,512: Re-using an available connection from the pool.
2018-04-18 08:40:10,366: Model SQL (adwords_join):
select
a.day,
a.campaignid, 
a.campaign,
a.account, 
channel,
platform,
url,
utm_campaign,
cost,
impressions,
clicks,
impression_share_num,
impression_share_den,
transactions
FROM ( 
	
	select
	day,
	a.campaign,
	a.campaignid, 
	account, 
	channel,
	platform,
	url,
	cost,
	impressions,
	clicks,
	impression_share_num,
	impression_share_den
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_campaigns` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_urls` b
	ON a.campaignid = b.campaignid

) a 
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_ads` b
ON ( a.campaignid = b.campaignid
	and a.day = b.day )
2018-04-18 08:40:10,409: Model SQL (agg_products):
SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`shopify_products_proc`
2018-04-18 08:40:10,717: Fetching data for query ga_transactions:


        select
            goal_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_conversions`

        
        ##where 1 = 1
        where goal_type = 'Conversion'
        
        
        
        ##and 2 = 2
        and client_name = 'lucadanni'
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 08:40:10,835: Fetching data for query ga_traffic:


        select
            goal_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_conversions`

        
        ##where 1 = 1
        where goal_type = 'Conversion'
        
        
        
        ##and 2 = 2
        and client_name = 'lucadanni'
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 08:40:11,496: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107111a90>]}
2018-04-18 08:40:11,713: 08:40:11 | 30 of 91 OK created table model agency_data_pipeline.agg_products.... [CREATE TABLE in 2.01s]
2018-04-18 08:40:11,714: 08:40:11 | 32 of 91 START table model agency_data_pipeline.agg_orders_union..... [RUN]
2018-04-18 08:40:11,714: Compiling model.agency_data_pipeline.agg_orders_union
2018-04-18 08:40:11,722: Writing injected SQL for node "model.agency_data_pipeline.agg_orders_union"
2018-04-18 08:40:11,723: Acquiring new bigquery connection "agg_orders_union".
2018-04-18 08:40:11,724: Re-using an available connection from the pool.
2018-04-18 08:40:11,803: Writing injected SQL for node "model.agency_data_pipeline.ga_transactions"
2018-04-18 08:40:12,329: Writing injected SQL for node "model.agency_data_pipeline.ga_traffic"
2018-04-18 08:40:12,603: Model SQL (agg_orders_union):
SELECT
account,
client,
platform,
created_at,
order_number,
quantity,
refund_quantity,
final_quantity,
price, 
total_order_price_undiscounted,
total_discounts,
total_order_shipping_price,
total_order_price_incl_shipping,
refund_amount,
final_price,
checkout_id,
product_id, 
landing_site,
sku, 
variant_title, 
variant_id,
line_item_id,	
customer_id,
orders_count,
customer_created_at,
last_order_id,
financial_status
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`shopify_orders_proc`
2018-04-18 08:40:12,643: Model SQL (ga_transactions):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc`, `growth-engines-pipeline`.`agency_data_pipeline`.`ga_conversions`


##`growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` 



with ga_report as (

	    

	    	
	    	
		   	SELECT
		   	'lucadanni' as client_name,
		   	'Google Analytics' as lookup_platform,
			lower(trim(regexp_replace(replace(replace(replace(replace(CONCAT(hostname,landingpagepath),'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
			date,
			lower(source) source,
			lower(medium) medium,
			lower(campaign) campaign,
			cast(regexp_replace(transactionid, r'#', '') as int64) transactionid,
			transactions last_touch_transactions,
			(transactionrevenue - transactionshipping - transactiontax) as last_touch_revenue,
			transactionshipping,
			transactiontax,
			_sdc_sequence,
			first_value(_sdc_sequence) OVER (PARTITION BY hostname, landingpagepath, date, source, medium, transactionid ORDER BY _sdc_sequence DESC) lv
			FROM `growth-engines-pipeline.ga_lucadanni.report` 

		    
	   

)


SELECT  
cast(date as date) date,
b.account,
b.client client,
c.source source,
c.medium medium,
a.campaign campaign,
concat(a.source, ' / ', a.medium) source_medium,  
case when c.platform is null then "Unmapped" else c.platform end as platform,
case when c.channel is null then "Unmapped" else c.channel end as channel,
regexp_replace(url, r'offers.|offer.|get.|info.|pos.|go.|join.|pages.','') url,
transactionid,
max(last_touch_transactions) last_touch_transactions,
max(last_touch_revenue) last_touch_revenue,
max(transactionshipping) last_touch_shipping,
max(transactiontax) last_touch_tax
FROM ga_report a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
ON ( a.client_name = b.client_name 
	AND a.lookup_platform = b.platform )
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc` c
ON ( a.source = c.source
  AND a.medium = c.medium 
  AND a.client_name = c.client_name )
GROUP BY date, account, client, source, medium, campaign, source_medium, platform, channel, url, transactionid


2018-04-18 08:40:13,035: Model SQL (ga_traffic):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc`, `growth-engines-pipeline`.`agency_data_pipeline`.`ga_conversions`


##`growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` 



with ga_report as (

	    

	    	
	    	
		   	SELECT
		   	'lucadanni' as client_name,
		   	'GA Traffic' as lookup_platform,
			lower(trim(regexp_replace(replace(replace(replace(replace(CONCAT(hostname,landingpagepath),'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
			date,
			lower(source) source,
			lower(medium) medium,
			lower(campaign) campaign,
			sessions,
			## goal completion columns
							
				goalcompletionsall as goal_completions,		
			
			_sdc_sequence,
			first_value(_sdc_sequence) OVER (PARTITION BY hostname, landingpagepath, date, source, medium, campaign ORDER BY _sdc_sequence DESC) lv
			FROM `growth-engines-pipeline.ga_lucadanni_traffic.report` 

		    
	   

)


SELECT  
cast(date as date) date,
b.account,
b.client client,
c.source source,
c.medium medium,
a.campaign campaign,
concat(a.source, ' / ', a.medium) source_medium,  
case when c.platform is null then "Unmapped" else c.platform end as platform,
case when c.channel is null then "Unmapped" else c.channel end as channel,
regexp_replace(url, r'offers.|offer.|get.|info.|pos.|go.|join.|pages.','') url,
max(sessions) sessions,
max(goal_completions) goal_completions
FROM ga_report a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
ON ( a.client_name = b.client_name 
	AND a.lookup_platform = b.platform )
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc` c
ON ( a.source = c.source
  AND a.medium = c.medium 
  AND a.client_name = c.client_name )
GROUP BY date, account, client, source, medium, campaign, source_medium, platform, channel, url


2018-04-18 08:40:15,858: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1045499b0>]}
2018-04-18 08:40:16,156: 08:40:16 | 31 of 91 OK created table model agency_data_pipeline.adwords_join.... [CREATE TABLE in 6.37s]
2018-04-18 08:40:18,167: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107171278>]}
2018-04-18 08:40:18,514: 08:40:18 | 28 of 91 OK created table model agency_data_pipeline.ga_transactions. [CREATE TABLE in 8.71s]
2018-04-18 08:40:20,282: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107111a90>]}
2018-04-18 08:40:20,499: 08:40:20 | 32 of 91 OK created table model agency_data_pipeline.agg_orders_union [CREATE TABLE in 8.57s]
2018-04-18 08:40:23,332: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10455e828>]}
2018-04-18 08:40:24,009: 08:40:24 | 29 of 91 OK created table model agency_data_pipeline.ga_traffic...... [CREATE TABLE in 13.87s]
2018-04-18 08:40:24,010: 08:40:24 | 33 of 91 START table model agency_data_pipeline.agg_transaction_order_number [RUN]
2018-04-18 08:40:24,011: Compiling model.agency_data_pipeline.agg_transaction_order_number
2018-04-18 08:40:24,010: 08:40:24 | 34 of 91 START table model agency_data_pipeline.adwords_stats........ [RUN]
2018-04-18 08:40:24,020: Writing injected SQL for node "model.agency_data_pipeline.agg_transaction_order_number"
2018-04-18 08:40:24,011: 08:40:24 | 35 of 91 START table model agency_data_pipeline.agg_transaction_line_item [RUN]
2018-04-18 08:40:24,021: Compiling model.agency_data_pipeline.adwords_stats
2018-04-18 08:40:24,011: 08:40:24 | 36 of 91 START table model agency_data_pipeline.adwords_impression_share [RUN]
2018-04-18 08:40:24,021: Compiling model.agency_data_pipeline.agg_transaction_line_item
2018-04-18 08:40:24,027: Writing injected SQL for node "model.agency_data_pipeline.adwords_stats"
2018-04-18 08:40:24,027: Compiling model.agency_data_pipeline.adwords_impression_share
2018-04-18 08:40:24,028: Acquiring new bigquery connection "agg_transaction_order_number".
2018-04-18 08:40:24,032: Writing injected SQL for node "model.agency_data_pipeline.agg_transaction_line_item"
2018-04-18 08:40:24,039: Writing injected SQL for node "model.agency_data_pipeline.adwords_impression_share"
2018-04-18 08:40:24,040: Re-using an available connection from the pool.
2018-04-18 08:40:24,041: Acquiring new bigquery connection "adwords_stats".
2018-04-18 08:40:24,046: Acquiring new bigquery connection "adwords_impression_share".
2018-04-18 08:40:24,047: Acquiring new bigquery connection "agg_transaction_line_item".
2018-04-18 08:40:24,048: Re-using an available connection from the pool.
2018-04-18 08:40:24,055: Re-using an available connection from the pool.
2018-04-18 08:40:24,058: Re-using an available connection from the pool.
2018-04-18 08:40:25,074: Model SQL (adwords_stats):
SELECT 
cast(day as date) date, 
account, 
platform,
channel,
url,
utm_campaign,
campaign,
sum(cost) cost,
sum(impressions) impressions,
sum(clicks) clicks,
sum(transactions) transactions
FROM 
  `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_join`
group by date, account, platform, channel, url, campaign, utm_campaign
2018-04-18 08:40:25,183: Model SQL (agg_transaction_line_item):
SELECT
client,
created_at,
order_number,
quantity,
refund_quantity,
final_quantity,
price, 
total_order_price_undiscounted,
total_discounts,
total_order_shipping_price,
total_order_price_incl_shipping,
refund_amount,
final_price,
checkout_id,
product_id, 
landing_site,
sku, 
variant_title, 
variant_id,
line_item_id,	
customer_id,
orders_count,
customer_created_at,
last_order_id,
financial_status
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`agg_orders_union`
2018-04-18 08:40:25,240: Model SQL (adwords_impression_share):
SELECT 
cast(day as date) date, 
account, 
channel,
platform,
sum(impression_share_num) impressions,
sum(impression_share_den) available_impressions
FROM 
  `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_join`
group by date, account, platform, channel
2018-04-18 08:40:25,271: Model SQL (agg_transaction_order_number):
SELECT
client,
cast(created_at as date) date,
order_number,
customer_id,
sum(final_quantity) final_quantity,
sum(final_price) final_price,
max(total_order_shipping_price) shipping_price
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`agg_orders_union`
GROUP BY client, created_at, order_number, customer_id
2018-04-18 08:40:27,418: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10718be10>]}
2018-04-18 08:40:27,626: 08:40:27 | 36 of 91 OK created table model agency_data_pipeline.adwords_impression_share [CREATE TABLE in 3.39s]
2018-04-18 08:40:27,627: 08:40:27 | 37 of 91 START table model agency_data_pipeline.fb_ads_stats......... [RUN]
2018-04-18 08:40:27,627: Compiling model.agency_data_pipeline.fb_ads_stats
2018-04-18 08:40:27,635: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_stats"
2018-04-18 08:40:27,636: Acquiring new bigquery connection "fb_ads_stats".
2018-04-18 08:40:27,636: Re-using an available connection from the pool.
2018-04-18 08:40:28,326: Model SQL (fb_ads_stats):
with cost as (

    select 
        date, account, ad_id, campaign,
        cost, impressions, clicks, null as conversions
    from `growth-engines-pipeline`.`agency_data_pipeline`.`fb_ads_insights`
),

conversions as (

    select 
        date, account, ad_id, campaign,
        null as cost, null as impressions, null as clicks, conversions
    from `growth-engines-pipeline`.`agency_data_pipeline`.`fb_ads_insights_conversions`
),

urls as (

    select ad_id, url
    from `growth-engines-pipeline`.`agency_data_pipeline`.`fb_ads`
)


SELECT
    cast(date as date) date,
    'FB Ads' platform,
    'Paid' channel,
    account, 
    b.url url,
    campaign,
    lower(campaign) utm_campaign, 
    sum(cost) cost,
    sum(impressions) impressions,
    sum(clicks) clicks,
    sum(conversions) transactions
FROM
(
    SELECT *
    FROM 
      cost
    UNION ALL
    SELECT *
    FROM 
      conversions
) a
LEFT JOIN urls b
ON ( a.ad_id = b.ad_id )
group by date, platform, channel, account, url, campaign, utm_campaign
2018-04-18 08:40:29,639: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1070ab320>]}
2018-04-18 08:40:29,922: 08:40:29 | 33 of 91 OK created table model agency_data_pipeline.agg_transaction_order_number [CREATE TABLE in 5.63s]
2018-04-18 08:40:30,535: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107171278>]}
2018-04-18 08:40:30,544: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10718be10>]}
2018-04-18 08:40:30,789: 08:40:30 | 34 of 91 OK created table model agency_data_pipeline.adwords_stats... [CREATE TABLE in 6.51s]
2018-04-18 08:40:30,995: 08:40:30 | 37 of 91 OK created table model agency_data_pipeline.fb_ads_stats.... [CREATE TABLE in 2.92s]
2018-04-18 08:40:34,341: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10718b278>]}
2018-04-18 08:40:34,556: 08:40:34 | 35 of 91 OK created table model agency_data_pipeline.agg_transaction_line_item [CREATE TABLE in 10.32s]
2018-04-18 08:40:34,557: 08:40:34 | 38 of 91 START table model agency_data_pipeline.customers_by_transaction [RUN]
2018-04-18 08:40:34,557: Compiling model.agency_data_pipeline.customers_by_transaction
2018-04-18 08:40:34,566: Writing injected SQL for node "model.agency_data_pipeline.customers_by_transaction"
2018-04-18 08:40:34,569: Acquiring new bigquery connection "customers_by_transaction".
2018-04-18 08:40:34,569: Re-using an available connection from the pool.
2018-04-18 08:40:35,524: Model SQL (customers_by_transaction):
SELECT
client,
customer_id,
order_number,
order_date,
first_order_date,
case when first_order_number = order_number then 'New' else 'Existing' end as order_type,
final_price,
first_order_revenue,
lifetime_revenue
FROM

(

	SELECT
	client,
	customer_id,
	order_number,
	date order_date,
	first_value(date) over w1 first_order_date,
	first_value(order_number) over w1 first_order_number,
	first_value(final_price) over w1 first_order_revenue,
    final_price,
	sum(final_price) over w2 lifetime_revenue
	FROM
    `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_order_number`
	WINDOW w1 as (PARTITION BY client, customer_id ORDER BY date desc),
	w2 as (PARTITION BY client, customer_id)
)
2018-04-18 08:40:38,819: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107171278>]}
2018-04-18 08:40:39,116: 08:40:39 | 38 of 91 OK created table model agency_data_pipeline.customers_by_transaction [CREATE TABLE in 4.26s]
2018-04-18 08:40:39,117: 08:40:39 | 39 of 91 START table model agency_data_pipeline.agg_ga_transaction_order_number [RUN]
2018-04-18 08:40:39,118: Compiling model.agency_data_pipeline.agg_ga_transaction_order_number
2018-04-18 08:40:39,118: 08:40:39 | 40 of 91 START table model agency_data_pipeline.frequency_proc....... [RUN]
2018-04-18 08:40:39,124: Compiling model.agency_data_pipeline.frequency_proc
2018-04-18 08:40:39,129: Writing injected SQL for node "model.agency_data_pipeline.frequency_proc"
2018-04-18 08:40:39,131: Writing injected SQL for node "model.agency_data_pipeline.agg_ga_transaction_order_number"
2018-04-18 08:40:39,135: Acquiring new bigquery connection "frequency_proc".
2018-04-18 08:40:39,135: Acquiring new bigquery connection "agg_ga_transaction_order_number".
2018-04-18 08:40:39,136: Re-using an available connection from the pool.
2018-04-18 08:40:39,136: Re-using an available connection from the pool.
2018-04-18 08:40:40,028: Model SQL (frequency_proc):
WITH transactions AS (

  	SELECT 
	client,
	customer_id,
	order_number,
	date,
	unix_date(date) d
	FROM
	`growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_order_number`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)

SELECT 
client,
'Rolling 365' as period,
date_in_range date,
unix_date_in_range, 
customer_id,
count(distinct(order_number)) frequency
FROM daterange
JOIN transactions
ON transactions.d > ( daterange.unix_date_in_range - 365 )
AND transactions.d <= daterange.unix_date_in_range
group by client, unix_date_in_range, customer_id, date
2018-04-18 08:40:40,031: Model SQL (agg_ga_transaction_order_number):
with ga as (

    select 
        date, account, client, 
        channel as last_touch_channel, 
        platform as last_touch_platform, 
        url as last_touch_url, 
        campaign as last_touch_utm_campaign, 
        '' as first_touch_channel, 
        '' as first_touch_platform, 
        '' as first_touch_utm_campaign, 
        transactionid,
        last_touch_transactions, last_touch_revenue,
        last_touch_shipping, last_touch_tax,
        null as first_touch_transactions, null as first_touch_revenue
    from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_transactions`

),

ga_mcf as (

    select 
        date, account, client, 
        '' as last_touch_channel,
        '' as last_touch_platform,
        '' as last_touch_url,
        '' as last_touch_utm_campaign, 
        channel as first_touch_channel, 
        platform as first_touch_platform, 
        campaign as first_touch_utm_campaign, 
        transactionid, 
        null as last_touch_transactions, null as last_touch_revenue,
        null as last_touch_shipping, null as last_touch_tax,
        first_touch_transactions, first_touch_revenue
    from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_mcf_stats`

)


SELECT
    date, 
    client,
    transactionid,
    max(last_touch_channel) last_touch_channel, 
    max(last_touch_platform) last_touch_platform, 
    max(last_touch_url) last_touch_url, 
    max(last_touch_utm_campaign) last_touch_utm_campaign, 
    max(first_touch_channel) first_touch_channel, 
    max(first_touch_platform) first_touch_platform, 
    max(first_touch_utm_campaign) first_touch_utm_campaign,
    sum(last_touch_transactions) last_touch_transactions,
    sum(last_touch_revenue) last_touch_revenue,
    sum(last_touch_shipping) last_touch_shipping_revenue,
    sum(last_touch_tax) last_touch_tax_revenue,
    sum(first_touch_transactions) first_touch_transactions,
    sum(first_touch_revenue) - ifnull(sum(last_touch_shipping),0) - ifnull(sum(last_touch_tax),0) first_touch_revenue
FROM
(
    SELECT *
    FROM 
      ga
    UNION ALL
    SELECT *
    FROM 
      ga_mcf
) 
GROUP BY
    date, client, transactionid
2018-04-18 08:40:44,429: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107087e10>]}
2018-04-18 08:40:44,721: 08:40:44 | 39 of 91 OK created table model agency_data_pipeline.agg_ga_transaction_order_number [CREATE TABLE in 5.31s]
2018-04-18 08:40:54,239: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10452e390>]}
2018-04-18 08:40:54,524: 08:40:54 | 40 of 91 OK created table model agency_data_pipeline.frequency_proc.. [CREATE TABLE in 15.12s]
2018-04-18 08:40:54,524: 08:40:54 | 41 of 91 START table model agency_data_pipeline.frequency_stats...... [RUN]
2018-04-18 08:40:54,525: 08:40:54 | 42 of 91 START table model agency_data_pipeline.agg_transaction_line_item_type [RUN]
2018-04-18 08:40:54,525: Compiling model.agency_data_pipeline.frequency_stats
2018-04-18 08:40:54,525: 08:40:54 | 43 of 91 START table model agency_data_pipeline.agg_ga_campaign...... [RUN]
2018-04-18 08:40:54,526: Compiling model.agency_data_pipeline.agg_transaction_line_item_type
2018-04-18 08:40:54,533: Compiling model.agency_data_pipeline.agg_ga_campaign
2018-04-18 08:40:54,534: Writing injected SQL for node "model.agency_data_pipeline.frequency_stats"
2018-04-18 08:40:54,540: Writing injected SQL for node "model.agency_data_pipeline.agg_transaction_line_item_type"
2018-04-18 08:40:54,547: Writing injected SQL for node "model.agency_data_pipeline.agg_ga_campaign"
2018-04-18 08:40:54,550: Acquiring new bigquery connection "agg_ga_campaign".
2018-04-18 08:40:54,551: Re-using an available connection from the pool.
2018-04-18 08:40:54,552: Acquiring new bigquery connection "agg_transaction_line_item_type".
2018-04-18 08:40:54,552: Re-using an available connection from the pool.
2018-04-18 08:40:54,556: Acquiring new bigquery connection "frequency_stats".
2018-04-18 08:40:54,556: Re-using an available connection from the pool.
2018-04-18 08:40:55,326: Model SQL (agg_transaction_line_item_type):
SELECT
client,
product_id,
product_type,
customer_id,
sku,
order_number,
created_at,
final_quantity,
final_price
FROM

( 
	SELECT 
	a.client, 
	a.product_id,
	product_type,
	customer_id,
	a.sku, 
	order_number,
	created_at,
	final_quantity,
	final_price
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_line_item` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`agg_products` b
	ON (
		a.product_id = b.product_id
	  and a.client = b.client
		)

)
2018-04-18 08:40:55,327: Model SQL (frequency_stats):
SELECT
client,
period,
date,
unix_date_in_range,
case when frequency = 1 then '1' 
	when frequency = 2 then '2'
	when frequency > 2 then '2+'
	else null end as frequency_segment,
sum(customers) customers 
FROM (

	SELECT 
	client,
	period,
	date,
	unix_date_in_range, 
	frequency,
	count(distinct(customer_id)) customers
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`frequency_proc`
	group by client, period, date, unix_date_in_range, frequency
)
group by client, period, date, unix_date_in_range, frequency_segment
2018-04-18 08:40:55,771: Model SQL (agg_ga_campaign):
with ga_transactions as (

	select 
		date, account, client, channel, platform, url, 
		campaign,
		null as sessions, null as goal_completions, last_touch_transactions, last_touch_revenue,
		last_touch_shipping, last_touch_tax,
		null as first_touch_transactions, null as first_touch_revenue
	from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_transactions`

),

ga_traffic as (

    select 
        date, account, client, channel, platform, url, 
        campaign,
        sessions, goal_completions, null as last_touch_transactions, null as last_touch_revenue,
        null as last_touch_shipping, null as last_touch_tax,
        null as first_touch_transactions, null as first_touch_revenue
    from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_traffic`

),

ga_mcf as (

	select 
		date, account, client, channel, platform, '' as url,
		campaign, 
		null as sessions, null as goal_completions, null as last_touch_transactions, null as last_touch_revenue,
		null as last_touch_shipping, null as last_touch_tax,
		first_touch_transactions, first_touch_revenue
	from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_mcf_stats`

)


SELECT
    date, 
    client,
    platform,
    channel, 
    url,
    campaign utm_campaign,
	sum(sessions) sessions,
	sum(goal_completions) goal_completions,
	sum(last_touch_transactions) last_touch_transactions,
	sum(last_touch_revenue) last_touch_revenue,
    sum(last_touch_shipping) last_touch_shipping_revenue,
    sum(last_touch_tax) last_touch_tax_revenue,
    sum(first_touch_transactions) first_touch_transactions,
    sum(first_touch_revenue) - sum(ifnull(last_touch_shipping,0)) - sum(ifnull(last_touch_tax,0)) first_touch_revenue

FROM
(
    SELECT *
    FROM 
      ga_transactions
    UNION ALL
    SELECT *
    FROM 
      ga_traffic
    UNION ALL
    SELECT *
    FROM 
      ga_mcf
) 
GROUP BY
    date, client, platform, channel, url, utm_campaign
2018-04-18 08:41:00,759: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104523dd8>]}
2018-04-18 08:41:00,769: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107171278>]}
2018-04-18 08:41:00,977: 08:41:00 | 42 of 91 OK created table model agency_data_pipeline.agg_transaction_line_item_type [CREATE TABLE in 6.23s]
2018-04-18 08:41:01,337: 08:41:01 | 41 of 91 OK created table model agency_data_pipeline.frequency_stats. [CREATE TABLE in 6.24s]
2018-04-18 08:41:04,612: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1045600b8>]}
2018-04-18 08:41:04,821: 08:41:04 | 43 of 91 OK created table model agency_data_pipeline.agg_ga_campaign. [CREATE TABLE in 10.08s]
2018-04-18 08:41:04,822: 08:41:04 | 44 of 91 START table model agency_data_pipeline.customers_first_purchase_product_type_proc [RUN]
2018-04-18 08:41:04,823: 08:41:04 | 45 of 91 START table model agency_data_pipeline.agg_transaction_product_type [RUN]
2018-04-18 08:41:04,823: Compiling model.agency_data_pipeline.customers_first_purchase_product_type_proc
2018-04-18 08:41:04,823: Compiling model.agency_data_pipeline.agg_transaction_product_type
2018-04-18 08:41:04,832: Writing injected SQL for node "model.agency_data_pipeline.customers_first_purchase_product_type_proc"
2018-04-18 08:41:04,838: Writing injected SQL for node "model.agency_data_pipeline.agg_transaction_product_type"
2018-04-18 08:41:04,841: Acquiring new bigquery connection "agg_transaction_product_type".
2018-04-18 08:41:04,842: Re-using an available connection from the pool.
2018-04-18 08:41:04,842: Acquiring new bigquery connection "customers_first_purchase_product_type_proc".
2018-04-18 08:41:04,843: Re-using an available connection from the pool.
2018-04-18 08:41:05,551: Model SQL (customers_first_purchase_product_type_proc):
SELECT 
client, 
customer_id, 
product_type,
min(cast(created_at as date)) first_order_date,
unix_date( min(cast(created_at as date))) first_order_unix_date
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_line_item_type`
GROUP BY client, customer_id, product_type
2018-04-18 08:41:05,659: Model SQL (agg_transaction_product_type):
SELECT
client,
product_type,
customer_id,
order_number,
created_at,
first_value(product_type) over (PARTITION BY client, customer_id, order_number, created_at ORDER BY final_price desc) as top_order_product_type,
final_quantity,
final_price,
sum(final_quantity) over (PARTITION BY client, customer_id, order_number) as total_order_quantity,
sum(final_price) over (PARTITION BY client, customer_id, order_number) as total_order_value
FROM
	(
		SELECT
		client,
		product_type,
		customer_id,
		order_number,
		created_at,
		sum(final_quantity) final_quantity,
		sum(final_price) final_price
		FROM
		`growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_line_item_type`
		GROUP BY
		client,
		product_type,
		customer_id,
		order_number,
		created_at
	)
2018-04-18 08:41:08,894: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1094fe9b0>]}
2018-04-18 08:41:09,219: 08:41:09 | 44 of 91 OK created table model agency_data_pipeline.customers_first_purchase_product_type_proc [CREATE TABLE in 4.07s]
2018-04-18 08:41:10,002: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1045605c0>]}
2018-04-18 08:41:10,296: 08:41:10 | 45 of 91 OK created table model agency_data_pipeline.agg_transaction_product_type [CREATE TABLE in 5.18s]
2018-04-18 08:41:10,297: 08:41:10 | 46 of 91 START table model agency_data_pipeline.order_paths_proc..... [RUN]
2018-04-18 08:41:10,297: 08:41:10 | 47 of 91 START table model agency_data_pipeline.products_proc........ [RUN]
2018-04-18 08:41:10,297: Compiling model.agency_data_pipeline.order_paths_proc
2018-04-18 08:41:10,298: 08:41:10 | 48 of 91 START table model agency_data_pipeline.customers_products_proc [RUN]
2018-04-18 08:41:10,298: Compiling model.agency_data_pipeline.products_proc
2018-04-18 08:41:10,304: Compiling model.agency_data_pipeline.customers_products_proc
2018-04-18 08:41:10,308: Writing injected SQL for node "model.agency_data_pipeline.order_paths_proc"
2018-04-18 08:41:10,324: Writing injected SQL for node "model.agency_data_pipeline.products_proc"
2018-04-18 08:41:10,326: Writing injected SQL for node "model.agency_data_pipeline.customers_products_proc"
2018-04-18 08:41:10,328: Acquiring new bigquery connection "order_paths_proc".
2018-04-18 08:41:10,328: Re-using an available connection from the pool.
2018-04-18 08:41:10,329: Acquiring new bigquery connection "products_proc".
2018-04-18 08:41:10,329: Re-using an available connection from the pool.
2018-04-18 08:41:10,333: Acquiring new bigquery connection "customers_products_proc".
2018-04-18 08:41:10,334: Re-using an available connection from the pool.
2018-04-18 08:41:11,372: Model SQL (customers_products_proc):
WITH customers AS (
  SELECT 
  client, 
  product_id,
  product_type,
  customer_id,
  sku, 
  order_number,
  cast(created_at as date) order_date,
  unix_date(cast(created_at as date)) unix_order_date, 
  final_quantity quantity,
  final_price revenue
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_line_item_type`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)

SELECT 
client,
period,
customer_id,
product_type,
date,
window_end_unix_date,
window_end_unix_date - 365 as window_start_unix_date,
window_end_unix_date - unix_date(recent_order) recency_days,
frequency,
quantity,
revenue,
case when frequency > 0 then revenue/frequency else 0 end as aov
FROM 
(  

  SELECT 
  client,
  'Rolling 365' as period,
  customer_id,
  product_type,
  date_in_range date,
  unix_date_in_range,
  unix_date_in_range window_end_unix_date, 
  max(order_date) recent_order,
  sum(quantity) as quantity,
  sum(revenue) as revenue,
  count(distinct(order_number)) as frequency
  FROM daterange
  JOIN customers
  ON customers.unix_order_date > ( daterange.unix_date_in_range - 365 )
  AND customers.unix_order_date <= daterange.unix_date_in_range
  GROUP BY client, customer_id, date, unix_date_in_range, product_type

  UNION ALL

  SELECT 
  client,
  'Rolling 365 (t-1mo)' as period,
  customer_id,
  product_type,
  date_in_range date,
  unix_date_in_range, 
  unix_date_in_range - 30 window_end_unix_date, 
  max(order_date) recent_order,
  sum(quantity) as quantity,
  sum(revenue) as revenue,
  count(distinct(order_number)) as frequency
  FROM daterange
  JOIN customers
  ON customers.unix_order_date > ( daterange.unix_date_in_range - 395 )
  AND customers.unix_order_date <= ( daterange.unix_date_in_range - 30 )
  GROUP BY client, customer_id, date, unix_date_in_range, product_type

  UNION ALL

  SELECT 
  client,
  'Rolling 365 (t-1yr)' as period,
  customer_id,
  product_type,
  date_in_range date,
  unix_date_in_range, 
  unix_date_in_range - 365 window_end_unix_date, 
  max(order_date) recent_order,
  sum(quantity) as quantity,
  sum(revenue) as revenue,
  count(distinct(order_number)) as frequency
  FROM daterange
  JOIN customers
  ON customers.unix_order_date > ( daterange.unix_date_in_range - 730 )
  AND customers.unix_order_date <= ( daterange.unix_date_in_range - 365 )
  GROUP BY client, customer_id, date, unix_date_in_range, product_type

)
2018-04-18 08:41:11,431: Model SQL (products_proc):
WITH transactions AS (
  SELECT 
  client, 
  product_id,
  product_type,
  customer_id,
  sku, 
  order_number,
  unix_date(cast(created_at as date)) d, 
  final_quantity,
  final_price,
  first_value(unix_date(cast(created_at as date))) over (partition by client, product_id, sku order by created_at desc) first_purchase_unix_date
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_line_item_type`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)

SELECT 
client,
'Last 30' as period,
sku,
product_type,
date_in_range date,
unix_date_in_range, 
case when 
  ( first_purchase_unix_date > ( daterange.unix_date_in_range - 365 ) and first_purchase_unix_date <= daterange.unix_date_in_range )
  then 'New' else 'Existing' end as newness,  
count(distinct(customer_id)) unique_customers,
count(distinct(order_number)) orders,
sum(final_quantity) quantity,
sum(final_price) revenue,
count(distinct(d)) days_sold
FROM daterange
JOIN transactions
ON transactions.d > ( daterange.unix_date_in_range - 30 )
AND transactions.d <= daterange.unix_date_in_range
group by date_in_range, unix_date_in_range, client, sku, product_type, newness

UNION ALL

SELECT 
client,
'Last 90' as period,
sku, 
product_type,
date_in_range date,
unix_date_in_range, 
case when 
  ( first_purchase_unix_date > ( daterange.unix_date_in_range - 365 ) and first_purchase_unix_date <= daterange.unix_date_in_range )
  then 'New' else 'Existing' end as newness,  
count(distinct(customer_id)) unique_customers,
count(distinct(order_number)) orders,
sum(final_quantity) quantity,
sum(final_price) revenue,
count(distinct(d)) days_sold
FROM daterange
JOIN transactions
ON transactions.d > ( daterange.unix_date_in_range - 90 )
AND transactions.d <= daterange.unix_date_in_range
group by date_in_range, unix_date_in_range, client, sku, product_type, newness

UNION ALL

SELECT 
client,
'YoY 30' as date_range,
sku, 
product_type,
date_in_range date,
unix_date_in_range,
case when 
  ( first_purchase_unix_date > ( daterange.unix_date_in_range - 730 ) and first_purchase_unix_date <= ( daterange.unix_date_in_range - 365 ))
  then 'New' else 'Existing' end as newness,   
count(distinct(customer_id)) unique_customers,
count(distinct(order_number)) orders,
sum(final_quantity) quantity,
sum(final_price) revenue,
count(distinct(d)) days_sold
FROM daterange
JOIN transactions
ON transactions.d > ( daterange.unix_date_in_range - 395 )
AND transactions.d <= ( daterange.unix_date_in_range - 365 )
group by date_in_range, unix_date_in_range, client, sku, product_type, newness
2018-04-18 08:41:11,437: Model SQL (order_paths_proc):
SELECT
client, 
customer_id, 
first_value(product_type) OVER w1 as first_product_type,
nth_value(product_type, 2) OVER w1 as second_product_type,
cast(first_value(created_at) OVER w1 as date) as first_purchase_date,
cast(nth_value(created_at, 2) OVER w1 as date) as second_purchase_date,
cast(nth_value(created_at, 3) OVER w1 as date) as third_purchase_date,
cast(nth_value(created_at, 4) OVER w1 as date) as fourth_purchase_date,
cast(nth_value(created_at, 5) OVER w1 as date) as fifth_purchase_date,
first_value(order_number) OVER w1 as first_order_number,
nth_value(order_number, 2) OVER w1 as second_order_number,
nth_value(order_number, 3) OVER w1 as third_order_number,
nth_value(order_number, 4) OVER w1 as fourth_order_number,
nth_value(order_number, 5) OVER w1 as fifth_order_number,
first_value(total_order_value) OVER w1 as first_order_value,
nth_value(total_order_value, 2) OVER w1 as second_order_value
FROM (
	  
	  SELECT 
	  client, 
	  product_type,
	  customer_id,
	  order_number,
	  created_at, 
	  total_order_value
	  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_product_type`
	  WHERE product_type = top_order_product_type

)
WINDOW w1 as (PARTITION BY client, customer_id ORDER BY created_at asc)
2018-04-18 08:41:14,764: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109524358>]}
2018-04-18 08:41:15,036: 08:41:15 | 46 of 91 OK created table model agency_data_pipeline.order_paths_proc [CREATE TABLE in 4.47s]
2018-04-18 08:41:20,229: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1070ecb70>]}
2018-04-18 08:41:20,460: 08:41:20 | 47 of 91 OK created table model agency_data_pipeline.products_proc... [CREATE TABLE in 9.93s]
2018-04-18 08:41:45,352: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1045386d8>]}
2018-04-18 08:41:45,991: 08:41:45 | 48 of 91 OK created table model agency_data_pipeline.customers_products_proc [CREATE TABLE in 35.05s]
2018-04-18 08:41:45,992: 08:41:45 | 49 of 91 START table model agency_data_pipeline.order_paths_agg...... [RUN]
2018-04-18 08:41:45,992: Compiling model.agency_data_pipeline.order_paths_agg
2018-04-18 08:41:46,001: Writing injected SQL for node "model.agency_data_pipeline.order_paths_agg"
2018-04-18 08:41:45,992: 08:41:45 | 50 of 91 START table model agency_data_pipeline.segment_proc_sku..... [RUN]
2018-04-18 08:41:46,002: Compiling model.agency_data_pipeline.segment_proc_sku
2018-04-18 08:41:46,012: Writing injected SQL for node "model.agency_data_pipeline.segment_proc_sku"
2018-04-18 08:41:46,015: Acquiring new bigquery connection "order_paths_agg".
2018-04-18 08:41:46,015: Re-using an available connection from the pool.
2018-04-18 08:41:46,017: Acquiring new bigquery connection "segment_proc_sku".
2018-04-18 08:41:46,018: Re-using an available connection from the pool.
2018-04-18 08:41:46,774: Model SQL (segment_proc_sku):
SELECT
client,
period,
sku, 
product_type,
date,
unique_customers,
orders,
quantity,
revenue,
case 
	when avg_daily_revenue >= avg_daily_revenue_90pct and avg_daily_quantity >= avg_daily_quantity_80pct then 'Best Seller'
	when avg_daily_revenue >= avg_daily_revenue_70pct and avg_daily_quantity >= avg_daily_quantity_40pct then 'Good'
	when avg_daily_revenue < avg_daily_revenue_70pct and avg_daily_revenue >= avg_daily_revenue_40pct and avg_daily_quantity < avg_daily_quantity_70pct then 'Average'
	when avg_daily_revenue < avg_daily_revenue_30pct and avg_daily_quantity < avg_daily_quantity_30pct then 'Poor'
	else 'Unbucketed' end as segment,
newness,	
avg_daily_revenue_90pct,
avg_daily_revenue_70pct,
avg_daily_revenue_30pct,
avg_daily_quantity_80pct,
avg_daily_quantity_70pct,
avg_daily_quantity_40pct,
avg_daily_quantity_30pct

FROM (

	SELECT
	client,
	period,
	sku, 
	product_type,
	newness,
	date,
	unique_customers,
	orders,
	quantity,
	revenue,
	days_sold,
	avg_daily_revenue,
	avg_daily_quantity,
	PERCENTILE_CONT(avg_daily_revenue, 0.90) OVER w1 AS avg_daily_revenue_90pct,
	PERCENTILE_CONT(avg_daily_revenue, 0.70) OVER w1 AS avg_daily_revenue_70pct,
	PERCENTILE_CONT(avg_daily_revenue, 0.3) OVER w1 AS avg_daily_revenue_30pct,
	PERCENTILE_CONT(avg_daily_quantity, 0.90) OVER w1 AS avg_daily_quantity_80pct,
	PERCENTILE_CONT(avg_daily_quantity, 0.90) OVER w1 AS avg_daily_quantity_70pct,
	PERCENTILE_CONT(avg_daily_quantity, 0.70) OVER w1 AS avg_daily_quantity_40pct,
	PERCENTILE_CONT(avg_daily_quantity, 0.3) OVER w1 AS avg_daily_quantity_30pct

	FROM
	(
		SELECT 
		client,
		period,
		sku, 
		product_type,
		newness,
		date,
		unique_customers,
		orders,
		quantity,
		revenue,
		days_sold,
		case when days_sold > 0 then revenue/days_sold else null end as avg_daily_revenue,
		case when days_sold > 0 then quantity/days_sold else null end as avg_daily_quantity
		FROM `growth-engines-pipeline`.`agency_data_pipeline`.`products_proc`
	)
	WINDOW w1 as (PARTITION BY client, period, date)
)
2018-04-18 08:41:46,774: Bad request while running:
SELECT
client,
period,
sku, 
product_type,
date,
unique_customers,
orders,
quantity,
revenue,
case 
	when avg_daily_revenue >= avg_daily_revenue_90pct and avg_daily_quantity >= avg_daily_quantity_80pct then 'Best Seller'
	when avg_daily_revenue >= avg_daily_revenue_70pct and avg_daily_quantity >= avg_daily_quantity_40pct then 'Good'
	when avg_daily_revenue < avg_daily_revenue_70pct and avg_daily_revenue >= avg_daily_revenue_40pct and avg_daily_quantity < avg_daily_quantity_70pct then 'Average'
	when avg_daily_revenue < avg_daily_revenue_30pct and avg_daily_quantity < avg_daily_quantity_30pct then 'Poor'
	else 'Unbucketed' end as segment,
newness,	
avg_daily_revenue_90pct,
avg_daily_revenue_70pct,
avg_daily_revenue_30pct,
avg_daily_quantity_80pct,
avg_daily_quantity_70pct,
avg_daily_quantity_40pct,
avg_daily_quantity_30pct

FROM (

	SELECT
	client,
	period,
	sku, 
	product_type,
	newness,
	date,
	unique_customers,
	orders,
	quantity,
	revenue,
	days_sold,
	avg_daily_revenue,
	avg_daily_quantity,
	PERCENTILE_CONT(avg_daily_revenue, 0.90) OVER w1 AS avg_daily_revenue_90pct,
	PERCENTILE_CONT(avg_daily_revenue, 0.70) OVER w1 AS avg_daily_revenue_70pct,
	PERCENTILE_CONT(avg_daily_revenue, 0.3) OVER w1 AS avg_daily_revenue_30pct,
	PERCENTILE_CONT(avg_daily_quantity, 0.90) OVER w1 AS avg_daily_quantity_80pct,
	PERCENTILE_CONT(avg_daily_quantity, 0.90) OVER w1 AS avg_daily_quantity_70pct,
	PERCENTILE_CONT(avg_daily_quantity, 0.70) OVER w1 AS avg_daily_quantity_40pct,
	PERCENTILE_CONT(avg_daily_quantity, 0.3) OVER w1 AS avg_daily_quantity_30pct

	FROM
	(
		SELECT 
		client,
		period,
		sku, 
		product_type,
		newness,
		date,
		unique_customers,
		orders,
		quantity,
		revenue,
		days_sold,
		case when days_sold > 0 then revenue/days_sold else null end as avg_daily_revenue,
		case when days_sold > 0 then quantity/days_sold else null end as avg_daily_quantity
		FROM `growth-engines-pipeline`.`agency_data_pipeline`.`products_proc`
	)
	WINDOW w1 as (PARTITION BY client, period, date)
)
2018-04-18 08:41:46,774: 400 Unrecognized name: avg_daily_revenue_40pct; Did you mean avg_daily_revenue_30pct? at [14:83]
2018-04-18 08:41:46,774: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104585550>]}
2018-04-18 08:41:46,822: Model SQL (order_paths_agg):
SELECT
client, 
first_product_type,
second_product_type,
first_purchase_date,
count(distinct(customer_id)) customer_count, 
count(distinct(second_order_number)) second_orders, 
count(distinct(third_order_number)) third_orders, 
count(distinct(fourth_order_number)) fourth_orders, 
count(distinct(fifth_order_number)) fifth_orders, 
sum(date_diff(second_purchase_date, first_purchase_date, DAY)) second_order_latency_days,
sum(date_diff(third_purchase_date, second_purchase_date, DAY)) third_order_latency_days,
sum(date_diff(fourth_purchase_date, third_purchase_date, DAY)) fourth_order_latency_days,
sum(date_diff(fifth_purchase_date, fourth_purchase_date, DAY)) fifth_order_latency_days,
sum(first_order_value) first_order_revenue,
sum(second_order_value) second_order_revenue
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`order_paths_proc`
where second_product_type is not null
GROUP BY client, first_product_type, second_product_type, first_purchase_date
2018-04-18 08:41:47,099: 08:41:47 | 50 of 91 ERROR creating table model agency_data_pipeline.segment_proc_sku [ERROR in 0.77s]
2018-04-18 08:41:49,005: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1095307f0>]}
2018-04-18 08:41:49,265: 08:41:49 | 49 of 91 OK created table model agency_data_pipeline.order_paths_agg. [CREATE TABLE in 3.01s]
2018-04-18 08:41:49,266: 08:41:49 | 51 of 91 START table model agency_data_pipeline.agg_ga_transaction... [RUN]
2018-04-18 08:41:49,267: Compiling model.agency_data_pipeline.agg_ga_transaction
2018-04-18 08:41:49,266: 08:41:49 | 52 of 91 SKIP relation agency_data_pipeline.segment_stats_sku........ [SKIP]
2018-04-18 08:41:49,267: 08:41:49 | 53 of 91 START table model agency_data_pipeline.segment_proc_customers_products [RUN]
2018-04-18 08:41:49,278: Writing injected SQL for node "model.agency_data_pipeline.agg_ga_transaction"
2018-04-18 08:41:49,278: Compiling model.agency_data_pipeline.segment_proc_customers_products
2018-04-18 08:41:49,267: 08:41:49 | 54 of 91 START table model agency_data_pipeline.agg_transaction...... [RUN]
2018-04-18 08:41:49,284: Writing injected SQL for node "model.agency_data_pipeline.segment_proc_customers_products"
2018-04-18 08:41:49,284: Compiling model.agency_data_pipeline.agg_transaction
2018-04-18 08:41:49,290: Writing injected SQL for node "model.agency_data_pipeline.agg_transaction"
2018-04-18 08:41:49,291: Acquiring new bigquery connection "agg_ga_transaction".
2018-04-18 08:41:49,291: Re-using an available connection from the pool.
2018-04-18 08:41:49,292: Acquiring new bigquery connection "segment_proc_customers_products".
2018-04-18 08:41:49,292: Acquiring new bigquery connection "agg_transaction".
2018-04-18 08:41:49,293: Re-using an available connection from the pool.
2018-04-18 08:41:49,294: Re-using an available connection from the pool.
2018-04-18 08:41:50,033: Model SQL (segment_proc_customers_products):
SELECT
client,
period,
date,
customer_id,
first_order_date,
first_order_unix_date,
product_type,
recency_days,
frequency,
revenue,
quantity,
aov,
case when recency_days <= 30 and first_order_unix_date >= window_start_unix_date then 'New'
	when frequency = 1 and recency_days <= 90 and aov >= aov_40pct then 'Promising'
	when frequency = 1 then 'One-time Purchaser'
	when frequency >= frequency_90pct and recency_days <= 90 and aov > aov_40pct then 'Whale'
	when recency_days <= 240 and frequency > frequency_50pct then 'Loyal'
	when recency_days <= 90 and frequency > frequency_50pct then 'Potential Loyalists' 
	when recency_days > 240 and frequency > frequency_50pct then 'Defecting Good Customer'	
	when recency_days > recency_50pct and frequency > frequency_50pct then 'Frequent, not Recent'
	when recency_days < recency_50pct and frequency < frequency_50pct then 'Recent, not Frequent'
	else 'Unbucketed' end as segment,
aov_50pct,
frequency_90pct,
frequency_75pct,
frequency_50pct,
recency_90pct,
recency_75pct,
recency_50pct
FROM
(
	SELECT 
	a.client client,
	period,
	date,
	a.customer_id customer_id,
	a.product_type product_type,
	b.first_order_date first_order_date,
	b.first_order_unix_date first_order_unix_date,
	window_start_unix_date,
	window_end_unix_date,	
	recency_days,
	frequency,
	revenue,
	quantity,
	aov,
	PERCENTILE_CONT(aov, 0.50) OVER w1 AS aov_50pct,
	PERCENTILE_CONT(frequency, 0.90) OVER w1 AS frequency_90pct,
	PERCENTILE_CONT(frequency, 0.75) OVER w1 AS frequency_75pct,
	PERCENTILE_CONT(frequency, 0.90) OVER w1 AS frequency_50pct,
	PERCENTILE_CONT(recency_days, 0.10) OVER w1 AS recency_90pct,
	PERCENTILE_CONT(recency_days, 0.25) OVER w1 AS recency_75pct,
	PERCENTILE_CONT(recency_days, 0.5) OVER w1 AS recency_50pct
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`customers_products_proc` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`customers_first_purchase_product_type_proc` b
	ON (
		a.client = b.client and
		a.customer_id = b.customer_id and
		a.product_type = b.product_type
		)
	WINDOW w1 as (PARTITION BY a.client, period, date, a.product_type)
)
2018-04-18 08:41:50,033: Bad request while running:
SELECT
client,
period,
date,
customer_id,
first_order_date,
first_order_unix_date,
product_type,
recency_days,
frequency,
revenue,
quantity,
aov,
case when recency_days <= 30 and first_order_unix_date >= window_start_unix_date then 'New'
	when frequency = 1 and recency_days <= 90 and aov >= aov_40pct then 'Promising'
	when frequency = 1 then 'One-time Purchaser'
	when frequency >= frequency_90pct and recency_days <= 90 and aov > aov_40pct then 'Whale'
	when recency_days <= 240 and frequency > frequency_50pct then 'Loyal'
	when recency_days <= 90 and frequency > frequency_50pct then 'Potential Loyalists' 
	when recency_days > 240 and frequency > frequency_50pct then 'Defecting Good Customer'	
	when recency_days > recency_50pct and frequency > frequency_50pct then 'Frequent, not Recent'
	when recency_days < recency_50pct and frequency < frequency_50pct then 'Recent, not Frequent'
	else 'Unbucketed' end as segment,
aov_50pct,
frequency_90pct,
frequency_75pct,
frequency_50pct,
recency_90pct,
recency_75pct,
recency_50pct
FROM
(
	SELECT 
	a.client client,
	period,
	date,
	a.customer_id customer_id,
	a.product_type product_type,
	b.first_order_date first_order_date,
	b.first_order_unix_date first_order_unix_date,
	window_start_unix_date,
	window_end_unix_date,	
	recency_days,
	frequency,
	revenue,
	quantity,
	aov,
	PERCENTILE_CONT(aov, 0.50) OVER w1 AS aov_50pct,
	PERCENTILE_CONT(frequency, 0.90) OVER w1 AS frequency_90pct,
	PERCENTILE_CONT(frequency, 0.75) OVER w1 AS frequency_75pct,
	PERCENTILE_CONT(frequency, 0.90) OVER w1 AS frequency_50pct,
	PERCENTILE_CONT(recency_days, 0.10) OVER w1 AS recency_90pct,
	PERCENTILE_CONT(recency_days, 0.25) OVER w1 AS recency_75pct,
	PERCENTILE_CONT(recency_days, 0.5) OVER w1 AS recency_50pct
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`customers_products_proc` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`customers_first_purchase_product_type_proc` b
	ON (
		a.client = b.client and
		a.customer_id = b.customer_id and
		a.product_type = b.product_type
		)
	WINDOW w1 as (PARTITION BY a.client, period, date, a.product_type)
)
2018-04-18 08:41:50,033: 400 Unrecognized name: aov_40pct; Did you mean aov_50pct? at [15:62]
2018-04-18 08:41:50,034: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109515400>]}
2018-04-18 08:41:50,079: Model SQL (agg_transaction):
SELECT
client,
date,
customer_id,
order_number,
last_touch_channel,
last_touch_platform,
last_touch_url,
first_touch_channel, 
first_touch_platform, 
first_touch_utm_campaign,
ifnull( sum(last_touch_transactions), 0) last_touch_transactions, 
ifnull( sum(last_touch_revenue), 0) last_touch_revenue, 
ifnull( sum(first_touch_transactions), 0) first_touch_transactions, 
ifnull( sum(first_touch_revenue), 0) first_touch_revenue,
ifnull( sum(final_quantity), 0) quantity,
ifnull( sum(final_price), 0) revenue,
ifnull( sum(shipping_price), 0) shipping_revenue,
ROW_NUMBER() OVER (PARTITION BY client, customer_id, order_number ORDER BY date asc) AS order_sequence
FROM
(
	SELECT
	a.client,
	a.date date,
	b.date ga_date,
	a.customer_id,
	a.order_number,
	transactionid,
	b.last_touch_channel,
	b.last_touch_platform,
	b.last_touch_url,
	b.first_touch_channel, 
	b.first_touch_platform, 
	b.first_touch_utm_campaign, 
	last_touch_transactions, 
	last_touch_revenue, 
	first_touch_transactions, 
	first_touch_revenue,
	final_quantity,
	final_price,
	shipping_price
	FROM
	`growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_order_number` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`agg_ga_transaction_order_number` b
	ON (
		a.client = b.client and
		a.order_number = b.transactionid
	)

)
GROUP BY
client, 
date, 
customer_id,
order_number, 
last_touch_channel,
last_touch_platform,
last_touch_url,
first_touch_channel, 
first_touch_platform, 
first_touch_utm_campaign
2018-04-18 08:41:50,159: Model SQL (agg_ga_transaction):
#done - lookup customer id from transaction id from orders
#done - tag an order as 'new' or 'existing' based on transaction id
#sum lifetime value of that customer id
#first order value for customer
#read from agg_ga_transaction into agg_ga_campaign instead of directly from ga_transactions and ga_mcf_stats


with ga as (

    select 
        date, 
        client, 
        'Last-touch' as attribution,
        channel, 
        platform, 
        url, 
        campaign, 
        transactionid,
        last_touch_transactions transactions, 
        last_touch_revenue + ifnull(last_touch_shipping, 0) + ifnull(last_touch_tax, 0) as revenue
    from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_transactions`

),

ga_mcf as (

    select 
        date, 
        client, 
        'First-touch' as attribution,
        channel, 
        platform, 
        '' as url,
        campaign, 
        transactionid, 
        first_touch_transactions as transactions,
        first_touch_revenue as revenue
    from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_mcf_stats`

)


SELECT
    date, 
    a.client client,
    attribution,
    transactionid,
    b.customer_id customer_id,
    b.order_type order_type,
    b.first_order_revenue first_order_revenue,
    b.lifetime_revenue lifetime_revenue,
    channel,
    platform,
    url,
    campaign,
    transactions,
    revenue
FROM (
    SELECT * FROM ga
    UNION ALL
    SELECT * FROM ga_mcf
) a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`customers_by_transaction` b
ON (
    a.client = b.client AND
    a.transactionid = b.order_number
)
2018-04-18 08:41:50,242: 08:41:50 | 53 of 91 ERROR creating table model agency_data_pipeline.segment_proc_customers_products [ERROR in 0.76s]
2018-04-18 08:41:55,566: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10718b710>]}
2018-04-18 08:41:55,783: 08:41:55 | 54 of 91 OK created table model agency_data_pipeline.agg_transaction. [CREATE TABLE in 6.28s]
2018-04-18 08:41:56,765: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1045386d8>]}
2018-04-18 08:41:57,071: 08:41:57 | 51 of 91 OK created table model agency_data_pipeline.agg_ga_transaction [CREATE TABLE in 7.50s]
2018-04-18 08:41:57,071: 08:41:57 | 55 of 91 START table model agency_data_pipeline.agg_transaction_daily [RUN]
2018-04-18 08:41:57,073: Compiling model.agency_data_pipeline.agg_transaction_daily
2018-04-18 08:41:57,072: 08:41:57 | 56 of 91 START table model agency_data_pipeline.agg_ga_campaign_by_type [RUN]
2018-04-18 08:41:57,079: Compiling model.agency_data_pipeline.agg_ga_campaign_by_type
2018-04-18 08:41:57,072: 08:41:57 | 57 of 91 SKIP relation agency_data_pipeline.segment_stats_customers_products_agg [SKIP]
2018-04-18 08:41:57,087: Writing injected SQL for node "model.agency_data_pipeline.agg_ga_campaign_by_type"
2018-04-18 08:41:57,088: Writing injected SQL for node "model.agency_data_pipeline.agg_transaction_daily"
2018-04-18 08:41:57,072: 08:41:57 | 58 of 91 START table model agency_data_pipeline.customers_first_purchase_proc [RUN]
2018-04-18 08:41:57,088: 08:41:57 | 59 of 91 START table model agency_data_pipeline.order_paths_stats.... [RUN]
2018-04-18 08:41:57,089: Compiling model.agency_data_pipeline.customers_first_purchase_proc
2018-04-18 08:41:57,090: Compiling model.agency_data_pipeline.order_paths_stats
2018-04-18 08:41:57,090: Acquiring new bigquery connection "agg_transaction_daily".
2018-04-18 08:41:57,095: Writing injected SQL for node "model.agency_data_pipeline.customers_first_purchase_proc"
2018-04-18 08:41:57,096: Acquiring new bigquery connection "agg_ga_campaign_by_type".
2018-04-18 08:41:57,101: Writing injected SQL for node "model.agency_data_pipeline.order_paths_stats"
2018-04-18 08:41:57,102: Re-using an available connection from the pool.
2018-04-18 08:41:57,102: Re-using an available connection from the pool.
2018-04-18 08:41:57,110: Acquiring new bigquery connection "order_paths_stats".
2018-04-18 08:41:57,113: Re-using an available connection from the pool.
2018-04-18 08:41:57,119: Acquiring new bigquery connection "customers_first_purchase_proc".
2018-04-18 08:41:57,119: Re-using an available connection from the pool.
2018-04-18 08:41:57,824: Model SQL (customers_first_purchase_proc):
SELECT 
client, 
customer_id, 
min(cast(date as date)) first_order_date,
unix_date( min(cast(date as date))) first_order_unix_date
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction`
GROUP BY client, customer_id
2018-04-18 08:41:57,881: Model SQL (agg_transaction_daily):
SELECT
client,
date,
customer_id,
sum(last_touch_transactions) last_touch_transactions, 
sum(last_touch_revenue) last_touch_revenue, 
sum(first_touch_transactions) first_touch_transactions, 
sum(first_touch_revenue) first_touch_revenue,
sum(quantity) quantity,
sum(revenue) revenue,
count(distinct(order_number)) order_count
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction`
GROUP BY
client, 
date, 
customer_id
2018-04-18 08:41:57,882: Model SQL (agg_ga_campaign_by_type):
with orders_new as (
    select 
    date, 
    client, 
    attribution,
    channel, 
    platform, 
    url, 
    campaign,
    count(distinct(customer_id)) customers_new,
    sum(transactions) transactions_new,
    sum(revenue) revenue_new,
    sum(first_order_revenue) first_order_revenue_new,
    sum(lifetime_revenue) lifetime_revenue_new,
    null as customers_total,
    null as transactions_total,
    null as revenue_total
    from `growth-engines-pipeline`.`agency_data_pipeline`.`agg_ga_transaction`
    where order_type = 'New'
    group by date, client, attribution, channel, platform, url, campaign
),
    
orders_total as (
    select 
    date, 
    client, 
    attribution,
    channel, 
    platform, 
    url, 
    campaign,
    null as customers_new,
    null as transactions_new,
    null as revenue_new,
    null as first_order_revenue_new,
    null as lifetime_revenue_new,
    count(distinct(customer_id)) customers_total,
    sum(transactions) transactions_total,
    sum(revenue) revenue_total
    from `growth-engines-pipeline`.`agency_data_pipeline`.`agg_ga_transaction`
    group by date, client, attribution, channel, platform, url, campaign

)

SELECT 
date, 
client, 
attribution,
channel, 
platform, 
url, 
campaign,
sum(customers_new) customers_new,
sum(transactions_new) transactions_new,
sum(revenue_new) revenue_new,
sum(first_order_revenue_new) first_order_revenue_new,
sum(lifetime_revenue_new) lifetime_revenue_new,
sum(customers_total) customers_total,
sum(transactions_total) transactions_total,
sum(revenue_total) revenue_total
from
    ( 
        SELECT * FROM orders_new
        UNION ALL 
        SELECT * FROM orders_total
    )
group by date, client, attribution, channel, platform, url, campaign
2018-04-18 08:41:58,071: Model SQL (order_paths_stats):
WITH transactions AS (
  SELECT 
  client, 
  first_product_type,
  second_product_type,
  first_purchase_date,
  customer_count,
  second_orders,
  third_orders,
  fourth_orders,
  fifth_orders,
  second_order_latency_days,
  third_order_latency_days,
  fourth_order_latency_days,
  fifth_order_latency_days,
  first_order_revenue,
  second_order_revenue,
  unix_date(cast(first_purchase_date as date)) d
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`order_paths_agg`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)

SELECT 
client,
'Rolling 365' as period,
first_product_type,
second_product_type,
date_in_range date,
unix_date_in_range, 
sum(customer_count) customer_count,
sum(second_orders) second_orders,
sum(third_orders) third_orders,
sum(fourth_orders) fourth_orders,
sum(fifth_orders) fifth_orders,
sum(second_order_latency_days) second_order_latency_days,
sum(third_order_latency_days) third_order_latency_days,
sum(fourth_order_latency_days) fourth_order_latency_days,
sum(fifth_order_latency_days) fifth_order_latency_days,
sum(first_order_revenue) first_order_revenue,
sum(second_order_revenue) second_order_revenue
FROM daterange
JOIN transactions
ON transactions.d > ( daterange.unix_date_in_range - 365 )
AND transactions.d <= daterange.unix_date_in_range
group by client, first_product_type, second_product_type, date_in_range, unix_date_in_range
2018-04-18 08:42:00,014: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104523d68>]}
2018-04-18 08:42:00,242: 08:42:00 | 58 of 91 OK created table model agency_data_pipeline.customers_first_purchase_proc [CREATE TABLE in 2.93s]
2018-04-18 08:42:00,243: 08:42:00 | 60 of 91 SKIP relation agency_data_pipeline.segment_stats_category... [SKIP]
2018-04-18 08:42:00,340: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104565d68>]}
2018-04-18 08:42:00,652: 08:42:00 | 59 of 91 OK created table model agency_data_pipeline.order_paths_stats [CREATE TABLE in 3.25s]
2018-04-18 08:42:04,435: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10451afd0>]}
2018-04-18 08:42:04,830: 08:42:04 | 56 of 91 OK created table model agency_data_pipeline.agg_ga_campaign_by_type [CREATE TABLE in 7.36s]
2018-04-18 08:42:05,564: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104583b00>]}
2018-04-18 08:42:05,778: 08:42:05 | 55 of 91 OK created table model agency_data_pipeline.agg_transaction_daily [CREATE TABLE in 8.49s]
2018-04-18 08:42:05,779: 08:42:05 | 61 of 91 START table model agency_data_pipeline.customers_proc....... [RUN]
2018-04-18 08:42:05,779: 08:42:05 | 62 of 91 START table model agency_data_pipeline.growth_customer_0_365 [RUN]
2018-04-18 08:42:05,779: Compiling model.agency_data_pipeline.customers_proc
2018-04-18 08:42:05,779: 08:42:05 | 63 of 91 SKIP relation agency_data_pipeline.segment_stats_customers_products [SKIP]
2018-04-18 08:42:05,780: Compiling model.agency_data_pipeline.growth_customer_0_365
2018-04-18 08:42:05,791: Writing injected SQL for node "model.agency_data_pipeline.growth_customer_0_365"
2018-04-18 08:42:05,792: Writing injected SQL for node "model.agency_data_pipeline.customers_proc"
2018-04-18 08:42:05,795: Acquiring new bigquery connection "growth_customer_0_365".
2018-04-18 08:42:05,796: Re-using an available connection from the pool.
2018-04-18 08:42:05,796: Acquiring new bigquery connection "customers_proc".
2018-04-18 08:42:05,798: Re-using an available connection from the pool.
2018-04-18 08:42:06,735: Model SQL (growth_customer_0_365):
WITH transactions AS (
  SELECT 
  client, 
  customer_id, 
  order_number,
  unix_date(cast(date as date)) d, 
  quantity,
  revenue,
  shipping_revenue
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)

SELECT 
date_in_range date,
unix_date_in_range, 
unix_date_in_range_yoy, 
client, 
customer_id,
count(distinct(order_number)) orders,
sum(quantity) quantity,
sum(revenue) revenue,
sum(shipping_revenue) shipping_revenue
FROM daterange
JOIN transactions
ON transactions.d >= ( daterange.unix_date_in_range - 365 ) 
AND transactions.d <= daterange.unix_date_in_range
GROUP BY date, unix_date_in_range, unix_date_in_range_yoy, client, customer_id
2018-04-18 08:42:06,768: Model SQL (customers_proc):
WITH customers AS (
  SELECT 
  client, 
  customer_id, 
  order_number,
  cast(date as date) order_date,
  unix_date(cast(date as date)) unix_order_date, 
  quantity,
  revenue 
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)
 
SELECT 
client,
period,
customer_id,
date,
window_end_unix_date,
window_end_unix_date - 365 as window_start_unix_date,
window_end_unix_date - unix_date(recent_order) recency_days,
frequency,
quantity,
revenue,
case when frequency > 0 then revenue/frequency else 0 end as aov
FROM 
(  

  SELECT 
  client,
  'Rolling 365' as period,
  customer_id,
  date_in_range date,
  unix_date_in_range,
  unix_date_in_range window_end_unix_date,
  max(order_date) recent_order,
  sum(quantity) as quantity,
  sum(revenue) as revenue,
  count(distinct(order_number)) as frequency
  FROM daterange
  JOIN customers
  ON customers.unix_order_date > ( daterange.unix_date_in_range - 365 )
  AND customers.unix_order_date <= daterange.unix_date_in_range
  GROUP BY client, customer_id, date, unix_date_in_range

  UNION ALL

  SELECT 
  client,
  'Rolling 365 (t-1mo)' as period,
  customer_id,
  date_in_range date,
  unix_date_in_range,
  unix_date_in_range - 30 window_end_unix_date, 
  max(order_date) recent_order,
  sum(quantity) as quantity,
  sum(revenue) as revenue,
  count(distinct(order_number)) as frequency
  FROM daterange
  JOIN customers
  ON customers.unix_order_date > ( daterange.unix_date_in_range - 395 )
  AND customers.unix_order_date <= ( daterange.unix_date_in_range - 30 )
  GROUP BY client, customer_id, date, unix_date_in_range

  UNION ALL

  SELECT 
  client,
  'Rolling 365 (t-1yr)' as period,
  customer_id,
  date_in_range date,
  unix_date_in_range, 
  unix_date_in_range - 365 window_end_unix_date, 
  max(order_date) recent_order,
  sum(quantity) as quantity,
  sum(revenue) as revenue,
  count(distinct(order_number)) as frequency
  FROM daterange
  JOIN customers
  ON customers.unix_order_date > ( daterange.unix_date_in_range - 730 )
  AND customers.unix_order_date <= ( daterange.unix_date_in_range - 365 )
  GROUP BY client, customer_id, date, unix_date_in_range

)
2018-04-18 08:42:27,293: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107111978>]}
2018-04-18 08:42:27,616: 08:42:27 | 62 of 91 OK created table model agency_data_pipeline.growth_customer_0_365 [CREATE TABLE in 21.51s]
2018-04-18 08:42:36,073: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104565e80>]}
2018-04-18 08:42:36,400: 08:42:36 | 61 of 91 OK created table model agency_data_pipeline.customers_proc.. [CREATE TABLE in 30.29s]
2018-04-18 08:42:36,401: 08:42:36 | 64 of 91 START table model agency_data_pipeline.retention_30_60...... [RUN]
2018-04-18 08:42:36,401: Compiling model.agency_data_pipeline.retention_30_60
2018-04-18 08:42:36,401: 08:42:36 | 65 of 91 START table model agency_data_pipeline.retention_0_30....... [RUN]
2018-04-18 08:42:36,409: Writing injected SQL for node "model.agency_data_pipeline.retention_30_60"
2018-04-18 08:42:36,401: 08:42:36 | 66 of 91 SKIP relation agency_data_pipeline.segment_list_customers_products [SKIP]
2018-04-18 08:42:36,409: Compiling model.agency_data_pipeline.retention_0_30
2018-04-18 08:42:36,401: 08:42:36 | 67 of 91 START table model agency_data_pipeline.retention_365_730.... [RUN]
2018-04-18 08:42:36,410: 08:42:36 | 68 of 91 START table model agency_data_pipeline.retention_60_plus.... [RUN]
2018-04-18 08:42:36,417: Writing injected SQL for node "model.agency_data_pipeline.retention_0_30"
2018-04-18 08:42:36,417: Compiling model.agency_data_pipeline.retention_365_730
2018-04-18 08:42:36,417: Compiling model.agency_data_pipeline.retention_60_plus
2018-04-18 08:42:36,418: Acquiring new bigquery connection "retention_30_60".
2018-04-18 08:42:36,437: Re-using an available connection from the pool.
2018-04-18 08:42:36,426: Writing injected SQL for node "model.agency_data_pipeline.retention_365_730"
2018-04-18 08:42:36,439: Acquiring new bigquery connection "retention_0_30".
2018-04-18 08:42:36,437: Writing injected SQL for node "model.agency_data_pipeline.retention_60_plus"
2018-04-18 08:42:36,442: Re-using an available connection from the pool.
2018-04-18 08:42:36,447: Acquiring new bigquery connection "retention_60_plus".
2018-04-18 08:42:36,448: Re-using an available connection from the pool.
2018-04-18 08:42:36,453: Acquiring new bigquery connection "retention_365_730".
2018-04-18 08:42:36,453: Re-using an available connection from the pool.
2018-04-18 08:42:39,253: Model SQL (retention_30_60):
WITH transactions AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_daily`
),

daterange AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`  	
),

temp AS (
  SELECT 
  client, 
  customer_id, 
  unix_date(date) d, 
  quantity,
  revenue,
  order_count
  FROM transactions
)

SELECT 
date_in_range date, 
unix_date_in_range,
client, 
customer_id,
sum(quantity) quantity,
sum(revenue) revenue,
sum(order_count) order_count
FROM daterange
JOIN temp
ON ( temp.d >= ( daterange.unix_date_in_range_bom_mom ) 
AND temp.d < ( daterange.unix_date_in_range_bom ) )
group by date_in_range, unix_date_in_range, client, customer_id
2018-04-18 08:42:39,259: Model SQL (retention_0_30):
WITH transactions AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_daily`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
),

temp AS (
  SELECT 
  client, 
  customer_id, 
  unix_date(date) d, 
  quantity,
  revenue,
  order_count
  FROM transactions
)

SELECT 
date_in_range date,
unix_date_in_range, 
client, 
customer_id,
sum(quantity) quantity,
sum(revenue) revenue,
sum(order_count) order_count
FROM daterange
JOIN temp
ON temp.d >= ( daterange.unix_date_in_range_bom ) 
AND temp.d <= daterange.unix_date_in_range
group by date_in_range, unix_date_in_range, client, customer_id
2018-04-18 08:42:39,260: Model SQL (retention_60_plus):
WITH transactions AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_daily`
),

daterange AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`  	
),

temp AS (
  SELECT 
  client, 
  customer_id, 
  unix_date(date) d, 
  quantity,
  revenue,
  order_count
  FROM transactions
)

SELECT 
date_in_range date, 
unix_date_in_range,
client, 
customer_id,
sum(quantity) quantity,
sum(revenue) revenue,
sum(order_count) order_count
FROM daterange
JOIN temp
ON temp.d < ( daterange.unix_date_in_range_bom_mom ) 
group by date_in_range, unix_date_in_range, client, customer_id
2018-04-18 08:42:39,261: Model SQL (retention_365_730):
WITH transactions AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_daily`
),

daterange AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`  	
),

temp AS (
  SELECT 
  client, 
  customer_id, 
  unix_date(date) d, 
  quantity,
  revenue,
  order_count
  FROM transactions
)

SELECT 
date_in_range date, 
unix_date_in_range,
client, 
customer_id,
sum(quantity) quantity,
sum(revenue) revenue,
sum(order_count) order_count
FROM daterange
JOIN temp
ON ( temp.d >= ( daterange.unix_date_in_range - 730 ) 
AND temp.d < ( daterange.unix_date_in_range - 365 ) )
group by date_in_range, unix_date_in_range, client, customer_id
2018-04-18 08:42:42,268: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10452e438>]}
2018-04-18 08:42:42,564: 08:42:42 | 65 of 91 OK created table model agency_data_pipeline.retention_0_30.. [CREATE TABLE in 5.86s]
2018-04-18 08:42:42,564: 08:42:42 | 69 of 91 START table model agency_data_pipeline.retention_730_plus... [RUN]
2018-04-18 08:42:42,565: Compiling model.agency_data_pipeline.retention_730_plus
2018-04-18 08:42:42,572: Writing injected SQL for node "model.agency_data_pipeline.retention_730_plus"
2018-04-18 08:42:42,573: Acquiring new bigquery connection "retention_730_plus".
2018-04-18 08:42:42,573: Re-using an available connection from the pool.
2018-04-18 08:42:43,541: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104549f98>]}
2018-04-18 08:42:43,544: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10451a2b0>]}
2018-04-18 08:42:43,866: 08:42:43 | 67 of 91 OK created table model agency_data_pipeline.retention_365_730 [CREATE TABLE in 7.12s]
2018-04-18 08:42:43,867: 08:42:43 | 70 of 91 START table model agency_data_pipeline.retention_0_365...... [RUN]
2018-04-18 08:42:43,869: Compiling model.agency_data_pipeline.retention_0_365
2018-04-18 08:42:43,880: Writing injected SQL for node "model.agency_data_pipeline.retention_0_365"
2018-04-18 08:42:43,883: Acquiring new bigquery connection "retention_0_365".
2018-04-18 08:42:43,883: Re-using an available connection from the pool.
2018-04-18 08:42:44,148: 08:42:44 | 64 of 91 OK created table model agency_data_pipeline.retention_30_60. [CREATE TABLE in 7.14s]
2018-04-18 08:42:44,888: Model SQL (retention_730_plus):
WITH transactions AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_daily`
),

daterange AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`  	
),

temp AS (
  SELECT 
  client, 
  customer_id, 
  unix_date(date) d, 
  quantity,
  revenue,
  order_count
  FROM transactions
)

SELECT 
date_in_range date, 
unix_date_in_range,
client, 
customer_id,
sum(quantity) quantity,
sum(revenue) revenue,
sum(order_count) order_count
FROM daterange
JOIN temp
ON temp.d <= ( daterange.unix_date_in_range - 730 ) 
group by date_in_range, unix_date_in_range, client, customer_id
2018-04-18 08:42:45,901: Model SQL (retention_0_365):
WITH transactions AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_daily`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
),

temp AS (
  SELECT 
  client, 
  customer_id, 
  unix_date(date) d, 
  quantity,
  revenue,
  order_count
  FROM transactions
)

SELECT 
date_in_range date,
unix_date_in_range, 
client, 
customer_id,
sum(quantity) quantity,
sum(revenue) revenue,
sum(order_count) order_count
FROM daterange
JOIN temp
ON temp.d >= ( daterange.unix_date_in_range - 365 ) 
AND temp.d <= daterange.unix_date_in_range
group by date_in_range, unix_date_in_range, client, customer_id
2018-04-18 08:42:47,857: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10452e438>]}
2018-04-18 08:42:48,486: 08:42:48 | 69 of 91 OK created table model agency_data_pipeline.retention_730_plus [CREATE TABLE in 5.29s]
2018-04-18 08:42:50,779: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10451afd0>]}
2018-04-18 08:42:50,990: 08:42:50 | 68 of 91 OK created table model agency_data_pipeline.retention_60_plus [CREATE TABLE in 14.36s]
2018-04-18 08:42:56,292: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107111a90>]}
2018-04-18 08:42:56,589: 08:42:56 | 70 of 91 OK created table model agency_data_pipeline.retention_0_365. [CREATE TABLE in 12.42s]
2018-04-18 08:42:56,590: 08:42:56 | 71 of 91 START table model agency_data_pipeline.agg_platforms_union.. [RUN]
2018-04-18 08:42:56,591: Compiling model.agency_data_pipeline.agg_platforms_union
2018-04-18 08:42:56,590: 08:42:56 | 72 of 91 START table model agency_data_pipeline.segment_proc_customers [RUN]
2018-04-18 08:42:56,597: Compiling model.agency_data_pipeline.segment_proc_customers
2018-04-18 08:42:56,603: Writing injected SQL for node "model.agency_data_pipeline.segment_proc_customers"
2018-04-18 08:42:56,604: Writing injected SQL for node "model.agency_data_pipeline.agg_platforms_union"
2018-04-18 08:42:56,606: Acquiring new bigquery connection "segment_proc_customers".
2018-04-18 08:42:56,606: Re-using an available connection from the pool.
2018-04-18 08:42:56,608: Acquiring new bigquery connection "agg_platforms_union".
2018-04-18 08:42:56,608: Re-using an available connection from the pool.
2018-04-18 08:43:00,279: Model SQL (segment_proc_customers):
SELECT
client,
period,
date,
customer_id,
first_order_date,
first_order_unix_date,
recency_days,
frequency,
revenue,
quantity,
aov,
case when recency_days <= 30 and first_order_unix_date >= window_start_unix_date then 'New'
	when frequency = 1 and recency_days <= 90 and aov >= aov_40pct then 'Promising'
	when frequency = 1 then 'One-time Purchaser'
	when frequency >= frequency_90pct and recency_days <= 90 and aov > aov_40pct then 'Whale'
	when recency_days <= 240 and frequency > frequency_50pct then 'Loyal'
	when recency_days <= 90 and frequency > frequency_50pct then 'Potential Loyalists' 
	when recency_days > 240 and frequency > frequency_50pct then 'Defecting Good Customer'	
	when recency_days > recency_50pct and frequency > frequency_50pct then 'Frequent, not Recent'
	when recency_days < recency_50pct and frequency < frequency_50pct then 'Recent, not Frequent'
	else 'Unbucketed' end as segment,
aov_40pct,
frequency_90pct,
frequency_75pct,
frequency_50pct,
recency_90pct,
recency_75pct,
recency_50pct
FROM
(
	SELECT 
	a.client client,
	period,
	date,
	a.customer_id customer_id,
	b.first_order_date first_order_date,
	b.first_order_unix_date first_order_unix_date,
	window_start_unix_date,
	window_end_unix_date,
	recency_days,
	frequency,
	revenue,
	quantity,
	aov,
	PERCENTILE_CONT(aov, 0.40) OVER w1 AS aov_40pct,
	PERCENTILE_CONT(frequency, 0.90) OVER w1 AS frequency_90pct,
	PERCENTILE_CONT(frequency, 0.75) OVER w1 AS frequency_75pct,
	PERCENTILE_CONT(frequency, 0.90) OVER w1 AS frequency_50pct,
	PERCENTILE_CONT(recency_days, 0.10) OVER w1 AS recency_90pct,
	PERCENTILE_CONT(recency_days, 0.25) OVER w1 AS recency_75pct,
	PERCENTILE_CONT(recency_days, 0.5) OVER w1 AS recency_50pct
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`customers_proc` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`customers_first_purchase_proc` b
	ON (
		a.client = b.client and
		a.customer_id = b.customer_id
		)
	WINDOW w1 as (PARTITION BY a.client, period, date)
)
2018-04-18 08:43:00,307: Model SQL (agg_platforms_union):
SELECT 
date, 
account, 
channel,
platform,
url,
utm_campaign,
campaign,
cost,
impressions,
clicks,
transactions
FROM 
`growth-engines-pipeline`.`agency_data_pipeline`.`adwords_stats`

UNION ALL

SELECT 
date, 
account, 
channel,
platform,
url,
utm_campaign,
campaign,
cost,
impressions,
clicks,
transactions
FROM 
`growth-engines-pipeline`.`agency_data_pipeline`.`bing_ads_stats`

UNION ALL  

SELECT 
date, 
account, 
channel,
platform,
url,
utm_campaign,
campaign,
cost,
impressions,
clicks,
transactions
FROM 
`growth-engines-pipeline`.`agency_data_pipeline`.`fb_ads_stats`
2018-04-18 08:43:04,654: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10451afd0>]}
2018-04-18 08:43:04,990: 08:43:04 | 71 of 91 OK created table model agency_data_pipeline.agg_platforms_union [CREATE TABLE in 8.06s]
2018-04-18 08:43:28,875: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1045608d0>]}
2018-04-18 08:43:29,182: 08:43:29 | 72 of 91 OK created table model agency_data_pipeline.segment_proc_customers [CREATE TABLE in 32.28s]
2018-04-18 08:43:29,183: 08:43:29 | 73 of 91 START table model agency_data_pipeline.segment_stats_customers_agg [RUN]
2018-04-18 08:43:29,184: Compiling model.agency_data_pipeline.segment_stats_customers_agg
2018-04-18 08:43:29,192: Writing injected SQL for node "model.agency_data_pipeline.segment_stats_customers_agg"
2018-04-18 08:43:29,184: 08:43:29 | 74 of 91 START table model agency_data_pipeline.retention_0_365_rebuy [RUN]
2018-04-18 08:43:29,184: 08:43:29 | 75 of 91 START table model agency_data_pipeline.retention_0_30_rebuy. [RUN]
2018-04-18 08:43:29,193: Compiling model.agency_data_pipeline.retention_0_365_rebuy
2018-04-18 08:43:29,193: Compiling model.agency_data_pipeline.retention_0_30_rebuy
2018-04-18 08:43:29,194: Acquiring new bigquery connection "segment_stats_customers_agg".
2018-04-18 08:43:29,198: Writing injected SQL for node "model.agency_data_pipeline.retention_0_365_rebuy"
2018-04-18 08:43:29,203: Writing injected SQL for node "model.agency_data_pipeline.retention_0_30_rebuy"
2018-04-18 08:43:29,203: Re-using an available connection from the pool.
2018-04-18 08:43:29,206: Acquiring new bigquery connection "retention_0_365_rebuy".
2018-04-18 08:43:29,207: Acquiring new bigquery connection "retention_0_30_rebuy".
2018-04-18 08:43:29,208: Re-using an available connection from the pool.
2018-04-18 08:43:29,209: Re-using an available connection from the pool.
2018-04-18 08:43:29,975: Model SQL (segment_stats_customers_agg):
WITH ty as (

	SELECT
	client,
	date,
	customer_id,
	segment as segment_365,
	recency_days as recency_365,
	frequency as frequency_365,
	revenue as revenue_365,
	aov as aov_365,
	'' as segment_mom,
	0 as recency_mom,
	0 as frequency_mom,
	0 as revenue_mom,
	0 as aov_mom,
	'' as segment_yoy,
	0 as recency_yoy,
	0 as frequency_yoy,
	0 as revenue_yoy,
	0 as aov_yoy
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers`
	WHERE period = 'Rolling 365'

),

last_month as (

	SELECT
	client,
	date,
	customer_id,
	'' as segment_365,
	0 as recency_365,
	0 as frequency_365,
	0 as revenue_365,
	0 as aov_365,
	segment as segment_mom,
	recency_days as recency_mom,
	frequency as frequency_mom,
	revenue as revenue_mom,
	aov as aov_mom,
	'' as segment_yoy,
	0 as recency_yoy,
	0 as frequency_yoy,
	0 as revenue_yoy,
	0 as aov_yoy
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers`
	WHERE period = 'Rolling 365 (t-1mo)'

),

this_month_1yr as (

	SELECT
	client,
	date,
	customer_id,
	'' as segment_365,
	0 as recency_365,
	0 as frequency_365,
	0 as revenue_365,
	0 as aov_365,
	'' as segment_mom,
	0 as recency_mom,
	0 as frequency_mom,
	0 as revenue_mom,
	0 as aov_mom,
	segment as segment_yoy,
	recency_days as recency_yoy,
	frequency as frequency_yoy,
	revenue as revenue_yoy,
	aov as aov_yoy
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers`
	WHERE period = 'Rolling 365 (t-1yr)'


)

SELECT
client,
date, 
customer_id,
ifnull(max(segment_365), '') segment_365,
ifnull(max(segment_mom), '') segment_mom,
ifnull(max(segment_yoy), '') segment_yoy,
ifnull(sum(recency_365), 0) recency_365,
ifnull(sum(frequency_365), 0) frequency_365,
ifnull(sum(revenue_365), 0) revenue_365,
ifnull(sum(aov_365), 0) aov_365,
ifnull(sum(recency_mom), 0) recency_mom,
ifnull(sum(frequency_mom), 0) frequency_mom,
ifnull(sum(revenue_mom), 0) revenue_mom,
ifnull(sum(aov_mom), 0) aov_mom,	
ifnull(sum(recency_yoy), 0) recency_yoy,
ifnull(sum(frequency_yoy), 0) frequency_yoy,
ifnull(sum(revenue_yoy), 0) revenue_yoy,
ifnull(sum(aov_yoy), 0) aov_yoy
FROM
(
	SELECT * FROM ty
	UNION ALL
	SELECT * FROM last_month
	UNION ALL
	SELECT * FROM this_month_1yr

)
GROUP BY client, date, customer_id
2018-04-18 08:43:30,043: Model SQL (retention_0_365_rebuy):
SELECT 
r2.client,
r2.date,
r2.customer_id, 
r2.quantity,
r2.revenue
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_365_730` r1 
left join `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365` r2 
  on ( r1.customer_id = r2.customer_id 
  and r1.date = r2.date )
2018-04-18 08:43:30,150: Model SQL (retention_0_30_rebuy):
SELECT 
r2.client,
r2.date,
r2.customer_id, 
r2.quantity,
r2.revenue
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_30_60` r1 
left join `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30` r2 
  on ( r1.customer_id = r2.customer_id 
  and r1.date = r2.date )
2018-04-18 08:43:35,552: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104523da0>]}
2018-04-18 08:43:35,839: 08:43:35 | 74 of 91 OK created table model agency_data_pipeline.retention_0_365_rebuy [CREATE TABLE in 6.36s]
2018-04-18 08:43:44,370: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10452e780>]}
2018-04-18 08:43:44,628: 08:43:44 | 75 of 91 OK created table model agency_data_pipeline.retention_0_30_rebuy [CREATE TABLE in 15.18s]
2018-04-18 08:43:52,834: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109530358>]}
2018-04-18 08:43:53,527: 08:43:53 | 73 of 91 OK created table model agency_data_pipeline.segment_stats_customers_agg [CREATE TABLE in 23.65s]
2018-04-18 08:43:53,528: 08:43:53 | 76 of 91 START table model agency_data_pipeline.retention_stats_rebuy_rate_month [RUN]
2018-04-18 08:43:53,529: Compiling model.agency_data_pipeline.retention_stats_rebuy_rate_month
2018-04-18 08:43:53,528: 08:43:53 | 77 of 91 START table model agency_data_pipeline.retention_0_30_reactivated [RUN]
2018-04-18 08:43:53,541: Compiling model.agency_data_pipeline.retention_0_30_reactivated
2018-04-18 08:43:53,548: Writing injected SQL for node "model.agency_data_pipeline.retention_stats_rebuy_rate_month"
2018-04-18 08:43:53,529: 08:43:53 | 78 of 91 START table model agency_data_pipeline.retention_0_365_reactivated [RUN]
2018-04-18 08:43:53,553: Writing injected SQL for node "model.agency_data_pipeline.retention_0_30_reactivated"
2018-04-18 08:43:53,529: 08:43:53 | 79 of 91 START table model agency_data_pipeline.retention_stats_rebuy_rate [RUN]
2018-04-18 08:43:53,553: Compiling model.agency_data_pipeline.retention_0_365_reactivated
2018-04-18 08:43:53,554: Acquiring new bigquery connection "retention_stats_rebuy_rate_month".
2018-04-18 08:43:53,554: Compiling model.agency_data_pipeline.retention_stats_rebuy_rate
2018-04-18 08:43:53,559: Writing injected SQL for node "model.agency_data_pipeline.retention_0_365_reactivated"
2018-04-18 08:43:53,560: Re-using an available connection from the pool.
2018-04-18 08:43:53,571: Acquiring new bigquery connection "retention_0_30_reactivated".
2018-04-18 08:43:53,576: Re-using an available connection from the pool.
2018-04-18 08:43:53,575: Writing injected SQL for node "model.agency_data_pipeline.retention_stats_rebuy_rate"
2018-04-18 08:43:53,580: Acquiring new bigquery connection "retention_0_365_reactivated".
2018-04-18 08:43:53,581: Re-using an available connection from the pool.
2018-04-18 08:43:53,587: Acquiring new bigquery connection "retention_stats_rebuy_rate".
2018-04-18 08:43:53,587: Re-using an available connection from the pool.
2018-04-18 08:43:54,450: Model SQL (retention_stats_rebuy_rate):
WITH r1 AS (
	SELECT 
	date,
	client,
	count(distinct customer_id) customers_prior_year,
	0 as customers_current_year, 
	sum(quantity) quantity_prior_year,
	0 as quantity_current_year,
	sum(revenue) revenue_prior_year,
	0 as revenue_current_year,
	case when sum(quantity) > 0 then sum(revenue)/sum(quantity) else null end as aov_prior_year,
	null as aov_current_year
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_365_730`
	group by date, client
),

r2 AS (
	SELECT 
	date,
	client,
	0 as customers_prior_year,
	count(distinct customer_id) customers_current_year, 
	0 as quantity_prior_year,
	sum(quantity) quantity_current_year,
	0 as revenue_prior_year,
	sum(revenue) revenue_current_year,
	null as aov_prior_year,
	case when sum(quantity) > 0 then sum(revenue)/sum(quantity) else null end as aov_current_year
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365_rebuy`
	group by date, client
)

SELECT 
date,
client,
sum(customers_prior_year) customers_prior_year, 
sum(customers_current_year) customers_current_year,
sum(quantity_prior_year) quantity_prior_year,
sum(quantity_current_year) quantity_current_year,
sum(revenue_prior_year) revenue_prior_year,
sum(revenue_current_year) revenue_current_year,
sum(aov_prior_year) aov_prior_year,
sum(aov_current_year) aov_current_year,
case when sum(revenue_prior_year) > 0 then sum(revenue_current_year)/sum(revenue_prior_year) else null end as revenue_retention,
case when sum(customers_prior_year) > 0 then sum(customers_current_year)/sum(customers_prior_year) else null end as customer_retention
FROM
(
	SELECT
	date,
	client,
	customers_prior_year,
	customers_current_year,
	quantity_prior_year,
	quantity_current_year,
	revenue_prior_year,
	revenue_current_year,
	aov_prior_year,
	aov_current_year
	FROM r1

	UNION ALL

	SELECT
	date,
	client,
	customers_prior_year,
	customers_current_year,
	quantity_prior_year,
	quantity_current_year,
	revenue_prior_year,
	revenue_current_year,
	aov_prior_year,
	aov_current_year
	FROM r2

) 
GROUP BY date, client
2018-04-18 08:43:54,464: Model SQL (retention_stats_rebuy_rate_month):
WITH r1 AS (
	SELECT 
	date,
	client,
	count(distinct customer_id) customers_prior_year,
	0 as customers_current_year, 
	sum(quantity) quantity_prior_year,
	0 as quantity_current_year,
	sum(revenue) revenue_prior_year,
	0 as revenue_current_year,
	case when sum(quantity) > 0 then sum(revenue)/sum(quantity) else null end as aov_prior_year,
	null as aov_current_year
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_30_60`
	group by date, client
),

r2 AS (
	SELECT 
	date,
	client,
	0 as customers_prior_year,
	count(distinct customer_id) customers_current_year, 
	0 as quantity_prior_year,
	sum(quantity) quantity_current_year,
	0 as revenue_prior_year,
	sum(revenue) revenue_current_year,
	null as aov_prior_year,
	case when sum(quantity) > 0 then sum(revenue)/sum(quantity) else null end as aov_current_year
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30_rebuy`
	group by date, client
)

SELECT 
date,
client,
sum(customers_prior_year) customers_prior_year, 
sum(customers_current_year) customers_current_year,
sum(quantity_prior_year) quantity_prior_year,
sum(quantity_current_year) quantity_current_year,
sum(revenue_prior_year) revenue_prior_year,
sum(revenue_current_year) revenue_current_year,
sum(aov_prior_year) aov_prior_year,
sum(aov_current_year) aov_current_year,
case when sum(revenue_prior_year) > 0 then sum(revenue_current_year)/sum(revenue_prior_year) else null end as revenue_retention,
case when sum(customers_prior_year) > 0 then sum(customers_current_year)/sum(customers_prior_year) else null end as customer_retention
FROM
(
	SELECT
	date,
	client,
	customers_prior_year,
	customers_current_year,
	quantity_prior_year,
	quantity_current_year,
	revenue_prior_year,
	revenue_current_year,
	aov_prior_year,
	aov_current_year
	FROM r1

	UNION ALL

	SELECT
	date,
	client,
	customers_prior_year,
	customers_current_year,
	quantity_prior_year,
	quantity_current_year,
	revenue_prior_year,
	revenue_current_year,
	aov_prior_year,
	aov_current_year
	FROM r2

) 
GROUP BY date, client
2018-04-18 08:43:54,497: Model SQL (retention_0_30_reactivated):
SELECT 
a.client,
a.date,
a.customer_id, 
a.quantity,
a.revenue
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_60_plus` b
ON (
	a.client = b.client AND
	a.date = b.date AND
	a.customer_id = b.customer_id
)
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_30_60` c
ON (
	a.client = c.client AND
	a.date = c.date AND
	a.customer_id = c.customer_id
)
WHERE b.customer_id is not null 
AND c.customer_id is null
2018-04-18 08:43:55,133: Model SQL (retention_0_365_reactivated):
SELECT 
a.client,
a.date,
a.customer_id, 
a.quantity,
a.revenue
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_730_plus` b
ON (
	a.client = b.client AND
	a.date = b.date AND
	a.customer_id = b.customer_id
)
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_365_730` c
ON (
	a.client = c.client AND
	a.date = c.date AND
	a.customer_id = c.customer_id
)
WHERE b.customer_id is not null 
AND c.customer_id is null
2018-04-18 08:43:56,620: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10452ee48>]}
2018-04-18 08:43:56,649: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1045608d0>]}
2018-04-18 08:43:56,920: 08:43:56 | 79 of 91 OK created table model agency_data_pipeline.retention_stats_rebuy_rate [CREATE TABLE in 3.07s]
2018-04-18 08:43:56,922: 08:43:56 | 80 of 91 START table model agency_data_pipeline.agg_platforms_client. [RUN]
2018-04-18 08:43:56,925: Compiling model.agency_data_pipeline.agg_platforms_client
2018-04-18 08:43:56,937: Writing injected SQL for node "model.agency_data_pipeline.agg_platforms_client"
2018-04-18 08:43:56,941: Acquiring new bigquery connection "agg_platforms_client".
2018-04-18 08:43:56,941: Re-using an available connection from the pool.
2018-04-18 08:43:57,224: 08:43:57 | 76 of 91 OK created table model agency_data_pipeline.retention_stats_rebuy_rate_month [CREATE TABLE in 3.12s]
2018-04-18 08:43:57,224: 08:43:57 | 81 of 91 START table model agency_data_pipeline.retention_0_30_new... [RUN]
2018-04-18 08:43:57,224: Compiling model.agency_data_pipeline.retention_0_30_new
2018-04-18 08:43:57,230: Writing injected SQL for node "model.agency_data_pipeline.retention_0_30_new"
2018-04-18 08:43:57,230: Acquiring new bigquery connection "retention_0_30_new".
2018-04-18 08:43:57,230: Re-using an available connection from the pool.
2018-04-18 08:43:57,571: Model SQL (agg_platforms_client):
SELECT 
date, 
a.account account, 
b.client client,
a.platform platform,
a.channel channel,
url,
utm_campaign,
campaign,
cost,
impressions,
clicks,
transactions ad_platform_transactions
FROM 
  `growth-engines-pipeline`.`agency_data_pipeline`.`agg_platforms_union` a
LEFT JOIN 
  `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc` b
ON ( 
  a.account = b.account AND
  a.platform = b.platform
)
2018-04-18 08:43:57,842: Model SQL (retention_0_30_new):
SELECT 
a.client,
a.date,
a.customer_id, 
a.quantity,
a.revenue,
a.order_count
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_60_plus` b
ON (
	a.client = b.client AND
	a.date = b.date AND
	a.customer_id = b.customer_id
)
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_30_60` c
ON (
	a.client = c.client AND
	a.date = c.date AND
	a.customer_id = c.customer_id
)
WHERE b.customer_id is null 
and c.customer_id is null
2018-04-18 08:43:58,409: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1094fe668>]}
2018-04-18 08:43:58,721: 08:43:58 | 78 of 91 OK created table model agency_data_pipeline.retention_0_365_reactivated [CREATE TABLE in 4.86s]
2018-04-18 08:43:58,722: 08:43:58 | 82 of 91 START table model agency_data_pipeline.retention_0_365_new.. [RUN]
2018-04-18 08:43:58,722: Compiling model.agency_data_pipeline.retention_0_365_new
2018-04-18 08:43:58,734: Writing injected SQL for node "model.agency_data_pipeline.retention_0_365_new"
2018-04-18 08:43:58,735: Acquiring new bigquery connection "retention_0_365_new".
2018-04-18 08:43:58,735: Re-using an available connection from the pool.
2018-04-18 08:43:58,865: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109524668>]}
2018-04-18 08:43:59,099: 08:43:59 | 77 of 91 OK created table model agency_data_pipeline.retention_0_30_reactivated [CREATE TABLE in 5.32s]
2018-04-18 08:43:59,100: 08:43:59 | 83 of 91 START table model agency_data_pipeline.segment_stats_customers [RUN]
2018-04-18 08:43:59,100: Compiling model.agency_data_pipeline.segment_stats_customers
2018-04-18 08:43:59,105: Writing injected SQL for node "model.agency_data_pipeline.segment_stats_customers"
2018-04-18 08:43:59,108: Acquiring new bigquery connection "segment_stats_customers".
2018-04-18 08:43:59,109: Re-using an available connection from the pool.
2018-04-18 08:43:59,353: Model SQL (retention_0_365_new):
SELECT 
a.client,
a.date,
a.customer_id, 
a.quantity,
a.revenue,
a.order_count
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_730_plus` b
ON (
	a.client = b.client AND
	a.date = b.date AND
	a.customer_id = b.customer_id
)
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_365_730` c
ON (
	a.client = c.client AND
	a.date = c.date AND
	a.customer_id = c.customer_id
)
WHERE b.customer_id is null 
and c.customer_id is null
2018-04-18 08:43:59,793: Model SQL (segment_stats_customers):
SELECT
client,
date,
segment_365,
segment_mom,
segment_yoy,
count(distinct(customer_id)) customers,
avg(recency_365) recency_365,
sum(frequency_365) frequency_365,
sum(revenue_365) revenue_365,
case when sum(frequency_365) > 0 then sum(revenue_365)/sum(frequency_365) else null end as aov_365,
avg(recency_mom) recency_mom,
sum(frequency_mom) frequency_mom,
sum(revenue_mom) revenue_mom,
case when sum(frequency_mom) > 0 then sum(revenue_mom)/sum(frequency_mom) else null end as aov_mom,
avg(recency_yoy) recency_yoy,
sum(frequency_yoy) frequency_yoy,
sum(revenue_yoy) revenue_yoy,
case when sum(frequency_yoy) > 0 then sum(revenue_yoy)/sum(frequency_yoy) else null end as aov_yoy
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_stats_customers_agg`
GROUP BY client, date, segment_365, segment_mom, segment_yoy
2018-04-18 08:44:00,907: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109522d68>]}
2018-04-18 08:44:01,221: 08:44:01 | 80 of 91 OK created table model agency_data_pipeline.agg_platforms_client [CREATE TABLE in 3.98s]
2018-04-18 08:44:03,729: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1045386d8>]}
2018-04-18 08:44:04,034: 08:44:04 | 81 of 91 OK created table model agency_data_pipeline.retention_0_30_new [CREATE TABLE in 6.50s]
2018-04-18 08:44:08,090: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104523080>]}
2018-04-18 08:44:08,401: 08:44:08 | 82 of 91 OK created table model agency_data_pipeline.retention_0_365_new [CREATE TABLE in 9.37s]
2018-04-18 08:44:12,804: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10718b080>]}
2018-04-18 08:44:13,089: 08:44:13 | 83 of 91 OK created table model agency_data_pipeline.segment_stats_customers [CREATE TABLE in 13.70s]
2018-04-18 08:44:13,090: 08:44:13 | 84 of 91 START table model agency_data_pipeline.segment_list_customers [RUN]
2018-04-18 08:44:13,090: Compiling model.agency_data_pipeline.segment_list_customers
2018-04-18 08:44:13,099: Writing injected SQL for node "model.agency_data_pipeline.segment_list_customers"
2018-04-18 08:44:13,101: Acquiring new bigquery connection "segment_list_customers".
2018-04-18 08:44:13,101: Re-using an available connection from the pool.
2018-04-18 08:44:14,076: Model SQL (segment_list_customers):
SELECT
a.client,
period,
date,
customer_id,
b.first_name,
b.last_name,
b.email,
recency_days,
frequency,
revenue,
quantity,
aov,
segment
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`agg_customers_union` b
ON (
	a.client = b.client AND
	a.customer_id = b.id
)
2018-04-18 08:44:45,646: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104538b70>]}
2018-04-18 08:44:45,952: 08:44:45 | 84 of 91 OK created table model agency_data_pipeline.segment_list_customers [CREATE TABLE in 32.56s]
2018-04-18 08:44:45,953: 08:44:45 | 85 of 91 START table model agency_data_pipeline.growth_customer_0_365_segment [RUN]
2018-04-18 08:44:45,953: Compiling model.agency_data_pipeline.growth_customer_0_365_segment
2018-04-18 08:44:45,966: Writing injected SQL for node "model.agency_data_pipeline.growth_customer_0_365_segment"
2018-04-18 08:44:45,968: Acquiring new bigquery connection "growth_customer_0_365_segment".
2018-04-18 08:44:45,968: Re-using an available connection from the pool.
2018-04-18 08:44:46,743: Model SQL (growth_customer_0_365_segment):
with segment as (

	SELECT 
	a.date,
	unix_date_in_range,
	unix_date_in_range_yoy,
	a.client client,
	a.customer_id customer_id,
	case when b.customer_id is not null then 'New' else 'Existing' end as segment,
	a.orders,
	a.quantity,
	a.revenue,
	a.shipping_revenue
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_customer_0_365` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365_new` b
	ON (
	  a.customer_id = b.customer_id AND
	  a.date  = b.date AND
	  a.client = b.client
	)
),

total as (

	SELECT 
	date,
	unix_date_in_range,
	unix_date_in_range_yoy,
	client,
	customer_id,
	'Total' as segment,
	orders,
	quantity,
	revenue,
	shipping_revenue
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_customer_0_365`

)

SELECT 
date,
unix_date_in_range,
unix_date_in_range_yoy,
client,
segment,
count(distinct(customer_id)) customers,
sum(orders) orders,
sum(quantity) quantity,
sum(revenue) revenue,
sum(shipping_revenue) shipping_revenue
FROM
( 
	SELECT * FROM segment
	UNION ALL
	SELECT * FROM total
) 
GROUP BY date, unix_date_in_range, unix_date_in_range_yoy, client, segment
2018-04-18 08:44:57,628: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10718b080>]}
2018-04-18 08:44:58,217: 08:44:58 | 85 of 91 OK created table model agency_data_pipeline.growth_customer_0_365_segment [CREATE TABLE in 11.67s]
2018-04-18 08:44:58,217: 08:44:58 | 86 of 91 START table model agency_data_pipeline.growth_date_union.... [RUN]
2018-04-18 08:44:58,218: Compiling model.agency_data_pipeline.growth_date_union
2018-04-18 08:44:58,229: Writing injected SQL for node "model.agency_data_pipeline.growth_date_union"
2018-04-18 08:44:58,232: Acquiring new bigquery connection "growth_date_union".
2018-04-18 08:44:58,233: Re-using an available connection from the pool.
2018-04-18 08:44:59,031: Model SQL (growth_date_union):
with ty as (

  SELECT 
  date,
  unix_date_in_range, 
  unix_date_in_range_yoy, 
  client, 
  segment,
  customers customers_ty,
  orders orders_ty,
  quantity quantity_ty,
  revenue revenue_ty,
  shipping_revenue shipping_revenue_ty,
  null as customers_ly,
  null as orders_ly,
  null as quantity_ly,
  null as revenue_ly,
  null as shipping_revenue_ly
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_customer_0_365_segment`

),

ly as (

  SELECT 
  date,
  0 as unix_date_in_range, 
  unix_date_in_range unix_date_in_range_yoy, 
  client, 
  segment,
  null as customers_ty,
  null as orders_ty,
  null as quantity_ty,
  null as revenue_ty,
  null as shipping_revenue_ty,
  customers customers_ly,
  orders orders_ly,
  quantity quantity_ly,
  revenue revenue_ly,
  shipping_revenue shipping_revenue_ly
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_customer_0_365_segment`

)


SELECT
max(date) date,
max(unix_date_in_range) unix_date_in_range,
unix_date_in_range_yoy,
client,
segment,
ifnull(sum(customers_ty), 0) customers_ty,
ifnull(sum(orders_ty), 0) orders_ty,
ifnull(sum(quantity_ty), 0) quantity_ty,
ifnull(sum(revenue_ty), 0) revenue_ty,
ifnull(sum(shipping_revenue_ty), 0) shipping_revenue_ty,
case when sum(orders_ty) > 0 then sum(revenue_ty)/sum(orders_ty) else null end as aov_ty,
ifnull(sum(customers_ly), 0) customers_ly,
ifnull(sum(orders_ly), 0) orders_ly,
ifnull(sum(quantity_ly), 0) quantity_ly,
ifnull(sum(revenue_ly), 0) revenue_ly,
ifnull(sum(shipping_revenue_ly), 0) shipping_revenue_ly,
case when sum(orders_ly) > 0 then sum(revenue_ly)/sum(orders_ly) else null end as aov_ly,
case when sum(orders_ly) > 0 then ( sum(orders_ty) - sum(orders_ly) ) / sum(orders_ly) else null end as order_growth,
case when sum(revenue_ly) > 0 then ( sum(revenue_ty) - sum(revenue_ly) ) / sum(revenue_ly) else null end as revenue_growth,
case when sum(customers_ly) > 0 then ( sum(customers_ty) - sum(customers_ly) ) / sum(customers_ly) else null end as customer_growth,
case when sum(orders_ly) > 0 then ( sum(revenue_ty)/sum(orders_ty) - sum(revenue_ly)/sum(orders_ly) ) / ( sum(revenue_ly)/sum(orders_ly) ) else null end as aov_growth
FROM (

  SELECT * FROM ty
  UNION ALL
  SELECT * FROM ly

)
where unix_date_in_range is not null
group by unix_date_in_range_yoy, client, segment
2018-04-18 08:45:00,119: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104538b70>]}
2018-04-18 08:45:00,393: 08:45:00 | 86 of 91 OK created table model agency_data_pipeline.growth_date_union [CREATE TABLE in 1.90s]
2018-04-18 08:45:00,393: 08:45:00 | 87 of 91 START table model agency_data_pipeline.retention_stats...... [RUN]
2018-04-18 08:45:00,394: Compiling model.agency_data_pipeline.retention_stats
2018-04-18 08:45:00,393: 08:45:00 | 88 of 91 START table model agency_data_pipeline.growth_stats......... [RUN]
2018-04-18 08:45:00,394: 08:45:00 | 89 of 91 START table model agency_data_pipeline.retention_stats_month [RUN]
2018-04-18 08:45:00,405: Compiling model.agency_data_pipeline.growth_stats
2018-04-18 08:45:00,405: Writing injected SQL for node "model.agency_data_pipeline.retention_stats"
2018-04-18 08:45:00,405: Compiling model.agency_data_pipeline.retention_stats_month
2018-04-18 08:45:00,417: Writing injected SQL for node "model.agency_data_pipeline.growth_stats"
2018-04-18 08:45:00,433: Writing injected SQL for node "model.agency_data_pipeline.retention_stats_month"
2018-04-18 08:45:00,435: Acquiring new bigquery connection "retention_stats".
2018-04-18 08:45:00,436: Acquiring new bigquery connection "growth_stats".
2018-04-18 08:45:00,440: Acquiring new bigquery connection "retention_stats_month".
2018-04-18 08:45:00,440: Re-using an available connection from the pool.
2018-04-18 08:45:00,445: Re-using an available connection from the pool.
2018-04-18 08:45:00,447: Re-using an available connection from the pool.
2018-04-18 08:45:01,286: Model SQL (retention_stats):
WITH last_year_buyers AS (
	SELECT 
	date,
	client,
	'Last year buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_365_730`
	group by date, client
),

rebuy_rate AS (
	SELECT 
	date,
	client,
	'Rebuy rate' as metric,
	customer_retention value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_stats_rebuy_rate`
),

repeat_buyers AS (
	SELECT 
	date,
	client,
	'Repeat buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365_rebuy`
	group by date, client
),

reactivated_buyers AS (
	SELECT 
	date,
	client,
	'Reactivated buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365_reactivated`
	group by date, client
),

new_buyers AS (
	SELECT 
	date,
	client,
	'New buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365_new`
	group by date, client
),

this_year_buyers AS (
	SELECT 
	date,
	client,
	'This year buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365`
	group by date, client
),

this_year_revenue AS (
	SELECT 
	date,
	client,
	'This year revenue' as metric,
	sum(revenue) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365`
	group by date, client
),

this_year_aov AS (
	SELECT 
	date,
	client,
	'This year AOV' as metric,
	case when sum(order_count) > 0 then sum(revenue)/sum(order_count) else 0 end as value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365`
	group by date, client
),

this_year_frequency AS (
	SELECT 
	date,
	client,
	'This year frequency' as metric,
	case when count(distinct customer_id) > 0 then sum(order_count)/count(distinct customer_id) else 0 end as value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365`
	group by date, client
)

SELECT 
date,
client,
metric,
ifnull(value, 0) value
FROM
(
	SELECT
	date,
	client,
	metric,
	value
	FROM last_year_buyers

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM rebuy_rate

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM repeat_buyers

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM reactivated_buyers	

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM new_buyers	

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_year_buyers	

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_year_revenue

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_year_aov

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_year_frequency

	UNION ALL

	SELECT
	a.date,
	a.client,
	'Dormant buyers' as metric,
	a.value - ifnull(b.value, 0) as value
	FROM last_year_buyers a
	LEFT JOIN repeat_buyers b
	ON ( a.date = b.date AND
		a.client = b.client )							

)
2018-04-18 08:45:01,287: Model SQL (retention_stats_month):
WITH last_month_buyers AS (
	SELECT 
	date,
	client,
	'Last month buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_30_60`
	group by date, client
),

rebuy_rate AS (
	SELECT 
	date,
	client,
	'Rebuy rate' as metric,
	customer_retention value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_stats_rebuy_rate_month`
),

repeat_buyers AS (
	SELECT 
	date,
	client,
	'Repeat buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30_rebuy`
	group by date, client
),

reactivated_buyers AS (
	SELECT 
	date,
	client,
	'Reactivated buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30_reactivated`
	group by date, client
),

new_buyers AS (
	SELECT 
	date,
	client,
	'New buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30_new`
	group by date, client
),

this_month_buyers AS (
	SELECT 
	date,
	client,
	'This month buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30`
	group by date, client
),

this_month_revenue AS (
	SELECT 
	date,
	client,
	'This month revenue' as metric,
	sum(revenue) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30`
	group by date, client
),

this_month_aov AS (
	SELECT 
	date,
	client,
	'This month AOV' as metric,
	case when sum(order_count) > 0 then sum(revenue)/sum(order_count) else 0 end as value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30`
	group by date, client
),

this_month_frequency AS (
	SELECT 
	date,
	client,
	'This month frequency' as metric,
	case when count(distinct customer_id) > 0 then sum(order_count)/count(distinct customer_id) else 0 end as value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30`
	group by date, client
)

SELECT 
date,
client,
metric,
ifnull(value, 0) value
FROM
(
	SELECT
	date,
	client,
	metric,
	value
	FROM last_month_buyers

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM rebuy_rate

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM repeat_buyers

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM reactivated_buyers	

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM new_buyers	

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_month_buyers	

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_month_revenue

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_month_aov

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_month_frequency

	UNION ALL

	SELECT
	a.date,
	a.client,
	'Dormant buyers' as metric,
	a.value - ifnull(b.value, 0) as value
	FROM last_month_buyers a
	LEFT JOIN repeat_buyers b
	ON ( a.date = b.date AND
		a.client = b.client )							

)
2018-04-18 08:45:01,310: Model SQL (growth_stats):
with orders as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'Orders' as metric,
  orders_ty as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`
),

order_growth as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'Order Growth' as metric,
  order_growth as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`
),

revenue as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'Revenue' as metric,
  revenue_ty as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`
),

revenue_growth as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'Revenue Growth' as metric,
  revenue_growth as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`
),

customers as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'Customers' as metric,
  customers_ty as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`
),

customer_growth as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'Customer Growth' as metric,
  customer_growth as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`

),

aov as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'AOV' as metric,
  aov_ty as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`

),

aov_growth as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'AOV Growth' as metric,
  aov_growth as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`

)

SELECT * FROM orders
UNION ALL 
SELECT * FROM order_growth
UNION ALL
SELECT * FROM revenue
UNION ALL 
SELECT * FROM revenue_growth
UNION ALL
SELECT * FROM customers
UNION ALL 
SELECT * FROM customer_growth
UNION ALL
SELECT * FROM aov
UNION ALL 
SELECT * FROM aov_growth
2018-04-18 08:45:02,395: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109524748>]}
2018-04-18 08:45:02,684: 08:45:02 | 88 of 91 OK created table model agency_data_pipeline.growth_stats.... [CREATE TABLE in 1.99s]
2018-04-18 08:45:04,649: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1094fe588>]}
2018-04-18 08:45:04,863: 08:45:04 | 89 of 91 OK created table model agency_data_pipeline.retention_stats_month [CREATE TABLE in 4.24s]
2018-04-18 08:45:07,850: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10718b080>]}
2018-04-18 08:45:08,141: 08:45:08 | 87 of 91 OK created table model agency_data_pipeline.retention_stats. [CREATE TABLE in 7.46s]
2018-04-18 08:45:08,142: 08:45:08 | 90 of 91 START table model agency_data_pipeline.agg_campaign......... [RUN]
2018-04-18 08:45:08,142: Compiling model.agency_data_pipeline.agg_campaign
2018-04-18 08:45:08,153: Writing injected SQL for node "model.agency_data_pipeline.agg_campaign"
2018-04-18 08:45:08,154: Acquiring new bigquery connection "agg_campaign".
2018-04-18 08:45:08,154: Re-using an available connection from the pool.
2018-04-18 08:45:09,067: Model SQL (agg_campaign):
with ga as (

	select 
		date, client, attribution, channel, platform, url, campaign as utm_campaign, '' as campaign,
    	customers_new,
    	transactions_new,
    	revenue_new,
    	first_order_revenue_new,
    	lifetime_revenue_new,
    	customers_total,
    	transactions_total,
    	revenue_total,
		null as cost, null as impressions, null as clicks, null as ad_platform_transactions
	from `growth-engines-pipeline`.`agency_data_pipeline`.`agg_ga_campaign_by_type`

),

platforms_last_touch as (

	select 
		date, client, 'Last-touch' as attribution, channel, platform, url, utm_campaign, campaign,
		null as customers_new,
    	null as transactions_new,
    	null as revenue_new,
    	null as first_order_revenue_new,
    	null as lifetime_revenue_new,
    	null as customers_total,
    	null as transactions_total,
    	null as revenue_total,
		cost, impressions, clicks, ad_platform_transactions
	from `growth-engines-pipeline`.`agency_data_pipeline`.`agg_platforms_client`

),

platforms_first_touch as (

    select 
        date, client, 'First-touch' as attribution, channel, platform, url, utm_campaign, campaign,
        null as customers_new,
        null as transactions_new,
        null as revenue_new,
        null as first_order_revenue_new,
        null as lifetime_revenue_new,
        null as customers_total,
        null as transactions_total,
        null as revenue_total,
        cost, impressions, clicks, ad_platform_transactions
    from `growth-engines-pipeline`.`agency_data_pipeline`.`agg_platforms_client`

)


SELECT
    date, 
    client,
    attribution,
    platform,
    channel, 
    url,
    utm_campaign,
    max(campaign) campaign,
    ifnull( sum(cost), 0) cost,
	ifnull( sum(impressions), 0) impressions,
	ifnull( sum(clicks), 0) clicks,
	ifnull( sum(ad_platform_transactions), 0) ad_platform_transactions,
	ifnull( sum(customers_new), 0) customers_new,
	ifnull( sum(transactions_new), 0) transactions_new,
	ifnull( sum(revenue_new), 0) revenue_new,
	ifnull( sum(first_order_revenue_new), 0) first_order_revenue_new,
	ifnull( sum(lifetime_revenue_new), 0) lifetime_revenue_new,
	ifnull( sum(customers_total), 0) customers_total,
	ifnull( sum(transactions_total), 0) transactions_total,
	ifnull( sum(revenue_total), 0) revenue_total	
FROM 
(
    SELECT *
    FROM 
      ga
    UNION ALL
    SELECT *
    FROM 
      platforms_first_touch
    UNION ALL
    SELECT *
    FROM 
      platforms_last_touch      
) 
GROUP BY
    date, client, attribution, platform, channel, url, utm_campaign
2018-04-18 08:45:16,764: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104538b70>]}
2018-04-18 08:45:16,994: 08:45:16 | 90 of 91 OK created table model agency_data_pipeline.agg_campaign.... [CREATE TABLE in 8.62s]
2018-04-18 08:45:16,995: 08:45:16 | 91 of 91 START table model agency_data_pipeline.agg_platform_monthly. [RUN]
2018-04-18 08:45:16,995: Compiling model.agency_data_pipeline.agg_platform_monthly
2018-04-18 08:45:17,004: Writing injected SQL for node "model.agency_data_pipeline.agg_platform_monthly"
2018-04-18 08:45:17,007: Acquiring new bigquery connection "agg_platform_monthly".
2018-04-18 08:45:17,008: Re-using an available connection from the pool.
2018-04-18 08:45:17,895: Model SQL (agg_platform_monthly):
SELECT
    FORMAT_DATE("%Y-%m", date) AS yyyymm,
    client,
    attribution,
    platform,
    channel, 
    sum(cost) cost,
	sum(clicks) clicks,
	sum(customers_new) customers_new,
	sum(first_order_revenue_new) first_order_revenue_new,
	sum(lifetime_revenue_new) lifetime_revenue_new,
	sum(transactions_new) transactions_new,
	sum(revenue_new) revenue_new,
    sum(customers_total) customers_total,
    sum(transactions_total) transactions_total,
    sum(revenue_total) revenue_total
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_campaign`
GROUP BY
    yyyymm, client, attribution, platform, channel
2018-04-18 08:45:19,042: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '354c7ba0-79c2-4154-9c7c-04e953688293', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10718b080>]}
2018-04-18 08:45:19,343: 08:45:19 | 91 of 91 OK created table model agency_data_pipeline.agg_platform_monthly [CREATE TABLE in 2.05s]
2018-04-18 08:45:19,411: 08:45:19 | 
2018-04-18 08:45:19,412: 08:45:19 | Finished running 91 table models in 353.82s.
2018-04-18 08:45:19,412: Connection 'master' was left open.
2018-04-18 08:45:19,413: 
2018-04-18 08:45:19,413: Completed with 2 errors:
2018-04-18 08:45:19,414: 
2018-04-18 08:45:19,414: Database Error in model segment_proc_sku (models/segmentation/products/segment_proc_sku.sql)
2018-04-18 08:45:19,414:   Unrecognized name: avg_daily_revenue_40pct; Did you mean avg_daily_revenue_30pct? at [14:83]
2018-04-18 08:45:19,414:   compiled SQL at target/compiled/agency_data_pipeline/segmentation/products/segment_proc_sku.sql
2018-04-18 08:45:19,414: 
2018-04-18 08:45:19,415: Database Error in model segment_proc_customers_products (models/segmentation/customers-products/segment_proc_customers_products.sql)
2018-04-18 08:45:19,415:   Unrecognized name: aov_40pct; Did you mean aov_50pct? at [15:62]
2018-04-18 08:45:19,415:   compiled SQL at target/compiled/agency_data_pipeline/segmentation/customers-products/segment_proc_customers_products.sql
2018-04-18 08:45:19,415: 
Done. PASS=84 ERROR=2 SKIP=5 TOTAL=91
2018-04-18 08:45:19,416: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1070be710>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107087a90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107087cc0>]}
2018-04-18 08:45:19,703: Flushing usage events
2018-04-18 08:49:46,948: Tracking: tracking
2018-04-18 08:49:46,951: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106c27cc0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106c27eb8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106c27f60>]}
2018-04-18 08:49:47,638: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-04-18 08:49:47,662: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/growth-engines/dbt_modules
2018-04-18 08:49:47,668: Parsing get_column_values.sql
2018-04-18 08:49:47,689: Parsing get_url_parameter.sql
2018-04-18 08:49:47,695: Parsing split_part.sql
2018-04-18 08:49:47,703: Parsing table_exists.sql
2018-04-18 08:49:47,713: Parsing core.sql
2018-04-18 08:49:47,727: Parsing adapters/bigquery.sql
2018-04-18 08:49:47,735: Parsing adapters/common.sql
2018-04-18 08:49:47,757: Parsing adapters/postgres.sql
2018-04-18 08:49:47,763: Parsing adapters/redshift.sql
2018-04-18 08:49:47,791: Parsing etc/get_custom_schema.sql
2018-04-18 08:49:47,803: Parsing materializations/archive.sql
2018-04-18 08:49:47,841: Parsing materializations/bigquery.sql
2018-04-18 08:49:47,862: Parsing materializations/helpers.sql
2018-04-18 08:49:47,880: Parsing materializations/incremental.sql
2018-04-18 08:49:47,927: Parsing materializations/table.sql
2018-04-18 08:49:47,947: Parsing materializations/view.sql
2018-04-18 08:49:47,974: Parsing materializations/wrapper.sql
2018-04-18 08:49:47,982: Parsing schema_tests/accepted_values.sql
2018-04-18 08:49:47,987: Parsing schema_tests/not_null.sql
2018-04-18 08:49:47,992: Parsing schema_tests/relationships.sql
2018-04-18 08:49:47,998: Parsing schema_tests/unique.sql
2018-04-18 08:49:48,068: Parsing model.agency_data_pipeline.accounts_proc
2018-04-18 08:49:48,070: Parsing model.agency_data_pipeline.all_dates
2018-04-18 08:49:48,071: Parsing model.agency_data_pipeline.carts_proc
2018-04-18 08:49:48,072: Parsing model.agency_data_pipeline.clients_proc
2018-04-18 08:49:48,075: Parsing model.agency_data_pipeline.conversion_goals_proc
2018-04-18 08:49:48,077: Parsing model.agency_data_pipeline.mappings_ga_proc
2018-04-18 08:49:48,078: Acquiring new bigquery connection "master".
2018-04-18 08:49:48,079: Opening a new connection (0 currently allocated)
2018-04-18 08:49:48,085: Parsing model.agency_data_pipeline.monthend_dates
2018-04-18 08:49:48,089: Parsing model.agency_data_pipeline.adwords_ads
2018-04-18 08:49:48,092: Parsing model.agency_data_pipeline.adwords_campaigns
2018-04-18 08:49:48,095: Parsing model.agency_data_pipeline.adwords_conversions
2018-04-18 08:49:48,097: Parsing model.agency_data_pipeline.adwords_impression_share
2018-04-18 08:49:48,099: Parsing model.agency_data_pipeline.adwords_join
2018-04-18 08:49:48,101: Parsing model.agency_data_pipeline.adwords_stats
2018-04-18 08:49:48,103: Parsing model.agency_data_pipeline.adwords_urls
2018-04-18 08:49:48,105: Parsing model.agency_data_pipeline.bing_ads_ads
2018-04-18 08:49:48,107: Parsing model.agency_data_pipeline.bing_ads_conversions
2018-04-18 08:49:48,109: Parsing model.agency_data_pipeline.bing_ads_impression_share
2018-04-18 08:49:48,111: Parsing model.agency_data_pipeline.bing_ads_stats
2018-04-18 08:49:48,113: Parsing model.agency_data_pipeline.fb_adcreative
2018-04-18 08:49:48,118: Parsing model.agency_data_pipeline.fb_ads
2018-04-18 08:49:48,124: Parsing model.agency_data_pipeline.fb_ads_insights
2018-04-18 08:49:48,128: Parsing model.agency_data_pipeline.fb_ads_insights_conversions
2018-04-18 08:49:48,134: Parsing model.agency_data_pipeline.fb_ads_stats
2018-04-18 08:49:48,136: Parsing model.agency_data_pipeline.ga_conversions
2018-04-18 08:49:48,137: Parsing model.agency_data_pipeline.ga_traffic
2018-04-18 08:49:48,154: Parsing model.agency_data_pipeline.ga_transactions
2018-04-18 08:49:48,164: Parsing model.agency_data_pipeline.ga_mcf_proc
2018-04-18 08:49:48,166: Parsing model.agency_data_pipeline.ga_mcf_stats
2018-04-18 08:49:48,169: Parsing model.agency_data_pipeline.shopify_customers_proc
2018-04-18 08:49:48,174: Parsing model.agency_data_pipeline.shopify_orders_proc
2018-04-18 08:49:48,183: Parsing model.agency_data_pipeline.shopify_products_proc
2018-04-18 08:49:48,189: Parsing model.agency_data_pipeline.shopify_refunds_proc
2018-04-18 08:49:48,194: Parsing model.agency_data_pipeline.agg_campaign
2018-04-18 08:49:48,197: Parsing model.agency_data_pipeline.agg_customers_union
2018-04-18 08:49:48,198: Parsing model.agency_data_pipeline.agg_ga_campaign
2018-04-18 08:49:48,201: Parsing model.agency_data_pipeline.agg_ga_campaign_by_type
2018-04-18 08:49:48,204: Parsing model.agency_data_pipeline.agg_ga_transaction
2018-04-18 08:49:48,206: Parsing model.agency_data_pipeline.agg_ga_transaction_order_number
2018-04-18 08:49:48,209: Parsing model.agency_data_pipeline.agg_orders_union
2018-04-18 08:49:48,211: Parsing model.agency_data_pipeline.agg_platform_monthly
2018-04-18 08:49:48,213: Parsing model.agency_data_pipeline.agg_platforms_client
2018-04-18 08:49:48,215: Parsing model.agency_data_pipeline.agg_platforms_union
2018-04-18 08:49:48,217: Parsing model.agency_data_pipeline.agg_products
2018-04-18 08:49:48,219: Parsing model.agency_data_pipeline.agg_transaction
2018-04-18 08:49:48,221: Parsing model.agency_data_pipeline.agg_transaction_daily
2018-04-18 08:49:48,222: Parsing model.agency_data_pipeline.agg_transaction_line_item
2018-04-18 08:49:48,224: Parsing model.agency_data_pipeline.agg_transaction_line_item_type
2018-04-18 08:49:48,226: Parsing model.agency_data_pipeline.agg_transaction_order_number
2018-04-18 08:49:48,228: Parsing model.agency_data_pipeline.agg_transaction_product_type
2018-04-18 08:49:48,229: Parsing model.agency_data_pipeline.customers_by_transaction
2018-04-18 08:49:48,231: Parsing model.agency_data_pipeline.growth_customer_0_365
2018-04-18 08:49:48,233: Parsing model.agency_data_pipeline.growth_customer_0_365_segment
2018-04-18 08:49:48,236: Parsing model.agency_data_pipeline.growth_date_union
2018-04-18 08:49:48,238: Parsing model.agency_data_pipeline.growth_stats
2018-04-18 08:49:48,243: Parsing model.agency_data_pipeline.retention_0_365
2018-04-18 08:49:48,245: Parsing model.agency_data_pipeline.retention_0_365_new
2018-04-18 08:49:48,247: Parsing model.agency_data_pipeline.retention_0_365_reactivated
2018-04-18 08:49:48,249: Parsing model.agency_data_pipeline.retention_0_365_rebuy
2018-04-18 08:49:48,251: Parsing model.agency_data_pipeline.retention_365_730
2018-04-18 08:49:48,253: Parsing model.agency_data_pipeline.retention_730_plus
2018-04-18 08:49:48,255: Parsing model.agency_data_pipeline.retention_stats
2018-04-18 08:49:48,260: Parsing model.agency_data_pipeline.retention_stats_rebuy_rate
2018-04-18 08:49:48,263: Parsing model.agency_data_pipeline.retention_0_30
2018-04-18 08:49:48,265: Parsing model.agency_data_pipeline.retention_0_30_new
2018-04-18 08:49:48,267: Parsing model.agency_data_pipeline.retention_0_30_reactivated
2018-04-18 08:49:48,269: Parsing model.agency_data_pipeline.retention_0_30_rebuy
2018-04-18 08:49:48,271: Parsing model.agency_data_pipeline.retention_30_60
2018-04-18 08:49:48,273: Parsing model.agency_data_pipeline.retention_60_plus
2018-04-18 08:49:48,276: Parsing model.agency_data_pipeline.retention_stats_month
2018-04-18 08:49:48,281: Parsing model.agency_data_pipeline.retention_stats_rebuy_rate_month
2018-04-18 08:49:48,284: Parsing model.agency_data_pipeline.customers_first_purchase_proc
2018-04-18 08:49:48,286: Parsing model.agency_data_pipeline.customers_proc
2018-04-18 08:49:48,288: Parsing model.agency_data_pipeline.segment_list_customers
2018-04-18 08:49:48,290: Parsing model.agency_data_pipeline.segment_proc_customers
2018-04-18 08:49:48,292: Parsing model.agency_data_pipeline.segment_stats_customers
2018-04-18 08:49:48,294: Parsing model.agency_data_pipeline.segment_stats_customers_agg
2018-04-18 08:49:48,297: Parsing model.agency_data_pipeline.customers_first_purchase_product_type_proc
2018-04-18 08:49:48,298: Parsing model.agency_data_pipeline.customers_products_proc
2018-04-18 08:49:48,301: Parsing model.agency_data_pipeline.segment_list_customers_products
2018-04-18 08:49:48,303: Parsing model.agency_data_pipeline.segment_proc_customers_products
2018-04-18 08:49:48,305: Parsing model.agency_data_pipeline.segment_stats_customers_products
2018-04-18 08:49:48,308: Parsing model.agency_data_pipeline.segment_stats_customers_products_agg
2018-04-18 08:49:48,311: Parsing model.agency_data_pipeline.frequency_proc
2018-04-18 08:49:48,313: Parsing model.agency_data_pipeline.frequency_stats
2018-04-18 08:49:48,315: Parsing model.agency_data_pipeline.order_paths_agg
2018-04-18 08:49:48,316: Parsing model.agency_data_pipeline.order_paths_proc
2018-04-18 08:49:48,318: Parsing model.agency_data_pipeline.order_paths_stats
2018-04-18 08:49:48,321: Parsing model.agency_data_pipeline.products_proc
2018-04-18 08:49:48,325: Parsing model.agency_data_pipeline.segment_proc_sku
2018-04-18 08:49:48,327: Parsing model.agency_data_pipeline.segment_stats_category
2018-04-18 08:49:48,329: Parsing model.agency_data_pipeline.segment_stats_sku
2018-04-18 08:49:48,362: Found 91 models, 0 tests, 0 archives, 0 analyses, 46 macros, 0 operations
2018-04-18 08:49:48,434: 
2018-04-18 08:49:49,708: 08:49:49 | Concurrency: 4 threads (target='prod')
2018-04-18 08:49:49,708: 08:49:49 | 
2018-04-18 08:49:50,345: 08:49:50 | 1 of 91 START table model agency_data_pipeline.carts_proc............ [RUN]
2018-04-18 08:49:50,345: 08:49:50 | 2 of 91 START table model agency_data_pipeline.adwords_campaigns..... [RUN]
2018-04-18 08:49:50,346: 08:49:50 | 3 of 91 START table model agency_data_pipeline.bing_ads_ads.......... [RUN]
2018-04-18 08:49:50,346: 08:49:50 | 4 of 91 START table model agency_data_pipeline.conversion_goals_proc. [RUN]
2018-04-18 08:49:50,346: Compiling model.agency_data_pipeline.carts_proc
2018-04-18 08:49:50,346: Compiling model.agency_data_pipeline.adwords_campaigns
2018-04-18 08:49:50,347: Compiling model.agency_data_pipeline.bing_ads_ads
2018-04-18 08:49:50,347: Compiling model.agency_data_pipeline.conversion_goals_proc
2018-04-18 08:49:50,352: Writing injected SQL for node "model.agency_data_pipeline.carts_proc"
2018-04-18 08:49:50,357: Writing injected SQL for node "model.agency_data_pipeline.adwords_campaigns"
2018-04-18 08:49:50,362: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_ads"
2018-04-18 08:49:50,366: Writing injected SQL for node "model.agency_data_pipeline.conversion_goals_proc"
2018-04-18 08:49:50,369: Acquiring new bigquery connection "carts_proc".
2018-04-18 08:49:50,370: Opening a new connection (1 currently allocated)
2018-04-18 08:49:50,371: Acquiring new bigquery connection "adwords_campaigns".
2018-04-18 08:49:50,372: Acquiring new bigquery connection "bing_ads_ads".
2018-04-18 08:49:50,374: Acquiring new bigquery connection "conversion_goals_proc".
2018-04-18 08:49:50,374: Opening a new connection (2 currently allocated)
2018-04-18 08:49:50,427: Opening a new connection (3 currently allocated)
2018-04-18 08:49:50,482: Opening a new connection (4 currently allocated)
2018-04-18 08:49:51,900: Model SQL (bing_ads_ads):
select
date, 
account, 
channel,
platform,
campaignid,
campaignname,
max(lower(trim(replace(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$','' ),'.html',''),'/'))) as url,
utm_campaign,
sum(cost) as cost,
sum(impressions) as impressions,
sum(clicks) as clicks,
sum(conversions) as conversions
from 
  ( 
SELECT  
cast(gregoriandate as date) date,
replace(accountname,',','') account,
'Paid' as channel,
'Bing Ads' as platform,
adid,
adtype,
campaignid, 
campaignname,
finalurl url,
case when regexp_contains(destinationurl, 'utm_campaign')
	then replace(lower(nullif(
  

    split(
        
  

    split(
        destinationurl,
        'utm_campaign='
        )[offset(1)]


,
        '&'
        )[offset(0)]


,'')),'+',' ') 
	else null end as utm_campaign,
spend cost, 
impressions, 
clicks, 
conversions,
_sdc_sequence,
first_value(_sdc_sequence) OVER (PARTITION BY adid, gregoriandate ORDER BY _sdc_sequence DESC) lv
FROM `growth-engines-pipeline.bing_ads.ad_performance_report` 
  )

where lv = _sdc_sequence
group by date, account, channel, platform, campaignid, campaignname, utm_campaign
2018-04-18 08:49:51,901: Model SQL (adwords_campaigns):
select
day,
campaignid, 
campaign,
account, 
channel,
platform,
sum(cost) cost,
sum(impressions) impressions,
sum(clicks) clicks,
sum(impression_share_num) impression_share_num,
sum(impression_share_den) impression_share_den
from 
  ( 
	SELECT  
	day,
	campaignid,
	campaign,
	account as account,
	'Paid' as channel,
	'Adwords' as platform,
	cost/1000000 cost, 
	impressions as impressions, 
	clicks, 
	case when searchimprshare is not null then impressions end as impression_share_num,
	case when searchimprshare is not null then impressions/(searchimprshare/100) end as impression_share_den,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY campaignid, day ORDER BY _sdc_sequence DESC) lv
	FROM `growth-engines-pipeline.adwords_2.CAMPAIGN_PERFORMANCE_REPORT`
  )
where lv = _sdc_sequence
group by day, campaignid, account, channel, platform, campaign
2018-04-18 08:49:51,917: Model SQL (conversion_goals_proc):
select 
client,
platform,
goal_name,
max(goal_type) goal_type,
account,
max(time_of_entry) time_of_entry
from  ( 

SELECT  
client,
platform,
trim(replace(replace(lower(goal_name),',',''),' ','')) goal_name,
goal_type,
account,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY platform ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.conversion_goals` 

) 

WHERE lv = time_of_entry
group by client, platform, account, goal_name
2018-04-18 08:49:51,925: Model SQL (carts_proc):
select 
client,
client_name,
account,
platform
from  ( 

SELECT  
client,
client_name,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.accounts`
WHERE platform in ('Shopify', 'Custom cart')

) 

WHERE lv = time_of_entry
2018-04-18 08:49:54,135: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106df36a0>]}
2018-04-18 08:49:54,181: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106df33c8>]}
2018-04-18 08:49:54,435: 08:49:54 | 4 of 91 OK created table model agency_data_pipeline.conversion_goals_proc [CREATE TABLE in 3.79s]
2018-04-18 08:49:54,436: 08:49:54 | 5 of 91 START table model agency_data_pipeline.clients_proc.......... [RUN]
2018-04-18 08:49:54,436: Compiling model.agency_data_pipeline.clients_proc
2018-04-18 08:49:54,442: Writing injected SQL for node "model.agency_data_pipeline.clients_proc"
2018-04-18 08:49:54,445: Acquiring new bigquery connection "clients_proc".
2018-04-18 08:49:54,446: Re-using an available connection from the pool.
2018-04-18 08:49:54,731: 08:49:54 | 1 of 91 OK created table model agency_data_pipeline.carts_proc....... [CREATE TABLE in 3.83s]
2018-04-18 08:49:54,731: 08:49:54 | 6 of 91 START table model agency_data_pipeline.accounts_proc......... [RUN]
2018-04-18 08:49:54,732: Compiling model.agency_data_pipeline.accounts_proc
2018-04-18 08:49:54,740: Writing injected SQL for node "model.agency_data_pipeline.accounts_proc"
2018-04-18 08:49:54,742: Acquiring new bigquery connection "accounts_proc".
2018-04-18 08:49:54,742: Re-using an available connection from the pool.
2018-04-18 08:49:55,188: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1091cd4e0>]}
2018-04-18 08:49:55,196: Model SQL (clients_proc):
select 
client,
client_name,
account,
platform
from  ( 

SELECT  
client,
client_name,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.accounts`
where client_name != ''
) 

WHERE lv = time_of_entry
2018-04-18 08:49:55,479: 08:49:55 | 3 of 91 OK created table model agency_data_pipeline.bing_ads_ads..... [CREATE TABLE in 4.84s]
2018-04-18 08:49:55,481: 08:49:55 | 7 of 91 START table model agency_data_pipeline.all_dates............. [RUN]
2018-04-18 08:49:55,481: Compiling model.agency_data_pipeline.all_dates
2018-04-18 08:49:55,489: Writing injected SQL for node "model.agency_data_pipeline.all_dates"
2018-04-18 08:49:55,490: Model SQL (accounts_proc):
select 
client,
account,
platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.accounts` 

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-04-18 08:49:55,490: Acquiring new bigquery connection "all_dates".
2018-04-18 08:49:55,491: Re-using an available connection from the pool.
2018-04-18 08:49:56,146: Model SQL (all_dates):
SELECT 
date_in_range,
unix_date(date_in_range) unix_date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-04-18 08:49:56,339: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106d83b38>]}
2018-04-18 08:49:56,674: 08:49:56 | 5 of 91 OK created table model agency_data_pipeline.clients_proc..... [CREATE TABLE in 1.90s]
2018-04-18 08:49:56,675: 08:49:56 | 8 of 91 START table model agency_data_pipeline.monthend_dates........ [RUN]
2018-04-18 08:49:56,675: Compiling model.agency_data_pipeline.monthend_dates
2018-04-18 08:49:56,683: Writing injected SQL for node "model.agency_data_pipeline.monthend_dates"
2018-04-18 08:49:56,684: Acquiring new bigquery connection "monthend_dates".
2018-04-18 08:49:56,684: Re-using an available connection from the pool.
2018-04-18 08:49:57,312: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106dfd630>]}
2018-04-18 08:49:57,368: Model SQL (monthend_dates):
SELECT
date_in_range,
date_in_range_bom,
date_in_range_bom_mom,
unix_date_in_range,
unix_date_in_range_bom,
unix_date(date_in_range_bom_mom) unix_date_in_range_bom_mom,
yyyymm,
date_in_range_yoy,
unix_date(date_in_range_yoy) unix_date_in_range_yoy

FROM
(
	SELECT 
	date_in_range,
	date_in_range_bom,
	date_sub(date_in_range_bom, INTERVAL 1 MONTH) date_in_range_bom_mom,
  date_sub(date_in_range, INTERVAL 1 YEAR) date_in_range_yoy,
	unix_date_in_range,
	unix_date(date_in_range_bom) unix_date_in_range_bom,
	yyyymm,
	first_value(date_in_range) over (partition by yyyymm order by date_in_range desc) monthend_date_in_range
	FROM
	( 
		SELECT 
		date_in_range,
		date_trunc( date_in_range, MONTH) date_in_range_bom,
		unix_date(date_in_range) unix_date_in_range,
		format_date("%Y-%m", date_in_range) AS yyyymm
		FROM UNNEST(
		    GENERATE_DATE_ARRAY(DATE('2016-01-31'), CURRENT_DATE(), INTERVAL 1 DAY)
		) AS date_in_range
	)
)
where date_in_range = monthend_date_in_range
2018-04-18 08:49:57,403: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106df32e8>]}
2018-04-18 08:49:57,615: 08:49:57 | 7 of 91 OK created table model agency_data_pipeline.all_dates........ [CREATE TABLE in 1.83s]
2018-04-18 08:49:57,616: 08:49:57 | 9 of 91 START table model agency_data_pipeline.bing_ads_impression_share [RUN]
2018-04-18 08:49:57,617: Compiling model.agency_data_pipeline.bing_ads_impression_share
2018-04-18 08:49:57,626: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_impression_share"
2018-04-18 08:49:57,629: Acquiring new bigquery connection "bing_ads_impression_share".
2018-04-18 08:49:57,629: Re-using an available connection from the pool.
2018-04-18 08:49:57,657: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10878f6d8>]}
2018-04-18 08:49:57,842: 08:49:57 | 2 of 91 OK created table model agency_data_pipeline.adwords_campaigns [CREATE TABLE in 7.06s]
2018-04-18 08:49:57,843: 08:49:57 | 10 of 91 START table model agency_data_pipeline.adwords_conversions.. [RUN]
2018-04-18 08:49:57,845: Compiling model.agency_data_pipeline.adwords_conversions
2018-04-18 08:49:57,850: Writing injected SQL for node "model.agency_data_pipeline.adwords_conversions"
2018-04-18 08:49:57,852: Acquiring new bigquery connection "adwords_conversions".
2018-04-18 08:49:57,852: Re-using an available connection from the pool.
2018-04-18 08:49:58,146: 08:49:58 | 6 of 91 OK created table model agency_data_pipeline.accounts_proc.... [CREATE TABLE in 2.93s]
2018-04-18 08:49:58,146: 08:49:58 | 11 of 91 START table model agency_data_pipeline.adwords_urls......... [RUN]
2018-04-18 08:49:58,147: Compiling model.agency_data_pipeline.adwords_urls
2018-04-18 08:49:58,155: Writing injected SQL for node "model.agency_data_pipeline.adwords_urls"
2018-04-18 08:49:58,156: Acquiring new bigquery connection "adwords_urls".
2018-04-18 08:49:58,156: Re-using an available connection from the pool.
2018-04-18 08:49:58,313: Model SQL (bing_ads_impression_share):
SELECT 
date, 
account,
channel,
platform,
sum(impressions) impressions,
sum(available_impressions) available_impressions
FROM

(

SELECT  
cast(gregoriandate as date) date,
replace(accountname,',','') account,  
'Paid' as channel,
'Bing Ads' as platform,
case when impressionsharepercent is null then 0 else impressions end as impressions,
cast(round(case when ( impressionsharepercent is not null and impressionsharepercent > 0 ) then (impressions*100)/impressionsharepercent else 0 end) as int64) as available_impressions,
_sdc_sequence,
first_value(_sdc_sequence) OVER (PARTITION BY campaignid, gregoriandate ORDER BY _sdc_sequence DESC) lv
FROM `growth-engines-pipeline.bing_ads.campaign_performance_report` 

)

where lv = _sdc_sequence
group by date, account, channel, platform
2018-04-18 08:49:58,600: Model SQL (adwords_conversions):
select 
client,
client_name,
platform,
goal_name,
goal_type,
account,
time_of_entry
from  ( 

SELECT  
client,
client_name,
platform,
trim(lower(goal_name)) goal_name,
goal_type,
account,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform, goal_name ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.conversion_goals` 
WHERE platform = 'Adwords'

) 

WHERE lv = time_of_entry
2018-04-18 08:49:58,789: Model SQL (adwords_urls):
SELECT
campaignid,
lower(trim(regexp_replace(replace(replace(replace(replace(finalurl,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url

FROM (

SELECT  
campaignid,
finalurl,
first_value(finalurl) OVER (PARTITION BY campaignid ORDER BY day DESC) lv
FROM `growth-engines-pipeline.adwords_2.FINAL_URL_REPORT`
)

WHERE lv = finalurl
group by campaignid, url
order by campaignid asc
2018-04-18 08:50:00,539: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1091cb0b8>]}
2018-04-18 08:50:00,676: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106d83b38>]}
2018-04-18 08:50:00,761: 08:50:00 | 9 of 91 OK created table model agency_data_pipeline.bing_ads_impression_share [CREATE TABLE in 2.92s]
2018-04-18 08:50:00,762: 08:50:00 | 12 of 91 START table model agency_data_pipeline.ga_conversions....... [RUN]
2018-04-18 08:50:00,762: Compiling model.agency_data_pipeline.ga_conversions
2018-04-18 08:50:00,770: Writing injected SQL for node "model.agency_data_pipeline.ga_conversions"
2018-04-18 08:50:00,775: Acquiring new bigquery connection "ga_conversions".
2018-04-18 08:50:00,775: Re-using an available connection from the pool.
2018-04-18 08:50:00,827: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106db2588>]}
2018-04-18 08:50:01,065: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10878f6d8>]}
2018-04-18 08:50:01,067: 08:50:01 | 8 of 91 OK created table model agency_data_pipeline.monthend_dates... [CREATE TABLE in 4.00s]
2018-04-18 08:50:01,301: 08:50:01 | 10 of 91 OK created table model agency_data_pipeline.adwords_conversions [CREATE TABLE in 2.98s]
2018-04-18 08:50:01,589: 08:50:01 | 11 of 91 OK created table model agency_data_pipeline.adwords_urls.... [CREATE TABLE in 2.92s]
2018-04-18 08:50:01,594: Model SQL (ga_conversions):
select 
client,
client_name,
platform,
goal_name,
goal_type,
account,
time_of_entry
from  ( 

SELECT  
client,
client_name,
platform,
trim(goal_name) goal_name,
goal_type,
account,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform, goal_name ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.conversion_goals` 
WHERE platform = 'Google Analytics'

) 

WHERE lv = time_of_entry
2018-04-18 08:50:02,682: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1091ab390>]}
2018-04-18 08:50:02,977: 08:50:02 | 12 of 91 OK created table model agency_data_pipeline.ga_conversions.. [CREATE TABLE in 1.92s]
2018-04-18 08:50:02,978: 08:50:02 | 13 of 91 START table model agency_data_pipeline.ga_mcf_proc.......... [RUN]
2018-04-18 08:50:02,978: Compiling model.agency_data_pipeline.ga_mcf_proc
2018-04-18 08:50:02,984: 08:50:02 | 14 of 91 START table model agency_data_pipeline.fb_ads_insights...... [RUN]
2018-04-18 08:50:02,989: Writing injected SQL for node "model.agency_data_pipeline.ga_mcf_proc"
2018-04-18 08:50:02,984: 08:50:02 | 15 of 91 START table model agency_data_pipeline.fb_ads_insights_conversions [RUN]
2018-04-18 08:50:02,989: 08:50:02 | 16 of 91 START table model agency_data_pipeline.mappings_ga_proc..... [RUN]
2018-04-18 08:50:02,990: Compiling model.agency_data_pipeline.fb_ads_insights
2018-04-18 08:50:02,990: Compiling model.agency_data_pipeline.fb_ads_insights_conversions
2018-04-18 08:50:02,991: Compiling model.agency_data_pipeline.mappings_ga_proc
2018-04-18 08:50:03,002: Acquiring new bigquery connection "fb_ads_insights".
2018-04-18 08:50:03,025: Re-using an available connection from the pool.
2018-04-18 08:50:03,025: Fetching data for query fb_ads_insights:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 08:50:03,004: Acquiring new bigquery connection "ga_mcf_proc".
2018-04-18 08:50:03,029: Re-using an available connection from the pool.
2018-04-18 08:50:03,040: Writing injected SQL for node "model.agency_data_pipeline.mappings_ga_proc"
2018-04-18 08:50:03,045: Acquiring new bigquery connection "fb_ads_insights_conversions".
2018-04-18 08:50:03,049: Re-using an available connection from the pool.
2018-04-18 08:50:03,050: Acquiring new bigquery connection "mappings_ga_proc".
2018-04-18 08:50:03,050: Fetching data for query fb_ads_insights_conversions:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 08:50:03,052: Re-using an available connection from the pool.
2018-04-18 08:50:04,186: Model SQL (mappings_ga_proc):
select 
client,
account,
client_name,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
account,
client_name,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.mappings_ga` 

) 

WHERE lv = time_of_entry
and client in (select client from `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc` )
group by client, account, client_name, source, medium, platform_n, channel_n, time_of_entry
2018-04-18 08:50:04,232: Model SQL (ga_mcf_proc):
SELECT 
date,
account,
'Google Analytics' as lookup_platform,
source_medium_path,
trim(lower(split(split(source_medium_path,'->')[SAFE_ORDINAL(1)],'/')[SAFE_ORDINAL(1)])) as source,
trim(lower(split(split(source_medium_path,'->')[SAFE_ORDINAL(1)],'/')[SAFE_ORDINAL(2)])) as medium,
first_interaction_campaign campaign,
cast(regexp_replace(transaction_id, r'#', '') as int64) transactionid,
max(first_interaction_conversions) transactions,
max(first_interaction_conversion_value) revenue
FROM `growth-engines-pipeline.agency_data_pipeline.ga_mcf`
where account in (select account from `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc` where platform = 'Google Analytics')
group by date, account, source, medium, campaign, source_medium_path, lookup_platform, transactionid
2018-04-18 08:50:04,281: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_insights_conversions"
2018-04-18 08:50:04,508: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_insights"
2018-04-18 08:50:04,983: Model SQL (fb_ads_insights_conversions):




with fb_ads_insights_conversions as (

	    
		   	SELECT 
			date_start,
			campaign_id,
			campaign_name,
			ad_id,
			account_name,
			spend,
			reach,
			inline_link_clicks,
			_sdc_sequence,
			action_type,
			value
			FROM `growth-engines-pipeline.fb_ads_luca_danni.ads_insights`
			cross join unnest(actions)
		    
	   

)

SELECT * 
FROM 
	(
    SELECT
    date_start date,
    campaign_id,
    campaign_name campaign,
    ad_id,
    account_name account,
    action_type,
    value conversions,
    first_value(_sdc_sequence) OVER (PARTITION BY ad_id, date_start ORDER BY _sdc_sequence DESC) lv,
    _sdc_sequence
    FROM fb_ads_insights_conversions
   	)
where lv = _sdc_sequence
and action_type like '%purchase%'


2018-04-18 08:50:05,274: Model SQL (fb_ads_insights):




with fb_ads_insights as (

	    
		   	SELECT 
			date_start,
			campaign_id,
			campaign_name,
			ad_id,
			account_name,
			spend,
			reach,
			inline_link_clicks,
			_sdc_sequence,
			first_value(_sdc_sequence) OVER (PARTITION BY date_start, ad_id, campaign_id ORDER BY _sdc_sequence DESC) lv
			FROM `growth-engines-pipeline.fb_ads_luca_danni.ads_insights`
		    
	   

)

select
date_start date,
campaign_id,
campaign_name campaign,
ad_id,
account_name account,
max(spend) cost,
max(reach) impressions,
max(inline_link_clicks) clicks
from fb_ads_insights
where lv = _sdc_sequence
group by date, campaign_id, ad_id, account, campaign


2018-04-18 08:50:06,373: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x103853710>]}
2018-04-18 08:50:06,808: 08:50:06 | 16 of 91 OK created table model agency_data_pipeline.mappings_ga_proc [CREATE TABLE in 3.38s]
2018-04-18 08:50:06,809: 08:50:06 | 17 of 91 START table model agency_data_pipeline.fb_adcreative........ [RUN]
2018-04-18 08:50:06,809: Compiling model.agency_data_pipeline.fb_adcreative
2018-04-18 08:50:06,820: Acquiring new bigquery connection "fb_adcreative".
2018-04-18 08:50:06,820: Re-using an available connection from the pool.
2018-04-18 08:50:06,820: Fetching data for query fb_adcreative:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 08:50:07,223: Writing injected SQL for node "model.agency_data_pipeline.fb_adcreative"
2018-04-18 08:50:07,989: Model SQL (fb_adcreative):




with fb_adcreative as (


	    
		   	SELECT 
			id,
			object_url,
			url_tags,
			_sdc_sequence
			FROM `growth-engines-pipeline.fb_ads_luca_danni.adcreative`
		    
	   
)

select creative_id, max(url) url
from (
  select
  id creative_id,
  lower(trim(regexp_replace(replace(replace(replace(replace(object_url,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
  first_value(_sdc_sequence) OVER (PARTITION BY id ORDER BY _sdc_sequence DESC) lv,
  _sdc_sequence
  from fb_adcreative
  )
where lv = _sdc_sequence
group by creative_id


2018-04-18 08:50:08,587: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109202198>]}
2018-04-18 08:50:08,791: 08:50:08 | 14 of 91 OK created table model agency_data_pipeline.fb_ads_insights. [CREATE TABLE in 5.60s]
2018-04-18 08:50:08,791: 08:50:08 | 18 of 91 START table model agency_data_pipeline.adwords_ads.......... [RUN]
2018-04-18 08:50:08,792: Compiling model.agency_data_pipeline.adwords_ads
2018-04-18 08:50:08,801: Writing injected SQL for node "model.agency_data_pipeline.adwords_ads"
2018-04-18 08:50:08,802: Acquiring new bigquery connection "adwords_ads".
2018-04-18 08:50:08,802: Re-using an available connection from the pool.
2018-04-18 08:50:09,430: Model SQL (adwords_ads):
SELECT  
day,
campaignid,
a.account as account,
utm_campaign,
sum( case when b.goal_type = 'Transaction' then conversions else 0 end ) as transactions
FROM (

	SELECT  
	day,
	adid,
	campaignid,
	account,
	lower(conversionname) conversionname,
	conversions,
	lower(campaign) utm_campaign,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY campaignid, day ORDER BY _sdc_sequence DESC) lv
	FROM
	`growth-engines-pipeline.adwords_2.AD_PERFORMANCE_REPORT`

) a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_conversions` b
ON ( a.conversionname = b.goal_name
	AND a.account = b.account )
WHERE lv = _sdc_sequence
group by day, campaignid, account, utm_campaign
2018-04-18 08:50:09,472: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106d05ef0>]}
2018-04-18 08:50:09,764: 08:50:09 | 15 of 91 OK created table model agency_data_pipeline.fb_ads_insights_conversions [CREATE TABLE in 6.48s]
2018-04-18 08:50:09,764: 08:50:09 | 19 of 91 START table model agency_data_pipeline.shopify_refunds_proc. [RUN]
2018-04-18 08:50:09,766: Compiling model.agency_data_pipeline.shopify_refunds_proc
2018-04-18 08:50:09,775: Acquiring new bigquery connection "shopify_refunds_proc".
2018-04-18 08:50:09,776: Re-using an available connection from the pool.
2018-04-18 08:50:09,776: Fetching data for query shopify_refunds_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 08:50:09,871: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106d9f048>]}
2018-04-18 08:50:10,164: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x103853710>]}
2018-04-18 08:50:10,179: 08:50:10 | 13 of 91 OK created table model agency_data_pipeline.ga_mcf_proc..... [CREATE TABLE in 6.89s]
2018-04-18 08:50:10,181: 08:50:10 | 20 of 91 START table model agency_data_pipeline.bing_ads_conversions. [RUN]
2018-04-18 08:50:10,183: Compiling model.agency_data_pipeline.bing_ads_conversions
2018-04-18 08:50:10,195: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_conversions"
2018-04-18 08:50:10,196: Acquiring new bigquery connection "bing_ads_conversions".
2018-04-18 08:50:10,197: Re-using an available connection from the pool.
2018-04-18 08:50:10,484: 08:50:10 | 17 of 91 OK created table model agency_data_pipeline.fb_adcreative... [CREATE TABLE in 3.35s]
2018-04-18 08:50:11,053: Writing injected SQL for node "model.agency_data_pipeline.shopify_refunds_proc"
2018-04-18 08:50:11,066: Model SQL (bing_ads_conversions):
SELECT
date, 
a.account account, 
a.channel channel,
a.platform platform,
campaignid,
campaignname,
sum( case when b.goal_type = 'Transactions' then conversions else 0 end ) as transactions
FROM

  ( 
SELECT  
cast(gregoriandate as date) date,
replace(accountname,',','') account,
'Paid' as channel,
'Bing Ads' as platform,
trim(replace(replace(lower(goal),',',''),' ','')) goal,
goalid,
campaignid,
campaignname,
conversions,
_sdc_sequence,
first_value(_sdc_sequence) OVER (PARTITION BY campaignid, goalid, gregoriandate ORDER BY _sdc_sequence DESC) lv
FROM `growth-engines-pipeline.bing_ads.goals_and_funnels_report` 

  ) a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`conversion_goals_proc` b
ON (
	a.account = b.account AND
	a.platform = b.platform AND
	a.goal = b.goal_name
)
where a.lv = a._sdc_sequence
group by date, account, channel, platform, campaignid, campaignname
2018-04-18 08:50:11,594: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106cf7d68>]}
2018-04-18 08:50:11,821: Model SQL (shopify_refunds_proc):




with refunds as (

	
	SELECT
	order_number,
	checkout_id,
	financial_status,
	line_item_id,
	quantity,
	subtotal,
	line_item.variant_id variant_id,
	line_item.id refund_id,
 	_sdc_sequence
	FROM `growth-engines-pipeline.shopify_lucadanni.orders` 
	cross join unnest(refunds), unnest(refund_line_items)
  	where financial_status like '%refund%'
	
	

)

SELECT * 
FROM 
	(
    SELECT
	order_number,
	checkout_id,
	financial_status,
	line_item_id,
	quantity,
	subtotal refund_amount,
	variant_id,
	refund_id,
 	_sdc_sequence,
    first_value(_sdc_sequence) OVER (PARTITION BY order_number, line_item_id ORDER BY _sdc_sequence DESC) lv
    FROM refunds
   	) 
WHERE lv = _sdc_sequence


2018-04-18 08:50:11,892: 08:50:11 | 18 of 91 OK created table model agency_data_pipeline.adwords_ads..... [CREATE TABLE in 2.80s]
2018-04-18 08:50:13,270: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106d9f048>]}
2018-04-18 08:50:13,609: 08:50:13 | 20 of 91 OK created table model agency_data_pipeline.bing_ads_conversions [CREATE TABLE in 3.09s]
2018-04-18 08:50:14,004: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106d05ef0>]}
2018-04-18 08:50:14,298: 08:50:14 | 19 of 91 OK created table model agency_data_pipeline.shopify_refunds_proc [CREATE TABLE in 4.24s]
2018-04-18 08:50:14,299: 08:50:14 | 21 of 91 START table model agency_data_pipeline.shopify_customers_proc [RUN]
2018-04-18 08:50:14,299: Compiling model.agency_data_pipeline.shopify_customers_proc
2018-04-18 08:50:14,300: 08:50:14 | 22 of 91 START table model agency_data_pipeline.fb_ads............... [RUN]
2018-04-18 08:50:14,306: Compiling model.agency_data_pipeline.fb_ads
2018-04-18 08:50:14,326: Acquiring new bigquery connection "shopify_customers_proc".
2018-04-18 08:50:14,327: Acquiring new bigquery connection "fb_ads".
2018-04-18 08:50:14,327: Re-using an available connection from the pool.
2018-04-18 08:50:14,327: Fetching data for query shopify_customers_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 08:50:14,328: Re-using an available connection from the pool.
2018-04-18 08:50:14,328: Fetching data for query fb_ads:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 08:50:14,739: Writing injected SQL for node "model.agency_data_pipeline.fb_ads"
2018-04-18 08:50:14,750: Writing injected SQL for node "model.agency_data_pipeline.shopify_customers_proc"
2018-04-18 08:50:15,759: Model SQL (fb_ads):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`fb_adcreative`





with fb_ads as (

	    
		   	SELECT 
			id ad_id,
			creative.creative_id creative_id,
			_sdc_sequence
			FROM `growth-engines-pipeline.fb_ads_luca_danni.ads`
		     
	   

)

SELECT
a.ad_id,
b.creative_id,
b.url
FROM (
    SELECT
    ad_id,
    creative_id,
    first_value(_sdc_sequence) OVER (PARTITION BY ad_id ORDER BY _sdc_sequence DESC) lv,
    _sdc_sequence
    FROM fb_ads
    ) a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`fb_adcreative` b
ON (
	a.creative_id = b.creative_id 
)
WHERE a.lv = a._sdc_sequence


2018-04-18 08:50:15,765: Model SQL (shopify_customers_proc):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc`





with customers as (

	
	SELECT
	'lucadanni' client_name,
	'Shopify' as lookup_platform,
	cast(created_at as date) created_at,
	id,
	first_name,
	last_name,
	email,
	_sdc_sequence,
	first_value(_sdc_sequence) over (partition by id, _sdc_sequence order by _sdc_sequence desc) lv
	FROM `growth-engines-pipeline.shopify_lucadanni.customers` 
	
	

)

SELECT
account,
client,
platform,
id,
min(created_at) created_at,
max(first_name) first_name,
max(last_name) last_name,
max(email) email
FROM (
	SELECT
	b.account,
	b.client,
	b.platform,
	created_at,
	id,
	first_name,
	last_name,
	email
	FROM customers a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
	ON ( a.client_name = b.client_name
	  AND a.lookup_platform = b.platform )
	where a.lv = a._sdc_sequence
)
group by account, client, platform, id

2018-04-18 08:50:17,940: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1091b8940>]}
2018-04-18 08:50:18,233: 08:50:18 | 22 of 91 OK created table model agency_data_pipeline.fb_ads.......... [CREATE TABLE in 3.63s]
2018-04-18 08:50:22,691: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1091ab390>]}
2018-04-18 08:50:22,914: 08:50:22 | 21 of 91 OK created table model agency_data_pipeline.shopify_customers_proc [CREATE TABLE in 8.39s]
2018-04-18 08:50:22,915: 08:50:22 | 23 of 91 START table model agency_data_pipeline.ga_mcf_stats......... [RUN]
2018-04-18 08:50:22,915: 08:50:22 | 24 of 91 START table model agency_data_pipeline.shopify_orders_proc.. [RUN]
2018-04-18 08:50:22,916: Compiling model.agency_data_pipeline.ga_mcf_stats
2018-04-18 08:50:22,916: 08:50:22 | 25 of 91 START table model agency_data_pipeline.bing_ads_stats....... [RUN]
2018-04-18 08:50:22,916: 08:50:22 | 26 of 91 START table model agency_data_pipeline.agg_customers_union.. [RUN]
2018-04-18 08:50:22,917: Compiling model.agency_data_pipeline.shopify_orders_proc
2018-04-18 08:50:22,923: Compiling model.agency_data_pipeline.bing_ads_stats
2018-04-18 08:50:22,926: Writing injected SQL for node "model.agency_data_pipeline.ga_mcf_stats"
2018-04-18 08:50:22,926: Compiling model.agency_data_pipeline.agg_customers_union
2018-04-18 08:50:22,952: Acquiring new bigquery connection "shopify_orders_proc".
2018-04-18 08:50:22,965: Re-using an available connection from the pool.
2018-04-18 08:50:22,965: Fetching data for query shopify_orders_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 08:50:22,954: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_stats"
2018-04-18 08:50:22,969: Acquiring new bigquery connection "bing_ads_stats".
2018-04-18 08:50:22,970: Re-using an available connection from the pool.
2018-04-18 08:50:22,955: Acquiring new bigquery connection "ga_mcf_stats".
2018-04-18 08:50:22,999: Re-using an available connection from the pool.
2018-04-18 08:50:22,998: Writing injected SQL for node "model.agency_data_pipeline.agg_customers_union"
2018-04-18 08:50:23,015: Acquiring new bigquery connection "agg_customers_union".
2018-04-18 08:50:23,015: Re-using an available connection from the pool.
2018-04-18 08:50:23,301: Writing injected SQL for node "model.agency_data_pipeline.shopify_orders_proc"
2018-04-18 08:50:23,815: Model SQL (agg_customers_union):
SELECT *
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`shopify_customers_proc`
2018-04-18 08:50:23,866: Model SQL (bing_ads_stats):
select
a.date, 
a.account, 
a.channel,
a.platform,
url,
a.campaignname campaign,
utm_campaign,
cost,
clicks,
impressions,
transactions
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`bing_ads_ads` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`bing_ads_conversions` b
ON (
	a.date = b.date AND
	a.account = b.account AND
	a.campaignid = b.campaignid

)
2018-04-18 08:50:23,931: Model SQL (ga_mcf_stats):
SELECT  
date,
a.account account,
b.client client,
case when c.platform is null then "Unmapped" else c.platform end as platform,
case when c.channel is null then "Unmapped" else c.channel end as channel,
lower(a.source) source,
lower(a.medium) medium,
lower(campaign) campaign,
transactionid,
sum(transactions) first_touch_transactions,
sum(revenue) first_touch_revenue
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`ga_mcf_proc` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc` b 
ON ( a.account = b.account and
	a.lookup_platform = b.platform )
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc` c
ON ( lower(a.source) = c.source
  AND lower(a.medium) = c.medium 
  and a.account = c.account )
group by date, account, client, source, medium, campaign, platform, channel, transactionid
2018-04-18 08:50:24,209: Model SQL (shopify_orders_proc):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc`, `growth-engines-pipeline`.`agency_data_pipeline`.`shopify_refunds_proc`





with orders as (

	
	SELECT
	'lucadanni' client_name,
	'Shopify' as lookup_platform,
	created_at,
	order_number,
	quantity,
	cast(pre_tax_price as float64) price, 
	total_line_items_price total_order_price_undiscounted,
	total_discounts,
	cast(discounted_price as float64) total_order_shipping_price,
	total_price_usd total_order_price_incl_shipping,
	checkout_id,
	product_id, 
	landing_site,
	sku, 
	variant_title, 
	variant_id,
	_id line_item_id,
	customer.id customer_id,
	customer.orders_count orders_count,
	customer.created_at customer_created_at,
	customer.last_order_id last_order_id,
	financial_status,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY order_number, _id ORDER BY _sdc_sequence DESC) lv
	FROM `growth-engines-pipeline.shopify_lucadanni.orders` 
	cross join unnest(line_items), unnest(shipping_lines)
	where source_name != 'shopify_draft_order'
	
	

)

SELECT
b.account,
b.client,
b.platform,
created_at,
a.order_number,
a.quantity,
c.quantity refund_quantity,
case when c.quantity is not null then a.quantity - c.quantity else a.quantity end as final_quantity,
price, 
total_order_price_undiscounted,
total_discounts,
total_order_shipping_price,
total_order_price_incl_shipping,
refund_amount,
case when refund_amount is not null then price - refund_amount else price end as final_price,
a.checkout_id,
a.product_id, 
landing_site,
sku, 
variant_title, 
a.variant_id,
a.line_item_id,	
customer_id,
orders_count,
customer_created_at,
last_order_id,
a.financial_status
FROM orders a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
ON ( a.client_name = b.client_name
  AND a.lookup_platform = b.platform )
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`shopify_refunds_proc` c
ON ( a.order_number = c.order_number
	AND a.line_item_id = c.line_item_id )   	
where a.lv = a._sdc_sequence


2018-04-18 08:50:26,048: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1087715f8>]}
2018-04-18 08:50:26,379: 08:50:26 | 25 of 91 OK created table model agency_data_pipeline.bing_ads_stats.. [CREATE TABLE in 3.12s]
2018-04-18 08:50:26,379: 08:50:26 | 27 of 91 START table model agency_data_pipeline.shopify_products_proc [RUN]
2018-04-18 08:50:26,380: Compiling model.agency_data_pipeline.shopify_products_proc
2018-04-18 08:50:26,393: Acquiring new bigquery connection "shopify_products_proc".
2018-04-18 08:50:26,394: Re-using an available connection from the pool.
2018-04-18 08:50:26,394: Fetching data for query shopify_products_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 08:50:26,925: Writing injected SQL for node "model.agency_data_pipeline.shopify_products_proc"
2018-04-18 08:50:27,091: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109205e48>]}
2018-04-18 08:50:27,319: 08:50:27 | 26 of 91 OK created table model agency_data_pipeline.agg_customers_union [CREATE TABLE in 4.16s]
2018-04-18 08:50:27,531: Model SQL (shopify_products_proc):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc`, `growth-engines-pipeline`.`agency_data_pipeline`.`shopify_refunds_proc`





with products as (

	
	SELECT
	'lucadanni' client_name,
	'Shopify' as lookup_platform,
	product_type,
	product_id,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY product_id ORDER BY _sdc_sequence DESC) lv
	FROM `growth-engines-pipeline.shopify_lucadanni.products` 
	cross join unnest(variants)
	
	

)

SELECT
b.account,
b.client,
b.platform,
max(product_type) product_type,
product_id
FROM products a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
ON ( a.client_name = b.client_name
  AND a.lookup_platform = b.platform )
where a.lv = a._sdc_sequence
group by product_id, account, client, platform


2018-04-18 08:50:29,446: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106d05ef0>]}
2018-04-18 08:50:29,732: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106e4bb70>]}
2018-04-18 08:50:29,819: 08:50:29 | 23 of 91 OK created table model agency_data_pipeline.ga_mcf_stats.... [CREATE TABLE in 6.53s]
2018-04-18 08:50:30,080: 08:50:30 | 27 of 91 OK created table model agency_data_pipeline.shopify_products_proc [CREATE TABLE in 3.35s]
2018-04-18 08:50:33,361: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106e4b9e8>]}
2018-04-18 08:50:33,662: 08:50:33 | 24 of 91 OK created table model agency_data_pipeline.shopify_orders_proc [CREATE TABLE in 10.44s]
2018-04-18 08:50:33,663: 08:50:33 | 28 of 91 START table model agency_data_pipeline.adwords_join......... [RUN]
2018-04-18 08:50:33,664: Compiling model.agency_data_pipeline.adwords_join
2018-04-18 08:50:33,664: 08:50:33 | 29 of 91 START table model agency_data_pipeline.ga_traffic........... [RUN]
2018-04-18 08:50:33,671: Compiling model.agency_data_pipeline.ga_traffic
2018-04-18 08:50:33,682: Writing injected SQL for node "model.agency_data_pipeline.adwords_join"
2018-04-18 08:50:33,664: 08:50:33 | 30 of 91 START table model agency_data_pipeline.ga_transactions...... [RUN]
2018-04-18 08:50:33,664: 08:50:33 | 31 of 91 START table model agency_data_pipeline.agg_products......... [RUN]
2018-04-18 08:50:33,695: Compiling model.agency_data_pipeline.ga_transactions
2018-04-18 08:50:33,704: Acquiring new bigquery connection "ga_traffic".
2018-04-18 08:50:33,704: Compiling model.agency_data_pipeline.agg_products
2018-04-18 08:50:33,711: Acquiring new bigquery connection "adwords_join".
2018-04-18 08:50:33,718: Re-using an available connection from the pool.
2018-04-18 08:50:33,745: Acquiring new bigquery connection "ga_transactions".
2018-04-18 08:50:33,746: Writing injected SQL for node "model.agency_data_pipeline.agg_products"
2018-04-18 08:50:33,749: Acquiring new bigquery connection "agg_products".
2018-04-18 08:50:33,746: Re-using an available connection from the pool.
2018-04-18 08:50:33,746: Fetching data for query ga_traffic:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'GA Traffic'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 08:50:33,750: Re-using an available connection from the pool.
2018-04-18 08:50:33,751: Fetching data for query ga_transactions:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Google Analytics'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 08:50:33,752: Re-using an available connection from the pool.
2018-04-18 08:50:34,601: Model SQL (agg_products):
SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`shopify_products_proc`
2018-04-18 08:50:34,602: Model SQL (adwords_join):
select
a.day,
a.campaignid, 
a.campaign,
a.account, 
channel,
platform,
url,
utm_campaign,
cost,
impressions,
clicks,
impression_share_num,
impression_share_den,
transactions
FROM ( 
	
	select
	day,
	a.campaign,
	a.campaignid, 
	account, 
	channel,
	platform,
	url,
	cost,
	impressions,
	clicks,
	impression_share_num,
	impression_share_den
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_campaigns` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_urls` b
	ON a.campaignid = b.campaignid

) a 
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_ads` b
ON ( a.campaignid = b.campaignid
	and a.day = b.day )
2018-04-18 08:50:34,917: Fetching data for query ga_transactions:


        select
            goal_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_conversions`

        
        ##where 1 = 1
        where goal_type = 'Conversion'
        
        
        
        ##and 2 = 2
        and client_name = 'lucadanni'
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 08:50:35,063: Fetching data for query ga_traffic:


        select
            goal_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_conversions`

        
        ##where 1 = 1
        where goal_type = 'Conversion'
        
        
        
        ##and 2 = 2
        and client_name = 'lucadanni'
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 08:50:35,696: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10879ef28>]}
2018-04-18 08:50:35,999: 08:50:35 | 31 of 91 OK created table model agency_data_pipeline.agg_products.... [CREATE TABLE in 1.99s]
2018-04-18 08:50:35,999: 08:50:35 | 32 of 91 START table model agency_data_pipeline.agg_orders_union..... [RUN]
2018-04-18 08:50:36,000: Compiling model.agency_data_pipeline.agg_orders_union
2018-04-18 08:50:36,006: Writing injected SQL for node "model.agency_data_pipeline.agg_orders_union"
2018-04-18 08:50:36,007: Acquiring new bigquery connection "agg_orders_union".
2018-04-18 08:50:36,008: Re-using an available connection from the pool.
2018-04-18 08:50:36,118: Writing injected SQL for node "model.agency_data_pipeline.ga_transactions"
2018-04-18 08:50:36,673: Writing injected SQL for node "model.agency_data_pipeline.ga_traffic"
2018-04-18 08:50:36,717: Model SQL (agg_orders_union):
SELECT
account,
client,
platform,
created_at,
order_number,
quantity,
refund_quantity,
final_quantity,
price, 
total_order_price_undiscounted,
total_discounts,
total_order_shipping_price,
total_order_price_incl_shipping,
refund_amount,
final_price,
checkout_id,
product_id, 
landing_site,
sku, 
variant_title, 
variant_id,
line_item_id,	
customer_id,
orders_count,
customer_created_at,
last_order_id,
financial_status
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`shopify_orders_proc`
2018-04-18 08:50:36,828: Model SQL (ga_transactions):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc`, `growth-engines-pipeline`.`agency_data_pipeline`.`ga_conversions`


##`growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` 



with ga_report as (

	    

	    	
	    	
		   	SELECT
		   	'lucadanni' as client_name,
		   	'Google Analytics' as lookup_platform,
			lower(trim(regexp_replace(replace(replace(replace(replace(CONCAT(hostname,landingpagepath),'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
			date,
			lower(source) source,
			lower(medium) medium,
			lower(campaign) campaign,
			cast(regexp_replace(transactionid, r'#', '') as int64) transactionid,
			transactions last_touch_transactions,
			(transactionrevenue - transactionshipping - transactiontax) as last_touch_revenue,
			transactionshipping,
			transactiontax,
			_sdc_sequence,
			first_value(_sdc_sequence) OVER (PARTITION BY hostname, landingpagepath, date, source, medium, transactionid ORDER BY _sdc_sequence DESC) lv
			FROM `growth-engines-pipeline.ga_lucadanni.report` 

		    
	   

)


SELECT  
cast(date as date) date,
b.account,
b.client client,
c.source source,
c.medium medium,
a.campaign campaign,
concat(a.source, ' / ', a.medium) source_medium,  
case when c.platform is null then "Unmapped" else c.platform end as platform,
case when c.channel is null then "Unmapped" else c.channel end as channel,
regexp_replace(url, r'offers.|offer.|get.|info.|pos.|go.|join.|pages.','') url,
transactionid,
max(last_touch_transactions) last_touch_transactions,
max(last_touch_revenue) last_touch_revenue,
max(transactionshipping) last_touch_shipping,
max(transactiontax) last_touch_tax
FROM ga_report a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
ON ( a.client_name = b.client_name 
	AND a.lookup_platform = b.platform )
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc` c
ON ( a.source = c.source
  AND a.medium = c.medium 
  AND a.client_name = c.client_name )
GROUP BY date, account, client, source, medium, campaign, source_medium, platform, channel, url, transactionid


2018-04-18 08:50:37,343: Model SQL (ga_traffic):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc`, `growth-engines-pipeline`.`agency_data_pipeline`.`ga_conversions`


##`growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` 



with ga_report as (

	    

	    	
	    	
		   	SELECT
		   	'lucadanni' as client_name,
		   	'GA Traffic' as lookup_platform,
			lower(trim(regexp_replace(replace(replace(replace(replace(CONCAT(hostname,landingpagepath),'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
			date,
			lower(source) source,
			lower(medium) medium,
			lower(campaign) campaign,
			sessions,
			## goal completion columns
							
				goalcompletionsall as goal_completions,		
			
			_sdc_sequence,
			first_value(_sdc_sequence) OVER (PARTITION BY hostname, landingpagepath, date, source, medium, campaign ORDER BY _sdc_sequence DESC) lv
			FROM `growth-engines-pipeline.ga_lucadanni_traffic.report` 

		    
	   

)


SELECT  
cast(date as date) date,
b.account,
b.client client,
c.source source,
c.medium medium,
a.campaign campaign,
concat(a.source, ' / ', a.medium) source_medium,  
case when c.platform is null then "Unmapped" else c.platform end as platform,
case when c.channel is null then "Unmapped" else c.channel end as channel,
regexp_replace(url, r'offers.|offer.|get.|info.|pos.|go.|join.|pages.','') url,
max(sessions) sessions,
max(goal_completions) goal_completions
FROM ga_report a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
ON ( a.client_name = b.client_name 
	AND a.lookup_platform = b.platform )
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc` c
ON ( a.source = c.source
  AND a.medium = c.medium 
  AND a.client_name = c.client_name )
GROUP BY date, account, client, source, medium, campaign, source_medium, platform, channel, url


2018-04-18 08:50:40,127: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106df3cf8>]}
2018-04-18 08:50:40,424: 08:50:40 | 28 of 91 OK created table model agency_data_pipeline.adwords_join.... [CREATE TABLE in 6.46s]
2018-04-18 08:50:44,402: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10879ef28>]}
2018-04-18 08:50:44,469: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1091c09b0>]}
2018-04-18 08:50:44,679: 08:50:44 | 32 of 91 OK created table model agency_data_pipeline.agg_orders_union [CREATE TABLE in 8.40s]
2018-04-18 08:50:44,914: 08:50:44 | 30 of 91 OK created table model agency_data_pipeline.ga_transactions. [CREATE TABLE in 10.77s]
2018-04-18 08:50:48,331: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106de0080>]}
2018-04-18 08:50:49,021: 08:50:49 | 29 of 91 OK created table model agency_data_pipeline.ga_traffic...... [CREATE TABLE in 14.66s]
2018-04-18 08:50:49,022: 08:50:49 | 33 of 91 START table model agency_data_pipeline.adwords_stats........ [RUN]
2018-04-18 08:50:49,022: Compiling model.agency_data_pipeline.adwords_stats
2018-04-18 08:50:49,022: 08:50:49 | 34 of 91 START table model agency_data_pipeline.agg_transaction_line_item [RUN]
2018-04-18 08:50:49,023: 08:50:49 | 35 of 91 START table model agency_data_pipeline.agg_transaction_order_number [RUN]
2018-04-18 08:50:49,023: 08:50:49 | 36 of 91 START table model agency_data_pipeline.fb_ads_stats......... [RUN]
2018-04-18 08:50:49,029: Compiling model.agency_data_pipeline.agg_transaction_line_item
2018-04-18 08:50:49,033: Writing injected SQL for node "model.agency_data_pipeline.adwords_stats"
2018-04-18 08:50:49,033: Compiling model.agency_data_pipeline.agg_transaction_order_number
2018-04-18 08:50:49,033: Compiling model.agency_data_pipeline.fb_ads_stats
2018-04-18 08:50:49,045: Writing injected SQL for node "model.agency_data_pipeline.agg_transaction_order_number"
2018-04-18 08:50:49,046: Writing injected SQL for node "model.agency_data_pipeline.agg_transaction_line_item"
2018-04-18 08:50:49,052: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_stats"
2018-04-18 08:50:49,053: Acquiring new bigquery connection "adwords_stats".
2018-04-18 08:50:49,054: Re-using an available connection from the pool.
2018-04-18 08:50:49,055: Acquiring new bigquery connection "agg_transaction_order_number".
2018-04-18 08:50:49,062: Acquiring new bigquery connection "agg_transaction_line_item".
2018-04-18 08:50:49,062: Re-using an available connection from the pool.
2018-04-18 08:50:49,063: Acquiring new bigquery connection "fb_ads_stats".
2018-04-18 08:50:49,070: Re-using an available connection from the pool.
2018-04-18 08:50:49,078: Re-using an available connection from the pool.
2018-04-18 08:50:49,801: Model SQL (agg_transaction_order_number):
SELECT
client,
cast(created_at as date) date,
order_number,
customer_id,
sum(final_quantity) final_quantity,
sum(final_price) final_price,
max(total_order_shipping_price) shipping_price
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`agg_orders_union`
GROUP BY client, created_at, order_number, customer_id
2018-04-18 08:50:49,816: Model SQL (fb_ads_stats):
with cost as (

    select 
        date, account, ad_id, campaign,
        cost, impressions, clicks, null as conversions
    from `growth-engines-pipeline`.`agency_data_pipeline`.`fb_ads_insights`
),

conversions as (

    select 
        date, account, ad_id, campaign,
        null as cost, null as impressions, null as clicks, conversions
    from `growth-engines-pipeline`.`agency_data_pipeline`.`fb_ads_insights_conversions`
),

urls as (

    select ad_id, url
    from `growth-engines-pipeline`.`agency_data_pipeline`.`fb_ads`
)


SELECT
    cast(date as date) date,
    'FB Ads' platform,
    'Paid' channel,
    account, 
    b.url url,
    campaign,
    lower(campaign) utm_campaign, 
    sum(cost) cost,
    sum(impressions) impressions,
    sum(clicks) clicks,
    sum(conversions) transactions
FROM
(
    SELECT *
    FROM 
      cost
    UNION ALL
    SELECT *
    FROM 
      conversions
) a
LEFT JOIN urls b
ON ( a.ad_id = b.ad_id )
group by date, platform, channel, account, url, campaign, utm_campaign
2018-04-18 08:50:49,849: Model SQL (adwords_stats):
SELECT 
cast(day as date) date, 
account, 
platform,
channel,
url,
utm_campaign,
campaign,
sum(cost) cost,
sum(impressions) impressions,
sum(clicks) clicks,
sum(transactions) transactions
FROM 
  `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_join`
group by date, account, platform, channel, url, campaign, utm_campaign
2018-04-18 08:50:49,863: Model SQL (agg_transaction_line_item):
SELECT
client,
created_at,
order_number,
quantity,
refund_quantity,
final_quantity,
price, 
total_order_price_undiscounted,
total_discounts,
total_order_shipping_price,
total_order_price_incl_shipping,
refund_amount,
final_price,
checkout_id,
product_id, 
landing_site,
sku, 
variant_title, 
variant_id,
line_item_id,	
customer_id,
orders_count,
customer_created_at,
last_order_id,
financial_status
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`agg_orders_union`
2018-04-18 08:50:52,035: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10878f358>]}
2018-04-18 08:50:52,406: 08:50:52 | 36 of 91 OK created table model agency_data_pipeline.fb_ads_stats.... [CREATE TABLE in 3.00s]
2018-04-18 08:50:52,407: 08:50:52 | 37 of 91 START table model agency_data_pipeline.adwords_impression_share [RUN]
2018-04-18 08:50:52,407: Compiling model.agency_data_pipeline.adwords_impression_share
2018-04-18 08:50:52,415: Writing injected SQL for node "model.agency_data_pipeline.adwords_impression_share"
2018-04-18 08:50:52,416: Acquiring new bigquery connection "adwords_impression_share".
2018-04-18 08:50:52,416: Re-using an available connection from the pool.
2018-04-18 08:50:53,138: Model SQL (adwords_impression_share):
SELECT 
cast(day as date) date, 
account, 
channel,
platform,
sum(impression_share_num) impressions,
sum(impression_share_den) available_impressions
FROM 
  `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_join`
group by date, account, platform, channel
2018-04-18 08:50:54,180: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10879a518>]}
2018-04-18 08:50:54,507: 08:50:54 | 35 of 91 OK created table model agency_data_pipeline.agg_transaction_order_number [CREATE TABLE in 5.15s]
2018-04-18 08:50:55,257: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106e4b9e8>]}
2018-04-18 08:50:55,303: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10878f358>]}
2018-04-18 08:50:55,472: 08:50:55 | 33 of 91 OK created table model agency_data_pipeline.adwords_stats... [CREATE TABLE in 6.23s]
2018-04-18 08:50:55,756: 08:50:55 | 37 of 91 OK created table model agency_data_pipeline.adwords_impression_share [CREATE TABLE in 2.90s]
2018-04-18 08:50:56,482: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1038bc780>]}
2018-04-18 08:50:56,771: 08:50:56 | 34 of 91 OK created table model agency_data_pipeline.agg_transaction_line_item [CREATE TABLE in 7.45s]
2018-04-18 08:50:56,772: 08:50:56 | 38 of 91 START table model agency_data_pipeline.customers_by_transaction [RUN]
2018-04-18 08:50:56,772: Compiling model.agency_data_pipeline.customers_by_transaction
2018-04-18 08:50:56,781: Writing injected SQL for node "model.agency_data_pipeline.customers_by_transaction"
2018-04-18 08:50:56,783: Acquiring new bigquery connection "customers_by_transaction".
2018-04-18 08:50:56,783: Re-using an available connection from the pool.
2018-04-18 08:50:57,742: Model SQL (customers_by_transaction):
SELECT
client,
customer_id,
order_number,
order_date,
first_order_date,
case when first_order_number = order_number then 'New' else 'Existing' end as order_type,
final_price,
first_order_revenue,
lifetime_revenue
FROM

(

	SELECT
	client,
	customer_id,
	order_number,
	date order_date,
	first_value(date) over w1 first_order_date,
	first_value(order_number) over w1 first_order_number,
	first_value(final_price) over w1 first_order_revenue,
    final_price,
	sum(final_price) over w2 lifetime_revenue
	FROM
    `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_order_number`
	WINDOW w1 as (PARTITION BY client, customer_id ORDER BY date desc),
	w2 as (PARTITION BY client, customer_id)
)
2018-04-18 08:51:01,068: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106e1c358>]}
2018-04-18 08:51:01,298: 08:51:01 | 38 of 91 OK created table model agency_data_pipeline.customers_by_transaction [CREATE TABLE in 4.30s]
2018-04-18 08:51:01,298: 08:51:01 | 39 of 91 START table model agency_data_pipeline.agg_ga_transaction_order_number [RUN]
2018-04-18 08:51:01,299: 08:51:01 | 40 of 91 START table model agency_data_pipeline.frequency_proc....... [RUN]
2018-04-18 08:51:01,299: Compiling model.agency_data_pipeline.agg_ga_transaction_order_number
2018-04-18 08:51:01,299: Compiling model.agency_data_pipeline.frequency_proc
2018-04-18 08:51:01,310: Writing injected SQL for node "model.agency_data_pipeline.frequency_proc"
2018-04-18 08:51:01,311: Writing injected SQL for node "model.agency_data_pipeline.agg_ga_transaction_order_number"
2018-04-18 08:51:01,315: Acquiring new bigquery connection "agg_ga_transaction_order_number".
2018-04-18 08:51:01,315: Re-using an available connection from the pool.
2018-04-18 08:51:01,316: Acquiring new bigquery connection "frequency_proc".
2018-04-18 08:51:01,316: Re-using an available connection from the pool.
2018-04-18 08:51:02,146: Model SQL (frequency_proc):
WITH transactions AS (

  	SELECT 
	client,
	customer_id,
	order_number,
	date,
	unix_date(date) d
	FROM
	`growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_order_number`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)

SELECT 
client,
'Rolling 365' as period,
date_in_range date,
unix_date_in_range, 
customer_id,
count(distinct(order_number)) frequency
FROM daterange
JOIN transactions
ON transactions.d > ( daterange.unix_date_in_range - 365 )
AND transactions.d <= daterange.unix_date_in_range
group by client, unix_date_in_range, customer_id, date
2018-04-18 08:51:02,190: Model SQL (agg_ga_transaction_order_number):
with ga as (

    select 
        date, account, client, 
        channel as last_touch_channel, 
        platform as last_touch_platform, 
        url as last_touch_url, 
        campaign as last_touch_utm_campaign, 
        '' as first_touch_channel, 
        '' as first_touch_platform, 
        '' as first_touch_utm_campaign, 
        transactionid,
        last_touch_transactions, last_touch_revenue,
        last_touch_shipping, last_touch_tax,
        null as first_touch_transactions, null as first_touch_revenue
    from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_transactions`

),

ga_mcf as (

    select 
        date, account, client, 
        '' as last_touch_channel,
        '' as last_touch_platform,
        '' as last_touch_url,
        '' as last_touch_utm_campaign, 
        channel as first_touch_channel, 
        platform as first_touch_platform, 
        campaign as first_touch_utm_campaign, 
        transactionid, 
        null as last_touch_transactions, null as last_touch_revenue,
        null as last_touch_shipping, null as last_touch_tax,
        first_touch_transactions, first_touch_revenue
    from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_mcf_stats`

)


SELECT
    date, 
    client,
    transactionid,
    max(last_touch_channel) last_touch_channel, 
    max(last_touch_platform) last_touch_platform, 
    max(last_touch_url) last_touch_url, 
    max(last_touch_utm_campaign) last_touch_utm_campaign, 
    max(first_touch_channel) first_touch_channel, 
    max(first_touch_platform) first_touch_platform, 
    max(first_touch_utm_campaign) first_touch_utm_campaign,
    sum(last_touch_transactions) last_touch_transactions,
    sum(last_touch_revenue) last_touch_revenue,
    sum(last_touch_shipping) last_touch_shipping_revenue,
    sum(last_touch_tax) last_touch_tax_revenue,
    sum(first_touch_transactions) first_touch_transactions,
    sum(first_touch_revenue) - ifnull(sum(last_touch_shipping),0) - ifnull(sum(last_touch_tax),0) first_touch_revenue
FROM
(
    SELECT *
    FROM 
      ga
    UNION ALL
    SELECT *
    FROM 
      ga_mcf
) 
GROUP BY
    date, client, transactionid
2018-04-18 08:51:07,674: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106e1c278>]}
2018-04-18 08:51:07,971: 08:51:07 | 39 of 91 OK created table model agency_data_pipeline.agg_ga_transaction_order_number [CREATE TABLE in 6.38s]
2018-04-18 08:51:15,148: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1038bc780>]}
2018-04-18 08:51:15,392: 08:51:15 | 40 of 91 OK created table model agency_data_pipeline.frequency_proc.. [CREATE TABLE in 13.85s]
2018-04-18 08:51:15,393: 08:51:15 | 41 of 91 START table model agency_data_pipeline.frequency_stats...... [RUN]
2018-04-18 08:51:15,393: 08:51:15 | 42 of 91 START table model agency_data_pipeline.agg_ga_campaign...... [RUN]
2018-04-18 08:51:15,394: Compiling model.agency_data_pipeline.frequency_stats
2018-04-18 08:51:15,394: 08:51:15 | 43 of 91 START table model agency_data_pipeline.agg_transaction_line_item_type [RUN]
2018-04-18 08:51:15,395: Compiling model.agency_data_pipeline.agg_ga_campaign
2018-04-18 08:51:15,401: Compiling model.agency_data_pipeline.agg_transaction_line_item_type
2018-04-18 08:51:15,405: Writing injected SQL for node "model.agency_data_pipeline.frequency_stats"
2018-04-18 08:51:15,417: Writing injected SQL for node "model.agency_data_pipeline.agg_transaction_line_item_type"
2018-04-18 08:51:15,418: Writing injected SQL for node "model.agency_data_pipeline.agg_ga_campaign"
2018-04-18 08:51:15,420: Acquiring new bigquery connection "agg_transaction_line_item_type".
2018-04-18 08:51:15,420: Re-using an available connection from the pool.
2018-04-18 08:51:15,420: Acquiring new bigquery connection "frequency_stats".
2018-04-18 08:51:15,421: Re-using an available connection from the pool.
2018-04-18 08:51:15,422: Acquiring new bigquery connection "agg_ga_campaign".
2018-04-18 08:51:15,422: Re-using an available connection from the pool.
2018-04-18 08:51:16,195: Model SQL (frequency_stats):
SELECT
client,
period,
date,
unix_date_in_range,
case when frequency = 1 then '1' 
	when frequency = 2 then '2'
	when frequency > 2 then '2+'
	else null end as frequency_segment,
sum(customers) customers 
FROM (

	SELECT 
	client,
	period,
	date,
	unix_date_in_range, 
	frequency,
	count(distinct(customer_id)) customers
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`frequency_proc`
	group by client, period, date, unix_date_in_range, frequency
)
group by client, period, date, unix_date_in_range, frequency_segment
2018-04-18 08:51:16,294: Model SQL (agg_ga_campaign):
with ga_transactions as (

	select 
		date, account, client, channel, platform, url, 
		campaign,
		null as sessions, null as goal_completions, last_touch_transactions, last_touch_revenue,
		last_touch_shipping, last_touch_tax,
		null as first_touch_transactions, null as first_touch_revenue
	from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_transactions`

),

ga_traffic as (

    select 
        date, account, client, channel, platform, url, 
        campaign,
        sessions, goal_completions, null as last_touch_transactions, null as last_touch_revenue,
        null as last_touch_shipping, null as last_touch_tax,
        null as first_touch_transactions, null as first_touch_revenue
    from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_traffic`

),

ga_mcf as (

	select 
		date, account, client, channel, platform, '' as url,
		campaign, 
		null as sessions, null as goal_completions, null as last_touch_transactions, null as last_touch_revenue,
		null as last_touch_shipping, null as last_touch_tax,
		first_touch_transactions, first_touch_revenue
	from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_mcf_stats`

)


SELECT
    date, 
    client,
    platform,
    channel, 
    url,
    campaign utm_campaign,
	sum(sessions) sessions,
	sum(goal_completions) goal_completions,
	sum(last_touch_transactions) last_touch_transactions,
	sum(last_touch_revenue) last_touch_revenue,
    sum(last_touch_shipping) last_touch_shipping_revenue,
    sum(last_touch_tax) last_touch_tax_revenue,
    sum(first_touch_transactions) first_touch_transactions,
    sum(first_touch_revenue) - sum(ifnull(last_touch_shipping,0)) - sum(ifnull(last_touch_tax,0)) first_touch_revenue

FROM
(
    SELECT *
    FROM 
      ga_transactions
    UNION ALL
    SELECT *
    FROM 
      ga_traffic
    UNION ALL
    SELECT *
    FROM 
      ga_mcf
) 
GROUP BY
    date, client, platform, channel, url, utm_campaign
2018-04-18 08:51:16,332: Model SQL (agg_transaction_line_item_type):
SELECT
client,
product_id,
product_type,
customer_id,
sku,
order_number,
created_at,
final_quantity,
final_price
FROM

( 
	SELECT 
	a.client, 
	a.product_id,
	product_type,
	customer_id,
	a.sku, 
	order_number,
	created_at,
	final_quantity,
	final_price
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_line_item` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`agg_products` b
	ON (
		a.product_id = b.product_id
	  and a.client = b.client
		)

)
2018-04-18 08:51:21,728: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106de0550>]}
2018-04-18 08:51:21,814: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10879a7f0>]}
2018-04-18 08:51:22,060: 08:51:22 | 41 of 91 OK created table model agency_data_pipeline.frequency_stats. [CREATE TABLE in 6.33s]
2018-04-18 08:51:22,354: 08:51:22 | 43 of 91 OK created table model agency_data_pipeline.agg_transaction_line_item_type [CREATE TABLE in 6.41s]
2018-04-18 08:51:25,013: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1091ab208>]}
2018-04-18 08:51:25,313: 08:51:25 | 42 of 91 OK created table model agency_data_pipeline.agg_ga_campaign. [CREATE TABLE in 9.62s]
2018-04-18 08:51:25,314: 08:51:25 | 44 of 91 START table model agency_data_pipeline.agg_transaction_product_type [RUN]
2018-04-18 08:51:25,315: Compiling model.agency_data_pipeline.agg_transaction_product_type
2018-04-18 08:51:25,315: 08:51:25 | 45 of 91 START table model agency_data_pipeline.customers_first_purchase_product_type_proc [RUN]
2018-04-18 08:51:25,322: Compiling model.agency_data_pipeline.customers_first_purchase_product_type_proc
2018-04-18 08:51:25,330: Writing injected SQL for node "model.agency_data_pipeline.agg_transaction_product_type"
2018-04-18 08:51:25,334: Writing injected SQL for node "model.agency_data_pipeline.customers_first_purchase_product_type_proc"
2018-04-18 08:51:25,337: Acquiring new bigquery connection "agg_transaction_product_type".
2018-04-18 08:51:25,338: Re-using an available connection from the pool.
2018-04-18 08:51:25,338: Acquiring new bigquery connection "customers_first_purchase_product_type_proc".
2018-04-18 08:51:25,340: Re-using an available connection from the pool.
2018-04-18 08:51:26,231: Model SQL (agg_transaction_product_type):
SELECT
client,
product_type,
customer_id,
order_number,
created_at,
first_value(product_type) over (PARTITION BY client, customer_id, order_number, created_at ORDER BY final_price desc) as top_order_product_type,
final_quantity,
final_price,
sum(final_quantity) over (PARTITION BY client, customer_id, order_number) as total_order_quantity,
sum(final_price) over (PARTITION BY client, customer_id, order_number) as total_order_value
FROM
	(
		SELECT
		client,
		product_type,
		customer_id,
		order_number,
		created_at,
		sum(final_quantity) final_quantity,
		sum(final_price) final_price
		FROM
		`growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_line_item_type`
		GROUP BY
		client,
		product_type,
		customer_id,
		order_number,
		created_at
	)
2018-04-18 08:51:26,232: Model SQL (customers_first_purchase_product_type_proc):
SELECT 
client, 
customer_id, 
product_type,
min(cast(created_at as date)) first_order_date,
unix_date( min(cast(created_at as date))) first_order_unix_date
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_line_item_type`
GROUP BY client, customer_id, product_type
2018-04-18 08:51:29,503: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108783f60>]}
2018-04-18 08:51:29,879: 08:51:29 | 45 of 91 OK created table model agency_data_pipeline.customers_first_purchase_product_type_proc [CREATE TABLE in 4.18s]
2018-04-18 08:51:30,612: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106e4bfd0>]}
2018-04-18 08:51:30,907: 08:51:30 | 44 of 91 OK created table model agency_data_pipeline.agg_transaction_product_type [CREATE TABLE in 5.30s]
2018-04-18 08:51:30,908: 08:51:30 | 46 of 91 START table model agency_data_pipeline.order_paths_proc..... [RUN]
2018-04-18 08:51:30,908: 08:51:30 | 47 of 91 START table model agency_data_pipeline.customers_products_proc [RUN]
2018-04-18 08:51:30,908: Compiling model.agency_data_pipeline.order_paths_proc
2018-04-18 08:51:30,908: 08:51:30 | 48 of 91 START table model agency_data_pipeline.products_proc........ [RUN]
2018-04-18 08:51:30,909: Compiling model.agency_data_pipeline.customers_products_proc
2018-04-18 08:51:30,916: Compiling model.agency_data_pipeline.products_proc
2018-04-18 08:51:30,918: Writing injected SQL for node "model.agency_data_pipeline.order_paths_proc"
2018-04-18 08:51:30,935: Writing injected SQL for node "model.agency_data_pipeline.customers_products_proc"
2018-04-18 08:51:30,939: Writing injected SQL for node "model.agency_data_pipeline.products_proc"
2018-04-18 08:51:30,940: Acquiring new bigquery connection "products_proc".
2018-04-18 08:51:30,940: Re-using an available connection from the pool.
2018-04-18 08:51:30,942: Acquiring new bigquery connection "customers_products_proc".
2018-04-18 08:51:30,944: Acquiring new bigquery connection "order_paths_proc".
2018-04-18 08:51:30,944: Re-using an available connection from the pool.
2018-04-18 08:51:30,946: Re-using an available connection from the pool.
2018-04-18 08:51:31,740: Model SQL (customers_products_proc):
WITH customers AS (
  SELECT 
  client, 
  product_id,
  product_type,
  customer_id,
  sku, 
  order_number,
  cast(created_at as date) order_date,
  unix_date(cast(created_at as date)) unix_order_date, 
  final_quantity quantity,
  final_price revenue
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_line_item_type`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)

SELECT 
client,
period,
customer_id,
product_type,
date,
window_end_unix_date,
window_end_unix_date - 365 as window_start_unix_date,
window_end_unix_date - unix_date(recent_order) recency_days,
frequency,
quantity,
revenue,
case when frequency > 0 then revenue/frequency else 0 end as aov
FROM 
(  

  SELECT 
  client,
  'Rolling 365' as period,
  customer_id,
  product_type,
  date_in_range date,
  unix_date_in_range,
  unix_date_in_range window_end_unix_date, 
  max(order_date) recent_order,
  sum(quantity) as quantity,
  sum(revenue) as revenue,
  count(distinct(order_number)) as frequency
  FROM daterange
  JOIN customers
  ON customers.unix_order_date > ( daterange.unix_date_in_range - 365 )
  AND customers.unix_order_date <= daterange.unix_date_in_range
  GROUP BY client, customer_id, date, unix_date_in_range, product_type

  UNION ALL

  SELECT 
  client,
  'Rolling 365 (t-1mo)' as period,
  customer_id,
  product_type,
  date_in_range date,
  unix_date_in_range, 
  unix_date_in_range - 30 window_end_unix_date, 
  max(order_date) recent_order,
  sum(quantity) as quantity,
  sum(revenue) as revenue,
  count(distinct(order_number)) as frequency
  FROM daterange
  JOIN customers
  ON customers.unix_order_date > ( daterange.unix_date_in_range - 395 )
  AND customers.unix_order_date <= ( daterange.unix_date_in_range - 30 )
  GROUP BY client, customer_id, date, unix_date_in_range, product_type

  UNION ALL

  SELECT 
  client,
  'Rolling 365 (t-1yr)' as period,
  customer_id,
  product_type,
  date_in_range date,
  unix_date_in_range, 
  unix_date_in_range - 365 window_end_unix_date, 
  max(order_date) recent_order,
  sum(quantity) as quantity,
  sum(revenue) as revenue,
  count(distinct(order_number)) as frequency
  FROM daterange
  JOIN customers
  ON customers.unix_order_date > ( daterange.unix_date_in_range - 730 )
  AND customers.unix_order_date <= ( daterange.unix_date_in_range - 365 )
  GROUP BY client, customer_id, date, unix_date_in_range, product_type

)
2018-04-18 08:51:31,741: Model SQL (order_paths_proc):
SELECT
client, 
customer_id, 
first_value(product_type) OVER w1 as first_product_type,
nth_value(product_type, 2) OVER w1 as second_product_type,
cast(first_value(created_at) OVER w1 as date) as first_purchase_date,
cast(nth_value(created_at, 2) OVER w1 as date) as second_purchase_date,
cast(nth_value(created_at, 3) OVER w1 as date) as third_purchase_date,
cast(nth_value(created_at, 4) OVER w1 as date) as fourth_purchase_date,
cast(nth_value(created_at, 5) OVER w1 as date) as fifth_purchase_date,
first_value(order_number) OVER w1 as first_order_number,
nth_value(order_number, 2) OVER w1 as second_order_number,
nth_value(order_number, 3) OVER w1 as third_order_number,
nth_value(order_number, 4) OVER w1 as fourth_order_number,
nth_value(order_number, 5) OVER w1 as fifth_order_number,
first_value(total_order_value) OVER w1 as first_order_value,
nth_value(total_order_value, 2) OVER w1 as second_order_value
FROM (
	  
	  SELECT 
	  client, 
	  product_type,
	  customer_id,
	  order_number,
	  created_at, 
	  total_order_value
	  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_product_type`
	  WHERE product_type = top_order_product_type

)
WINDOW w1 as (PARTITION BY client, customer_id ORDER BY created_at asc)
2018-04-18 08:51:31,744: Model SQL (products_proc):
WITH transactions AS (
  SELECT 
  client, 
  product_id,
  product_type,
  customer_id,
  sku, 
  order_number,
  unix_date(cast(created_at as date)) d, 
  final_quantity,
  final_price,
  first_value(unix_date(cast(created_at as date))) over (partition by client, product_id, sku order by created_at desc) first_purchase_unix_date
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_line_item_type`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)

SELECT 
client,
'Last 30' as period,
sku,
product_type,
date_in_range date,
unix_date_in_range, 
case when 
  ( first_purchase_unix_date > ( daterange.unix_date_in_range - 365 ) and first_purchase_unix_date <= daterange.unix_date_in_range )
  then 'New' else 'Existing' end as newness,  
count(distinct(customer_id)) unique_customers,
count(distinct(order_number)) orders,
sum(final_quantity) quantity,
sum(final_price) revenue,
count(distinct(d)) days_sold
FROM daterange
JOIN transactions
ON transactions.d > ( daterange.unix_date_in_range - 30 )
AND transactions.d <= daterange.unix_date_in_range
group by date_in_range, unix_date_in_range, client, sku, product_type, newness

UNION ALL

SELECT 
client,
'Last 90' as period,
sku, 
product_type,
date_in_range date,
unix_date_in_range, 
case when 
  ( first_purchase_unix_date > ( daterange.unix_date_in_range - 365 ) and first_purchase_unix_date <= daterange.unix_date_in_range )
  then 'New' else 'Existing' end as newness,  
count(distinct(customer_id)) unique_customers,
count(distinct(order_number)) orders,
sum(final_quantity) quantity,
sum(final_price) revenue,
count(distinct(d)) days_sold
FROM daterange
JOIN transactions
ON transactions.d > ( daterange.unix_date_in_range - 90 )
AND transactions.d <= daterange.unix_date_in_range
group by date_in_range, unix_date_in_range, client, sku, product_type, newness

UNION ALL

SELECT 
client,
'YoY 30' as date_range,
sku, 
product_type,
date_in_range date,
unix_date_in_range,
case when 
  ( first_purchase_unix_date > ( daterange.unix_date_in_range - 730 ) and first_purchase_unix_date <= ( daterange.unix_date_in_range - 365 ))
  then 'New' else 'Existing' end as newness,   
count(distinct(customer_id)) unique_customers,
count(distinct(order_number)) orders,
sum(final_quantity) quantity,
sum(final_price) revenue,
count(distinct(d)) days_sold
FROM daterange
JOIN transactions
ON transactions.d > ( daterange.unix_date_in_range - 395 )
AND transactions.d <= ( daterange.unix_date_in_range - 365 )
group by date_in_range, unix_date_in_range, client, sku, product_type, newness
2018-04-18 08:51:34,992: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108771320>]}
2018-04-18 08:51:35,196: 08:51:35 | 46 of 91 OK created table model agency_data_pipeline.order_paths_proc [CREATE TABLE in 4.08s]
2018-04-18 08:51:39,377: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109205f28>]}
2018-04-18 08:51:39,708: 08:51:39 | 48 of 91 OK created table model agency_data_pipeline.products_proc... [CREATE TABLE in 8.46s]
2018-04-18 08:52:09,434: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1039670f0>]}
2018-04-18 08:52:10,060: 08:52:10 | 47 of 91 OK created table model agency_data_pipeline.customers_products_proc [CREATE TABLE in 38.53s]
2018-04-18 08:52:10,062: 08:52:10 | 49 of 91 START table model agency_data_pipeline.segment_proc_sku..... [RUN]
2018-04-18 08:52:10,062: Compiling model.agency_data_pipeline.segment_proc_sku
2018-04-18 08:52:10,069: Writing injected SQL for node "model.agency_data_pipeline.segment_proc_sku"
2018-04-18 08:52:10,062: 08:52:10 | 50 of 91 START table model agency_data_pipeline.order_paths_agg...... [RUN]
2018-04-18 08:52:10,070: Compiling model.agency_data_pipeline.order_paths_agg
2018-04-18 08:52:10,074: Writing injected SQL for node "model.agency_data_pipeline.order_paths_agg"
2018-04-18 08:52:10,075: Acquiring new bigquery connection "segment_proc_sku".
2018-04-18 08:52:10,075: Re-using an available connection from the pool.
2018-04-18 08:52:10,076: Acquiring new bigquery connection "order_paths_agg".
2018-04-18 08:52:10,076: Re-using an available connection from the pool.
2018-04-18 08:52:10,733: Model SQL (segment_proc_sku):
SELECT
client,
period,
sku, 
product_type,
date,
unique_customers,
orders,
quantity,
revenue,
case 
	when avg_daily_revenue >= avg_daily_revenue_90pct and avg_daily_quantity >= avg_daily_quantity_80pct then 'Best Seller'
	when avg_daily_revenue >= avg_daily_revenue_70pct and avg_daily_quantity >= avg_daily_quantity_40pct then 'Good'
	when avg_daily_revenue < avg_daily_revenue_70pct and avg_daily_revenue >= avg_daily_revenue_30pct and avg_daily_quantity < avg_daily_quantity_70pct then 'Average'
	when avg_daily_revenue < avg_daily_revenue_30pct and avg_daily_quantity < avg_daily_quantity_30pct then 'Poor'
	else 'Unbucketed' end as segment,
newness,	
avg_daily_revenue_90pct,
avg_daily_revenue_70pct,
avg_daily_revenue_30pct,
avg_daily_quantity_80pct,
avg_daily_quantity_70pct,
avg_daily_quantity_40pct,
avg_daily_quantity_30pct

FROM (

	SELECT
	client,
	period,
	sku, 
	product_type,
	newness,
	date,
	unique_customers,
	orders,
	quantity,
	revenue,
	days_sold,
	avg_daily_revenue,
	avg_daily_quantity,
	PERCENTILE_CONT(avg_daily_revenue, 0.90) OVER w1 AS avg_daily_revenue_90pct,
	PERCENTILE_CONT(avg_daily_revenue, 0.70) OVER w1 AS avg_daily_revenue_70pct,
	PERCENTILE_CONT(avg_daily_revenue, 0.3) OVER w1 AS avg_daily_revenue_30pct,
	PERCENTILE_CONT(avg_daily_quantity, 0.90) OVER w1 AS avg_daily_quantity_80pct,
	PERCENTILE_CONT(avg_daily_quantity, 0.90) OVER w1 AS avg_daily_quantity_70pct,
	PERCENTILE_CONT(avg_daily_quantity, 0.70) OVER w1 AS avg_daily_quantity_40pct,
	PERCENTILE_CONT(avg_daily_quantity, 0.3) OVER w1 AS avg_daily_quantity_30pct

	FROM
	(
		SELECT 
		client,
		period,
		sku, 
		product_type,
		newness,
		date,
		unique_customers,
		orders,
		quantity,
		revenue,
		days_sold,
		case when days_sold > 0 then revenue/days_sold else null end as avg_daily_revenue,
		case when days_sold > 0 then quantity/days_sold else null end as avg_daily_quantity
		FROM `growth-engines-pipeline`.`agency_data_pipeline`.`products_proc`
	)
	WINDOW w1 as (PARTITION BY client, period, date)
)
2018-04-18 08:52:10,820: Model SQL (order_paths_agg):
SELECT
client, 
first_product_type,
second_product_type,
first_purchase_date,
count(distinct(customer_id)) customer_count, 
count(distinct(second_order_number)) second_orders, 
count(distinct(third_order_number)) third_orders, 
count(distinct(fourth_order_number)) fourth_orders, 
count(distinct(fifth_order_number)) fifth_orders, 
sum(date_diff(second_purchase_date, first_purchase_date, DAY)) second_order_latency_days,
sum(date_diff(third_purchase_date, second_purchase_date, DAY)) third_order_latency_days,
sum(date_diff(fourth_purchase_date, third_purchase_date, DAY)) fourth_order_latency_days,
sum(date_diff(fifth_purchase_date, fourth_purchase_date, DAY)) fifth_order_latency_days,
sum(first_order_value) first_order_revenue,
sum(second_order_value) second_order_revenue
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`order_paths_proc`
where second_product_type is not null
GROUP BY client, first_product_type, second_product_type, first_purchase_date
2018-04-18 08:52:12,903: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106dfd4e0>]}
2018-04-18 08:52:12,997: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106dfd438>]}
2018-04-18 08:52:13,200: 08:52:13 | 49 of 91 OK created table model agency_data_pipeline.segment_proc_sku [CREATE TABLE in 2.84s]
2018-04-18 08:52:13,481: 08:52:13 | 50 of 91 OK created table model agency_data_pipeline.order_paths_agg. [CREATE TABLE in 2.93s]
2018-04-18 08:52:13,482: 08:52:13 | 51 of 91 START table model agency_data_pipeline.agg_transaction...... [RUN]
2018-04-18 08:52:13,482: 08:52:13 | 52 of 91 START table model agency_data_pipeline.segment_proc_customers_products [RUN]
2018-04-18 08:52:13,482: 08:52:13 | 53 of 91 START table model agency_data_pipeline.segment_stats_sku.... [RUN]
2018-04-18 08:52:13,483: 08:52:13 | 54 of 91 START table model agency_data_pipeline.agg_ga_transaction... [RUN]
2018-04-18 08:52:13,483: Compiling model.agency_data_pipeline.agg_transaction
2018-04-18 08:52:13,483: Compiling model.agency_data_pipeline.segment_proc_customers_products
2018-04-18 08:52:13,483: Compiling model.agency_data_pipeline.segment_stats_sku
2018-04-18 08:52:13,483: Compiling model.agency_data_pipeline.agg_ga_transaction
2018-04-18 08:52:13,493: Writing injected SQL for node "model.agency_data_pipeline.agg_transaction"
2018-04-18 08:52:13,510: Writing injected SQL for node "model.agency_data_pipeline.segment_proc_customers_products"
2018-04-18 08:52:13,520: Writing injected SQL for node "model.agency_data_pipeline.segment_stats_sku"
2018-04-18 08:52:13,522: Writing injected SQL for node "model.agency_data_pipeline.agg_ga_transaction"
2018-04-18 08:52:13,523: Acquiring new bigquery connection "segment_stats_sku".
2018-04-18 08:52:13,524: Acquiring new bigquery connection "agg_transaction".
2018-04-18 08:52:13,524: Re-using an available connection from the pool.
2018-04-18 08:52:13,525: Acquiring new bigquery connection "segment_proc_customers_products".
2018-04-18 08:52:13,525: Acquiring new bigquery connection "agg_ga_transaction".
2018-04-18 08:52:13,525: Re-using an available connection from the pool.
2018-04-18 08:52:13,527: Re-using an available connection from the pool.
2018-04-18 08:52:13,528: Re-using an available connection from the pool.
2018-04-18 08:52:14,216: Model SQL (segment_stats_sku):
WITH last_30 as (

	SELECT
	client,
	sku, 
	product_type,
	date,
	unique_customers as customers_30,
	orders as orders_30,
	revenue as revenue_30,
	segment as segment_30,
	newness as newness_30,
	0 as customers_90,
	0 as orders_90,
	0 as revenue_90,
	'' as segment_90,
	0 as customers_yoy_30,
	0 as orders_yoy_30,
	0 as revenue_yoy_30,
	'' as segment_yoy_30
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_sku`
	WHERE period = 'Last 30'

),

last_90 as (

	SELECT
	client,
	sku, 
	product_type,
	date,
	0 as customers_30,
	0 as orders_30,
	0 as revenue_30,
	'' as segment_30,
	'' as newness_30,
	unique_customers as customers_90,
	orders as orders_90,
	revenue as revenue_90,
	segment as segment_90,
	0 as customers_yoy_30,
	0 as orders_yoy_30,
	0 as revenue_yoy_30,
	'' as segment_yoy_30
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_sku`
	WHERE period = 'Last 90'

),

yoy_30 as (

	SELECT
	client,
	sku, 
	product_type,
	date,
	0 as customers_30,
	0 as orders_30,
	0 as revenue_30,
	'' as segment_30,
	'' as newness_30,
	0 as customers_90,
	0 as orders_90,
	0 as revenue_90,
	'' as segment_90,
	unique_customers as customers_yoy_30,
	orders as orders_yoy_30,
	revenue as revenue_yoy_30,
	segment as segment_yoy_30
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_sku`
	WHERE period = 'YoY 30'

)

SELECT
client,
sku, 
product_type,
date,
ifnull(sum(customers_30), 0) customers_30,
ifnull(sum(orders_30), 0) orders_30,
ifnull(sum(revenue_30), 0) revenue_30,
ifnull(max(segment_30), '') segment_30,
ifnull(sum(customers_90), 0) customers_90,
ifnull(sum(orders_90), 0) orders_90,
ifnull(sum(revenue_90), 0) revenue_90,
ifnull(max(segment_90),'') segment_90,
ifnull(sum(customers_yoy_30), 0) customers_yoy_30,
ifnull(sum(orders_yoy_30), 0) orders_yoy_30,
ifnull(sum(revenue_yoy_30), 0) revenue_yoy_30,
case when max(newness_30) = 'New' then 'New'
	else ifnull(max(segment_yoy_30), '') end as segment_yoy_30
FROM
(
	SELECT * FROM last_30
	UNION ALL
	SELECT * FROM last_90
	UNION ALL
	SELECT * FROM yoy_30

)
GROUP BY client, sku, product_type, date
2018-04-18 08:52:14,254: Model SQL (segment_proc_customers_products):
SELECT
client,
period,
date,
customer_id,
first_order_date,
first_order_unix_date,
product_type,
recency_days,
frequency,
revenue,
quantity,
aov,
case when recency_days <= 30 and first_order_unix_date >= window_start_unix_date then 'New'
	when frequency = 1 and recency_days <= 90 and aov >= aov_40pct then 'Promising'
	when frequency = 1 then 'One-time Purchaser'
	when frequency >= frequency_90pct and recency_days <= 90 and aov > aov_40pct then 'Whale'
	when recency_days <= 240 and frequency > frequency_50pct then 'Loyal'
	when recency_days <= 90 and frequency > frequency_50pct then 'Potential Loyalists' 
	when recency_days > 240 and frequency > frequency_50pct then 'Defecting Good Customer'	
	when recency_days > recency_50pct and frequency > frequency_50pct then 'Frequent, not Recent'
	when recency_days < recency_50pct and frequency < frequency_50pct then 'Recent, not Frequent'
	else 'Unbucketed' end as segment,
aov_40pct,
frequency_90pct,
frequency_75pct,
frequency_50pct,
recency_90pct,
recency_75pct,
recency_50pct
FROM
(
	SELECT 
	a.client client,
	period,
	date,
	a.customer_id customer_id,
	a.product_type product_type,
	b.first_order_date first_order_date,
	b.first_order_unix_date first_order_unix_date,
	window_start_unix_date,
	window_end_unix_date,	
	recency_days,
	frequency,
	revenue,
	quantity,
	aov,
	PERCENTILE_CONT(aov, 0.40) OVER w1 AS aov_40pct,
	PERCENTILE_CONT(frequency, 0.90) OVER w1 AS frequency_90pct,
	PERCENTILE_CONT(frequency, 0.75) OVER w1 AS frequency_75pct,
	PERCENTILE_CONT(frequency, 0.90) OVER w1 AS frequency_50pct,
	PERCENTILE_CONT(recency_days, 0.10) OVER w1 AS recency_90pct,
	PERCENTILE_CONT(recency_days, 0.25) OVER w1 AS recency_75pct,
	PERCENTILE_CONT(recency_days, 0.5) OVER w1 AS recency_50pct
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`customers_products_proc` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`customers_first_purchase_product_type_proc` b
	ON (
		a.client = b.client and
		a.customer_id = b.customer_id and
		a.product_type = b.product_type
		)
	WINDOW w1 as (PARTITION BY a.client, period, date, a.product_type)
)
2018-04-18 08:52:14,316: Model SQL (agg_ga_transaction):
#done - lookup customer id from transaction id from orders
#done - tag an order as 'new' or 'existing' based on transaction id
#sum lifetime value of that customer id
#first order value for customer
#read from agg_ga_transaction into agg_ga_campaign instead of directly from ga_transactions and ga_mcf_stats


with ga as (

    select 
        date, 
        client, 
        'Last-touch' as attribution,
        channel, 
        platform, 
        url, 
        campaign, 
        transactionid,
        last_touch_transactions transactions, 
        last_touch_revenue + ifnull(last_touch_shipping, 0) + ifnull(last_touch_tax, 0) as revenue
    from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_transactions`

),

ga_mcf as (

    select 
        date, 
        client, 
        'First-touch' as attribution,
        channel, 
        platform, 
        '' as url,
        campaign, 
        transactionid, 
        first_touch_transactions as transactions,
        first_touch_revenue as revenue
    from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_mcf_stats`

)


SELECT
    date, 
    a.client client,
    attribution,
    transactionid,
    b.customer_id customer_id,
    b.order_type order_type,
    b.first_order_revenue first_order_revenue,
    b.lifetime_revenue lifetime_revenue,
    channel,
    platform,
    url,
    campaign,
    transactions,
    revenue
FROM (
    SELECT * FROM ga
    UNION ALL
    SELECT * FROM ga_mcf
) a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`customers_by_transaction` b
ON (
    a.client = b.client AND
    a.transactionid = b.order_number
)
2018-04-18 08:52:14,456: Model SQL (agg_transaction):
SELECT
client,
date,
customer_id,
order_number,
last_touch_channel,
last_touch_platform,
last_touch_url,
first_touch_channel, 
first_touch_platform, 
first_touch_utm_campaign,
ifnull( sum(last_touch_transactions), 0) last_touch_transactions, 
ifnull( sum(last_touch_revenue), 0) last_touch_revenue, 
ifnull( sum(first_touch_transactions), 0) first_touch_transactions, 
ifnull( sum(first_touch_revenue), 0) first_touch_revenue,
ifnull( sum(final_quantity), 0) quantity,
ifnull( sum(final_price), 0) revenue,
ifnull( sum(shipping_price), 0) shipping_revenue,
ROW_NUMBER() OVER (PARTITION BY client, customer_id, order_number ORDER BY date asc) AS order_sequence
FROM
(
	SELECT
	a.client,
	a.date date,
	b.date ga_date,
	a.customer_id,
	a.order_number,
	transactionid,
	b.last_touch_channel,
	b.last_touch_platform,
	b.last_touch_url,
	b.first_touch_channel, 
	b.first_touch_platform, 
	b.first_touch_utm_campaign, 
	last_touch_transactions, 
	last_touch_revenue, 
	first_touch_transactions, 
	first_touch_revenue,
	final_quantity,
	final_price,
	shipping_price
	FROM
	`growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_order_number` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`agg_ga_transaction_order_number` b
	ON (
		a.client = b.client and
		a.order_number = b.transactionid
	)

)
GROUP BY
client, 
date, 
customer_id,
order_number, 
last_touch_channel,
last_touch_platform,
last_touch_url,
first_touch_channel, 
first_touch_platform, 
first_touch_utm_campaign
2018-04-18 08:52:16,467: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1091c0588>]}
2018-04-18 08:52:16,768: 08:52:16 | 53 of 91 OK created table model agency_data_pipeline.segment_stats_sku [CREATE TABLE in 2.98s]
2018-04-18 08:52:19,764: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109202b00>]}
2018-04-18 08:52:19,982: 08:52:19 | 54 of 91 OK created table model agency_data_pipeline.agg_ga_transaction [CREATE TABLE in 6.28s]
2018-04-18 08:52:20,971: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109205e48>]}
2018-04-18 08:52:21,267: 08:52:21 | 51 of 91 OK created table model agency_data_pipeline.agg_transaction. [CREATE TABLE in 7.49s]
2018-04-18 08:52:39,695: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1087715f8>]}
2018-04-18 08:52:39,948: 08:52:39 | 52 of 91 OK created table model agency_data_pipeline.segment_proc_customers_products [CREATE TABLE in 26.21s]
2018-04-18 08:52:39,949: 08:52:39 | 55 of 91 START table model agency_data_pipeline.customers_first_purchase_proc [RUN]
2018-04-18 08:52:39,950: Compiling model.agency_data_pipeline.customers_first_purchase_proc
2018-04-18 08:52:39,950: 08:52:39 | 56 of 91 START table model agency_data_pipeline.segment_stats_category [RUN]
2018-04-18 08:52:39,957: Compiling model.agency_data_pipeline.segment_stats_category
2018-04-18 08:52:39,964: Writing injected SQL for node "model.agency_data_pipeline.customers_first_purchase_proc"
2018-04-18 08:52:39,965: Writing injected SQL for node "model.agency_data_pipeline.segment_stats_category"
2018-04-18 08:52:39,950: 08:52:39 | 57 of 91 START table model agency_data_pipeline.segment_stats_customers_products_agg [RUN]
2018-04-18 08:52:39,966: Compiling model.agency_data_pipeline.segment_stats_customers_products_agg
2018-04-18 08:52:39,971: Writing injected SQL for node "model.agency_data_pipeline.segment_stats_customers_products_agg"
2018-04-18 08:52:39,950: 08:52:39 | 58 of 91 START table model agency_data_pipeline.agg_ga_campaign_by_type [RUN]
2018-04-18 08:52:39,972: Compiling model.agency_data_pipeline.agg_ga_campaign_by_type
2018-04-18 08:52:39,977: Writing injected SQL for node "model.agency_data_pipeline.agg_ga_campaign_by_type"
2018-04-18 08:52:39,978: Acquiring new bigquery connection "segment_stats_customers_products_agg".
2018-04-18 08:52:39,978: Re-using an available connection from the pool.
2018-04-18 08:52:39,982: Acquiring new bigquery connection "agg_ga_campaign_by_type".
2018-04-18 08:52:39,986: Re-using an available connection from the pool.
2018-04-18 08:52:39,984: Acquiring new bigquery connection "segment_stats_category".
2018-04-18 08:52:39,989: Re-using an available connection from the pool.
2018-04-18 08:52:39,986: Acquiring new bigquery connection "customers_first_purchase_proc".
2018-04-18 08:52:39,993: Re-using an available connection from the pool.
2018-04-18 08:52:42,704: Model SQL (agg_ga_campaign_by_type):
with orders_new as (
    select 
    date, 
    client, 
    attribution,
    channel, 
    platform, 
    url, 
    campaign,
    count(distinct(customer_id)) customers_new,
    sum(transactions) transactions_new,
    sum(revenue) revenue_new,
    sum(first_order_revenue) first_order_revenue_new,
    sum(lifetime_revenue) lifetime_revenue_new,
    null as customers_total,
    null as transactions_total,
    null as revenue_total
    from `growth-engines-pipeline`.`agency_data_pipeline`.`agg_ga_transaction`
    where order_type = 'New'
    group by date, client, attribution, channel, platform, url, campaign
),
    
orders_total as (
    select 
    date, 
    client, 
    attribution,
    channel, 
    platform, 
    url, 
    campaign,
    null as customers_new,
    null as transactions_new,
    null as revenue_new,
    null as first_order_revenue_new,
    null as lifetime_revenue_new,
    count(distinct(customer_id)) customers_total,
    sum(transactions) transactions_total,
    sum(revenue) revenue_total
    from `growth-engines-pipeline`.`agency_data_pipeline`.`agg_ga_transaction`
    group by date, client, attribution, channel, platform, url, campaign

)

SELECT 
date, 
client, 
attribution,
channel, 
platform, 
url, 
campaign,
sum(customers_new) customers_new,
sum(transactions_new) transactions_new,
sum(revenue_new) revenue_new,
sum(first_order_revenue_new) first_order_revenue_new,
sum(lifetime_revenue_new) lifetime_revenue_new,
sum(customers_total) customers_total,
sum(transactions_total) transactions_total,
sum(revenue_total) revenue_total
from
    ( 
        SELECT * FROM orders_new
        UNION ALL 
        SELECT * FROM orders_total
    )
group by date, client, attribution, channel, platform, url, campaign
2018-04-18 08:52:42,705: Model SQL (segment_stats_customers_products_agg):
WITH ty as (

	SELECT
	client,
	date,
	customer_id,
	product_type,
	segment as segment_365,
	recency_days as recency_365,
	frequency as frequency_365,
	revenue as revenue_365,
	aov as aov_365,
	'' as segment_mom,
	0 as recency_mom,
	0 as frequency_mom,
	0 as revenue_mom,
	0 as aov_mom,
	'' as segment_yoy,
	0 as recency_yoy,
	0 as frequency_yoy,
	0 as revenue_yoy,
	0 as aov_yoy
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers_products`
	WHERE period = 'Rolling 365'

),

last_month as (

	SELECT
	client,
	date,
	customer_id,
	product_type,
	'' as segment_365,
	0 as recency_365,
	0 as frequency_365,
	0 as revenue_365,
	0 as aov_365,
	segment as segment_mom,
	recency_days as recency_mom,
	frequency as frequency_mom,
	revenue as revenue_mom,
	aov as aov_mom,
	'' as segment_yoy,
	0 as recency_yoy,
	0 as frequency_yoy,
	0 as revenue_yoy,
	0 as aov_yoy
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers_products`
	WHERE period = 'Rolling 365 (t-1mo)'

),

this_month_1yr as (

	SELECT
	client,
	date,
	customer_id,
	product_type,
	'' as segment_365,
	0 as recency_365,
	0 as frequency_365,
	0 as revenue_365,
	0 as aov_365,
	'' as segment_mom,
	0 as recency_mom,
	0 as frequency_mom,
	0 as revenue_mom,
	0 as aov_mom,
	segment as segment_yoy,
	recency_days as recency_yoy,
	frequency as frequency_yoy,
	revenue as revenue_yoy,
	aov as aov_yoy
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers_products`
	WHERE period = 'Rolling 365 (t-1yr)'


)

SELECT
client,
date, 
customer_id,
product_type,
ifnull(max(segment_365), '') segment_365,
ifnull(max(segment_mom), '') segment_mom,
ifnull(max(segment_yoy), '') segment_yoy,
ifnull(sum(recency_365), 0) recency_365,
ifnull(sum(frequency_365), 0) frequency_365,
ifnull(sum(revenue_365), 0) revenue_365,
ifnull(sum(aov_365), 0) aov_365,
ifnull(sum(recency_mom), 0) recency_mom,
ifnull(sum(frequency_mom), 0) frequency_mom,
ifnull(sum(revenue_mom), 0) revenue_mom,
ifnull(sum(aov_mom), 0) aov_mom,	
ifnull(sum(recency_yoy), 0) recency_yoy,
ifnull(sum(frequency_yoy), 0) frequency_yoy,
ifnull(sum(revenue_yoy), 0) revenue_yoy,
ifnull(sum(aov_yoy), 0) aov_yoy
FROM
(
	SELECT * FROM ty
	UNION ALL
	SELECT * FROM last_month
	UNION ALL
	SELECT * FROM this_month_1yr

)
GROUP BY client, date, customer_id, product_type
2018-04-18 08:52:42,737: Model SQL (customers_first_purchase_proc):
SELECT 
client, 
customer_id, 
min(cast(date as date)) first_order_date,
unix_date( min(cast(date as date))) first_order_unix_date
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction`
GROUP BY client, customer_id
2018-04-18 08:52:42,877: Model SQL (segment_stats_category):
SELECT
client,
product_type,
date,
segment_30,
segment_90,
segment_yoy_30,
ifnull(sum(customers_30), 0) customers_30,
ifnull(sum(orders_30), 0) orders_30,
ifnull(sum(revenue_30), 0) revenue_30,
ifnull(sum(customers_90), 0) customers_90,
ifnull(sum(orders_90), 0) orders_90,
ifnull(sum(revenue_90), 0) revenue_90,
ifnull(sum(customers_yoy_30), 0) customers_yoy_30,
ifnull(sum(orders_yoy_30), 0) orders_yoy_30,
ifnull(sum(revenue_yoy_30), 0) revenue_yoy_30
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`segment_stats_sku`
GROUP BY client, product_type, date, segment_30, segment_90, segment_yoy_30
2018-04-18 08:52:45,646: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106df32e8>]}
2018-04-18 08:52:45,696: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1087832b0>]}
2018-04-18 08:52:45,855: 08:52:45 | 55 of 91 OK created table model agency_data_pipeline.customers_first_purchase_proc [CREATE TABLE in 5.70s]
2018-04-18 08:52:45,856: 08:52:45 | 59 of 91 START table model agency_data_pipeline.agg_transaction_daily [RUN]
2018-04-18 08:52:45,857: Compiling model.agency_data_pipeline.agg_transaction_daily
2018-04-18 08:52:45,867: Writing injected SQL for node "model.agency_data_pipeline.agg_transaction_daily"
2018-04-18 08:52:45,870: Acquiring new bigquery connection "agg_transaction_daily".
2018-04-18 08:52:45,870: Re-using an available connection from the pool.
2018-04-18 08:52:46,152: 08:52:46 | 56 of 91 OK created table model agency_data_pipeline.segment_stats_category [CREATE TABLE in 5.74s]
2018-04-18 08:52:46,153: 08:52:46 | 60 of 91 START table model agency_data_pipeline.order_paths_stats.... [RUN]
2018-04-18 08:52:46,153: Compiling model.agency_data_pipeline.order_paths_stats
2018-04-18 08:52:46,161: Writing injected SQL for node "model.agency_data_pipeline.order_paths_stats"
2018-04-18 08:52:46,162: Acquiring new bigquery connection "order_paths_stats".
2018-04-18 08:52:46,162: Re-using an available connection from the pool.
2018-04-18 08:52:48,427: Model SQL (order_paths_stats):
WITH transactions AS (
  SELECT 
  client, 
  first_product_type,
  second_product_type,
  first_purchase_date,
  customer_count,
  second_orders,
  third_orders,
  fourth_orders,
  fifth_orders,
  second_order_latency_days,
  third_order_latency_days,
  fourth_order_latency_days,
  fifth_order_latency_days,
  first_order_revenue,
  second_order_revenue,
  unix_date(cast(first_purchase_date as date)) d
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`order_paths_agg`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)

SELECT 
client,
'Rolling 365' as period,
first_product_type,
second_product_type,
date_in_range date,
unix_date_in_range, 
sum(customer_count) customer_count,
sum(second_orders) second_orders,
sum(third_orders) third_orders,
sum(fourth_orders) fourth_orders,
sum(fifth_orders) fifth_orders,
sum(second_order_latency_days) second_order_latency_days,
sum(third_order_latency_days) third_order_latency_days,
sum(fourth_order_latency_days) fourth_order_latency_days,
sum(fifth_order_latency_days) fifth_order_latency_days,
sum(first_order_revenue) first_order_revenue,
sum(second_order_revenue) second_order_revenue
FROM daterange
JOIN transactions
ON transactions.d > ( daterange.unix_date_in_range - 365 )
AND transactions.d <= daterange.unix_date_in_range
group by client, first_product_type, second_product_type, date_in_range, unix_date_in_range
2018-04-18 08:52:48,475: Model SQL (agg_transaction_daily):
SELECT
client,
date,
customer_id,
sum(last_touch_transactions) last_touch_transactions, 
sum(last_touch_revenue) last_touch_revenue, 
sum(first_touch_transactions) first_touch_transactions, 
sum(first_touch_revenue) first_touch_revenue,
sum(quantity) quantity,
sum(revenue) revenue,
count(distinct(order_number)) order_count
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction`
GROUP BY
client, 
date, 
customer_id
2018-04-18 08:52:49,715: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1091b7358>]}
2018-04-18 08:52:50,000: 08:52:50 | 58 of 91 OK created table model agency_data_pipeline.agg_ga_campaign_by_type [CREATE TABLE in 9.74s]
2018-04-18 08:52:51,202: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106d83b38>]}
2018-04-18 08:52:51,498: 08:52:51 | 60 of 91 OK created table model agency_data_pipeline.order_paths_stats [CREATE TABLE in 5.05s]
2018-04-18 08:52:55,624: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1092020b8>]}
2018-04-18 08:52:55,922: 08:52:55 | 59 of 91 OK created table model agency_data_pipeline.agg_transaction_daily [CREATE TABLE in 9.77s]
2018-04-18 08:53:05,920: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1092026d8>]}
2018-04-18 08:53:06,210: 08:53:06 | 57 of 91 OK created table model agency_data_pipeline.segment_stats_customers_products_agg [CREATE TABLE in 25.95s]
2018-04-18 08:53:06,211: 08:53:06 | 61 of 91 START table model agency_data_pipeline.customers_proc....... [RUN]
2018-04-18 08:53:06,212: Compiling model.agency_data_pipeline.customers_proc
2018-04-18 08:53:06,211: 08:53:06 | 62 of 91 START table model agency_data_pipeline.growth_customer_0_365 [RUN]
2018-04-18 08:53:06,222: Writing injected SQL for node "model.agency_data_pipeline.customers_proc"
2018-04-18 08:53:06,211: 08:53:06 | 63 of 91 START table model agency_data_pipeline.segment_stats_customers_products [RUN]
2018-04-18 08:53:06,222: Compiling model.agency_data_pipeline.growth_customer_0_365
2018-04-18 08:53:06,222: Compiling model.agency_data_pipeline.segment_stats_customers_products
2018-04-18 08:53:06,228: Writing injected SQL for node "model.agency_data_pipeline.growth_customer_0_365"
2018-04-18 08:53:06,232: Writing injected SQL for node "model.agency_data_pipeline.segment_stats_customers_products"
2018-04-18 08:53:06,233: Acquiring new bigquery connection "customers_proc".
2018-04-18 08:53:06,234: Re-using an available connection from the pool.
2018-04-18 08:53:06,237: Acquiring new bigquery connection "growth_customer_0_365".
2018-04-18 08:53:06,239: Re-using an available connection from the pool.
2018-04-18 08:53:06,239: Acquiring new bigquery connection "segment_stats_customers_products".
2018-04-18 08:53:06,244: Re-using an available connection from the pool.
2018-04-18 08:53:07,100: Model SQL (segment_stats_customers_products):
SELECT
client,
date,
product_type,
segment_365,
segment_mom,
segment_yoy,
count(distinct(customer_id)) customers,
avg(recency_365) recency_365,
sum(frequency_365) frequency_365,
sum(revenue_365) revenue_365,
case when sum(frequency_365) > 0 then sum(revenue_365)/sum(frequency_365) else null end as aov_365,
avg(recency_mom) recency_mom,
sum(frequency_mom) frequency_mom,
sum(revenue_mom) revenue_mom,
case when sum(frequency_mom) > 0 then sum(revenue_mom)/sum(frequency_mom) else null end as aov_mom,
avg(recency_yoy) recency_yoy,
sum(frequency_yoy) frequency_yoy,
sum(revenue_yoy) revenue_yoy,
case when sum(frequency_yoy) > 0 then sum(revenue_yoy)/sum(frequency_yoy) else null end as aov_yoy
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_stats_customers_products_agg`
GROUP BY client, date, product_type, segment_365, segment_mom, segment_yoy
2018-04-18 08:53:07,101: Model SQL (growth_customer_0_365):
WITH transactions AS (
  SELECT 
  client, 
  customer_id, 
  order_number,
  unix_date(cast(date as date)) d, 
  quantity,
  revenue,
  shipping_revenue
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)

SELECT 
date_in_range date,
unix_date_in_range, 
unix_date_in_range_yoy, 
client, 
customer_id,
count(distinct(order_number)) orders,
sum(quantity) quantity,
sum(revenue) revenue,
sum(shipping_revenue) shipping_revenue
FROM daterange
JOIN transactions
ON transactions.d >= ( daterange.unix_date_in_range - 365 ) 
AND transactions.d <= daterange.unix_date_in_range
GROUP BY date, unix_date_in_range, unix_date_in_range_yoy, client, customer_id
2018-04-18 08:53:07,129: Model SQL (customers_proc):
WITH customers AS (
  SELECT 
  client, 
  customer_id, 
  order_number,
  cast(date as date) order_date,
  unix_date(cast(date as date)) unix_order_date, 
  quantity,
  revenue 
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)
 
SELECT 
client,
period,
customer_id,
date,
window_end_unix_date,
window_end_unix_date - 365 as window_start_unix_date,
window_end_unix_date - unix_date(recent_order) recency_days,
frequency,
quantity,
revenue,
case when frequency > 0 then revenue/frequency else 0 end as aov
FROM 
(  

  SELECT 
  client,
  'Rolling 365' as period,
  customer_id,
  date_in_range date,
  unix_date_in_range,
  unix_date_in_range window_end_unix_date,
  max(order_date) recent_order,
  sum(quantity) as quantity,
  sum(revenue) as revenue,
  count(distinct(order_number)) as frequency
  FROM daterange
  JOIN customers
  ON customers.unix_order_date > ( daterange.unix_date_in_range - 365 )
  AND customers.unix_order_date <= daterange.unix_date_in_range
  GROUP BY client, customer_id, date, unix_date_in_range

  UNION ALL

  SELECT 
  client,
  'Rolling 365 (t-1mo)' as period,
  customer_id,
  date_in_range date,
  unix_date_in_range,
  unix_date_in_range - 30 window_end_unix_date, 
  max(order_date) recent_order,
  sum(quantity) as quantity,
  sum(revenue) as revenue,
  count(distinct(order_number)) as frequency
  FROM daterange
  JOIN customers
  ON customers.unix_order_date > ( daterange.unix_date_in_range - 395 )
  AND customers.unix_order_date <= ( daterange.unix_date_in_range - 30 )
  GROUP BY client, customer_id, date, unix_date_in_range

  UNION ALL

  SELECT 
  client,
  'Rolling 365 (t-1yr)' as period,
  customer_id,
  date_in_range date,
  unix_date_in_range, 
  unix_date_in_range - 365 window_end_unix_date, 
  max(order_date) recent_order,
  sum(quantity) as quantity,
  sum(revenue) as revenue,
  count(distinct(order_number)) as frequency
  FROM daterange
  JOIN customers
  ON customers.unix_order_date > ( daterange.unix_date_in_range - 730 )
  AND customers.unix_order_date <= ( daterange.unix_date_in_range - 365 )
  GROUP BY client, customer_id, date, unix_date_in_range

)
2018-04-18 08:53:19,088: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109205828>]}
2018-04-18 08:53:19,730: 08:53:19 | 63 of 91 OK created table model agency_data_pipeline.segment_stats_customers_products [CREATE TABLE in 12.87s]
2018-04-18 08:53:25,716: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106e4bfd0>]}
2018-04-18 08:53:25,933: 08:53:25 | 62 of 91 OK created table model agency_data_pipeline.growth_customer_0_365 [CREATE TABLE in 19.49s]
2018-04-18 08:53:38,677: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1039700b8>]}
2018-04-18 08:53:38,986: 08:53:38 | 61 of 91 OK created table model agency_data_pipeline.customers_proc.. [CREATE TABLE in 32.47s]
2018-04-18 08:53:38,987: 08:53:38 | 64 of 91 START table model agency_data_pipeline.retention_30_60...... [RUN]
2018-04-18 08:53:38,987: 08:53:38 | 65 of 91 START table model agency_data_pipeline.retention_730_plus... [RUN]
2018-04-18 08:53:38,987: 08:53:38 | 66 of 91 START table model agency_data_pipeline.retention_365_730.... [RUN]
2018-04-18 08:53:38,988: 08:53:38 | 67 of 91 START table model agency_data_pipeline.retention_60_plus.... [RUN]
2018-04-18 08:53:38,988: Compiling model.agency_data_pipeline.retention_30_60
2018-04-18 08:53:38,988: Compiling model.agency_data_pipeline.retention_730_plus
2018-04-18 08:53:38,988: Compiling model.agency_data_pipeline.retention_365_730
2018-04-18 08:53:38,988: Compiling model.agency_data_pipeline.retention_60_plus
2018-04-18 08:53:38,999: Writing injected SQL for node "model.agency_data_pipeline.retention_730_plus"
2018-04-18 08:53:39,000: Writing injected SQL for node "model.agency_data_pipeline.retention_30_60"
2018-04-18 08:53:39,004: Writing injected SQL for node "model.agency_data_pipeline.retention_365_730"
2018-04-18 08:53:39,010: Writing injected SQL for node "model.agency_data_pipeline.retention_60_plus"
2018-04-18 08:53:39,014: Acquiring new bigquery connection "retention_30_60".
2018-04-18 08:53:39,014: Re-using an available connection from the pool.
2018-04-18 08:53:39,015: Acquiring new bigquery connection "retention_365_730".
2018-04-18 08:53:39,016: Re-using an available connection from the pool.
2018-04-18 08:53:39,017: Acquiring new bigquery connection "retention_730_plus".
2018-04-18 08:53:39,018: Re-using an available connection from the pool.
2018-04-18 08:53:39,020: Acquiring new bigquery connection "retention_60_plus".
2018-04-18 08:53:39,023: Re-using an available connection from the pool.
2018-04-18 08:53:39,853: Model SQL (retention_730_plus):
WITH transactions AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_daily`
),

daterange AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`  	
),

temp AS (
  SELECT 
  client, 
  customer_id, 
  unix_date(date) d, 
  quantity,
  revenue,
  order_count
  FROM transactions
)

SELECT 
date_in_range date, 
unix_date_in_range,
client, 
customer_id,
sum(quantity) quantity,
sum(revenue) revenue,
sum(order_count) order_count
FROM daterange
JOIN temp
ON temp.d <= ( daterange.unix_date_in_range - 730 ) 
group by date_in_range, unix_date_in_range, client, customer_id
2018-04-18 08:53:39,882: Model SQL (retention_365_730):
WITH transactions AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_daily`
),

daterange AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`  	
),

temp AS (
  SELECT 
  client, 
  customer_id, 
  unix_date(date) d, 
  quantity,
  revenue,
  order_count
  FROM transactions
)

SELECT 
date_in_range date, 
unix_date_in_range,
client, 
customer_id,
sum(quantity) quantity,
sum(revenue) revenue,
sum(order_count) order_count
FROM daterange
JOIN temp
ON ( temp.d >= ( daterange.unix_date_in_range - 730 ) 
AND temp.d < ( daterange.unix_date_in_range - 365 ) )
group by date_in_range, unix_date_in_range, client, customer_id
2018-04-18 08:53:39,896: Model SQL (retention_60_plus):
WITH transactions AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_daily`
),

daterange AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`  	
),

temp AS (
  SELECT 
  client, 
  customer_id, 
  unix_date(date) d, 
  quantity,
  revenue,
  order_count
  FROM transactions
)

SELECT 
date_in_range date, 
unix_date_in_range,
client, 
customer_id,
sum(quantity) quantity,
sum(revenue) revenue,
sum(order_count) order_count
FROM daterange
JOIN temp
ON temp.d < ( daterange.unix_date_in_range_bom_mom ) 
group by date_in_range, unix_date_in_range, client, customer_id
2018-04-18 08:53:39,943: Model SQL (retention_30_60):
WITH transactions AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_daily`
),

daterange AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`  	
),

temp AS (
  SELECT 
  client, 
  customer_id, 
  unix_date(date) d, 
  quantity,
  revenue,
  order_count
  FROM transactions
)

SELECT 
date_in_range date, 
unix_date_in_range,
client, 
customer_id,
sum(quantity) quantity,
sum(revenue) revenue,
sum(order_count) order_count
FROM daterange
JOIN temp
ON ( temp.d >= ( daterange.unix_date_in_range_bom_mom ) 
AND temp.d < ( daterange.unix_date_in_range_bom ) )
group by date_in_range, unix_date_in_range, client, customer_id
2018-04-18 08:53:42,039: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1091cbc50>]}
2018-04-18 08:53:42,338: 08:53:42 | 65 of 91 OK created table model agency_data_pipeline.retention_730_plus [CREATE TABLE in 3.05s]
2018-04-18 08:53:42,339: 08:53:42 | 68 of 91 START table model agency_data_pipeline.retention_0_365...... [RUN]
2018-04-18 08:53:42,339: Compiling model.agency_data_pipeline.retention_0_365
2018-04-18 08:53:42,347: Writing injected SQL for node "model.agency_data_pipeline.retention_0_365"
2018-04-18 08:53:42,348: Acquiring new bigquery connection "retention_0_365".
2018-04-18 08:53:42,348: Re-using an available connection from the pool.
2018-04-18 08:53:43,100: Model SQL (retention_0_365):
WITH transactions AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_daily`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
),

temp AS (
  SELECT 
  client, 
  customer_id, 
  unix_date(date) d, 
  quantity,
  revenue,
  order_count
  FROM transactions
)

SELECT 
date_in_range date,
unix_date_in_range, 
client, 
customer_id,
sum(quantity) quantity,
sum(revenue) revenue,
sum(order_count) order_count
FROM daterange
JOIN temp
ON temp.d >= ( daterange.unix_date_in_range - 365 ) 
AND temp.d <= daterange.unix_date_in_range
group by date_in_range, unix_date_in_range, client, customer_id
2018-04-18 08:53:43,318: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109205da0>]}
2018-04-18 08:53:43,608: 08:53:43 | 64 of 91 OK created table model agency_data_pipeline.retention_30_60. [CREATE TABLE in 4.33s]
2018-04-18 08:53:43,609: 08:53:43 | 69 of 91 START table model agency_data_pipeline.segment_list_customers_products [RUN]
2018-04-18 08:53:43,609: Compiling model.agency_data_pipeline.segment_list_customers_products
2018-04-18 08:53:43,615: Writing injected SQL for node "model.agency_data_pipeline.segment_list_customers_products"
2018-04-18 08:53:43,620: Acquiring new bigquery connection "segment_list_customers_products".
2018-04-18 08:53:43,620: Re-using an available connection from the pool.
2018-04-18 08:53:44,239: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1091ebe80>]}
2018-04-18 08:53:44,392: Model SQL (segment_list_customers_products):
SELECT
a.client,
period,
date,
customer_id,
product_type,
b.first_name,
b.last_name,
b.email,
recency_days,
frequency,
revenue,
quantity,
aov,
segment
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers_products` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`agg_customers_union` b
ON (
	a.client = b.client AND
	a.customer_id = b.id
)
2018-04-18 08:53:44,488: 08:53:44 | 66 of 91 OK created table model agency_data_pipeline.retention_365_730 [CREATE TABLE in 5.25s]
2018-04-18 08:53:44,488: 08:53:44 | 70 of 91 START table model agency_data_pipeline.retention_0_30....... [RUN]
2018-04-18 08:53:44,489: Compiling model.agency_data_pipeline.retention_0_30
2018-04-18 08:53:44,498: Writing injected SQL for node "model.agency_data_pipeline.retention_0_30"
2018-04-18 08:53:44,500: Acquiring new bigquery connection "retention_0_30".
2018-04-18 08:53:44,500: Re-using an available connection from the pool.
2018-04-18 08:53:45,167: Model SQL (retention_0_30):
WITH transactions AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_daily`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
),

temp AS (
  SELECT 
  client, 
  customer_id, 
  unix_date(date) d, 
  quantity,
  revenue,
  order_count
  FROM transactions
)

SELECT 
date_in_range date,
unix_date_in_range, 
client, 
customer_id,
sum(quantity) quantity,
sum(revenue) revenue,
sum(order_count) order_count
FROM daterange
JOIN temp
ON temp.d >= ( daterange.unix_date_in_range_bom ) 
AND temp.d <= daterange.unix_date_in_range
group by date_in_range, unix_date_in_range, client, customer_id
2018-04-18 08:53:47,554: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1091ebd30>]}
2018-04-18 08:53:47,775: 08:53:47 | 67 of 91 OK created table model agency_data_pipeline.retention_60_plus [CREATE TABLE in 8.57s]
2018-04-18 08:53:48,448: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10879ad68>]}
2018-04-18 08:53:48,670: 08:53:48 | 70 of 91 OK created table model agency_data_pipeline.retention_0_30.. [CREATE TABLE in 3.96s]
2018-04-18 08:53:54,082: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106e4b7f0>]}
2018-04-18 08:53:54,367: 08:53:54 | 68 of 91 OK created table model agency_data_pipeline.retention_0_365. [CREATE TABLE in 11.74s]
2018-04-18 08:54:26,371: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106df3c88>]}
2018-04-18 08:54:27,059: 08:54:27 | 69 of 91 OK created table model agency_data_pipeline.segment_list_customers_products [CREATE TABLE in 42.76s]
2018-04-18 08:54:27,060: 08:54:27 | 71 of 91 START table model agency_data_pipeline.segment_proc_customers [RUN]
2018-04-18 08:54:27,060: 08:54:27 | 72 of 91 START table model agency_data_pipeline.agg_platforms_union.. [RUN]
2018-04-18 08:54:27,061: Compiling model.agency_data_pipeline.segment_proc_customers
2018-04-18 08:54:27,061: Compiling model.agency_data_pipeline.agg_platforms_union
2018-04-18 08:54:27,077: Writing injected SQL for node "model.agency_data_pipeline.segment_proc_customers"
2018-04-18 08:54:27,079: Writing injected SQL for node "model.agency_data_pipeline.agg_platforms_union"
2018-04-18 08:54:27,079: Acquiring new bigquery connection "segment_proc_customers".
2018-04-18 08:54:27,080: Re-using an available connection from the pool.
2018-04-18 08:54:27,081: Acquiring new bigquery connection "agg_platforms_union".
2018-04-18 08:54:27,081: Re-using an available connection from the pool.
2018-04-18 08:54:27,972: Model SQL (agg_platforms_union):
SELECT 
date, 
account, 
channel,
platform,
url,
utm_campaign,
campaign,
cost,
impressions,
clicks,
transactions
FROM 
`growth-engines-pipeline`.`agency_data_pipeline`.`adwords_stats`

UNION ALL

SELECT 
date, 
account, 
channel,
platform,
url,
utm_campaign,
campaign,
cost,
impressions,
clicks,
transactions
FROM 
`growth-engines-pipeline`.`agency_data_pipeline`.`bing_ads_stats`

UNION ALL  

SELECT 
date, 
account, 
channel,
platform,
url,
utm_campaign,
campaign,
cost,
impressions,
clicks,
transactions
FROM 
`growth-engines-pipeline`.`agency_data_pipeline`.`fb_ads_stats`
2018-04-18 08:54:27,979: Model SQL (segment_proc_customers):
SELECT
client,
period,
date,
customer_id,
first_order_date,
first_order_unix_date,
recency_days,
frequency,
revenue,
quantity,
aov,
case when recency_days <= 30 and first_order_unix_date >= window_start_unix_date then 'New'
	when frequency = 1 and recency_days <= 90 and aov >= aov_40pct then 'Promising'
	when frequency = 1 then 'One-time Purchaser'
	when frequency >= frequency_90pct and recency_days <= 90 and aov > aov_40pct then 'Whale'
	when recency_days <= 240 and frequency > frequency_50pct then 'Loyal'
	when recency_days <= 90 and frequency > frequency_50pct then 'Potential Loyalists' 
	when recency_days > 240 and frequency > frequency_50pct then 'Defecting Good Customer'	
	when recency_days > recency_50pct and frequency > frequency_50pct then 'Frequent, not Recent'
	when recency_days < recency_50pct and frequency < frequency_50pct then 'Recent, not Frequent'
	else 'Unbucketed' end as segment,
aov_40pct,
frequency_90pct,
frequency_75pct,
frequency_50pct,
recency_90pct,
recency_75pct,
recency_50pct
FROM
(
	SELECT 
	a.client client,
	period,
	date,
	a.customer_id customer_id,
	b.first_order_date first_order_date,
	b.first_order_unix_date first_order_unix_date,
	window_start_unix_date,
	window_end_unix_date,
	recency_days,
	frequency,
	revenue,
	quantity,
	aov,
	PERCENTILE_CONT(aov, 0.40) OVER w1 AS aov_40pct,
	PERCENTILE_CONT(frequency, 0.90) OVER w1 AS frequency_90pct,
	PERCENTILE_CONT(frequency, 0.75) OVER w1 AS frequency_75pct,
	PERCENTILE_CONT(frequency, 0.90) OVER w1 AS frequency_50pct,
	PERCENTILE_CONT(recency_days, 0.10) OVER w1 AS recency_90pct,
	PERCENTILE_CONT(recency_days, 0.25) OVER w1 AS recency_75pct,
	PERCENTILE_CONT(recency_days, 0.5) OVER w1 AS recency_50pct
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`customers_proc` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`customers_first_purchase_proc` b
	ON (
		a.client = b.client and
		a.customer_id = b.customer_id
		)
	WINDOW w1 as (PARTITION BY a.client, period, date)
)
2018-04-18 08:54:32,318: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106df37f0>]}
2018-04-18 08:54:32,611: 08:54:32 | 72 of 91 OK created table model agency_data_pipeline.agg_platforms_union [CREATE TABLE in 5.26s]
2018-04-18 08:54:58,894: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1091c0940>]}
2018-04-18 08:54:59,186: 08:54:59 | 71 of 91 OK created table model agency_data_pipeline.segment_proc_customers [CREATE TABLE in 31.83s]
2018-04-18 08:54:59,187: 08:54:59 | 73 of 91 START table model agency_data_pipeline.segment_stats_customers_agg [RUN]
2018-04-18 08:54:59,188: Compiling model.agency_data_pipeline.segment_stats_customers_agg
2018-04-18 08:54:59,188: 08:54:59 | 74 of 91 START table model agency_data_pipeline.retention_0_365_rebuy [RUN]
2018-04-18 08:54:59,199: Writing injected SQL for node "model.agency_data_pipeline.segment_stats_customers_agg"
2018-04-18 08:54:59,188: 08:54:59 | 75 of 91 START table model agency_data_pipeline.retention_0_30_rebuy. [RUN]
2018-04-18 08:54:59,199: Compiling model.agency_data_pipeline.retention_0_365_rebuy
2018-04-18 08:54:59,199: Compiling model.agency_data_pipeline.retention_0_30_rebuy
2018-04-18 08:54:59,204: Writing injected SQL for node "model.agency_data_pipeline.retention_0_365_rebuy"
2018-04-18 08:54:59,205: Acquiring new bigquery connection "segment_stats_customers_agg".
2018-04-18 08:54:59,210: Re-using an available connection from the pool.
2018-04-18 08:54:59,211: Acquiring new bigquery connection "retention_0_365_rebuy".
2018-04-18 08:54:59,210: Writing injected SQL for node "model.agency_data_pipeline.retention_0_30_rebuy"
2018-04-18 08:54:59,212: Re-using an available connection from the pool.
2018-04-18 08:54:59,216: Acquiring new bigquery connection "retention_0_30_rebuy".
2018-04-18 08:54:59,217: Re-using an available connection from the pool.
2018-04-18 08:55:00,126: Model SQL (retention_0_365_rebuy):
SELECT 
r2.client,
r2.date,
r2.customer_id, 
r2.quantity,
r2.revenue
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_365_730` r1 
left join `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365` r2 
  on ( r1.customer_id = r2.customer_id 
  and r1.date = r2.date )
2018-04-18 08:55:00,127: Model SQL (retention_0_30_rebuy):
SELECT 
r2.client,
r2.date,
r2.customer_id, 
r2.quantity,
r2.revenue
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_30_60` r1 
left join `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30` r2 
  on ( r1.customer_id = r2.customer_id 
  and r1.date = r2.date )
2018-04-18 08:55:01,010: Model SQL (segment_stats_customers_agg):
WITH ty as (

	SELECT
	client,
	date,
	customer_id,
	segment as segment_365,
	recency_days as recency_365,
	frequency as frequency_365,
	revenue as revenue_365,
	aov as aov_365,
	'' as segment_mom,
	0 as recency_mom,
	0 as frequency_mom,
	0 as revenue_mom,
	0 as aov_mom,
	'' as segment_yoy,
	0 as recency_yoy,
	0 as frequency_yoy,
	0 as revenue_yoy,
	0 as aov_yoy
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers`
	WHERE period = 'Rolling 365'

),

last_month as (

	SELECT
	client,
	date,
	customer_id,
	'' as segment_365,
	0 as recency_365,
	0 as frequency_365,
	0 as revenue_365,
	0 as aov_365,
	segment as segment_mom,
	recency_days as recency_mom,
	frequency as frequency_mom,
	revenue as revenue_mom,
	aov as aov_mom,
	'' as segment_yoy,
	0 as recency_yoy,
	0 as frequency_yoy,
	0 as revenue_yoy,
	0 as aov_yoy
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers`
	WHERE period = 'Rolling 365 (t-1mo)'

),

this_month_1yr as (

	SELECT
	client,
	date,
	customer_id,
	'' as segment_365,
	0 as recency_365,
	0 as frequency_365,
	0 as revenue_365,
	0 as aov_365,
	'' as segment_mom,
	0 as recency_mom,
	0 as frequency_mom,
	0 as revenue_mom,
	0 as aov_mom,
	segment as segment_yoy,
	recency_days as recency_yoy,
	frequency as frequency_yoy,
	revenue as revenue_yoy,
	aov as aov_yoy
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers`
	WHERE period = 'Rolling 365 (t-1yr)'


)

SELECT
client,
date, 
customer_id,
ifnull(max(segment_365), '') segment_365,
ifnull(max(segment_mom), '') segment_mom,
ifnull(max(segment_yoy), '') segment_yoy,
ifnull(sum(recency_365), 0) recency_365,
ifnull(sum(frequency_365), 0) frequency_365,
ifnull(sum(revenue_365), 0) revenue_365,
ifnull(sum(aov_365), 0) aov_365,
ifnull(sum(recency_mom), 0) recency_mom,
ifnull(sum(frequency_mom), 0) frequency_mom,
ifnull(sum(revenue_mom), 0) revenue_mom,
ifnull(sum(aov_mom), 0) aov_mom,	
ifnull(sum(recency_yoy), 0) recency_yoy,
ifnull(sum(frequency_yoy), 0) frequency_yoy,
ifnull(sum(revenue_yoy), 0) revenue_yoy,
ifnull(sum(aov_yoy), 0) aov_yoy
FROM
(
	SELECT * FROM ty
	UNION ALL
	SELECT * FROM last_month
	UNION ALL
	SELECT * FROM this_month_1yr

)
GROUP BY client, date, customer_id
2018-04-18 08:55:02,301: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1091dd080>]}
2018-04-18 08:55:02,507: 08:55:02 | 75 of 91 OK created table model agency_data_pipeline.retention_0_30_rebuy [CREATE TABLE in 3.10s]
2018-04-18 08:55:06,651: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10397eba8>]}
2018-04-18 08:55:06,950: 08:55:06 | 74 of 91 OK created table model agency_data_pipeline.retention_0_365_rebuy [CREATE TABLE in 7.45s]
2018-04-18 08:55:25,226: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106df3c88>]}
2018-04-18 08:55:25,522: 08:55:25 | 73 of 91 OK created table model agency_data_pipeline.segment_stats_customers_agg [CREATE TABLE in 26.04s]
2018-04-18 08:55:25,523: 08:55:25 | 76 of 91 START table model agency_data_pipeline.retention_stats_rebuy_rate [RUN]
2018-04-18 08:55:25,523: 08:55:25 | 77 of 91 START table model agency_data_pipeline.retention_0_30_reactivated [RUN]
2018-04-18 08:55:25,523: 08:55:25 | 78 of 91 START table model agency_data_pipeline.retention_stats_rebuy_rate_month [RUN]
2018-04-18 08:55:25,524: Compiling model.agency_data_pipeline.retention_stats_rebuy_rate
2018-04-18 08:55:25,524: 08:55:25 | 79 of 91 START table model agency_data_pipeline.retention_0_365_reactivated [RUN]
2018-04-18 08:55:25,524: Compiling model.agency_data_pipeline.retention_0_30_reactivated
2018-04-18 08:55:25,524: Compiling model.agency_data_pipeline.retention_stats_rebuy_rate_month
2018-04-18 08:55:25,531: Compiling model.agency_data_pipeline.retention_0_365_reactivated
2018-04-18 08:55:25,535: Writing injected SQL for node "model.agency_data_pipeline.retention_stats_rebuy_rate"
2018-04-18 08:55:25,547: Writing injected SQL for node "model.agency_data_pipeline.retention_stats_rebuy_rate_month"
2018-04-18 08:55:25,549: Writing injected SQL for node "model.agency_data_pipeline.retention_0_30_reactivated"
2018-04-18 08:55:25,553: Writing injected SQL for node "model.agency_data_pipeline.retention_0_365_reactivated"
2018-04-18 08:55:25,555: Acquiring new bigquery connection "retention_stats_rebuy_rate_month".
2018-04-18 08:55:25,555: Re-using an available connection from the pool.
2018-04-18 08:55:25,557: Acquiring new bigquery connection "retention_0_30_reactivated".
2018-04-18 08:55:25,557: Acquiring new bigquery connection "retention_stats_rebuy_rate".
2018-04-18 08:55:25,558: Acquiring new bigquery connection "retention_0_365_reactivated".
2018-04-18 08:55:25,558: Re-using an available connection from the pool.
2018-04-18 08:55:25,560: Re-using an available connection from the pool.
2018-04-18 08:55:25,561: Re-using an available connection from the pool.
2018-04-18 08:55:26,648: Model SQL (retention_stats_rebuy_rate_month):
WITH r1 AS (
	SELECT 
	date,
	client,
	count(distinct customer_id) customers_prior_year,
	0 as customers_current_year, 
	sum(quantity) quantity_prior_year,
	0 as quantity_current_year,
	sum(revenue) revenue_prior_year,
	0 as revenue_current_year,
	case when sum(quantity) > 0 then sum(revenue)/sum(quantity) else null end as aov_prior_year,
	null as aov_current_year
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_30_60`
	group by date, client
),

r2 AS (
	SELECT 
	date,
	client,
	0 as customers_prior_year,
	count(distinct customer_id) customers_current_year, 
	0 as quantity_prior_year,
	sum(quantity) quantity_current_year,
	0 as revenue_prior_year,
	sum(revenue) revenue_current_year,
	null as aov_prior_year,
	case when sum(quantity) > 0 then sum(revenue)/sum(quantity) else null end as aov_current_year
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30_rebuy`
	group by date, client
)

SELECT 
date,
client,
sum(customers_prior_year) customers_prior_year, 
sum(customers_current_year) customers_current_year,
sum(quantity_prior_year) quantity_prior_year,
sum(quantity_current_year) quantity_current_year,
sum(revenue_prior_year) revenue_prior_year,
sum(revenue_current_year) revenue_current_year,
sum(aov_prior_year) aov_prior_year,
sum(aov_current_year) aov_current_year,
case when sum(revenue_prior_year) > 0 then sum(revenue_current_year)/sum(revenue_prior_year) else null end as revenue_retention,
case when sum(customers_prior_year) > 0 then sum(customers_current_year)/sum(customers_prior_year) else null end as customer_retention
FROM
(
	SELECT
	date,
	client,
	customers_prior_year,
	customers_current_year,
	quantity_prior_year,
	quantity_current_year,
	revenue_prior_year,
	revenue_current_year,
	aov_prior_year,
	aov_current_year
	FROM r1

	UNION ALL

	SELECT
	date,
	client,
	customers_prior_year,
	customers_current_year,
	quantity_prior_year,
	quantity_current_year,
	revenue_prior_year,
	revenue_current_year,
	aov_prior_year,
	aov_current_year
	FROM r2

) 
GROUP BY date, client
2018-04-18 08:55:26,649: Model SQL (retention_stats_rebuy_rate):
WITH r1 AS (
	SELECT 
	date,
	client,
	count(distinct customer_id) customers_prior_year,
	0 as customers_current_year, 
	sum(quantity) quantity_prior_year,
	0 as quantity_current_year,
	sum(revenue) revenue_prior_year,
	0 as revenue_current_year,
	case when sum(quantity) > 0 then sum(revenue)/sum(quantity) else null end as aov_prior_year,
	null as aov_current_year
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_365_730`
	group by date, client
),

r2 AS (
	SELECT 
	date,
	client,
	0 as customers_prior_year,
	count(distinct customer_id) customers_current_year, 
	0 as quantity_prior_year,
	sum(quantity) quantity_current_year,
	0 as revenue_prior_year,
	sum(revenue) revenue_current_year,
	null as aov_prior_year,
	case when sum(quantity) > 0 then sum(revenue)/sum(quantity) else null end as aov_current_year
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365_rebuy`
	group by date, client
)

SELECT 
date,
client,
sum(customers_prior_year) customers_prior_year, 
sum(customers_current_year) customers_current_year,
sum(quantity_prior_year) quantity_prior_year,
sum(quantity_current_year) quantity_current_year,
sum(revenue_prior_year) revenue_prior_year,
sum(revenue_current_year) revenue_current_year,
sum(aov_prior_year) aov_prior_year,
sum(aov_current_year) aov_current_year,
case when sum(revenue_prior_year) > 0 then sum(revenue_current_year)/sum(revenue_prior_year) else null end as revenue_retention,
case when sum(customers_prior_year) > 0 then sum(customers_current_year)/sum(customers_prior_year) else null end as customer_retention
FROM
(
	SELECT
	date,
	client,
	customers_prior_year,
	customers_current_year,
	quantity_prior_year,
	quantity_current_year,
	revenue_prior_year,
	revenue_current_year,
	aov_prior_year,
	aov_current_year
	FROM r1

	UNION ALL

	SELECT
	date,
	client,
	customers_prior_year,
	customers_current_year,
	quantity_prior_year,
	quantity_current_year,
	revenue_prior_year,
	revenue_current_year,
	aov_prior_year,
	aov_current_year
	FROM r2

) 
GROUP BY date, client
2018-04-18 08:55:26,656: Model SQL (retention_0_30_reactivated):
SELECT 
a.client,
a.date,
a.customer_id, 
a.quantity,
a.revenue
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_60_plus` b
ON (
	a.client = b.client AND
	a.date = b.date AND
	a.customer_id = b.customer_id
)
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_30_60` c
ON (
	a.client = c.client AND
	a.date = c.date AND
	a.customer_id = c.customer_id
)
WHERE b.customer_id is not null 
AND c.customer_id is null
2018-04-18 08:55:26,692: Model SQL (retention_0_365_reactivated):
SELECT 
a.client,
a.date,
a.customer_id, 
a.quantity,
a.revenue
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_730_plus` b
ON (
	a.client = b.client AND
	a.date = b.date AND
	a.customer_id = b.customer_id
)
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_365_730` c
ON (
	a.client = c.client AND
	a.date = c.date AND
	a.customer_id = c.customer_id
)
WHERE b.customer_id is not null 
AND c.customer_id is null
2018-04-18 08:55:28,857: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108783278>]}
2018-04-18 08:55:28,860: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1091b7518>]}
2018-04-18 08:55:29,561: 08:55:29 | 78 of 91 OK created table model agency_data_pipeline.retention_stats_rebuy_rate_month [CREATE TABLE in 3.33s]
2018-04-18 08:55:29,562: 08:55:29 | 80 of 91 START table model agency_data_pipeline.agg_platforms_client. [RUN]
2018-04-18 08:55:29,563: Compiling model.agency_data_pipeline.agg_platforms_client
2018-04-18 08:55:29,573: Writing injected SQL for node "model.agency_data_pipeline.agg_platforms_client"
2018-04-18 08:55:29,576: Acquiring new bigquery connection "agg_platforms_client".
2018-04-18 08:55:29,576: Re-using an available connection from the pool.
2018-04-18 08:55:29,826: 08:55:29 | 76 of 91 OK created table model agency_data_pipeline.retention_stats_rebuy_rate [CREATE TABLE in 3.34s]
2018-04-18 08:55:29,827: 08:55:29 | 81 of 91 START table model agency_data_pipeline.retention_0_365_new.. [RUN]
2018-04-18 08:55:29,827: Compiling model.agency_data_pipeline.retention_0_365_new
2018-04-18 08:55:29,833: Writing injected SQL for node "model.agency_data_pipeline.retention_0_365_new"
2018-04-18 08:55:29,834: Acquiring new bigquery connection "retention_0_365_new".
2018-04-18 08:55:29,834: Re-using an available connection from the pool.
2018-04-18 08:55:30,369: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10879ae10>]}
2018-04-18 08:55:30,406: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1091b7ba8>]}
2018-04-18 08:55:30,507: Model SQL (agg_platforms_client):
SELECT 
date, 
a.account account, 
b.client client,
a.platform platform,
a.channel channel,
url,
utm_campaign,
campaign,
cost,
impressions,
clicks,
transactions ad_platform_transactions
FROM 
  `growth-engines-pipeline`.`agency_data_pipeline`.`agg_platforms_union` a
LEFT JOIN 
  `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc` b
ON ( 
  a.account = b.account AND
  a.platform = b.platform
)
2018-04-18 08:55:30,710: Model SQL (retention_0_365_new):
SELECT 
a.client,
a.date,
a.customer_id, 
a.quantity,
a.revenue,
a.order_count
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_730_plus` b
ON (
	a.client = b.client AND
	a.date = b.date AND
	a.customer_id = b.customer_id
)
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_365_730` c
ON (
	a.client = c.client AND
	a.date = c.date AND
	a.customer_id = c.customer_id
)
WHERE b.customer_id is null 
and c.customer_id is null
2018-04-18 08:55:31,004: 08:55:31 | 79 of 91 OK created table model agency_data_pipeline.retention_0_365_reactivated [CREATE TABLE in 4.84s]
2018-04-18 08:55:31,006: 08:55:31 | 82 of 91 START table model agency_data_pipeline.segment_stats_customers [RUN]
2018-04-18 08:55:31,008: Compiling model.agency_data_pipeline.segment_stats_customers
2018-04-18 08:55:31,016: Writing injected SQL for node "model.agency_data_pipeline.segment_stats_customers"
2018-04-18 08:55:31,020: Acquiring new bigquery connection "segment_stats_customers".
2018-04-18 08:55:31,021: Re-using an available connection from the pool.
2018-04-18 08:55:31,300: 08:55:31 | 77 of 91 OK created table model agency_data_pipeline.retention_0_30_reactivated [CREATE TABLE in 4.88s]
2018-04-18 08:55:31,300: 08:55:31 | 83 of 91 START table model agency_data_pipeline.retention_0_30_new... [RUN]
2018-04-18 08:55:31,300: Compiling model.agency_data_pipeline.retention_0_30_new
2018-04-18 08:55:31,307: Writing injected SQL for node "model.agency_data_pipeline.retention_0_30_new"
2018-04-18 08:55:31,308: Acquiring new bigquery connection "retention_0_30_new".
2018-04-18 08:55:31,308: Re-using an available connection from the pool.
2018-04-18 08:55:31,820: Model SQL (segment_stats_customers):
SELECT
client,
date,
segment_365,
segment_mom,
segment_yoy,
count(distinct(customer_id)) customers,
avg(recency_365) recency_365,
sum(frequency_365) frequency_365,
sum(revenue_365) revenue_365,
case when sum(frequency_365) > 0 then sum(revenue_365)/sum(frequency_365) else null end as aov_365,
avg(recency_mom) recency_mom,
sum(frequency_mom) frequency_mom,
sum(revenue_mom) revenue_mom,
case when sum(frequency_mom) > 0 then sum(revenue_mom)/sum(frequency_mom) else null end as aov_mom,
avg(recency_yoy) recency_yoy,
sum(frequency_yoy) frequency_yoy,
sum(revenue_yoy) revenue_yoy,
case when sum(frequency_yoy) > 0 then sum(revenue_yoy)/sum(frequency_yoy) else null end as aov_yoy
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_stats_customers_agg`
GROUP BY client, date, segment_365, segment_mom, segment_yoy
2018-04-18 08:55:31,960: Model SQL (retention_0_30_new):
SELECT 
a.client,
a.date,
a.customer_id, 
a.quantity,
a.revenue,
a.order_count
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_60_plus` b
ON (
	a.client = b.client AND
	a.date = b.date AND
	a.customer_id = b.customer_id
)
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_30_60` c
ON (
	a.client = c.client AND
	a.date = c.date AND
	a.customer_id = c.customer_id
)
WHERE b.customer_id is null 
and c.customer_id is null
2018-04-18 08:55:35,985: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106e4bfd0>]}
2018-04-18 08:55:36,268: 08:55:36 | 80 of 91 OK created table model agency_data_pipeline.agg_platforms_client [CREATE TABLE in 6.42s]
2018-04-18 08:55:36,727: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1091dd2b0>]}
2018-04-18 08:55:37,011: 08:55:37 | 83 of 91 OK created table model agency_data_pipeline.retention_0_30_new [CREATE TABLE in 5.43s]
2018-04-18 08:55:40,637: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10879ab70>]}
2018-04-18 08:55:40,928: 08:55:40 | 81 of 91 OK created table model agency_data_pipeline.retention_0_365_new [CREATE TABLE in 10.81s]
2018-04-18 08:55:46,102: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106df3278>]}
2018-04-18 08:55:46,441: 08:55:46 | 82 of 91 OK created table model agency_data_pipeline.segment_stats_customers [CREATE TABLE in 15.09s]
2018-04-18 08:55:46,441: 08:55:46 | 84 of 91 START table model agency_data_pipeline.segment_list_customers [RUN]
2018-04-18 08:55:46,442: Compiling model.agency_data_pipeline.segment_list_customers
2018-04-18 08:55:46,450: Writing injected SQL for node "model.agency_data_pipeline.segment_list_customers"
2018-04-18 08:55:46,451: Acquiring new bigquery connection "segment_list_customers".
2018-04-18 08:55:46,451: Re-using an available connection from the pool.
2018-04-18 08:55:47,198: Model SQL (segment_list_customers):
SELECT
a.client,
period,
date,
customer_id,
b.first_name,
b.last_name,
b.email,
recency_days,
frequency,
revenue,
quantity,
aov,
segment
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`agg_customers_union` b
ON (
	a.client = b.client AND
	a.customer_id = b.id
)
2018-04-18 08:56:22,651: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106df3c88>]}
2018-04-18 08:56:22,869: 08:56:22 | 84 of 91 OK created table model agency_data_pipeline.segment_list_customers [CREATE TABLE in 36.21s]
2018-04-18 08:56:22,870: 08:56:22 | 85 of 91 START table model agency_data_pipeline.growth_customer_0_365_segment [RUN]
2018-04-18 08:56:22,870: Compiling model.agency_data_pipeline.growth_customer_0_365_segment
2018-04-18 08:56:22,879: Writing injected SQL for node "model.agency_data_pipeline.growth_customer_0_365_segment"
2018-04-18 08:56:22,880: Acquiring new bigquery connection "growth_customer_0_365_segment".
2018-04-18 08:56:22,880: Re-using an available connection from the pool.
2018-04-18 08:56:23,786: Model SQL (growth_customer_0_365_segment):
with segment as (

	SELECT 
	a.date,
	unix_date_in_range,
	unix_date_in_range_yoy,
	a.client client,
	a.customer_id customer_id,
	case when b.customer_id is not null then 'New' else 'Existing' end as segment,
	a.orders,
	a.quantity,
	a.revenue,
	a.shipping_revenue
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_customer_0_365` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365_new` b
	ON (
	  a.customer_id = b.customer_id AND
	  a.date  = b.date AND
	  a.client = b.client
	)
),

total as (

	SELECT 
	date,
	unix_date_in_range,
	unix_date_in_range_yoy,
	client,
	customer_id,
	'Total' as segment,
	orders,
	quantity,
	revenue,
	shipping_revenue
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_customer_0_365`

)

SELECT 
date,
unix_date_in_range,
unix_date_in_range_yoy,
client,
segment,
count(distinct(customer_id)) customers,
sum(orders) orders,
sum(quantity) quantity,
sum(revenue) revenue,
sum(shipping_revenue) shipping_revenue
FROM
( 
	SELECT * FROM segment
	UNION ALL
	SELECT * FROM total
) 
GROUP BY date, unix_date_in_range, unix_date_in_range_yoy, client, segment
2018-04-18 08:56:35,851: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106df3278>]}
2018-04-18 08:56:36,509: 08:56:36 | 85 of 91 OK created table model agency_data_pipeline.growth_customer_0_365_segment [CREATE TABLE in 12.98s]
2018-04-18 08:56:36,510: 08:56:36 | 86 of 91 START table model agency_data_pipeline.growth_date_union.... [RUN]
2018-04-18 08:56:36,510: Compiling model.agency_data_pipeline.growth_date_union
2018-04-18 08:56:36,520: Writing injected SQL for node "model.agency_data_pipeline.growth_date_union"
2018-04-18 08:56:36,521: Acquiring new bigquery connection "growth_date_union".
2018-04-18 08:56:36,521: Re-using an available connection from the pool.
2018-04-18 08:56:37,405: Model SQL (growth_date_union):
with ty as (

  SELECT 
  date,
  unix_date_in_range, 
  unix_date_in_range_yoy, 
  client, 
  segment,
  customers customers_ty,
  orders orders_ty,
  quantity quantity_ty,
  revenue revenue_ty,
  shipping_revenue shipping_revenue_ty,
  null as customers_ly,
  null as orders_ly,
  null as quantity_ly,
  null as revenue_ly,
  null as shipping_revenue_ly
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_customer_0_365_segment`

),

ly as (

  SELECT 
  date,
  0 as unix_date_in_range, 
  unix_date_in_range unix_date_in_range_yoy, 
  client, 
  segment,
  null as customers_ty,
  null as orders_ty,
  null as quantity_ty,
  null as revenue_ty,
  null as shipping_revenue_ty,
  customers customers_ly,
  orders orders_ly,
  quantity quantity_ly,
  revenue revenue_ly,
  shipping_revenue shipping_revenue_ly
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_customer_0_365_segment`

)


SELECT
max(date) date,
max(unix_date_in_range) unix_date_in_range,
unix_date_in_range_yoy,
client,
segment,
ifnull(sum(customers_ty), 0) customers_ty,
ifnull(sum(orders_ty), 0) orders_ty,
ifnull(sum(quantity_ty), 0) quantity_ty,
ifnull(sum(revenue_ty), 0) revenue_ty,
ifnull(sum(shipping_revenue_ty), 0) shipping_revenue_ty,
case when sum(orders_ty) > 0 then sum(revenue_ty)/sum(orders_ty) else null end as aov_ty,
ifnull(sum(customers_ly), 0) customers_ly,
ifnull(sum(orders_ly), 0) orders_ly,
ifnull(sum(quantity_ly), 0) quantity_ly,
ifnull(sum(revenue_ly), 0) revenue_ly,
ifnull(sum(shipping_revenue_ly), 0) shipping_revenue_ly,
case when sum(orders_ly) > 0 then sum(revenue_ly)/sum(orders_ly) else null end as aov_ly,
case when sum(orders_ly) > 0 then ( sum(orders_ty) - sum(orders_ly) ) / sum(orders_ly) else null end as order_growth,
case when sum(revenue_ly) > 0 then ( sum(revenue_ty) - sum(revenue_ly) ) / sum(revenue_ly) else null end as revenue_growth,
case when sum(customers_ly) > 0 then ( sum(customers_ty) - sum(customers_ly) ) / sum(customers_ly) else null end as customer_growth,
case when sum(orders_ly) > 0 then ( sum(revenue_ty)/sum(orders_ty) - sum(revenue_ly)/sum(orders_ly) ) / ( sum(revenue_ly)/sum(orders_ly) ) else null end as aov_growth
FROM (

  SELECT * FROM ty
  UNION ALL
  SELECT * FROM ly

)
where unix_date_in_range is not null
group by unix_date_in_range_yoy, client, segment
2018-04-18 08:56:38,498: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10879a4e0>]}
2018-04-18 08:56:38,788: 08:56:38 | 86 of 91 OK created table model agency_data_pipeline.growth_date_union [CREATE TABLE in 1.99s]
2018-04-18 08:56:38,789: 08:56:38 | 87 of 91 START table model agency_data_pipeline.retention_stats...... [RUN]
2018-04-18 08:56:38,789: Compiling model.agency_data_pipeline.retention_stats
2018-04-18 08:56:38,789: 08:56:38 | 88 of 91 START table model agency_data_pipeline.growth_stats......... [RUN]
2018-04-18 08:56:38,801: Compiling model.agency_data_pipeline.growth_stats
2018-04-18 08:56:38,805: Writing injected SQL for node "model.agency_data_pipeline.retention_stats"
2018-04-18 08:56:38,789: 08:56:38 | 89 of 91 START table model agency_data_pipeline.retention_stats_month [RUN]
2018-04-18 08:56:38,820: Writing injected SQL for node "model.agency_data_pipeline.growth_stats"
2018-04-18 08:56:38,821: Compiling model.agency_data_pipeline.retention_stats_month
2018-04-18 08:56:38,845: Acquiring new bigquery connection "growth_stats".
2018-04-18 08:56:38,845: Re-using an available connection from the pool.
2018-04-18 08:56:38,846: Writing injected SQL for node "model.agency_data_pipeline.retention_stats_month"
2018-04-18 08:56:38,852: Acquiring new bigquery connection "retention_stats_month".
2018-04-18 08:56:38,855: Re-using an available connection from the pool.
2018-04-18 08:56:38,858: Acquiring new bigquery connection "retention_stats".
2018-04-18 08:56:38,859: Re-using an available connection from the pool.
2018-04-18 08:56:39,658: Model SQL (growth_stats):
with orders as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'Orders' as metric,
  orders_ty as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`
),

order_growth as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'Order Growth' as metric,
  order_growth as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`
),

revenue as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'Revenue' as metric,
  revenue_ty as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`
),

revenue_growth as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'Revenue Growth' as metric,
  revenue_growth as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`
),

customers as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'Customers' as metric,
  customers_ty as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`
),

customer_growth as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'Customer Growth' as metric,
  customer_growth as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`

),

aov as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'AOV' as metric,
  aov_ty as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`

),

aov_growth as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'AOV Growth' as metric,
  aov_growth as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`

)

SELECT * FROM orders
UNION ALL 
SELECT * FROM order_growth
UNION ALL
SELECT * FROM revenue
UNION ALL 
SELECT * FROM revenue_growth
UNION ALL
SELECT * FROM customers
UNION ALL 
SELECT * FROM customer_growth
UNION ALL
SELECT * FROM aov
UNION ALL 
SELECT * FROM aov_growth
2018-04-18 08:56:39,720: Model SQL (retention_stats_month):
WITH last_month_buyers AS (
	SELECT 
	date,
	client,
	'Last month buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_30_60`
	group by date, client
),

rebuy_rate AS (
	SELECT 
	date,
	client,
	'Rebuy rate' as metric,
	customer_retention value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_stats_rebuy_rate_month`
),

repeat_buyers AS (
	SELECT 
	date,
	client,
	'Repeat buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30_rebuy`
	group by date, client
),

reactivated_buyers AS (
	SELECT 
	date,
	client,
	'Reactivated buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30_reactivated`
	group by date, client
),

new_buyers AS (
	SELECT 
	date,
	client,
	'New buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30_new`
	group by date, client
),

this_month_buyers AS (
	SELECT 
	date,
	client,
	'This month buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30`
	group by date, client
),

this_month_revenue AS (
	SELECT 
	date,
	client,
	'This month revenue' as metric,
	sum(revenue) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30`
	group by date, client
),

this_month_aov AS (
	SELECT 
	date,
	client,
	'This month AOV' as metric,
	case when sum(order_count) > 0 then sum(revenue)/sum(order_count) else 0 end as value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30`
	group by date, client
),

this_month_frequency AS (
	SELECT 
	date,
	client,
	'This month frequency' as metric,
	case when count(distinct customer_id) > 0 then sum(order_count)/count(distinct customer_id) else 0 end as value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30`
	group by date, client
)

SELECT 
date,
client,
metric,
ifnull(value, 0) value
FROM
(
	SELECT
	date,
	client,
	metric,
	value
	FROM last_month_buyers

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM rebuy_rate

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM repeat_buyers

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM reactivated_buyers	

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM new_buyers	

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_month_buyers	

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_month_revenue

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_month_aov

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_month_frequency

	UNION ALL

	SELECT
	a.date,
	a.client,
	'Dormant buyers' as metric,
	a.value - ifnull(b.value, 0) as value
	FROM last_month_buyers a
	LEFT JOIN repeat_buyers b
	ON ( a.date = b.date AND
		a.client = b.client )							

)
2018-04-18 08:56:39,779: Model SQL (retention_stats):
WITH last_year_buyers AS (
	SELECT 
	date,
	client,
	'Last year buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_365_730`
	group by date, client
),

rebuy_rate AS (
	SELECT 
	date,
	client,
	'Rebuy rate' as metric,
	customer_retention value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_stats_rebuy_rate`
),

repeat_buyers AS (
	SELECT 
	date,
	client,
	'Repeat buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365_rebuy`
	group by date, client
),

reactivated_buyers AS (
	SELECT 
	date,
	client,
	'Reactivated buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365_reactivated`
	group by date, client
),

new_buyers AS (
	SELECT 
	date,
	client,
	'New buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365_new`
	group by date, client
),

this_year_buyers AS (
	SELECT 
	date,
	client,
	'This year buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365`
	group by date, client
),

this_year_revenue AS (
	SELECT 
	date,
	client,
	'This year revenue' as metric,
	sum(revenue) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365`
	group by date, client
),

this_year_aov AS (
	SELECT 
	date,
	client,
	'This year AOV' as metric,
	case when sum(order_count) > 0 then sum(revenue)/sum(order_count) else 0 end as value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365`
	group by date, client
),

this_year_frequency AS (
	SELECT 
	date,
	client,
	'This year frequency' as metric,
	case when count(distinct customer_id) > 0 then sum(order_count)/count(distinct customer_id) else 0 end as value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365`
	group by date, client
)

SELECT 
date,
client,
metric,
ifnull(value, 0) value
FROM
(
	SELECT
	date,
	client,
	metric,
	value
	FROM last_year_buyers

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM rebuy_rate

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM repeat_buyers

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM reactivated_buyers	

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM new_buyers	

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_year_buyers	

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_year_revenue

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_year_aov

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_year_frequency

	UNION ALL

	SELECT
	a.date,
	a.client,
	'Dormant buyers' as metric,
	a.value - ifnull(b.value, 0) as value
	FROM last_year_buyers a
	LEFT JOIN repeat_buyers b
	ON ( a.date = b.date AND
		a.client = b.client )							

)
2018-04-18 08:56:41,854: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106e4bfd0>]}
2018-04-18 08:56:41,924: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106dfd588>]}
2018-04-18 08:56:42,204: 08:56:42 | 88 of 91 OK created table model agency_data_pipeline.growth_stats.... [CREATE TABLE in 3.05s]
2018-04-18 08:56:42,425: 08:56:42 | 89 of 91 OK created table model agency_data_pipeline.retention_stats_month [CREATE TABLE in 3.10s]
2018-04-18 08:56:47,559: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106db2f60>]}
2018-04-18 08:56:47,899: 08:56:47 | 87 of 91 OK created table model agency_data_pipeline.retention_stats. [CREATE TABLE in 8.77s]
2018-04-18 08:56:47,899: 08:56:47 | 90 of 91 START table model agency_data_pipeline.agg_campaign......... [RUN]
2018-04-18 08:56:47,900: Compiling model.agency_data_pipeline.agg_campaign
2018-04-18 08:56:47,910: Writing injected SQL for node "model.agency_data_pipeline.agg_campaign"
2018-04-18 08:56:47,911: Acquiring new bigquery connection "agg_campaign".
2018-04-18 08:56:47,911: Re-using an available connection from the pool.
2018-04-18 08:56:48,772: Model SQL (agg_campaign):
with ga as (

	select 
		date, client, attribution, channel, platform, url, campaign as utm_campaign, '' as campaign,
    	customers_new,
    	transactions_new,
    	revenue_new,
    	first_order_revenue_new,
    	lifetime_revenue_new,
    	customers_total,
    	transactions_total,
    	revenue_total,
		null as cost, null as impressions, null as clicks, null as ad_platform_transactions
	from `growth-engines-pipeline`.`agency_data_pipeline`.`agg_ga_campaign_by_type`

),

platforms_last_touch as (

	select 
		date, client, 'Last-touch' as attribution, channel, platform, url, utm_campaign, campaign,
		null as customers_new,
    	null as transactions_new,
    	null as revenue_new,
    	null as first_order_revenue_new,
    	null as lifetime_revenue_new,
    	null as customers_total,
    	null as transactions_total,
    	null as revenue_total,
		cost, impressions, clicks, ad_platform_transactions
	from `growth-engines-pipeline`.`agency_data_pipeline`.`agg_platforms_client`

),

platforms_first_touch as (

    select 
        date, client, 'First-touch' as attribution, channel, platform, url, utm_campaign, campaign,
        null as customers_new,
        null as transactions_new,
        null as revenue_new,
        null as first_order_revenue_new,
        null as lifetime_revenue_new,
        null as customers_total,
        null as transactions_total,
        null as revenue_total,
        cost, impressions, clicks, ad_platform_transactions
    from `growth-engines-pipeline`.`agency_data_pipeline`.`agg_platforms_client`

)


SELECT
    date, 
    client,
    attribution,
    platform,
    channel, 
    url,
    utm_campaign,
    max(campaign) campaign,
    ifnull( sum(cost), 0) cost,
	ifnull( sum(impressions), 0) impressions,
	ifnull( sum(clicks), 0) clicks,
	ifnull( sum(ad_platform_transactions), 0) ad_platform_transactions,
	ifnull( sum(customers_new), 0) customers_new,
	ifnull( sum(transactions_new), 0) transactions_new,
	ifnull( sum(revenue_new), 0) revenue_new,
	ifnull( sum(first_order_revenue_new), 0) first_order_revenue_new,
	ifnull( sum(lifetime_revenue_new), 0) lifetime_revenue_new,
	ifnull( sum(customers_total), 0) customers_total,
	ifnull( sum(transactions_total), 0) transactions_total,
	ifnull( sum(revenue_total), 0) revenue_total	
FROM 
(
    SELECT *
    FROM 
      ga
    UNION ALL
    SELECT *
    FROM 
      platforms_first_touch
    UNION ALL
    SELECT *
    FROM 
      platforms_last_touch      
) 
GROUP BY
    date, client, attribution, platform, channel, url, utm_campaign
2018-04-18 08:56:56,441: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106dfdc88>]}
2018-04-18 08:56:56,735: 08:56:56 | 90 of 91 OK created table model agency_data_pipeline.agg_campaign.... [CREATE TABLE in 8.54s]
2018-04-18 08:56:56,736: 08:56:56 | 91 of 91 START table model agency_data_pipeline.agg_platform_monthly. [RUN]
2018-04-18 08:56:56,736: Compiling model.agency_data_pipeline.agg_platform_monthly
2018-04-18 08:56:56,744: Writing injected SQL for node "model.agency_data_pipeline.agg_platform_monthly"
2018-04-18 08:56:56,747: Acquiring new bigquery connection "agg_platform_monthly".
2018-04-18 08:56:56,747: Re-using an available connection from the pool.
2018-04-18 08:56:57,578: Model SQL (agg_platform_monthly):
SELECT
    FORMAT_DATE("%Y-%m", date) AS yyyymm,
    client,
    attribution,
    platform,
    channel, 
    sum(cost) cost,
	sum(clicks) clicks,
	sum(customers_new) customers_new,
	sum(first_order_revenue_new) first_order_revenue_new,
	sum(lifetime_revenue_new) lifetime_revenue_new,
	sum(transactions_new) transactions_new,
	sum(revenue_new) revenue_new,
    sum(customers_total) customers_total,
    sum(transactions_total) transactions_total,
    sum(revenue_total) revenue_total
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_campaign`
GROUP BY
    yyyymm, client, attribution, platform, channel
2018-04-18 08:56:59,876: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '197a8300-159a-4985-921e-f3c97c89bdc8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106db2f60>]}
2018-04-18 08:57:00,134: 08:57:00 | 91 of 91 OK created table model agency_data_pipeline.agg_platform_monthly [CREATE TABLE in 3.14s]
2018-04-18 08:57:00,211: 08:57:00 | 
2018-04-18 08:57:00,212: 08:57:00 | Finished running 91 table models in 430.50s.
2018-04-18 08:57:00,212: Connection 'master' was left open.
2018-04-18 08:57:00,213: 
2018-04-18 08:57:00,213: Completed successfully
2018-04-18 08:57:00,213: 
Done. PASS=91 ERROR=0 SKIP=0 TOTAL=91
2018-04-18 08:57:00,214: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106d2e630>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106cf79b0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106cf7c50>]}
2018-04-18 08:57:00,474: Flushing usage events
2018-04-18 09:33:13,847: Tracking: tracking
2018-04-18 09:33:13,850: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111febf60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111febe80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111febdd8>]}
2018-04-18 09:33:14,709: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-04-18 09:33:14,729: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/growth-engines/dbt_modules
2018-04-18 09:33:14,736: Parsing get_column_values.sql
2018-04-18 09:33:14,766: Parsing get_url_parameter.sql
2018-04-18 09:33:14,775: Parsing split_part.sql
2018-04-18 09:33:14,791: Parsing table_exists.sql
2018-04-18 09:33:14,806: Parsing core.sql
2018-04-18 09:33:14,820: Parsing adapters/bigquery.sql
2018-04-18 09:33:14,832: Parsing adapters/common.sql
2018-04-18 09:33:14,850: Parsing adapters/postgres.sql
2018-04-18 09:33:14,858: Parsing adapters/redshift.sql
2018-04-18 09:33:14,885: Parsing etc/get_custom_schema.sql
2018-04-18 09:33:14,894: Parsing materializations/archive.sql
2018-04-18 09:33:14,942: Parsing materializations/bigquery.sql
2018-04-18 09:33:14,974: Parsing materializations/helpers.sql
2018-04-18 09:33:15,006: Parsing materializations/incremental.sql
2018-04-18 09:33:15,036: Parsing materializations/table.sql
2018-04-18 09:33:15,058: Parsing materializations/view.sql
2018-04-18 09:33:15,077: Parsing materializations/wrapper.sql
2018-04-18 09:33:15,084: Parsing schema_tests/accepted_values.sql
2018-04-18 09:33:15,091: Parsing schema_tests/not_null.sql
2018-04-18 09:33:15,095: Parsing schema_tests/relationships.sql
2018-04-18 09:33:15,102: Parsing schema_tests/unique.sql
2018-04-18 09:33:15,438: Parsing model.agency_data_pipeline.accounts_proc
2018-04-18 09:33:15,442: Parsing model.agency_data_pipeline.all_dates
2018-04-18 09:33:15,444: Parsing model.agency_data_pipeline.carts_proc
2018-04-18 09:33:15,448: Parsing model.agency_data_pipeline.clients_proc
2018-04-18 09:33:15,452: Parsing model.agency_data_pipeline.conversion_goals_proc
2018-04-18 09:33:15,455: Parsing model.agency_data_pipeline.mappings_ga_proc
2018-04-18 09:33:15,459: Acquiring new bigquery connection "master".
2018-04-18 09:33:15,459: Opening a new connection (0 currently allocated)
2018-04-18 09:33:15,467: Parsing model.agency_data_pipeline.monthend_dates
2018-04-18 09:33:15,470: Parsing model.agency_data_pipeline.adwords_ads
2018-04-18 09:33:15,474: Parsing model.agency_data_pipeline.adwords_campaigns
2018-04-18 09:33:15,476: Parsing model.agency_data_pipeline.adwords_conversions
2018-04-18 09:33:15,479: Parsing model.agency_data_pipeline.adwords_impression_share
2018-04-18 09:33:15,481: Parsing model.agency_data_pipeline.adwords_join
2018-04-18 09:33:15,483: Parsing model.agency_data_pipeline.adwords_stats
2018-04-18 09:33:15,485: Parsing model.agency_data_pipeline.adwords_urls
2018-04-18 09:33:15,488: Parsing model.agency_data_pipeline.bing_ads_ads
2018-04-18 09:33:15,492: Parsing model.agency_data_pipeline.bing_ads_conversions
2018-04-18 09:33:15,494: Parsing model.agency_data_pipeline.bing_ads_impression_share
2018-04-18 09:33:15,497: Parsing model.agency_data_pipeline.bing_ads_stats
2018-04-18 09:33:15,499: Parsing model.agency_data_pipeline.fb_adcreative
2018-04-18 09:33:15,505: Parsing model.agency_data_pipeline.fb_ads
2018-04-18 09:33:15,511: Parsing model.agency_data_pipeline.fb_ads_insights
2018-04-18 09:33:15,520: Parsing model.agency_data_pipeline.fb_ads_insights_conversions
2018-04-18 09:33:15,526: Parsing model.agency_data_pipeline.fb_ads_stats
2018-04-18 09:33:15,529: Parsing model.agency_data_pipeline.ga_conversions
2018-04-18 09:33:15,531: Parsing model.agency_data_pipeline.ga_traffic
2018-04-18 09:33:15,548: Parsing model.agency_data_pipeline.ga_transactions
2018-04-18 09:33:15,567: Parsing model.agency_data_pipeline.ga_mcf_proc
2018-04-18 09:33:15,571: Parsing model.agency_data_pipeline.ga_mcf_stats
2018-04-18 09:33:15,575: Parsing model.agency_data_pipeline.shopify_customers_proc
2018-04-18 09:33:15,585: Parsing model.agency_data_pipeline.shopify_orders_proc
2018-04-18 09:33:15,592: Parsing model.agency_data_pipeline.shopify_products_proc
2018-04-18 09:33:15,599: Parsing model.agency_data_pipeline.shopify_refunds_proc
2018-04-18 09:33:15,605: Parsing model.agency_data_pipeline.agg_campaign
2018-04-18 09:33:15,609: Parsing model.agency_data_pipeline.agg_customers_union
2018-04-18 09:33:15,610: Parsing model.agency_data_pipeline.agg_ga_campaign
2018-04-18 09:33:15,615: Parsing model.agency_data_pipeline.agg_ga_campaign_by_type
2018-04-18 09:33:15,618: Parsing model.agency_data_pipeline.agg_ga_transaction
2018-04-18 09:33:15,621: Parsing model.agency_data_pipeline.agg_ga_transaction_order_number
2018-04-18 09:33:15,624: Parsing model.agency_data_pipeline.agg_orders_union
2018-04-18 09:33:15,626: Parsing model.agency_data_pipeline.agg_platform_monthly
2018-04-18 09:33:15,627: Parsing model.agency_data_pipeline.agg_platforms_client
2018-04-18 09:33:15,631: Parsing model.agency_data_pipeline.agg_platforms_union
2018-04-18 09:33:15,633: Parsing model.agency_data_pipeline.agg_products
2018-04-18 09:33:15,635: Parsing model.agency_data_pipeline.agg_transaction
2018-04-18 09:33:15,637: Parsing model.agency_data_pipeline.agg_transaction_daily
2018-04-18 09:33:15,639: Parsing model.agency_data_pipeline.agg_transaction_line_item
2018-04-18 09:33:15,642: Parsing model.agency_data_pipeline.agg_transaction_line_item_type
2018-04-18 09:33:15,647: Parsing model.agency_data_pipeline.agg_transaction_order_number
2018-04-18 09:33:15,650: Parsing model.agency_data_pipeline.agg_transaction_product_type
2018-04-18 09:33:15,652: Parsing model.agency_data_pipeline.customers_by_transaction
2018-04-18 09:33:15,654: Parsing model.agency_data_pipeline.growth_customer_0_365
2018-04-18 09:33:15,656: Parsing model.agency_data_pipeline.growth_customer_0_365_segment
2018-04-18 09:33:15,659: Parsing model.agency_data_pipeline.growth_date_union
2018-04-18 09:33:15,661: Parsing model.agency_data_pipeline.growth_stats
2018-04-18 09:33:15,666: Parsing model.agency_data_pipeline.retention_0_365
2018-04-18 09:33:15,668: Parsing model.agency_data_pipeline.retention_0_365_new
2018-04-18 09:33:15,671: Parsing model.agency_data_pipeline.retention_0_365_reactivated
2018-04-18 09:33:15,673: Parsing model.agency_data_pipeline.retention_0_365_rebuy
2018-04-18 09:33:15,675: Parsing model.agency_data_pipeline.retention_365_730
2018-04-18 09:33:15,677: Parsing model.agency_data_pipeline.retention_730_plus
2018-04-18 09:33:15,680: Parsing model.agency_data_pipeline.retention_stats
2018-04-18 09:33:15,685: Parsing model.agency_data_pipeline.retention_stats_rebuy_rate
2018-04-18 09:33:15,687: Parsing model.agency_data_pipeline.retention_0_30
2018-04-18 09:33:15,690: Parsing model.agency_data_pipeline.retention_0_30_new
2018-04-18 09:33:15,692: Parsing model.agency_data_pipeline.retention_0_30_reactivated
2018-04-18 09:33:15,694: Parsing model.agency_data_pipeline.retention_0_30_rebuy
2018-04-18 09:33:15,697: Parsing model.agency_data_pipeline.retention_30_60
2018-04-18 09:33:15,699: Parsing model.agency_data_pipeline.retention_60_plus
2018-04-18 09:33:15,701: Parsing model.agency_data_pipeline.retention_stats_month
2018-04-18 09:33:15,706: Parsing model.agency_data_pipeline.retention_stats_rebuy_rate_month
2018-04-18 09:33:15,708: Parsing model.agency_data_pipeline.customers_first_purchase_proc
2018-04-18 09:33:15,711: Parsing model.agency_data_pipeline.customers_proc
2018-04-18 09:33:15,714: Parsing model.agency_data_pipeline.segment_list_customers
2018-04-18 09:33:15,716: Parsing model.agency_data_pipeline.segment_proc_customers
2018-04-18 09:33:15,719: Parsing model.agency_data_pipeline.segment_stats_customers
2018-04-18 09:33:15,722: Parsing model.agency_data_pipeline.segment_stats_customers_agg
2018-04-18 09:33:15,724: Parsing model.agency_data_pipeline.customers_first_purchase_product_type_proc
2018-04-18 09:33:15,726: Parsing model.agency_data_pipeline.customers_products_proc
2018-04-18 09:33:15,729: Parsing model.agency_data_pipeline.segment_list_customers_products
2018-04-18 09:33:15,731: Parsing model.agency_data_pipeline.segment_proc_customers_products
2018-04-18 09:33:15,734: Parsing model.agency_data_pipeline.segment_stats_customers_products
2018-04-18 09:33:15,736: Parsing model.agency_data_pipeline.segment_stats_customers_products_agg
2018-04-18 09:33:15,739: Parsing model.agency_data_pipeline.frequency_proc
2018-04-18 09:33:15,741: Parsing model.agency_data_pipeline.frequency_stats
2018-04-18 09:33:15,743: Parsing model.agency_data_pipeline.order_paths_agg
2018-04-18 09:33:15,744: Parsing model.agency_data_pipeline.order_paths_proc
2018-04-18 09:33:15,747: Parsing model.agency_data_pipeline.order_paths_stats
2018-04-18 09:33:15,749: Parsing model.agency_data_pipeline.products_proc
2018-04-18 09:33:15,751: Parsing model.agency_data_pipeline.segment_proc_sku
2018-04-18 09:33:15,754: Parsing model.agency_data_pipeline.segment_stats_category
2018-04-18 09:33:15,756: Parsing model.agency_data_pipeline.segment_stats_sku
2018-04-18 09:33:15,799: Found 91 models, 0 tests, 0 archives, 0 analyses, 46 macros, 0 operations
2018-04-18 09:33:15,862: 
2018-04-18 09:33:17,068: 09:33:17 | Concurrency: 4 threads (target='prod')
2018-04-18 09:33:17,068: 09:33:17 | 
2018-04-18 09:33:18,011: 09:33:18 | 1 of 91 START table model agency_data_pipeline.bing_ads_ads.......... [RUN]
2018-04-18 09:33:18,012: Compiling model.agency_data_pipeline.bing_ads_ads
2018-04-18 09:33:18,021: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_ads"
2018-04-18 09:33:18,018: 09:33:18 | 2 of 91 START table model agency_data_pipeline.ga_conversions........ [RUN]
2018-04-18 09:33:18,021: 09:33:18 | 3 of 91 START table model agency_data_pipeline.accounts_proc......... [RUN]
2018-04-18 09:33:18,022: 09:33:18 | 4 of 91 START table model agency_data_pipeline.monthend_dates........ [RUN]
2018-04-18 09:33:18,022: Compiling model.agency_data_pipeline.ga_conversions
2018-04-18 09:33:18,022: Compiling model.agency_data_pipeline.accounts_proc
2018-04-18 09:33:18,022: Compiling model.agency_data_pipeline.monthend_dates
2018-04-18 09:33:18,027: Writing injected SQL for node "model.agency_data_pipeline.ga_conversions"
2018-04-18 09:33:18,032: Writing injected SQL for node "model.agency_data_pipeline.accounts_proc"
2018-04-18 09:33:18,039: Acquiring new bigquery connection "bing_ads_ads".
2018-04-18 09:33:18,042: Opening a new connection (1 currently allocated)
2018-04-18 09:33:18,042: Writing injected SQL for node "model.agency_data_pipeline.monthend_dates"
2018-04-18 09:33:18,045: Acquiring new bigquery connection "monthend_dates".
2018-04-18 09:33:18,049: Acquiring new bigquery connection "ga_conversions".
2018-04-18 09:33:18,051: Acquiring new bigquery connection "accounts_proc".
2018-04-18 09:33:18,112: Opening a new connection (2 currently allocated)
2018-04-18 09:33:18,119: Opening a new connection (3 currently allocated)
2018-04-18 09:33:18,233: Opening a new connection (4 currently allocated)
2018-04-18 09:33:18,750: 09:33:18 | The bigquery adapter does not support query cancellation. Some queries may still be running!
2018-04-18 09:33:18,751: Connection 'master' was left open.
2018-04-18 09:33:18,751: Connection 'bing_ads_ads' was left open.
2018-04-18 09:33:18,751: Connection 'monthend_dates' was left open.
2018-04-18 09:33:18,751: Connection 'ga_conversions' was left open.
2018-04-18 09:33:18,751: Connection 'accounts_proc' was left open.
2018-04-18 09:33:18,751: ctrl-c
2018-04-18 09:34:57,861: Tracking: tracking
2018-04-18 09:34:57,864: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11157f518>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11157f7b8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11157fb38>]}
2018-04-18 09:35:01,743: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-04-18 09:35:01,764: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/growth-engines/dbt_modules
2018-04-18 09:35:01,774: Parsing get_column_values.sql
2018-04-18 09:35:01,790: Parsing get_url_parameter.sql
2018-04-18 09:35:01,797: Parsing split_part.sql
2018-04-18 09:35:01,810: Parsing table_exists.sql
2018-04-18 09:35:01,825: Parsing core.sql
2018-04-18 09:35:01,842: Parsing adapters/bigquery.sql
2018-04-18 09:35:01,849: Parsing adapters/common.sql
2018-04-18 09:35:01,868: Parsing adapters/postgres.sql
2018-04-18 09:35:01,875: Parsing adapters/redshift.sql
2018-04-18 09:35:01,905: Parsing etc/get_custom_schema.sql
2018-04-18 09:35:01,913: Parsing materializations/archive.sql
2018-04-18 09:35:01,946: Parsing materializations/bigquery.sql
2018-04-18 09:35:01,969: Parsing materializations/helpers.sql
2018-04-18 09:35:01,987: Parsing materializations/incremental.sql
2018-04-18 09:35:02,015: Parsing materializations/table.sql
2018-04-18 09:35:02,040: Parsing materializations/view.sql
2018-04-18 09:35:02,057: Parsing materializations/wrapper.sql
2018-04-18 09:35:02,063: Parsing schema_tests/accepted_values.sql
2018-04-18 09:35:02,070: Parsing schema_tests/not_null.sql
2018-04-18 09:35:02,077: Parsing schema_tests/relationships.sql
2018-04-18 09:35:02,084: Parsing schema_tests/unique.sql
2018-04-18 09:35:02,176: Parsing model.agency_data_pipeline.accounts_proc
2018-04-18 09:35:02,178: Parsing model.agency_data_pipeline.all_dates
2018-04-18 09:35:02,179: Parsing model.agency_data_pipeline.carts_proc
2018-04-18 09:35:02,180: Parsing model.agency_data_pipeline.clients_proc
2018-04-18 09:35:02,182: Parsing model.agency_data_pipeline.conversion_goals_proc
2018-04-18 09:35:02,183: Parsing model.agency_data_pipeline.mappings_ga_proc
2018-04-18 09:35:02,185: Acquiring new bigquery connection "master".
2018-04-18 09:35:02,185: Opening a new connection (0 currently allocated)
2018-04-18 09:35:02,189: Parsing model.agency_data_pipeline.monthend_dates
2018-04-18 09:35:02,191: Parsing model.agency_data_pipeline.adwords_ads
2018-04-18 09:35:02,193: Parsing model.agency_data_pipeline.adwords_campaigns
2018-04-18 09:35:02,195: Parsing model.agency_data_pipeline.adwords_conversions
2018-04-18 09:35:02,196: Parsing model.agency_data_pipeline.adwords_impression_share
2018-04-18 09:35:02,198: Parsing model.agency_data_pipeline.adwords_join
2018-04-18 09:35:02,200: Parsing model.agency_data_pipeline.adwords_stats
2018-04-18 09:35:02,202: Parsing model.agency_data_pipeline.adwords_urls
2018-04-18 09:35:02,204: Parsing model.agency_data_pipeline.bing_ads_ads
2018-04-18 09:35:02,207: Parsing model.agency_data_pipeline.bing_ads_conversions
2018-04-18 09:35:02,209: Parsing model.agency_data_pipeline.bing_ads_impression_share
2018-04-18 09:35:02,210: Parsing model.agency_data_pipeline.bing_ads_stats
2018-04-18 09:35:02,212: Parsing model.agency_data_pipeline.fb_adcreative
2018-04-18 09:35:02,217: Parsing model.agency_data_pipeline.fb_ads
2018-04-18 09:35:02,223: Parsing model.agency_data_pipeline.fb_ads_insights
2018-04-18 09:35:02,228: Parsing model.agency_data_pipeline.fb_ads_insights_conversions
2018-04-18 09:35:02,233: Parsing model.agency_data_pipeline.fb_ads_stats
2018-04-18 09:35:02,236: Parsing model.agency_data_pipeline.ga_conversions
2018-04-18 09:35:02,238: Parsing model.agency_data_pipeline.ga_traffic
2018-04-18 09:35:02,249: Parsing model.agency_data_pipeline.ga_transactions
2018-04-18 09:35:02,259: Parsing model.agency_data_pipeline.ga_mcf_proc
2018-04-18 09:35:02,261: Parsing model.agency_data_pipeline.ga_mcf_stats
2018-04-18 09:35:02,264: Parsing model.agency_data_pipeline.shopify_customers_proc
2018-04-18 09:35:02,270: Parsing model.agency_data_pipeline.shopify_orders_proc
2018-04-18 09:35:02,279: Parsing model.agency_data_pipeline.shopify_products_proc
2018-04-18 09:35:02,287: Parsing model.agency_data_pipeline.shopify_refunds_proc
2018-04-18 09:35:02,292: Parsing model.agency_data_pipeline.agg_campaign
2018-04-18 09:35:02,295: Parsing model.agency_data_pipeline.agg_customers_union
2018-04-18 09:35:02,296: Parsing model.agency_data_pipeline.agg_ga_campaign
2018-04-18 09:35:02,299: Parsing model.agency_data_pipeline.agg_ga_campaign_by_type
2018-04-18 09:35:02,302: Parsing model.agency_data_pipeline.agg_ga_transaction
2018-04-18 09:35:02,305: Parsing model.agency_data_pipeline.agg_ga_transaction_order_number
2018-04-18 09:35:02,308: Parsing model.agency_data_pipeline.agg_orders_union
2018-04-18 09:35:02,310: Parsing model.agency_data_pipeline.agg_platform_monthly
2018-04-18 09:35:02,313: Parsing model.agency_data_pipeline.agg_platforms_client
2018-04-18 09:35:02,315: Parsing model.agency_data_pipeline.agg_platforms_union
2018-04-18 09:35:02,317: Parsing model.agency_data_pipeline.agg_products
2018-04-18 09:35:02,318: Parsing model.agency_data_pipeline.agg_transaction
2018-04-18 09:35:02,321: Parsing model.agency_data_pipeline.agg_transaction_daily
2018-04-18 09:35:02,323: Parsing model.agency_data_pipeline.agg_transaction_line_item
2018-04-18 09:35:02,324: Parsing model.agency_data_pipeline.agg_transaction_line_item_type
2018-04-18 09:35:02,326: Parsing model.agency_data_pipeline.agg_transaction_order_number
2018-04-18 09:35:02,328: Parsing model.agency_data_pipeline.agg_transaction_product_type
2018-04-18 09:35:02,330: Parsing model.agency_data_pipeline.customers_by_transaction
2018-04-18 09:35:02,331: Parsing model.agency_data_pipeline.growth_customer_0_365
2018-04-18 09:35:02,333: Parsing model.agency_data_pipeline.growth_customer_0_365_segment
2018-04-18 09:35:02,336: Parsing model.agency_data_pipeline.growth_date_union
2018-04-18 09:35:02,340: Parsing model.agency_data_pipeline.growth_stats
2018-04-18 09:35:02,348: Parsing model.agency_data_pipeline.retention_0_365
2018-04-18 09:35:02,350: Parsing model.agency_data_pipeline.retention_0_365_new
2018-04-18 09:35:02,352: Parsing model.agency_data_pipeline.retention_0_365_reactivated
2018-04-18 09:35:02,355: Parsing model.agency_data_pipeline.retention_0_365_rebuy
2018-04-18 09:35:02,357: Parsing model.agency_data_pipeline.retention_365_730
2018-04-18 09:35:02,360: Parsing model.agency_data_pipeline.retention_730_plus
2018-04-18 09:35:02,363: Parsing model.agency_data_pipeline.retention_stats
2018-04-18 09:35:02,368: Parsing model.agency_data_pipeline.retention_stats_rebuy_rate
2018-04-18 09:35:02,371: Parsing model.agency_data_pipeline.retention_0_30
2018-04-18 09:35:02,374: Parsing model.agency_data_pipeline.retention_0_30_new
2018-04-18 09:35:02,377: Parsing model.agency_data_pipeline.retention_0_30_reactivated
2018-04-18 09:35:02,381: Parsing model.agency_data_pipeline.retention_0_30_rebuy
2018-04-18 09:35:02,382: Parsing model.agency_data_pipeline.retention_30_60
2018-04-18 09:35:02,384: Parsing model.agency_data_pipeline.retention_60_plus
2018-04-18 09:35:02,387: Parsing model.agency_data_pipeline.retention_stats_month
2018-04-18 09:35:02,393: Parsing model.agency_data_pipeline.retention_stats_rebuy_rate_month
2018-04-18 09:35:02,398: Parsing model.agency_data_pipeline.customers_first_purchase_proc
2018-04-18 09:35:02,401: Parsing model.agency_data_pipeline.customers_proc
2018-04-18 09:35:02,404: Parsing model.agency_data_pipeline.segment_list_customers
2018-04-18 09:35:02,407: Parsing model.agency_data_pipeline.segment_proc_customers
2018-04-18 09:35:02,409: Parsing model.agency_data_pipeline.segment_stats_customers
2018-04-18 09:35:02,412: Parsing model.agency_data_pipeline.segment_stats_customers_agg
2018-04-18 09:35:02,415: Parsing model.agency_data_pipeline.customers_first_purchase_product_type_proc
2018-04-18 09:35:02,417: Parsing model.agency_data_pipeline.customers_products_proc
2018-04-18 09:35:02,420: Parsing model.agency_data_pipeline.segment_list_customers_products
2018-04-18 09:35:02,422: Parsing model.agency_data_pipeline.segment_proc_customers_products
2018-04-18 09:35:02,425: Parsing model.agency_data_pipeline.segment_stats_customers_products
2018-04-18 09:35:02,428: Parsing model.agency_data_pipeline.segment_stats_customers_products_agg
2018-04-18 09:35:02,431: Parsing model.agency_data_pipeline.frequency_proc
2018-04-18 09:35:02,433: Parsing model.agency_data_pipeline.frequency_stats
2018-04-18 09:35:02,435: Parsing model.agency_data_pipeline.order_paths_agg
2018-04-18 09:35:02,437: Parsing model.agency_data_pipeline.order_paths_proc
2018-04-18 09:35:02,439: Parsing model.agency_data_pipeline.order_paths_stats
2018-04-18 09:35:02,441: Parsing model.agency_data_pipeline.products_proc
2018-04-18 09:35:02,444: Parsing model.agency_data_pipeline.segment_proc_sku
2018-04-18 09:35:02,446: Parsing model.agency_data_pipeline.segment_stats_category
2018-04-18 09:35:02,447: Parsing model.agency_data_pipeline.segment_stats_sku
2018-04-18 09:35:02,477: Found 91 models, 0 tests, 0 archives, 0 analyses, 46 macros, 0 operations
2018-04-18 09:35:02,539: 
2018-04-18 09:35:02,964: 09:35:02 | Concurrency: 4 threads (target='prod')
2018-04-18 09:35:02,964: 09:35:02 | 
2018-04-18 09:35:03,695: 09:35:03 | 1 of 91 START table model agency_data_pipeline.adwords_urls.......... [RUN]
2018-04-18 09:35:03,695: 09:35:03 | 2 of 91 START table model agency_data_pipeline.monthend_dates........ [RUN]
2018-04-18 09:35:03,696: 09:35:03 | 3 of 91 START table model agency_data_pipeline.bing_ads_impression_share [RUN]
2018-04-18 09:35:03,696: 09:35:03 | 4 of 91 START table model agency_data_pipeline.clients_proc.......... [RUN]
2018-04-18 09:35:03,697: Compiling model.agency_data_pipeline.adwords_urls
2018-04-18 09:35:03,698: Compiling model.agency_data_pipeline.monthend_dates
2018-04-18 09:35:03,698: Compiling model.agency_data_pipeline.bing_ads_impression_share
2018-04-18 09:35:03,698: Compiling model.agency_data_pipeline.clients_proc
2018-04-18 09:35:03,702: Writing injected SQL for node "model.agency_data_pipeline.adwords_urls"
2018-04-18 09:35:03,706: Writing injected SQL for node "model.agency_data_pipeline.monthend_dates"
2018-04-18 09:35:03,710: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_impression_share"
2018-04-18 09:35:03,714: Writing injected SQL for node "model.agency_data_pipeline.clients_proc"
2018-04-18 09:35:03,718: Acquiring new bigquery connection "monthend_dates".
2018-04-18 09:35:03,718: Opening a new connection (1 currently allocated)
2018-04-18 09:35:03,719: Acquiring new bigquery connection "adwords_urls".
2018-04-18 09:35:03,720: Acquiring new bigquery connection "clients_proc".
2018-04-18 09:35:03,720: Acquiring new bigquery connection "bing_ads_impression_share".
2018-04-18 09:35:03,722: Opening a new connection (2 currently allocated)
2018-04-18 09:35:03,781: Opening a new connection (3 currently allocated)
2018-04-18 09:35:03,834: Opening a new connection (4 currently allocated)
2018-04-18 09:35:05,110: Model SQL (bing_ads_impression_share):
SELECT 
date, 
account,
channel,
platform,
sum(impressions) impressions,
sum(available_impressions) available_impressions
FROM

(

SELECT  
cast(gregoriandate as date) date,
replace(accountname,',','') account,  
'Paid' as channel,
'Bing Ads' as platform,
case when impressionsharepercent is null then 0 else impressions end as impressions,
cast(round(case when ( impressionsharepercent is not null and impressionsharepercent > 0 ) then (impressions*100)/impressionsharepercent else 0 end) as int64) as available_impressions,
_sdc_sequence,
first_value(_sdc_sequence) OVER (PARTITION BY campaignid, gregoriandate ORDER BY _sdc_sequence DESC) lv
FROM `growth-engines-pipeline.bing_ads.campaign_performance_report` 

)

where lv = _sdc_sequence
group by date, account, channel, platform
2018-04-18 09:35:05,110: Model SQL (monthend_dates):
SELECT
date_in_range,
date_in_range_bom,
date_in_range_bom_mom,
unix_date_in_range,
unix_date_in_range_bom,
unix_date(date_in_range_bom_mom) unix_date_in_range_bom_mom,
yyyymm,
date_in_range_yoy,
unix_date(date_in_range_yoy) unix_date_in_range_yoy

FROM
(
	SELECT 
	date_in_range,
	date_in_range_bom,
	date_sub(date_in_range_bom, INTERVAL 1 MONTH) date_in_range_bom_mom,
  date_sub(date_in_range, INTERVAL 1 YEAR) date_in_range_yoy,
	unix_date_in_range,
	unix_date(date_in_range_bom) unix_date_in_range_bom,
	yyyymm,
	first_value(date_in_range) over (partition by yyyymm order by date_in_range desc) monthend_date_in_range
	FROM
	( 
		SELECT 
		date_in_range,
		date_trunc( date_in_range, MONTH) date_in_range_bom,
		unix_date(date_in_range) unix_date_in_range,
		format_date("%Y-%m", date_in_range) AS yyyymm
		FROM UNNEST(
		    GENERATE_DATE_ARRAY(DATE('2016-01-31'), CURRENT_DATE(), INTERVAL 1 DAY)
		) AS date_in_range
	)
)
where date_in_range = monthend_date_in_range
2018-04-18 09:35:05,167: Model SQL (clients_proc):
select 
client,
client_name,
account,
platform
from  ( 

SELECT  
client,
client_name,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.accounts`
where client_name != ''
) 

WHERE lv = time_of_entry
2018-04-18 09:35:05,235: Model SQL (adwords_urls):
SELECT
campaignid,
lower(trim(regexp_replace(replace(replace(replace(replace(finalurl,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url

FROM (

SELECT  
campaignid,
finalurl,
first_value(finalurl) OVER (PARTITION BY campaignid ORDER BY day DESC) lv
FROM `growth-engines-pipeline.adwords_2.FINAL_URL_REPORT`
)

WHERE lv = finalurl
group by campaignid, url
order by campaignid asc
2018-04-18 09:35:06,228: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e2f6240>]}
2018-04-18 09:35:07,355: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e2f65f8>]}
2018-04-18 09:35:07,363: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e2f6b38>]}
2018-04-18 09:35:07,628: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1139e9898>]}
2018-04-18 09:35:09,516: 09:35:09 | 2 of 91 OK created table model agency_data_pipeline.monthend_dates... [CREATE TABLE in 2.53s]
2018-04-18 09:35:09,517: 09:35:09 | 5 of 91 START table model agency_data_pipeline.ga_conversions........ [RUN]
2018-04-18 09:35:09,519: Compiling model.agency_data_pipeline.ga_conversions
2018-04-18 09:35:09,528: Writing injected SQL for node "model.agency_data_pipeline.ga_conversions"
2018-04-18 09:35:09,533: Acquiring new bigquery connection "ga_conversions".
2018-04-18 09:35:09,533: Re-using an available connection from the pool.
2018-04-18 09:35:10,200: 09:35:10 | 3 of 91 OK created table model agency_data_pipeline.bing_ads_impression_share [CREATE TABLE in 3.66s]
2018-04-18 09:35:10,201: 09:35:10 | 6 of 91 START table model agency_data_pipeline.bing_ads_ads.......... [RUN]
2018-04-18 09:35:10,203: Compiling model.agency_data_pipeline.bing_ads_ads
2018-04-18 09:35:10,216: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_ads"
2018-04-18 09:35:10,220: Acquiring new bigquery connection "bing_ads_ads".
2018-04-18 09:35:10,220: Re-using an available connection from the pool.
2018-04-18 09:35:10,426: Model SQL (ga_conversions):
select 
client,
client_name,
platform,
goal_name,
goal_type,
account,
time_of_entry
from  ( 

SELECT  
client,
client_name,
platform,
trim(goal_name) goal_name,
goal_type,
account,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform, goal_name ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.conversion_goals` 
WHERE platform = 'Google Analytics'

) 

WHERE lv = time_of_entry
2018-04-18 09:35:10,468: 09:35:10 | 4 of 91 OK created table model agency_data_pipeline.clients_proc..... [CREATE TABLE in 3.66s]
2018-04-18 09:35:10,469: 09:35:10 | 7 of 91 START table model agency_data_pipeline.carts_proc............ [RUN]
2018-04-18 09:35:10,470: Compiling model.agency_data_pipeline.carts_proc
2018-04-18 09:35:10,477: Writing injected SQL for node "model.agency_data_pipeline.carts_proc"
2018-04-18 09:35:10,481: Acquiring new bigquery connection "carts_proc".
2018-04-18 09:35:10,482: Re-using an available connection from the pool.
2018-04-18 09:35:10,718: 09:35:10 | 1 of 91 OK created table model agency_data_pipeline.adwords_urls..... [CREATE TABLE in 3.93s]
2018-04-18 09:35:10,720: 09:35:10 | 8 of 91 START table model agency_data_pipeline.accounts_proc......... [RUN]
2018-04-18 09:35:10,721: Compiling model.agency_data_pipeline.accounts_proc
2018-04-18 09:35:10,726: Writing injected SQL for node "model.agency_data_pipeline.accounts_proc"
2018-04-18 09:35:10,727: Acquiring new bigquery connection "accounts_proc".
2018-04-18 09:35:10,727: Re-using an available connection from the pool.
2018-04-18 09:35:11,087: Model SQL (bing_ads_ads):
select
date, 
account, 
channel,
platform,
campaignid,
campaignname,
max(lower(trim(replace(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$','' ),'.html',''),'/'))) as url,
utm_campaign,
sum(cost) as cost,
sum(impressions) as impressions,
sum(clicks) as clicks,
sum(conversions) as conversions
from 
  ( 
SELECT  
cast(gregoriandate as date) date,
replace(accountname,',','') account,
'Paid' as channel,
'Bing Ads' as platform,
adid,
adtype,
campaignid, 
campaignname,
finalurl url,
case when regexp_contains(destinationurl, 'utm_campaign')
	then replace(lower(nullif(
  

    split(
        
  

    split(
        destinationurl,
        'utm_campaign='
        )[offset(1)]


,
        '&'
        )[offset(0)]


,'')),'+',' ') 
	else null end as utm_campaign,
spend cost, 
impressions, 
clicks, 
conversions,
_sdc_sequence,
first_value(_sdc_sequence) OVER (PARTITION BY adid, gregoriandate ORDER BY _sdc_sequence DESC) lv
FROM `growth-engines-pipeline.bing_ads.ad_performance_report` 
  )

where lv = _sdc_sequence
group by date, account, channel, platform, campaignid, campaignname, utm_campaign
2018-04-18 09:35:11,487: Model SQL (carts_proc):
select 
client,
client_name,
account,
platform
from  ( 

SELECT  
client,
client_name,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.accounts`
WHERE platform in ('Shopify', 'Custom cart')

) 

WHERE lv = time_of_entry
2018-04-18 09:35:11,596: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1139e1940>]}
2018-04-18 09:35:11,717: Model SQL (accounts_proc):
select 
client,
account,
platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.accounts` 

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-04-18 09:35:13,692: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1139db828>]}
2018-04-18 09:35:14,114: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e31b8d0>]}
2018-04-18 09:35:14,405: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1116712e8>]}
2018-04-18 09:35:14,927: 09:35:14 | 5 of 91 OK created table model agency_data_pipeline.ga_conversions... [CREATE TABLE in 2.08s]
2018-04-18 09:35:14,928: 09:35:14 | 9 of 91 START table model agency_data_pipeline.adwords_conversions... [RUN]
2018-04-18 09:35:14,928: Compiling model.agency_data_pipeline.adwords_conversions
2018-04-18 09:35:14,938: Writing injected SQL for node "model.agency_data_pipeline.adwords_conversions"
2018-04-18 09:35:14,940: Acquiring new bigquery connection "adwords_conversions".
2018-04-18 09:35:14,941: Re-using an available connection from the pool.
2018-04-18 09:35:15,853: Model SQL (adwords_conversions):
select 
client,
client_name,
platform,
goal_name,
goal_type,
account,
time_of_entry
from  ( 

SELECT  
client,
client_name,
platform,
trim(lower(goal_name)) goal_name,
goal_type,
account,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform, goal_name ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.conversion_goals` 
WHERE platform = 'Adwords'

) 

WHERE lv = time_of_entry
2018-04-18 09:35:16,959: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e2246a0>]}
2018-04-18 09:35:17,998: 09:35:17 | 7 of 91 OK created table model agency_data_pipeline.carts_proc....... [CREATE TABLE in 3.22s]
2018-04-18 09:35:17,999: 09:35:17 | 10 of 91 START table model agency_data_pipeline.conversion_goals_proc [RUN]
2018-04-18 09:35:18,000: Compiling model.agency_data_pipeline.conversion_goals_proc
2018-04-18 09:35:18,010: Writing injected SQL for node "model.agency_data_pipeline.conversion_goals_proc"
2018-04-18 09:35:18,012: Acquiring new bigquery connection "conversion_goals_proc".
2018-04-18 09:35:18,012: Re-using an available connection from the pool.
2018-04-18 09:35:18,593: 09:35:18 | 8 of 91 OK created table model agency_data_pipeline.accounts_proc.... [CREATE TABLE in 3.39s]
2018-04-18 09:35:18,594: 09:35:18 | 11 of 91 START table model agency_data_pipeline.adwords_campaigns.... [RUN]
2018-04-18 09:35:18,595: Compiling model.agency_data_pipeline.adwords_campaigns
2018-04-18 09:35:18,606: Writing injected SQL for node "model.agency_data_pipeline.adwords_campaigns"
2018-04-18 09:35:18,609: Acquiring new bigquery connection "adwords_campaigns".
2018-04-18 09:35:18,609: Re-using an available connection from the pool.
2018-04-18 09:35:18,922: 09:35:18 | 6 of 91 OK created table model agency_data_pipeline.bing_ads_ads..... [CREATE TABLE in 4.20s]
2018-04-18 09:35:18,922: 09:35:18 | 12 of 91 START table model agency_data_pipeline.all_dates............ [RUN]
2018-04-18 09:35:18,924: Compiling model.agency_data_pipeline.all_dates
2018-04-18 09:35:18,932: Writing injected SQL for node "model.agency_data_pipeline.all_dates"
2018-04-18 09:35:18,938: Acquiring new bigquery connection "all_dates".
2018-04-18 09:35:18,939: Re-using an available connection from the pool.
2018-04-18 09:35:19,138: Model SQL (conversion_goals_proc):
select 
client,
platform,
goal_name,
max(goal_type) goal_type,
account,
max(time_of_entry) time_of_entry
from  ( 

SELECT  
client,
platform,
trim(replace(replace(lower(goal_name),',',''),' ','')) goal_name,
goal_type,
account,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY platform ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.conversion_goals` 

) 

WHERE lv = time_of_entry
group by client, platform, account, goal_name
2018-04-18 09:35:19,644: 09:35:19 | 9 of 91 OK created table model agency_data_pipeline.adwords_conversions [CREATE TABLE in 2.03s]
2018-04-18 09:35:19,696: Model SQL (adwords_campaigns):
select
day,
campaignid, 
campaign,
account, 
channel,
platform,
sum(cost) cost,
sum(impressions) impressions,
sum(clicks) clicks,
sum(impression_share_num) impression_share_num,
sum(impression_share_den) impression_share_den
from 
  ( 
	SELECT  
	day,
	campaignid,
	campaign,
	account as account,
	'Paid' as channel,
	'Adwords' as platform,
	cost/1000000 cost, 
	impressions as impressions, 
	clicks, 
	case when searchimprshare is not null then impressions end as impression_share_num,
	case when searchimprshare is not null then impressions/(searchimprshare/100) end as impression_share_den,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY campaignid, day ORDER BY _sdc_sequence DESC) lv
	FROM `growth-engines-pipeline.adwords_2.CAMPAIGN_PERFORMANCE_REPORT`
  )
where lv = _sdc_sequence
group by day, campaignid, account, channel, platform, campaign
2018-04-18 09:35:19,899: Model SQL (all_dates):
SELECT 
date_in_range,
unix_date(date_in_range) unix_date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-04-18 09:35:20,259: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1139d6cf8>]}
2018-04-18 09:35:20,523: 09:35:20 | 10 of 91 OK created table model agency_data_pipeline.conversion_goals_proc [CREATE TABLE in 2.26s]
2018-04-18 09:35:21,025: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1116712e8>]}
2018-04-18 09:35:22,401: 09:35:22 | 12 of 91 OK created table model agency_data_pipeline.all_dates....... [CREATE TABLE in 2.10s]
2018-04-18 09:35:25,277: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e314198>]}
2018-04-18 09:35:27,623: 09:35:27 | 11 of 91 OK created table model agency_data_pipeline.adwords_campaigns [CREATE TABLE in 6.68s]
2018-04-18 09:35:27,624: 09:35:27 | 13 of 91 START table model agency_data_pipeline.adwords_ads.......... [RUN]
2018-04-18 09:35:27,625: Compiling model.agency_data_pipeline.adwords_ads
2018-04-18 09:35:27,624: 09:35:27 | 14 of 91 START table model agency_data_pipeline.mappings_ga_proc..... [RUN]
2018-04-18 09:35:27,632: Compiling model.agency_data_pipeline.mappings_ga_proc
2018-04-18 09:35:27,639: Writing injected SQL for node "model.agency_data_pipeline.adwords_ads"
2018-04-18 09:35:27,625: 09:35:27 | 15 of 91 START table model agency_data_pipeline.fb_ads_insights...... [RUN]
2018-04-18 09:35:27,643: Writing injected SQL for node "model.agency_data_pipeline.mappings_ga_proc"
2018-04-18 09:35:27,625: 09:35:27 | 16 of 91 START table model agency_data_pipeline.bing_ads_conversions. [RUN]
2018-04-18 09:35:27,644: Compiling model.agency_data_pipeline.fb_ads_insights
2018-04-18 09:35:27,645: Acquiring new bigquery connection "adwords_ads".
2018-04-18 09:35:27,652: Re-using an available connection from the pool.
2018-04-18 09:35:27,646: Compiling model.agency_data_pipeline.bing_ads_conversions
2018-04-18 09:35:27,658: Acquiring new bigquery connection "fb_ads_insights".
2018-04-18 09:35:27,674: Re-using an available connection from the pool.
2018-04-18 09:35:27,676: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_conversions"
2018-04-18 09:35:27,678: Acquiring new bigquery connection "mappings_ga_proc".
2018-04-18 09:35:27,678: Fetching data for query fb_ads_insights:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 09:35:27,680: Re-using an available connection from the pool.
2018-04-18 09:35:27,685: Acquiring new bigquery connection "bing_ads_conversions".
2018-04-18 09:35:27,688: Re-using an available connection from the pool.
2018-04-18 09:35:28,559: Model SQL (mappings_ga_proc):
select 
client,
account,
client_name,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
account,
client_name,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.mappings_ga` 

) 

WHERE lv = time_of_entry
and client in (select client from `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc` )
group by client, account, client_name, source, medium, platform_n, channel_n, time_of_entry
2018-04-18 09:35:28,560: Model SQL (adwords_ads):
SELECT  
day,
campaignid,
a.account as account,
utm_campaign,
sum( case when b.goal_type = 'Transaction' then conversions else 0 end ) as transactions
FROM (

	SELECT  
	day,
	adid,
	campaignid,
	account,
	lower(conversionname) conversionname,
	conversions,
	lower(campaign) utm_campaign,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY campaignid, day ORDER BY _sdc_sequence DESC) lv
	FROM
	`growth-engines-pipeline.adwords_2.AD_PERFORMANCE_REPORT`

) a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_conversions` b
ON ( a.conversionname = b.goal_name
	AND a.account = b.account )
WHERE lv = _sdc_sequence
group by day, campaignid, account, utm_campaign
2018-04-18 09:35:28,610: Model SQL (bing_ads_conversions):
SELECT
date, 
a.account account, 
a.channel channel,
a.platform platform,
campaignid,
campaignname,
sum( case when b.goal_type = 'Transactions' then conversions else 0 end ) as transactions
FROM

  ( 
SELECT  
cast(gregoriandate as date) date,
replace(accountname,',','') account,
'Paid' as channel,
'Bing Ads' as platform,
trim(replace(replace(lower(goal),',',''),' ','')) goal,
goalid,
campaignid,
campaignname,
conversions,
_sdc_sequence,
first_value(_sdc_sequence) OVER (PARTITION BY campaignid, goalid, gregoriandate ORDER BY _sdc_sequence DESC) lv
FROM `growth-engines-pipeline.bing_ads.goals_and_funnels_report` 

  ) a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`conversion_goals_proc` b
ON (
	a.account = b.account AND
	a.platform = b.platform AND
	a.goal = b.goal_name
)
where a.lv = a._sdc_sequence
group by date, account, channel, platform, campaignid, campaignname
2018-04-18 09:35:28,816: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_insights"
2018-04-18 09:35:29,652: Model SQL (fb_ads_insights):




with fb_ads_insights as (

	    
		   	SELECT 
			date_start,
			campaign_id,
			campaign_name,
			ad_id,
			account_name,
			spend,
			reach,
			inline_link_clicks,
			_sdc_sequence,
			first_value(_sdc_sequence) OVER (PARTITION BY date_start, ad_id, campaign_id ORDER BY _sdc_sequence DESC) lv
			FROM `growth-engines-pipeline.fb_ads_luca_danni.ads_insights`
		    
	   

)

select
date_start date,
campaign_id,
campaign_name campaign,
ad_id,
account_name account,
max(spend) cost,
max(reach) impressions,
max(inline_link_clicks) clicks
from fb_ads_insights
where lv = _sdc_sequence
group by date, campaign_id, ad_id, account, campaign


2018-04-18 09:35:30,803: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113a2c518>]}
2018-04-18 09:35:30,865: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113a013c8>]}
2018-04-18 09:35:31,026: 09:35:31 | 14 of 91 OK created table model agency_data_pipeline.mappings_ga_proc [CREATE TABLE in 3.17s]
2018-04-18 09:35:31,027: 09:35:31 | 17 of 91 START table model agency_data_pipeline.fb_ads_insights_conversions [RUN]
2018-04-18 09:35:31,028: Compiling model.agency_data_pipeline.fb_ads_insights_conversions
2018-04-18 09:35:31,037: Acquiring new bigquery connection "fb_ads_insights_conversions".
2018-04-18 09:35:31,037: Re-using an available connection from the pool.
2018-04-18 09:35:31,037: Fetching data for query fb_ads_insights_conversions:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 09:35:31,530: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_insights_conversions"
2018-04-18 09:35:32,763: Model SQL (fb_ads_insights_conversions):




with fb_ads_insights_conversions as (

	    
		   	SELECT 
			date_start,
			campaign_id,
			campaign_name,
			ad_id,
			account_name,
			spend,
			reach,
			inline_link_clicks,
			_sdc_sequence,
			action_type,
			value
			FROM `growth-engines-pipeline.fb_ads_luca_danni.ads_insights`
			cross join unnest(actions)
		    
	   

)

SELECT * 
FROM 
	(
    SELECT
    date_start date,
    campaign_id,
    campaign_name campaign,
    ad_id,
    account_name account,
    action_type,
    value conversions,
    first_value(_sdc_sequence) OVER (PARTITION BY ad_id, date_start ORDER BY _sdc_sequence DESC) lv,
    _sdc_sequence
    FROM fb_ads_insights_conversions
   	)
where lv = _sdc_sequence
and action_type like '%purchase%'


2018-04-18 09:35:32,935: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e33a978>]}
2018-04-18 09:35:32,940: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1139e9048>]}
2018-04-18 09:35:34,279: 09:35:34 | 16 of 91 OK created table model agency_data_pipeline.bing_ads_conversions [CREATE TABLE in 3.22s]
2018-04-18 09:35:34,281: 09:35:34 | 18 of 91 START table model agency_data_pipeline.ga_mcf_proc.......... [RUN]
2018-04-18 09:35:34,283: Compiling model.agency_data_pipeline.ga_mcf_proc
2018-04-18 09:35:34,294: Writing injected SQL for node "model.agency_data_pipeline.ga_mcf_proc"
2018-04-18 09:35:34,295: Acquiring new bigquery connection "ga_mcf_proc".
2018-04-18 09:35:34,295: Re-using an available connection from the pool.
2018-04-18 09:35:35,123: Model SQL (ga_mcf_proc):
SELECT 
date,
account,
'Google Analytics' as lookup_platform,
source_medium_path,
trim(lower(split(split(source_medium_path,'->')[SAFE_ORDINAL(1)],'/')[SAFE_ORDINAL(1)])) as source,
trim(lower(split(split(source_medium_path,'->')[SAFE_ORDINAL(1)],'/')[SAFE_ORDINAL(2)])) as medium,
first_interaction_campaign campaign,
cast(regexp_replace(transaction_id, r'#', '') as int64) transactionid,
max(first_interaction_conversions) transactions,
max(first_interaction_conversion_value) revenue
FROM `growth-engines-pipeline.agency_data_pipeline.ga_mcf`
where account in (select account from `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc` where platform = 'Google Analytics')
group by date, account, source, medium, campaign, source_medium_path, lookup_platform, transactionid
2018-04-18 09:35:35,975: 09:35:35 | 13 of 91 OK created table model agency_data_pipeline.adwords_ads..... [CREATE TABLE in 5.31s]
2018-04-18 09:35:35,976: 09:35:35 | 19 of 91 START table model agency_data_pipeline.shopify_refunds_proc. [RUN]
2018-04-18 09:35:35,977: Compiling model.agency_data_pipeline.shopify_refunds_proc
2018-04-18 09:35:35,990: Acquiring new bigquery connection "shopify_refunds_proc".
2018-04-18 09:35:35,990: Re-using an available connection from the pool.
2018-04-18 09:35:35,991: Fetching data for query shopify_refunds_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 09:35:37,162: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1116711d0>]}
2018-04-18 09:35:37,260: Writing injected SQL for node "model.agency_data_pipeline.shopify_refunds_proc"
2018-04-18 09:35:38,271: Model SQL (shopify_refunds_proc):




with refunds as (

	
	SELECT
	order_number,
	checkout_id,
	financial_status,
	line_item_id,
	quantity,
	subtotal,
	line_item.variant_id variant_id,
	line_item.id refund_id,
 	_sdc_sequence
	FROM `growth-engines-pipeline.shopify_lucadanni.orders` 
	cross join unnest(refunds), unnest(refund_line_items)
  	where financial_status like '%refund%'
	
	

)

SELECT * 
FROM 
	(
    SELECT
	order_number,
	checkout_id,
	financial_status,
	line_item_id,
	quantity,
	subtotal refund_amount,
	variant_id,
	refund_id,
 	_sdc_sequence,
    first_value(_sdc_sequence) OVER (PARTITION BY order_number, line_item_id ORDER BY _sdc_sequence DESC) lv
    FROM refunds
   	) 
WHERE lv = _sdc_sequence


2018-04-18 09:35:38,857: 09:35:38 | 15 of 91 OK created table model agency_data_pipeline.fb_ads_insights. [CREATE TABLE in 5.30s]
2018-04-18 09:35:38,858: 09:35:38 | 20 of 91 START table model agency_data_pipeline.fb_adcreative........ [RUN]
2018-04-18 09:35:38,858: Compiling model.agency_data_pipeline.fb_adcreative
2018-04-18 09:35:38,868: Acquiring new bigquery connection "fb_adcreative".
2018-04-18 09:35:38,869: Re-using an available connection from the pool.
2018-04-18 09:35:38,870: Fetching data for query fb_adcreative:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 09:35:39,457: Writing injected SQL for node "model.agency_data_pipeline.fb_adcreative"
2018-04-18 09:35:40,360: Model SQL (fb_adcreative):




with fb_adcreative as (


	    
		   	SELECT 
			id,
			object_url,
			url_tags,
			_sdc_sequence
			FROM `growth-engines-pipeline.fb_ads_luca_danni.adcreative`
		    
	   
)

select creative_id, max(url) url
from (
  select
  id creative_id,
  lower(trim(regexp_replace(replace(replace(replace(replace(object_url,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
  first_value(_sdc_sequence) OVER (PARTITION BY id ORDER BY _sdc_sequence DESC) lv,
  _sdc_sequence
  from fb_adcreative
  )
where lv = _sdc_sequence
group by creative_id


2018-04-18 09:35:40,678: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e33a978>]}
2018-04-18 09:35:40,767: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1139d6c50>]}
2018-04-18 09:35:42,164: 09:35:42 | 17 of 91 OK created table model agency_data_pipeline.fb_ads_insights_conversions [CREATE TABLE in 6.13s]
2018-04-18 09:35:42,560: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1139cf6d8>]}
2018-04-18 09:35:45,549: 09:35:45 | 19 of 91 OK created table model agency_data_pipeline.shopify_refunds_proc [CREATE TABLE in 4.70s]
2018-04-18 09:35:45,762: 09:35:45 | 18 of 91 OK created table model agency_data_pipeline.ga_mcf_proc..... [CREATE TABLE in 6.48s]
2018-04-18 09:35:48,103: 09:35:48 | 20 of 91 OK created table model agency_data_pipeline.fb_adcreative... [CREATE TABLE in 3.70s]
2018-04-18 09:35:48,104: 09:35:48 | 21 of 91 START table model agency_data_pipeline.fb_ads............... [RUN]
2018-04-18 09:35:48,105: Compiling model.agency_data_pipeline.fb_ads
2018-04-18 09:35:48,105: 09:35:48 | 22 of 91 START table model agency_data_pipeline.shopify_customers_proc [RUN]
2018-04-18 09:35:48,118: Compiling model.agency_data_pipeline.shopify_customers_proc
2018-04-18 09:35:48,119: Acquiring new bigquery connection "fb_ads".
2018-04-18 09:35:48,125: Re-using an available connection from the pool.
2018-04-18 09:35:48,126: Fetching data for query fb_ads:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 09:35:48,134: Acquiring new bigquery connection "shopify_customers_proc".
2018-04-18 09:35:48,135: Re-using an available connection from the pool.
2018-04-18 09:35:48,135: Fetching data for query shopify_customers_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 09:35:48,516: Writing injected SQL for node "model.agency_data_pipeline.fb_ads"
2018-04-18 09:35:48,526: Writing injected SQL for node "model.agency_data_pipeline.shopify_customers_proc"
2018-04-18 09:35:49,535: Model SQL (shopify_customers_proc):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc`





with customers as (

	
	SELECT
	'lucadanni' client_name,
	'Shopify' as lookup_platform,
	cast(created_at as date) created_at,
	id,
	first_name,
	last_name,
	email,
	_sdc_sequence,
	first_value(_sdc_sequence) over (partition by id, _sdc_sequence order by _sdc_sequence desc) lv
	FROM `growth-engines-pipeline.shopify_lucadanni.customers` 
	
	

)

SELECT
account,
client,
platform,
id,
min(created_at) created_at,
max(first_name) first_name,
max(last_name) last_name,
max(email) email
FROM (
	SELECT
	b.account,
	b.client,
	b.platform,
	created_at,
	id,
	first_name,
	last_name,
	email
	FROM customers a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
	ON ( a.client_name = b.client_name
	  AND a.lookup_platform = b.platform )
	where a.lv = a._sdc_sequence
)
group by account, client, platform, id

2018-04-18 09:35:49,547: Model SQL (fb_ads):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`fb_adcreative`





with fb_ads as (

	    
		   	SELECT 
			id ad_id,
			creative.creative_id creative_id,
			_sdc_sequence
			FROM `growth-engines-pipeline.fb_ads_luca_danni.ads`
		     
	   

)

SELECT
a.ad_id,
b.creative_id,
b.url
FROM (
    SELECT
    ad_id,
    creative_id,
    first_value(_sdc_sequence) OVER (PARTITION BY ad_id ORDER BY _sdc_sequence DESC) lv,
    _sdc_sequence
    FROM fb_ads
    ) a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`fb_adcreative` b
ON (
	a.creative_id = b.creative_id 
)
WHERE a.lv = a._sdc_sequence


2018-04-18 09:35:51,739: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e314198>]}
2018-04-18 09:35:52,057: 09:35:52 | 21 of 91 OK created table model agency_data_pipeline.fb_ads.......... [CREATE TABLE in 3.63s]
2018-04-18 09:35:55,236: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113a05080>]}
2018-04-18 09:35:55,511: 09:35:55 | 22 of 91 OK created table model agency_data_pipeline.shopify_customers_proc [CREATE TABLE in 7.12s]
2018-04-18 09:35:55,512: 09:35:55 | 23 of 91 START table model agency_data_pipeline.agg_customers_union.. [RUN]
2018-04-18 09:35:55,513: 09:35:55 | 24 of 91 START table model agency_data_pipeline.shopify_products_proc [RUN]
2018-04-18 09:35:55,513: 09:35:55 | 25 of 91 START table model agency_data_pipeline.ga_mcf_stats......... [RUN]
2018-04-18 09:35:55,513: Compiling model.agency_data_pipeline.agg_customers_union
2018-04-18 09:35:55,513: 09:35:55 | 26 of 91 START table model agency_data_pipeline.bing_ads_stats....... [RUN]
2018-04-18 09:35:55,514: Compiling model.agency_data_pipeline.shopify_products_proc
2018-04-18 09:35:55,514: Compiling model.agency_data_pipeline.ga_mcf_stats
2018-04-18 09:35:55,521: Compiling model.agency_data_pipeline.bing_ads_stats
2018-04-18 09:35:55,521: Writing injected SQL for node "model.agency_data_pipeline.agg_customers_union"
2018-04-18 09:35:55,533: Writing injected SQL for node "model.agency_data_pipeline.ga_mcf_stats"
2018-04-18 09:35:55,534: Acquiring new bigquery connection "shopify_products_proc".
2018-04-18 09:35:55,539: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_stats"
2018-04-18 09:35:55,539: Re-using an available connection from the pool.
2018-04-18 09:35:55,540: Acquiring new bigquery connection "agg_customers_union".
2018-04-18 09:35:55,541: Acquiring new bigquery connection "ga_mcf_stats".
2018-04-18 09:35:55,541: Fetching data for query shopify_products_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 09:35:55,541: Acquiring new bigquery connection "bing_ads_stats".
2018-04-18 09:35:55,541: Re-using an available connection from the pool.
2018-04-18 09:35:55,543: Re-using an available connection from the pool.
2018-04-18 09:35:55,546: Re-using an available connection from the pool.
2018-04-18 09:35:55,927: Writing injected SQL for node "model.agency_data_pipeline.shopify_products_proc"
2018-04-18 09:35:56,309: Model SQL (bing_ads_stats):
select
a.date, 
a.account, 
a.channel,
a.platform,
url,
a.campaignname campaign,
utm_campaign,
cost,
clicks,
impressions,
transactions
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`bing_ads_ads` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`bing_ads_conversions` b
ON (
	a.date = b.date AND
	a.account = b.account AND
	a.campaignid = b.campaignid

)
2018-04-18 09:35:56,318: Model SQL (agg_customers_union):
SELECT *
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`shopify_customers_proc`
2018-04-18 09:35:56,447: Model SQL (ga_mcf_stats):
SELECT  
date,
a.account account,
b.client client,
case when c.platform is null then "Unmapped" else c.platform end as platform,
case when c.channel is null then "Unmapped" else c.channel end as channel,
lower(a.source) source,
lower(a.medium) medium,
lower(campaign) campaign,
transactionid,
sum(transactions) first_touch_transactions,
sum(revenue) first_touch_revenue
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`ga_mcf_proc` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc` b 
ON ( a.account = b.account and
	a.lookup_platform = b.platform )
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc` c
ON ( lower(a.source) = c.source
  AND lower(a.medium) = c.medium 
  and a.account = c.account )
group by date, account, client, source, medium, campaign, platform, channel, transactionid
2018-04-18 09:35:56,814: Model SQL (shopify_products_proc):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc`, `growth-engines-pipeline`.`agency_data_pipeline`.`shopify_refunds_proc`





with products as (

	
	SELECT
	'lucadanni' client_name,
	'Shopify' as lookup_platform,
	product_type,
	product_id,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY product_id ORDER BY _sdc_sequence DESC) lv
	FROM `growth-engines-pipeline.shopify_lucadanni.products` 
	cross join unnest(variants)
	
	

)

SELECT
b.account,
b.client,
b.platform,
max(product_type) product_type,
product_id
FROM products a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
ON ( a.client_name = b.client_name
  AND a.lookup_platform = b.platform )
where a.lv = a._sdc_sequence
group by product_id, account, client, platform


2018-04-18 09:35:58,553: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111658e48>]}
2018-04-18 09:35:58,990: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e314198>]}
2018-04-18 09:35:59,654: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1139e1358>]}
2018-04-18 09:36:00,841: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113a05a20>]}
2018-04-18 09:36:01,313: 09:36:01 | 26 of 91 OK created table model agency_data_pipeline.bing_ads_stats.. [CREATE TABLE in 3.03s]
2018-04-18 09:36:01,314: 09:36:01 | 27 of 91 START table model agency_data_pipeline.shopify_orders_proc.. [RUN]
2018-04-18 09:36:01,315: Compiling model.agency_data_pipeline.shopify_orders_proc
2018-04-18 09:36:01,326: Acquiring new bigquery connection "shopify_orders_proc".
2018-04-18 09:36:01,326: Re-using an available connection from the pool.
2018-04-18 09:36:01,326: Fetching data for query shopify_orders_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 09:36:01,733: Writing injected SQL for node "model.agency_data_pipeline.shopify_orders_proc"
2018-04-18 09:36:02,948: Model SQL (shopify_orders_proc):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc`, `growth-engines-pipeline`.`agency_data_pipeline`.`shopify_refunds_proc`





with orders as (

	
	SELECT
	'lucadanni' client_name,
	'Shopify' as lookup_platform,
	created_at,
	order_number,
	quantity,
	cast(pre_tax_price as float64) price, 
	total_line_items_price total_order_price_undiscounted,
	total_discounts,
	cast(discounted_price as float64) total_order_shipping_price,
	total_price_usd total_order_price_incl_shipping,
	checkout_id,
	product_id, 
	landing_site,
	sku, 
	variant_title, 
	variant_id,
	_id line_item_id,
	customer.id customer_id,
	customer.orders_count orders_count,
	customer.created_at customer_created_at,
	customer.last_order_id last_order_id,
	financial_status,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY order_number, _id ORDER BY _sdc_sequence DESC) lv
	FROM `growth-engines-pipeline.shopify_lucadanni.orders` 
	cross join unnest(line_items), unnest(shipping_lines)
	where source_name != 'shopify_draft_order'
	
	

)

SELECT
b.account,
b.client,
b.platform,
created_at,
a.order_number,
a.quantity,
c.quantity refund_quantity,
case when c.quantity is not null then a.quantity - c.quantity else a.quantity end as final_quantity,
price, 
total_order_price_undiscounted,
total_discounts,
total_order_shipping_price,
total_order_price_incl_shipping,
refund_amount,
case when refund_amount is not null then price - refund_amount else price end as final_price,
a.checkout_id,
a.product_id, 
landing_site,
sku, 
variant_title, 
a.variant_id,
a.line_item_id,	
customer_id,
orders_count,
customer_created_at,
last_order_id,
a.financial_status
FROM orders a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
ON ( a.client_name = b.client_name
  AND a.lookup_platform = b.platform )
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`shopify_refunds_proc` c
ON ( a.order_number = c.order_number
	AND a.line_item_id = c.line_item_id )   	
where a.lv = a._sdc_sequence


2018-04-18 09:36:04,386: 09:36:04 | 24 of 91 OK created table model agency_data_pipeline.shopify_products_proc [CREATE TABLE in 3.48s]
2018-04-18 09:36:04,639: 09:36:04 | 23 of 91 OK created table model agency_data_pipeline.agg_customers_union [CREATE TABLE in 4.14s]
2018-04-18 09:36:05,179: 09:36:05 | 25 of 91 OK created table model agency_data_pipeline.ga_mcf_stats.... [CREATE TABLE in 5.33s]
2018-04-18 09:36:10,660: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111658e48>]}
2018-04-18 09:36:10,971: 09:36:10 | 27 of 91 OK created table model agency_data_pipeline.shopify_orders_proc [CREATE TABLE in 9.35s]
2018-04-18 09:36:10,972: 09:36:10 | 28 of 91 START table model agency_data_pipeline.adwords_join......... [RUN]
2018-04-18 09:36:10,973: Compiling model.agency_data_pipeline.adwords_join
2018-04-18 09:36:10,972: 09:36:10 | 30 of 91 START table model agency_data_pipeline.agg_orders_union..... [RUN]
2018-04-18 09:36:10,973: 09:36:10 | 31 of 91 START table model agency_data_pipeline.agg_products......... [RUN]
2018-04-18 09:36:10,972: 09:36:10 | 29 of 91 START table model agency_data_pipeline.ga_traffic........... [RUN]
2018-04-18 09:36:10,980: Writing injected SQL for node "model.agency_data_pipeline.adwords_join"
2018-04-18 09:36:10,980: Compiling model.agency_data_pipeline.agg_orders_union
2018-04-18 09:36:10,980: Compiling model.agency_data_pipeline.agg_products
2018-04-18 09:36:10,980: Compiling model.agency_data_pipeline.ga_traffic
2018-04-18 09:36:10,990: Writing injected SQL for node "model.agency_data_pipeline.agg_orders_union"
2018-04-18 09:36:10,998: Acquiring new bigquery connection "adwords_join".
2018-04-18 09:36:11,027: Re-using an available connection from the pool.
2018-04-18 09:36:11,003: Writing injected SQL for node "model.agency_data_pipeline.agg_products"
2018-04-18 09:36:11,036: Acquiring new bigquery connection "agg_orders_union".
2018-04-18 09:36:11,048: Acquiring new bigquery connection "ga_traffic".
2018-04-18 09:36:11,049: Re-using an available connection from the pool.
2018-04-18 09:36:11,050: Re-using an available connection from the pool.
2018-04-18 09:36:11,051: Fetching data for query ga_traffic:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'GA Traffic'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 09:36:11,053: Acquiring new bigquery connection "agg_products".
2018-04-18 09:36:11,056: Re-using an available connection from the pool.
2018-04-18 09:36:11,959: Model SQL (agg_orders_union):
SELECT
account,
client,
platform,
created_at,
order_number,
quantity,
refund_quantity,
final_quantity,
price, 
total_order_price_undiscounted,
total_discounts,
total_order_shipping_price,
total_order_price_incl_shipping,
refund_amount,
final_price,
checkout_id,
product_id, 
landing_site,
sku, 
variant_title, 
variant_id,
line_item_id,	
customer_id,
orders_count,
customer_created_at,
last_order_id,
financial_status
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`shopify_orders_proc`
2018-04-18 09:36:12,076: Model SQL (agg_products):
SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`shopify_products_proc`
2018-04-18 09:36:12,213: Model SQL (adwords_join):
select
a.day,
a.campaignid, 
a.campaign,
a.account, 
channel,
platform,
url,
utm_campaign,
cost,
impressions,
clicks,
impression_share_num,
impression_share_den,
transactions
FROM ( 
	
	select
	day,
	a.campaign,
	a.campaignid, 
	account, 
	channel,
	platform,
	url,
	cost,
	impressions,
	clicks,
	impression_share_num,
	impression_share_den
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_campaigns` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_urls` b
	ON a.campaignid = b.campaignid

) a 
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_ads` b
ON ( a.campaignid = b.campaignid
	and a.day = b.day )
2018-04-18 09:36:12,576: Fetching data for query ga_traffic:


        select
            goal_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_conversions`

        
        ##where 1 = 1
        where goal_type = 'Conversion'
        
        
        
        ##and 2 = 2
        and client_name = 'lucadanni'
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 09:36:13,157: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113a23cf8>]}
2018-04-18 09:36:14,106: Writing injected SQL for node "model.agency_data_pipeline.ga_traffic"
2018-04-18 09:36:15,035: Model SQL (ga_traffic):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc`, `growth-engines-pipeline`.`agency_data_pipeline`.`ga_conversions`


##`growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` 



with ga_report as (

	    

	    	
	    	
		   	SELECT
		   	'lucadanni' as client_name,
		   	'GA Traffic' as lookup_platform,
			lower(trim(regexp_replace(replace(replace(replace(replace(CONCAT(hostname,landingpagepath),'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
			date,
			lower(source) source,
			lower(medium) medium,
			lower(campaign) campaign,
			sessions,
			## goal completion columns
							
				goalcompletionsall as goal_completions,		
			
			_sdc_sequence,
			first_value(_sdc_sequence) OVER (PARTITION BY hostname, landingpagepath, date, source, medium, campaign ORDER BY _sdc_sequence DESC) lv
			FROM `growth-engines-pipeline.ga_lucadanni_traffic.report` 

		    
	   

)


SELECT  
cast(date as date) date,
b.account,
b.client client,
c.source source,
c.medium medium,
a.campaign campaign,
concat(a.source, ' / ', a.medium) source_medium,  
case when c.platform is null then "Unmapped" else c.platform end as platform,
case when c.channel is null then "Unmapped" else c.channel end as channel,
regexp_replace(url, r'offers.|offer.|get.|info.|pos.|go.|join.|pages.','') url,
max(sessions) sessions,
max(goal_completions) goal_completions
FROM ga_report a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
ON ( a.client_name = b.client_name 
	AND a.lookup_platform = b.platform )
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc` c
ON ( a.source = c.source
  AND a.medium = c.medium 
  AND a.client_name = c.client_name )
GROUP BY date, account, client, source, medium, campaign, source_medium, platform, channel, url


2018-04-18 09:36:16,363: 09:36:16 | 31 of 91 OK created table model agency_data_pipeline.agg_products.... [CREATE TABLE in 2.18s]
2018-04-18 09:36:16,364: 09:36:16 | 32 of 91 START table model agency_data_pipeline.ga_transactions...... [RUN]
2018-04-18 09:36:16,364: Compiling model.agency_data_pipeline.ga_transactions
2018-04-18 09:36:16,377: Acquiring new bigquery connection "ga_transactions".
2018-04-18 09:36:16,377: Re-using an available connection from the pool.
2018-04-18 09:36:16,377: Fetching data for query ga_transactions:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Google Analytics'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 09:36:17,767: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e3731d0>]}
2018-04-18 09:36:17,798: Fetching data for query ga_transactions:


        select
            goal_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_conversions`

        
        ##where 1 = 1
        where goal_type = 'Conversion'
        
        
        
        ##and 2 = 2
        and client_name = 'lucadanni'
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 09:36:18,158: Writing injected SQL for node "model.agency_data_pipeline.ga_transactions"
2018-04-18 09:36:19,230: Model SQL (ga_transactions):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc`, `growth-engines-pipeline`.`agency_data_pipeline`.`ga_conversions`


##`growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` 



with ga_report as (

	    

	    	
	    	
		   	SELECT
		   	'lucadanni' as client_name,
		   	'Google Analytics' as lookup_platform,
			lower(trim(regexp_replace(replace(replace(replace(replace(CONCAT(hostname,landingpagepath),'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
			date,
			lower(source) source,
			lower(medium) medium,
			lower(campaign) campaign,
			cast(regexp_replace(transactionid, r'#', '') as int64) transactionid,
			transactions last_touch_transactions,
			(transactionrevenue - transactionshipping - transactiontax) as last_touch_revenue,
			transactionshipping,
			transactiontax,
			_sdc_sequence,
			first_value(_sdc_sequence) OVER (PARTITION BY hostname, landingpagepath, date, source, medium, transactionid ORDER BY _sdc_sequence DESC) lv
			FROM `growth-engines-pipeline.ga_lucadanni.report` 

		    
	   

)


SELECT  
cast(date as date) date,
b.account,
b.client client,
c.source source,
c.medium medium,
a.campaign campaign,
concat(a.source, ' / ', a.medium) source_medium,  
case when c.platform is null then "Unmapped" else c.platform end as platform,
case when c.channel is null then "Unmapped" else c.channel end as channel,
regexp_replace(url, r'offers.|offer.|get.|info.|pos.|go.|join.|pages.','') url,
transactionid,
max(last_touch_transactions) last_touch_transactions,
max(last_touch_revenue) last_touch_revenue,
max(transactionshipping) last_touch_shipping,
max(transactiontax) last_touch_tax
FROM ga_report a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
ON ( a.client_name = b.client_name 
	AND a.lookup_platform = b.platform )
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc` c
ON ( a.source = c.source
  AND a.medium = c.medium 
  AND a.client_name = c.client_name )
GROUP BY date, account, client, source, medium, campaign, source_medium, platform, channel, url, transactionid


2018-04-18 09:36:19,638: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e373978>]}
2018-04-18 09:36:21,445: 09:36:21 | 28 of 91 OK created table model agency_data_pipeline.adwords_join.... [CREATE TABLE in 6.79s]
2018-04-18 09:36:22,708: 09:36:22 | 30 of 91 OK created table model agency_data_pipeline.agg_orders_union [CREATE TABLE in 8.66s]
2018-04-18 09:36:25,865: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113a01b38>]}
2018-04-18 09:36:26,169: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1139e1400>]}
2018-04-18 09:36:29,378: 09:36:29 | 32 of 91 OK created table model agency_data_pipeline.ga_transactions. [CREATE TABLE in 9.50s]
2018-04-18 09:36:31,524: 09:36:31 | 29 of 91 OK created table model agency_data_pipeline.ga_traffic...... [CREATE TABLE in 15.19s]
2018-04-18 09:36:31,525: 09:36:31 | 33 of 91 START table model agency_data_pipeline.agg_transaction_order_number [RUN]
2018-04-18 09:36:31,526: Compiling model.agency_data_pipeline.agg_transaction_order_number
2018-04-18 09:36:31,525: 09:36:31 | 34 of 91 START table model agency_data_pipeline.adwords_impression_share [RUN]
2018-04-18 09:36:31,533: Compiling model.agency_data_pipeline.adwords_impression_share
2018-04-18 09:36:31,542: Writing injected SQL for node "model.agency_data_pipeline.agg_transaction_order_number"
2018-04-18 09:36:31,526: 09:36:31 | 35 of 91 START table model agency_data_pipeline.agg_transaction_line_item [RUN]
2018-04-18 09:36:31,547: Writing injected SQL for node "model.agency_data_pipeline.adwords_impression_share"
2018-04-18 09:36:31,526: 09:36:31 | 36 of 91 START table model agency_data_pipeline.adwords_stats........ [RUN]
2018-04-18 09:36:31,547: Compiling model.agency_data_pipeline.agg_transaction_line_item
2018-04-18 09:36:31,548: Compiling model.agency_data_pipeline.adwords_stats
2018-04-18 09:36:31,558: Writing injected SQL for node "model.agency_data_pipeline.agg_transaction_line_item"
2018-04-18 09:36:31,564: Acquiring new bigquery connection "adwords_impression_share".
2018-04-18 09:36:31,573: Re-using an available connection from the pool.
2018-04-18 09:36:31,565: Acquiring new bigquery connection "agg_transaction_order_number".
2018-04-18 09:36:31,573: Writing injected SQL for node "model.agency_data_pipeline.adwords_stats"
2018-04-18 09:36:31,576: Acquiring new bigquery connection "agg_transaction_line_item".
2018-04-18 09:36:31,578: Re-using an available connection from the pool.
2018-04-18 09:36:31,579: Re-using an available connection from the pool.
2018-04-18 09:36:31,587: Acquiring new bigquery connection "adwords_stats".
2018-04-18 09:36:31,589: Re-using an available connection from the pool.
2018-04-18 09:36:32,412: Model SQL (adwords_stats):
SELECT 
cast(day as date) date, 
account, 
platform,
channel,
url,
utm_campaign,
campaign,
sum(cost) cost,
sum(impressions) impressions,
sum(clicks) clicks,
sum(transactions) transactions
FROM 
  `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_join`
group by date, account, platform, channel, url, campaign, utm_campaign
2018-04-18 09:36:32,447: Model SQL (agg_transaction_order_number):
SELECT
client,
cast(created_at as date) date,
order_number,
customer_id,
sum(final_quantity) final_quantity,
sum(final_price) final_price,
max(total_order_shipping_price) shipping_price
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`agg_orders_union`
GROUP BY client, created_at, order_number, customer_id
2018-04-18 09:36:32,448: Model SQL (adwords_impression_share):
SELECT 
cast(day as date) date, 
account, 
channel,
platform,
sum(impression_share_num) impressions,
sum(impression_share_den) available_impressions
FROM 
  `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_join`
group by date, account, platform, channel
2018-04-18 09:36:32,559: Model SQL (agg_transaction_line_item):
SELECT
client,
created_at,
order_number,
quantity,
refund_quantity,
final_quantity,
price, 
total_order_price_undiscounted,
total_discounts,
total_order_shipping_price,
total_order_price_incl_shipping,
refund_amount,
final_price,
checkout_id,
product_id, 
landing_site,
sku, 
variant_title, 
variant_id,
line_item_id,	
customer_id,
orders_count,
customer_created_at,
last_order_id,
financial_status
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`agg_orders_union`
2018-04-18 09:36:34,897: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11164bcf8>]}
2018-04-18 09:36:37,978: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111658e48>]}
2018-04-18 09:36:38,126: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1139f8908>]}
2018-04-18 09:36:38,327: 09:36:38 | 34 of 91 OK created table model agency_data_pipeline.adwords_impression_share [CREATE TABLE in 3.36s]
2018-04-18 09:36:38,329: 09:36:38 | 37 of 91 START table model agency_data_pipeline.fb_ads_stats......... [RUN]
2018-04-18 09:36:38,332: Compiling model.agency_data_pipeline.fb_ads_stats
2018-04-18 09:36:38,344: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_stats"
2018-04-18 09:36:38,347: Acquiring new bigquery connection "fb_ads_stats".
2018-04-18 09:36:38,347: Re-using an available connection from the pool.
2018-04-18 09:36:39,138: 09:36:39 | 33 of 91 OK created table model agency_data_pipeline.agg_transaction_order_number [CREATE TABLE in 6.45s]
2018-04-18 09:36:39,260: Model SQL (fb_ads_stats):
with cost as (

    select 
        date, account, ad_id, campaign,
        cost, impressions, clicks, null as conversions
    from `growth-engines-pipeline`.`agency_data_pipeline`.`fb_ads_insights`
),

conversions as (

    select 
        date, account, ad_id, campaign,
        null as cost, null as impressions, null as clicks, conversions
    from `growth-engines-pipeline`.`agency_data_pipeline`.`fb_ads_insights_conversions`
),

urls as (

    select ad_id, url
    from `growth-engines-pipeline`.`agency_data_pipeline`.`fb_ads`
)


SELECT
    cast(date as date) date,
    'FB Ads' platform,
    'Paid' channel,
    account, 
    b.url url,
    campaign,
    lower(campaign) utm_campaign, 
    sum(cost) cost,
    sum(impressions) impressions,
    sum(clicks) clicks,
    sum(conversions) transactions
FROM
(
    SELECT *
    FROM 
      cost
    UNION ALL
    SELECT *
    FROM 
      conversions
) a
LEFT JOIN urls b
ON ( a.ad_id = b.ad_id )
group by date, platform, channel, account, url, campaign, utm_campaign
2018-04-18 09:36:39,437: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113a239e8>]}
2018-04-18 09:36:39,485: 09:36:39 | 36 of 91 OK created table model agency_data_pipeline.adwords_stats... [CREATE TABLE in 6.58s]
2018-04-18 09:36:39,792: 09:36:39 | 35 of 91 OK created table model agency_data_pipeline.agg_transaction_line_item [CREATE TABLE in 7.89s]
2018-04-18 09:36:41,525: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11164bcf8>]}
2018-04-18 09:36:41,877: 09:36:41 | 37 of 91 OK created table model agency_data_pipeline.fb_ads_stats.... [CREATE TABLE in 3.19s]
2018-04-18 09:36:41,878: 09:36:41 | 38 of 91 START table model agency_data_pipeline.customers_by_transaction [RUN]
2018-04-18 09:36:41,878: Compiling model.agency_data_pipeline.customers_by_transaction
2018-04-18 09:36:41,886: Writing injected SQL for node "model.agency_data_pipeline.customers_by_transaction"
2018-04-18 09:36:41,887: Acquiring new bigquery connection "customers_by_transaction".
2018-04-18 09:36:41,887: Re-using an available connection from the pool.
2018-04-18 09:36:42,886: Model SQL (customers_by_transaction):
SELECT
client,
customer_id,
order_number,
order_date,
first_order_date,
case when first_order_number = order_number then 'New' else 'Existing' end as order_type,
final_price,
first_order_revenue,
lifetime_revenue
FROM

(

	SELECT
	client,
	customer_id,
	order_number,
	date order_date,
	first_value(date) over w1 first_order_date,
	first_value(order_number) over w1 first_order_number,
	first_value(final_price) over w1 first_order_revenue,
    final_price,
	sum(final_price) over w2 lifetime_revenue
	FROM
    `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_order_number`
	WINDOW w1 as (PARTITION BY client, customer_id ORDER BY date desc),
	w2 as (PARTITION BY client, customer_id)
)
2018-04-18 09:36:46,176: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1139e1400>]}
2018-04-18 09:36:48,623: 09:36:48 | 38 of 91 OK created table model agency_data_pipeline.customers_by_transaction [CREATE TABLE in 4.30s]
2018-04-18 09:36:48,624: 09:36:48 | 39 of 91 START table model agency_data_pipeline.agg_ga_transaction_order_number [RUN]
2018-04-18 09:36:48,625: Compiling model.agency_data_pipeline.agg_ga_transaction_order_number
2018-04-18 09:36:48,624: 09:36:48 | 40 of 91 START table model agency_data_pipeline.frequency_proc....... [RUN]
2018-04-18 09:36:48,632: Compiling model.agency_data_pipeline.frequency_proc
2018-04-18 09:36:48,636: Writing injected SQL for node "model.agency_data_pipeline.frequency_proc"
2018-04-18 09:36:48,638: Writing injected SQL for node "model.agency_data_pipeline.agg_ga_transaction_order_number"
2018-04-18 09:36:48,641: Acquiring new bigquery connection "agg_ga_transaction_order_number".
2018-04-18 09:36:48,641: Re-using an available connection from the pool.
2018-04-18 09:36:48,644: Acquiring new bigquery connection "frequency_proc".
2018-04-18 09:36:48,644: Re-using an available connection from the pool.
2018-04-18 09:36:49,541: Model SQL (frequency_proc):
WITH transactions AS (

  	SELECT 
	client,
	customer_id,
	order_number,
	date,
	unix_date(date) d
	FROM
	`growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_order_number`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)

SELECT 
client,
'Rolling 365' as period,
date_in_range date,
unix_date_in_range, 
customer_id,
count(distinct(order_number)) frequency
FROM daterange
JOIN transactions
ON transactions.d > ( daterange.unix_date_in_range - 365 )
AND transactions.d <= daterange.unix_date_in_range
group by client, unix_date_in_range, customer_id, date
2018-04-18 09:36:49,553: Model SQL (agg_ga_transaction_order_number):
with ga as (

    select 
        date, account, client, 
        channel as last_touch_channel, 
        platform as last_touch_platform, 
        url as last_touch_url, 
        campaign as last_touch_utm_campaign, 
        '' as first_touch_channel, 
        '' as first_touch_platform, 
        '' as first_touch_utm_campaign, 
        transactionid,
        last_touch_transactions, last_touch_revenue,
        last_touch_shipping, last_touch_tax,
        null as first_touch_transactions, null as first_touch_revenue
    from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_transactions`

),

ga_mcf as (

    select 
        date, account, client, 
        '' as last_touch_channel,
        '' as last_touch_platform,
        '' as last_touch_url,
        '' as last_touch_utm_campaign, 
        channel as first_touch_channel, 
        platform as first_touch_platform, 
        campaign as first_touch_utm_campaign, 
        transactionid, 
        null as last_touch_transactions, null as last_touch_revenue,
        null as last_touch_shipping, null as last_touch_tax,
        first_touch_transactions, first_touch_revenue
    from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_mcf_stats`

)


SELECT
    date, 
    client,
    transactionid,
    max(last_touch_channel) last_touch_channel, 
    max(last_touch_platform) last_touch_platform, 
    max(last_touch_url) last_touch_url, 
    max(last_touch_utm_campaign) last_touch_utm_campaign, 
    max(first_touch_channel) first_touch_channel, 
    max(first_touch_platform) first_touch_platform, 
    max(first_touch_utm_campaign) first_touch_utm_campaign,
    sum(last_touch_transactions) last_touch_transactions,
    sum(last_touch_revenue) last_touch_revenue,
    sum(last_touch_shipping) last_touch_shipping_revenue,
    sum(last_touch_tax) last_touch_tax_revenue,
    sum(first_touch_transactions) first_touch_transactions,
    sum(first_touch_revenue) - ifnull(sum(last_touch_shipping),0) - ifnull(sum(last_touch_tax),0) first_touch_revenue
FROM
(
    SELECT *
    FROM 
      ga
    UNION ALL
    SELECT *
    FROM 
      ga_mcf
) 
GROUP BY
    date, client, transactionid
2018-04-18 09:36:54,285: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11164bcf8>]}
2018-04-18 09:36:57,999: 09:36:57 | 39 of 91 OK created table model agency_data_pipeline.agg_ga_transaction_order_number [CREATE TABLE in 5.66s]
2018-04-18 09:37:04,187: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1139f85f8>]}
2018-04-18 09:37:06,972: 09:37:06 | 40 of 91 OK created table model agency_data_pipeline.frequency_proc.. [CREATE TABLE in 15.56s]
2018-04-18 09:37:06,974: 09:37:06 | 41 of 91 START table model agency_data_pipeline.agg_transaction_line_item_type [RUN]
2018-04-18 09:37:06,975: 09:37:06 | 42 of 91 START table model agency_data_pipeline.frequency_stats...... [RUN]
2018-04-18 09:37:06,975: Compiling model.agency_data_pipeline.agg_transaction_line_item_type
2018-04-18 09:37:06,975: 09:37:06 | 43 of 91 START table model agency_data_pipeline.agg_ga_campaign...... [RUN]
2018-04-18 09:37:06,976: Compiling model.agency_data_pipeline.frequency_stats
2018-04-18 09:37:06,981: Compiling model.agency_data_pipeline.agg_ga_campaign
2018-04-18 09:37:06,984: Writing injected SQL for node "model.agency_data_pipeline.agg_transaction_line_item_type"
2018-04-18 09:37:06,990: Writing injected SQL for node "model.agency_data_pipeline.frequency_stats"
2018-04-18 09:37:06,998: Writing injected SQL for node "model.agency_data_pipeline.agg_ga_campaign"
2018-04-18 09:37:07,001: Acquiring new bigquery connection "agg_transaction_line_item_type".
2018-04-18 09:37:07,002: Re-using an available connection from the pool.
2018-04-18 09:37:07,004: Acquiring new bigquery connection "frequency_stats".
2018-04-18 09:37:07,005: Acquiring new bigquery connection "agg_ga_campaign".
2018-04-18 09:37:07,005: Re-using an available connection from the pool.
2018-04-18 09:37:07,009: Re-using an available connection from the pool.
2018-04-18 09:37:07,948: Model SQL (frequency_stats):
SELECT
client,
period,
date,
unix_date_in_range,
case when frequency = 1 then '1' 
	when frequency = 2 then '2'
	when frequency > 2 then '2+'
	else null end as frequency_segment,
sum(customers) customers 
FROM (

	SELECT 
	client,
	period,
	date,
	unix_date_in_range, 
	frequency,
	count(distinct(customer_id)) customers
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`frequency_proc`
	group by client, period, date, unix_date_in_range, frequency
)
group by client, period, date, unix_date_in_range, frequency_segment
2018-04-18 09:37:08,033: Model SQL (agg_transaction_line_item_type):
SELECT
client,
product_id,
product_type,
customer_id,
sku,
order_number,
created_at,
final_quantity,
final_price
FROM

( 
	SELECT 
	a.client, 
	a.product_id,
	product_type,
	customer_id,
	a.sku, 
	order_number,
	created_at,
	final_quantity,
	final_price
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_line_item` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`agg_products` b
	ON (
		a.product_id = b.product_id
	  and a.client = b.client
		)

)
2018-04-18 09:37:08,091: Model SQL (agg_ga_campaign):
with ga_transactions as (

	select 
		date, account, client, channel, platform, url, 
		campaign,
		null as sessions, null as goal_completions, last_touch_transactions, last_touch_revenue,
		last_touch_shipping, last_touch_tax,
		null as first_touch_transactions, null as first_touch_revenue
	from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_transactions`

),

ga_traffic as (

    select 
        date, account, client, channel, platform, url, 
        campaign,
        sessions, goal_completions, null as last_touch_transactions, null as last_touch_revenue,
        null as last_touch_shipping, null as last_touch_tax,
        null as first_touch_transactions, null as first_touch_revenue
    from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_traffic`

),

ga_mcf as (

	select 
		date, account, client, channel, platform, '' as url,
		campaign, 
		null as sessions, null as goal_completions, null as last_touch_transactions, null as last_touch_revenue,
		null as last_touch_shipping, null as last_touch_tax,
		first_touch_transactions, first_touch_revenue
	from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_mcf_stats`

)


SELECT
    date, 
    client,
    platform,
    channel, 
    url,
    campaign utm_campaign,
	sum(sessions) sessions,
	sum(goal_completions) goal_completions,
	sum(last_touch_transactions) last_touch_transactions,
	sum(last_touch_revenue) last_touch_revenue,
    sum(last_touch_shipping) last_touch_shipping_revenue,
    sum(last_touch_tax) last_touch_tax_revenue,
    sum(first_touch_transactions) first_touch_transactions,
    sum(first_touch_revenue) - sum(ifnull(last_touch_shipping,0)) - sum(ifnull(last_touch_tax,0)) first_touch_revenue

FROM
(
    SELECT *
    FROM 
      ga_transactions
    UNION ALL
    SELECT *
    FROM 
      ga_traffic
    UNION ALL
    SELECT *
    FROM 
      ga_mcf
) 
GROUP BY
    date, client, platform, channel, url, utm_campaign
2018-04-18 09:37:12,409: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1139f8eb8>]}
2018-04-18 09:37:12,481: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1139e1400>]}
2018-04-18 09:37:12,647: 09:37:12 | 42 of 91 OK created table model agency_data_pipeline.frequency_stats. [CREATE TABLE in 5.43s]
2018-04-18 09:37:12,911: 09:37:12 | 41 of 91 OK created table model agency_data_pipeline.agg_transaction_line_item_type [CREATE TABLE in 5.51s]
2018-04-18 09:37:17,040: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1116712e8>]}
2018-04-18 09:37:19,097: 09:37:19 | 43 of 91 OK created table model agency_data_pipeline.agg_ga_campaign. [CREATE TABLE in 10.06s]
2018-04-18 09:37:19,098: 09:37:19 | 44 of 91 START table model agency_data_pipeline.agg_transaction_product_type [RUN]
2018-04-18 09:37:19,099: 09:37:19 | 45 of 91 START table model agency_data_pipeline.customers_first_purchase_product_type_proc [RUN]
2018-04-18 09:37:19,099: Compiling model.agency_data_pipeline.agg_transaction_product_type
2018-04-18 09:37:19,099: Compiling model.agency_data_pipeline.customers_first_purchase_product_type_proc
2018-04-18 09:37:19,107: Writing injected SQL for node "model.agency_data_pipeline.agg_transaction_product_type"
2018-04-18 09:37:19,112: Writing injected SQL for node "model.agency_data_pipeline.customers_first_purchase_product_type_proc"
2018-04-18 09:37:19,115: Acquiring new bigquery connection "agg_transaction_product_type".
2018-04-18 09:37:19,116: Acquiring new bigquery connection "customers_first_purchase_product_type_proc".
2018-04-18 09:37:19,116: Re-using an available connection from the pool.
2018-04-18 09:37:19,116: Re-using an available connection from the pool.
2018-04-18 09:37:20,388: Model SQL (agg_transaction_product_type):
SELECT
client,
product_type,
customer_id,
order_number,
created_at,
first_value(product_type) over (PARTITION BY client, customer_id, order_number, created_at ORDER BY final_price desc) as top_order_product_type,
final_quantity,
final_price,
sum(final_quantity) over (PARTITION BY client, customer_id, order_number) as total_order_quantity,
sum(final_price) over (PARTITION BY client, customer_id, order_number) as total_order_value
FROM
	(
		SELECT
		client,
		product_type,
		customer_id,
		order_number,
		created_at,
		sum(final_quantity) final_quantity,
		sum(final_price) final_price
		FROM
		`growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_line_item_type`
		GROUP BY
		client,
		product_type,
		customer_id,
		order_number,
		created_at
	)
2018-04-18 09:37:20,388: Model SQL (customers_first_purchase_product_type_proc):
SELECT 
client, 
customer_id, 
product_type,
min(cast(created_at as date)) first_order_date,
unix_date( min(cast(created_at as date))) first_order_unix_date
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_line_item_type`
GROUP BY client, customer_id, product_type
2018-04-18 09:37:23,339: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e314198>]}
2018-04-18 09:37:24,239: 09:37:24 | 45 of 91 OK created table model agency_data_pipeline.customers_first_purchase_product_type_proc [CREATE TABLE in 4.24s]
2018-04-18 09:37:25,100: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e373a90>]}
2018-04-18 09:37:28,141: 09:37:28 | 44 of 91 OK created table model agency_data_pipeline.agg_transaction_product_type [CREATE TABLE in 6.00s]
2018-04-18 09:37:28,146: 09:37:28 | 46 of 91 START table model agency_data_pipeline.products_proc........ [RUN]
2018-04-18 09:37:28,147: Compiling model.agency_data_pipeline.products_proc
2018-04-18 09:37:28,156: 09:37:28 | 47 of 91 START table model agency_data_pipeline.customers_products_proc [RUN]
2018-04-18 09:37:28,157: Compiling model.agency_data_pipeline.customers_products_proc
2018-04-18 09:37:28,168: 09:37:28 | 48 of 91 START table model agency_data_pipeline.order_paths_proc..... [RUN]
2018-04-18 09:37:28,168: Compiling model.agency_data_pipeline.order_paths_proc
2018-04-18 09:37:28,179: Writing injected SQL for node "model.agency_data_pipeline.order_paths_proc"
2018-04-18 09:37:28,181: Acquiring new bigquery connection "order_paths_proc".
2018-04-18 09:37:28,181: Re-using an available connection from the pool.
2018-04-18 09:37:28,185: Writing injected SQL for node "model.agency_data_pipeline.customers_products_proc"
2018-04-18 09:37:28,187: Acquiring new bigquery connection "customers_products_proc".
2018-04-18 09:37:28,187: Re-using an available connection from the pool.
2018-04-18 09:37:28,199: Writing injected SQL for node "model.agency_data_pipeline.products_proc"
2018-04-18 09:37:28,201: Acquiring new bigquery connection "products_proc".
2018-04-18 09:37:28,201: Re-using an available connection from the pool.
2018-04-18 09:37:29,044: Model SQL (order_paths_proc):
SELECT
client, 
customer_id, 
first_value(product_type) OVER w1 as first_product_type,
nth_value(product_type, 2) OVER w1 as second_product_type,
cast(first_value(created_at) OVER w1 as date) as first_purchase_date,
cast(nth_value(created_at, 2) OVER w1 as date) as second_purchase_date,
cast(nth_value(created_at, 3) OVER w1 as date) as third_purchase_date,
cast(nth_value(created_at, 4) OVER w1 as date) as fourth_purchase_date,
cast(nth_value(created_at, 5) OVER w1 as date) as fifth_purchase_date,
first_value(order_number) OVER w1 as first_order_number,
nth_value(order_number, 2) OVER w1 as second_order_number,
nth_value(order_number, 3) OVER w1 as third_order_number,
nth_value(order_number, 4) OVER w1 as fourth_order_number,
nth_value(order_number, 5) OVER w1 as fifth_order_number,
first_value(total_order_value) OVER w1 as first_order_value,
nth_value(total_order_value, 2) OVER w1 as second_order_value
FROM (
	  
	  SELECT 
	  client, 
	  product_type,
	  customer_id,
	  order_number,
	  created_at, 
	  total_order_value
	  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_product_type`
	  WHERE product_type = top_order_product_type

)
WINDOW w1 as (PARTITION BY client, customer_id ORDER BY created_at asc)
2018-04-18 09:37:29,092: Model SQL (products_proc):
WITH transactions AS (
  SELECT 
  client, 
  product_id,
  product_type,
  customer_id,
  sku, 
  order_number,
  unix_date(cast(created_at as date)) d, 
  final_quantity,
  final_price,
  first_value(unix_date(cast(created_at as date))) over (partition by client, product_id, sku order by created_at desc) first_purchase_unix_date
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_line_item_type`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)

SELECT 
client,
'Last 30' as period,
sku,
product_type,
date_in_range date,
unix_date_in_range, 
case when 
  ( first_purchase_unix_date > ( daterange.unix_date_in_range - 365 ) and first_purchase_unix_date <= daterange.unix_date_in_range )
  then 'New' else 'Existing' end as newness,  
count(distinct(customer_id)) unique_customers,
count(distinct(order_number)) orders,
sum(final_quantity) quantity,
sum(final_price) revenue,
count(distinct(d)) days_sold
FROM daterange
JOIN transactions
ON transactions.d > ( daterange.unix_date_in_range - 30 )
AND transactions.d <= daterange.unix_date_in_range
group by date_in_range, unix_date_in_range, client, sku, product_type, newness

UNION ALL

SELECT 
client,
'Last 90' as period,
sku, 
product_type,
date_in_range date,
unix_date_in_range, 
case when 
  ( first_purchase_unix_date > ( daterange.unix_date_in_range - 365 ) and first_purchase_unix_date <= daterange.unix_date_in_range )
  then 'New' else 'Existing' end as newness,  
count(distinct(customer_id)) unique_customers,
count(distinct(order_number)) orders,
sum(final_quantity) quantity,
sum(final_price) revenue,
count(distinct(d)) days_sold
FROM daterange
JOIN transactions
ON transactions.d > ( daterange.unix_date_in_range - 90 )
AND transactions.d <= daterange.unix_date_in_range
group by date_in_range, unix_date_in_range, client, sku, product_type, newness

UNION ALL

SELECT 
client,
'YoY 30' as date_range,
sku, 
product_type,
date_in_range date,
unix_date_in_range,
case when 
  ( first_purchase_unix_date > ( daterange.unix_date_in_range - 730 ) and first_purchase_unix_date <= ( daterange.unix_date_in_range - 365 ))
  then 'New' else 'Existing' end as newness,   
count(distinct(customer_id)) unique_customers,
count(distinct(order_number)) orders,
sum(final_quantity) quantity,
sum(final_price) revenue,
count(distinct(d)) days_sold
FROM daterange
JOIN transactions
ON transactions.d > ( daterange.unix_date_in_range - 395 )
AND transactions.d <= ( daterange.unix_date_in_range - 365 )
group by date_in_range, unix_date_in_range, client, sku, product_type, newness
2018-04-18 09:37:29,142: Model SQL (customers_products_proc):
WITH customers AS (
  SELECT 
  client, 
  product_id,
  product_type,
  customer_id,
  sku, 
  order_number,
  cast(created_at as date) order_date,
  unix_date(cast(created_at as date)) unix_order_date, 
  final_quantity quantity,
  final_price revenue
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_line_item_type`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)

SELECT 
client,
period,
customer_id,
product_type,
date,
window_end_unix_date,
window_end_unix_date - 365 as window_start_unix_date,
window_end_unix_date - unix_date(recent_order) recency_days,
frequency,
quantity,
revenue,
case when frequency > 0 then revenue/frequency else 0 end as aov
FROM 
(  

  SELECT 
  client,
  'Rolling 365' as period,
  customer_id,
  product_type,
  date_in_range date,
  unix_date_in_range,
  unix_date_in_range window_end_unix_date, 
  max(order_date) recent_order,
  sum(quantity) as quantity,
  sum(revenue) as revenue,
  count(distinct(order_number)) as frequency
  FROM daterange
  JOIN customers
  ON customers.unix_order_date > ( daterange.unix_date_in_range - 365 )
  AND customers.unix_order_date <= daterange.unix_date_in_range
  GROUP BY client, customer_id, date, unix_date_in_range, product_type

  UNION ALL

  SELECT 
  client,
  'Rolling 365 (t-1mo)' as period,
  customer_id,
  product_type,
  date_in_range date,
  unix_date_in_range, 
  unix_date_in_range - 30 window_end_unix_date, 
  max(order_date) recent_order,
  sum(quantity) as quantity,
  sum(revenue) as revenue,
  count(distinct(order_number)) as frequency
  FROM daterange
  JOIN customers
  ON customers.unix_order_date > ( daterange.unix_date_in_range - 395 )
  AND customers.unix_order_date <= ( daterange.unix_date_in_range - 30 )
  GROUP BY client, customer_id, date, unix_date_in_range, product_type

  UNION ALL

  SELECT 
  client,
  'Rolling 365 (t-1yr)' as period,
  customer_id,
  product_type,
  date_in_range date,
  unix_date_in_range, 
  unix_date_in_range - 365 window_end_unix_date, 
  max(order_date) recent_order,
  sum(quantity) as quantity,
  sum(revenue) as revenue,
  count(distinct(order_number)) as frequency
  FROM daterange
  JOIN customers
  ON customers.unix_order_date > ( daterange.unix_date_in_range - 730 )
  AND customers.unix_order_date <= ( daterange.unix_date_in_range - 365 )
  GROUP BY client, customer_id, date, unix_date_in_range, product_type

)
2018-04-18 09:37:32,457: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113a238d0>]}
2018-04-18 09:37:32,779: 09:37:32 | 48 of 91 OK created table model agency_data_pipeline.order_paths_proc [CREATE TABLE in 4.29s]
2018-04-18 09:37:37,022: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1116712e8>]}
2018-04-18 09:37:39,513: 09:37:39 | 46 of 91 OK created table model agency_data_pipeline.products_proc... [CREATE TABLE in 8.87s]
2018-04-18 09:38:07,891: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1139cf550>]}
2018-04-18 09:38:11,262: 09:38:11 | 47 of 91 OK created table model agency_data_pipeline.customers_products_proc [CREATE TABLE in 39.73s]
2018-04-18 09:38:11,265: 09:38:11 | 49 of 91 START table model agency_data_pipeline.order_paths_agg...... [RUN]
2018-04-18 09:38:11,266: Compiling model.agency_data_pipeline.order_paths_agg
2018-04-18 09:38:11,265: 09:38:11 | 50 of 91 START table model agency_data_pipeline.segment_proc_sku..... [RUN]
2018-04-18 09:38:11,278: Compiling model.agency_data_pipeline.segment_proc_sku
2018-04-18 09:38:11,288: Writing injected SQL for node "model.agency_data_pipeline.order_paths_agg"
2018-04-18 09:38:11,288: Writing injected SQL for node "model.agency_data_pipeline.segment_proc_sku"
2018-04-18 09:38:11,292: Acquiring new bigquery connection "segment_proc_sku".
2018-04-18 09:38:11,293: Re-using an available connection from the pool.
2018-04-18 09:38:11,296: Acquiring new bigquery connection "order_paths_agg".
2018-04-18 09:38:11,296: Re-using an available connection from the pool.
2018-04-18 09:38:12,080: Model SQL (order_paths_agg):
SELECT
client, 
first_product_type,
second_product_type,
first_purchase_date,
count(distinct(customer_id)) customer_count, 
count(distinct(second_order_number)) second_orders, 
count(distinct(third_order_number)) third_orders, 
count(distinct(fourth_order_number)) fourth_orders, 
count(distinct(fifth_order_number)) fifth_orders, 
sum(date_diff(second_purchase_date, first_purchase_date, DAY)) second_order_latency_days,
sum(date_diff(third_purchase_date, second_purchase_date, DAY)) third_order_latency_days,
sum(date_diff(fourth_purchase_date, third_purchase_date, DAY)) fourth_order_latency_days,
sum(date_diff(fifth_purchase_date, fourth_purchase_date, DAY)) fifth_order_latency_days,
sum(first_order_value) first_order_revenue,
sum(second_order_value) second_order_revenue
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`order_paths_proc`
where second_product_type is not null
GROUP BY client, first_product_type, second_product_type, first_purchase_date
2018-04-18 09:38:12,134: Model SQL (segment_proc_sku):
SELECT
client,
period,
sku, 
product_type,
date,
unique_customers,
orders,
quantity,
revenue,
case 
	when avg_daily_revenue >= avg_daily_revenue_90pct and avg_daily_quantity >= avg_daily_quantity_80pct then 'Best Seller'
	when avg_daily_revenue >= avg_daily_revenue_70pct and avg_daily_quantity >= avg_daily_quantity_40pct then 'Good'
	when avg_daily_revenue < avg_daily_revenue_70pct and avg_daily_revenue >= avg_daily_revenue_30pct and avg_daily_quantity < avg_daily_quantity_70pct then 'Average'
	when avg_daily_revenue < avg_daily_revenue_30pct and avg_daily_quantity < avg_daily_quantity_30pct then 'Poor'
	else 'Unbucketed' end as segment,
newness,	
avg_daily_revenue_90pct,
avg_daily_revenue_70pct,
avg_daily_revenue_30pct,
avg_daily_quantity_80pct,
avg_daily_quantity_70pct,
avg_daily_quantity_40pct,
avg_daily_quantity_30pct

FROM (

	SELECT
	client,
	period,
	sku, 
	product_type,
	newness,
	date,
	unique_customers,
	orders,
	quantity,
	revenue,
	days_sold,
	avg_daily_revenue,
	avg_daily_quantity,
	PERCENTILE_CONT(avg_daily_revenue, 0.90) OVER w1 AS avg_daily_revenue_90pct,
	PERCENTILE_CONT(avg_daily_revenue, 0.70) OVER w1 AS avg_daily_revenue_70pct,
	PERCENTILE_CONT(avg_daily_revenue, 0.3) OVER w1 AS avg_daily_revenue_30pct,
	PERCENTILE_CONT(avg_daily_quantity, 0.80) OVER w1 AS avg_daily_quantity_80pct,
	PERCENTILE_CONT(avg_daily_quantity, 0.70) OVER w1 AS avg_daily_quantity_70pct,
	PERCENTILE_CONT(avg_daily_quantity, 0.40) OVER w1 AS avg_daily_quantity_40pct,
	PERCENTILE_CONT(avg_daily_quantity, 0.3) OVER w1 AS avg_daily_quantity_30pct

	FROM
	(
		SELECT 
		client,
		period,
		sku, 
		product_type,
		newness,
		date,
		unique_customers,
		orders,
		quantity,
		revenue,
		days_sold,
		case when days_sold > 0 then revenue/days_sold else null end as avg_daily_revenue,
		case when days_sold > 0 then quantity/days_sold else null end as avg_daily_quantity
		FROM `growth-engines-pipeline`.`agency_data_pipeline`.`products_proc`
	)
	WINDOW w1 as (PARTITION BY client, period, date)
)
2018-04-18 09:38:14,307: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113a64cc0>]}
2018-04-18 09:38:14,359: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e373a90>]}
2018-04-18 09:38:14,552: 09:38:14 | 50 of 91 OK created table model agency_data_pipeline.segment_proc_sku [CREATE TABLE in 3.03s]
2018-04-18 09:38:14,798: 09:38:14 | 49 of 91 OK created table model agency_data_pipeline.order_paths_agg. [CREATE TABLE in 3.09s]
2018-04-18 09:38:14,799: 09:38:14 | 51 of 91 START table model agency_data_pipeline.agg_transaction...... [RUN]
2018-04-18 09:38:14,800: Compiling model.agency_data_pipeline.agg_transaction
2018-04-18 09:38:14,799: 09:38:14 | 52 of 91 START table model agency_data_pipeline.agg_ga_transaction... [RUN]
2018-04-18 09:38:14,806: Compiling model.agency_data_pipeline.agg_ga_transaction
2018-04-18 09:38:14,799: 09:38:14 | 53 of 91 START table model agency_data_pipeline.segment_proc_customers_products [RUN]
2018-04-18 09:38:14,814: Compiling model.agency_data_pipeline.segment_proc_customers_products
2018-04-18 09:38:14,799: 09:38:14 | 54 of 91 START table model agency_data_pipeline.segment_stats_sku.... [RUN]
2018-04-18 09:38:14,816: Writing injected SQL for node "model.agency_data_pipeline.agg_transaction"
2018-04-18 09:38:14,817: Writing injected SQL for node "model.agency_data_pipeline.agg_ga_transaction"
2018-04-18 09:38:14,817: Compiling model.agency_data_pipeline.segment_stats_sku
2018-04-18 09:38:14,822: Writing injected SQL for node "model.agency_data_pipeline.segment_proc_customers_products"
2018-04-18 09:38:14,858: Acquiring new bigquery connection "agg_ga_transaction".
2018-04-18 09:38:14,866: Re-using an available connection from the pool.
2018-04-18 09:38:14,859: Acquiring new bigquery connection "segment_proc_customers_products".
2018-04-18 09:38:14,867: Re-using an available connection from the pool.
2018-04-18 09:38:14,900: Acquiring new bigquery connection "agg_transaction".
2018-04-18 09:38:14,900: Re-using an available connection from the pool.
2018-04-18 09:38:14,906: Writing injected SQL for node "model.agency_data_pipeline.segment_stats_sku"
2018-04-18 09:38:14,909: Acquiring new bigquery connection "segment_stats_sku".
2018-04-18 09:38:14,909: Re-using an available connection from the pool.
2018-04-18 09:38:17,724: Model SQL (agg_ga_transaction):
#done - lookup customer id from transaction id from orders
#done - tag an order as 'new' or 'existing' based on transaction id
#sum lifetime value of that customer id
#first order value for customer
#read from agg_ga_transaction into agg_ga_campaign instead of directly from ga_transactions and ga_mcf_stats


with ga as (

    select 
        date, 
        client, 
        'Last-touch' as attribution,
        channel, 
        platform, 
        url, 
        campaign, 
        transactionid,
        last_touch_transactions transactions, 
        last_touch_revenue + ifnull(last_touch_shipping, 0) + ifnull(last_touch_tax, 0) as revenue
    from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_transactions`

),

ga_mcf as (

    select 
        date, 
        client, 
        'First-touch' as attribution,
        channel, 
        platform, 
        '' as url,
        campaign, 
        transactionid, 
        first_touch_transactions as transactions,
        first_touch_revenue as revenue
    from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_mcf_stats`

)


SELECT
    date, 
    a.client client,
    attribution,
    transactionid,
    b.customer_id customer_id,
    b.order_type order_type,
    b.first_order_revenue first_order_revenue,
    b.lifetime_revenue lifetime_revenue,
    channel,
    platform,
    url,
    campaign,
    transactions,
    revenue
FROM (
    SELECT * FROM ga
    UNION ALL
    SELECT * FROM ga_mcf
) a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`customers_by_transaction` b
ON (
    a.client = b.client AND
    a.transactionid = b.order_number
)
2018-04-18 09:38:17,728: Model SQL (segment_proc_customers_products):
SELECT
client,
period,
date,
customer_id,
first_order_date,
first_order_unix_date,
product_type,
recency_days,
frequency,
revenue,
quantity,
aov,
case when recency_days <= 30 and first_order_unix_date >= window_start_unix_date then 'New'
	when frequency = 1 and recency_days <= 90 and aov >= aov_40pct then 'Promising'
	when frequency = 1 then 'One-time Purchaser'
	when frequency >= frequency_90pct and recency_days <= 90 and aov > aov_40pct then 'Whale'
	when recency_days <= 240 and frequency > frequency_50pct then 'Loyal'
	when recency_days <= 90 and frequency > frequency_50pct then 'Potential Loyalists' 
	when recency_days > 240 and frequency > frequency_50pct then 'Defecting Good Customer'	
	when recency_days > recency_50pct and frequency > frequency_50pct then 'Frequent, not Recent'
	when recency_days < recency_50pct and frequency < frequency_50pct then 'Recent, not Frequent'
	else 'Unbucketed' end as segment,
aov_40pct,
frequency_90pct,
frequency_75pct,
frequency_50pct,
recency_50pct
FROM
(
	SELECT 
	a.client client,
	period,
	date,
	a.customer_id customer_id,
	a.product_type product_type,
	b.first_order_date first_order_date,
	b.first_order_unix_date first_order_unix_date,
	window_start_unix_date,
	window_end_unix_date,	
	recency_days,
	frequency,
	revenue,
	quantity,
	aov,
	PERCENTILE_CONT(aov, 0.40) OVER w1 AS aov_40pct,
	PERCENTILE_CONT(frequency, 0.90) OVER w1 AS frequency_90pct,
	PERCENTILE_CONT(frequency, 0.75) OVER w1 AS frequency_75pct,
	PERCENTILE_CONT(frequency, 0.50) OVER w1 AS frequency_50pct,
	PERCENTILE_CONT(recency_days, 0.5) OVER w1 AS recency_50pct
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`customers_products_proc` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`customers_first_purchase_product_type_proc` b
	ON (
		a.client = b.client and
		a.customer_id = b.customer_id and
		a.product_type = b.product_type
		)
	WINDOW w1 as (PARTITION BY a.client, period, date, a.product_type)
)
2018-04-18 09:38:17,787: Model SQL (segment_stats_sku):
WITH last_30 as (

	SELECT
	client,
	sku, 
	product_type,
	date,
	unique_customers as customers_30,
	orders as orders_30,
	revenue as revenue_30,
	segment as segment_30,
	newness as newness_30,
	0 as customers_90,
	0 as orders_90,
	0 as revenue_90,
	'' as segment_90,
	0 as customers_yoy_30,
	0 as orders_yoy_30,
	0 as revenue_yoy_30,
	'' as segment_yoy_30
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_sku`
	WHERE period = 'Last 30'

),

last_90 as (

	SELECT
	client,
	sku, 
	product_type,
	date,
	0 as customers_30,
	0 as orders_30,
	0 as revenue_30,
	'' as segment_30,
	'' as newness_30,
	unique_customers as customers_90,
	orders as orders_90,
	revenue as revenue_90,
	segment as segment_90,
	0 as customers_yoy_30,
	0 as orders_yoy_30,
	0 as revenue_yoy_30,
	'' as segment_yoy_30
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_sku`
	WHERE period = 'Last 90'

),

yoy_30 as (

	SELECT
	client,
	sku, 
	product_type,
	date,
	0 as customers_30,
	0 as orders_30,
	0 as revenue_30,
	'' as segment_30,
	'' as newness_30,
	0 as customers_90,
	0 as orders_90,
	0 as revenue_90,
	'' as segment_90,
	unique_customers as customers_yoy_30,
	orders as orders_yoy_30,
	revenue as revenue_yoy_30,
	segment as segment_yoy_30
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_sku`
	WHERE period = 'YoY 30'

)

SELECT
client,
sku, 
product_type,
date,
ifnull(sum(customers_30), 0) customers_30,
ifnull(sum(orders_30), 0) orders_30,
ifnull(sum(revenue_30), 0) revenue_30,
ifnull(max(segment_30), '') segment_30,
ifnull(sum(customers_90), 0) customers_90,
ifnull(sum(orders_90), 0) orders_90,
ifnull(sum(revenue_90), 0) revenue_90,
ifnull(max(segment_90),'') segment_90,
ifnull(sum(customers_yoy_30), 0) customers_yoy_30,
ifnull(sum(orders_yoy_30), 0) orders_yoy_30,
ifnull(sum(revenue_yoy_30), 0) revenue_yoy_30,
case when max(newness_30) = 'New' then 'New'
	else ifnull(max(segment_yoy_30), '') end as segment_yoy_30
FROM
(
	SELECT * FROM last_30
	UNION ALL
	SELECT * FROM last_90
	UNION ALL
	SELECT * FROM yoy_30

)
GROUP BY client, sku, product_type, date
2018-04-18 09:38:17,814: Model SQL (agg_transaction):
SELECT
client,
date,
customer_id,
order_number,
last_touch_channel,
last_touch_platform,
last_touch_url,
first_touch_channel, 
first_touch_platform, 
first_touch_utm_campaign,
ifnull( sum(last_touch_transactions), 0) last_touch_transactions, 
ifnull( sum(last_touch_revenue), 0) last_touch_revenue, 
ifnull( sum(first_touch_transactions), 0) first_touch_transactions, 
ifnull( sum(first_touch_revenue), 0) first_touch_revenue,
ifnull( sum(final_quantity), 0) quantity,
ifnull( sum(final_price), 0) revenue,
ifnull( sum(shipping_price), 0) shipping_revenue,
ROW_NUMBER() OVER (PARTITION BY client, customer_id, order_number ORDER BY date asc) AS order_sequence
FROM
(
	SELECT
	a.client,
	a.date date,
	b.date ga_date,
	a.customer_id,
	a.order_number,
	transactionid,
	b.last_touch_channel,
	b.last_touch_platform,
	b.last_touch_url,
	b.first_touch_channel, 
	b.first_touch_platform, 
	b.first_touch_utm_campaign, 
	last_touch_transactions, 
	last_touch_revenue, 
	first_touch_transactions, 
	first_touch_revenue,
	final_quantity,
	final_price,
	shipping_price
	FROM
	`growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_order_number` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`agg_ga_transaction_order_number` b
	ON (
		a.client = b.client and
		a.order_number = b.transactionid
	)

)
GROUP BY
client, 
date, 
customer_id,
order_number, 
last_touch_channel,
last_touch_platform,
last_touch_url,
first_touch_channel, 
first_touch_platform, 
first_touch_utm_campaign
2018-04-18 09:38:20,710: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113a645c0>]}
2018-04-18 09:38:23,241: 09:38:23 | 54 of 91 OK created table model agency_data_pipeline.segment_stats_sku [CREATE TABLE in 5.89s]
2018-04-18 09:38:23,680: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e2fce80>]}
2018-04-18 09:38:23,956: 09:38:23 | 51 of 91 OK created table model agency_data_pipeline.agg_transaction. [CREATE TABLE in 8.88s]
2018-04-18 09:38:25,166: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1139e9240>]}
2018-04-18 09:38:25,409: 09:38:25 | 52 of 91 OK created table model agency_data_pipeline.agg_ga_transaction [CREATE TABLE in 10.36s]
2018-04-18 09:38:52,243: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113a4dcf8>]}
2018-04-18 09:38:54,165: 09:38:54 | 53 of 91 OK created table model agency_data_pipeline.segment_proc_customers_products [CREATE TABLE in 37.43s]
2018-04-18 09:38:54,168: 09:38:54 | 55 of 91 START table model agency_data_pipeline.segment_stats_category [RUN]
2018-04-18 09:38:54,169: 09:38:54 | 56 of 91 START table model agency_data_pipeline.customers_first_purchase_proc [RUN]
2018-04-18 09:38:54,170: Compiling model.agency_data_pipeline.segment_stats_category
2018-04-18 09:38:54,169: 09:38:54 | 57 of 91 START table model agency_data_pipeline.agg_ga_campaign_by_type [RUN]
2018-04-18 09:38:54,169: 09:38:54 | 58 of 91 START table model agency_data_pipeline.segment_stats_customers_products_agg [RUN]
2018-04-18 09:38:54,170: Compiling model.agency_data_pipeline.customers_first_purchase_proc
2018-04-18 09:38:54,180: Writing injected SQL for node "model.agency_data_pipeline.segment_stats_category"
2018-04-18 09:38:54,180: Compiling model.agency_data_pipeline.agg_ga_campaign_by_type
2018-04-18 09:38:54,181: Compiling model.agency_data_pipeline.segment_stats_customers_products_agg
2018-04-18 09:38:54,190: Writing injected SQL for node "model.agency_data_pipeline.customers_first_purchase_proc"
2018-04-18 09:38:54,196: Writing injected SQL for node "model.agency_data_pipeline.agg_ga_campaign_by_type"
2018-04-18 09:38:54,204: Writing injected SQL for node "model.agency_data_pipeline.segment_stats_customers_products_agg"
2018-04-18 09:38:54,206: Acquiring new bigquery connection "segment_stats_category".
2018-04-18 09:38:54,207: Re-using an available connection from the pool.
2018-04-18 09:38:54,213: Acquiring new bigquery connection "customers_first_purchase_proc".
2018-04-18 09:38:54,214: Acquiring new bigquery connection "agg_ga_campaign_by_type".
2018-04-18 09:38:54,215: Acquiring new bigquery connection "segment_stats_customers_products_agg".
2018-04-18 09:38:54,215: Re-using an available connection from the pool.
2018-04-18 09:38:54,217: Re-using an available connection from the pool.
2018-04-18 09:38:54,220: Re-using an available connection from the pool.
2018-04-18 09:38:57,205: Model SQL (segment_stats_category):
SELECT
client,
product_type,
date,
segment_30,
segment_90,
segment_yoy_30,
ifnull(sum(customers_30), 0) customers_30,
ifnull(sum(orders_30), 0) orders_30,
ifnull(sum(revenue_30), 0) revenue_30,
ifnull(sum(customers_90), 0) customers_90,
ifnull(sum(orders_90), 0) orders_90,
ifnull(sum(revenue_90), 0) revenue_90,
ifnull(sum(customers_yoy_30), 0) customers_yoy_30,
ifnull(sum(orders_yoy_30), 0) orders_yoy_30,
ifnull(sum(revenue_yoy_30), 0) revenue_yoy_30
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`segment_stats_sku`
GROUP BY client, product_type, date, segment_30, segment_90, segment_yoy_30
2018-04-18 09:38:57,207: Model SQL (customers_first_purchase_proc):
SELECT 
client, 
customer_id, 
min(cast(date as date)) first_order_date,
unix_date( min(cast(date as date))) first_order_unix_date
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction`
GROUP BY client, customer_id
2018-04-18 09:38:57,207: Model SQL (agg_ga_campaign_by_type):
with orders_new as (
    select 
    date, 
    client, 
    attribution,
    channel, 
    platform, 
    url, 
    campaign,
    count(distinct(customer_id)) customers_new,
    sum(transactions) transactions_new,
    sum(revenue) revenue_new,
    sum(first_order_revenue) first_order_revenue_new,
    sum(lifetime_revenue) lifetime_revenue_new,
    null as customers_total,
    null as transactions_total,
    null as revenue_total
    from `growth-engines-pipeline`.`agency_data_pipeline`.`agg_ga_transaction`
    where order_type = 'New'
    group by date, client, attribution, channel, platform, url, campaign
),
    
orders_total as (
    select 
    date, 
    client, 
    attribution,
    channel, 
    platform, 
    url, 
    campaign,
    null as customers_new,
    null as transactions_new,
    null as revenue_new,
    null as first_order_revenue_new,
    null as lifetime_revenue_new,
    count(distinct(customer_id)) customers_total,
    sum(transactions) transactions_total,
    sum(revenue) revenue_total
    from `growth-engines-pipeline`.`agency_data_pipeline`.`agg_ga_transaction`
    group by date, client, attribution, channel, platform, url, campaign

)

SELECT 
date, 
client, 
attribution,
channel, 
platform, 
url, 
campaign,
sum(customers_new) customers_new,
sum(transactions_new) transactions_new,
sum(revenue_new) revenue_new,
sum(first_order_revenue_new) first_order_revenue_new,
sum(lifetime_revenue_new) lifetime_revenue_new,
sum(customers_total) customers_total,
sum(transactions_total) transactions_total,
sum(revenue_total) revenue_total
from
    ( 
        SELECT * FROM orders_new
        UNION ALL 
        SELECT * FROM orders_total
    )
group by date, client, attribution, channel, platform, url, campaign
2018-04-18 09:38:57,300: Model SQL (segment_stats_customers_products_agg):
WITH ty as (

	SELECT
	client,
	date,
	customer_id,
	product_type,
	segment as segment_365,
	recency_days as recency_365,
	frequency as frequency_365,
	revenue as revenue_365,
	aov as aov_365,
	'' as segment_mom,
	0 as recency_mom,
	0 as frequency_mom,
	0 as revenue_mom,
	0 as aov_mom,
	'' as segment_yoy,
	0 as recency_yoy,
	0 as frequency_yoy,
	0 as revenue_yoy,
	0 as aov_yoy
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers_products`
	WHERE period = 'Rolling 365'

),

last_month as (

	SELECT
	client,
	date,
	customer_id,
	product_type,
	'' as segment_365,
	0 as recency_365,
	0 as frequency_365,
	0 as revenue_365,
	0 as aov_365,
	segment as segment_mom,
	recency_days as recency_mom,
	frequency as frequency_mom,
	revenue as revenue_mom,
	aov as aov_mom,
	'' as segment_yoy,
	0 as recency_yoy,
	0 as frequency_yoy,
	0 as revenue_yoy,
	0 as aov_yoy
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers_products`
	WHERE period = 'Rolling 365 (t-1mo)'

),

this_month_1yr as (

	SELECT
	client,
	date,
	customer_id,
	product_type,
	'' as segment_365,
	0 as recency_365,
	0 as frequency_365,
	0 as revenue_365,
	0 as aov_365,
	'' as segment_mom,
	0 as recency_mom,
	0 as frequency_mom,
	0 as revenue_mom,
	0 as aov_mom,
	segment as segment_yoy,
	recency_days as recency_yoy,
	frequency as frequency_yoy,
	revenue as revenue_yoy,
	aov as aov_yoy
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers_products`
	WHERE period = 'Rolling 365 (t-1yr)'


)

SELECT
client,
date, 
customer_id,
product_type,
ifnull(max(segment_365), '') segment_365,
ifnull(max(segment_mom), '') segment_mom,
ifnull(max(segment_yoy), '') segment_yoy,
ifnull(sum(recency_365), 0) recency_365,
ifnull(sum(frequency_365), 0) frequency_365,
ifnull(sum(revenue_365), 0) revenue_365,
ifnull(sum(aov_365), 0) aov_365,
ifnull(sum(recency_mom), 0) recency_mom,
ifnull(sum(frequency_mom), 0) frequency_mom,
ifnull(sum(revenue_mom), 0) revenue_mom,
ifnull(sum(aov_mom), 0) aov_mom,	
ifnull(sum(recency_yoy), 0) recency_yoy,
ifnull(sum(frequency_yoy), 0) frequency_yoy,
ifnull(sum(revenue_yoy), 0) revenue_yoy,
ifnull(sum(aov_yoy), 0) aov_yoy
FROM
(
	SELECT * FROM ty
	UNION ALL
	SELECT * FROM last_month
	UNION ALL
	SELECT * FROM this_month_1yr

)
GROUP BY client, date, customer_id, product_type
2018-04-18 09:38:58,707: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e373a90>]}
2018-04-18 09:39:00,262: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e2fcfd0>]}
2018-04-18 09:39:01,131: 09:39:01 | 55 of 91 OK created table model agency_data_pipeline.segment_stats_category [CREATE TABLE in 4.54s]
2018-04-18 09:39:01,132: 09:39:01 | 59 of 91 START table model agency_data_pipeline.agg_transaction_daily [RUN]
2018-04-18 09:39:01,132: Compiling model.agency_data_pipeline.agg_transaction_daily
2018-04-18 09:39:01,141: Writing injected SQL for node "model.agency_data_pipeline.agg_transaction_daily"
2018-04-18 09:39:01,145: Acquiring new bigquery connection "agg_transaction_daily".
2018-04-18 09:39:01,146: Re-using an available connection from the pool.
2018-04-18 09:39:03,996: Model SQL (agg_transaction_daily):
SELECT
client,
date,
customer_id,
sum(last_touch_transactions) last_touch_transactions, 
sum(last_touch_revenue) last_touch_revenue, 
sum(first_touch_transactions) first_touch_transactions, 
sum(first_touch_revenue) first_touch_revenue,
sum(quantity) quantity,
sum(revenue) revenue,
count(distinct(order_number)) order_count
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction`
GROUP BY
client, 
date, 
customer_id
2018-04-18 09:39:04,276: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1139e1400>]}
2018-04-18 09:39:04,292: 09:39:04 | 56 of 91 OK created table model agency_data_pipeline.customers_first_purchase_proc [CREATE TABLE in 6.09s]
2018-04-18 09:39:04,294: 09:39:04 | 60 of 91 START table model agency_data_pipeline.order_paths_stats.... [RUN]
2018-04-18 09:39:04,296: Compiling model.agency_data_pipeline.order_paths_stats
2018-04-18 09:39:04,307: Writing injected SQL for node "model.agency_data_pipeline.order_paths_stats"
2018-04-18 09:39:04,308: Acquiring new bigquery connection "order_paths_stats".
2018-04-18 09:39:04,308: Re-using an available connection from the pool.
2018-04-18 09:39:04,545: 09:39:04 | 57 of 91 OK created table model agency_data_pipeline.agg_ga_campaign_by_type [CREATE TABLE in 10.10s]
2018-04-18 09:39:07,005: Model SQL (order_paths_stats):
WITH transactions AS (
  SELECT 
  client, 
  first_product_type,
  second_product_type,
  first_purchase_date,
  customer_count,
  second_orders,
  third_orders,
  fourth_orders,
  fifth_orders,
  second_order_latency_days,
  third_order_latency_days,
  fourth_order_latency_days,
  fifth_order_latency_days,
  first_order_revenue,
  second_order_revenue,
  unix_date(cast(first_purchase_date as date)) d
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`order_paths_agg`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)

SELECT 
client,
'Rolling 365' as period,
first_product_type,
second_product_type,
date_in_range date,
unix_date_in_range, 
sum(customer_count) customer_count,
sum(second_orders) second_orders,
sum(third_orders) third_orders,
sum(fourth_orders) fourth_orders,
sum(fifth_orders) fifth_orders,
sum(second_order_latency_days) second_order_latency_days,
sum(third_order_latency_days) third_order_latency_days,
sum(fourth_order_latency_days) fourth_order_latency_days,
sum(fifth_order_latency_days) fifth_order_latency_days,
sum(first_order_revenue) first_order_revenue,
sum(second_order_revenue) second_order_revenue
FROM daterange
JOIN transactions
ON transactions.d > ( daterange.unix_date_in_range - 365 )
AND transactions.d <= daterange.unix_date_in_range
group by client, first_product_type, second_product_type, date_in_range, unix_date_in_range
2018-04-18 09:39:08,293: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e2fcfd0>]}
2018-04-18 09:39:11,266: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e373a90>]}
2018-04-18 09:39:11,597: 09:39:11 | 60 of 91 OK created table model agency_data_pipeline.order_paths_stats [CREATE TABLE in 4.00s]
2018-04-18 09:39:13,912: 09:39:13 | 59 of 91 OK created table model agency_data_pipeline.agg_transaction_daily [CREATE TABLE in 10.13s]
2018-04-18 09:39:26,800: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1139f89e8>]}
2018-04-18 09:39:29,800: 09:39:29 | 58 of 91 OK created table model agency_data_pipeline.segment_stats_customers_products_agg [CREATE TABLE in 32.62s]
2018-04-18 09:39:29,801: 09:39:29 | 61 of 91 START table model agency_data_pipeline.segment_stats_customers_products [RUN]
2018-04-18 09:39:29,801: 09:39:29 | 62 of 91 START table model agency_data_pipeline.growth_customer_0_365 [RUN]
2018-04-18 09:39:29,801: Compiling model.agency_data_pipeline.segment_stats_customers_products
2018-04-18 09:39:29,801: 09:39:29 | 63 of 91 START table model agency_data_pipeline.customers_proc....... [RUN]
2018-04-18 09:39:29,802: Compiling model.agency_data_pipeline.growth_customer_0_365
2018-04-18 09:39:29,808: Compiling model.agency_data_pipeline.customers_proc
2018-04-18 09:39:29,812: Writing injected SQL for node "model.agency_data_pipeline.segment_stats_customers_products"
2018-04-18 09:39:29,820: Writing injected SQL for node "model.agency_data_pipeline.growth_customer_0_365"
2018-04-18 09:39:29,826: Writing injected SQL for node "model.agency_data_pipeline.customers_proc"
2018-04-18 09:39:29,827: Acquiring new bigquery connection "segment_stats_customers_products".
2018-04-18 09:39:29,829: Acquiring new bigquery connection "growth_customer_0_365".
2018-04-18 09:39:29,829: Re-using an available connection from the pool.
2018-04-18 09:39:29,830: Acquiring new bigquery connection "customers_proc".
2018-04-18 09:39:29,830: Re-using an available connection from the pool.
2018-04-18 09:39:29,830: Re-using an available connection from the pool.
2018-04-18 09:39:32,679: Model SQL (customers_proc):
WITH customers AS (
  SELECT 
  client, 
  customer_id, 
  order_number,
  cast(date as date) order_date,
  unix_date(cast(date as date)) unix_order_date, 
  quantity,
  revenue 
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)
 
SELECT 
client,
period,
customer_id,
date,
window_end_unix_date,
window_end_unix_date - 365 as window_start_unix_date,
window_end_unix_date - unix_date(recent_order) recency_days,
frequency,
quantity,
revenue,
case when frequency > 0 then revenue/frequency else 0 end as aov
FROM 
(  

  SELECT 
  client,
  'Rolling 365' as period,
  customer_id,
  date_in_range date,
  unix_date_in_range,
  unix_date_in_range window_end_unix_date,
  max(order_date) recent_order,
  sum(quantity) as quantity,
  sum(revenue) as revenue,
  count(distinct(order_number)) as frequency
  FROM daterange
  JOIN customers
  ON customers.unix_order_date > ( daterange.unix_date_in_range - 365 )
  AND customers.unix_order_date <= daterange.unix_date_in_range
  GROUP BY client, customer_id, date, unix_date_in_range

  UNION ALL

  SELECT 
  client,
  'Rolling 365 (t-1mo)' as period,
  customer_id,
  date_in_range date,
  unix_date_in_range,
  unix_date_in_range - 30 window_end_unix_date, 
  max(order_date) recent_order,
  sum(quantity) as quantity,
  sum(revenue) as revenue,
  count(distinct(order_number)) as frequency
  FROM daterange
  JOIN customers
  ON customers.unix_order_date > ( daterange.unix_date_in_range - 395 )
  AND customers.unix_order_date <= ( daterange.unix_date_in_range - 30 )
  GROUP BY client, customer_id, date, unix_date_in_range

  UNION ALL

  SELECT 
  client,
  'Rolling 365 (t-1yr)' as period,
  customer_id,
  date_in_range date,
  unix_date_in_range, 
  unix_date_in_range - 365 window_end_unix_date, 
  max(order_date) recent_order,
  sum(quantity) as quantity,
  sum(revenue) as revenue,
  count(distinct(order_number)) as frequency
  FROM daterange
  JOIN customers
  ON customers.unix_order_date > ( daterange.unix_date_in_range - 730 )
  AND customers.unix_order_date <= ( daterange.unix_date_in_range - 365 )
  GROUP BY client, customer_id, date, unix_date_in_range

)
2018-04-18 09:39:32,682: Model SQL (growth_customer_0_365):
WITH transactions AS (
  SELECT 
  client, 
  customer_id, 
  order_number,
  unix_date(cast(date as date)) d, 
  quantity,
  revenue,
  shipping_revenue
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)

SELECT 
date_in_range date,
unix_date_in_range, 
unix_date_in_range_yoy, 
client, 
customer_id,
count(distinct(order_number)) orders,
sum(quantity) quantity,
sum(revenue) revenue,
sum(shipping_revenue) shipping_revenue
FROM daterange
JOIN transactions
ON transactions.d >= ( daterange.unix_date_in_range - 365 ) 
AND transactions.d <= daterange.unix_date_in_range
GROUP BY date, unix_date_in_range, unix_date_in_range_yoy, client, customer_id
2018-04-18 09:39:32,682: Model SQL (segment_stats_customers_products):
SELECT
client,
date,
product_type,
segment_365,
segment_mom,
segment_yoy,
count(distinct(customer_id)) customers,
avg(recency_365) recency_365,
sum(frequency_365) frequency_365,
sum(revenue_365) revenue_365,
case when sum(frequency_365) > 0 then sum(revenue_365)/sum(frequency_365) else null end as aov_365,
avg(recency_mom) recency_mom,
sum(frequency_mom) frequency_mom,
sum(revenue_mom) revenue_mom,
case when sum(frequency_mom) > 0 then sum(revenue_mom)/sum(frequency_mom) else null end as aov_mom,
avg(recency_yoy) recency_yoy,
sum(frequency_yoy) frequency_yoy,
sum(revenue_yoy) revenue_yoy,
case when sum(frequency_yoy) > 0 then sum(revenue_yoy)/sum(frequency_yoy) else null end as aov_yoy
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_stats_customers_products_agg`
GROUP BY client, date, product_type, segment_365, segment_mom, segment_yoy
2018-04-18 09:39:46,145: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1139f8518>]}
2018-04-18 09:39:46,870: 09:39:46 | 61 of 91 OK created table model agency_data_pipeline.segment_stats_customers_products [CREATE TABLE in 16.34s]
2018-04-18 09:39:53,525: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e2fc128>]}
2018-04-18 09:39:54,912: 09:39:54 | 62 of 91 OK created table model agency_data_pipeline.growth_customer_0_365 [CREATE TABLE in 23.72s]
2018-04-18 09:40:01,850: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113a9c780>]}
2018-04-18 09:40:03,224: 09:40:03 | 63 of 91 OK created table model agency_data_pipeline.customers_proc.. [CREATE TABLE in 32.04s]
2018-04-18 09:40:03,225: 09:40:03 | 64 of 91 START table model agency_data_pipeline.retention_730_plus... [RUN]
2018-04-18 09:40:03,225: 09:40:03 | 65 of 91 START table model agency_data_pipeline.retention_0_365...... [RUN]
2018-04-18 09:40:03,226: Compiling model.agency_data_pipeline.retention_730_plus
2018-04-18 09:40:03,226: 09:40:03 | 66 of 91 START table model agency_data_pipeline.retention_60_plus.... [RUN]
2018-04-18 09:40:03,226: 09:40:03 | 67 of 91 START table model agency_data_pipeline.retention_365_730.... [RUN]
2018-04-18 09:40:03,226: Compiling model.agency_data_pipeline.retention_0_365
2018-04-18 09:40:03,232: Writing injected SQL for node "model.agency_data_pipeline.retention_730_plus"
2018-04-18 09:40:03,232: Compiling model.agency_data_pipeline.retention_60_plus
2018-04-18 09:40:03,232: Compiling model.agency_data_pipeline.retention_365_730
2018-04-18 09:40:03,237: Writing injected SQL for node "model.agency_data_pipeline.retention_0_365"
2018-04-18 09:40:03,242: Writing injected SQL for node "model.agency_data_pipeline.retention_60_plus"
2018-04-18 09:40:03,247: Writing injected SQL for node "model.agency_data_pipeline.retention_365_730"
2018-04-18 09:40:03,251: Acquiring new bigquery connection "retention_0_365".
2018-04-18 09:40:03,251: Re-using an available connection from the pool.
2018-04-18 09:40:03,253: Acquiring new bigquery connection "retention_365_730".
2018-04-18 09:40:03,253: Re-using an available connection from the pool.
2018-04-18 09:40:03,254: Acquiring new bigquery connection "retention_730_plus".
2018-04-18 09:40:03,255: Acquiring new bigquery connection "retention_60_plus".
2018-04-18 09:40:03,255: Re-using an available connection from the pool.
2018-04-18 09:40:03,258: Re-using an available connection from the pool.
2018-04-18 09:40:04,139: Model SQL (retention_0_365):
WITH transactions AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_daily`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
),

temp AS (
  SELECT 
  client, 
  customer_id, 
  unix_date(date) d, 
  quantity,
  revenue,
  order_count
  FROM transactions
)

SELECT 
date_in_range date,
unix_date_in_range, 
client, 
customer_id,
sum(quantity) quantity,
sum(revenue) revenue,
sum(order_count) order_count
FROM daterange
JOIN temp
ON temp.d >= ( daterange.unix_date_in_range - 365 ) 
AND temp.d <= daterange.unix_date_in_range
group by date_in_range, unix_date_in_range, client, customer_id
2018-04-18 09:40:04,178: Model SQL (retention_365_730):
WITH transactions AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_daily`
),

daterange AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`  	
),

temp AS (
  SELECT 
  client, 
  customer_id, 
  unix_date(date) d, 
  quantity,
  revenue,
  order_count
  FROM transactions
)

SELECT 
date_in_range date, 
unix_date_in_range,
client, 
customer_id,
sum(quantity) quantity,
sum(revenue) revenue,
sum(order_count) order_count
FROM daterange
JOIN temp
ON ( temp.d >= ( daterange.unix_date_in_range - 730 ) 
AND temp.d < ( daterange.unix_date_in_range - 365 ) )
group by date_in_range, unix_date_in_range, client, customer_id
2018-04-18 09:40:04,234: Model SQL (retention_730_plus):
WITH transactions AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_daily`
),

daterange AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`  	
),

temp AS (
  SELECT 
  client, 
  customer_id, 
  unix_date(date) d, 
  quantity,
  revenue,
  order_count
  FROM transactions
)

SELECT 
date_in_range date, 
unix_date_in_range,
client, 
customer_id,
sum(quantity) quantity,
sum(revenue) revenue,
sum(order_count) order_count
FROM daterange
JOIN temp
ON temp.d <= ( daterange.unix_date_in_range - 730 ) 
group by date_in_range, unix_date_in_range, client, customer_id
2018-04-18 09:40:04,276: Model SQL (retention_60_plus):
WITH transactions AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_daily`
),

daterange AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`  	
),

temp AS (
  SELECT 
  client, 
  customer_id, 
  unix_date(date) d, 
  quantity,
  revenue,
  order_count
  FROM transactions
)

SELECT 
date_in_range date, 
unix_date_in_range,
client, 
customer_id,
sum(quantity) quantity,
sum(revenue) revenue,
sum(order_count) order_count
FROM daterange
JOIN temp
ON temp.d < ( daterange.unix_date_in_range_bom_mom ) 
group by date_in_range, unix_date_in_range, client, customer_id
2018-04-18 09:40:06,419: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1139e9128>]}
2018-04-18 09:40:06,656: 09:40:06 | 64 of 91 OK created table model agency_data_pipeline.retention_730_plus [CREATE TABLE in 3.19s]
2018-04-18 09:40:06,657: 09:40:06 | 68 of 91 START table model agency_data_pipeline.retention_0_30....... [RUN]
2018-04-18 09:40:06,657: Compiling model.agency_data_pipeline.retention_0_30
2018-04-18 09:40:06,667: Writing injected SQL for node "model.agency_data_pipeline.retention_0_30"
2018-04-18 09:40:06,668: Acquiring new bigquery connection "retention_0_30".
2018-04-18 09:40:06,668: Re-using an available connection from the pool.
2018-04-18 09:40:07,529: Model SQL (retention_0_30):
WITH transactions AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_daily`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
),

temp AS (
  SELECT 
  client, 
  customer_id, 
  unix_date(date) d, 
  quantity,
  revenue,
  order_count
  FROM transactions
)

SELECT 
date_in_range date,
unix_date_in_range, 
client, 
customer_id,
sum(quantity) quantity,
sum(revenue) revenue,
sum(order_count) order_count
FROM daterange
JOIN temp
ON temp.d >= ( daterange.unix_date_in_range_bom ) 
AND temp.d <= daterange.unix_date_in_range
group by date_in_range, unix_date_in_range, client, customer_id
2018-04-18 09:40:08,562: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1139cf438>]}
2018-04-18 09:40:08,791: 09:40:08 | 67 of 91 OK created table model agency_data_pipeline.retention_365_730 [CREATE TABLE in 5.33s]
2018-04-18 09:40:08,792: 09:40:08 | 69 of 91 START table model agency_data_pipeline.segment_list_customers_products [RUN]
2018-04-18 09:40:08,792: Compiling model.agency_data_pipeline.segment_list_customers_products
2018-04-18 09:40:08,801: Writing injected SQL for node "model.agency_data_pipeline.segment_list_customers_products"
2018-04-18 09:40:08,802: Acquiring new bigquery connection "segment_list_customers_products".
2018-04-18 09:40:08,802: Re-using an available connection from the pool.
2018-04-18 09:40:09,554: Model SQL (segment_list_customers_products):
SELECT
a.client,
period,
date,
customer_id,
product_type,
b.first_name,
b.last_name,
b.email,
recency_days,
frequency,
revenue,
quantity,
aov,
segment
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers_products` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`agg_customers_union` b
ON (
	a.client = b.client AND
	a.customer_id = b.id
)
2018-04-18 09:40:10,793: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e3731d0>]}
2018-04-18 09:40:13,731: 09:40:13 | 68 of 91 OK created table model agency_data_pipeline.retention_0_30.. [CREATE TABLE in 4.14s]
2018-04-18 09:40:13,731: 09:40:13 | 70 of 91 START table model agency_data_pipeline.retention_30_60...... [RUN]
2018-04-18 09:40:13,731: Compiling model.agency_data_pipeline.retention_30_60
2018-04-18 09:40:13,741: Writing injected SQL for node "model.agency_data_pipeline.retention_30_60"
2018-04-18 09:40:13,742: Acquiring new bigquery connection "retention_30_60".
2018-04-18 09:40:13,742: Re-using an available connection from the pool.
2018-04-18 09:40:14,411: Model SQL (retention_30_60):
WITH transactions AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_daily`
),

daterange AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`  	
),

temp AS (
  SELECT 
  client, 
  customer_id, 
  unix_date(date) d, 
  quantity,
  revenue,
  order_count
  FROM transactions
)

SELECT 
date_in_range date, 
unix_date_in_range,
client, 
customer_id,
sum(quantity) quantity,
sum(revenue) revenue,
sum(order_count) order_count
FROM daterange
JOIN temp
ON ( temp.d >= ( daterange.unix_date_in_range_bom_mom ) 
AND temp.d < ( daterange.unix_date_in_range_bom ) )
group by date_in_range, unix_date_in_range, client, customer_id
2018-04-18 09:40:15,223: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113aa4f98>]}
2018-04-18 09:40:17,347: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e31b8d0>]}
2018-04-18 09:40:17,834: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e3731d0>]}
2018-04-18 09:40:18,513: 09:40:18 | 66 of 91 OK created table model agency_data_pipeline.retention_60_plus [CREATE TABLE in 11.99s]
2018-04-18 09:40:20,084: 09:40:20 | 65 of 91 OK created table model agency_data_pipeline.retention_0_365. [CREATE TABLE in 14.12s]
2018-04-18 09:40:20,321: 09:40:20 | 70 of 91 OK created table model agency_data_pipeline.retention_30_60. [CREATE TABLE in 4.10s]
2018-04-18 09:40:53,431: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113a48160>]}
2018-04-18 09:40:54,080: 09:40:54 | 69 of 91 OK created table model agency_data_pipeline.segment_list_customers_products [CREATE TABLE in 44.64s]
2018-04-18 09:40:54,081: 09:40:54 | 71 of 91 START table model agency_data_pipeline.segment_proc_customers [RUN]
2018-04-18 09:40:54,081: Compiling model.agency_data_pipeline.segment_proc_customers
2018-04-18 09:40:54,091: 09:40:54 | 72 of 91 START table model agency_data_pipeline.agg_platforms_union.. [RUN]
2018-04-18 09:40:54,091: Compiling model.agency_data_pipeline.agg_platforms_union
2018-04-18 09:40:54,100: Writing injected SQL for node "model.agency_data_pipeline.segment_proc_customers"
2018-04-18 09:40:54,105: Writing injected SQL for node "model.agency_data_pipeline.agg_platforms_union"
2018-04-18 09:40:54,108: Acquiring new bigquery connection "segment_proc_customers".
2018-04-18 09:40:54,108: Re-using an available connection from the pool.
2018-04-18 09:40:54,110: Acquiring new bigquery connection "agg_platforms_union".
2018-04-18 09:40:54,111: Re-using an available connection from the pool.
2018-04-18 09:40:54,997: Model SQL (segment_proc_customers):
SELECT
client,
period,
date,
customer_id,
first_order_date,
first_order_unix_date,
recency_days,
frequency,
revenue,
quantity,
aov,
case when recency_days <= 30 and first_order_unix_date >= window_start_unix_date then 'New'
	when frequency = 1 and recency_days <= 90 and aov >= aov_40pct then 'Promising'
	when frequency = 1 then 'One-time Purchaser'
	when frequency >= frequency_90pct and recency_days <= 90 and aov > aov_40pct then 'Whale'
	when recency_days <= 240 and frequency > frequency_50pct then 'Loyal'
	when recency_days <= 90 and frequency > frequency_50pct then 'Potential Loyalists' 
	when recency_days > 240 and frequency > frequency_50pct then 'Defecting Good Customer'	
	when recency_days > recency_50pct and frequency > frequency_50pct then 'Frequent, not Recent'
	when recency_days < recency_50pct and frequency < frequency_50pct then 'Recent, not Frequent'
	else 'Unbucketed' end as segment,
aov_40pct,
frequency_90pct,
frequency_75pct,
frequency_50pct,
recency_90pct,
recency_75pct,
recency_50pct
FROM
(
	SELECT 
	a.client client,
	period,
	date,
	a.customer_id customer_id,
	b.first_order_date first_order_date,
	b.first_order_unix_date first_order_unix_date,
	window_start_unix_date,
	window_end_unix_date,
	recency_days,
	frequency,
	revenue,
	quantity,
	aov,
	PERCENTILE_CONT(aov, 0.40) OVER w1 AS aov_40pct,
	PERCENTILE_CONT(frequency, 0.90) OVER w1 AS frequency_90pct,
	PERCENTILE_CONT(frequency, 0.75) OVER w1 AS frequency_75pct,
	PERCENTILE_CONT(frequency, 0.50) OVER w1 AS frequency_50pct,
	PERCENTILE_CONT(recency_days, 0.5) OVER w1 AS recency_50pct
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`customers_proc` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`customers_first_purchase_proc` b
	ON (
		a.client = b.client and
		a.customer_id = b.customer_id
		)
	WINDOW w1 as (PARTITION BY a.client, period, date)
)
2018-04-18 09:40:54,997: Bad request while running:
SELECT
client,
period,
date,
customer_id,
first_order_date,
first_order_unix_date,
recency_days,
frequency,
revenue,
quantity,
aov,
case when recency_days <= 30 and first_order_unix_date >= window_start_unix_date then 'New'
	when frequency = 1 and recency_days <= 90 and aov >= aov_40pct then 'Promising'
	when frequency = 1 then 'One-time Purchaser'
	when frequency >= frequency_90pct and recency_days <= 90 and aov > aov_40pct then 'Whale'
	when recency_days <= 240 and frequency > frequency_50pct then 'Loyal'
	when recency_days <= 90 and frequency > frequency_50pct then 'Potential Loyalists' 
	when recency_days > 240 and frequency > frequency_50pct then 'Defecting Good Customer'	
	when recency_days > recency_50pct and frequency > frequency_50pct then 'Frequent, not Recent'
	when recency_days < recency_50pct and frequency < frequency_50pct then 'Recent, not Frequent'
	else 'Unbucketed' end as segment,
aov_40pct,
frequency_90pct,
frequency_75pct,
frequency_50pct,
recency_90pct,
recency_75pct,
recency_50pct
FROM
(
	SELECT 
	a.client client,
	period,
	date,
	a.customer_id customer_id,
	b.first_order_date first_order_date,
	b.first_order_unix_date first_order_unix_date,
	window_start_unix_date,
	window_end_unix_date,
	recency_days,
	frequency,
	revenue,
	quantity,
	aov,
	PERCENTILE_CONT(aov, 0.40) OVER w1 AS aov_40pct,
	PERCENTILE_CONT(frequency, 0.90) OVER w1 AS frequency_90pct,
	PERCENTILE_CONT(frequency, 0.75) OVER w1 AS frequency_75pct,
	PERCENTILE_CONT(frequency, 0.50) OVER w1 AS frequency_50pct,
	PERCENTILE_CONT(recency_days, 0.5) OVER w1 AS recency_50pct
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`customers_proc` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`customers_first_purchase_proc` b
	ON (
		a.client = b.client and
		a.customer_id = b.customer_id
		)
	WINDOW w1 as (PARTITION BY a.client, period, date)
)
2018-04-18 09:40:54,998: 400 Unrecognized name: recency_90pct; Did you mean recency_50pct? at [27:1]
2018-04-18 09:40:54,999: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e31b0b8>]}
2018-04-18 09:40:55,018: Model SQL (agg_platforms_union):
SELECT 
date, 
account, 
channel,
platform,
url,
utm_campaign,
campaign,
cost,
impressions,
clicks,
transactions
FROM 
`growth-engines-pipeline`.`agency_data_pipeline`.`adwords_stats`

UNION ALL

SELECT 
date, 
account, 
channel,
platform,
url,
utm_campaign,
campaign,
cost,
impressions,
clicks,
transactions
FROM 
`growth-engines-pipeline`.`agency_data_pipeline`.`bing_ads_stats`

UNION ALL  

SELECT 
date, 
account, 
channel,
platform,
url,
utm_campaign,
campaign,
cost,
impressions,
clicks,
transactions
FROM 
`growth-engines-pipeline`.`agency_data_pipeline`.`fb_ads_stats`
2018-04-18 09:40:55,247: 09:40:55 | 71 of 91 ERROR creating table model agency_data_pipeline.segment_proc_customers [ERROR in 0.92s]
2018-04-18 09:40:59,401: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e373978>]}
2018-04-18 09:40:59,635: 09:40:59 | 72 of 91 OK created table model agency_data_pipeline.agg_platforms_union [CREATE TABLE in 5.31s]
2018-04-18 09:40:59,636: 09:40:59 | 73 of 91 SKIP relation agency_data_pipeline.segment_stats_customers_agg [SKIP]
2018-04-18 09:40:59,636: 09:40:59 | 74 of 91 START table model agency_data_pipeline.retention_0_30_rebuy. [RUN]
2018-04-18 09:40:59,637: 09:40:59 | 75 of 91 START table model agency_data_pipeline.retention_0_365_rebuy [RUN]
2018-04-18 09:40:59,637: Compiling model.agency_data_pipeline.retention_0_30_rebuy
2018-04-18 09:40:59,637: Compiling model.agency_data_pipeline.retention_0_365_rebuy
2018-04-18 09:40:59,645: Writing injected SQL for node "model.agency_data_pipeline.retention_0_30_rebuy"
2018-04-18 09:40:59,650: Writing injected SQL for node "model.agency_data_pipeline.retention_0_365_rebuy"
2018-04-18 09:40:59,654: Acquiring new bigquery connection "retention_0_30_rebuy".
2018-04-18 09:40:59,654: Re-using an available connection from the pool.
2018-04-18 09:40:59,655: Acquiring new bigquery connection "retention_0_365_rebuy".
2018-04-18 09:40:59,655: Re-using an available connection from the pool.
2018-04-18 09:41:00,631: Model SQL (retention_0_30_rebuy):
SELECT 
r2.client,
r2.date,
r2.customer_id, 
r2.quantity,
r2.revenue
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_30_60` r1 
left join `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30` r2 
  on ( r1.customer_id = r2.customer_id 
  and r1.date = r2.date )
2018-04-18 09:41:00,631: Model SQL (retention_0_365_rebuy):
SELECT 
r2.client,
r2.date,
r2.customer_id, 
r2.quantity,
r2.revenue
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_365_730` r1 
left join `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365` r2 
  on ( r1.customer_id = r2.customer_id 
  and r1.date = r2.date )
2018-04-18 09:41:02,810: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e2fc128>]}
2018-04-18 09:41:03,131: 09:41:03 | 74 of 91 OK created table model agency_data_pipeline.retention_0_30_rebuy [CREATE TABLE in 3.17s]
2018-04-18 09:41:06,152: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1116712e8>]}
2018-04-18 09:41:06,391: 09:41:06 | 75 of 91 OK created table model agency_data_pipeline.retention_0_365_rebuy [CREATE TABLE in 6.51s]
2018-04-18 09:41:06,392: 09:41:06 | 76 of 91 START table model agency_data_pipeline.retention_stats_rebuy_rate [RUN]
2018-04-18 09:41:06,392: Compiling model.agency_data_pipeline.retention_stats_rebuy_rate
2018-04-18 09:41:06,401: Writing injected SQL for node "model.agency_data_pipeline.retention_stats_rebuy_rate"
2018-04-18 09:41:06,399: 09:41:06 | 77 of 91 START table model agency_data_pipeline.retention_0_365_new.. [RUN]
2018-04-18 09:41:06,401: Compiling model.agency_data_pipeline.retention_0_365_new
2018-04-18 09:41:06,406: Writing injected SQL for node "model.agency_data_pipeline.retention_0_365_new"
2018-04-18 09:41:06,399: 09:41:06 | 78 of 91 START table model agency_data_pipeline.retention_stats_rebuy_rate_month [RUN]
2018-04-18 09:41:06,406: Compiling model.agency_data_pipeline.retention_stats_rebuy_rate_month
2018-04-18 09:41:06,412: Writing injected SQL for node "model.agency_data_pipeline.retention_stats_rebuy_rate_month"
2018-04-18 09:41:06,399: 09:41:06 | 79 of 91 START table model agency_data_pipeline.agg_platforms_client. [RUN]
2018-04-18 09:41:06,412: Compiling model.agency_data_pipeline.agg_platforms_client
2018-04-18 09:41:06,422: Writing injected SQL for node "model.agency_data_pipeline.agg_platforms_client"
2018-04-18 09:41:06,424: Acquiring new bigquery connection "retention_stats_rebuy_rate".
2018-04-18 09:41:06,428: Re-using an available connection from the pool.
2018-04-18 09:41:06,426: Acquiring new bigquery connection "retention_0_365_new".
2018-04-18 09:41:06,427: Acquiring new bigquery connection "retention_stats_rebuy_rate_month".
2018-04-18 09:41:06,430: Re-using an available connection from the pool.
2018-04-18 09:41:06,432: Re-using an available connection from the pool.
2018-04-18 09:41:06,437: Acquiring new bigquery connection "agg_platforms_client".
2018-04-18 09:41:06,437: Re-using an available connection from the pool.
2018-04-18 09:41:07,362: Model SQL (retention_stats_rebuy_rate):
WITH r1 AS (
	SELECT 
	date,
	client,
	count(distinct customer_id) customers_prior_year,
	0 as customers_current_year, 
	sum(quantity) quantity_prior_year,
	0 as quantity_current_year,
	sum(revenue) revenue_prior_year,
	0 as revenue_current_year,
	case when sum(quantity) > 0 then sum(revenue)/sum(quantity) else null end as aov_prior_year,
	null as aov_current_year
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_365_730`
	group by date, client
),

r2 AS (
	SELECT 
	date,
	client,
	0 as customers_prior_year,
	count(distinct customer_id) customers_current_year, 
	0 as quantity_prior_year,
	sum(quantity) quantity_current_year,
	0 as revenue_prior_year,
	sum(revenue) revenue_current_year,
	null as aov_prior_year,
	case when sum(quantity) > 0 then sum(revenue)/sum(quantity) else null end as aov_current_year
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365_rebuy`
	group by date, client
)

SELECT 
date,
client,
sum(customers_prior_year) customers_prior_year, 
sum(customers_current_year) customers_current_year,
sum(quantity_prior_year) quantity_prior_year,
sum(quantity_current_year) quantity_current_year,
sum(revenue_prior_year) revenue_prior_year,
sum(revenue_current_year) revenue_current_year,
sum(aov_prior_year) aov_prior_year,
sum(aov_current_year) aov_current_year,
case when sum(revenue_prior_year) > 0 then sum(revenue_current_year)/sum(revenue_prior_year) else null end as revenue_retention,
case when sum(customers_prior_year) > 0 then sum(customers_current_year)/sum(customers_prior_year) else null end as customer_retention
FROM
(
	SELECT
	date,
	client,
	customers_prior_year,
	customers_current_year,
	quantity_prior_year,
	quantity_current_year,
	revenue_prior_year,
	revenue_current_year,
	aov_prior_year,
	aov_current_year
	FROM r1

	UNION ALL

	SELECT
	date,
	client,
	customers_prior_year,
	customers_current_year,
	quantity_prior_year,
	quantity_current_year,
	revenue_prior_year,
	revenue_current_year,
	aov_prior_year,
	aov_current_year
	FROM r2

) 
GROUP BY date, client
2018-04-18 09:41:07,368: Model SQL (agg_platforms_client):
SELECT 
date, 
a.account account, 
b.client client,
a.platform platform,
a.channel channel,
url,
utm_campaign,
campaign,
cost,
impressions,
clicks,
transactions ad_platform_transactions
FROM 
  `growth-engines-pipeline`.`agency_data_pipeline`.`agg_platforms_union` a
LEFT JOIN 
  `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc` b
ON ( 
  a.account = b.account AND
  a.platform = b.platform
)
2018-04-18 09:41:07,408: Model SQL (retention_0_365_new):
SELECT 
a.client,
a.date,
a.customer_id, 
a.quantity,
a.revenue,
a.order_count
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_730_plus` b
ON (
	a.client = b.client AND
	a.date = b.date AND
	a.customer_id = b.customer_id
)
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_365_730` c
ON (
	a.client = c.client AND
	a.date = c.date AND
	a.customer_id = c.customer_id
)
WHERE b.customer_id is null 
and c.customer_id is null
2018-04-18 09:41:07,489: Model SQL (retention_stats_rebuy_rate_month):
WITH r1 AS (
	SELECT 
	date,
	client,
	count(distinct customer_id) customers_prior_year,
	0 as customers_current_year, 
	sum(quantity) quantity_prior_year,
	0 as quantity_current_year,
	sum(revenue) revenue_prior_year,
	0 as revenue_current_year,
	case when sum(quantity) > 0 then sum(revenue)/sum(quantity) else null end as aov_prior_year,
	null as aov_current_year
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_30_60`
	group by date, client
),

r2 AS (
	SELECT 
	date,
	client,
	0 as customers_prior_year,
	count(distinct customer_id) customers_current_year, 
	0 as quantity_prior_year,
	sum(quantity) quantity_current_year,
	0 as revenue_prior_year,
	sum(revenue) revenue_current_year,
	null as aov_prior_year,
	case when sum(quantity) > 0 then sum(revenue)/sum(quantity) else null end as aov_current_year
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30_rebuy`
	group by date, client
)

SELECT 
date,
client,
sum(customers_prior_year) customers_prior_year, 
sum(customers_current_year) customers_current_year,
sum(quantity_prior_year) quantity_prior_year,
sum(quantity_current_year) quantity_current_year,
sum(revenue_prior_year) revenue_prior_year,
sum(revenue_current_year) revenue_current_year,
sum(aov_prior_year) aov_prior_year,
sum(aov_current_year) aov_current_year,
case when sum(revenue_prior_year) > 0 then sum(revenue_current_year)/sum(revenue_prior_year) else null end as revenue_retention,
case when sum(customers_prior_year) > 0 then sum(customers_current_year)/sum(customers_prior_year) else null end as customer_retention
FROM
(
	SELECT
	date,
	client,
	customers_prior_year,
	customers_current_year,
	quantity_prior_year,
	quantity_current_year,
	revenue_prior_year,
	revenue_current_year,
	aov_prior_year,
	aov_current_year
	FROM r1

	UNION ALL

	SELECT
	date,
	client,
	customers_prior_year,
	customers_current_year,
	quantity_prior_year,
	quantity_current_year,
	revenue_prior_year,
	revenue_current_year,
	aov_prior_year,
	aov_current_year
	FROM r2

) 
GROUP BY date, client
2018-04-18 09:41:09,572: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e373978>]}
2018-04-18 09:41:09,680: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113a48828>]}
2018-04-18 09:41:09,829: 09:41:09 | 76 of 91 OK created table model agency_data_pipeline.retention_stats_rebuy_rate [CREATE TABLE in 3.18s]
2018-04-18 09:41:09,830: 09:41:09 | 80 of 91 START table model agency_data_pipeline.retention_0_30_reactivated [RUN]
2018-04-18 09:41:09,835: Compiling model.agency_data_pipeline.retention_0_30_reactivated
2018-04-18 09:41:09,891: Writing injected SQL for node "model.agency_data_pipeline.retention_0_30_reactivated"
2018-04-18 09:41:09,892: Acquiring new bigquery connection "retention_0_30_reactivated".
2018-04-18 09:41:09,892: Re-using an available connection from the pool.
2018-04-18 09:41:10,163: 09:41:10 | 78 of 91 OK created table model agency_data_pipeline.retention_stats_rebuy_rate_month [CREATE TABLE in 3.27s]
2018-04-18 09:41:10,164: 09:41:10 | 81 of 91 START table model agency_data_pipeline.retention_0_365_reactivated [RUN]
2018-04-18 09:41:10,167: Compiling model.agency_data_pipeline.retention_0_365_reactivated
2018-04-18 09:41:10,192: Writing injected SQL for node "model.agency_data_pipeline.retention_0_365_reactivated"
2018-04-18 09:41:10,195: Acquiring new bigquery connection "retention_0_365_reactivated".
2018-04-18 09:41:10,196: Re-using an available connection from the pool.
2018-04-18 09:41:10,701: Model SQL (retention_0_30_reactivated):
SELECT 
a.client,
a.date,
a.customer_id, 
a.quantity,
a.revenue
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_60_plus` b
ON (
	a.client = b.client AND
	a.date = b.date AND
	a.customer_id = b.customer_id
)
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_30_60` c
ON (
	a.client = c.client AND
	a.date = c.date AND
	a.customer_id = c.customer_id
)
WHERE b.customer_id is not null 
AND c.customer_id is null
2018-04-18 09:41:10,901: Model SQL (retention_0_365_reactivated):
SELECT 
a.client,
a.date,
a.customer_id, 
a.quantity,
a.revenue
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_730_plus` b
ON (
	a.client = b.client AND
	a.date = b.date AND
	a.customer_id = b.customer_id
)
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_365_730` c
ON (
	a.client = c.client AND
	a.date = c.date AND
	a.customer_id = c.customer_id
)
WHERE b.customer_id is not null 
AND c.customer_id is null
2018-04-18 09:41:11,791: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113a551d0>]}
2018-04-18 09:41:12,546: 09:41:12 | 79 of 91 OK created table model agency_data_pipeline.agg_platforms_client [CREATE TABLE in 5.38s]
2018-04-18 09:41:12,546: 09:41:12 | 82 of 91 SKIP relation agency_data_pipeline.segment_stats_customers.. [SKIP]
2018-04-18 09:41:12,547: 09:41:12 | 83 of 91 START table model agency_data_pipeline.retention_0_30_new... [RUN]
2018-04-18 09:41:12,547: Compiling model.agency_data_pipeline.retention_0_30_new
2018-04-18 09:41:12,558: Writing injected SQL for node "model.agency_data_pipeline.retention_0_30_new"
2018-04-18 09:41:12,560: Acquiring new bigquery connection "retention_0_30_new".
2018-04-18 09:41:12,560: Re-using an available connection from the pool.
2018-04-18 09:41:13,874: Model SQL (retention_0_30_new):
SELECT 
a.client,
a.date,
a.customer_id, 
a.quantity,
a.revenue,
a.order_count
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_60_plus` b
ON (
	a.client = b.client AND
	a.date = b.date AND
	a.customer_id = b.customer_id
)
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_30_60` c
ON (
	a.client = c.client AND
	a.date = c.date AND
	a.customer_id = c.customer_id
)
WHERE b.customer_id is null 
and c.customer_id is null
2018-04-18 09:41:14,033: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e373978>]}
2018-04-18 09:41:14,215: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113a48828>]}
2018-04-18 09:41:14,260: 09:41:14 | 80 of 91 OK created table model agency_data_pipeline.retention_0_30_reactivated [CREATE TABLE in 4.20s]
2018-04-18 09:41:14,476: 09:41:14 | 81 of 91 OK created table model agency_data_pipeline.retention_0_365_reactivated [CREATE TABLE in 4.05s]
2018-04-18 09:41:15,771: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113a05cf8>]}
2018-04-18 09:41:16,018: 09:41:16 | 77 of 91 OK created table model agency_data_pipeline.retention_0_365_new [CREATE TABLE in 9.37s]
2018-04-18 09:41:19,387: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113a2cdd8>]}
2018-04-18 09:41:19,641: 09:41:19 | 83 of 91 OK created table model agency_data_pipeline.retention_0_30_new [CREATE TABLE in 6.84s]
2018-04-18 09:41:19,642: 09:41:19 | 84 of 91 SKIP relation agency_data_pipeline.segment_list_customers... [SKIP]
2018-04-18 09:41:19,643: 09:41:19 | 85 of 91 START table model agency_data_pipeline.growth_customer_0_365_segment [RUN]
2018-04-18 09:41:19,643: Compiling model.agency_data_pipeline.growth_customer_0_365_segment
2018-04-18 09:41:19,654: Writing injected SQL for node "model.agency_data_pipeline.growth_customer_0_365_segment"
2018-04-18 09:41:19,659: Acquiring new bigquery connection "growth_customer_0_365_segment".
2018-04-18 09:41:19,659: Re-using an available connection from the pool.
2018-04-18 09:41:20,805: Model SQL (growth_customer_0_365_segment):
with segment as (

	SELECT 
	a.date,
	unix_date_in_range,
	unix_date_in_range_yoy,
	a.client client,
	a.customer_id customer_id,
	case when b.customer_id is not null then 'New' else 'Existing' end as segment,
	a.orders,
	a.quantity,
	a.revenue,
	a.shipping_revenue
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_customer_0_365` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365_new` b
	ON (
	  a.customer_id = b.customer_id AND
	  a.date  = b.date AND
	  a.client = b.client
	)
),

total as (

	SELECT 
	date,
	unix_date_in_range,
	unix_date_in_range_yoy,
	client,
	customer_id,
	'Total' as segment,
	orders,
	quantity,
	revenue,
	shipping_revenue
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_customer_0_365`

)

SELECT 
date,
unix_date_in_range,
unix_date_in_range_yoy,
client,
segment,
count(distinct(customer_id)) customers,
sum(orders) orders,
sum(quantity) quantity,
sum(revenue) revenue,
sum(shipping_revenue) shipping_revenue
FROM
( 
	SELECT * FROM segment
	UNION ALL
	SELECT * FROM total
) 
GROUP BY date, unix_date_in_range, unix_date_in_range_yoy, client, segment
2018-04-18 09:41:33,054: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113a2cdd8>]}
2018-04-18 09:41:33,804: 09:41:33 | 85 of 91 OK created table model agency_data_pipeline.growth_customer_0_365_segment [CREATE TABLE in 13.41s]
2018-04-18 09:41:33,805: 09:41:33 | 86 of 91 START table model agency_data_pipeline.growth_date_union.... [RUN]
2018-04-18 09:41:33,805: Compiling model.agency_data_pipeline.growth_date_union
2018-04-18 09:41:33,811: Writing injected SQL for node "model.agency_data_pipeline.growth_date_union"
2018-04-18 09:41:33,812: Acquiring new bigquery connection "growth_date_union".
2018-04-18 09:41:33,812: Re-using an available connection from the pool.
2018-04-18 09:41:34,718: Model SQL (growth_date_union):
with ty as (

  SELECT 
  date,
  unix_date_in_range, 
  unix_date_in_range_yoy, 
  client, 
  segment,
  customers customers_ty,
  orders orders_ty,
  quantity quantity_ty,
  revenue revenue_ty,
  shipping_revenue shipping_revenue_ty,
  null as customers_ly,
  null as orders_ly,
  null as quantity_ly,
  null as revenue_ly,
  null as shipping_revenue_ly
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_customer_0_365_segment`

),

ly as (

  SELECT 
  date,
  0 as unix_date_in_range, 
  unix_date_in_range unix_date_in_range_yoy, 
  client, 
  segment,
  null as customers_ty,
  null as orders_ty,
  null as quantity_ty,
  null as revenue_ty,
  null as shipping_revenue_ty,
  customers customers_ly,
  orders orders_ly,
  quantity quantity_ly,
  revenue revenue_ly,
  shipping_revenue shipping_revenue_ly
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_customer_0_365_segment`

)


SELECT
max(date) date,
max(unix_date_in_range) unix_date_in_range,
unix_date_in_range_yoy,
client,
segment,
ifnull(sum(customers_ty), 0) customers_ty,
ifnull(sum(orders_ty), 0) orders_ty,
ifnull(sum(quantity_ty), 0) quantity_ty,
ifnull(sum(revenue_ty), 0) revenue_ty,
ifnull(sum(shipping_revenue_ty), 0) shipping_revenue_ty,
case when sum(orders_ty) > 0 then sum(revenue_ty)/sum(orders_ty) else null end as aov_ty,
ifnull(sum(customers_ly), 0) customers_ly,
ifnull(sum(orders_ly), 0) orders_ly,
ifnull(sum(quantity_ly), 0) quantity_ly,
ifnull(sum(revenue_ly), 0) revenue_ly,
ifnull(sum(shipping_revenue_ly), 0) shipping_revenue_ly,
case when sum(orders_ly) > 0 then sum(revenue_ly)/sum(orders_ly) else null end as aov_ly,
case when sum(orders_ly) > 0 then ( sum(orders_ty) - sum(orders_ly) ) / sum(orders_ly) else null end as order_growth,
case when sum(revenue_ly) > 0 then ( sum(revenue_ty) - sum(revenue_ly) ) / sum(revenue_ly) else null end as revenue_growth,
case when sum(customers_ly) > 0 then ( sum(customers_ty) - sum(customers_ly) ) / sum(customers_ly) else null end as customer_growth,
case when sum(orders_ly) > 0 then ( sum(revenue_ty)/sum(orders_ty) - sum(revenue_ly)/sum(orders_ly) ) / ( sum(revenue_ly)/sum(orders_ly) ) else null end as aov_growth
FROM (

  SELECT * FROM ty
  UNION ALL
  SELECT * FROM ly

)
where unix_date_in_range is not null
group by unix_date_in_range_yoy, client, segment
2018-04-18 09:41:35,822: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e2f6320>]}
2018-04-18 09:41:36,070: 09:41:36 | 86 of 91 OK created table model agency_data_pipeline.growth_date_union [CREATE TABLE in 2.02s]
2018-04-18 09:41:36,071: 09:41:36 | 87 of 91 START table model agency_data_pipeline.retention_stats...... [RUN]
2018-04-18 09:41:36,071: Compiling model.agency_data_pipeline.retention_stats
2018-04-18 09:41:36,071: 09:41:36 | 88 of 91 START table model agency_data_pipeline.growth_stats......... [RUN]
2018-04-18 09:41:36,077: Compiling model.agency_data_pipeline.growth_stats
2018-04-18 09:41:36,076: 09:41:36 | 89 of 91 START table model agency_data_pipeline.retention_stats_month [RUN]
2018-04-18 09:41:36,080: Writing injected SQL for node "model.agency_data_pipeline.retention_stats"
2018-04-18 09:41:36,086: Compiling model.agency_data_pipeline.retention_stats_month
2018-04-18 09:41:36,089: Writing injected SQL for node "model.agency_data_pipeline.growth_stats"
2018-04-18 09:41:36,098: Writing injected SQL for node "model.agency_data_pipeline.retention_stats_month"
2018-04-18 09:41:36,099: Acquiring new bigquery connection "retention_stats".
2018-04-18 09:41:36,100: Re-using an available connection from the pool.
2018-04-18 09:41:36,103: Acquiring new bigquery connection "retention_stats_month".
2018-04-18 09:41:36,104: Re-using an available connection from the pool.
2018-04-18 09:41:36,105: Acquiring new bigquery connection "growth_stats".
2018-04-18 09:41:36,107: Re-using an available connection from the pool.
2018-04-18 09:41:36,983: Model SQL (retention_stats):
WITH last_year_buyers AS (
	SELECT 
	date,
	client,
	'Last year buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_365_730`
	group by date, client
),

rebuy_rate AS (
	SELECT 
	date,
	client,
	'Rebuy rate' as metric,
	customer_retention value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_stats_rebuy_rate`
),

repeat_buyers AS (
	SELECT 
	date,
	client,
	'Repeat buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365_rebuy`
	group by date, client
),

reactivated_buyers AS (
	SELECT 
	date,
	client,
	'Reactivated buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365_reactivated`
	group by date, client
),

new_buyers AS (
	SELECT 
	date,
	client,
	'New buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365_new`
	group by date, client
),

this_year_buyers AS (
	SELECT 
	date,
	client,
	'This year buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365`
	group by date, client
),

this_year_revenue AS (
	SELECT 
	date,
	client,
	'This year revenue' as metric,
	sum(revenue) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365`
	group by date, client
),

this_year_aov AS (
	SELECT 
	date,
	client,
	'This year AOV' as metric,
	case when sum(order_count) > 0 then sum(revenue)/sum(order_count) else 0 end as value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365`
	group by date, client
),

this_year_frequency AS (
	SELECT 
	date,
	client,
	'This year frequency' as metric,
	case when count(distinct customer_id) > 0 then sum(order_count)/count(distinct customer_id) else 0 end as value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365`
	group by date, client
)

SELECT 
date,
client,
metric,
ifnull(value, 0) value
FROM
(
	SELECT
	date,
	client,
	metric,
	value
	FROM last_year_buyers

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM rebuy_rate

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM repeat_buyers

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM reactivated_buyers	

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM new_buyers	

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_year_buyers	

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_year_revenue

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_year_aov

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_year_frequency

	UNION ALL

	SELECT
	a.date,
	a.client,
	'Dormant buyers' as metric,
	a.value - ifnull(b.value, 0) as value
	FROM last_year_buyers a
	LEFT JOIN repeat_buyers b
	ON ( a.date = b.date AND
		a.client = b.client )							

)
2018-04-18 09:41:36,985: Model SQL (growth_stats):
with orders as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'Orders' as metric,
  orders_ty as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`
),

order_growth as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'Order Growth' as metric,
  order_growth as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`
),

revenue as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'Revenue' as metric,
  revenue_ty as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`
),

revenue_growth as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'Revenue Growth' as metric,
  revenue_growth as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`
),

customers as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'Customers' as metric,
  customers_ty as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`
),

customer_growth as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'Customer Growth' as metric,
  customer_growth as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`

),

aov as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'AOV' as metric,
  aov_ty as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`

),

aov_growth as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'AOV Growth' as metric,
  aov_growth as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`

)

SELECT * FROM orders
UNION ALL 
SELECT * FROM order_growth
UNION ALL
SELECT * FROM revenue
UNION ALL 
SELECT * FROM revenue_growth
UNION ALL
SELECT * FROM customers
UNION ALL 
SELECT * FROM customer_growth
UNION ALL
SELECT * FROM aov
UNION ALL 
SELECT * FROM aov_growth
2018-04-18 09:41:36,991: Model SQL (retention_stats_month):
WITH last_month_buyers AS (
	SELECT 
	date,
	client,
	'Last month buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_30_60`
	group by date, client
),

rebuy_rate AS (
	SELECT 
	date,
	client,
	'Rebuy rate' as metric,
	customer_retention value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_stats_rebuy_rate_month`
),

repeat_buyers AS (
	SELECT 
	date,
	client,
	'Repeat buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30_rebuy`
	group by date, client
),

reactivated_buyers AS (
	SELECT 
	date,
	client,
	'Reactivated buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30_reactivated`
	group by date, client
),

new_buyers AS (
	SELECT 
	date,
	client,
	'New buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30_new`
	group by date, client
),

this_month_buyers AS (
	SELECT 
	date,
	client,
	'This month buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30`
	group by date, client
),

this_month_revenue AS (
	SELECT 
	date,
	client,
	'This month revenue' as metric,
	sum(revenue) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30`
	group by date, client
),

this_month_aov AS (
	SELECT 
	date,
	client,
	'This month AOV' as metric,
	case when sum(order_count) > 0 then sum(revenue)/sum(order_count) else 0 end as value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30`
	group by date, client
),

this_month_frequency AS (
	SELECT 
	date,
	client,
	'This month frequency' as metric,
	case when count(distinct customer_id) > 0 then sum(order_count)/count(distinct customer_id) else 0 end as value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30`
	group by date, client
)

SELECT 
date,
client,
metric,
ifnull(value, 0) value
FROM
(
	SELECT
	date,
	client,
	metric,
	value
	FROM last_month_buyers

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM rebuy_rate

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM repeat_buyers

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM reactivated_buyers	

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM new_buyers	

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_month_buyers	

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_month_revenue

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_month_aov

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_month_frequency

	UNION ALL

	SELECT
	a.date,
	a.client,
	'Dormant buyers' as metric,
	a.value - ifnull(b.value, 0) as value
	FROM last_month_buyers a
	LEFT JOIN repeat_buyers b
	ON ( a.date = b.date AND
		a.client = b.client )							

)
2018-04-18 09:41:38,083: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113ae9eb8>]}
2018-04-18 09:41:38,326: 09:41:38 | 88 of 91 OK created table model agency_data_pipeline.growth_stats.... [CREATE TABLE in 2.01s]
2018-04-18 09:41:39,174: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113a48a90>]}
2018-04-18 09:41:39,448: 09:41:39 | 89 of 91 OK created table model agency_data_pipeline.retention_stats_month [CREATE TABLE in 3.09s]
2018-04-18 09:41:43,900: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e2f6cf8>]}
2018-04-18 09:41:44,162: 09:41:44 | 87 of 91 OK created table model agency_data_pipeline.retention_stats. [CREATE TABLE in 7.83s]
2018-04-18 09:41:44,163: 09:41:44 | 90 of 91 START table model agency_data_pipeline.agg_campaign......... [RUN]
2018-04-18 09:41:44,163: Compiling model.agency_data_pipeline.agg_campaign
2018-04-18 09:41:44,176: Writing injected SQL for node "model.agency_data_pipeline.agg_campaign"
2018-04-18 09:41:44,177: Acquiring new bigquery connection "agg_campaign".
2018-04-18 09:41:44,177: Re-using an available connection from the pool.
2018-04-18 09:41:45,491: Model SQL (agg_campaign):
with ga as (

	select 
		date, client, attribution, channel, platform, url, campaign as utm_campaign, '' as campaign,
    	customers_new,
    	transactions_new,
    	revenue_new,
    	first_order_revenue_new,
    	lifetime_revenue_new,
    	customers_total,
    	transactions_total,
    	revenue_total,
		null as cost, null as impressions, null as clicks, null as ad_platform_transactions
	from `growth-engines-pipeline`.`agency_data_pipeline`.`agg_ga_campaign_by_type`

),

platforms_last_touch as (

	select 
		date, client, 'Last-touch' as attribution, channel, platform, url, utm_campaign, campaign,
		null as customers_new,
    	null as transactions_new,
    	null as revenue_new,
    	null as first_order_revenue_new,
    	null as lifetime_revenue_new,
    	null as customers_total,
    	null as transactions_total,
    	null as revenue_total,
		cost, impressions, clicks, ad_platform_transactions
	from `growth-engines-pipeline`.`agency_data_pipeline`.`agg_platforms_client`

),

platforms_first_touch as (

    select 
        date, client, 'First-touch' as attribution, channel, platform, url, utm_campaign, campaign,
        null as customers_new,
        null as transactions_new,
        null as revenue_new,
        null as first_order_revenue_new,
        null as lifetime_revenue_new,
        null as customers_total,
        null as transactions_total,
        null as revenue_total,
        cost, impressions, clicks, ad_platform_transactions
    from `growth-engines-pipeline`.`agency_data_pipeline`.`agg_platforms_client`

)


SELECT
    date, 
    client,
    attribution,
    platform,
    channel, 
    url,
    utm_campaign,
    max(campaign) campaign,
    ifnull( sum(cost), 0) cost,
	ifnull( sum(impressions), 0) impressions,
	ifnull( sum(clicks), 0) clicks,
	ifnull( sum(ad_platform_transactions), 0) ad_platform_transactions,
	ifnull( sum(customers_new), 0) customers_new,
	ifnull( sum(transactions_new), 0) transactions_new,
	ifnull( sum(revenue_new), 0) revenue_new,
	ifnull( sum(first_order_revenue_new), 0) first_order_revenue_new,
	ifnull( sum(lifetime_revenue_new), 0) lifetime_revenue_new,
	ifnull( sum(customers_total), 0) customers_total,
	ifnull( sum(transactions_total), 0) transactions_total,
	ifnull( sum(revenue_total), 0) revenue_total	
FROM 
(
    SELECT *
    FROM 
      ga
    UNION ALL
    SELECT *
    FROM 
      platforms_first_touch
    UNION ALL
    SELECT *
    FROM 
      platforms_last_touch      
) 
GROUP BY
    date, client, attribution, platform, channel, url, utm_campaign
2018-04-18 09:41:53,189: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e31b400>]}
2018-04-18 09:41:53,873: 09:41:53 | 90 of 91 OK created table model agency_data_pipeline.agg_campaign.... [CREATE TABLE in 9.03s]
2018-04-18 09:41:53,874: 09:41:53 | 91 of 91 START table model agency_data_pipeline.agg_platform_monthly. [RUN]
2018-04-18 09:41:53,874: Compiling model.agency_data_pipeline.agg_platform_monthly
2018-04-18 09:41:53,882: Writing injected SQL for node "model.agency_data_pipeline.agg_platform_monthly"
2018-04-18 09:41:53,884: Acquiring new bigquery connection "agg_platform_monthly".
2018-04-18 09:41:53,884: Re-using an available connection from the pool.
2018-04-18 09:41:54,801: Model SQL (agg_platform_monthly):
SELECT
    FORMAT_DATE("%Y-%m", date) AS yyyymm,
    client,
    attribution,
    platform,
    channel, 
    sum(cost) cost,
	sum(clicks) clicks,
	sum(customers_new) customers_new,
	sum(first_order_revenue_new) first_order_revenue_new,
	sum(lifetime_revenue_new) lifetime_revenue_new,
	sum(transactions_new) transactions_new,
	sum(revenue_new) revenue_new,
    sum(customers_total) customers_total,
    sum(transactions_total) transactions_total,
    sum(revenue_total) revenue_total
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_campaign`
GROUP BY
    yyyymm, client, attribution, platform, channel
2018-04-18 09:41:57,052: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4e19ab37-efd8-4d5f-b551-1ba4e4f78b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10e31b5c0>]}
2018-04-18 09:41:57,368: 09:41:57 | 91 of 91 OK created table model agency_data_pipeline.agg_platform_monthly [CREATE TABLE in 3.18s]
2018-04-18 09:41:57,402: 09:41:57 | 
2018-04-18 09:41:57,403: 09:41:57 | Finished running 91 table models in 414.44s.
2018-04-18 09:41:57,403: Connection 'master' was left open.
2018-04-18 09:41:57,404: 
2018-04-18 09:41:57,405: Completed with 1 errors:
2018-04-18 09:41:57,405: 
2018-04-18 09:41:57,405: Database Error in model segment_proc_customers (models/segmentation/customers/segment_proc_customers.sql)
2018-04-18 09:41:57,406:   Unrecognized name: recency_90pct; Did you mean recency_50pct? at [27:1]
2018-04-18 09:41:57,406:   compiled SQL at target/compiled/agency_data_pipeline/segmentation/customers/segment_proc_customers.sql
2018-04-18 09:41:57,406: 
Done. PASS=87 ERROR=1 SKIP=3 TOTAL=91
2018-04-18 09:41:57,408: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11164b940>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11164bbe0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1115f25f8>]}
2018-04-18 09:41:57,646: Flushing usage events
2018-04-18 09:46:55,264: Tracking: tracking
2018-04-18 09:46:55,267: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d88b588>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d88b828>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d88bba8>]}
2018-04-18 09:46:56,022: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-04-18 09:46:56,044: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/growth-engines/dbt_modules
2018-04-18 09:46:56,051: Parsing get_column_values.sql
2018-04-18 09:46:56,074: Parsing get_url_parameter.sql
2018-04-18 09:46:56,082: Parsing split_part.sql
2018-04-18 09:46:56,092: Parsing table_exists.sql
2018-04-18 09:46:56,104: Parsing core.sql
2018-04-18 09:46:56,121: Parsing adapters/bigquery.sql
2018-04-18 09:46:56,134: Parsing adapters/common.sql
2018-04-18 09:46:56,158: Parsing adapters/postgres.sql
2018-04-18 09:46:56,166: Parsing adapters/redshift.sql
2018-04-18 09:46:56,196: Parsing etc/get_custom_schema.sql
2018-04-18 09:46:56,204: Parsing materializations/archive.sql
2018-04-18 09:46:56,241: Parsing materializations/bigquery.sql
2018-04-18 09:46:56,258: Parsing materializations/helpers.sql
2018-04-18 09:46:56,277: Parsing materializations/incremental.sql
2018-04-18 09:46:56,308: Parsing materializations/table.sql
2018-04-18 09:46:56,330: Parsing materializations/view.sql
2018-04-18 09:46:56,351: Parsing materializations/wrapper.sql
2018-04-18 09:46:56,361: Parsing schema_tests/accepted_values.sql
2018-04-18 09:46:56,368: Parsing schema_tests/not_null.sql
2018-04-18 09:46:56,372: Parsing schema_tests/relationships.sql
2018-04-18 09:46:56,379: Parsing schema_tests/unique.sql
2018-04-18 09:46:56,462: Parsing model.agency_data_pipeline.accounts_proc
2018-04-18 09:46:56,464: Parsing model.agency_data_pipeline.all_dates
2018-04-18 09:46:56,465: Parsing model.agency_data_pipeline.carts_proc
2018-04-18 09:46:56,466: Parsing model.agency_data_pipeline.clients_proc
2018-04-18 09:46:56,468: Parsing model.agency_data_pipeline.conversion_goals_proc
2018-04-18 09:46:56,470: Parsing model.agency_data_pipeline.mappings_ga_proc
2018-04-18 09:46:56,472: Acquiring new bigquery connection "master".
2018-04-18 09:46:56,472: Opening a new connection (0 currently allocated)
2018-04-18 09:46:56,476: Parsing model.agency_data_pipeline.monthend_dates
2018-04-18 09:46:56,478: Parsing model.agency_data_pipeline.adwords_ads
2018-04-18 09:46:56,480: Parsing model.agency_data_pipeline.adwords_campaigns
2018-04-18 09:46:56,482: Parsing model.agency_data_pipeline.adwords_conversions
2018-04-18 09:46:56,484: Parsing model.agency_data_pipeline.adwords_impression_share
2018-04-18 09:46:56,486: Parsing model.agency_data_pipeline.adwords_join
2018-04-18 09:46:56,489: Parsing model.agency_data_pipeline.adwords_stats
2018-04-18 09:46:56,491: Parsing model.agency_data_pipeline.adwords_urls
2018-04-18 09:46:56,493: Parsing model.agency_data_pipeline.bing_ads_ads
2018-04-18 09:46:56,496: Parsing model.agency_data_pipeline.bing_ads_conversions
2018-04-18 09:46:56,499: Parsing model.agency_data_pipeline.bing_ads_impression_share
2018-04-18 09:46:56,501: Parsing model.agency_data_pipeline.bing_ads_stats
2018-04-18 09:46:56,503: Parsing model.agency_data_pipeline.fb_adcreative
2018-04-18 09:46:56,509: Parsing model.agency_data_pipeline.fb_ads
2018-04-18 09:46:56,515: Parsing model.agency_data_pipeline.fb_ads_insights
2018-04-18 09:46:56,520: Parsing model.agency_data_pipeline.fb_ads_insights_conversions
2018-04-18 09:46:56,530: Parsing model.agency_data_pipeline.fb_ads_stats
2018-04-18 09:46:56,534: Parsing model.agency_data_pipeline.ga_conversions
2018-04-18 09:46:56,536: Parsing model.agency_data_pipeline.ga_traffic
2018-04-18 09:46:56,548: Parsing model.agency_data_pipeline.ga_transactions
2018-04-18 09:46:56,559: Parsing model.agency_data_pipeline.ga_mcf_proc
2018-04-18 09:46:56,561: Parsing model.agency_data_pipeline.ga_mcf_stats
2018-04-18 09:46:56,563: Parsing model.agency_data_pipeline.shopify_customers_proc
2018-04-18 09:46:56,569: Parsing model.agency_data_pipeline.shopify_orders_proc
2018-04-18 09:46:56,577: Parsing model.agency_data_pipeline.shopify_products_proc
2018-04-18 09:46:56,584: Parsing model.agency_data_pipeline.shopify_refunds_proc
2018-04-18 09:46:56,590: Parsing model.agency_data_pipeline.agg_campaign
2018-04-18 09:46:56,594: Parsing model.agency_data_pipeline.agg_customers_union
2018-04-18 09:46:56,595: Parsing model.agency_data_pipeline.agg_ga_campaign
2018-04-18 09:46:56,598: Parsing model.agency_data_pipeline.agg_ga_campaign_by_type
2018-04-18 09:46:56,601: Parsing model.agency_data_pipeline.agg_ga_transaction
2018-04-18 09:46:56,604: Parsing model.agency_data_pipeline.agg_ga_transaction_order_number
2018-04-18 09:46:56,608: Parsing model.agency_data_pipeline.agg_orders_union
2018-04-18 09:46:56,610: Parsing model.agency_data_pipeline.agg_platform_monthly
2018-04-18 09:46:56,612: Parsing model.agency_data_pipeline.agg_platforms_client
2018-04-18 09:46:56,614: Parsing model.agency_data_pipeline.agg_platforms_union
2018-04-18 09:46:56,617: Parsing model.agency_data_pipeline.agg_products
2018-04-18 09:46:56,618: Parsing model.agency_data_pipeline.agg_transaction
2018-04-18 09:46:56,621: Parsing model.agency_data_pipeline.agg_transaction_daily
2018-04-18 09:46:56,623: Parsing model.agency_data_pipeline.agg_transaction_line_item
2018-04-18 09:46:56,624: Parsing model.agency_data_pipeline.agg_transaction_line_item_type
2018-04-18 09:46:56,627: Parsing model.agency_data_pipeline.agg_transaction_order_number
2018-04-18 09:46:56,628: Parsing model.agency_data_pipeline.agg_transaction_product_type
2018-04-18 09:46:56,630: Parsing model.agency_data_pipeline.customers_by_transaction
2018-04-18 09:46:56,631: Parsing model.agency_data_pipeline.growth_customer_0_365
2018-04-18 09:46:56,634: Parsing model.agency_data_pipeline.growth_customer_0_365_segment
2018-04-18 09:46:56,636: Parsing model.agency_data_pipeline.growth_date_union
2018-04-18 09:46:56,640: Parsing model.agency_data_pipeline.growth_stats
2018-04-18 09:46:56,644: Parsing model.agency_data_pipeline.retention_0_365
2018-04-18 09:46:56,646: Parsing model.agency_data_pipeline.retention_0_365_new
2018-04-18 09:46:56,648: Parsing model.agency_data_pipeline.retention_0_365_reactivated
2018-04-18 09:46:56,651: Parsing model.agency_data_pipeline.retention_0_365_rebuy
2018-04-18 09:46:56,653: Parsing model.agency_data_pipeline.retention_365_730
2018-04-18 09:46:56,656: Parsing model.agency_data_pipeline.retention_730_plus
2018-04-18 09:46:56,658: Parsing model.agency_data_pipeline.retention_stats
2018-04-18 09:46:56,664: Parsing model.agency_data_pipeline.retention_stats_rebuy_rate
2018-04-18 09:46:56,666: Parsing model.agency_data_pipeline.retention_0_30
2018-04-18 09:46:56,670: Parsing model.agency_data_pipeline.retention_0_30_new
2018-04-18 09:46:56,676: Parsing model.agency_data_pipeline.retention_0_30_reactivated
2018-04-18 09:46:56,680: Parsing model.agency_data_pipeline.retention_0_30_rebuy
2018-04-18 09:46:56,682: Parsing model.agency_data_pipeline.retention_30_60
2018-04-18 09:46:56,684: Parsing model.agency_data_pipeline.retention_60_plus
2018-04-18 09:46:56,687: Parsing model.agency_data_pipeline.retention_stats_month
2018-04-18 09:46:56,692: Parsing model.agency_data_pipeline.retention_stats_rebuy_rate_month
2018-04-18 09:46:56,695: Parsing model.agency_data_pipeline.customers_first_purchase_proc
2018-04-18 09:46:56,696: Parsing model.agency_data_pipeline.customers_proc
2018-04-18 09:46:56,699: Parsing model.agency_data_pipeline.segment_list_customers
2018-04-18 09:46:56,701: Parsing model.agency_data_pipeline.segment_proc_customers
2018-04-18 09:46:56,704: Parsing model.agency_data_pipeline.segment_stats_customers
2018-04-18 09:46:56,706: Parsing model.agency_data_pipeline.segment_stats_customers_agg
2018-04-18 09:46:56,709: Parsing model.agency_data_pipeline.customers_first_purchase_product_type_proc
2018-04-18 09:46:56,711: Parsing model.agency_data_pipeline.customers_products_proc
2018-04-18 09:46:56,714: Parsing model.agency_data_pipeline.segment_list_customers_products
2018-04-18 09:46:56,716: Parsing model.agency_data_pipeline.segment_proc_customers_products
2018-04-18 09:46:56,718: Parsing model.agency_data_pipeline.segment_stats_customers_products
2018-04-18 09:46:56,721: Parsing model.agency_data_pipeline.segment_stats_customers_products_agg
2018-04-18 09:46:56,724: Parsing model.agency_data_pipeline.frequency_proc
2018-04-18 09:46:56,727: Parsing model.agency_data_pipeline.frequency_stats
2018-04-18 09:46:56,729: Parsing model.agency_data_pipeline.order_paths_agg
2018-04-18 09:46:56,731: Parsing model.agency_data_pipeline.order_paths_proc
2018-04-18 09:46:56,733: Parsing model.agency_data_pipeline.order_paths_stats
2018-04-18 09:46:56,735: Parsing model.agency_data_pipeline.products_proc
2018-04-18 09:46:56,738: Parsing model.agency_data_pipeline.segment_proc_sku
2018-04-18 09:46:56,741: Parsing model.agency_data_pipeline.segment_stats_category
2018-04-18 09:46:56,742: Parsing model.agency_data_pipeline.segment_stats_sku
2018-04-18 09:46:56,783: Found 91 models, 0 tests, 0 archives, 0 analyses, 46 macros, 0 operations
2018-04-18 09:46:56,844: 
2018-04-18 09:46:58,535: 09:46:58 | Concurrency: 4 threads (target='prod')
2018-04-18 09:46:58,536: 09:46:58 | 
2018-04-18 09:46:59,409: 09:46:59 | 1 of 91 START table model agency_data_pipeline.all_dates............. [RUN]
2018-04-18 09:46:59,410: Compiling model.agency_data_pipeline.all_dates
2018-04-18 09:46:59,409: 09:46:59 | 2 of 91 START table model agency_data_pipeline.ga_conversions........ [RUN]
2018-04-18 09:46:59,415: Writing injected SQL for node "model.agency_data_pipeline.all_dates"
2018-04-18 09:46:59,409: 09:46:59 | 3 of 91 START table model agency_data_pipeline.adwords_conversions... [RUN]
2018-04-18 09:46:59,415: Compiling model.agency_data_pipeline.ga_conversions
2018-04-18 09:46:59,410: 09:46:59 | 4 of 91 START table model agency_data_pipeline.monthend_dates........ [RUN]
2018-04-18 09:46:59,415: Compiling model.agency_data_pipeline.adwords_conversions
2018-04-18 09:46:59,420: Writing injected SQL for node "model.agency_data_pipeline.ga_conversions"
2018-04-18 09:46:59,420: Compiling model.agency_data_pipeline.monthend_dates
2018-04-18 09:46:59,426: Writing injected SQL for node "model.agency_data_pipeline.adwords_conversions"
2018-04-18 09:46:59,427: Acquiring new bigquery connection "all_dates".
2018-04-18 09:46:59,434: Writing injected SQL for node "model.agency_data_pipeline.monthend_dates"
2018-04-18 09:46:59,435: Acquiring new bigquery connection "ga_conversions".
2018-04-18 09:46:59,435: Opening a new connection (1 currently allocated)
2018-04-18 09:46:59,440: Acquiring new bigquery connection "monthend_dates".
2018-04-18 09:46:59,441: Opening a new connection (2 currently allocated)
2018-04-18 09:46:59,493: Acquiring new bigquery connection "adwords_conversions".
2018-04-18 09:46:59,545: Opening a new connection (3 currently allocated)
2018-04-18 09:46:59,553: Opening a new connection (4 currently allocated)
2018-04-18 09:47:00,874: Model SQL (all_dates):
SELECT 
date_in_range,
unix_date(date_in_range) unix_date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-04-18 09:47:00,936: Model SQL (ga_conversions):
select 
client,
client_name,
platform,
goal_name,
goal_type,
account,
time_of_entry
from  ( 

SELECT  
client,
client_name,
platform,
trim(goal_name) goal_name,
goal_type,
account,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform, goal_name ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.conversion_goals` 
WHERE platform = 'Google Analytics'

) 

WHERE lv = time_of_entry
2018-04-18 09:47:00,976: Model SQL (monthend_dates):
SELECT
date_in_range,
date_in_range_bom,
date_in_range_bom_mom,
unix_date_in_range,
unix_date_in_range_bom,
unix_date(date_in_range_bom_mom) unix_date_in_range_bom_mom,
yyyymm,
date_in_range_yoy,
unix_date(date_in_range_yoy) unix_date_in_range_yoy

FROM
(
	SELECT 
	date_in_range,
	date_in_range_bom,
	date_sub(date_in_range_bom, INTERVAL 1 MONTH) date_in_range_bom_mom,
  date_sub(date_in_range, INTERVAL 1 YEAR) date_in_range_yoy,
	unix_date_in_range,
	unix_date(date_in_range_bom) unix_date_in_range_bom,
	yyyymm,
	first_value(date_in_range) over (partition by yyyymm order by date_in_range desc) monthend_date_in_range
	FROM
	( 
		SELECT 
		date_in_range,
		date_trunc( date_in_range, MONTH) date_in_range_bom,
		unix_date(date_in_range) unix_date_in_range,
		format_date("%Y-%m", date_in_range) AS yyyymm
		FROM UNNEST(
		    GENERATE_DATE_ARRAY(DATE('2016-01-31'), CURRENT_DATE(), INTERVAL 1 DAY)
		) AS date_in_range
	)
)
where date_in_range = monthend_date_in_range
2018-04-18 09:47:01,038: Model SQL (adwords_conversions):
select 
client,
client_name,
platform,
goal_name,
goal_type,
account,
time_of_entry
from  ( 

SELECT  
client,
client_name,
platform,
trim(lower(goal_name)) goal_name,
goal_type,
account,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform, goal_name ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.conversion_goals` 
WHERE platform = 'Adwords'

) 

WHERE lv = time_of_entry
2018-04-18 09:47:01,966: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d959d68>]}
2018-04-18 09:47:02,082: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10dab6e48>]}
2018-04-18 09:47:02,198: 09:47:02 | 1 of 91 OK created table model agency_data_pipeline.all_dates........ [CREATE TABLE in 2.56s]
2018-04-18 09:47:02,199: 09:47:02 | 5 of 91 START table model agency_data_pipeline.clients_proc.......... [RUN]
2018-04-18 09:47:02,200: Compiling model.agency_data_pipeline.clients_proc
2018-04-18 09:47:02,214: Writing injected SQL for node "model.agency_data_pipeline.clients_proc"
2018-04-18 09:47:02,216: Acquiring new bigquery connection "clients_proc".
2018-04-18 09:47:02,217: Re-using an available connection from the pool.
2018-04-18 09:47:02,465: 09:47:02 | 4 of 91 OK created table model agency_data_pipeline.monthend_dates... [CREATE TABLE in 2.66s]
2018-04-18 09:47:02,465: 09:47:02 | 6 of 91 START table model agency_data_pipeline.conversion_goals_proc. [RUN]
2018-04-18 09:47:02,465: Compiling model.agency_data_pipeline.conversion_goals_proc
2018-04-18 09:47:02,470: Writing injected SQL for node "model.agency_data_pipeline.conversion_goals_proc"
2018-04-18 09:47:02,471: Acquiring new bigquery connection "conversion_goals_proc".
2018-04-18 09:47:02,471: Re-using an available connection from the pool.
2018-04-18 09:47:03,117: Model SQL (clients_proc):
select 
client,
client_name,
account,
platform
from  ( 

SELECT  
client,
client_name,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.accounts`
where client_name != ''
) 

WHERE lv = time_of_entry
2018-04-18 09:47:03,141: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a3b2710>]}
2018-04-18 09:47:03,244: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10dab65c0>]}
2018-04-18 09:47:03,333: Model SQL (conversion_goals_proc):
select 
client,
platform,
goal_name,
max(goal_type) goal_type,
account,
max(time_of_entry) time_of_entry
from  ( 

SELECT  
client,
platform,
trim(replace(replace(lower(goal_name),',',''),' ','')) goal_name,
goal_type,
account,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY platform ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.conversion_goals` 

) 

WHERE lv = time_of_entry
group by client, platform, account, goal_name
2018-04-18 09:47:03,405: 09:47:03 | 2 of 91 OK created table model agency_data_pipeline.ga_conversions... [CREATE TABLE in 3.73s]
2018-04-18 09:47:03,407: 09:47:03 | 7 of 91 START table model agency_data_pipeline.adwords_urls.......... [RUN]
2018-04-18 09:47:03,407: Compiling model.agency_data_pipeline.adwords_urls
2018-04-18 09:47:03,414: Writing injected SQL for node "model.agency_data_pipeline.adwords_urls"
2018-04-18 09:47:03,416: Acquiring new bigquery connection "adwords_urls".
2018-04-18 09:47:03,416: Re-using an available connection from the pool.
2018-04-18 09:47:03,663: 09:47:03 | 3 of 91 OK created table model agency_data_pipeline.adwords_conversions [CREATE TABLE in 3.83s]
2018-04-18 09:47:03,664: 09:47:03 | 8 of 91 START table model agency_data_pipeline.accounts_proc......... [RUN]
2018-04-18 09:47:03,664: Compiling model.agency_data_pipeline.accounts_proc
2018-04-18 09:47:03,668: Writing injected SQL for node "model.agency_data_pipeline.accounts_proc"
2018-04-18 09:47:03,669: Acquiring new bigquery connection "accounts_proc".
2018-04-18 09:47:03,669: Re-using an available connection from the pool.
2018-04-18 09:47:04,229: Model SQL (adwords_urls):
SELECT
campaignid,
lower(trim(regexp_replace(replace(replace(replace(replace(finalurl,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url

FROM (

SELECT  
campaignid,
finalurl,
first_value(finalurl) OVER (PARTITION BY campaignid ORDER BY day DESC) lv
FROM `growth-engines-pipeline.adwords_2.FINAL_URL_REPORT`
)

WHERE lv = finalurl
group by campaignid, url
order by campaignid asc
2018-04-18 09:47:04,332: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d959d68>]}
2018-04-18 09:47:04,377: Model SQL (accounts_proc):
select 
client,
account,
platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.accounts` 

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-04-18 09:47:05,012: 09:47:05 | 5 of 91 OK created table model agency_data_pipeline.clients_proc..... [CREATE TABLE in 2.13s]
2018-04-18 09:47:05,012: 09:47:05 | 9 of 91 START table model agency_data_pipeline.bing_ads_impression_share [RUN]
2018-04-18 09:47:05,013: Compiling model.agency_data_pipeline.bing_ads_impression_share
2018-04-18 09:47:05,022: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_impression_share"
2018-04-18 09:47:05,025: Acquiring new bigquery connection "bing_ads_impression_share".
2018-04-18 09:47:05,025: Re-using an available connection from the pool.
2018-04-18 09:47:05,550: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10dab3b00>]}
2018-04-18 09:47:05,814: 09:47:05 | 6 of 91 OK created table model agency_data_pipeline.conversion_goals_proc [CREATE TABLE in 3.08s]
2018-04-18 09:47:05,814: 09:47:05 | 10 of 91 START table model agency_data_pipeline.adwords_campaigns.... [RUN]
2018-04-18 09:47:05,814: Compiling model.agency_data_pipeline.adwords_campaigns
2018-04-18 09:47:05,824: Writing injected SQL for node "model.agency_data_pipeline.adwords_campaigns"
2018-04-18 09:47:05,826: Acquiring new bigquery connection "adwords_campaigns".
2018-04-18 09:47:05,826: Re-using an available connection from the pool.
2018-04-18 09:47:05,947: Model SQL (bing_ads_impression_share):
SELECT 
date, 
account,
channel,
platform,
sum(impressions) impressions,
sum(available_impressions) available_impressions
FROM

(

SELECT  
cast(gregoriandate as date) date,
replace(accountname,',','') account,  
'Paid' as channel,
'Bing Ads' as platform,
case when impressionsharepercent is null then 0 else impressions end as impressions,
cast(round(case when ( impressionsharepercent is not null and impressionsharepercent > 0 ) then (impressions*100)/impressionsharepercent else 0 end) as int64) as available_impressions,
_sdc_sequence,
first_value(_sdc_sequence) OVER (PARTITION BY campaignid, gregoriandate ORDER BY _sdc_sequence DESC) lv
FROM `growth-engines-pipeline.bing_ads.campaign_performance_report` 

)

where lv = _sdc_sequence
group by date, account, channel, platform
2018-04-18 09:47:06,539: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a3b2710>]}
2018-04-18 09:47:06,596: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10dab65c0>]}
2018-04-18 09:47:06,786: 09:47:06 | 7 of 91 OK created table model agency_data_pipeline.adwords_urls..... [CREATE TABLE in 3.13s]
2018-04-18 09:47:06,787: 09:47:06 | 11 of 91 START table model agency_data_pipeline.bing_ads_ads......... [RUN]
2018-04-18 09:47:06,788: Compiling model.agency_data_pipeline.bing_ads_ads
2018-04-18 09:47:06,801: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_ads"
2018-04-18 09:47:06,805: Acquiring new bigquery connection "bing_ads_ads".
2018-04-18 09:47:06,805: Re-using an available connection from the pool.
2018-04-18 09:47:07,106: 09:47:07 | 8 of 91 OK created table model agency_data_pipeline.accounts_proc.... [CREATE TABLE in 2.93s]
2018-04-18 09:47:07,106: 09:47:07 | 12 of 91 START table model agency_data_pipeline.carts_proc........... [RUN]
2018-04-18 09:47:07,107: Compiling model.agency_data_pipeline.carts_proc
2018-04-18 09:47:07,112: Writing injected SQL for node "model.agency_data_pipeline.carts_proc"
2018-04-18 09:47:07,113: Acquiring new bigquery connection "carts_proc".
2018-04-18 09:47:07,113: Re-using an available connection from the pool.
2018-04-18 09:47:07,273: Model SQL (adwords_campaigns):
select
day,
campaignid, 
campaign,
account, 
channel,
platform,
sum(cost) cost,
sum(impressions) impressions,
sum(clicks) clicks,
sum(impression_share_num) impression_share_num,
sum(impression_share_den) impression_share_den
from 
  ( 
	SELECT  
	day,
	campaignid,
	campaign,
	account as account,
	'Paid' as channel,
	'Adwords' as platform,
	cost/1000000 cost, 
	impressions as impressions, 
	clicks, 
	case when searchimprshare is not null then impressions end as impression_share_num,
	case when searchimprshare is not null then impressions/(searchimprshare/100) end as impression_share_den,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY campaignid, day ORDER BY _sdc_sequence DESC) lv
	FROM `growth-engines-pipeline.adwords_2.CAMPAIGN_PERFORMANCE_REPORT`
  )
where lv = _sdc_sequence
group by day, campaignid, account, channel, platform, campaign
2018-04-18 09:47:07,642: Model SQL (bing_ads_ads):
select
date, 
account, 
channel,
platform,
campaignid,
campaignname,
max(lower(trim(replace(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$','' ),'.html',''),'/'))) as url,
utm_campaign,
sum(cost) as cost,
sum(impressions) as impressions,
sum(clicks) as clicks,
sum(conversions) as conversions
from 
  ( 
SELECT  
cast(gregoriandate as date) date,
replace(accountname,',','') account,
'Paid' as channel,
'Bing Ads' as platform,
adid,
adtype,
campaignid, 
campaignname,
finalurl url,
case when regexp_contains(destinationurl, 'utm_campaign')
	then replace(lower(nullif(
  

    split(
        
  

    split(
        destinationurl,
        'utm_campaign='
        )[offset(1)]


,
        '&'
        )[offset(0)]


,'')),'+',' ') 
	else null end as utm_campaign,
spend cost, 
impressions, 
clicks, 
conversions,
_sdc_sequence,
first_value(_sdc_sequence) OVER (PARTITION BY adid, gregoriandate ORDER BY _sdc_sequence DESC) lv
FROM `growth-engines-pipeline.bing_ads.ad_performance_report` 
  )

where lv = _sdc_sequence
group by date, account, channel, platform, campaignid, campaignname, utm_campaign
2018-04-18 09:47:07,874: Model SQL (carts_proc):
select 
client,
client_name,
account,
platform
from  ( 

SELECT  
client,
client_name,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.accounts`
WHERE platform in ('Shopify', 'Custom cart')

) 

WHERE lv = time_of_entry
2018-04-18 09:47:08,151: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d959d68>]}
2018-04-18 09:47:08,416: 09:47:08 | 9 of 91 OK created table model agency_data_pipeline.bing_ads_impression_share [CREATE TABLE in 3.14s]
2018-04-18 09:47:10,047: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10dab65c0>]}
2018-04-18 09:47:10,338: 09:47:10 | 12 of 91 OK created table model agency_data_pipeline.carts_proc...... [CREATE TABLE in 2.94s]
2018-04-18 09:47:10,968: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a3b2710>]}
2018-04-18 09:47:11,231: 09:47:11 | 11 of 91 OK created table model agency_data_pipeline.bing_ads_ads.... [CREATE TABLE in 4.18s]
2018-04-18 09:47:12,801: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10dab3b00>]}
2018-04-18 09:47:13,098: 09:47:13 | 10 of 91 OK created table model agency_data_pipeline.adwords_campaigns [CREATE TABLE in 6.99s]
2018-04-18 09:47:13,099: 09:47:13 | 13 of 91 START table model agency_data_pipeline.fb_adcreative........ [RUN]
2018-04-18 09:47:13,100: Compiling model.agency_data_pipeline.fb_adcreative
2018-04-18 09:47:13,100: 09:47:13 | 14 of 91 START table model agency_data_pipeline.ga_mcf_proc.......... [RUN]
2018-04-18 09:47:13,112: Compiling model.agency_data_pipeline.ga_mcf_proc
2018-04-18 09:47:13,113: Acquiring new bigquery connection "fb_adcreative".
2018-04-18 09:47:13,100: 09:47:13 | 15 of 91 START table model agency_data_pipeline.adwords_ads.......... [RUN]
2018-04-18 09:47:13,119: Re-using an available connection from the pool.
2018-04-18 09:47:13,100: 09:47:13 | 16 of 91 START table model agency_data_pipeline.fb_ads_insights_conversions [RUN]
2018-04-18 09:47:13,120: Writing injected SQL for node "model.agency_data_pipeline.ga_mcf_proc"
2018-04-18 09:47:13,120: Compiling model.agency_data_pipeline.adwords_ads
2018-04-18 09:47:13,120: Fetching data for query fb_adcreative:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 09:47:13,120: Compiling model.agency_data_pipeline.fb_ads_insights_conversions
2018-04-18 09:47:13,126: Writing injected SQL for node "model.agency_data_pipeline.adwords_ads"
2018-04-18 09:47:13,135: Acquiring new bigquery connection "fb_ads_insights_conversions".
2018-04-18 09:47:13,139: Re-using an available connection from the pool.
2018-04-18 09:47:13,139: Fetching data for query fb_ads_insights_conversions:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 09:47:13,142: Acquiring new bigquery connection "adwords_ads".
2018-04-18 09:47:13,143: Re-using an available connection from the pool.
2018-04-18 09:47:13,148: Acquiring new bigquery connection "ga_mcf_proc".
2018-04-18 09:47:13,150: Re-using an available connection from the pool.
2018-04-18 09:47:14,033: Model SQL (adwords_ads):
SELECT  
day,
campaignid,
a.account as account,
utm_campaign,
sum( case when b.goal_type = 'Transaction' then conversions else 0 end ) as transactions
FROM (

	SELECT  
	day,
	adid,
	campaignid,
	account,
	lower(conversionname) conversionname,
	conversions,
	lower(campaign) utm_campaign,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY campaignid, day ORDER BY _sdc_sequence DESC) lv
	FROM
	`growth-engines-pipeline.adwords_2.AD_PERFORMANCE_REPORT`

) a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_conversions` b
ON ( a.conversionname = b.goal_name
	AND a.account = b.account )
WHERE lv = _sdc_sequence
group by day, campaignid, account, utm_campaign
2018-04-18 09:47:14,103: Model SQL (ga_mcf_proc):
SELECT 
date,
account,
'Google Analytics' as lookup_platform,
source_medium_path,
trim(lower(split(split(source_medium_path,'->')[SAFE_ORDINAL(1)],'/')[SAFE_ORDINAL(1)])) as source,
trim(lower(split(split(source_medium_path,'->')[SAFE_ORDINAL(1)],'/')[SAFE_ORDINAL(2)])) as medium,
first_interaction_campaign campaign,
cast(regexp_replace(transaction_id, r'#', '') as int64) transactionid,
max(first_interaction_conversions) transactions,
max(first_interaction_conversion_value) revenue
FROM `growth-engines-pipeline.agency_data_pipeline.ga_mcf`
where account in (select account from `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc` where platform = 'Google Analytics')
group by date, account, source, medium, campaign, source_medium_path, lookup_platform, transactionid
2018-04-18 09:47:14,460: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_insights_conversions"
2018-04-18 09:47:14,502: Writing injected SQL for node "model.agency_data_pipeline.fb_adcreative"
2018-04-18 09:47:15,743: Model SQL (fb_ads_insights_conversions):




with fb_ads_insights_conversions as (

	    
		   	SELECT 
			date_start,
			campaign_id,
			campaign_name,
			ad_id,
			account_name,
			spend,
			reach,
			inline_link_clicks,
			_sdc_sequence,
			action_type,
			value
			FROM `growth-engines-pipeline.fb_ads_luca_danni.ads_insights`
			cross join unnest(actions)
		    
	   

)

SELECT * 
FROM 
	(
    SELECT
    date_start date,
    campaign_id,
    campaign_name campaign,
    ad_id,
    account_name account,
    action_type,
    value conversions,
    first_value(_sdc_sequence) OVER (PARTITION BY ad_id, date_start ORDER BY _sdc_sequence DESC) lv,
    _sdc_sequence
    FROM fb_ads_insights_conversions
   	)
where lv = _sdc_sequence
and action_type like '%purchase%'


2018-04-18 09:47:15,801: Model SQL (fb_adcreative):




with fb_adcreative as (


	    
		   	SELECT 
			id,
			object_url,
			url_tags,
			_sdc_sequence
			FROM `growth-engines-pipeline.fb_ads_luca_danni.adcreative`
		    
	   
)

select creative_id, max(url) url
from (
  select
  id creative_id,
  lower(trim(regexp_replace(replace(replace(replace(replace(object_url,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
  first_value(_sdc_sequence) OVER (PARTITION BY id ORDER BY _sdc_sequence DESC) lv,
  _sdc_sequence
  from fb_adcreative
  )
where lv = _sdc_sequence
group by creative_id


2018-04-18 09:47:16,418: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10da3f978>]}
2018-04-18 09:47:16,656: 09:47:16 | 15 of 91 OK created table model agency_data_pipeline.adwords_ads..... [CREATE TABLE in 3.30s]
2018-04-18 09:47:16,656: 09:47:16 | 17 of 91 START table model agency_data_pipeline.shopify_refunds_proc. [RUN]
2018-04-18 09:47:16,657: Compiling model.agency_data_pipeline.shopify_refunds_proc
2018-04-18 09:47:16,665: Acquiring new bigquery connection "shopify_refunds_proc".
2018-04-18 09:47:16,665: Re-using an available connection from the pool.
2018-04-18 09:47:16,665: Fetching data for query shopify_refunds_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 09:47:18,020: Writing injected SQL for node "model.agency_data_pipeline.shopify_refunds_proc"
2018-04-18 09:47:18,139: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d9652b0>]}
2018-04-18 09:47:18,401: 09:47:18 | 13 of 91 OK created table model agency_data_pipeline.fb_adcreative... [CREATE TABLE in 5.04s]
2018-04-18 09:47:18,402: 09:47:18 | 18 of 91 START table model agency_data_pipeline.bing_ads_conversions. [RUN]
2018-04-18 09:47:18,402: Compiling model.agency_data_pipeline.bing_ads_conversions
2018-04-18 09:47:18,413: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_conversions"
2018-04-18 09:47:18,414: Acquiring new bigquery connection "bing_ads_conversions".
2018-04-18 09:47:18,414: Re-using an available connection from the pool.
2018-04-18 09:47:18,816: Model SQL (shopify_refunds_proc):




with refunds as (

	
	SELECT
	order_number,
	checkout_id,
	financial_status,
	line_item_id,
	quantity,
	subtotal,
	line_item.variant_id variant_id,
	line_item.id refund_id,
 	_sdc_sequence
	FROM `growth-engines-pipeline.shopify_lucadanni.orders` 
	cross join unnest(refunds), unnest(refund_line_items)
  	where financial_status like '%refund%'
	
	

)

SELECT * 
FROM 
	(
    SELECT
	order_number,
	checkout_id,
	financial_status,
	line_item_id,
	quantity,
	subtotal refund_amount,
	variant_id,
	refund_id,
 	_sdc_sequence,
    first_value(_sdc_sequence) OVER (PARTITION BY order_number, line_item_id ORDER BY _sdc_sequence DESC) lv
    FROM refunds
   	) 
WHERE lv = _sdc_sequence


2018-04-18 09:47:19,155: Model SQL (bing_ads_conversions):
SELECT
date, 
a.account account, 
a.channel channel,
a.platform platform,
campaignid,
campaignname,
sum( case when b.goal_type = 'Transactions' then conversions else 0 end ) as transactions
FROM

  ( 
SELECT  
cast(gregoriandate as date) date,
replace(accountname,',','') account,
'Paid' as channel,
'Bing Ads' as platform,
trim(replace(replace(lower(goal),',',''),' ','')) goal,
goalid,
campaignid,
campaignname,
conversions,
_sdc_sequence,
first_value(_sdc_sequence) OVER (PARTITION BY campaignid, goalid, gregoriandate ORDER BY _sdc_sequence DESC) lv
FROM `growth-engines-pipeline.bing_ads.goals_and_funnels_report` 

  ) a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`conversion_goals_proc` b
ON (
	a.account = b.account AND
	a.platform = b.platform AND
	a.goal = b.goal_name
)
where a.lv = a._sdc_sequence
group by date, account, channel, platform, campaignid, campaignname
2018-04-18 09:47:19,696: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ac9e940>]}
2018-04-18 09:47:19,946: 09:47:19 | 14 of 91 OK created table model agency_data_pipeline.ga_mcf_proc..... [CREATE TABLE in 6.58s]
2018-04-18 09:47:19,947: 09:47:19 | 19 of 91 START table model agency_data_pipeline.mappings_ga_proc..... [RUN]
2018-04-18 09:47:19,947: Compiling model.agency_data_pipeline.mappings_ga_proc
2018-04-18 09:47:19,954: Writing injected SQL for node "model.agency_data_pipeline.mappings_ga_proc"
2018-04-18 09:47:19,956: Acquiring new bigquery connection "mappings_ga_proc".
2018-04-18 09:47:19,956: Re-using an available connection from the pool.
2018-04-18 09:47:20,197: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ac5cdd8>]}
2018-04-18 09:47:20,461: 09:47:20 | 16 of 91 OK created table model agency_data_pipeline.fb_ads_insights_conversions [CREATE TABLE in 7.08s]
2018-04-18 09:47:20,462: 09:47:20 | 20 of 91 START table model agency_data_pipeline.fb_ads_insights...... [RUN]
2018-04-18 09:47:20,462: Compiling model.agency_data_pipeline.fb_ads_insights
2018-04-18 09:47:20,478: Acquiring new bigquery connection "fb_ads_insights".
2018-04-18 09:47:20,478: Re-using an available connection from the pool.
2018-04-18 09:47:20,478: Fetching data for query fb_ads_insights:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 09:47:20,856: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_insights"
2018-04-18 09:47:20,969: Model SQL (mappings_ga_proc):
select 
client,
account,
client_name,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
account,
client_name,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.mappings_ga` 

) 

WHERE lv = time_of_entry
and client in (select client from `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc` )
group by client, account, client_name, source, medium, platform_n, channel_n, time_of_entry
2018-04-18 09:47:21,050: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10da3f978>]}
2018-04-18 09:47:21,320: 09:47:21 | 17 of 91 OK created table model agency_data_pipeline.shopify_refunds_proc [CREATE TABLE in 4.39s]
2018-04-18 09:47:21,525: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d9652b0>]}
2018-04-18 09:47:21,775: Model SQL (fb_ads_insights):




with fb_ads_insights as (

	    
		   	SELECT 
			date_start,
			campaign_id,
			campaign_name,
			ad_id,
			account_name,
			spend,
			reach,
			inline_link_clicks,
			_sdc_sequence,
			first_value(_sdc_sequence) OVER (PARTITION BY date_start, ad_id, campaign_id ORDER BY _sdc_sequence DESC) lv
			FROM `growth-engines-pipeline.fb_ads_luca_danni.ads_insights`
		    
	   

)

select
date_start date,
campaign_id,
campaign_name campaign,
ad_id,
account_name account,
max(spend) cost,
max(reach) impressions,
max(inline_link_clicks) clicks
from fb_ads_insights
where lv = _sdc_sequence
group by date, campaign_id, ad_id, account, campaign


2018-04-18 09:47:21,785: 09:47:21 | 18 of 91 OK created table model agency_data_pipeline.bing_ads_conversions [CREATE TABLE in 3.12s]
2018-04-18 09:47:25,616: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ac29fd0>]}
2018-04-18 09:47:25,660: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ac35fd0>]}
2018-04-18 09:47:25,934: 09:47:25 | 20 of 91 OK created table model agency_data_pipeline.fb_ads_insights. [CREATE TABLE in 5.15s]
2018-04-18 09:47:26,197: 09:47:26 | 19 of 91 OK created table model agency_data_pipeline.mappings_ga_proc [CREATE TABLE in 5.71s]
2018-04-18 09:47:26,198: 09:47:26 | 21 of 91 START table model agency_data_pipeline.fb_ads............... [RUN]
2018-04-18 09:47:26,198: Compiling model.agency_data_pipeline.fb_ads
2018-04-18 09:47:26,198: 09:47:26 | 22 of 91 START table model agency_data_pipeline.shopify_customers_proc [RUN]
2018-04-18 09:47:26,209: Compiling model.agency_data_pipeline.shopify_customers_proc
2018-04-18 09:47:26,210: Acquiring new bigquery connection "fb_ads".
2018-04-18 09:47:26,219: Acquiring new bigquery connection "shopify_customers_proc".
2018-04-18 09:47:26,219: Re-using an available connection from the pool.
2018-04-18 09:47:26,219: Fetching data for query fb_ads:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 09:47:26,219: Re-using an available connection from the pool.
2018-04-18 09:47:26,223: Fetching data for query shopify_customers_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 09:47:26,688: Writing injected SQL for node "model.agency_data_pipeline.fb_ads"
2018-04-18 09:47:26,702: Writing injected SQL for node "model.agency_data_pipeline.shopify_customers_proc"
2018-04-18 09:47:27,683: Model SQL (shopify_customers_proc):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc`





with customers as (

	
	SELECT
	'lucadanni' client_name,
	'Shopify' as lookup_platform,
	cast(created_at as date) created_at,
	id,
	first_name,
	last_name,
	email,
	_sdc_sequence,
	first_value(_sdc_sequence) over (partition by id, _sdc_sequence order by _sdc_sequence desc) lv
	FROM `growth-engines-pipeline.shopify_lucadanni.customers` 
	
	

)

SELECT
account,
client,
platform,
id,
min(created_at) created_at,
max(first_name) first_name,
max(last_name) last_name,
max(email) email
FROM (
	SELECT
	b.account,
	b.client,
	b.platform,
	created_at,
	id,
	first_name,
	last_name,
	email
	FROM customers a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
	ON ( a.client_name = b.client_name
	  AND a.lookup_platform = b.platform )
	where a.lv = a._sdc_sequence
)
group by account, client, platform, id

2018-04-18 09:47:28,070: Model SQL (fb_ads):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`fb_adcreative`





with fb_ads as (

	    
		   	SELECT 
			id ad_id,
			creative.creative_id creative_id,
			_sdc_sequence
			FROM `growth-engines-pipeline.fb_ads_luca_danni.ads`
		     
	   

)

SELECT
a.ad_id,
b.creative_id,
b.url
FROM (
    SELECT
    ad_id,
    creative_id,
    first_value(_sdc_sequence) OVER (PARTITION BY ad_id ORDER BY _sdc_sequence DESC) lv,
    _sdc_sequence
    FROM fb_ads
    ) a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`fb_adcreative` b
ON (
	a.creative_id = b.creative_id 
)
WHERE a.lv = a._sdc_sequence


2018-04-18 09:47:30,274: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10da56b38>]}
2018-04-18 09:47:30,934: 09:47:30 | 21 of 91 OK created table model agency_data_pipeline.fb_ads.......... [CREATE TABLE in 4.07s]
2018-04-18 09:47:33,245: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10acab320>]}
2018-04-18 09:47:33,503: 09:47:33 | 22 of 91 OK created table model agency_data_pipeline.shopify_customers_proc [CREATE TABLE in 7.04s]
2018-04-18 09:47:33,504: 09:47:33 | 23 of 91 START table model agency_data_pipeline.shopify_orders_proc.. [RUN]
2018-04-18 09:47:33,504: Compiling model.agency_data_pipeline.shopify_orders_proc
2018-04-18 09:47:33,504: 09:47:33 | 24 of 91 START table model agency_data_pipeline.bing_ads_stats....... [RUN]
2018-04-18 09:47:33,519: Compiling model.agency_data_pipeline.bing_ads_stats
2018-04-18 09:47:33,504: 09:47:33 | 25 of 91 START table model agency_data_pipeline.ga_mcf_stats......... [RUN]
2018-04-18 09:47:33,519: Acquiring new bigquery connection "shopify_orders_proc".
2018-04-18 09:47:33,524: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_stats"
2018-04-18 09:47:33,504: 09:47:33 | 26 of 91 START table model agency_data_pipeline.agg_customers_union.. [RUN]
2018-04-18 09:47:33,525: Compiling model.agency_data_pipeline.ga_mcf_stats
2018-04-18 09:47:33,525: Re-using an available connection from the pool.
2018-04-18 09:47:33,526: Compiling model.agency_data_pipeline.agg_customers_union
2018-04-18 09:47:33,533: Fetching data for query shopify_orders_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 09:47:33,533: Writing injected SQL for node "model.agency_data_pipeline.ga_mcf_stats"
2018-04-18 09:47:33,553: Acquiring new bigquery connection "ga_mcf_stats".
2018-04-18 09:47:33,554: Re-using an available connection from the pool.
2018-04-18 09:47:33,544: Writing injected SQL for node "model.agency_data_pipeline.agg_customers_union"
2018-04-18 09:47:33,547: Acquiring new bigquery connection "bing_ads_stats".
2018-04-18 09:47:33,561: Re-using an available connection from the pool.
2018-04-18 09:47:33,570: Acquiring new bigquery connection "agg_customers_union".
2018-04-18 09:47:33,571: Re-using an available connection from the pool.
2018-04-18 09:47:33,986: Writing injected SQL for node "model.agency_data_pipeline.shopify_orders_proc"
2018-04-18 09:47:34,462: Model SQL (bing_ads_stats):
select
a.date, 
a.account, 
a.channel,
a.platform,
url,
a.campaignname campaign,
utm_campaign,
cost,
clicks,
impressions,
transactions
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`bing_ads_ads` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`bing_ads_conversions` b
ON (
	a.date = b.date AND
	a.account = b.account AND
	a.campaignid = b.campaignid

)
2018-04-18 09:47:34,499: Model SQL (agg_customers_union):
SELECT *
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`shopify_customers_proc`
2018-04-18 09:47:34,528: Model SQL (ga_mcf_stats):
SELECT  
date,
a.account account,
b.client client,
case when c.platform is null then "Unmapped" else c.platform end as platform,
case when c.channel is null then "Unmapped" else c.channel end as channel,
lower(a.source) source,
lower(a.medium) medium,
lower(campaign) campaign,
transactionid,
sum(transactions) first_touch_transactions,
sum(revenue) first_touch_revenue
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`ga_mcf_proc` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc` b 
ON ( a.account = b.account and
	a.lookup_platform = b.platform )
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc` c
ON ( lower(a.source) = c.source
  AND lower(a.medium) = c.medium 
  and a.account = c.account )
group by date, account, client, source, medium, campaign, platform, channel, transactionid
2018-04-18 09:47:34,989: Model SQL (shopify_orders_proc):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc`, `growth-engines-pipeline`.`agency_data_pipeline`.`shopify_refunds_proc`





with orders as (

	
	SELECT
	'lucadanni' client_name,
	'Shopify' as lookup_platform,
	created_at,
	order_number,
	quantity,
	cast(pre_tax_price as float64) price, 
	total_line_items_price total_order_price_undiscounted,
	total_discounts,
	cast(discounted_price as float64) total_order_shipping_price,
	total_price_usd total_order_price_incl_shipping,
	checkout_id,
	product_id, 
	landing_site,
	sku, 
	variant_title, 
	variant_id,
	_id line_item_id,
	customer.id customer_id,
	customer.orders_count orders_count,
	customer.created_at customer_created_at,
	customer.last_order_id last_order_id,
	financial_status,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY order_number, _id ORDER BY _sdc_sequence DESC) lv
	FROM `growth-engines-pipeline.shopify_lucadanni.orders` 
	cross join unnest(line_items), unnest(shipping_lines)
	where source_name != 'shopify_draft_order'
	
	

)

SELECT
b.account,
b.client,
b.platform,
created_at,
a.order_number,
a.quantity,
c.quantity refund_quantity,
case when c.quantity is not null then a.quantity - c.quantity else a.quantity end as final_quantity,
price, 
total_order_price_undiscounted,
total_discounts,
total_order_shipping_price,
total_order_price_incl_shipping,
refund_amount,
case when refund_amount is not null then price - refund_amount else price end as final_price,
a.checkout_id,
a.product_id, 
landing_site,
sku, 
variant_title, 
a.variant_id,
a.line_item_id,	
customer_id,
orders_count,
customer_created_at,
last_order_id,
a.financial_status
FROM orders a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
ON ( a.client_name = b.client_name
  AND a.lookup_platform = b.platform )
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`shopify_refunds_proc` c
ON ( a.order_number = c.order_number
	AND a.line_item_id = c.line_item_id )   	
where a.lv = a._sdc_sequence


2018-04-18 09:47:36,668: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10da56b38>]}
2018-04-18 09:47:36,937: 09:47:36 | 24 of 91 OK created table model agency_data_pipeline.bing_ads_stats.. [CREATE TABLE in 3.15s]
2018-04-18 09:47:36,937: 09:47:36 | 27 of 91 START table model agency_data_pipeline.shopify_products_proc [RUN]
2018-04-18 09:47:36,937: Compiling model.agency_data_pipeline.shopify_products_proc
2018-04-18 09:47:36,946: Acquiring new bigquery connection "shopify_products_proc".
2018-04-18 09:47:36,946: Re-using an available connection from the pool.
2018-04-18 09:47:36,946: Fetching data for query shopify_products_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 09:47:37,323: Writing injected SQL for node "model.agency_data_pipeline.shopify_products_proc"
2018-04-18 09:47:37,817: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d9f0da0>]}
2018-04-18 09:47:38,049: Model SQL (shopify_products_proc):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc`, `growth-engines-pipeline`.`agency_data_pipeline`.`shopify_refunds_proc`





with products as (

	
	SELECT
	'lucadanni' client_name,
	'Shopify' as lookup_platform,
	product_type,
	product_id,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY product_id ORDER BY _sdc_sequence DESC) lv
	FROM `growth-engines-pipeline.shopify_lucadanni.products` 
	cross join unnest(variants)
	
	

)

SELECT
b.account,
b.client,
b.platform,
max(product_type) product_type,
product_id
FROM products a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
ON ( a.client_name = b.client_name
  AND a.lookup_platform = b.platform )
where a.lv = a._sdc_sequence
group by product_id, account, client, platform


2018-04-18 09:47:38,066: 09:47:38 | 26 of 91 OK created table model agency_data_pipeline.agg_customers_union [CREATE TABLE in 4.29s]
2018-04-18 09:47:38,945: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ac15748>]}
2018-04-18 09:47:39,403: 09:47:39 | 25 of 91 OK created table model agency_data_pipeline.ga_mcf_stats.... [CREATE TABLE in 5.42s]
2018-04-18 09:47:40,421: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ac5c588>]}
2018-04-18 09:47:40,685: 09:47:40 | 27 of 91 OK created table model agency_data_pipeline.shopify_products_proc [CREATE TABLE in 3.48s]
2018-04-18 09:47:43,061: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ac15668>]}
2018-04-18 09:47:43,735: 09:47:43 | 23 of 91 OK created table model agency_data_pipeline.shopify_orders_proc [CREATE TABLE in 9.56s]
2018-04-18 09:47:43,735: 09:47:43 | 28 of 91 START table model agency_data_pipeline.agg_orders_union..... [RUN]
2018-04-18 09:47:43,735: 09:47:43 | 29 of 91 START table model agency_data_pipeline.ga_traffic........... [RUN]
2018-04-18 09:47:43,736: Compiling model.agency_data_pipeline.agg_orders_union
2018-04-18 09:47:43,735: 09:47:43 | 30 of 91 START table model agency_data_pipeline.ga_transactions...... [RUN]
2018-04-18 09:47:43,736: 09:47:43 | 31 of 91 START table model agency_data_pipeline.agg_products......... [RUN]
2018-04-18 09:47:43,736: Compiling model.agency_data_pipeline.ga_traffic
2018-04-18 09:47:43,741: Writing injected SQL for node "model.agency_data_pipeline.agg_orders_union"
2018-04-18 09:47:43,741: Compiling model.agency_data_pipeline.ga_transactions
2018-04-18 09:47:43,741: Compiling model.agency_data_pipeline.agg_products
2018-04-18 09:47:43,749: Acquiring new bigquery connection "agg_orders_union".
2018-04-18 09:47:43,782: Re-using an available connection from the pool.
2018-04-18 09:47:43,760: Acquiring new bigquery connection "ga_traffic".
2018-04-18 09:47:43,791: Writing injected SQL for node "model.agency_data_pipeline.agg_products"
2018-04-18 09:47:43,809: Acquiring new bigquery connection "ga_transactions".
2018-04-18 09:47:43,813: Re-using an available connection from the pool.
2018-04-18 09:47:43,817: Fetching data for query ga_traffic:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'GA Traffic'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 09:47:43,816: Acquiring new bigquery connection "agg_products".
2018-04-18 09:47:43,821: Re-using an available connection from the pool.
2018-04-18 09:47:43,821: Fetching data for query ga_transactions:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Google Analytics'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 09:47:43,822: Re-using an available connection from the pool.
2018-04-18 09:47:44,589: Model SQL (agg_products):
SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`shopify_products_proc`
2018-04-18 09:47:44,680: Model SQL (agg_orders_union):
SELECT
account,
client,
platform,
created_at,
order_number,
quantity,
refund_quantity,
final_quantity,
price, 
total_order_price_undiscounted,
total_discounts,
total_order_shipping_price,
total_order_price_incl_shipping,
refund_amount,
final_price,
checkout_id,
product_id, 
landing_site,
sku, 
variant_title, 
variant_id,
line_item_id,	
customer_id,
orders_count,
customer_created_at,
last_order_id,
financial_status
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`shopify_orders_proc`
2018-04-18 09:47:45,082: Fetching data for query ga_traffic:


        select
            goal_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_conversions`

        
        ##where 1 = 1
        where goal_type = 'Conversion'
        
        
        
        ##and 2 = 2
        and client_name = 'lucadanni'
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 09:47:45,195: Fetching data for query ga_transactions:


        select
            goal_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_conversions`

        
        ##where 1 = 1
        where goal_type = 'Conversion'
        
        
        
        ##and 2 = 2
        and client_name = 'lucadanni'
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 09:47:45,703: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10da567b8>]}
2018-04-18 09:47:45,966: 09:47:45 | 31 of 91 OK created table model agency_data_pipeline.agg_products.... [CREATE TABLE in 1.96s]
2018-04-18 09:47:45,966: 09:47:45 | 32 of 91 START table model agency_data_pipeline.adwords_join......... [RUN]
2018-04-18 09:47:45,966: Compiling model.agency_data_pipeline.adwords_join
2018-04-18 09:47:45,974: Writing injected SQL for node "model.agency_data_pipeline.adwords_join"
2018-04-18 09:47:45,975: Acquiring new bigquery connection "adwords_join".
2018-04-18 09:47:45,975: Re-using an available connection from the pool.
2018-04-18 09:47:46,191: Writing injected SQL for node "model.agency_data_pipeline.ga_traffic"
2018-04-18 09:47:46,765: Writing injected SQL for node "model.agency_data_pipeline.ga_transactions"
2018-04-18 09:47:47,322: Model SQL (ga_traffic):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc`, `growth-engines-pipeline`.`agency_data_pipeline`.`ga_conversions`


##`growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` 



with ga_report as (

	    

	    	
	    	
		   	SELECT
		   	'lucadanni' as client_name,
		   	'GA Traffic' as lookup_platform,
			lower(trim(regexp_replace(replace(replace(replace(replace(CONCAT(hostname,landingpagepath),'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
			date,
			lower(source) source,
			lower(medium) medium,
			lower(campaign) campaign,
			sessions,
			## goal completion columns
							
				goalcompletionsall as goal_completions,		
			
			_sdc_sequence,
			first_value(_sdc_sequence) OVER (PARTITION BY hostname, landingpagepath, date, source, medium, campaign ORDER BY _sdc_sequence DESC) lv
			FROM `growth-engines-pipeline.ga_lucadanni_traffic.report` 

		    
	   

)


SELECT  
cast(date as date) date,
b.account,
b.client client,
c.source source,
c.medium medium,
a.campaign campaign,
concat(a.source, ' / ', a.medium) source_medium,  
case when c.platform is null then "Unmapped" else c.platform end as platform,
case when c.channel is null then "Unmapped" else c.channel end as channel,
regexp_replace(url, r'offers.|offer.|get.|info.|pos.|go.|join.|pages.','') url,
max(sessions) sessions,
max(goal_completions) goal_completions
FROM ga_report a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
ON ( a.client_name = b.client_name 
	AND a.lookup_platform = b.platform )
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc` c
ON ( a.source = c.source
  AND a.medium = c.medium 
  AND a.client_name = c.client_name )
GROUP BY date, account, client, source, medium, campaign, source_medium, platform, channel, url


2018-04-18 09:47:47,984: Model SQL (ga_transactions):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc`, `growth-engines-pipeline`.`agency_data_pipeline`.`ga_conversions`


##`growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` 



with ga_report as (

	    

	    	
	    	
		   	SELECT
		   	'lucadanni' as client_name,
		   	'Google Analytics' as lookup_platform,
			lower(trim(regexp_replace(replace(replace(replace(replace(CONCAT(hostname,landingpagepath),'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
			date,
			lower(source) source,
			lower(medium) medium,
			lower(campaign) campaign,
			cast(regexp_replace(transactionid, r'#', '') as int64) transactionid,
			transactions last_touch_transactions,
			(transactionrevenue - transactionshipping - transactiontax) as last_touch_revenue,
			transactionshipping,
			transactiontax,
			_sdc_sequence,
			first_value(_sdc_sequence) OVER (PARTITION BY hostname, landingpagepath, date, source, medium, transactionid ORDER BY _sdc_sequence DESC) lv
			FROM `growth-engines-pipeline.ga_lucadanni.report` 

		    
	   

)


SELECT  
cast(date as date) date,
b.account,
b.client client,
c.source source,
c.medium medium,
a.campaign campaign,
concat(a.source, ' / ', a.medium) source_medium,  
case when c.platform is null then "Unmapped" else c.platform end as platform,
case when c.channel is null then "Unmapped" else c.channel end as channel,
regexp_replace(url, r'offers.|offer.|get.|info.|pos.|go.|join.|pages.','') url,
transactionid,
max(last_touch_transactions) last_touch_transactions,
max(last_touch_revenue) last_touch_revenue,
max(transactionshipping) last_touch_shipping,
max(transactiontax) last_touch_tax
FROM ga_report a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
ON ( a.client_name = b.client_name 
	AND a.lookup_platform = b.platform )
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc` c
ON ( a.source = c.source
  AND a.medium = c.medium 
  AND a.client_name = c.client_name )
GROUP BY date, account, client, source, medium, campaign, source_medium, platform, channel, url, transactionid


2018-04-18 09:47:48,497: Model SQL (adwords_join):
select
a.day,
a.campaignid, 
a.campaign,
a.account, 
channel,
platform,
url,
utm_campaign,
cost,
impressions,
clicks,
impression_share_num,
impression_share_den,
transactions
FROM ( 
	
	select
	day,
	a.campaign,
	a.campaignid, 
	account, 
	channel,
	platform,
	url,
	cost,
	impressions,
	clicks,
	impression_share_num,
	impression_share_den
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_campaigns` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_urls` b
	ON a.campaignid = b.campaignid

) a 
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_ads` b
ON ( a.campaignid = b.campaignid
	and a.day = b.day )
2018-04-18 09:47:51,522: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ac29fd0>]}
2018-04-18 09:47:51,908: 09:47:51 | 28 of 91 OK created table model agency_data_pipeline.agg_orders_union [CREATE TABLE in 7.79s]
2018-04-18 09:47:53,642: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10da3fd30>]}
2018-04-18 09:47:53,917: 09:47:53 | 30 of 91 OK created table model agency_data_pipeline.ga_transactions. [CREATE TABLE in 9.90s]
2018-04-18 09:47:54,074: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ac155c0>]}
2018-04-18 09:47:54,358: 09:47:54 | 32 of 91 OK created table model agency_data_pipeline.adwords_join.... [CREATE TABLE in 8.11s]
2018-04-18 09:47:58,497: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d965ef0>]}
2018-04-18 09:47:59,151: 09:47:59 | 29 of 91 OK created table model agency_data_pipeline.ga_traffic...... [CREATE TABLE in 14.76s]
2018-04-18 09:47:59,152: 09:47:59 | 33 of 91 START table model agency_data_pipeline.agg_transaction_line_item [RUN]
2018-04-18 09:47:59,153: Compiling model.agency_data_pipeline.agg_transaction_line_item
2018-04-18 09:47:59,160: Writing injected SQL for node "model.agency_data_pipeline.agg_transaction_line_item"
2018-04-18 09:47:59,152: 09:47:59 | 34 of 91 START table model agency_data_pipeline.agg_transaction_order_number [RUN]
2018-04-18 09:47:59,160: Compiling model.agency_data_pipeline.agg_transaction_order_number
2018-04-18 09:47:59,166: Writing injected SQL for node "model.agency_data_pipeline.agg_transaction_order_number"
2018-04-18 09:47:59,152: 09:47:59 | 35 of 91 START table model agency_data_pipeline.adwords_stats........ [RUN]
2018-04-18 09:47:59,153: 09:47:59 | 36 of 91 START table model agency_data_pipeline.adwords_impression_share [RUN]
2018-04-18 09:47:59,167: Compiling model.agency_data_pipeline.adwords_stats
2018-04-18 09:47:59,167: Compiling model.agency_data_pipeline.adwords_impression_share
2018-04-18 09:47:59,168: Acquiring new bigquery connection "agg_transaction_order_number".
2018-04-18 09:47:59,168: Acquiring new bigquery connection "agg_transaction_line_item".
2018-04-18 09:47:59,173: Writing injected SQL for node "model.agency_data_pipeline.adwords_stats"
2018-04-18 09:47:59,178: Writing injected SQL for node "model.agency_data_pipeline.adwords_impression_share"
2018-04-18 09:47:59,179: Re-using an available connection from the pool.
2018-04-18 09:47:59,180: Acquiring new bigquery connection "adwords_stats".
2018-04-18 09:47:59,181: Re-using an available connection from the pool.
2018-04-18 09:47:59,183: Acquiring new bigquery connection "adwords_impression_share".
2018-04-18 09:47:59,183: Re-using an available connection from the pool.
2018-04-18 09:47:59,194: Re-using an available connection from the pool.
2018-04-18 09:48:00,068: Model SQL (adwords_impression_share):
SELECT 
cast(day as date) date, 
account, 
channel,
platform,
sum(impression_share_num) impressions,
sum(impression_share_den) available_impressions
FROM 
  `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_join`
group by date, account, platform, channel
2018-04-18 09:48:00,091: Model SQL (agg_transaction_order_number):
SELECT
client,
cast(created_at as date) date,
order_number,
customer_id,
sum(final_quantity) final_quantity,
sum(final_price) final_price,
max(total_order_shipping_price) shipping_price
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`agg_orders_union`
GROUP BY client, created_at, order_number, customer_id
2018-04-18 09:48:00,137: Model SQL (agg_transaction_line_item):
SELECT
client,
created_at,
order_number,
quantity,
refund_quantity,
final_quantity,
price, 
total_order_price_undiscounted,
total_discounts,
total_order_shipping_price,
total_order_price_incl_shipping,
refund_amount,
final_price,
checkout_id,
product_id, 
landing_site,
sku, 
variant_title, 
variant_id,
line_item_id,	
customer_id,
orders_count,
customer_created_at,
last_order_id,
financial_status
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`agg_orders_union`
2018-04-18 09:48:00,206: Model SQL (adwords_stats):
SELECT 
cast(day as date) date, 
account, 
platform,
channel,
url,
utm_campaign,
campaign,
sum(cost) cost,
sum(impressions) impressions,
sum(clicks) clicks,
sum(transactions) transactions
FROM 
  `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_join`
group by date, account, platform, channel, url, campaign, utm_campaign
2018-04-18 09:48:02,313: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d9f0a58>]}
2018-04-18 09:48:02,595: 09:48:02 | 36 of 91 OK created table model agency_data_pipeline.adwords_impression_share [CREATE TABLE in 3.15s]
2018-04-18 09:48:02,595: 09:48:02 | 37 of 91 START table model agency_data_pipeline.fb_ads_stats......... [RUN]
2018-04-18 09:48:02,596: Compiling model.agency_data_pipeline.fb_ads_stats
2018-04-18 09:48:02,603: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_stats"
2018-04-18 09:48:02,604: Acquiring new bigquery connection "fb_ads_stats".
2018-04-18 09:48:02,604: Re-using an available connection from the pool.
2018-04-18 09:48:03,426: Model SQL (fb_ads_stats):
with cost as (

    select 
        date, account, ad_id, campaign,
        cost, impressions, clicks, null as conversions
    from `growth-engines-pipeline`.`agency_data_pipeline`.`fb_ads_insights`
),

conversions as (

    select 
        date, account, ad_id, campaign,
        null as cost, null as impressions, null as clicks, conversions
    from `growth-engines-pipeline`.`agency_data_pipeline`.`fb_ads_insights_conversions`
),

urls as (

    select ad_id, url
    from `growth-engines-pipeline`.`agency_data_pipeline`.`fb_ads`
)


SELECT
    cast(date as date) date,
    'FB Ads' platform,
    'Paid' channel,
    account, 
    b.url url,
    campaign,
    lower(campaign) utm_campaign, 
    sum(cost) cost,
    sum(impressions) impressions,
    sum(clicks) clicks,
    sum(conversions) transactions
FROM
(
    SELECT *
    FROM 
      cost
    UNION ALL
    SELECT *
    FROM 
      conversions
) a
LEFT JOIN urls b
ON ( a.ad_id = b.ad_id )
group by date, platform, channel, account, url, campaign, utm_campaign
2018-04-18 09:48:03,453: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ac558d0>]}
2018-04-18 09:48:03,706: 09:48:03 | 34 of 91 OK created table model agency_data_pipeline.agg_transaction_order_number [CREATE TABLE in 4.29s]
2018-04-18 09:48:05,598: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d9f0a58>]}
2018-04-18 09:48:05,912: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10aceaba8>]}
2018-04-18 09:48:05,933: 09:48:05 | 37 of 91 OK created table model agency_data_pipeline.fb_ads_stats.... [CREATE TABLE in 3.00s]
2018-04-18 09:48:06,209: 09:48:06 | 35 of 91 OK created table model agency_data_pipeline.adwords_stats... [CREATE TABLE in 6.75s]
2018-04-18 09:48:09,011: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ac55198>]}
2018-04-18 09:48:09,280: 09:48:09 | 33 of 91 OK created table model agency_data_pipeline.agg_transaction_line_item [CREATE TABLE in 9.86s]
2018-04-18 09:48:09,281: 09:48:09 | 38 of 91 START table model agency_data_pipeline.customers_by_transaction [RUN]
2018-04-18 09:48:09,281: Compiling model.agency_data_pipeline.customers_by_transaction
2018-04-18 09:48:09,292: Writing injected SQL for node "model.agency_data_pipeline.customers_by_transaction"
2018-04-18 09:48:09,294: Acquiring new bigquery connection "customers_by_transaction".
2018-04-18 09:48:09,294: Re-using an available connection from the pool.
2018-04-18 09:48:10,634: Model SQL (customers_by_transaction):
SELECT
client,
customer_id,
order_number,
order_date,
first_order_date,
case when first_order_number = order_number then 'New' else 'Existing' end as order_type,
final_price,
first_order_revenue,
lifetime_revenue
FROM

(

	SELECT
	client,
	customer_id,
	order_number,
	date order_date,
	first_value(date) over w1 first_order_date,
	first_value(order_number) over w1 first_order_number,
	first_value(final_price) over w1 first_order_revenue,
    final_price,
	sum(final_price) over w2 lifetime_revenue
	FROM
    `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_order_number`
	WINDOW w1 as (PARTITION BY client, customer_id ORDER BY date desc),
	w2 as (PARTITION BY client, customer_id)
)
2018-04-18 09:48:15,220: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d965ef0>]}
2018-04-18 09:48:15,490: 09:48:15 | 38 of 91 OK created table model agency_data_pipeline.customers_by_transaction [CREATE TABLE in 5.94s]
2018-04-18 09:48:15,491: 09:48:15 | 39 of 91 START table model agency_data_pipeline.agg_ga_transaction_order_number [RUN]
2018-04-18 09:48:15,491: Compiling model.agency_data_pipeline.agg_ga_transaction_order_number
2018-04-18 09:48:15,503: Writing injected SQL for node "model.agency_data_pipeline.agg_ga_transaction_order_number"
2018-04-18 09:48:15,491: 09:48:15 | 40 of 91 START table model agency_data_pipeline.frequency_proc....... [RUN]
2018-04-18 09:48:15,503: Compiling model.agency_data_pipeline.frequency_proc
2018-04-18 09:48:15,510: Writing injected SQL for node "model.agency_data_pipeline.frequency_proc"
2018-04-18 09:48:15,514: Acquiring new bigquery connection "frequency_proc".
2018-04-18 09:48:15,515: Acquiring new bigquery connection "agg_ga_transaction_order_number".
2018-04-18 09:48:15,515: Re-using an available connection from the pool.
2018-04-18 09:48:15,516: Re-using an available connection from the pool.
2018-04-18 09:48:16,371: Model SQL (agg_ga_transaction_order_number):
with ga as (

    select 
        date, account, client, 
        channel as last_touch_channel, 
        platform as last_touch_platform, 
        url as last_touch_url, 
        campaign as last_touch_utm_campaign, 
        '' as first_touch_channel, 
        '' as first_touch_platform, 
        '' as first_touch_utm_campaign, 
        transactionid,
        last_touch_transactions, last_touch_revenue,
        last_touch_shipping, last_touch_tax,
        null as first_touch_transactions, null as first_touch_revenue
    from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_transactions`

),

ga_mcf as (

    select 
        date, account, client, 
        '' as last_touch_channel,
        '' as last_touch_platform,
        '' as last_touch_url,
        '' as last_touch_utm_campaign, 
        channel as first_touch_channel, 
        platform as first_touch_platform, 
        campaign as first_touch_utm_campaign, 
        transactionid, 
        null as last_touch_transactions, null as last_touch_revenue,
        null as last_touch_shipping, null as last_touch_tax,
        first_touch_transactions, first_touch_revenue
    from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_mcf_stats`

)


SELECT
    date, 
    client,
    transactionid,
    max(last_touch_channel) last_touch_channel, 
    max(last_touch_platform) last_touch_platform, 
    max(last_touch_url) last_touch_url, 
    max(last_touch_utm_campaign) last_touch_utm_campaign, 
    max(first_touch_channel) first_touch_channel, 
    max(first_touch_platform) first_touch_platform, 
    max(first_touch_utm_campaign) first_touch_utm_campaign,
    sum(last_touch_transactions) last_touch_transactions,
    sum(last_touch_revenue) last_touch_revenue,
    sum(last_touch_shipping) last_touch_shipping_revenue,
    sum(last_touch_tax) last_touch_tax_revenue,
    sum(first_touch_transactions) first_touch_transactions,
    sum(first_touch_revenue) - ifnull(sum(last_touch_shipping),0) - ifnull(sum(last_touch_tax),0) first_touch_revenue
FROM
(
    SELECT *
    FROM 
      ga
    UNION ALL
    SELECT *
    FROM 
      ga_mcf
) 
GROUP BY
    date, client, transactionid
2018-04-18 09:48:16,414: Model SQL (frequency_proc):
WITH transactions AS (

  	SELECT 
	client,
	customer_id,
	order_number,
	date,
	unix_date(date) d
	FROM
	`growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_order_number`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)

SELECT 
client,
'Rolling 365' as period,
date_in_range date,
unix_date_in_range, 
customer_id,
count(distinct(order_number)) frequency
FROM daterange
JOIN transactions
ON transactions.d > ( daterange.unix_date_in_range - 365 )
AND transactions.d <= daterange.unix_date_in_range
group by client, unix_date_in_range, customer_id, date
2018-04-18 09:48:21,876: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ac29400>]}
2018-04-18 09:48:22,692: 09:48:22 | 39 of 91 OK created table model agency_data_pipeline.agg_ga_transaction_order_number [CREATE TABLE in 6.39s]
2018-04-18 09:48:32,318: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ac29f98>]}
2018-04-18 09:48:32,611: 09:48:32 | 40 of 91 OK created table model agency_data_pipeline.frequency_proc.. [CREATE TABLE in 16.81s]
2018-04-18 09:48:32,612: 09:48:32 | 41 of 91 START table model agency_data_pipeline.agg_ga_campaign...... [RUN]
2018-04-18 09:48:32,613: Compiling model.agency_data_pipeline.agg_ga_campaign
2018-04-18 09:48:32,628: Writing injected SQL for node "model.agency_data_pipeline.agg_ga_campaign"
2018-04-18 09:48:32,618: 09:48:32 | 42 of 91 START table model agency_data_pipeline.agg_transaction_line_item_type [RUN]
2018-04-18 09:48:32,629: Compiling model.agency_data_pipeline.agg_transaction_line_item_type
2018-04-18 09:48:32,635: Writing injected SQL for node "model.agency_data_pipeline.agg_transaction_line_item_type"
2018-04-18 09:48:32,618: 09:48:32 | 43 of 91 START table model agency_data_pipeline.frequency_stats...... [RUN]
2018-04-18 09:48:32,635: Compiling model.agency_data_pipeline.frequency_stats
2018-04-18 09:48:32,642: Writing injected SQL for node "model.agency_data_pipeline.frequency_stats"
2018-04-18 09:48:32,644: Acquiring new bigquery connection "agg_ga_campaign".
2018-04-18 09:48:32,645: Re-using an available connection from the pool.
2018-04-18 09:48:32,647: Acquiring new bigquery connection "agg_transaction_line_item_type".
2018-04-18 09:48:32,648: Re-using an available connection from the pool.
2018-04-18 09:48:32,654: Acquiring new bigquery connection "frequency_stats".
2018-04-18 09:48:32,655: Re-using an available connection from the pool.
2018-04-18 09:48:33,435: Model SQL (agg_ga_campaign):
with ga_transactions as (

	select 
		date, account, client, channel, platform, url, 
		campaign,
		null as sessions, null as goal_completions, last_touch_transactions, last_touch_revenue,
		last_touch_shipping, last_touch_tax,
		null as first_touch_transactions, null as first_touch_revenue
	from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_transactions`

),

ga_traffic as (

    select 
        date, account, client, channel, platform, url, 
        campaign,
        sessions, goal_completions, null as last_touch_transactions, null as last_touch_revenue,
        null as last_touch_shipping, null as last_touch_tax,
        null as first_touch_transactions, null as first_touch_revenue
    from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_traffic`

),

ga_mcf as (

	select 
		date, account, client, channel, platform, '' as url,
		campaign, 
		null as sessions, null as goal_completions, null as last_touch_transactions, null as last_touch_revenue,
		null as last_touch_shipping, null as last_touch_tax,
		first_touch_transactions, first_touch_revenue
	from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_mcf_stats`

)


SELECT
    date, 
    client,
    platform,
    channel, 
    url,
    campaign utm_campaign,
	sum(sessions) sessions,
	sum(goal_completions) goal_completions,
	sum(last_touch_transactions) last_touch_transactions,
	sum(last_touch_revenue) last_touch_revenue,
    sum(last_touch_shipping) last_touch_shipping_revenue,
    sum(last_touch_tax) last_touch_tax_revenue,
    sum(first_touch_transactions) first_touch_transactions,
    sum(first_touch_revenue) - sum(ifnull(last_touch_shipping,0)) - sum(ifnull(last_touch_tax,0)) first_touch_revenue

FROM
(
    SELECT *
    FROM 
      ga_transactions
    UNION ALL
    SELECT *
    FROM 
      ga_traffic
    UNION ALL
    SELECT *
    FROM 
      ga_mcf
) 
GROUP BY
    date, client, platform, channel, url, utm_campaign
2018-04-18 09:48:33,493: Model SQL (frequency_stats):
SELECT
client,
period,
date,
unix_date_in_range,
case when frequency = 1 then '1' 
	when frequency = 2 then '2'
	when frequency > 2 then '2+'
	else null end as frequency_segment,
sum(customers) customers 
FROM (

	SELECT 
	client,
	period,
	date,
	unix_date_in_range, 
	frequency,
	count(distinct(customer_id)) customers
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`frequency_proc`
	group by client, period, date, unix_date_in_range, frequency
)
group by client, period, date, unix_date_in_range, frequency_segment
2018-04-18 09:48:33,545: Model SQL (agg_transaction_line_item_type):
SELECT
client,
product_id,
product_type,
customer_id,
sku,
order_number,
created_at,
final_quantity,
final_price
FROM

( 
	SELECT 
	a.client, 
	a.product_id,
	product_type,
	customer_id,
	a.sku, 
	order_number,
	created_at,
	final_quantity,
	final_price
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_line_item` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`agg_products` b
	ON (
		a.product_id = b.product_id
	  and a.client = b.client
		)

)
2018-04-18 09:48:38,003: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ac157f0>]}
2018-04-18 09:48:38,675: 09:48:38 | 42 of 91 OK created table model agency_data_pipeline.agg_transaction_line_item_type [CREATE TABLE in 5.37s]
2018-04-18 09:48:40,103: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ac74898>]}
2018-04-18 09:48:40,339: 09:48:40 | 43 of 91 OK created table model agency_data_pipeline.frequency_stats. [CREATE TABLE in 7.47s]
2018-04-18 09:48:41,121: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d965ef0>]}
2018-04-18 09:48:41,404: 09:48:41 | 41 of 91 OK created table model agency_data_pipeline.agg_ga_campaign. [CREATE TABLE in 8.51s]
2018-04-18 09:48:41,404: 09:48:41 | 44 of 91 START table model agency_data_pipeline.customers_first_purchase_product_type_proc [RUN]
2018-04-18 09:48:41,405: Compiling model.agency_data_pipeline.customers_first_purchase_product_type_proc
2018-04-18 09:48:41,412: Writing injected SQL for node "model.agency_data_pipeline.customers_first_purchase_product_type_proc"
2018-04-18 09:48:41,405: 09:48:41 | 45 of 91 START table model agency_data_pipeline.agg_transaction_product_type [RUN]
2018-04-18 09:48:41,413: Compiling model.agency_data_pipeline.agg_transaction_product_type
2018-04-18 09:48:41,420: Writing injected SQL for node "model.agency_data_pipeline.agg_transaction_product_type"
2018-04-18 09:48:41,422: Acquiring new bigquery connection "customers_first_purchase_product_type_proc".
2018-04-18 09:48:41,422: Re-using an available connection from the pool.
2018-04-18 09:48:41,425: Acquiring new bigquery connection "agg_transaction_product_type".
2018-04-18 09:48:41,426: Re-using an available connection from the pool.
2018-04-18 09:48:42,376: Model SQL (agg_transaction_product_type):
SELECT
client,
product_type,
customer_id,
order_number,
created_at,
first_value(product_type) over (PARTITION BY client, customer_id, order_number, created_at ORDER BY final_price desc) as top_order_product_type,
final_quantity,
final_price,
sum(final_quantity) over (PARTITION BY client, customer_id, order_number) as total_order_quantity,
sum(final_price) over (PARTITION BY client, customer_id, order_number) as total_order_value
FROM
	(
		SELECT
		client,
		product_type,
		customer_id,
		order_number,
		created_at,
		sum(final_quantity) final_quantity,
		sum(final_price) final_price
		FROM
		`growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_line_item_type`
		GROUP BY
		client,
		product_type,
		customer_id,
		order_number,
		created_at
	)
2018-04-18 09:48:42,377: Model SQL (customers_first_purchase_product_type_proc):
SELECT 
client, 
customer_id, 
product_type,
min(cast(created_at as date)) first_order_date,
unix_date( min(cast(created_at as date))) first_order_unix_date
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_line_item_type`
GROUP BY client, customer_id, product_type
2018-04-18 09:48:45,643: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ac20390>]}
2018-04-18 09:48:45,928: 09:48:45 | 44 of 91 OK created table model agency_data_pipeline.customers_first_purchase_product_type_proc [CREATE TABLE in 4.24s]
2018-04-18 09:48:46,757: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10dab3940>]}
2018-04-18 09:48:47,046: 09:48:47 | 45 of 91 OK created table model agency_data_pipeline.agg_transaction_product_type [CREATE TABLE in 5.34s]
2018-04-18 09:48:47,046: 09:48:47 | 46 of 91 START table model agency_data_pipeline.products_proc........ [RUN]
2018-04-18 09:48:47,047: Compiling model.agency_data_pipeline.products_proc
2018-04-18 09:48:47,047: 09:48:47 | 47 of 91 START table model agency_data_pipeline.order_paths_proc..... [RUN]
2018-04-18 09:48:47,056: Writing injected SQL for node "model.agency_data_pipeline.products_proc"
2018-04-18 09:48:47,047: 09:48:47 | 48 of 91 START table model agency_data_pipeline.customers_products_proc [RUN]
2018-04-18 09:48:47,056: Compiling model.agency_data_pipeline.order_paths_proc
2018-04-18 09:48:47,056: Compiling model.agency_data_pipeline.customers_products_proc
2018-04-18 09:48:47,062: Writing injected SQL for node "model.agency_data_pipeline.order_paths_proc"
2018-04-18 09:48:47,073: Writing injected SQL for node "model.agency_data_pipeline.customers_products_proc"
2018-04-18 09:48:47,075: Acquiring new bigquery connection "customers_products_proc".
2018-04-18 09:48:47,076: Re-using an available connection from the pool.
2018-04-18 09:48:47,083: Acquiring new bigquery connection "order_paths_proc".
2018-04-18 09:48:47,083: Re-using an available connection from the pool.
2018-04-18 09:48:47,090: Acquiring new bigquery connection "products_proc".
2018-04-18 09:48:47,090: Re-using an available connection from the pool.
2018-04-18 09:48:47,862: Model SQL (customers_products_proc):
WITH customers AS (
  SELECT 
  client, 
  product_id,
  product_type,
  customer_id,
  sku, 
  order_number,
  cast(created_at as date) order_date,
  unix_date(cast(created_at as date)) unix_order_date, 
  final_quantity quantity,
  final_price revenue
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_line_item_type`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)

SELECT 
client,
period,
customer_id,
product_type,
date,
window_end_unix_date,
window_end_unix_date - 365 as window_start_unix_date,
window_end_unix_date - unix_date(recent_order) recency_days,
frequency,
quantity,
revenue,
case when frequency > 0 then revenue/frequency else 0 end as aov
FROM 
(  

  SELECT 
  client,
  'Rolling 365' as period,
  customer_id,
  product_type,
  date_in_range date,
  unix_date_in_range,
  unix_date_in_range window_end_unix_date, 
  max(order_date) recent_order,
  sum(quantity) as quantity,
  sum(revenue) as revenue,
  count(distinct(order_number)) as frequency
  FROM daterange
  JOIN customers
  ON customers.unix_order_date > ( daterange.unix_date_in_range - 365 )
  AND customers.unix_order_date <= daterange.unix_date_in_range
  GROUP BY client, customer_id, date, unix_date_in_range, product_type

  UNION ALL

  SELECT 
  client,
  'Rolling 365 (t-1mo)' as period,
  customer_id,
  product_type,
  date_in_range date,
  unix_date_in_range, 
  unix_date_in_range - 30 window_end_unix_date, 
  max(order_date) recent_order,
  sum(quantity) as quantity,
  sum(revenue) as revenue,
  count(distinct(order_number)) as frequency
  FROM daterange
  JOIN customers
  ON customers.unix_order_date > ( daterange.unix_date_in_range - 395 )
  AND customers.unix_order_date <= ( daterange.unix_date_in_range - 30 )
  GROUP BY client, customer_id, date, unix_date_in_range, product_type

  UNION ALL

  SELECT 
  client,
  'Rolling 365 (t-1yr)' as period,
  customer_id,
  product_type,
  date_in_range date,
  unix_date_in_range, 
  unix_date_in_range - 365 window_end_unix_date, 
  max(order_date) recent_order,
  sum(quantity) as quantity,
  sum(revenue) as revenue,
  count(distinct(order_number)) as frequency
  FROM daterange
  JOIN customers
  ON customers.unix_order_date > ( daterange.unix_date_in_range - 730 )
  AND customers.unix_order_date <= ( daterange.unix_date_in_range - 365 )
  GROUP BY client, customer_id, date, unix_date_in_range, product_type

)
2018-04-18 09:48:47,904: Model SQL (order_paths_proc):
SELECT
client, 
customer_id, 
first_value(product_type) OVER w1 as first_product_type,
nth_value(product_type, 2) OVER w1 as second_product_type,
cast(first_value(created_at) OVER w1 as date) as first_purchase_date,
cast(nth_value(created_at, 2) OVER w1 as date) as second_purchase_date,
cast(nth_value(created_at, 3) OVER w1 as date) as third_purchase_date,
cast(nth_value(created_at, 4) OVER w1 as date) as fourth_purchase_date,
cast(nth_value(created_at, 5) OVER w1 as date) as fifth_purchase_date,
first_value(order_number) OVER w1 as first_order_number,
nth_value(order_number, 2) OVER w1 as second_order_number,
nth_value(order_number, 3) OVER w1 as third_order_number,
nth_value(order_number, 4) OVER w1 as fourth_order_number,
nth_value(order_number, 5) OVER w1 as fifth_order_number,
first_value(total_order_value) OVER w1 as first_order_value,
nth_value(total_order_value, 2) OVER w1 as second_order_value
FROM (
	  
	  SELECT 
	  client, 
	  product_type,
	  customer_id,
	  order_number,
	  created_at, 
	  total_order_value
	  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_product_type`
	  WHERE product_type = top_order_product_type

)
WINDOW w1 as (PARTITION BY client, customer_id ORDER BY created_at asc)
2018-04-18 09:48:47,911: Model SQL (products_proc):
WITH transactions AS (
  SELECT 
  client, 
  product_id,
  product_type,
  customer_id,
  sku, 
  order_number,
  unix_date(cast(created_at as date)) d, 
  final_quantity,
  final_price,
  first_value(unix_date(cast(created_at as date))) over (partition by client, product_id, sku order by created_at asc) first_purchase_unix_date
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_line_item_type`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)

SELECT 
client,
'Last 30' as period,
sku,
product_type,
date_in_range date,
unix_date_in_range, 
case when 
  ( first_purchase_unix_date > ( daterange.unix_date_in_range - 365 ) and first_purchase_unix_date <= daterange.unix_date_in_range )
  then 'New' else 'Existing' end as newness,  
count(distinct(customer_id)) unique_customers,
count(distinct(order_number)) orders,
sum(final_quantity) quantity,
sum(final_price) revenue,
count(distinct(d)) days_sold
FROM daterange
JOIN transactions
ON transactions.d > ( daterange.unix_date_in_range - 30 )
AND transactions.d <= daterange.unix_date_in_range
group by date_in_range, unix_date_in_range, client, sku, product_type, newness

UNION ALL

SELECT 
client,
'Last 90' as period,
sku, 
product_type,
date_in_range date,
unix_date_in_range, 
case when 
  ( first_purchase_unix_date > ( daterange.unix_date_in_range - 365 ) and first_purchase_unix_date <= daterange.unix_date_in_range )
  then 'New' else 'Existing' end as newness,  
count(distinct(customer_id)) unique_customers,
count(distinct(order_number)) orders,
sum(final_quantity) quantity,
sum(final_price) revenue,
count(distinct(d)) days_sold
FROM daterange
JOIN transactions
ON transactions.d > ( daterange.unix_date_in_range - 90 )
AND transactions.d <= daterange.unix_date_in_range
group by date_in_range, unix_date_in_range, client, sku, product_type, newness

UNION ALL

SELECT 
client,
'YoY 30' as date_range,
sku, 
product_type,
date_in_range date,
unix_date_in_range,
case when 
  ( first_purchase_unix_date > ( daterange.unix_date_in_range - 730 ) and first_purchase_unix_date <= ( daterange.unix_date_in_range - 365 ))
  then 'New' else 'Existing' end as newness,   
count(distinct(customer_id)) unique_customers,
count(distinct(order_number)) orders,
sum(final_quantity) quantity,
sum(final_price) revenue,
count(distinct(d)) days_sold
FROM daterange
JOIN transactions
ON transactions.d > ( daterange.unix_date_in_range - 395 )
AND transactions.d <= ( daterange.unix_date_in_range - 365 )
group by date_in_range, unix_date_in_range, client, sku, product_type, newness
2018-04-18 09:48:50,217: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10da5e128>]}
2018-04-18 09:48:50,544: 09:48:50 | 47 of 91 OK created table model agency_data_pipeline.order_paths_proc [CREATE TABLE in 3.16s]
2018-04-18 09:48:55,743: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d965ef0>]}
2018-04-18 09:48:55,976: 09:48:55 | 46 of 91 OK created table model agency_data_pipeline.products_proc... [CREATE TABLE in 8.70s]
2018-04-18 09:49:23,888: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d965ef0>]}
2018-04-18 09:49:24,600: 09:49:24 | 48 of 91 OK created table model agency_data_pipeline.customers_products_proc [CREATE TABLE in 36.83s]
2018-04-18 09:49:24,601: 09:49:24 | 49 of 91 START table model agency_data_pipeline.segment_proc_sku..... [RUN]
2018-04-18 09:49:24,602: Compiling model.agency_data_pipeline.segment_proc_sku
2018-04-18 09:49:24,601: 09:49:24 | 50 of 91 START table model agency_data_pipeline.order_paths_agg...... [RUN]
2018-04-18 09:49:24,610: Writing injected SQL for node "model.agency_data_pipeline.segment_proc_sku"
2018-04-18 09:49:24,610: Compiling model.agency_data_pipeline.order_paths_agg
2018-04-18 09:49:24,615: Writing injected SQL for node "model.agency_data_pipeline.order_paths_agg"
2018-04-18 09:49:24,616: Acquiring new bigquery connection "segment_proc_sku".
2018-04-18 09:49:24,616: Re-using an available connection from the pool.
2018-04-18 09:49:24,619: Acquiring new bigquery connection "order_paths_agg".
2018-04-18 09:49:24,619: Re-using an available connection from the pool.
2018-04-18 09:49:25,686: Model SQL (order_paths_agg):
SELECT
client, 
first_product_type,
second_product_type,
first_purchase_date,
count(distinct(customer_id)) customer_count, 
count(distinct(second_order_number)) second_orders, 
count(distinct(third_order_number)) third_orders, 
count(distinct(fourth_order_number)) fourth_orders, 
count(distinct(fifth_order_number)) fifth_orders, 
sum(date_diff(second_purchase_date, first_purchase_date, DAY)) second_order_latency_days,
sum(date_diff(third_purchase_date, second_purchase_date, DAY)) third_order_latency_days,
sum(date_diff(fourth_purchase_date, third_purchase_date, DAY)) fourth_order_latency_days,
sum(date_diff(fifth_purchase_date, fourth_purchase_date, DAY)) fifth_order_latency_days,
sum(first_order_value) first_order_revenue,
sum(second_order_value) second_order_revenue
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`order_paths_proc`
where second_product_type is not null
GROUP BY client, first_product_type, second_product_type, first_purchase_date
2018-04-18 09:49:25,689: Model SQL (segment_proc_sku):
SELECT
client,
period,
sku, 
product_type,
date,
unique_customers,
orders,
quantity,
revenue,
case 
	when avg_daily_revenue >= avg_daily_revenue_90pct and avg_daily_quantity >= avg_daily_quantity_80pct then 'Best Seller'
	when avg_daily_revenue >= avg_daily_revenue_70pct and avg_daily_quantity >= avg_daily_quantity_40pct then 'Good'
	when avg_daily_revenue < avg_daily_revenue_70pct and avg_daily_revenue >= avg_daily_revenue_30pct and avg_daily_quantity < avg_daily_quantity_70pct then 'Average'
	when avg_daily_revenue < avg_daily_revenue_30pct and avg_daily_quantity < avg_daily_quantity_30pct then 'Poor'
	else 'Unbucketed' end as segment,
newness,	
avg_daily_revenue_90pct,
avg_daily_revenue_70pct,
avg_daily_revenue_30pct,
avg_daily_quantity_80pct,
avg_daily_quantity_70pct,
avg_daily_quantity_40pct,
avg_daily_quantity_30pct

FROM (

	SELECT
	client,
	period,
	sku, 
	product_type,
	newness,
	date,
	unique_customers,
	orders,
	quantity,
	revenue,
	days_sold,
	avg_daily_revenue,
	avg_daily_quantity,
	PERCENTILE_CONT(avg_daily_revenue, 0.90) OVER w1 AS avg_daily_revenue_90pct,
	PERCENTILE_CONT(avg_daily_revenue, 0.70) OVER w1 AS avg_daily_revenue_70pct,
	PERCENTILE_CONT(avg_daily_revenue, 0.3) OVER w1 AS avg_daily_revenue_30pct,
	PERCENTILE_CONT(avg_daily_quantity, 0.80) OVER w1 AS avg_daily_quantity_80pct,
	PERCENTILE_CONT(avg_daily_quantity, 0.70) OVER w1 AS avg_daily_quantity_70pct,
	PERCENTILE_CONT(avg_daily_quantity, 0.40) OVER w1 AS avg_daily_quantity_40pct,
	PERCENTILE_CONT(avg_daily_quantity, 0.3) OVER w1 AS avg_daily_quantity_30pct

	FROM
	(
		SELECT 
		client,
		period,
		sku, 
		product_type,
		newness,
		date,
		unique_customers,
		orders,
		quantity,
		revenue,
		days_sold,
		case when days_sold > 0 then revenue/days_sold else null end as avg_daily_revenue,
		case when days_sold > 0 then quantity/days_sold else null end as avg_daily_quantity
		FROM `growth-engines-pipeline`.`agency_data_pipeline`.`products_proc`
	)
	WINDOW w1 as (PARTITION BY client, period, date)
)
2018-04-18 09:49:27,882: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10dab3940>]}
2018-04-18 09:49:27,889: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10da56ef0>]}
2018-04-18 09:49:28,128: 09:49:28 | 49 of 91 OK created table model agency_data_pipeline.segment_proc_sku [CREATE TABLE in 3.28s]
2018-04-18 09:49:28,362: 09:49:28 | 50 of 91 OK created table model agency_data_pipeline.order_paths_agg. [CREATE TABLE in 3.28s]
2018-04-18 09:49:28,363: 09:49:28 | 51 of 91 START table model agency_data_pipeline.segment_stats_sku.... [RUN]
2018-04-18 09:49:28,363: 09:49:28 | 52 of 91 START table model agency_data_pipeline.agg_transaction...... [RUN]
2018-04-18 09:49:28,364: 09:49:28 | 53 of 91 START table model agency_data_pipeline.segment_proc_customers_products [RUN]
2018-04-18 09:49:28,364: 09:49:28 | 54 of 91 START table model agency_data_pipeline.agg_ga_transaction... [RUN]
2018-04-18 09:49:28,364: Compiling model.agency_data_pipeline.segment_stats_sku
2018-04-18 09:49:28,365: Compiling model.agency_data_pipeline.agg_transaction
2018-04-18 09:49:28,365: Compiling model.agency_data_pipeline.segment_proc_customers_products
2018-04-18 09:49:28,365: Compiling model.agency_data_pipeline.agg_ga_transaction
2018-04-18 09:49:28,374: Writing injected SQL for node "model.agency_data_pipeline.segment_stats_sku"
2018-04-18 09:49:28,385: Writing injected SQL for node "model.agency_data_pipeline.segment_proc_customers_products"
2018-04-18 09:49:28,386: Writing injected SQL for node "model.agency_data_pipeline.agg_transaction"
2018-04-18 09:49:28,394: Writing injected SQL for node "model.agency_data_pipeline.agg_ga_transaction"
2018-04-18 09:49:28,401: Acquiring new bigquery connection "segment_proc_customers_products".
2018-04-18 09:49:28,401: Re-using an available connection from the pool.
2018-04-18 09:49:28,402: Acquiring new bigquery connection "segment_stats_sku".
2018-04-18 09:49:28,403: Acquiring new bigquery connection "agg_transaction".
2018-04-18 09:49:28,404: Acquiring new bigquery connection "agg_ga_transaction".
2018-04-18 09:49:28,404: Re-using an available connection from the pool.
2018-04-18 09:49:28,410: Re-using an available connection from the pool.
2018-04-18 09:49:28,414: Re-using an available connection from the pool.
2018-04-18 09:49:29,249: Model SQL (segment_stats_sku):
WITH last_30 as (

	SELECT
	client,
	sku, 
	product_type,
	date,
	unique_customers as customers_30,
	orders as orders_30,
	revenue as revenue_30,
	segment as segment_30,
	newness as newness_30,
	0 as customers_90,
	0 as orders_90,
	0 as revenue_90,
	'' as segment_90,
	0 as customers_yoy_30,
	0 as orders_yoy_30,
	0 as revenue_yoy_30,
	'' as segment_yoy_30
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_sku`
	WHERE period = 'Last 30'

),

last_90 as (

	SELECT
	client,
	sku, 
	product_type,
	date,
	0 as customers_30,
	0 as orders_30,
	0 as revenue_30,
	'' as segment_30,
	'' as newness_30,
	unique_customers as customers_90,
	orders as orders_90,
	revenue as revenue_90,
	segment as segment_90,
	0 as customers_yoy_30,
	0 as orders_yoy_30,
	0 as revenue_yoy_30,
	'' as segment_yoy_30
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_sku`
	WHERE period = 'Last 90'

),

yoy_30 as (

	SELECT
	client,
	sku, 
	product_type,
	date,
	0 as customers_30,
	0 as orders_30,
	0 as revenue_30,
	'' as segment_30,
	'' as newness_30,
	0 as customers_90,
	0 as orders_90,
	0 as revenue_90,
	'' as segment_90,
	unique_customers as customers_yoy_30,
	orders as orders_yoy_30,
	revenue as revenue_yoy_30,
	segment as segment_yoy_30
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_sku`
	WHERE period = 'YoY 30'

)

SELECT
client,
sku, 
product_type,
date,
ifnull(sum(customers_30), 0) customers_30,
ifnull(sum(orders_30), 0) orders_30,
ifnull(sum(revenue_30), 0) revenue_30,
ifnull(max(segment_30), '') segment_30,
ifnull(sum(customers_90), 0) customers_90,
ifnull(sum(orders_90), 0) orders_90,
ifnull(sum(revenue_90), 0) revenue_90,
ifnull(max(segment_90),'') segment_90,
ifnull(sum(customers_yoy_30), 0) customers_yoy_30,
ifnull(sum(orders_yoy_30), 0) orders_yoy_30,
ifnull(sum(revenue_yoy_30), 0) revenue_yoy_30,
case when max(newness_30) = 'New' then 'New'
	else ifnull(max(segment_yoy_30), '') end as segment_yoy_30
FROM
(
	SELECT * FROM last_30
	UNION ALL
	SELECT * FROM last_90
	UNION ALL
	SELECT * FROM yoy_30

)
GROUP BY client, sku, product_type, date
2018-04-18 09:49:29,277: Model SQL (segment_proc_customers_products):
SELECT
client,
period,
date,
customer_id,
first_order_date,
first_order_unix_date,
product_type,
recency_days,
frequency,
revenue,
quantity,
aov,
case when recency_days <= 30 and first_order_unix_date >= window_start_unix_date then 'New'
	when frequency = 1 and recency_days <= 90 and aov >= aov_40pct then 'Promising'
	when frequency = 1 then 'One-time Purchaser'
	when frequency >= frequency_90pct and recency_days <= 90 and aov > aov_40pct then 'Whale'
	when recency_days <= 240 and frequency > frequency_50pct then 'Loyal'
	when recency_days <= 90 and frequency > frequency_50pct then 'Potential Loyalists' 
	when recency_days > 240 and frequency > frequency_50pct then 'Defecting Good Customer'	
	when recency_days > recency_50pct and frequency > frequency_50pct then 'Frequent, not Recent'
	when recency_days < recency_50pct and frequency < frequency_50pct then 'Recent, not Frequent'
	else 'Unbucketed' end as segment,
aov_40pct,
frequency_90pct,
frequency_75pct,
frequency_50pct,
recency_50pct
FROM
(
	SELECT 
	a.client client,
	period,
	date,
	a.customer_id customer_id,
	a.product_type product_type,
	b.first_order_date first_order_date,
	b.first_order_unix_date first_order_unix_date,
	window_start_unix_date,
	window_end_unix_date,	
	recency_days,
	frequency,
	revenue,
	quantity,
	aov,
	PERCENTILE_CONT(aov, 0.40) OVER w1 AS aov_40pct,
	PERCENTILE_CONT(frequency, 0.90) OVER w1 AS frequency_90pct,
	PERCENTILE_CONT(frequency, 0.75) OVER w1 AS frequency_75pct,
	PERCENTILE_CONT(frequency, 0.50) OVER w1 AS frequency_50pct,
	PERCENTILE_CONT(recency_days, 0.5) OVER w1 AS recency_50pct
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`customers_products_proc` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`customers_first_purchase_product_type_proc` b
	ON (
		a.client = b.client and
		a.customer_id = b.customer_id and
		a.product_type = b.product_type
		)
	WINDOW w1 as (PARTITION BY a.client, period, date, a.product_type)
)
2018-04-18 09:49:29,279: Model SQL (agg_ga_transaction):
#done - lookup customer id from transaction id from orders
#done - tag an order as 'new' or 'existing' based on transaction id
#sum lifetime value of that customer id
#first order value for customer
#read from agg_ga_transaction into agg_ga_campaign instead of directly from ga_transactions and ga_mcf_stats


with ga as (

    select 
        date, 
        client, 
        'Last-touch' as attribution,
        channel, 
        platform, 
        url, 
        campaign, 
        transactionid,
        last_touch_transactions transactions, 
        last_touch_revenue + ifnull(last_touch_shipping, 0) + ifnull(last_touch_tax, 0) as revenue
    from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_transactions`

),

ga_mcf as (

    select 
        date, 
        client, 
        'First-touch' as attribution,
        channel, 
        platform, 
        '' as url,
        campaign, 
        transactionid, 
        first_touch_transactions as transactions,
        first_touch_revenue as revenue
    from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_mcf_stats`

)


SELECT
    date, 
    a.client client,
    attribution,
    transactionid,
    b.customer_id customer_id,
    b.order_type order_type,
    b.first_order_revenue first_order_revenue,
    b.lifetime_revenue lifetime_revenue,
    channel,
    platform,
    url,
    campaign,
    transactions,
    revenue
FROM (
    SELECT * FROM ga
    UNION ALL
    SELECT * FROM ga_mcf
) a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`customers_by_transaction` b
ON (
    a.client = b.client AND
    a.transactionid = b.order_number
)
2018-04-18 09:49:29,413: Model SQL (agg_transaction):
SELECT
client,
date,
customer_id,
order_number,
last_touch_channel,
last_touch_platform,
last_touch_url,
first_touch_channel, 
first_touch_platform, 
first_touch_utm_campaign,
ifnull( sum(last_touch_transactions), 0) last_touch_transactions, 
ifnull( sum(last_touch_revenue), 0) last_touch_revenue, 
ifnull( sum(first_touch_transactions), 0) first_touch_transactions, 
ifnull( sum(first_touch_revenue), 0) first_touch_revenue,
ifnull( sum(final_quantity), 0) quantity,
ifnull( sum(final_price), 0) revenue,
ifnull( sum(shipping_price), 0) shipping_revenue,
ROW_NUMBER() OVER (PARTITION BY client, customer_id, order_number ORDER BY date asc) AS order_sequence
FROM
(
	SELECT
	a.client,
	a.date date,
	b.date ga_date,
	a.customer_id,
	a.order_number,
	transactionid,
	b.last_touch_channel,
	b.last_touch_platform,
	b.last_touch_url,
	b.first_touch_channel, 
	b.first_touch_platform, 
	b.first_touch_utm_campaign, 
	last_touch_transactions, 
	last_touch_revenue, 
	first_touch_transactions, 
	first_touch_revenue,
	final_quantity,
	final_price,
	shipping_price
	FROM
	`growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_order_number` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`agg_ga_transaction_order_number` b
	ON (
		a.client = b.client and
		a.order_number = b.transactionid
	)

)
GROUP BY
client, 
date, 
customer_id,
order_number, 
last_touch_channel,
last_touch_platform,
last_touch_url,
first_touch_channel, 
first_touch_platform, 
first_touch_utm_campaign
2018-04-18 09:49:32,717: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d965ef0>]}
2018-04-18 09:49:32,971: 09:49:32 | 51 of 91 OK created table model agency_data_pipeline.segment_stats_sku [CREATE TABLE in 4.35s]
2018-04-18 09:49:34,964: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10da5e128>]}
2018-04-18 09:49:35,343: 09:49:35 | 52 of 91 OK created table model agency_data_pipeline.agg_transaction. [CREATE TABLE in 6.60s]
2018-04-18 09:49:43,586: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ac8f860>]}
2018-04-18 09:49:44,332: 09:49:44 | 54 of 91 OK created table model agency_data_pipeline.agg_ga_transaction [CREATE TABLE in 15.22s]
2018-04-18 09:50:04,762: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10dab3940>]}
2018-04-18 09:50:05,400: 09:50:05 | 53 of 91 OK created table model agency_data_pipeline.segment_proc_customers_products [CREATE TABLE in 36.40s]
2018-04-18 09:50:05,401: 09:50:05 | 55 of 91 START table model agency_data_pipeline.agg_ga_campaign_by_type [RUN]
2018-04-18 09:50:05,402: 09:50:05 | 56 of 91 START table model agency_data_pipeline.segment_stats_category [RUN]
2018-04-18 09:50:05,403: Compiling model.agency_data_pipeline.agg_ga_campaign_by_type
2018-04-18 09:50:05,402: 09:50:05 | 57 of 91 START table model agency_data_pipeline.agg_transaction_daily [RUN]
2018-04-18 09:50:05,403: Compiling model.agency_data_pipeline.segment_stats_category
2018-04-18 09:50:05,402: 09:50:05 | 58 of 91 START table model agency_data_pipeline.order_paths_stats.... [RUN]
2018-04-18 09:50:05,417: Compiling model.agency_data_pipeline.agg_transaction_daily
2018-04-18 09:50:05,426: Writing injected SQL for node "model.agency_data_pipeline.agg_ga_campaign_by_type"
2018-04-18 09:50:05,440: Writing injected SQL for node "model.agency_data_pipeline.segment_stats_category"
2018-04-18 09:50:05,440: Compiling model.agency_data_pipeline.order_paths_stats
2018-04-18 09:50:05,449: Writing injected SQL for node "model.agency_data_pipeline.agg_transaction_daily"
2018-04-18 09:50:05,451: Acquiring new bigquery connection "agg_ga_campaign_by_type".
2018-04-18 09:50:05,460: Re-using an available connection from the pool.
2018-04-18 09:50:05,452: Acquiring new bigquery connection "segment_stats_category".
2018-04-18 09:50:05,459: Writing injected SQL for node "model.agency_data_pipeline.order_paths_stats"
2018-04-18 09:50:05,465: Re-using an available connection from the pool.
2018-04-18 09:50:05,470: Acquiring new bigquery connection "agg_transaction_daily".
2018-04-18 09:50:05,470: Re-using an available connection from the pool.
2018-04-18 09:50:05,480: Acquiring new bigquery connection "order_paths_stats".
2018-04-18 09:50:05,481: Re-using an available connection from the pool.
2018-04-18 09:50:06,597: Model SQL (agg_transaction_daily):
SELECT
client,
date,
customer_id,
sum(last_touch_transactions) last_touch_transactions, 
sum(last_touch_revenue) last_touch_revenue, 
sum(first_touch_transactions) first_touch_transactions, 
sum(first_touch_revenue) first_touch_revenue,
sum(quantity) quantity,
sum(revenue) revenue,
count(distinct(order_number)) order_count
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction`
GROUP BY
client, 
date, 
customer_id
2018-04-18 09:50:06,682: Model SQL (segment_stats_category):
SELECT
client,
product_type,
date,
segment_30,
segment_90,
segment_yoy_30,
ifnull(sum(customers_30), 0) customers_30,
ifnull(sum(orders_30), 0) orders_30,
ifnull(sum(revenue_30), 0) revenue_30,
ifnull(sum(customers_90), 0) customers_90,
ifnull(sum(orders_90), 0) orders_90,
ifnull(sum(revenue_90), 0) revenue_90,
ifnull(sum(customers_yoy_30), 0) customers_yoy_30,
ifnull(sum(orders_yoy_30), 0) orders_yoy_30,
ifnull(sum(revenue_yoy_30), 0) revenue_yoy_30
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`segment_stats_sku`
GROUP BY client, product_type, date, segment_30, segment_90, segment_yoy_30
2018-04-18 09:50:06,799: Model SQL (agg_ga_campaign_by_type):
with orders_new as (
    select 
    date, 
    client, 
    attribution,
    channel, 
    platform, 
    url, 
    campaign,
    count(distinct(customer_id)) customers_new,
    sum(transactions) transactions_new,
    sum(revenue) revenue_new,
    sum(first_order_revenue) first_order_revenue_new,
    sum(lifetime_revenue) lifetime_revenue_new,
    null as customers_total,
    null as transactions_total,
    null as revenue_total
    from `growth-engines-pipeline`.`agency_data_pipeline`.`agg_ga_transaction`
    where order_type = 'New'
    group by date, client, attribution, channel, platform, url, campaign
),
    
orders_total as (
    select 
    date, 
    client, 
    attribution,
    channel, 
    platform, 
    url, 
    campaign,
    null as customers_new,
    null as transactions_new,
    null as revenue_new,
    null as first_order_revenue_new,
    null as lifetime_revenue_new,
    count(distinct(customer_id)) customers_total,
    sum(transactions) transactions_total,
    sum(revenue) revenue_total
    from `growth-engines-pipeline`.`agency_data_pipeline`.`agg_ga_transaction`
    group by date, client, attribution, channel, platform, url, campaign

)

SELECT 
date, 
client, 
attribution,
channel, 
platform, 
url, 
campaign,
sum(customers_new) customers_new,
sum(transactions_new) transactions_new,
sum(revenue_new) revenue_new,
sum(first_order_revenue_new) first_order_revenue_new,
sum(lifetime_revenue_new) lifetime_revenue_new,
sum(customers_total) customers_total,
sum(transactions_total) transactions_total,
sum(revenue_total) revenue_total
from
    ( 
        SELECT * FROM orders_new
        UNION ALL 
        SELECT * FROM orders_total
    )
group by date, client, attribution, channel, platform, url, campaign
2018-04-18 09:50:06,863: Model SQL (order_paths_stats):
WITH transactions AS (
  SELECT 
  client, 
  first_product_type,
  second_product_type,
  first_purchase_date,
  customer_count,
  second_orders,
  third_orders,
  fourth_orders,
  fifth_orders,
  second_order_latency_days,
  third_order_latency_days,
  fourth_order_latency_days,
  fifth_order_latency_days,
  first_order_revenue,
  second_order_revenue,
  unix_date(cast(first_purchase_date as date)) d
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`order_paths_agg`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)

SELECT 
client,
'Rolling 365' as period,
first_product_type,
second_product_type,
date_in_range date,
unix_date_in_range, 
sum(customer_count) customer_count,
sum(second_orders) second_orders,
sum(third_orders) third_orders,
sum(fourth_orders) fourth_orders,
sum(fifth_orders) fifth_orders,
sum(second_order_latency_days) second_order_latency_days,
sum(third_order_latency_days) third_order_latency_days,
sum(fourth_order_latency_days) fourth_order_latency_days,
sum(fifth_order_latency_days) fifth_order_latency_days,
sum(first_order_revenue) first_order_revenue,
sum(second_order_revenue) second_order_revenue
FROM daterange
JOIN transactions
ON transactions.d > ( daterange.unix_date_in_range - 365 )
AND transactions.d <= daterange.unix_date_in_range
group by client, first_product_type, second_product_type, date_in_range, unix_date_in_range
2018-04-18 09:50:09,198: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ad1e8d0>]}
2018-04-18 09:50:09,203: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ac8fda0>]}
2018-04-18 09:50:09,506: 09:50:09 | 56 of 91 OK created table model agency_data_pipeline.segment_stats_category [CREATE TABLE in 3.79s]
2018-04-18 09:50:09,506: 09:50:09 | 59 of 91 START table model agency_data_pipeline.customers_first_purchase_proc [RUN]
2018-04-18 09:50:09,507: Compiling model.agency_data_pipeline.customers_first_purchase_proc
2018-04-18 09:50:09,516: Writing injected SQL for node "model.agency_data_pipeline.customers_first_purchase_proc"
2018-04-18 09:50:09,522: Acquiring new bigquery connection "customers_first_purchase_proc".
2018-04-18 09:50:09,522: Re-using an available connection from the pool.
2018-04-18 09:50:09,766: 09:50:09 | 58 of 91 OK created table model agency_data_pipeline.order_paths_stats [CREATE TABLE in 3.76s]
2018-04-18 09:50:09,766: 09:50:09 | 60 of 91 START table model agency_data_pipeline.segment_stats_customers_products_agg [RUN]
2018-04-18 09:50:09,767: Compiling model.agency_data_pipeline.segment_stats_customers_products_agg
2018-04-18 09:50:09,778: Writing injected SQL for node "model.agency_data_pipeline.segment_stats_customers_products_agg"
2018-04-18 09:50:09,780: Acquiring new bigquery connection "segment_stats_customers_products_agg".
2018-04-18 09:50:09,780: Re-using an available connection from the pool.
2018-04-18 09:50:11,974: Model SQL (customers_first_purchase_proc):
SELECT 
client, 
customer_id, 
min(cast(date as date)) first_order_date,
unix_date( min(cast(date as date))) first_order_unix_date
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction`
GROUP BY client, customer_id
2018-04-18 09:50:11,978: Model SQL (segment_stats_customers_products_agg):
WITH ty as (

	SELECT
	client,
	date,
	customer_id,
	product_type,
	segment as segment_365,
	recency_days as recency_365,
	frequency as frequency_365,
	revenue as revenue_365,
	aov as aov_365,
	'' as segment_mom,
	0 as recency_mom,
	0 as frequency_mom,
	0 as revenue_mom,
	0 as aov_mom,
	'' as segment_yoy,
	0 as recency_yoy,
	0 as frequency_yoy,
	0 as revenue_yoy,
	0 as aov_yoy
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers_products`
	WHERE period = 'Rolling 365'

),

last_month as (

	SELECT
	client,
	date,
	customer_id,
	product_type,
	'' as segment_365,
	0 as recency_365,
	0 as frequency_365,
	0 as revenue_365,
	0 as aov_365,
	segment as segment_mom,
	recency_days as recency_mom,
	frequency as frequency_mom,
	revenue as revenue_mom,
	aov as aov_mom,
	'' as segment_yoy,
	0 as recency_yoy,
	0 as frequency_yoy,
	0 as revenue_yoy,
	0 as aov_yoy
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers_products`
	WHERE period = 'Rolling 365 (t-1mo)'

),

this_month_1yr as (

	SELECT
	client,
	date,
	customer_id,
	product_type,
	'' as segment_365,
	0 as recency_365,
	0 as frequency_365,
	0 as revenue_365,
	0 as aov_365,
	'' as segment_mom,
	0 as recency_mom,
	0 as frequency_mom,
	0 as revenue_mom,
	0 as aov_mom,
	segment as segment_yoy,
	recency_days as recency_yoy,
	frequency as frequency_yoy,
	revenue as revenue_yoy,
	aov as aov_yoy
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers_products`
	WHERE period = 'Rolling 365 (t-1yr)'


)

SELECT
client,
date, 
customer_id,
product_type,
ifnull(max(segment_365), '') segment_365,
ifnull(max(segment_mom), '') segment_mom,
ifnull(max(segment_yoy), '') segment_yoy,
ifnull(sum(recency_365), 0) recency_365,
ifnull(sum(frequency_365), 0) frequency_365,
ifnull(sum(revenue_365), 0) revenue_365,
ifnull(sum(aov_365), 0) aov_365,
ifnull(sum(recency_mom), 0) recency_mom,
ifnull(sum(frequency_mom), 0) frequency_mom,
ifnull(sum(revenue_mom), 0) revenue_mom,
ifnull(sum(aov_mom), 0) aov_mom,	
ifnull(sum(recency_yoy), 0) recency_yoy,
ifnull(sum(frequency_yoy), 0) frequency_yoy,
ifnull(sum(revenue_yoy), 0) revenue_yoy,
ifnull(sum(aov_yoy), 0) aov_yoy
FROM
(
	SELECT * FROM ty
	UNION ALL
	SELECT * FROM last_month
	UNION ALL
	SELECT * FROM this_month_1yr

)
GROUP BY client, date, customer_id, product_type
2018-04-18 09:50:13,198: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10da56ef0>]}
2018-04-18 09:50:13,438: 09:50:13 | 55 of 91 OK created table model agency_data_pipeline.agg_ga_campaign_by_type [CREATE TABLE in 7.80s]
2018-04-18 09:50:14,723: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10da56dd8>]}
2018-04-18 09:50:14,733: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10dab65c0>]}
2018-04-18 09:50:14,965: 09:50:14 | 59 of 91 OK created table model agency_data_pipeline.customers_first_purchase_proc [CREATE TABLE in 5.22s]
2018-04-18 09:50:15,180: 09:50:15 | 57 of 91 OK created table model agency_data_pipeline.agg_transaction_daily [CREATE TABLE in 9.32s]
2018-04-18 09:50:41,349: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ac20208>]}
2018-04-18 09:50:42,226: 09:50:42 | 60 of 91 OK created table model agency_data_pipeline.segment_stats_customers_products_agg [CREATE TABLE in 31.58s]
2018-04-18 09:50:42,227: 09:50:42 | 61 of 91 START table model agency_data_pipeline.customers_proc....... [RUN]
2018-04-18 09:50:42,228: Compiling model.agency_data_pipeline.customers_proc
2018-04-18 09:50:42,239: Writing injected SQL for node "model.agency_data_pipeline.customers_proc"
2018-04-18 09:50:42,227: 09:50:42 | 62 of 91 START table model agency_data_pipeline.segment_stats_customers_products [RUN]
2018-04-18 09:50:42,240: Compiling model.agency_data_pipeline.segment_stats_customers_products
2018-04-18 09:50:42,251: Writing injected SQL for node "model.agency_data_pipeline.segment_stats_customers_products"
2018-04-18 09:50:42,253: Acquiring new bigquery connection "segment_stats_customers_products".
2018-04-18 09:50:42,253: Re-using an available connection from the pool.
2018-04-18 09:50:42,258: Acquiring new bigquery connection "customers_proc".
2018-04-18 09:50:42,258: Re-using an available connection from the pool.
2018-04-18 09:50:42,228: 09:50:42 | 63 of 91 START table model agency_data_pipeline.growth_customer_0_365 [RUN]
2018-04-18 09:50:42,262: Compiling model.agency_data_pipeline.growth_customer_0_365
2018-04-18 09:50:42,292: Writing injected SQL for node "model.agency_data_pipeline.growth_customer_0_365"
2018-04-18 09:50:42,296: Acquiring new bigquery connection "growth_customer_0_365".
2018-04-18 09:50:42,296: Re-using an available connection from the pool.
2018-04-18 09:50:45,283: Model SQL (segment_stats_customers_products):
SELECT
client,
date,
product_type,
segment_365,
segment_mom,
segment_yoy,
count(distinct(customer_id)) customers,
avg(recency_365) recency_365,
sum(frequency_365) frequency_365,
sum(revenue_365) revenue_365,
case when sum(frequency_365) > 0 then sum(revenue_365)/sum(frequency_365) else null end as aov_365,
avg(recency_mom) recency_mom,
sum(frequency_mom) frequency_mom,
sum(revenue_mom) revenue_mom,
case when sum(frequency_mom) > 0 then sum(revenue_mom)/sum(frequency_mom) else null end as aov_mom,
avg(recency_yoy) recency_yoy,
sum(frequency_yoy) frequency_yoy,
sum(revenue_yoy) revenue_yoy,
case when sum(frequency_yoy) > 0 then sum(revenue_yoy)/sum(frequency_yoy) else null end as aov_yoy
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_stats_customers_products_agg`
GROUP BY client, date, product_type, segment_365, segment_mom, segment_yoy
2018-04-18 09:50:45,344: Model SQL (customers_proc):
WITH customers AS (
  SELECT 
  client, 
  customer_id, 
  order_number,
  cast(date as date) order_date,
  unix_date(cast(date as date)) unix_order_date, 
  quantity,
  revenue 
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)
 
SELECT 
client,
period,
customer_id,
date,
window_end_unix_date,
window_end_unix_date - 365 as window_start_unix_date,
window_end_unix_date - unix_date(recent_order) recency_days,
frequency,
quantity,
revenue,
case when frequency > 0 then revenue/frequency else 0 end as aov
FROM 
(  

  SELECT 
  client,
  'Rolling 365' as period,
  customer_id,
  date_in_range date,
  unix_date_in_range,
  unix_date_in_range window_end_unix_date,
  max(order_date) recent_order,
  sum(quantity) as quantity,
  sum(revenue) as revenue,
  count(distinct(order_number)) as frequency
  FROM daterange
  JOIN customers
  ON customers.unix_order_date > ( daterange.unix_date_in_range - 365 )
  AND customers.unix_order_date <= daterange.unix_date_in_range
  GROUP BY client, customer_id, date, unix_date_in_range

  UNION ALL

  SELECT 
  client,
  'Rolling 365 (t-1mo)' as period,
  customer_id,
  date_in_range date,
  unix_date_in_range,
  unix_date_in_range - 30 window_end_unix_date, 
  max(order_date) recent_order,
  sum(quantity) as quantity,
  sum(revenue) as revenue,
  count(distinct(order_number)) as frequency
  FROM daterange
  JOIN customers
  ON customers.unix_order_date > ( daterange.unix_date_in_range - 395 )
  AND customers.unix_order_date <= ( daterange.unix_date_in_range - 30 )
  GROUP BY client, customer_id, date, unix_date_in_range

  UNION ALL

  SELECT 
  client,
  'Rolling 365 (t-1yr)' as period,
  customer_id,
  date_in_range date,
  unix_date_in_range, 
  unix_date_in_range - 365 window_end_unix_date, 
  max(order_date) recent_order,
  sum(quantity) as quantity,
  sum(revenue) as revenue,
  count(distinct(order_number)) as frequency
  FROM daterange
  JOIN customers
  ON customers.unix_order_date > ( daterange.unix_date_in_range - 730 )
  AND customers.unix_order_date <= ( daterange.unix_date_in_range - 365 )
  GROUP BY client, customer_id, date, unix_date_in_range

)
2018-04-18 09:50:45,362: Model SQL (growth_customer_0_365):
WITH transactions AS (
  SELECT 
  client, 
  customer_id, 
  order_number,
  unix_date(cast(date as date)) d, 
  quantity,
  revenue,
  shipping_revenue
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)

SELECT 
date_in_range date,
unix_date_in_range, 
unix_date_in_range_yoy, 
client, 
customer_id,
count(distinct(order_number)) orders,
sum(quantity) quantity,
sum(revenue) revenue,
sum(shipping_revenue) shipping_revenue
FROM daterange
JOIN transactions
ON transactions.d >= ( daterange.unix_date_in_range - 365 ) 
AND transactions.d <= daterange.unix_date_in_range
GROUP BY date, unix_date_in_range, unix_date_in_range_yoy, client, customer_id
2018-04-18 09:50:58,323: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10dab6438>]}
2018-04-18 09:50:58,611: 09:50:58 | 62 of 91 OK created table model agency_data_pipeline.segment_stats_customers_products [CREATE TABLE in 16.08s]
2018-04-18 09:51:03,856: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d959d68>]}
2018-04-18 09:51:04,179: 09:51:04 | 63 of 91 OK created table model agency_data_pipeline.growth_customer_0_365 [CREATE TABLE in 21.59s]
2018-04-18 09:51:18,059: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10dab3940>]}
2018-04-18 09:51:18,773: 09:51:18 | 61 of 91 OK created table model agency_data_pipeline.customers_proc.. [CREATE TABLE in 35.83s]
2018-04-18 09:51:18,774: 09:51:18 | 64 of 91 START table model agency_data_pipeline.retention_730_plus... [RUN]
2018-04-18 09:51:18,775: Compiling model.agency_data_pipeline.retention_730_plus
2018-04-18 09:51:18,775: 09:51:18 | 65 of 91 START table model agency_data_pipeline.retention_0_365...... [RUN]
2018-04-18 09:51:18,775: 09:51:18 | 66 of 91 START table model agency_data_pipeline.segment_list_customers_products [RUN]
2018-04-18 09:51:18,776: 09:51:18 | 67 of 91 START table model agency_data_pipeline.retention_30_60...... [RUN]
2018-04-18 09:51:18,782: Compiling model.agency_data_pipeline.retention_0_365
2018-04-18 09:51:18,789: Writing injected SQL for node "model.agency_data_pipeline.retention_730_plus"
2018-04-18 09:51:18,789: Compiling model.agency_data_pipeline.segment_list_customers_products
2018-04-18 09:51:18,789: Compiling model.agency_data_pipeline.retention_30_60
2018-04-18 09:51:18,797: Writing injected SQL for node "model.agency_data_pipeline.retention_0_365"
2018-04-18 09:51:18,803: Writing injected SQL for node "model.agency_data_pipeline.segment_list_customers_products"
2018-04-18 09:51:18,816: Acquiring new bigquery connection "retention_730_plus".
2018-04-18 09:51:18,817: Writing injected SQL for node "model.agency_data_pipeline.retention_30_60"
2018-04-18 09:51:18,817: Re-using an available connection from the pool.
2018-04-18 09:51:18,822: Acquiring new bigquery connection "segment_list_customers_products".
2018-04-18 09:51:18,831: Re-using an available connection from the pool.
2018-04-18 09:51:18,824: Acquiring new bigquery connection "retention_0_365".
2018-04-18 09:51:18,833: Re-using an available connection from the pool.
2018-04-18 09:51:18,840: Acquiring new bigquery connection "retention_30_60".
2018-04-18 09:51:18,841: Re-using an available connection from the pool.
2018-04-18 09:51:19,743: Model SQL (segment_list_customers_products):
SELECT
a.client,
period,
date,
customer_id,
product_type,
b.first_name,
b.last_name,
b.email,
recency_days,
frequency,
revenue,
quantity,
aov,
segment
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers_products` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`agg_customers_union` b
ON (
	a.client = b.client AND
	a.customer_id = b.id
)
2018-04-18 09:51:19,744: Model SQL (retention_730_plus):
WITH transactions AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_daily`
),

daterange AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`  	
),

temp AS (
  SELECT 
  client, 
  customer_id, 
  unix_date(date) d, 
  quantity,
  revenue,
  order_count
  FROM transactions
)

SELECT 
date_in_range date, 
unix_date_in_range,
client, 
customer_id,
sum(quantity) quantity,
sum(revenue) revenue,
sum(order_count) order_count
FROM daterange
JOIN temp
ON temp.d <= ( daterange.unix_date_in_range - 730 ) 
group by date_in_range, unix_date_in_range, client, customer_id
2018-04-18 09:51:19,744: Model SQL (retention_0_365):
WITH transactions AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_daily`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
),

temp AS (
  SELECT 
  client, 
  customer_id, 
  unix_date(date) d, 
  quantity,
  revenue,
  order_count
  FROM transactions
)

SELECT 
date_in_range date,
unix_date_in_range, 
client, 
customer_id,
sum(quantity) quantity,
sum(revenue) revenue,
sum(order_count) order_count
FROM daterange
JOIN temp
ON temp.d >= ( daterange.unix_date_in_range - 365 ) 
AND temp.d <= daterange.unix_date_in_range
group by date_in_range, unix_date_in_range, client, customer_id
2018-04-18 09:51:19,776: Model SQL (retention_30_60):
WITH transactions AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_daily`
),

daterange AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`  	
),

temp AS (
  SELECT 
  client, 
  customer_id, 
  unix_date(date) d, 
  quantity,
  revenue,
  order_count
  FROM transactions
)

SELECT 
date_in_range date, 
unix_date_in_range,
client, 
customer_id,
sum(quantity) quantity,
sum(revenue) revenue,
sum(order_count) order_count
FROM daterange
JOIN temp
ON ( temp.d >= ( daterange.unix_date_in_range_bom_mom ) 
AND temp.d < ( daterange.unix_date_in_range_bom ) )
group by date_in_range, unix_date_in_range, client, customer_id
2018-04-18 09:51:21,980: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10aca0cf8>]}
2018-04-18 09:51:22,295: 09:51:22 | 64 of 91 OK created table model agency_data_pipeline.retention_730_plus [CREATE TABLE in 3.21s]
2018-04-18 09:51:22,296: 09:51:22 | 68 of 91 START table model agency_data_pipeline.retention_365_730.... [RUN]
2018-04-18 09:51:22,296: Compiling model.agency_data_pipeline.retention_365_730
2018-04-18 09:51:22,305: Writing injected SQL for node "model.agency_data_pipeline.retention_365_730"
2018-04-18 09:51:22,307: Acquiring new bigquery connection "retention_365_730".
2018-04-18 09:51:22,307: Re-using an available connection from the pool.
2018-04-18 09:51:23,007: Model SQL (retention_365_730):
WITH transactions AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_daily`
),

daterange AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`  	
),

temp AS (
  SELECT 
  client, 
  customer_id, 
  unix_date(date) d, 
  quantity,
  revenue,
  order_count
  FROM transactions
)

SELECT 
date_in_range date, 
unix_date_in_range,
client, 
customer_id,
sum(quantity) quantity,
sum(revenue) revenue,
sum(order_count) order_count
FROM daterange
JOIN temp
ON ( temp.d >= ( daterange.unix_date_in_range - 730 ) 
AND temp.d < ( daterange.unix_date_in_range - 365 ) )
group by date_in_range, unix_date_in_range, client, customer_id
2018-04-18 09:51:24,555: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10aca0f98>]}
2018-04-18 09:51:25,012: 09:51:25 | 67 of 91 OK created table model agency_data_pipeline.retention_30_60. [CREATE TABLE in 5.77s]
2018-04-18 09:51:25,013: 09:51:25 | 69 of 91 START table model agency_data_pipeline.retention_60_plus.... [RUN]
2018-04-18 09:51:25,013: Compiling model.agency_data_pipeline.retention_60_plus
2018-04-18 09:51:25,024: Writing injected SQL for node "model.agency_data_pipeline.retention_60_plus"
2018-04-18 09:51:25,025: Acquiring new bigquery connection "retention_60_plus".
2018-04-18 09:51:25,025: Re-using an available connection from the pool.
2018-04-18 09:51:25,962: Model SQL (retention_60_plus):
WITH transactions AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_daily`
),

daterange AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`  	
),

temp AS (
  SELECT 
  client, 
  customer_id, 
  unix_date(date) d, 
  quantity,
  revenue,
  order_count
  FROM transactions
)

SELECT 
date_in_range date, 
unix_date_in_range,
client, 
customer_id,
sum(quantity) quantity,
sum(revenue) revenue,
sum(order_count) order_count
FROM daterange
JOIN temp
ON temp.d < ( daterange.unix_date_in_range_bom_mom ) 
group by date_in_range, unix_date_in_range, client, customer_id
2018-04-18 09:51:27,007: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ac20240>]}
2018-04-18 09:51:27,696: 09:51:27 | 68 of 91 OK created table model agency_data_pipeline.retention_365_730 [CREATE TABLE in 4.71s]
2018-04-18 09:51:27,696: 09:51:27 | 70 of 91 START table model agency_data_pipeline.retention_0_30....... [RUN]
2018-04-18 09:51:27,696: Compiling model.agency_data_pipeline.retention_0_30
2018-04-18 09:51:27,707: Writing injected SQL for node "model.agency_data_pipeline.retention_0_30"
2018-04-18 09:51:27,708: Acquiring new bigquery connection "retention_0_30".
2018-04-18 09:51:27,709: Re-using an available connection from the pool.
2018-04-18 09:51:28,483: Model SQL (retention_0_30):
WITH transactions AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_daily`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
),

temp AS (
  SELECT 
  client, 
  customer_id, 
  unix_date(date) d, 
  quantity,
  revenue,
  order_count
  FROM transactions
)

SELECT 
date_in_range date,
unix_date_in_range, 
client, 
customer_id,
sum(quantity) quantity,
sum(revenue) revenue,
sum(order_count) order_count
FROM daterange
JOIN temp
ON temp.d >= ( daterange.unix_date_in_range_bom ) 
AND temp.d <= daterange.unix_date_in_range
group by date_in_range, unix_date_in_range, client, customer_id
2018-04-18 09:51:31,504: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ac29048>]}
2018-04-18 09:51:31,770: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ac20240>]}
2018-04-18 09:51:31,798: 09:51:31 | 65 of 91 OK created table model agency_data_pipeline.retention_0_365. [CREATE TABLE in 12.72s]
2018-04-18 09:51:32,105: 09:51:32 | 70 of 91 OK created table model agency_data_pipeline.retention_0_30.. [CREATE TABLE in 4.07s]
2018-04-18 09:51:37,830: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ac157f0>]}
2018-04-18 09:51:38,535: 09:51:38 | 69 of 91 OK created table model agency_data_pipeline.retention_60_plus [CREATE TABLE in 12.82s]
2018-04-18 09:52:02,205: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ac79470>]}
2018-04-18 09:52:03,067: 09:52:03 | 66 of 91 OK created table model agency_data_pipeline.segment_list_customers_products [CREATE TABLE in 43.41s]
2018-04-18 09:52:03,070: 09:52:03 | 71 of 91 START table model agency_data_pipeline.segment_proc_customers [RUN]
2018-04-18 09:52:03,070: 09:52:03 | 72 of 91 START table model agency_data_pipeline.agg_platforms_union.. [RUN]
2018-04-18 09:52:03,070: Compiling model.agency_data_pipeline.segment_proc_customers
2018-04-18 09:52:03,071: Compiling model.agency_data_pipeline.agg_platforms_union
2018-04-18 09:52:03,087: Writing injected SQL for node "model.agency_data_pipeline.segment_proc_customers"
2018-04-18 09:52:03,090: Writing injected SQL for node "model.agency_data_pipeline.agg_platforms_union"
2018-04-18 09:52:03,094: Acquiring new bigquery connection "segment_proc_customers".
2018-04-18 09:52:03,094: Re-using an available connection from the pool.
2018-04-18 09:52:03,096: Acquiring new bigquery connection "agg_platforms_union".
2018-04-18 09:52:03,096: Re-using an available connection from the pool.
2018-04-18 09:52:04,030: Model SQL (segment_proc_customers):
SELECT
client,
period,
date,
customer_id,
first_order_date,
first_order_unix_date,
recency_days,
frequency,
revenue,
quantity,
aov,
case when recency_days <= 30 and first_order_unix_date >= window_start_unix_date then 'New'
	when frequency = 1 and recency_days <= 90 and aov >= aov_40pct then 'Promising'
	when frequency = 1 then 'One-time Purchaser'
	when frequency >= frequency_90pct and recency_days <= 90 and aov > aov_40pct then 'Whale'
	when recency_days <= 240 and frequency > frequency_50pct then 'Loyal'
	when recency_days <= 90 and frequency > frequency_50pct then 'Potential Loyalists' 
	when recency_days > 240 and frequency > frequency_50pct then 'Defecting Good Customer'	
	when recency_days > recency_50pct and frequency > frequency_50pct then 'Frequent, not Recent'
	when recency_days < recency_50pct and frequency < frequency_50pct then 'Recent, not Frequent'
	else 'Unbucketed' end as segment,
aov_40pct,
frequency_90pct,
frequency_75pct,
frequency_50pct,
recency_50pct
FROM
(
	SELECT 
	a.client client,
	period,
	date,
	a.customer_id customer_id,
	b.first_order_date first_order_date,
	b.first_order_unix_date first_order_unix_date,
	window_start_unix_date,
	window_end_unix_date,
	recency_days,
	frequency,
	revenue,
	quantity,
	aov,
	PERCENTILE_CONT(aov, 0.40) OVER w1 AS aov_40pct,
	PERCENTILE_CONT(frequency, 0.90) OVER w1 AS frequency_90pct,
	PERCENTILE_CONT(frequency, 0.75) OVER w1 AS frequency_75pct,
	PERCENTILE_CONT(frequency, 0.50) OVER w1 AS frequency_50pct,
	PERCENTILE_CONT(recency_days, 0.5) OVER w1 AS recency_50pct
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`customers_proc` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`customers_first_purchase_proc` b
	ON (
		a.client = b.client and
		a.customer_id = b.customer_id
		)
	WINDOW w1 as (PARTITION BY a.client, period, date)
)
2018-04-18 09:52:04,295: Model SQL (agg_platforms_union):
SELECT 
date, 
account, 
channel,
platform,
url,
utm_campaign,
campaign,
cost,
impressions,
clicks,
transactions
FROM 
`growth-engines-pipeline`.`agency_data_pipeline`.`adwords_stats`

UNION ALL

SELECT 
date, 
account, 
channel,
platform,
url,
utm_campaign,
campaign,
cost,
impressions,
clicks,
transactions
FROM 
`growth-engines-pipeline`.`agency_data_pipeline`.`bing_ads_stats`

UNION ALL  

SELECT 
date, 
account, 
channel,
platform,
url,
utm_campaign,
campaign,
cost,
impressions,
clicks,
transactions
FROM 
`growth-engines-pipeline`.`agency_data_pipeline`.`fb_ads_stats`
2018-04-18 09:52:08,718: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ac20c50>]}
2018-04-18 09:52:09,019: 09:52:09 | 72 of 91 OK created table model agency_data_pipeline.agg_platforms_union [CREATE TABLE in 5.65s]
2018-04-18 09:52:38,572: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10dab3940>]}
2018-04-18 09:52:38,851: 09:52:38 | 71 of 91 OK created table model agency_data_pipeline.segment_proc_customers [CREATE TABLE in 35.50s]
2018-04-18 09:52:38,852: 09:52:38 | 73 of 91 START table model agency_data_pipeline.retention_0_365_rebuy [RUN]
2018-04-18 09:52:38,853: Compiling model.agency_data_pipeline.retention_0_365_rebuy
2018-04-18 09:52:38,852: 09:52:38 | 74 of 91 START table model agency_data_pipeline.retention_0_30_rebuy. [RUN]
2018-04-18 09:52:38,860: Writing injected SQL for node "model.agency_data_pipeline.retention_0_365_rebuy"
2018-04-18 09:52:38,860: Compiling model.agency_data_pipeline.retention_0_30_rebuy
2018-04-18 09:52:38,853: 09:52:38 | 75 of 91 START table model agency_data_pipeline.segment_stats_customers_agg [RUN]
2018-04-18 09:52:38,866: Writing injected SQL for node "model.agency_data_pipeline.retention_0_30_rebuy"
2018-04-18 09:52:38,866: Compiling model.agency_data_pipeline.segment_stats_customers_agg
2018-04-18 09:52:38,867: Acquiring new bigquery connection "retention_0_365_rebuy".
2018-04-18 09:52:38,874: Writing injected SQL for node "model.agency_data_pipeline.segment_stats_customers_agg"
2018-04-18 09:52:38,874: Re-using an available connection from the pool.
2018-04-18 09:52:38,877: Acquiring new bigquery connection "segment_stats_customers_agg".
2018-04-18 09:52:38,878: Acquiring new bigquery connection "retention_0_30_rebuy".
2018-04-18 09:52:38,879: Re-using an available connection from the pool.
2018-04-18 09:52:38,879: Re-using an available connection from the pool.
2018-04-18 09:52:39,823: Model SQL (retention_0_365_rebuy):
SELECT 
r2.client,
r2.date,
r2.customer_id, 
r2.quantity,
r2.revenue
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_365_730` r1 
left join `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365` r2 
  on ( r1.customer_id = r2.customer_id 
  and r1.date = r2.date )
2018-04-18 09:52:39,824: Model SQL (retention_0_30_rebuy):
SELECT 
r2.client,
r2.date,
r2.customer_id, 
r2.quantity,
r2.revenue
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_30_60` r1 
left join `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30` r2 
  on ( r1.customer_id = r2.customer_id 
  and r1.date = r2.date )
2018-04-18 09:52:39,832: Model SQL (segment_stats_customers_agg):
WITH ty as (

	SELECT
	client,
	date,
	customer_id,
	segment as segment_365,
	recency_days as recency_365,
	frequency as frequency_365,
	revenue as revenue_365,
	aov as aov_365,
	'' as segment_mom,
	0 as recency_mom,
	0 as frequency_mom,
	0 as revenue_mom,
	0 as aov_mom,
	'' as segment_yoy,
	0 as recency_yoy,
	0 as frequency_yoy,
	0 as revenue_yoy,
	0 as aov_yoy
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers`
	WHERE period = 'Rolling 365'

),

last_month as (

	SELECT
	client,
	date,
	customer_id,
	'' as segment_365,
	0 as recency_365,
	0 as frequency_365,
	0 as revenue_365,
	0 as aov_365,
	segment as segment_mom,
	recency_days as recency_mom,
	frequency as frequency_mom,
	revenue as revenue_mom,
	aov as aov_mom,
	'' as segment_yoy,
	0 as recency_yoy,
	0 as frequency_yoy,
	0 as revenue_yoy,
	0 as aov_yoy
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers`
	WHERE period = 'Rolling 365 (t-1mo)'

),

this_month_1yr as (

	SELECT
	client,
	date,
	customer_id,
	'' as segment_365,
	0 as recency_365,
	0 as frequency_365,
	0 as revenue_365,
	0 as aov_365,
	'' as segment_mom,
	0 as recency_mom,
	0 as frequency_mom,
	0 as revenue_mom,
	0 as aov_mom,
	segment as segment_yoy,
	recency_days as recency_yoy,
	frequency as frequency_yoy,
	revenue as revenue_yoy,
	aov as aov_yoy
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers`
	WHERE period = 'Rolling 365 (t-1yr)'


)

SELECT
client,
date, 
customer_id,
ifnull(max(segment_365), '') segment_365,
ifnull(max(segment_mom), '') segment_mom,
ifnull(max(segment_yoy), '') segment_yoy,
ifnull(sum(recency_365), 0) recency_365,
ifnull(sum(frequency_365), 0) frequency_365,
ifnull(sum(revenue_365), 0) revenue_365,
ifnull(sum(aov_365), 0) aov_365,
ifnull(sum(recency_mom), 0) recency_mom,
ifnull(sum(frequency_mom), 0) frequency_mom,
ifnull(sum(revenue_mom), 0) revenue_mom,
ifnull(sum(aov_mom), 0) aov_mom,	
ifnull(sum(recency_yoy), 0) recency_yoy,
ifnull(sum(frequency_yoy), 0) frequency_yoy,
ifnull(sum(revenue_yoy), 0) revenue_yoy,
ifnull(sum(aov_yoy), 0) aov_yoy
FROM
(
	SELECT * FROM ty
	UNION ALL
	SELECT * FROM last_month
	UNION ALL
	SELECT * FROM this_month_1yr

)
GROUP BY client, date, customer_id
2018-04-18 09:52:42,044: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ac55048>]}
2018-04-18 09:52:42,283: 09:52:42 | 74 of 91 OK created table model agency_data_pipeline.retention_0_30_rebuy [CREATE TABLE in 3.18s]
2018-04-18 09:52:44,232: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10acac8d0>]}
2018-04-18 09:52:44,462: 09:52:44 | 73 of 91 OK created table model agency_data_pipeline.retention_0_365_rebuy [CREATE TABLE in 5.38s]
2018-04-18 09:53:03,007: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d9f0a58>]}
2018-04-18 09:53:03,772: 09:53:03 | 75 of 91 OK created table model agency_data_pipeline.segment_stats_customers_agg [CREATE TABLE in 24.14s]
2018-04-18 09:53:03,773: 09:53:03 | 76 of 91 START table model agency_data_pipeline.retention_0_30_new... [RUN]
2018-04-18 09:53:03,774: Compiling model.agency_data_pipeline.retention_0_30_new
2018-04-18 09:53:03,773: 09:53:03 | 77 of 91 START table model agency_data_pipeline.agg_platforms_client. [RUN]
2018-04-18 09:53:03,786: Compiling model.agency_data_pipeline.agg_platforms_client
2018-04-18 09:53:03,789: Writing injected SQL for node "model.agency_data_pipeline.retention_0_30_new"
2018-04-18 09:53:03,773: 09:53:03 | 78 of 91 START table model agency_data_pipeline.retention_stats_rebuy_rate_month [RUN]
2018-04-18 09:53:03,797: Writing injected SQL for node "model.agency_data_pipeline.agg_platforms_client"
2018-04-18 09:53:03,773: 09:53:03 | 79 of 91 START table model agency_data_pipeline.segment_stats_customers [RUN]
2018-04-18 09:53:03,798: Compiling model.agency_data_pipeline.retention_stats_rebuy_rate_month
2018-04-18 09:53:03,799: Compiling model.agency_data_pipeline.segment_stats_customers
2018-04-18 09:53:03,808: Writing injected SQL for node "model.agency_data_pipeline.retention_stats_rebuy_rate_month"
2018-04-18 09:53:03,818: Acquiring new bigquery connection "retention_stats_rebuy_rate_month".
2018-04-18 09:53:03,821: Acquiring new bigquery connection "retention_0_30_new".
2018-04-18 09:53:03,824: Writing injected SQL for node "model.agency_data_pipeline.segment_stats_customers"
2018-04-18 09:53:03,825: Acquiring new bigquery connection "agg_platforms_client".
2018-04-18 09:53:03,825: Re-using an available connection from the pool.
2018-04-18 09:53:03,826: Re-using an available connection from the pool.
2018-04-18 09:53:03,827: Acquiring new bigquery connection "segment_stats_customers".
2018-04-18 09:53:03,831: Re-using an available connection from the pool.
2018-04-18 09:53:03,836: Re-using an available connection from the pool.
2018-04-18 09:53:04,786: Model SQL (retention_stats_rebuy_rate_month):
WITH r1 AS (
	SELECT 
	date,
	client,
	count(distinct customer_id) customers_prior_year,
	0 as customers_current_year, 
	sum(quantity) quantity_prior_year,
	0 as quantity_current_year,
	sum(revenue) revenue_prior_year,
	0 as revenue_current_year,
	case when sum(quantity) > 0 then sum(revenue)/sum(quantity) else null end as aov_prior_year,
	null as aov_current_year
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_30_60`
	group by date, client
),

r2 AS (
	SELECT 
	date,
	client,
	0 as customers_prior_year,
	count(distinct customer_id) customers_current_year, 
	0 as quantity_prior_year,
	sum(quantity) quantity_current_year,
	0 as revenue_prior_year,
	sum(revenue) revenue_current_year,
	null as aov_prior_year,
	case when sum(quantity) > 0 then sum(revenue)/sum(quantity) else null end as aov_current_year
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30_rebuy`
	group by date, client
)

SELECT 
date,
client,
sum(customers_prior_year) customers_prior_year, 
sum(customers_current_year) customers_current_year,
sum(quantity_prior_year) quantity_prior_year,
sum(quantity_current_year) quantity_current_year,
sum(revenue_prior_year) revenue_prior_year,
sum(revenue_current_year) revenue_current_year,
sum(aov_prior_year) aov_prior_year,
sum(aov_current_year) aov_current_year,
case when sum(revenue_prior_year) > 0 then sum(revenue_current_year)/sum(revenue_prior_year) else null end as revenue_retention,
case when sum(customers_prior_year) > 0 then sum(customers_current_year)/sum(customers_prior_year) else null end as customer_retention
FROM
(
	SELECT
	date,
	client,
	customers_prior_year,
	customers_current_year,
	quantity_prior_year,
	quantity_current_year,
	revenue_prior_year,
	revenue_current_year,
	aov_prior_year,
	aov_current_year
	FROM r1

	UNION ALL

	SELECT
	date,
	client,
	customers_prior_year,
	customers_current_year,
	quantity_prior_year,
	quantity_current_year,
	revenue_prior_year,
	revenue_current_year,
	aov_prior_year,
	aov_current_year
	FROM r2

) 
GROUP BY date, client
2018-04-18 09:53:04,806: Model SQL (agg_platforms_client):
SELECT 
date, 
a.account account, 
b.client client,
a.platform platform,
a.channel channel,
url,
utm_campaign,
campaign,
cost,
impressions,
clicks,
transactions ad_platform_transactions
FROM 
  `growth-engines-pipeline`.`agency_data_pipeline`.`agg_platforms_union` a
LEFT JOIN 
  `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc` b
ON ( 
  a.account = b.account AND
  a.platform = b.platform
)
2018-04-18 09:53:04,813: Model SQL (retention_0_30_new):
SELECT 
a.client,
a.date,
a.customer_id, 
a.quantity,
a.revenue,
a.order_count
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_60_plus` b
ON (
	a.client = b.client AND
	a.date = b.date AND
	a.customer_id = b.customer_id
)
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_30_60` c
ON (
	a.client = c.client AND
	a.date = c.date AND
	a.customer_id = c.customer_id
)
WHERE b.customer_id is null 
and c.customer_id is null
2018-04-18 09:53:04,837: Model SQL (segment_stats_customers):
SELECT
client,
date,
segment_365,
segment_mom,
segment_yoy,
count(distinct(customer_id)) customers,
avg(recency_365) recency_365,
sum(frequency_365) frequency_365,
sum(revenue_365) revenue_365,
case when sum(frequency_365) > 0 then sum(revenue_365)/sum(frequency_365) else null end as aov_365,
avg(recency_mom) recency_mom,
sum(frequency_mom) frequency_mom,
sum(revenue_mom) revenue_mom,
case when sum(frequency_mom) > 0 then sum(revenue_mom)/sum(frequency_mom) else null end as aov_mom,
avg(recency_yoy) recency_yoy,
sum(frequency_yoy) frequency_yoy,
sum(revenue_yoy) revenue_yoy,
case when sum(frequency_yoy) > 0 then sum(revenue_yoy)/sum(frequency_yoy) else null end as aov_yoy
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_stats_customers_agg`
GROUP BY client, date, segment_365, segment_mom, segment_yoy
2018-04-18 09:53:06,987: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ac20470>]}
2018-04-18 09:53:07,256: 09:53:07 | 78 of 91 OK created table model agency_data_pipeline.retention_stats_rebuy_rate_month [CREATE TABLE in 3.19s]
2018-04-18 09:53:07,256: 09:53:07 | 80 of 91 START table model agency_data_pipeline.retention_0_365_new.. [RUN]
2018-04-18 09:53:07,257: Compiling model.agency_data_pipeline.retention_0_365_new
2018-04-18 09:53:07,263: Writing injected SQL for node "model.agency_data_pipeline.retention_0_365_new"
2018-04-18 09:53:07,265: Acquiring new bigquery connection "retention_0_365_new".
2018-04-18 09:53:07,265: Re-using an available connection from the pool.
2018-04-18 09:53:07,982: Model SQL (retention_0_365_new):
SELECT 
a.client,
a.date,
a.customer_id, 
a.quantity,
a.revenue,
a.order_count
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_730_plus` b
ON (
	a.client = b.client AND
	a.date = b.date AND
	a.customer_id = b.customer_id
)
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_365_730` c
ON (
	a.client = c.client AND
	a.date = c.date AND
	a.customer_id = c.customer_id
)
WHERE b.customer_id is null 
and c.customer_id is null
2018-04-18 09:53:09,288: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10acabef0>]}
2018-04-18 09:53:09,531: 09:53:09 | 77 of 91 OK created table model agency_data_pipeline.agg_platforms_client [CREATE TABLE in 5.50s]
2018-04-18 09:53:09,531: 09:53:09 | 81 of 91 START table model agency_data_pipeline.retention_0_365_reactivated [RUN]
2018-04-18 09:53:09,532: Compiling model.agency_data_pipeline.retention_0_365_reactivated
2018-04-18 09:53:09,542: Writing injected SQL for node "model.agency_data_pipeline.retention_0_365_reactivated"
2018-04-18 09:53:09,544: Acquiring new bigquery connection "retention_0_365_reactivated".
2018-04-18 09:53:09,544: Re-using an available connection from the pool.
2018-04-18 09:53:10,341: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10dab3940>]}
2018-04-18 09:53:10,606: Model SQL (retention_0_365_reactivated):
SELECT 
a.client,
a.date,
a.customer_id, 
a.quantity,
a.revenue
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_730_plus` b
ON (
	a.client = b.client AND
	a.date = b.date AND
	a.customer_id = b.customer_id
)
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_365_730` c
ON (
	a.client = c.client AND
	a.date = c.date AND
	a.customer_id = c.customer_id
)
WHERE b.customer_id is not null 
AND c.customer_id is null
2018-04-18 09:53:10,681: 09:53:10 | 76 of 91 OK created table model agency_data_pipeline.retention_0_30_new [CREATE TABLE in 6.57s]
2018-04-18 09:53:10,681: 09:53:10 | 82 of 91 START table model agency_data_pipeline.retention_stats_rebuy_rate [RUN]
2018-04-18 09:53:10,682: Compiling model.agency_data_pipeline.retention_stats_rebuy_rate
2018-04-18 09:53:10,694: Writing injected SQL for node "model.agency_data_pipeline.retention_stats_rebuy_rate"
2018-04-18 09:53:10,695: Acquiring new bigquery connection "retention_stats_rebuy_rate".
2018-04-18 09:53:10,695: Re-using an available connection from the pool.
2018-04-18 09:53:11,561: Model SQL (retention_stats_rebuy_rate):
WITH r1 AS (
	SELECT 
	date,
	client,
	count(distinct customer_id) customers_prior_year,
	0 as customers_current_year, 
	sum(quantity) quantity_prior_year,
	0 as quantity_current_year,
	sum(revenue) revenue_prior_year,
	0 as revenue_current_year,
	case when sum(quantity) > 0 then sum(revenue)/sum(quantity) else null end as aov_prior_year,
	null as aov_current_year
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_365_730`
	group by date, client
),

r2 AS (
	SELECT 
	date,
	client,
	0 as customers_prior_year,
	count(distinct customer_id) customers_current_year, 
	0 as quantity_prior_year,
	sum(quantity) quantity_current_year,
	0 as revenue_prior_year,
	sum(revenue) revenue_current_year,
	null as aov_prior_year,
	case when sum(quantity) > 0 then sum(revenue)/sum(quantity) else null end as aov_current_year
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365_rebuy`
	group by date, client
)

SELECT 
date,
client,
sum(customers_prior_year) customers_prior_year, 
sum(customers_current_year) customers_current_year,
sum(quantity_prior_year) quantity_prior_year,
sum(quantity_current_year) quantity_current_year,
sum(revenue_prior_year) revenue_prior_year,
sum(revenue_current_year) revenue_current_year,
sum(aov_prior_year) aov_prior_year,
sum(aov_current_year) aov_current_year,
case when sum(revenue_prior_year) > 0 then sum(revenue_current_year)/sum(revenue_prior_year) else null end as revenue_retention,
case when sum(customers_prior_year) > 0 then sum(customers_current_year)/sum(customers_prior_year) else null end as customer_retention
FROM
(
	SELECT
	date,
	client,
	customers_prior_year,
	customers_current_year,
	quantity_prior_year,
	quantity_current_year,
	revenue_prior_year,
	revenue_current_year,
	aov_prior_year,
	aov_current_year
	FROM r1

	UNION ALL

	SELECT
	date,
	client,
	customers_prior_year,
	customers_current_year,
	quantity_prior_year,
	quantity_current_year,
	revenue_prior_year,
	revenue_current_year,
	aov_prior_year,
	aov_current_year
	FROM r2

) 
GROUP BY date, client
2018-04-18 09:53:14,508: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10dab3940>]}
2018-04-18 09:53:14,606: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10acabef0>]}
2018-04-18 09:53:15,922: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ac5cda0>]}
2018-04-18 09:53:15,927: 09:53:15 | 82 of 91 OK created table model agency_data_pipeline.retention_stats_rebuy_rate [CREATE TABLE in 3.83s]
2018-04-18 09:53:15,928: 09:53:15 | 83 of 91 START table model agency_data_pipeline.retention_0_30_reactivated [RUN]
2018-04-18 09:53:15,928: Compiling model.agency_data_pipeline.retention_0_30_reactivated
2018-04-18 09:53:15,937: Writing injected SQL for node "model.agency_data_pipeline.retention_0_30_reactivated"
2018-04-18 09:53:15,939: Acquiring new bigquery connection "retention_0_30_reactivated".
2018-04-18 09:53:15,939: Re-using an available connection from the pool.
2018-04-18 09:53:16,274: 09:53:16 | 81 of 91 OK created table model agency_data_pipeline.retention_0_365_reactivated [CREATE TABLE in 5.07s]
2018-04-18 09:53:16,810: 09:53:16 | 79 of 91 OK created table model agency_data_pipeline.segment_stats_customers [CREATE TABLE in 12.12s]
2018-04-18 09:53:17,646: Model SQL (retention_0_30_reactivated):
SELECT 
a.client,
a.date,
a.customer_id, 
a.quantity,
a.revenue
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_60_plus` b
ON (
	a.client = b.client AND
	a.date = b.date AND
	a.customer_id = b.customer_id
)
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_30_60` c
ON (
	a.client = c.client AND
	a.date = c.date AND
	a.customer_id = c.customer_id
)
WHERE b.customer_id is not null 
AND c.customer_id is null
2018-04-18 09:53:18,346: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ac20470>]}
2018-04-18 09:53:18,598: 09:53:18 | 80 of 91 OK created table model agency_data_pipeline.retention_0_365_new [CREATE TABLE in 11.09s]
2018-04-18 09:53:22,069: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10dab3940>]}
2018-04-18 09:53:22,436: 09:53:22 | 83 of 91 OK created table model agency_data_pipeline.retention_0_30_reactivated [CREATE TABLE in 6.14s]
2018-04-18 09:53:22,437: 09:53:22 | 84 of 91 START table model agency_data_pipeline.segment_list_customers [RUN]
2018-04-18 09:53:22,437: Compiling model.agency_data_pipeline.segment_list_customers
2018-04-18 09:53:22,447: Writing injected SQL for node "model.agency_data_pipeline.segment_list_customers"
2018-04-18 09:53:22,448: Acquiring new bigquery connection "segment_list_customers".
2018-04-18 09:53:22,448: Re-using an available connection from the pool.
2018-04-18 09:53:23,364: Model SQL (segment_list_customers):
SELECT
a.client,
period,
date,
customer_id,
b.first_name,
b.last_name,
b.email,
recency_days,
frequency,
revenue,
quantity,
aov,
segment
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`agg_customers_union` b
ON (
	a.client = b.client AND
	a.customer_id = b.id
)
2018-04-18 09:53:59,304: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d9f0a58>]}
2018-04-18 09:54:00,274: 09:54:00 | 84 of 91 OK created table model agency_data_pipeline.segment_list_customers [CREATE TABLE in 36.87s]
2018-04-18 09:54:00,275: 09:54:00 | 85 of 91 START table model agency_data_pipeline.growth_customer_0_365_segment [RUN]
2018-04-18 09:54:00,275: Compiling model.agency_data_pipeline.growth_customer_0_365_segment
2018-04-18 09:54:00,285: Writing injected SQL for node "model.agency_data_pipeline.growth_customer_0_365_segment"
2018-04-18 09:54:00,288: Acquiring new bigquery connection "growth_customer_0_365_segment".
2018-04-18 09:54:00,288: Re-using an available connection from the pool.
2018-04-18 09:54:01,599: Model SQL (growth_customer_0_365_segment):
with segment as (

	SELECT 
	a.date,
	unix_date_in_range,
	unix_date_in_range_yoy,
	a.client client,
	a.customer_id customer_id,
	case when b.customer_id is not null then 'New' else 'Existing' end as segment,
	a.orders,
	a.quantity,
	a.revenue,
	a.shipping_revenue
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_customer_0_365` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365_new` b
	ON (
	  a.customer_id = b.customer_id AND
	  a.date  = b.date AND
	  a.client = b.client
	)
),

total as (

	SELECT 
	date,
	unix_date_in_range,
	unix_date_in_range_yoy,
	client,
	customer_id,
	'Total' as segment,
	orders,
	quantity,
	revenue,
	shipping_revenue
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_customer_0_365`

)

SELECT 
date,
unix_date_in_range,
unix_date_in_range_yoy,
client,
segment,
count(distinct(customer_id)) customers,
sum(orders) orders,
sum(quantity) quantity,
sum(revenue) revenue,
sum(shipping_revenue) shipping_revenue
FROM
( 
	SELECT * FROM segment
	UNION ALL
	SELECT * FROM total
) 
GROUP BY date, unix_date_in_range, unix_date_in_range_yoy, client, segment
2018-04-18 09:54:15,053: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10dab3940>]}
2018-04-18 09:54:15,346: 09:54:15 | 85 of 91 OK created table model agency_data_pipeline.growth_customer_0_365_segment [CREATE TABLE in 14.78s]
2018-04-18 09:54:15,348: 09:54:15 | 86 of 91 START table model agency_data_pipeline.growth_date_union.... [RUN]
2018-04-18 09:54:15,348: Compiling model.agency_data_pipeline.growth_date_union
2018-04-18 09:54:15,363: Writing injected SQL for node "model.agency_data_pipeline.growth_date_union"
2018-04-18 09:54:15,364: Acquiring new bigquery connection "growth_date_union".
2018-04-18 09:54:15,364: Re-using an available connection from the pool.
2018-04-18 09:54:16,261: Model SQL (growth_date_union):
with ty as (

  SELECT 
  date,
  unix_date_in_range, 
  unix_date_in_range_yoy, 
  client, 
  segment,
  customers customers_ty,
  orders orders_ty,
  quantity quantity_ty,
  revenue revenue_ty,
  shipping_revenue shipping_revenue_ty,
  null as customers_ly,
  null as orders_ly,
  null as quantity_ly,
  null as revenue_ly,
  null as shipping_revenue_ly
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_customer_0_365_segment`

),

ly as (

  SELECT 
  date,
  0 as unix_date_in_range, 
  unix_date_in_range unix_date_in_range_yoy, 
  client, 
  segment,
  null as customers_ty,
  null as orders_ty,
  null as quantity_ty,
  null as revenue_ty,
  null as shipping_revenue_ty,
  customers customers_ly,
  orders orders_ly,
  quantity quantity_ly,
  revenue revenue_ly,
  shipping_revenue shipping_revenue_ly
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_customer_0_365_segment`

)


SELECT
max(date) date,
max(unix_date_in_range) unix_date_in_range,
unix_date_in_range_yoy,
client,
segment,
ifnull(sum(customers_ty), 0) customers_ty,
ifnull(sum(orders_ty), 0) orders_ty,
ifnull(sum(quantity_ty), 0) quantity_ty,
ifnull(sum(revenue_ty), 0) revenue_ty,
ifnull(sum(shipping_revenue_ty), 0) shipping_revenue_ty,
case when sum(orders_ty) > 0 then sum(revenue_ty)/sum(orders_ty) else null end as aov_ty,
ifnull(sum(customers_ly), 0) customers_ly,
ifnull(sum(orders_ly), 0) orders_ly,
ifnull(sum(quantity_ly), 0) quantity_ly,
ifnull(sum(revenue_ly), 0) revenue_ly,
ifnull(sum(shipping_revenue_ly), 0) shipping_revenue_ly,
case when sum(orders_ly) > 0 then sum(revenue_ly)/sum(orders_ly) else null end as aov_ly,
case when sum(orders_ly) > 0 then ( sum(orders_ty) - sum(orders_ly) ) / sum(orders_ly) else null end as order_growth,
case when sum(revenue_ly) > 0 then ( sum(revenue_ty) - sum(revenue_ly) ) / sum(revenue_ly) else null end as revenue_growth,
case when sum(customers_ly) > 0 then ( sum(customers_ty) - sum(customers_ly) ) / sum(customers_ly) else null end as customer_growth,
case when sum(orders_ly) > 0 then ( sum(revenue_ty)/sum(orders_ty) - sum(revenue_ly)/sum(orders_ly) ) / ( sum(revenue_ly)/sum(orders_ly) ) else null end as aov_growth
FROM (

  SELECT * FROM ty
  UNION ALL
  SELECT * FROM ly

)
where unix_date_in_range is not null
group by unix_date_in_range_yoy, client, segment
2018-04-18 09:54:17,380: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d9f0a58>]}
2018-04-18 09:54:17,625: 09:54:17 | 86 of 91 OK created table model agency_data_pipeline.growth_date_union [CREATE TABLE in 2.03s]
2018-04-18 09:54:17,626: 09:54:17 | 87 of 91 START table model agency_data_pipeline.retention_stats_month [RUN]
2018-04-18 09:54:17,627: 09:54:17 | 88 of 91 START table model agency_data_pipeline.retention_stats...... [RUN]
2018-04-18 09:54:17,627: Compiling model.agency_data_pipeline.retention_stats_month
2018-04-18 09:54:17,627: 09:54:17 | 89 of 91 START table model agency_data_pipeline.growth_stats......... [RUN]
2018-04-18 09:54:17,628: Compiling model.agency_data_pipeline.retention_stats
2018-04-18 09:54:17,634: Compiling model.agency_data_pipeline.growth_stats
2018-04-18 09:54:17,642: Writing injected SQL for node "model.agency_data_pipeline.retention_stats_month"
2018-04-18 09:54:17,659: Writing injected SQL for node "model.agency_data_pipeline.retention_stats"
2018-04-18 09:54:17,662: Writing injected SQL for node "model.agency_data_pipeline.growth_stats"
2018-04-18 09:54:17,665: Acquiring new bigquery connection "retention_stats_month".
2018-04-18 09:54:17,666: Acquiring new bigquery connection "retention_stats".
2018-04-18 09:54:17,667: Acquiring new bigquery connection "growth_stats".
2018-04-18 09:54:17,667: Re-using an available connection from the pool.
2018-04-18 09:54:17,667: Re-using an available connection from the pool.
2018-04-18 09:54:17,668: Re-using an available connection from the pool.
2018-04-18 09:54:18,552: Model SQL (growth_stats):
with orders as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'Orders' as metric,
  orders_ty as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`
),

order_growth as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'Order Growth' as metric,
  order_growth as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`
),

revenue as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'Revenue' as metric,
  revenue_ty as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`
),

revenue_growth as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'Revenue Growth' as metric,
  revenue_growth as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`
),

customers as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'Customers' as metric,
  customers_ty as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`
),

customer_growth as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'Customer Growth' as metric,
  customer_growth as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`

),

aov as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'AOV' as metric,
  aov_ty as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`

),

aov_growth as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'AOV Growth' as metric,
  aov_growth as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`

)

SELECT * FROM orders
UNION ALL 
SELECT * FROM order_growth
UNION ALL
SELECT * FROM revenue
UNION ALL 
SELECT * FROM revenue_growth
UNION ALL
SELECT * FROM customers
UNION ALL 
SELECT * FROM customer_growth
UNION ALL
SELECT * FROM aov
UNION ALL 
SELECT * FROM aov_growth
2018-04-18 09:54:18,615: Model SQL (retention_stats_month):
WITH last_month_buyers AS (
	SELECT 
	date,
	client,
	'Last month buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_30_60`
	group by date, client
),

rebuy_rate AS (
	SELECT 
	date,
	client,
	'Rebuy rate' as metric,
	customer_retention value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_stats_rebuy_rate_month`
),

repeat_buyers AS (
	SELECT 
	date,
	client,
	'Repeat buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30_rebuy`
	group by date, client
),

reactivated_buyers AS (
	SELECT 
	date,
	client,
	'Reactivated buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30_reactivated`
	group by date, client
),

new_buyers AS (
	SELECT 
	date,
	client,
	'New buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30_new`
	group by date, client
),

this_month_buyers AS (
	SELECT 
	date,
	client,
	'This month buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30`
	group by date, client
),

this_month_revenue AS (
	SELECT 
	date,
	client,
	'This month revenue' as metric,
	sum(revenue) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30`
	group by date, client
),

this_month_aov AS (
	SELECT 
	date,
	client,
	'This month AOV' as metric,
	case when sum(order_count) > 0 then sum(revenue)/sum(order_count) else 0 end as value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30`
	group by date, client
),

this_month_frequency AS (
	SELECT 
	date,
	client,
	'This month frequency' as metric,
	case when count(distinct customer_id) > 0 then sum(order_count)/count(distinct customer_id) else 0 end as value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30`
	group by date, client
)

SELECT 
date,
client,
metric,
ifnull(value, 0) value
FROM
(
	SELECT
	date,
	client,
	metric,
	value
	FROM last_month_buyers

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM rebuy_rate

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM repeat_buyers

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM reactivated_buyers	

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM new_buyers	

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_month_buyers	

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_month_revenue

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_month_aov

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_month_frequency

	UNION ALL

	SELECT
	a.date,
	a.client,
	'Dormant buyers' as metric,
	a.value - ifnull(b.value, 0) as value
	FROM last_month_buyers a
	LEFT JOIN repeat_buyers b
	ON ( a.date = b.date AND
		a.client = b.client )							

)
2018-04-18 09:54:18,650: Model SQL (retention_stats):
WITH last_year_buyers AS (
	SELECT 
	date,
	client,
	'Last year buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_365_730`
	group by date, client
),

rebuy_rate AS (
	SELECT 
	date,
	client,
	'Rebuy rate' as metric,
	customer_retention value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_stats_rebuy_rate`
),

repeat_buyers AS (
	SELECT 
	date,
	client,
	'Repeat buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365_rebuy`
	group by date, client
),

reactivated_buyers AS (
	SELECT 
	date,
	client,
	'Reactivated buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365_reactivated`
	group by date, client
),

new_buyers AS (
	SELECT 
	date,
	client,
	'New buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365_new`
	group by date, client
),

this_year_buyers AS (
	SELECT 
	date,
	client,
	'This year buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365`
	group by date, client
),

this_year_revenue AS (
	SELECT 
	date,
	client,
	'This year revenue' as metric,
	sum(revenue) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365`
	group by date, client
),

this_year_aov AS (
	SELECT 
	date,
	client,
	'This year AOV' as metric,
	case when sum(order_count) > 0 then sum(revenue)/sum(order_count) else 0 end as value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365`
	group by date, client
),

this_year_frequency AS (
	SELECT 
	date,
	client,
	'This year frequency' as metric,
	case when count(distinct customer_id) > 0 then sum(order_count)/count(distinct customer_id) else 0 end as value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365`
	group by date, client
)

SELECT 
date,
client,
metric,
ifnull(value, 0) value
FROM
(
	SELECT
	date,
	client,
	metric,
	value
	FROM last_year_buyers

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM rebuy_rate

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM repeat_buyers

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM reactivated_buyers	

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM new_buyers	

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_year_buyers	

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_year_revenue

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_year_aov

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_year_frequency

	UNION ALL

	SELECT
	a.date,
	a.client,
	'Dormant buyers' as metric,
	a.value - ifnull(b.value, 0) as value
	FROM last_year_buyers a
	LEFT JOIN repeat_buyers b
	ON ( a.date = b.date AND
		a.client = b.client )							

)
2018-04-18 09:54:19,646: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10aceae48>]}
2018-04-18 09:54:19,903: 09:54:19 | 89 of 91 OK created table model agency_data_pipeline.growth_stats.... [CREATE TABLE in 2.01s]
2018-04-18 09:54:21,943: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10dab3940>]}
2018-04-18 09:54:22,183: 09:54:22 | 87 of 91 OK created table model agency_data_pipeline.retention_stats_month [CREATE TABLE in 4.32s]
2018-04-18 09:54:26,372: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10acaccf8>]}
2018-04-18 09:54:26,613: 09:54:26 | 88 of 91 OK created table model agency_data_pipeline.retention_stats. [CREATE TABLE in 8.74s]
2018-04-18 09:54:26,614: 09:54:26 | 90 of 91 START table model agency_data_pipeline.agg_campaign......... [RUN]
2018-04-18 09:54:26,614: Compiling model.agency_data_pipeline.agg_campaign
2018-04-18 09:54:26,622: Writing injected SQL for node "model.agency_data_pipeline.agg_campaign"
2018-04-18 09:54:26,625: Acquiring new bigquery connection "agg_campaign".
2018-04-18 09:54:26,625: Re-using an available connection from the pool.
2018-04-18 09:54:27,544: Model SQL (agg_campaign):
with ga as (

	select 
		date, client, attribution, channel, platform, url, campaign as utm_campaign, '' as campaign,
    	customers_new,
    	transactions_new,
    	revenue_new,
    	first_order_revenue_new,
    	lifetime_revenue_new,
    	customers_total,
    	transactions_total,
    	revenue_total,
		null as cost, null as impressions, null as clicks, null as ad_platform_transactions
	from `growth-engines-pipeline`.`agency_data_pipeline`.`agg_ga_campaign_by_type`

),

platforms_last_touch as (

	select 
		date, client, 'Last-touch' as attribution, channel, platform, url, utm_campaign, campaign,
		null as customers_new,
    	null as transactions_new,
    	null as revenue_new,
    	null as first_order_revenue_new,
    	null as lifetime_revenue_new,
    	null as customers_total,
    	null as transactions_total,
    	null as revenue_total,
		cost, impressions, clicks, ad_platform_transactions
	from `growth-engines-pipeline`.`agency_data_pipeline`.`agg_platforms_client`

),

platforms_first_touch as (

    select 
        date, client, 'First-touch' as attribution, channel, platform, url, utm_campaign, campaign,
        null as customers_new,
        null as transactions_new,
        null as revenue_new,
        null as first_order_revenue_new,
        null as lifetime_revenue_new,
        null as customers_total,
        null as transactions_total,
        null as revenue_total,
        cost, impressions, clicks, ad_platform_transactions
    from `growth-engines-pipeline`.`agency_data_pipeline`.`agg_platforms_client`

)


SELECT
    date, 
    client,
    attribution,
    platform,
    channel, 
    url,
    utm_campaign,
    max(campaign) campaign,
    ifnull( sum(cost), 0) cost,
	ifnull( sum(impressions), 0) impressions,
	ifnull( sum(clicks), 0) clicks,
	ifnull( sum(ad_platform_transactions), 0) ad_platform_transactions,
	ifnull( sum(customers_new), 0) customers_new,
	ifnull( sum(transactions_new), 0) transactions_new,
	ifnull( sum(revenue_new), 0) revenue_new,
	ifnull( sum(first_order_revenue_new), 0) first_order_revenue_new,
	ifnull( sum(lifetime_revenue_new), 0) lifetime_revenue_new,
	ifnull( sum(customers_total), 0) customers_total,
	ifnull( sum(transactions_total), 0) transactions_total,
	ifnull( sum(revenue_total), 0) revenue_total	
FROM 
(
    SELECT *
    FROM 
      ga
    UNION ALL
    SELECT *
    FROM 
      platforms_first_touch
    UNION ALL
    SELECT *
    FROM 
      platforms_last_touch      
) 
GROUP BY
    date, client, attribution, platform, channel, url, utm_campaign
2018-04-18 09:54:36,307: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d9f0a58>]}
2018-04-18 09:54:36,598: 09:54:36 | 90 of 91 OK created table model agency_data_pipeline.agg_campaign.... [CREATE TABLE in 9.69s]
2018-04-18 09:54:36,598: 09:54:36 | 91 of 91 START table model agency_data_pipeline.agg_platform_monthly. [RUN]
2018-04-18 09:54:36,598: Compiling model.agency_data_pipeline.agg_platform_monthly
2018-04-18 09:54:36,603: Writing injected SQL for node "model.agency_data_pipeline.agg_platform_monthly"
2018-04-18 09:54:36,606: Acquiring new bigquery connection "agg_platform_monthly".
2018-04-18 09:54:36,606: Re-using an available connection from the pool.
2018-04-18 09:54:37,551: Model SQL (agg_platform_monthly):
SELECT
    FORMAT_DATE("%Y-%m", date) AS yyyymm,
    client,
    attribution,
    platform,
    channel, 
    sum(cost) cost,
	sum(clicks) clicks,
	sum(customers_new) customers_new,
	sum(first_order_revenue_new) first_order_revenue_new,
	sum(lifetime_revenue_new) lifetime_revenue_new,
	sum(transactions_new) transactions_new,
	sum(revenue_new) revenue_new,
    sum(customers_total) customers_total,
    sum(transactions_total) transactions_total,
    sum(revenue_total) revenue_total
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_campaign`
GROUP BY
    yyyymm, client, attribution, platform, channel
2018-04-18 09:54:39,748: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '447e59da-e102-4cb8-bc37-a249cf70d534', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10dab3940>]}
2018-04-18 09:54:40,034: 09:54:40 | 91 of 91 OK created table model agency_data_pipeline.agg_platform_monthly [CREATE TABLE in 3.15s]
2018-04-18 09:54:40,049: 09:54:40 | 
2018-04-18 09:54:40,050: 09:54:40 | Finished running 91 table models in 461.52s.
2018-04-18 09:54:40,050: Connection 'master' was left open.
2018-04-18 09:54:40,051: 
2018-04-18 09:54:40,051: Completed successfully
2018-04-18 09:54:40,052: 
Done. PASS=91 ERROR=0 SKIP=0 TOTAL=91
2018-04-18 09:54:40,053: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d959c88>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d9599b0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d959c50>]}
2018-04-18 09:54:40,347: Flushing usage events
2018-04-18 09:57:16,449: Tracking: tracking
2018-04-18 09:57:16,451: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11428a588>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11428a828>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11428aba8>]}
2018-04-18 09:57:17,184: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-04-18 09:57:17,209: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/growth-engines/dbt_modules
2018-04-18 09:57:17,218: Parsing get_column_values.sql
2018-04-18 09:57:17,243: Parsing get_url_parameter.sql
2018-04-18 09:57:17,253: Parsing split_part.sql
2018-04-18 09:57:17,265: Parsing table_exists.sql
2018-04-18 09:57:17,290: Parsing core.sql
2018-04-18 09:57:17,311: Parsing adapters/bigquery.sql
2018-04-18 09:57:17,319: Parsing adapters/common.sql
2018-04-18 09:57:17,342: Parsing adapters/postgres.sql
2018-04-18 09:57:17,351: Parsing adapters/redshift.sql
2018-04-18 09:57:17,387: Parsing etc/get_custom_schema.sql
2018-04-18 09:57:17,400: Parsing materializations/archive.sql
2018-04-18 09:57:17,440: Parsing materializations/bigquery.sql
2018-04-18 09:57:17,462: Parsing materializations/helpers.sql
2018-04-18 09:57:17,483: Parsing materializations/incremental.sql
2018-04-18 09:57:17,515: Parsing materializations/table.sql
2018-04-18 09:57:17,540: Parsing materializations/view.sql
2018-04-18 09:57:17,560: Parsing materializations/wrapper.sql
2018-04-18 09:57:17,566: Parsing schema_tests/accepted_values.sql
2018-04-18 09:57:17,575: Parsing schema_tests/not_null.sql
2018-04-18 09:57:17,581: Parsing schema_tests/relationships.sql
2018-04-18 09:57:17,588: Parsing schema_tests/unique.sql
2018-04-18 09:57:17,666: Parsing model.agency_data_pipeline.accounts_proc
2018-04-18 09:57:17,668: Parsing model.agency_data_pipeline.all_dates
2018-04-18 09:57:17,670: Parsing model.agency_data_pipeline.carts_proc
2018-04-18 09:57:17,672: Parsing model.agency_data_pipeline.clients_proc
2018-04-18 09:57:17,674: Parsing model.agency_data_pipeline.conversion_goals_proc
2018-04-18 09:57:17,677: Parsing model.agency_data_pipeline.mappings_ga_proc
2018-04-18 09:57:17,679: Acquiring new bigquery connection "master".
2018-04-18 09:57:17,680: Opening a new connection (0 currently allocated)
2018-04-18 09:57:17,686: Parsing model.agency_data_pipeline.monthend_dates
2018-04-18 09:57:17,689: Parsing model.agency_data_pipeline.adwords_ads
2018-04-18 09:57:17,694: Parsing model.agency_data_pipeline.adwords_campaigns
2018-04-18 09:57:17,697: Parsing model.agency_data_pipeline.adwords_conversions
2018-04-18 09:57:17,699: Parsing model.agency_data_pipeline.adwords_impression_share
2018-04-18 09:57:17,701: Parsing model.agency_data_pipeline.adwords_join
2018-04-18 09:57:17,707: Parsing model.agency_data_pipeline.adwords_stats
2018-04-18 09:57:17,713: Parsing model.agency_data_pipeline.adwords_urls
2018-04-18 09:57:17,716: Parsing model.agency_data_pipeline.bing_ads_ads
2018-04-18 09:57:17,721: Parsing model.agency_data_pipeline.bing_ads_conversions
2018-04-18 09:57:17,726: Parsing model.agency_data_pipeline.bing_ads_impression_share
2018-04-18 09:57:17,729: Parsing model.agency_data_pipeline.bing_ads_stats
2018-04-18 09:57:17,732: Parsing model.agency_data_pipeline.fb_adcreative
2018-04-18 09:57:17,741: Parsing model.agency_data_pipeline.fb_ads
2018-04-18 09:57:17,751: Parsing model.agency_data_pipeline.fb_ads_insights
2018-04-18 09:57:17,756: Parsing model.agency_data_pipeline.fb_ads_insights_conversions
2018-04-18 09:57:17,767: Parsing model.agency_data_pipeline.fb_ads_stats
2018-04-18 09:57:17,770: Parsing model.agency_data_pipeline.ga_conversions
2018-04-18 09:57:17,772: Parsing model.agency_data_pipeline.ga_traffic
2018-04-18 09:57:17,790: Parsing model.agency_data_pipeline.ga_transactions
2018-04-18 09:57:17,804: Parsing model.agency_data_pipeline.ga_mcf_proc
2018-04-18 09:57:17,806: Parsing model.agency_data_pipeline.ga_mcf_stats
2018-04-18 09:57:17,810: Parsing model.agency_data_pipeline.shopify_customers_proc
2018-04-18 09:57:17,818: Parsing model.agency_data_pipeline.shopify_orders_proc
2018-04-18 09:57:17,827: Parsing model.agency_data_pipeline.shopify_products_proc
2018-04-18 09:57:17,835: Parsing model.agency_data_pipeline.shopify_refunds_proc
2018-04-18 09:57:17,841: Parsing model.agency_data_pipeline.agg_campaign
2018-04-18 09:57:17,845: Parsing model.agency_data_pipeline.agg_customers_union
2018-04-18 09:57:17,848: Parsing model.agency_data_pipeline.agg_ga_campaign
2018-04-18 09:57:17,851: Parsing model.agency_data_pipeline.agg_ga_campaign_by_type
2018-04-18 09:57:17,855: Parsing model.agency_data_pipeline.agg_ga_transaction
2018-04-18 09:57:17,858: Parsing model.agency_data_pipeline.agg_ga_transaction_order_number
2018-04-18 09:57:17,862: Parsing model.agency_data_pipeline.agg_orders_union
2018-04-18 09:57:17,864: Parsing model.agency_data_pipeline.agg_platform_monthly
2018-04-18 09:57:17,867: Parsing model.agency_data_pipeline.agg_platforms_client
2018-04-18 09:57:17,869: Parsing model.agency_data_pipeline.agg_platforms_union
2018-04-18 09:57:17,872: Parsing model.agency_data_pipeline.agg_products
2018-04-18 09:57:17,873: Parsing model.agency_data_pipeline.agg_transaction
2018-04-18 09:57:17,877: Parsing model.agency_data_pipeline.agg_transaction_daily
2018-04-18 09:57:17,880: Parsing model.agency_data_pipeline.agg_transaction_line_item
2018-04-18 09:57:17,883: Parsing model.agency_data_pipeline.agg_transaction_line_item_type
2018-04-18 09:57:17,886: Parsing model.agency_data_pipeline.agg_transaction_order_number
2018-04-18 09:57:17,889: Parsing model.agency_data_pipeline.agg_transaction_product_type
2018-04-18 09:57:17,890: Parsing model.agency_data_pipeline.customers_by_transaction
2018-04-18 09:57:17,892: Parsing model.agency_data_pipeline.growth_customer_0_365
2018-04-18 09:57:17,895: Parsing model.agency_data_pipeline.growth_customer_0_365_segment
2018-04-18 09:57:17,898: Parsing model.agency_data_pipeline.growth_date_union
2018-04-18 09:57:17,901: Parsing model.agency_data_pipeline.growth_stats
2018-04-18 09:57:17,906: Parsing model.agency_data_pipeline.retention_0_365
2018-04-18 09:57:17,909: Parsing model.agency_data_pipeline.retention_0_365_new
2018-04-18 09:57:17,913: Parsing model.agency_data_pipeline.retention_0_365_reactivated
2018-04-18 09:57:17,916: Parsing model.agency_data_pipeline.retention_0_365_rebuy
2018-04-18 09:57:17,919: Parsing model.agency_data_pipeline.retention_365_730
2018-04-18 09:57:17,921: Parsing model.agency_data_pipeline.retention_730_plus
2018-04-18 09:57:17,924: Parsing model.agency_data_pipeline.retention_stats
2018-04-18 09:57:17,931: Parsing model.agency_data_pipeline.retention_stats_rebuy_rate
2018-04-18 09:57:17,934: Parsing model.agency_data_pipeline.retention_0_30
2018-04-18 09:57:17,937: Parsing model.agency_data_pipeline.retention_0_30_new
2018-04-18 09:57:17,940: Parsing model.agency_data_pipeline.retention_0_30_reactivated
2018-04-18 09:57:17,943: Parsing model.agency_data_pipeline.retention_0_30_rebuy
2018-04-18 09:57:17,946: Parsing model.agency_data_pipeline.retention_30_60
2018-04-18 09:57:17,949: Parsing model.agency_data_pipeline.retention_60_plus
2018-04-18 09:57:17,952: Parsing model.agency_data_pipeline.retention_stats_month
2018-04-18 09:57:17,958: Parsing model.agency_data_pipeline.retention_stats_rebuy_rate_month
2018-04-18 09:57:17,962: Parsing model.agency_data_pipeline.customers_first_purchase_proc
2018-04-18 09:57:17,964: Parsing model.agency_data_pipeline.customers_proc
2018-04-18 09:57:17,967: Parsing model.agency_data_pipeline.segment_list_customers
2018-04-18 09:57:17,970: Parsing model.agency_data_pipeline.segment_proc_customers
2018-04-18 09:57:17,973: Parsing model.agency_data_pipeline.segment_stats_customers
2018-04-18 09:57:17,975: Parsing model.agency_data_pipeline.segment_stats_customers_agg
2018-04-18 09:57:17,980: Parsing model.agency_data_pipeline.customers_first_purchase_product_type_proc
2018-04-18 09:57:17,982: Parsing model.agency_data_pipeline.customers_products_proc
2018-04-18 09:57:17,986: Parsing model.agency_data_pipeline.segment_list_customers_products
2018-04-18 09:57:17,988: Parsing model.agency_data_pipeline.segment_proc_customers_products
2018-04-18 09:57:17,991: Parsing model.agency_data_pipeline.segment_stats_customers_products
2018-04-18 09:57:17,993: Parsing model.agency_data_pipeline.segment_stats_customers_products_agg
2018-04-18 09:57:17,997: Parsing model.agency_data_pipeline.frequency_proc
2018-04-18 09:57:17,999: Parsing model.agency_data_pipeline.frequency_stats
2018-04-18 09:57:18,002: Parsing model.agency_data_pipeline.order_paths_agg
2018-04-18 09:57:18,003: Parsing model.agency_data_pipeline.order_paths_proc
2018-04-18 09:57:18,006: Parsing model.agency_data_pipeline.order_paths_stats
2018-04-18 09:57:18,009: Parsing model.agency_data_pipeline.products_proc
2018-04-18 09:57:18,012: Parsing model.agency_data_pipeline.segment_proc_sku
2018-04-18 09:57:18,015: Parsing model.agency_data_pipeline.segment_stats_category
2018-04-18 09:57:18,017: Parsing model.agency_data_pipeline.segment_stats_sku
2018-04-18 09:57:18,052: Found 91 models, 0 tests, 0 archives, 0 analyses, 46 macros, 0 operations
2018-04-18 09:57:18,122: 
2018-04-18 09:57:19,495: 09:57:19 | Concurrency: 4 threads (target='prod')
2018-04-18 09:57:19,497: 09:57:19 | 
2018-04-18 09:57:20,219: 09:57:20 | 1 of 91 START table model agency_data_pipeline.carts_proc............ [RUN]
2018-04-18 09:57:20,219: Compiling model.agency_data_pipeline.carts_proc
2018-04-18 09:57:20,219: 09:57:20 | 2 of 91 START table model agency_data_pipeline.adwords_urls.......... [RUN]
2018-04-18 09:57:20,224: Writing injected SQL for node "model.agency_data_pipeline.carts_proc"
2018-04-18 09:57:20,219: 09:57:20 | 3 of 91 START table model agency_data_pipeline.bing_ads_impression_share [RUN]
2018-04-18 09:57:20,224: Compiling model.agency_data_pipeline.adwords_urls
2018-04-18 09:57:20,219: 09:57:20 | 4 of 91 START table model agency_data_pipeline.accounts_proc......... [RUN]
2018-04-18 09:57:20,224: Compiling model.agency_data_pipeline.bing_ads_impression_share
2018-04-18 09:57:20,230: Writing injected SQL for node "model.agency_data_pipeline.adwords_urls"
2018-04-18 09:57:20,230: Acquiring new bigquery connection "carts_proc".
2018-04-18 09:57:20,230: Compiling model.agency_data_pipeline.accounts_proc
2018-04-18 09:57:20,234: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_impression_share"
2018-04-18 09:57:20,235: Opening a new connection (1 currently allocated)
2018-04-18 09:57:20,241: Writing injected SQL for node "model.agency_data_pipeline.accounts_proc"
2018-04-18 09:57:20,245: Acquiring new bigquery connection "adwords_urls".
2018-04-18 09:57:20,247: Opening a new connection (2 currently allocated)
2018-04-18 09:57:20,298: Acquiring new bigquery connection "bing_ads_impression_share".
2018-04-18 09:57:20,300: Acquiring new bigquery connection "accounts_proc".
2018-04-18 09:57:20,306: Opening a new connection (3 currently allocated)
2018-04-18 09:57:20,455: Opening a new connection (4 currently allocated)
2018-04-18 09:57:21,839: Model SQL (adwords_urls):
SELECT
campaignid,
lower(trim(regexp_replace(replace(replace(replace(replace(finalurl,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url

FROM (

SELECT  
campaignid,
finalurl,
first_value(finalurl) OVER (PARTITION BY campaignid ORDER BY day DESC) lv
FROM `growth-engines-pipeline.adwords_2.FINAL_URL_REPORT`
)

WHERE lv = finalurl
group by campaignid, url
order by campaignid asc
2018-04-18 09:57:21,841: Model SQL (bing_ads_impression_share):
SELECT 
date, 
account,
channel,
platform,
sum(impressions) impressions,
sum(available_impressions) available_impressions
FROM

(

SELECT  
cast(gregoriandate as date) date,
replace(accountname,',','') account,  
'Paid' as channel,
'Bing Ads' as platform,
case when impressionsharepercent is null then 0 else impressions end as impressions,
cast(round(case when ( impressionsharepercent is not null and impressionsharepercent > 0 ) then (impressions*100)/impressionsharepercent else 0 end) as int64) as available_impressions,
_sdc_sequence,
first_value(_sdc_sequence) OVER (PARTITION BY campaignid, gregoriandate ORDER BY _sdc_sequence DESC) lv
FROM `growth-engines-pipeline.bing_ads.campaign_performance_report` 

)

where lv = _sdc_sequence
group by date, account, channel, platform
2018-04-18 09:57:21,846: Model SQL (carts_proc):
select 
client,
client_name,
account,
platform
from  ( 

SELECT  
client,
client_name,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.accounts`
WHERE platform in ('Shopify', 'Custom cart')

) 

WHERE lv = time_of_entry
2018-04-18 09:57:21,870: Model SQL (accounts_proc):
select 
client,
account,
platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.accounts` 

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-04-18 09:57:22,939: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5ff182a7-6821-4626-a4b4-cd6e62841f8a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1144346d8>]}
2018-04-18 09:57:23,167: 09:57:23 | 1 of 91 OK created table model agency_data_pipeline.carts_proc....... [CREATE TABLE in 2.72s]
2018-04-18 09:57:23,168: 09:57:23 | 5 of 91 START table model agency_data_pipeline.adwords_conversions... [RUN]
2018-04-18 09:57:23,168: Compiling model.agency_data_pipeline.adwords_conversions
2018-04-18 09:57:23,175: Writing injected SQL for node "model.agency_data_pipeline.adwords_conversions"
2018-04-18 09:57:23,176: Acquiring new bigquery connection "adwords_conversions".
2018-04-18 09:57:23,176: Re-using an available connection from the pool.
2018-04-18 09:57:24,050: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5ff182a7-6821-4626-a4b4-cd6e62841f8a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110f38710>]}
2018-04-18 09:57:24,067: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5ff182a7-6821-4626-a4b4-cd6e62841f8a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x114434940>]}
2018-04-18 09:57:24,143: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5ff182a7-6821-4626-a4b4-cd6e62841f8a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1144149e8>]}
2018-04-18 09:57:24,284: 09:57:24 | 2 of 91 OK created table model agency_data_pipeline.adwords_urls..... [CREATE TABLE in 3.83s]
2018-04-18 09:57:24,284: 09:57:24 | 6 of 91 START table model agency_data_pipeline.ga_conversions........ [RUN]
2018-04-18 09:57:24,285: Compiling model.agency_data_pipeline.ga_conversions
2018-04-18 09:57:24,289: Writing injected SQL for node "model.agency_data_pipeline.ga_conversions"
2018-04-18 09:57:24,294: Acquiring new bigquery connection "ga_conversions".
2018-04-18 09:57:24,296: Re-using an available connection from the pool.
2018-04-18 09:57:24,305: Model SQL (adwords_conversions):
select 
client,
client_name,
platform,
goal_name,
goal_type,
account,
time_of_entry
from  ( 

SELECT  
client,
client_name,
platform,
trim(lower(goal_name)) goal_name,
goal_type,
account,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform, goal_name ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.conversion_goals` 
WHERE platform = 'Adwords'

) 

WHERE lv = time_of_entry
2018-04-18 09:57:24,553: 09:57:24 | 3 of 91 OK created table model agency_data_pipeline.bing_ads_impression_share [CREATE TABLE in 3.84s]
2018-04-18 09:57:24,554: 09:57:24 | 7 of 91 START table model agency_data_pipeline.conversion_goals_proc. [RUN]
2018-04-18 09:57:24,557: Compiling model.agency_data_pipeline.conversion_goals_proc
2018-04-18 09:57:24,565: Writing injected SQL for node "model.agency_data_pipeline.conversion_goals_proc"
2018-04-18 09:57:24,566: Acquiring new bigquery connection "conversion_goals_proc".
2018-04-18 09:57:24,567: Re-using an available connection from the pool.
2018-04-18 09:57:24,808: 09:57:24 | 4 of 91 OK created table model agency_data_pipeline.accounts_proc.... [CREATE TABLE in 3.91s]
2018-04-18 09:57:24,808: 09:57:24 | 8 of 91 START table model agency_data_pipeline.bing_ads_ads.......... [RUN]
2018-04-18 09:57:24,809: Compiling model.agency_data_pipeline.bing_ads_ads
2018-04-18 09:57:24,818: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_ads"
2018-04-18 09:57:24,819: Acquiring new bigquery connection "bing_ads_ads".
2018-04-18 09:57:24,820: Re-using an available connection from the pool.
2018-04-18 09:57:25,145: Model SQL (ga_conversions):
select 
client,
client_name,
platform,
goal_name,
goal_type,
account,
time_of_entry
from  ( 

SELECT  
client,
client_name,
platform,
trim(goal_name) goal_name,
goal_type,
account,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform, goal_name ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.conversion_goals` 
WHERE platform = 'Google Analytics'

) 

WHERE lv = time_of_entry
2018-04-18 09:57:25,405: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5ff182a7-6821-4626-a4b4-cd6e62841f8a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1144346d8>]}
2018-04-18 09:57:25,412: Model SQL (conversion_goals_proc):
select 
client,
platform,
goal_name,
max(goal_type) goal_type,
account,
max(time_of_entry) time_of_entry
from  ( 

SELECT  
client,
platform,
trim(replace(replace(lower(goal_name),',',''),' ','')) goal_name,
goal_type,
account,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY platform ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.conversion_goals` 

) 

WHERE lv = time_of_entry
group by client, platform, account, goal_name
2018-04-18 09:57:25,747: 09:57:25 | 5 of 91 OK created table model agency_data_pipeline.adwords_conversions [CREATE TABLE in 2.24s]
2018-04-18 09:57:25,747: 09:57:25 | 9 of 91 START table model agency_data_pipeline.adwords_campaigns..... [RUN]
2018-04-18 09:57:25,748: Compiling model.agency_data_pipeline.adwords_campaigns
2018-04-18 09:57:25,756: Writing injected SQL for node "model.agency_data_pipeline.adwords_campaigns"
2018-04-18 09:57:25,757: Acquiring new bigquery connection "adwords_campaigns".
2018-04-18 09:57:25,757: Re-using an available connection from the pool.
2018-04-18 09:57:25,773: Model SQL (bing_ads_ads):
select
date, 
account, 
channel,
platform,
campaignid,
campaignname,
max(lower(trim(replace(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$','' ),'.html',''),'/'))) as url,
utm_campaign,
sum(cost) as cost,
sum(impressions) as impressions,
sum(clicks) as clicks,
sum(conversions) as conversions
from 
  ( 
SELECT  
cast(gregoriandate as date) date,
replace(accountname,',','') account,
'Paid' as channel,
'Bing Ads' as platform,
adid,
adtype,
campaignid, 
campaignname,
finalurl url,
case when regexp_contains(destinationurl, 'utm_campaign')
	then replace(lower(nullif(
  

    split(
        
  

    split(
        destinationurl,
        'utm_campaign='
        )[offset(1)]


,
        '&'
        )[offset(0)]


,'')),'+',' ') 
	else null end as utm_campaign,
spend cost, 
impressions, 
clicks, 
conversions,
_sdc_sequence,
first_value(_sdc_sequence) OVER (PARTITION BY adid, gregoriandate ORDER BY _sdc_sequence DESC) lv
FROM `growth-engines-pipeline.bing_ads.ad_performance_report` 
  )

where lv = _sdc_sequence
group by date, account, channel, platform, campaignid, campaignname, utm_campaign
2018-04-18 09:57:26,245: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5ff182a7-6821-4626-a4b4-cd6e62841f8a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110f38710>]}
2018-04-18 09:57:26,484: 09:57:26 | 6 of 91 OK created table model agency_data_pipeline.ga_conversions... [CREATE TABLE in 1.96s]
2018-04-18 09:57:26,485: 09:57:26 | 10 of 91 START table model agency_data_pipeline.all_dates............ [RUN]
2018-04-18 09:57:26,485: Compiling model.agency_data_pipeline.all_dates
2018-04-18 09:57:26,493: Writing injected SQL for node "model.agency_data_pipeline.all_dates"
2018-04-18 09:57:26,495: Acquiring new bigquery connection "all_dates".
2018-04-18 09:57:26,496: Re-using an available connection from the pool.
2018-04-18 09:57:26,507: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5ff182a7-6821-4626-a4b4-cd6e62841f8a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1143a18d0>]}
2018-04-18 09:57:26,533: Model SQL (adwords_campaigns):
select
day,
campaignid, 
campaign,
account, 
channel,
platform,
sum(cost) cost,
sum(impressions) impressions,
sum(clicks) clicks,
sum(impression_share_num) impression_share_num,
sum(impression_share_den) impression_share_den
from 
  ( 
	SELECT  
	day,
	campaignid,
	campaign,
	account as account,
	'Paid' as channel,
	'Adwords' as platform,
	cost/1000000 cost, 
	impressions as impressions, 
	clicks, 
	case when searchimprshare is not null then impressions end as impression_share_num,
	case when searchimprshare is not null then impressions/(searchimprshare/100) end as impression_share_den,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY campaignid, day ORDER BY _sdc_sequence DESC) lv
	FROM `growth-engines-pipeline.adwords_2.CAMPAIGN_PERFORMANCE_REPORT`
  )
where lv = _sdc_sequence
group by day, campaignid, account, channel, platform, campaign
2018-04-18 09:57:26,769: 09:57:26 | 7 of 91 OK created table model agency_data_pipeline.conversion_goals_proc [CREATE TABLE in 1.95s]
2018-04-18 09:57:26,780: 09:57:26 | 11 of 91 START table model agency_data_pipeline.clients_proc......... [RUN]
2018-04-18 09:57:26,780: Compiling model.agency_data_pipeline.clients_proc
2018-04-18 09:57:26,792: Writing injected SQL for node "model.agency_data_pipeline.clients_proc"
2018-04-18 09:57:26,800: Acquiring new bigquery connection "clients_proc".
2018-04-18 09:57:26,800: Re-using an available connection from the pool.
2018-04-18 09:57:28,416: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5ff182a7-6821-4626-a4b4-cd6e62841f8a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1144149e8>]}
2018-04-18 09:57:28,704: Model SQL (all_dates):
SELECT 
date_in_range,
unix_date(date_in_range) unix_date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-04-18 09:57:29,036: Model SQL (clients_proc):
select 
client,
client_name,
account,
platform
from  ( 

SELECT  
client,
client_name,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.accounts`
where client_name != ''
) 

WHERE lv = time_of_entry
2018-04-18 09:57:29,123: 09:57:29 | 8 of 91 OK created table model agency_data_pipeline.bing_ads_ads..... [CREATE TABLE in 3.61s]
2018-04-18 09:57:29,123: 09:57:29 | 12 of 91 START table model agency_data_pipeline.monthend_dates....... [RUN]
2018-04-18 09:57:29,124: Compiling model.agency_data_pipeline.monthend_dates
2018-04-18 09:57:29,133: Writing injected SQL for node "model.agency_data_pipeline.monthend_dates"
2018-04-18 09:57:29,135: Acquiring new bigquery connection "monthend_dates".
2018-04-18 09:57:29,135: Re-using an available connection from the pool.
2018-04-18 09:57:29,812: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5ff182a7-6821-4626-a4b4-cd6e62841f8a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110f38710>]}
2018-04-18 09:57:29,971: Model SQL (monthend_dates):
SELECT
date_in_range,
date_in_range_bom,
date_in_range_bom_mom,
unix_date_in_range,
unix_date_in_range_bom,
unix_date(date_in_range_bom_mom) unix_date_in_range_bom_mom,
yyyymm,
date_in_range_yoy,
unix_date(date_in_range_yoy) unix_date_in_range_yoy

FROM
(
	SELECT 
	date_in_range,
	date_in_range_bom,
	date_sub(date_in_range_bom, INTERVAL 1 MONTH) date_in_range_bom_mom,
  date_sub(date_in_range, INTERVAL 1 YEAR) date_in_range_yoy,
	unix_date_in_range,
	unix_date(date_in_range_bom) unix_date_in_range_bom,
	yyyymm,
	first_value(date_in_range) over (partition by yyyymm order by date_in_range desc) monthend_date_in_range
	FROM
	( 
		SELECT 
		date_in_range,
		date_trunc( date_in_range, MONTH) date_in_range_bom,
		unix_date(date_in_range) unix_date_in_range,
		format_date("%Y-%m", date_in_range) AS yyyymm
		FROM UNNEST(
		    GENERATE_DATE_ARRAY(DATE('2016-01-31'), CURRENT_DATE(), INTERVAL 1 DAY)
		) AS date_in_range
	)
)
where date_in_range = monthend_date_in_range
2018-04-18 09:57:30,090: 09:57:30 | 10 of 91 OK created table model agency_data_pipeline.all_dates....... [CREATE TABLE in 3.33s]
2018-04-18 09:57:30,125: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5ff182a7-6821-4626-a4b4-cd6e62841f8a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x114434a90>]}
2018-04-18 09:57:30,378: 09:57:30 | 11 of 91 OK created table model agency_data_pipeline.clients_proc.... [CREATE TABLE in 3.34s]
2018-04-18 09:57:31,091: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5ff182a7-6821-4626-a4b4-cd6e62841f8a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1144149e8>]}
2018-04-18 09:57:31,401: 09:57:31 | 12 of 91 OK created table model agency_data_pipeline.monthend_dates.. [CREATE TABLE in 1.97s]
2018-04-18 09:57:32,780: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5ff182a7-6821-4626-a4b4-cd6e62841f8a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1144b19b0>]}
2018-04-18 09:57:33,008: 09:57:33 | 9 of 91 OK created table model agency_data_pipeline.adwords_campaigns [CREATE TABLE in 7.03s]
2018-04-18 09:57:33,009: 09:57:33 | 13 of 91 START table model agency_data_pipeline.fb_ads_insights...... [RUN]
2018-04-18 09:57:33,010: Compiling model.agency_data_pipeline.fb_ads_insights
2018-04-18 09:57:33,009: 09:57:33 | 14 of 91 START table model agency_data_pipeline.bing_ads_conversions. [RUN]
2018-04-18 09:57:33,016: Compiling model.agency_data_pipeline.bing_ads_conversions
2018-04-18 09:57:33,015: 09:57:33 | 15 of 91 START table model agency_data_pipeline.shopify_refunds_proc. [RUN]
2018-04-18 09:57:33,033: Acquiring new bigquery connection "fb_ads_insights".
2018-04-18 09:57:33,037: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_conversions"
2018-04-18 09:57:33,037: Compiling model.agency_data_pipeline.shopify_refunds_proc
2018-04-18 09:57:33,033: 09:57:33 | 16 of 91 START table model agency_data_pipeline.fb_ads_insights_conversions [RUN]
2018-04-18 09:57:33,037: Re-using an available connection from the pool.
2018-04-18 09:57:33,046: Acquiring new bigquery connection "shopify_refunds_proc".
2018-04-18 09:57:33,046: Compiling model.agency_data_pipeline.fb_ads_insights_conversions
2018-04-18 09:57:33,046: Fetching data for query fb_ads_insights:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 09:57:33,046: Re-using an available connection from the pool.
2018-04-18 09:57:33,066: Fetching data for query shopify_refunds_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 09:57:33,056: Acquiring new bigquery connection "bing_ads_conversions".
2018-04-18 09:57:33,081: Re-using an available connection from the pool.
2018-04-18 09:57:33,101: Acquiring new bigquery connection "fb_ads_insights_conversions".
2018-04-18 09:57:33,101: Re-using an available connection from the pool.
2018-04-18 09:57:33,102: Fetching data for query fb_ads_insights_conversions:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 09:57:34,214: Model SQL (bing_ads_conversions):
SELECT
date, 
a.account account, 
a.channel channel,
a.platform platform,
campaignid,
campaignname,
sum( case when b.goal_type = 'Transactions' then conversions else 0 end ) as transactions
FROM

  ( 
SELECT  
cast(gregoriandate as date) date,
replace(accountname,',','') account,
'Paid' as channel,
'Bing Ads' as platform,
trim(replace(replace(lower(goal),',',''),' ','')) goal,
goalid,
campaignid,
campaignname,
conversions,
_sdc_sequence,
first_value(_sdc_sequence) OVER (PARTITION BY campaignid, goalid, gregoriandate ORDER BY _sdc_sequence DESC) lv
FROM `growth-engines-pipeline.bing_ads.goals_and_funnels_report` 

  ) a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`conversion_goals_proc` b
ON (
	a.account = b.account AND
	a.platform = b.platform AND
	a.goal = b.goal_name
)
where a.lv = a._sdc_sequence
group by date, account, channel, platform, campaignid, campaignname
2018-04-18 09:57:34,326: Writing injected SQL for node "model.agency_data_pipeline.shopify_refunds_proc"
2018-04-18 09:57:34,361: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_insights_conversions"
2018-04-18 09:57:34,918: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_insights"
2018-04-18 09:57:35,253: Model SQL (shopify_refunds_proc):




with refunds as (

	
	SELECT
	order_number,
	checkout_id,
	financial_status,
	line_item_id,
	quantity,
	subtotal,
	line_item.variant_id variant_id,
	line_item.id refund_id,
 	_sdc_sequence
	FROM `growth-engines-pipeline.shopify_lucadanni.orders` 
	cross join unnest(refunds), unnest(refund_line_items)
  	where financial_status like '%refund%'
	
	

)

SELECT * 
FROM 
	(
    SELECT
	order_number,
	checkout_id,
	financial_status,
	line_item_id,
	quantity,
	subtotal refund_amount,
	variant_id,
	refund_id,
 	_sdc_sequence,
    first_value(_sdc_sequence) OVER (PARTITION BY order_number, line_item_id ORDER BY _sdc_sequence DESC) lv
    FROM refunds
   	) 
WHERE lv = _sdc_sequence


2018-04-18 09:57:35,265: Model SQL (fb_ads_insights_conversions):




with fb_ads_insights_conversions as (

	    
		   	SELECT 
			date_start,
			campaign_id,
			campaign_name,
			ad_id,
			account_name,
			spend,
			reach,
			inline_link_clicks,
			_sdc_sequence,
			action_type,
			value
			FROM `growth-engines-pipeline.fb_ads_luca_danni.ads_insights`
			cross join unnest(actions)
		    
	   

)

SELECT * 
FROM 
	(
    SELECT
    date_start date,
    campaign_id,
    campaign_name campaign,
    ad_id,
    account_name account,
    action_type,
    value conversions,
    first_value(_sdc_sequence) OVER (PARTITION BY ad_id, date_start ORDER BY _sdc_sequence DESC) lv,
    _sdc_sequence
    FROM fb_ads_insights_conversions
   	)
where lv = _sdc_sequence
and action_type like '%purchase%'


2018-04-18 09:57:35,716: Model SQL (fb_ads_insights):




with fb_ads_insights as (

	    
		   	SELECT 
			date_start,
			campaign_id,
			campaign_name,
			ad_id,
			account_name,
			spend,
			reach,
			inline_link_clicks,
			_sdc_sequence,
			first_value(_sdc_sequence) OVER (PARTITION BY date_start, ad_id, campaign_id ORDER BY _sdc_sequence DESC) lv
			FROM `growth-engines-pipeline.fb_ads_luca_danni.ads_insights`
		    
	   

)

select
date_start date,
campaign_id,
campaign_name campaign,
ad_id,
account_name account,
max(spend) cost,
max(reach) impressions,
max(inline_link_clicks) clicks
from fb_ads_insights
where lv = _sdc_sequence
group by date, campaign_id, ad_id, account, campaign


2018-04-18 09:57:36,457: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5ff182a7-6821-4626-a4b4-cd6e62841f8a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110f38710>]}
2018-04-18 09:57:36,708: 09:57:36 | 14 of 91 OK created table model agency_data_pipeline.bing_ads_conversions [CREATE TABLE in 3.44s]
2018-04-18 09:57:36,709: 09:57:36 | 17 of 91 START table model agency_data_pipeline.fb_adcreative........ [RUN]
2018-04-18 09:57:36,710: Compiling model.agency_data_pipeline.fb_adcreative
2018-04-18 09:57:36,718: Acquiring new bigquery connection "fb_adcreative".
2018-04-18 09:57:36,718: Re-using an available connection from the pool.
2018-04-18 09:57:36,719: Fetching data for query fb_adcreative:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 09:57:37,036: Writing injected SQL for node "model.agency_data_pipeline.fb_adcreative"
2018-04-18 09:57:37,458: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5ff182a7-6821-4626-a4b4-cd6e62841f8a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111859cf8>]}
2018-04-18 09:57:37,709: 09:57:37 | 15 of 91 OK created table model agency_data_pipeline.shopify_refunds_proc [CREATE TABLE in 4.42s]
2018-04-18 09:57:37,710: 09:57:37 | 18 of 91 START table model agency_data_pipeline.ga_mcf_proc.......... [RUN]
2018-04-18 09:57:37,710: Compiling model.agency_data_pipeline.ga_mcf_proc
2018-04-18 09:57:37,719: Writing injected SQL for node "model.agency_data_pipeline.ga_mcf_proc"
2018-04-18 09:57:37,720: Acquiring new bigquery connection "ga_mcf_proc".
2018-04-18 09:57:37,720: Re-using an available connection from the pool.
2018-04-18 09:57:37,945: Model SQL (fb_adcreative):




with fb_adcreative as (


	    
		   	SELECT 
			id,
			object_url,
			url_tags,
			_sdc_sequence
			FROM `growth-engines-pipeline.fb_ads_luca_danni.adcreative`
		    
	   
)

select creative_id, max(url) url
from (
  select
  id creative_id,
  lower(trim(regexp_replace(replace(replace(replace(replace(object_url,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
  first_value(_sdc_sequence) OVER (PARTITION BY id ORDER BY _sdc_sequence DESC) lv,
  _sdc_sequence
  from fb_adcreative
  )
where lv = _sdc_sequence
group by creative_id


2018-04-18 09:57:38,451: Model SQL (ga_mcf_proc):
SELECT 
date,
account,
'Google Analytics' as lookup_platform,
source_medium_path,
trim(lower(split(split(source_medium_path,'->')[SAFE_ORDINAL(1)],'/')[SAFE_ORDINAL(1)])) as source,
trim(lower(split(split(source_medium_path,'->')[SAFE_ORDINAL(1)],'/')[SAFE_ORDINAL(2)])) as medium,
first_interaction_campaign campaign,
cast(regexp_replace(transaction_id, r'#', '') as int64) transactionid,
max(first_interaction_conversions) transactions,
max(first_interaction_conversion_value) revenue
FROM `growth-engines-pipeline.agency_data_pipeline.ga_mcf`
where account in (select account from `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc` where platform = 'Google Analytics')
group by date, account, source, medium, campaign, source_medium_path, lookup_platform, transactionid
2018-04-18 09:57:39,025: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5ff182a7-6821-4626-a4b4-cd6e62841f8a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11446bb00>]}
2018-04-18 09:57:39,337: 09:57:39 | 13 of 91 OK created table model agency_data_pipeline.fb_ads_insights. [CREATE TABLE in 6.02s]
2018-04-18 09:57:39,337: 09:57:39 | 19 of 91 START table model agency_data_pipeline.mappings_ga_proc..... [RUN]
2018-04-18 09:57:39,338: Compiling model.agency_data_pipeline.mappings_ga_proc
2018-04-18 09:57:39,345: Writing injected SQL for node "model.agency_data_pipeline.mappings_ga_proc"
2018-04-18 09:57:39,347: Acquiring new bigquery connection "mappings_ga_proc".
2018-04-18 09:57:39,347: Re-using an available connection from the pool.
2018-04-18 09:57:39,776: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5ff182a7-6821-4626-a4b4-cd6e62841f8a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11446b6a0>]}
2018-04-18 09:57:40,023: 09:57:40 | 16 of 91 OK created table model agency_data_pipeline.fb_ads_insights_conversions [CREATE TABLE in 6.73s]
2018-04-18 09:57:40,024: 09:57:40 | 20 of 91 START table model agency_data_pipeline.adwords_ads.......... [RUN]
2018-04-18 09:57:40,024: Compiling model.agency_data_pipeline.adwords_ads
2018-04-18 09:57:40,033: Writing injected SQL for node "model.agency_data_pipeline.adwords_ads"
2018-04-18 09:57:40,034: Acquiring new bigquery connection "adwords_ads".
2018-04-18 09:57:40,035: Re-using an available connection from the pool.
2018-04-18 09:57:40,147: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5ff182a7-6821-4626-a4b4-cd6e62841f8a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110f38710>]}
2018-04-18 09:57:40,204: Model SQL (mappings_ga_proc):
select 
client,
account,
client_name,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
account,
client_name,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.mappings_ga` 

) 

WHERE lv = time_of_entry
and client in (select client from `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc` )
group by client, account, client_name, source, medium, platform_n, channel_n, time_of_entry
2018-04-18 09:57:40,487: 09:57:40 | 17 of 91 OK created table model agency_data_pipeline.fb_adcreative... [CREATE TABLE in 3.44s]
2018-04-18 09:57:40,893: Model SQL (adwords_ads):
SELECT  
day,
campaignid,
a.account as account,
utm_campaign,
sum( case when b.goal_type = 'Transaction' then conversions else 0 end ) as transactions
FROM (

	SELECT  
	day,
	adid,
	campaignid,
	account,
	lower(conversionname) conversionname,
	conversions,
	lower(campaign) utm_campaign,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY campaignid, day ORDER BY _sdc_sequence DESC) lv
	FROM
	`growth-engines-pipeline.adwords_2.AD_PERFORMANCE_REPORT`

) a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_conversions` b
ON ( a.conversionname = b.goal_name
	AND a.account = b.account )
WHERE lv = _sdc_sequence
group by day, campaignid, account, utm_campaign
2018-04-18 09:57:42,397: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5ff182a7-6821-4626-a4b4-cd6e62841f8a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11446bb00>]}
2018-04-18 09:57:42,644: 09:57:42 | 19 of 91 OK created table model agency_data_pipeline.mappings_ga_proc [CREATE TABLE in 3.06s]
2018-04-18 09:57:42,962: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5ff182a7-6821-4626-a4b4-cd6e62841f8a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1144b1160>]}
2018-04-18 09:57:43,417: 09:57:43 | 18 of 91 OK created table model agency_data_pipeline.ga_mcf_proc..... [CREATE TABLE in 5.25s]
2018-04-18 09:57:44,275: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5ff182a7-6821-4626-a4b4-cd6e62841f8a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11183fc18>]}
2018-04-18 09:57:44,545: 09:57:44 | 20 of 91 OK created table model agency_data_pipeline.adwords_ads..... [CREATE TABLE in 4.25s]
2018-04-18 09:57:44,546: 09:57:44 | 21 of 91 START table model agency_data_pipeline.shopify_customers_proc [RUN]
2018-04-18 09:57:44,546: Compiling model.agency_data_pipeline.shopify_customers_proc
2018-04-18 09:57:44,560: Acquiring new bigquery connection "shopify_customers_proc".
2018-04-18 09:57:44,560: Re-using an available connection from the pool.
2018-04-18 09:57:44,560: Fetching data for query shopify_customers_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 09:57:44,554: 09:57:44 | 22 of 91 START table model agency_data_pipeline.fb_ads............... [RUN]
2018-04-18 09:57:44,561: Compiling model.agency_data_pipeline.fb_ads
2018-04-18 09:57:44,576: Acquiring new bigquery connection "fb_ads".
2018-04-18 09:57:44,578: Re-using an available connection from the pool.
2018-04-18 09:57:44,578: Fetching data for query fb_ads:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 09:57:44,937: Writing injected SQL for node "model.agency_data_pipeline.fb_ads"
2018-04-18 09:57:44,951: Writing injected SQL for node "model.agency_data_pipeline.shopify_customers_proc"
2018-04-18 09:57:45,975: Model SQL (fb_ads):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`fb_adcreative`





with fb_ads as (

	    
		   	SELECT 
			id ad_id,
			creative.creative_id creative_id,
			_sdc_sequence
			FROM `growth-engines-pipeline.fb_ads_luca_danni.ads`
		     
	   

)

SELECT
a.ad_id,
b.creative_id,
b.url
FROM (
    SELECT
    ad_id,
    creative_id,
    first_value(_sdc_sequence) OVER (PARTITION BY ad_id ORDER BY _sdc_sequence DESC) lv,
    _sdc_sequence
    FROM fb_ads
    ) a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`fb_adcreative` b
ON (
	a.creative_id = b.creative_id 
)
WHERE a.lv = a._sdc_sequence


2018-04-18 09:57:46,042: Model SQL (shopify_customers_proc):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc`





with customers as (

	
	SELECT
	'lucadanni' client_name,
	'Shopify' as lookup_platform,
	cast(created_at as date) created_at,
	id,
	first_name,
	last_name,
	email,
	_sdc_sequence,
	first_value(_sdc_sequence) over (partition by id, _sdc_sequence order by _sdc_sequence desc) lv
	FROM `growth-engines-pipeline.shopify_lucadanni.customers` 
	
	

)

SELECT
account,
client,
platform,
id,
min(created_at) created_at,
max(first_name) first_name,
max(last_name) last_name,
max(email) email
FROM (
	SELECT
	b.account,
	b.client,
	b.platform,
	created_at,
	id,
	first_name,
	last_name,
	email
	FROM customers a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
	ON ( a.client_name = b.client_name
	  AND a.lookup_platform = b.platform )
	where a.lv = a._sdc_sequence
)
group by account, client, platform, id

2018-04-18 09:57:48,170: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5ff182a7-6821-4626-a4b4-cd6e62841f8a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11183f860>]}
2018-04-18 09:57:48,491: 09:57:48 | 22 of 91 OK created table model agency_data_pipeline.fb_ads.......... [CREATE TABLE in 3.61s]
2018-04-18 09:57:50,416: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '5ff182a7-6821-4626-a4b4-cd6e62841f8a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1144b19b0>]}
2018-04-18 09:57:50,678: 09:57:50 | 21 of 91 OK created table model agency_data_pipeline.shopify_customers_proc [CREATE TABLE in 5.87s]
2018-04-18 09:57:50,679: 09:57:50 | 23 of 91 START table model agency_data_pipeline.bing_ads_stats....... [RUN]
2018-04-18 09:57:50,680: Compiling model.agency_data_pipeline.bing_ads_stats
2018-04-18 09:57:50,690: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_stats"
2018-04-18 09:57:50,679: 09:57:50 | 24 of 91 START table model agency_data_pipeline.ga_mcf_stats......... [RUN]
2018-04-18 09:57:50,691: Compiling model.agency_data_pipeline.ga_mcf_stats
2018-04-18 09:57:50,680: 09:57:50 | 25 of 91 START table model agency_data_pipeline.shopify_products_proc [RUN]
2018-04-18 09:57:50,697: Compiling model.agency_data_pipeline.shopify_products_proc
2018-04-18 09:57:50,721: Acquiring new bigquery connection "shopify_products_proc".
2018-04-18 09:57:50,722: Re-using an available connection from the pool.
2018-04-18 09:57:50,680: 09:57:50 | 26 of 91 START table model agency_data_pipeline.shopify_orders_proc.. [RUN]
2018-04-18 09:57:50,726: Compiling model.agency_data_pipeline.shopify_orders_proc
2018-04-18 09:57:50,724: Writing injected SQL for node "model.agency_data_pipeline.ga_mcf_stats"
2018-04-18 09:57:50,726: Acquiring new bigquery connection "bing_ads_stats".
2018-04-18 09:57:50,725: Fetching data for query shopify_products_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 09:57:50,745: Acquiring new bigquery connection "ga_mcf_stats".
2018-04-18 09:57:50,749: Acquiring new bigquery connection "shopify_orders_proc".
2018-04-18 09:57:50,749: Re-using an available connection from the pool.
2018-04-18 09:57:50,760: Re-using an available connection from the pool.
2018-04-18 09:57:50,765: Re-using an available connection from the pool.
2018-04-18 09:57:50,765: Fetching data for query shopify_orders_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 09:57:51,132: Writing injected SQL for node "model.agency_data_pipeline.shopify_products_proc"
2018-04-18 09:57:51,409: Writing injected SQL for node "model.agency_data_pipeline.shopify_orders_proc"
2018-04-18 09:57:51,693: Model SQL (bing_ads_stats):
select
a.date, 
a.account, 
a.channel,
a.platform,
url,
a.campaignname campaign,
utm_campaign,
cost,
clicks,
impressions,
transactions
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`bing_ads_ads` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`bing_ads_conversions` b
ON (
	a.date = b.date AND
	a.account = b.account AND
	a.campaignid = b.campaignid

)
2018-04-18 09:57:51,780: Unhandled error while executing None
404 GET https://www.googleapis.com/bigquery/v2/projects/growth-engines-pipeline/datasets/agency_data_pipeline/tables?pageToken=shopify_products_proc: Not found: Token shopify_products_proc
2018-04-18 09:57:51,781: 09:57:51 | 27 of 91 START table model agency_data_pipeline.agg_customers_union.. [RUN]
2018-04-18 09:57:51,781: Compiling model.agency_data_pipeline.agg_customers_union
2018-04-18 09:57:51,791: Writing injected SQL for node "model.agency_data_pipeline.agg_customers_union"
2018-04-18 09:57:51,791: Connection 'master' was left open.
2018-04-18 09:57:51,791: Connection 'shopify_products_proc' was left open.
2018-04-18 09:57:51,792: Connection 'ga_mcf_stats' was left open.
2018-04-18 09:57:51,792: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111858d30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x114434ef0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11183f0f0>]}
2018-04-18 09:57:51,793: Acquiring new bigquery connection "agg_customers_union".
2018-04-18 09:57:51,794: Opening a new connection (0 currently allocated)
2018-04-18 09:57:51,875: Model SQL (ga_mcf_stats):
SELECT  
date,
a.account account,
b.client client,
case when c.platform is null then "Unmapped" else c.platform end as platform,
case when c.channel is null then "Unmapped" else c.channel end as channel,
lower(a.source) source,
lower(a.medium) medium,
lower(campaign) campaign,
transactionid,
sum(transactions) first_touch_transactions,
sum(revenue) first_touch_revenue
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`ga_mcf_proc` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc` b 
ON ( a.account = b.account and
	a.lookup_platform = b.platform )
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc` c
ON ( lower(a.source) = c.source
  AND lower(a.medium) = c.medium 
  and a.account = c.account )
group by date, account, client, source, medium, campaign, platform, channel, transactionid
2018-04-18 09:57:51,991: Model SQL (shopify_products_proc):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc`, `growth-engines-pipeline`.`agency_data_pipeline`.`shopify_refunds_proc`





with products as (

	
	SELECT
	'lucadanni' client_name,
	'Shopify' as lookup_platform,
	product_type,
	product_id,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY product_id ORDER BY _sdc_sequence DESC) lv
	FROM `growth-engines-pipeline.shopify_lucadanni.products` 
	cross join unnest(variants)
	
	

)

SELECT
b.account,
b.client,
b.platform,
max(product_type) product_type,
product_id
FROM products a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
ON ( a.client_name = b.client_name
  AND a.lookup_platform = b.platform )
where a.lv = a._sdc_sequence
group by product_id, account, client, platform


2018-04-18 09:57:52,154: Encountered an error:
2018-04-18 09:57:52,154: 404 GET https://www.googleapis.com/bigquery/v2/projects/growth-engines-pipeline/datasets/agency_data_pipeline/tables?pageToken=shopify_products_proc: Not found: Token shopify_products_proc
2018-04-18 09:57:52,181: Traceback (most recent call last):
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/main.py", line 40, in main
    results, succeeded = handle_and_check(args)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/main.py", line 84, in handle_and_check
    task, res = run_from_args(parsed)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/main.py", line 138, in run_from_args
    results = run_from_task(task, proj, parsed)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/main.py", line 146, in run_from_task
    result = task.run()
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/task/run.py", line 26, in run
    results = runner.run(query, ModelRunner)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/runner.py", line 221, in run
    return self.run_from_graph(Selector, Runner, query)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/runner.py", line 208, in run_from_graph
    res = self.execute_nodes(linker, Runner, flat_graph, dep_list)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/runner.py", line 133, in execute_nodes
    for result in pool.imap_unordered(self.call_runner, args_list):
  File "/usr/local/opt/python3/Frameworks/Python.framework/Versions/3.6/lib/python3.6/multiprocessing/pool.py", line 735, in next
    raise value
  File "/usr/local/opt/python3/Frameworks/Python.framework/Versions/3.6/lib/python3.6/multiprocessing/pool.py", line 119, in worker
    result = (True, func(*args, **kwds))
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/runner.py", line 82, in call_runner
    result = runner.safe_run(flat_graph, existing)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/node_runners.py", line 139, in safe_run
    raise e
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/node_runners.py", line 108, in safe_run
    result = self.run(compiled_node, existing, flat_graph)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/node_runners.py", line 155, in run
    return self.execute(compiled_node, existing, flat_graph)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/node_runners.py", line 389, in execute
    materialization_macro.get('generator')(context)()
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/clients/jinja.py", line 51, in call
    return macro(*args, **kwargs)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/runtime.py", line 549, in __call__
    return self._invoke(arguments, autoescape)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/asyncsupport.py", line 110, in _invoke
    return original_invoke(self, arguments, autoescape)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/runtime.py", line 553, in _invoke
    rv = self._func(*arguments)
  File "<template>", line 55, in macro
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/sandbox.py", line 427, in call
    return __context.call(__obj, *args, **kwargs)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/runtime.py", line 260, in call
    return __obj(*args, **kwargs)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/context/common.py", line 48, in wrapped
    return getattr(self.adapter, fn)(*args, **kwargs)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/adapters/bigquery.py", line 154, in query_for_existing
    all_tables.extend(dataset.list_tables())
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/google/cloud/iterator.py", line 218, in _items_iter
    for page in self._page_iter(increment=False):
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/google/cloud/iterator.py", line 254, in _page_iter
    page = self._next_page()
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/google/cloud/iterator.py", line 348, in _next_page
    response = self._get_next_page_response()
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/google/cloud/iterator.py", line 399, in _get_next_page_response
    query_params=params)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/google/cloud/_http.py", line 293, in api_request
    raise exceptions.from_http_response(response)
google.cloud.exceptions.NotFound: 404 GET https://www.googleapis.com/bigquery/v2/projects/growth-engines-pipeline/datasets/agency_data_pipeline/tables?pageToken=shopify_products_proc: Not found: Token shopify_products_proc

2018-04-18 09:59:19,180: Tracking: tracking
2018-04-18 09:59:19,182: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104c50d68>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104c50e80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104c50940>]}
2018-04-18 09:59:20,016: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-04-18 09:59:20,044: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/growth-engines/dbt_modules
2018-04-18 09:59:20,050: Parsing get_column_values.sql
2018-04-18 09:59:20,069: Parsing get_url_parameter.sql
2018-04-18 09:59:20,075: Parsing split_part.sql
2018-04-18 09:59:20,084: Parsing table_exists.sql
2018-04-18 09:59:20,096: Parsing core.sql
2018-04-18 09:59:20,111: Parsing adapters/bigquery.sql
2018-04-18 09:59:20,118: Parsing adapters/common.sql
2018-04-18 09:59:20,137: Parsing adapters/postgres.sql
2018-04-18 09:59:20,144: Parsing adapters/redshift.sql
2018-04-18 09:59:20,167: Parsing etc/get_custom_schema.sql
2018-04-18 09:59:20,177: Parsing materializations/archive.sql
2018-04-18 09:59:20,214: Parsing materializations/bigquery.sql
2018-04-18 09:59:20,234: Parsing materializations/helpers.sql
2018-04-18 09:59:20,254: Parsing materializations/incremental.sql
2018-04-18 09:59:20,288: Parsing materializations/table.sql
2018-04-18 09:59:20,312: Parsing materializations/view.sql
2018-04-18 09:59:20,331: Parsing materializations/wrapper.sql
2018-04-18 09:59:20,337: Parsing schema_tests/accepted_values.sql
2018-04-18 09:59:20,344: Parsing schema_tests/not_null.sql
2018-04-18 09:59:20,348: Parsing schema_tests/relationships.sql
2018-04-18 09:59:20,354: Parsing schema_tests/unique.sql
2018-04-18 09:59:20,479: Parsing model.agency_data_pipeline.accounts_proc
2018-04-18 09:59:20,482: Parsing model.agency_data_pipeline.all_dates
2018-04-18 09:59:20,483: Parsing model.agency_data_pipeline.carts_proc
2018-04-18 09:59:20,484: Parsing model.agency_data_pipeline.clients_proc
2018-04-18 09:59:20,487: Parsing model.agency_data_pipeline.conversion_goals_proc
2018-04-18 09:59:20,489: Parsing model.agency_data_pipeline.mappings_ga_proc
2018-04-18 09:59:20,492: Acquiring new bigquery connection "master".
2018-04-18 09:59:20,492: Opening a new connection (0 currently allocated)
2018-04-18 09:59:20,496: Parsing model.agency_data_pipeline.monthend_dates
2018-04-18 09:59:20,497: Parsing model.agency_data_pipeline.adwords_ads
2018-04-18 09:59:20,499: Parsing model.agency_data_pipeline.adwords_campaigns
2018-04-18 09:59:20,501: Parsing model.agency_data_pipeline.adwords_conversions
2018-04-18 09:59:20,503: Parsing model.agency_data_pipeline.adwords_impression_share
2018-04-18 09:59:20,505: Parsing model.agency_data_pipeline.adwords_join
2018-04-18 09:59:20,508: Parsing model.agency_data_pipeline.adwords_stats
2018-04-18 09:59:20,510: Parsing model.agency_data_pipeline.adwords_urls
2018-04-18 09:59:20,513: Parsing model.agency_data_pipeline.bing_ads_ads
2018-04-18 09:59:20,515: Parsing model.agency_data_pipeline.bing_ads_conversions
2018-04-18 09:59:20,518: Parsing model.agency_data_pipeline.bing_ads_impression_share
2018-04-18 09:59:20,519: Parsing model.agency_data_pipeline.bing_ads_stats
2018-04-18 09:59:20,521: Parsing model.agency_data_pipeline.fb_adcreative
2018-04-18 09:59:20,529: Parsing model.agency_data_pipeline.fb_ads
2018-04-18 09:59:20,535: Parsing model.agency_data_pipeline.fb_ads_insights
2018-04-18 09:59:20,542: Parsing model.agency_data_pipeline.fb_ads_insights_conversions
2018-04-18 09:59:20,548: Parsing model.agency_data_pipeline.fb_ads_stats
2018-04-18 09:59:20,551: Parsing model.agency_data_pipeline.ga_conversions
2018-04-18 09:59:20,553: Parsing model.agency_data_pipeline.ga_traffic
2018-04-18 09:59:20,566: Parsing model.agency_data_pipeline.ga_transactions
2018-04-18 09:59:20,577: Parsing model.agency_data_pipeline.ga_mcf_proc
2018-04-18 09:59:20,580: Parsing model.agency_data_pipeline.ga_mcf_stats
2018-04-18 09:59:20,582: Parsing model.agency_data_pipeline.shopify_customers_proc
2018-04-18 09:59:20,590: Parsing model.agency_data_pipeline.shopify_orders_proc
2018-04-18 09:59:20,599: Parsing model.agency_data_pipeline.shopify_products_proc
2018-04-18 09:59:20,605: Parsing model.agency_data_pipeline.shopify_refunds_proc
2018-04-18 09:59:20,612: Parsing model.agency_data_pipeline.agg_campaign
2018-04-18 09:59:20,615: Parsing model.agency_data_pipeline.agg_customers_union
2018-04-18 09:59:20,617: Parsing model.agency_data_pipeline.agg_ga_campaign
2018-04-18 09:59:20,620: Parsing model.agency_data_pipeline.agg_ga_campaign_by_type
2018-04-18 09:59:20,624: Parsing model.agency_data_pipeline.agg_ga_transaction
2018-04-18 09:59:20,628: Parsing model.agency_data_pipeline.agg_ga_transaction_order_number
2018-04-18 09:59:20,631: Parsing model.agency_data_pipeline.agg_orders_union
2018-04-18 09:59:20,633: Parsing model.agency_data_pipeline.agg_platform_monthly
2018-04-18 09:59:20,635: Parsing model.agency_data_pipeline.agg_platforms_client
2018-04-18 09:59:20,638: Parsing model.agency_data_pipeline.agg_platforms_union
2018-04-18 09:59:20,641: Parsing model.agency_data_pipeline.agg_products
2018-04-18 09:59:20,644: Parsing model.agency_data_pipeline.agg_transaction
2018-04-18 09:59:20,647: Parsing model.agency_data_pipeline.agg_transaction_daily
2018-04-18 09:59:20,648: Parsing model.agency_data_pipeline.agg_transaction_line_item
2018-04-18 09:59:20,650: Parsing model.agency_data_pipeline.agg_transaction_line_item_type
2018-04-18 09:59:20,652: Parsing model.agency_data_pipeline.agg_transaction_order_number
2018-04-18 09:59:20,654: Parsing model.agency_data_pipeline.agg_transaction_product_type
2018-04-18 09:59:20,656: Parsing model.agency_data_pipeline.customers_by_transaction
2018-04-18 09:59:20,659: Parsing model.agency_data_pipeline.growth_customer_0_365
2018-04-18 09:59:20,662: Parsing model.agency_data_pipeline.growth_customer_0_365_segment
2018-04-18 09:59:20,665: Parsing model.agency_data_pipeline.growth_date_union
2018-04-18 09:59:20,668: Parsing model.agency_data_pipeline.growth_stats
2018-04-18 09:59:20,673: Parsing model.agency_data_pipeline.retention_0_365
2018-04-18 09:59:20,676: Parsing model.agency_data_pipeline.retention_0_365_new
2018-04-18 09:59:20,678: Parsing model.agency_data_pipeline.retention_0_365_reactivated
2018-04-18 09:59:20,681: Parsing model.agency_data_pipeline.retention_0_365_rebuy
2018-04-18 09:59:20,684: Parsing model.agency_data_pipeline.retention_365_730
2018-04-18 09:59:20,686: Parsing model.agency_data_pipeline.retention_730_plus
2018-04-18 09:59:20,688: Parsing model.agency_data_pipeline.retention_stats
2018-04-18 09:59:20,696: Parsing model.agency_data_pipeline.retention_stats_rebuy_rate
2018-04-18 09:59:20,700: Parsing model.agency_data_pipeline.retention_0_30
2018-04-18 09:59:20,702: Parsing model.agency_data_pipeline.retention_0_30_new
2018-04-18 09:59:20,705: Parsing model.agency_data_pipeline.retention_0_30_reactivated
2018-04-18 09:59:20,707: Parsing model.agency_data_pipeline.retention_0_30_rebuy
2018-04-18 09:59:20,710: Parsing model.agency_data_pipeline.retention_30_60
2018-04-18 09:59:20,712: Parsing model.agency_data_pipeline.retention_60_plus
2018-04-18 09:59:20,716: Parsing model.agency_data_pipeline.retention_stats_month
2018-04-18 09:59:20,722: Parsing model.agency_data_pipeline.retention_stats_rebuy_rate_month
2018-04-18 09:59:20,727: Parsing model.agency_data_pipeline.customers_first_purchase_proc
2018-04-18 09:59:20,729: Parsing model.agency_data_pipeline.customers_proc
2018-04-18 09:59:20,731: Parsing model.agency_data_pipeline.segment_list_customers
2018-04-18 09:59:20,733: Parsing model.agency_data_pipeline.segment_proc_customers
2018-04-18 09:59:20,735: Parsing model.agency_data_pipeline.segment_stats_customers
2018-04-18 09:59:20,737: Parsing model.agency_data_pipeline.segment_stats_customers_agg
2018-04-18 09:59:20,742: Parsing model.agency_data_pipeline.customers_first_purchase_product_type_proc
2018-04-18 09:59:20,745: Parsing model.agency_data_pipeline.customers_products_proc
2018-04-18 09:59:20,747: Parsing model.agency_data_pipeline.segment_list_customers_products
2018-04-18 09:59:20,749: Parsing model.agency_data_pipeline.segment_proc_customers_products
2018-04-18 09:59:20,752: Parsing model.agency_data_pipeline.segment_stats_customers_products
2018-04-18 09:59:20,754: Parsing model.agency_data_pipeline.segment_stats_customers_products_agg
2018-04-18 09:59:20,759: Parsing model.agency_data_pipeline.frequency_proc
2018-04-18 09:59:20,761: Parsing model.agency_data_pipeline.frequency_stats
2018-04-18 09:59:20,763: Parsing model.agency_data_pipeline.order_paths_agg
2018-04-18 09:59:20,765: Parsing model.agency_data_pipeline.order_paths_proc
2018-04-18 09:59:20,767: Parsing model.agency_data_pipeline.order_paths_stats
2018-04-18 09:59:20,769: Parsing model.agency_data_pipeline.products_proc
2018-04-18 09:59:20,772: Parsing model.agency_data_pipeline.segment_proc_sku
2018-04-18 09:59:20,775: Parsing model.agency_data_pipeline.segment_stats_category
2018-04-18 09:59:20,777: Parsing model.agency_data_pipeline.segment_stats_sku
2018-04-18 09:59:20,809: Found 91 models, 0 tests, 0 archives, 0 analyses, 46 macros, 0 operations
2018-04-18 09:59:20,905: 
2018-04-18 09:59:22,265: 09:59:22 | Concurrency: 4 threads (target='prod')
2018-04-18 09:59:22,265: 09:59:22 | 
2018-04-18 09:59:22,997: 09:59:22 | 1 of 91 START table model agency_data_pipeline.adwords_urls.......... [RUN]
2018-04-18 09:59:22,998: Compiling model.agency_data_pipeline.adwords_urls
2018-04-18 09:59:23,003: Writing injected SQL for node "model.agency_data_pipeline.adwords_urls"
2018-04-18 09:59:22,998: 09:59:22 | 2 of 91 START table model agency_data_pipeline.bing_ads_impression_share [RUN]
2018-04-18 09:59:23,003: Compiling model.agency_data_pipeline.bing_ads_impression_share
2018-04-18 09:59:23,009: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_impression_share"
2018-04-18 09:59:22,998: 09:59:22 | 3 of 91 START table model agency_data_pipeline.monthend_dates........ [RUN]
2018-04-18 09:59:22,998: 09:59:22 | 4 of 91 START table model agency_data_pipeline.conversion_goals_proc. [RUN]
2018-04-18 09:59:23,011: Acquiring new bigquery connection "adwords_urls".
2018-04-18 09:59:23,011: Compiling model.agency_data_pipeline.monthend_dates
2018-04-18 09:59:23,011: Compiling model.agency_data_pipeline.conversion_goals_proc
2018-04-18 09:59:23,012: Acquiring new bigquery connection "bing_ads_impression_share".
2018-04-18 09:59:23,024: Writing injected SQL for node "model.agency_data_pipeline.conversion_goals_proc"
2018-04-18 09:59:23,018: Opening a new connection (1 currently allocated)
2018-04-18 09:59:23,018: Writing injected SQL for node "model.agency_data_pipeline.monthend_dates"
2018-04-18 09:59:23,138: Opening a new connection (2 currently allocated)
2018-04-18 09:59:23,139: Acquiring new bigquery connection "monthend_dates".
2018-04-18 09:59:23,142: Acquiring new bigquery connection "conversion_goals_proc".
2018-04-18 09:59:23,150: Opening a new connection (3 currently allocated)
2018-04-18 09:59:23,245: Opening a new connection (4 currently allocated)
2018-04-18 09:59:24,509: Model SQL (bing_ads_impression_share):
SELECT 
date, 
account,
channel,
platform,
sum(impressions) impressions,
sum(available_impressions) available_impressions
FROM

(

SELECT  
cast(gregoriandate as date) date,
replace(accountname,',','') account,  
'Paid' as channel,
'Bing Ads' as platform,
case when impressionsharepercent is null then 0 else impressions end as impressions,
cast(round(case when ( impressionsharepercent is not null and impressionsharepercent > 0 ) then (impressions*100)/impressionsharepercent else 0 end) as int64) as available_impressions,
_sdc_sequence,
first_value(_sdc_sequence) OVER (PARTITION BY campaignid, gregoriandate ORDER BY _sdc_sequence DESC) lv
FROM `growth-engines-pipeline.bing_ads.campaign_performance_report` 

)

where lv = _sdc_sequence
group by date, account, channel, platform
2018-04-18 09:59:24,511: Model SQL (conversion_goals_proc):
select 
client,
platform,
goal_name,
max(goal_type) goal_type,
account,
max(time_of_entry) time_of_entry
from  ( 

SELECT  
client,
platform,
trim(replace(replace(lower(goal_name),',',''),' ','')) goal_name,
goal_type,
account,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY platform ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.conversion_goals` 

) 

WHERE lv = time_of_entry
group by client, platform, account, goal_name
2018-04-18 09:59:24,512: Model SQL (monthend_dates):
SELECT
date_in_range,
date_in_range_bom,
date_in_range_bom_mom,
unix_date_in_range,
unix_date_in_range_bom,
unix_date(date_in_range_bom_mom) unix_date_in_range_bom_mom,
yyyymm,
date_in_range_yoy,
unix_date(date_in_range_yoy) unix_date_in_range_yoy

FROM
(
	SELECT 
	date_in_range,
	date_in_range_bom,
	date_sub(date_in_range_bom, INTERVAL 1 MONTH) date_in_range_bom_mom,
  date_sub(date_in_range, INTERVAL 1 YEAR) date_in_range_yoy,
	unix_date_in_range,
	unix_date(date_in_range_bom) unix_date_in_range_bom,
	yyyymm,
	first_value(date_in_range) over (partition by yyyymm order by date_in_range desc) monthend_date_in_range
	FROM
	( 
		SELECT 
		date_in_range,
		date_trunc( date_in_range, MONTH) date_in_range_bom,
		unix_date(date_in_range) unix_date_in_range,
		format_date("%Y-%m", date_in_range) AS yyyymm
		FROM UNNEST(
		    GENERATE_DATE_ARRAY(DATE('2016-01-31'), CURRENT_DATE(), INTERVAL 1 DAY)
		) AS date_in_range
	)
)
where date_in_range = monthend_date_in_range
2018-04-18 09:59:24,513: Model SQL (adwords_urls):
SELECT
campaignid,
lower(trim(regexp_replace(replace(replace(replace(replace(finalurl,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url

FROM (

SELECT  
campaignid,
finalurl,
first_value(finalurl) OVER (PARTITION BY campaignid ORDER BY day DESC) lv
FROM `growth-engines-pipeline.adwords_2.FINAL_URL_REPORT`
)

WHERE lv = finalurl
group by campaignid, url
order by campaignid asc
2018-04-18 09:59:25,597: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e1beb8>]}
2018-04-18 09:59:25,621: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x101890c88>]}
2018-04-18 09:59:25,831: 09:59:25 | 2 of 91 OK created table model agency_data_pipeline.bing_ads_impression_share [CREATE TABLE in 2.59s]
2018-04-18 09:59:25,831: 09:59:25 | 5 of 91 START table model agency_data_pipeline.adwords_campaigns..... [RUN]
2018-04-18 09:59:25,831: Compiling model.agency_data_pipeline.adwords_campaigns
2018-04-18 09:59:25,837: Writing injected SQL for node "model.agency_data_pipeline.adwords_campaigns"
2018-04-18 09:59:25,840: Acquiring new bigquery connection "adwords_campaigns".
2018-04-18 09:59:25,842: Re-using an available connection from the pool.
2018-04-18 09:59:26,115: 09:59:26 | 3 of 91 OK created table model agency_data_pipeline.monthend_dates... [CREATE TABLE in 2.61s]
2018-04-18 09:59:26,115: 09:59:26 | 6 of 91 START table model agency_data_pipeline.clients_proc.......... [RUN]
2018-04-18 09:59:26,115: Compiling model.agency_data_pipeline.clients_proc
2018-04-18 09:59:26,128: Writing injected SQL for node "model.agency_data_pipeline.clients_proc"
2018-04-18 09:59:26,131: Acquiring new bigquery connection "clients_proc".
2018-04-18 09:59:26,131: Re-using an available connection from the pool.
2018-04-18 09:59:26,757: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e1bcc0>]}
2018-04-18 09:59:26,787: Model SQL (adwords_campaigns):
select
day,
campaignid, 
campaign,
account, 
channel,
platform,
sum(cost) cost,
sum(impressions) impressions,
sum(clicks) clicks,
sum(impression_share_num) impression_share_num,
sum(impression_share_den) impression_share_den
from 
  ( 
	SELECT  
	day,
	campaignid,
	campaign,
	account as account,
	'Paid' as channel,
	'Adwords' as platform,
	cost/1000000 cost, 
	impressions as impressions, 
	clicks, 
	case when searchimprshare is not null then impressions end as impression_share_num,
	case when searchimprshare is not null then impressions/(searchimprshare/100) end as impression_share_den,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY campaignid, day ORDER BY _sdc_sequence DESC) lv
	FROM `growth-engines-pipeline.adwords_2.CAMPAIGN_PERFORMANCE_REPORT`
  )
where lv = _sdc_sequence
group by day, campaignid, account, channel, platform, campaign
2018-04-18 09:59:26,829: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e06358>]}
2018-04-18 09:59:27,024: 09:59:27 | 4 of 91 OK created table model agency_data_pipeline.conversion_goals_proc [CREATE TABLE in 3.75s]
2018-04-18 09:59:27,025: 09:59:27 | 7 of 91 START table model agency_data_pipeline.ga_conversions........ [RUN]
2018-04-18 09:59:27,026: Compiling model.agency_data_pipeline.ga_conversions
2018-04-18 09:59:27,030: Writing injected SQL for node "model.agency_data_pipeline.ga_conversions"
2018-04-18 09:59:27,034: Acquiring new bigquery connection "ga_conversions".
2018-04-18 09:59:27,034: Re-using an available connection from the pool.
2018-04-18 09:59:27,276: 09:59:27 | 1 of 91 OK created table model agency_data_pipeline.adwords_urls..... [CREATE TABLE in 3.83s]
2018-04-18 09:59:27,276: 09:59:27 | 8 of 91 START table model agency_data_pipeline.bing_ads_ads.......... [RUN]
2018-04-18 09:59:27,276: Compiling model.agency_data_pipeline.bing_ads_ads
2018-04-18 09:59:27,286: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_ads"
2018-04-18 09:59:27,287: Acquiring new bigquery connection "bing_ads_ads".
2018-04-18 09:59:27,287: Re-using an available connection from the pool.
2018-04-18 09:59:27,791: Model SQL (clients_proc):
select 
client,
client_name,
account,
platform
from  ( 

SELECT  
client,
client_name,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.accounts`
where client_name != ''
) 

WHERE lv = time_of_entry
2018-04-18 09:59:27,993: Model SQL (ga_conversions):
select 
client,
client_name,
platform,
goal_name,
goal_type,
account,
time_of_entry
from  ( 

SELECT  
client,
client_name,
platform,
trim(goal_name) goal_name,
goal_type,
account,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform, goal_name ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.conversion_goals` 
WHERE platform = 'Google Analytics'

) 

WHERE lv = time_of_entry
2018-04-18 09:59:28,162: Model SQL (bing_ads_ads):
select
date, 
account, 
channel,
platform,
campaignid,
campaignname,
max(lower(trim(replace(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$','' ),'.html',''),'/'))) as url,
utm_campaign,
sum(cost) as cost,
sum(impressions) as impressions,
sum(clicks) as clicks,
sum(conversions) as conversions
from 
  ( 
SELECT  
cast(gregoriandate as date) date,
replace(accountname,',','') account,
'Paid' as channel,
'Bing Ads' as platform,
adid,
adtype,
campaignid, 
campaignname,
finalurl url,
case when regexp_contains(destinationurl, 'utm_campaign')
	then replace(lower(nullif(
  

    split(
        
  

    split(
        destinationurl,
        'utm_campaign='
        )[offset(1)]


,
        '&'
        )[offset(0)]


,'')),'+',' ') 
	else null end as utm_campaign,
spend cost, 
impressions, 
clicks, 
conversions,
_sdc_sequence,
first_value(_sdc_sequence) OVER (PARTITION BY adid, gregoriandate ORDER BY _sdc_sequence DESC) lv
FROM `growth-engines-pipeline.bing_ads.ad_performance_report` 
  )

where lv = _sdc_sequence
group by date, account, channel, platform, campaignid, campaignname, utm_campaign
2018-04-18 09:59:28,924: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104d42438>]}
2018-04-18 09:59:29,088: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e77630>]}
2018-04-18 09:59:29,168: 09:59:29 | 6 of 91 OK created table model agency_data_pipeline.clients_proc..... [CREATE TABLE in 2.81s]
2018-04-18 09:59:29,171: 09:59:29 | 9 of 91 START table model agency_data_pipeline.carts_proc............ [RUN]
2018-04-18 09:59:29,171: Compiling model.agency_data_pipeline.carts_proc
2018-04-18 09:59:29,177: Writing injected SQL for node "model.agency_data_pipeline.carts_proc"
2018-04-18 09:59:29,180: Acquiring new bigquery connection "carts_proc".
2018-04-18 09:59:29,181: Re-using an available connection from the pool.
2018-04-18 09:59:29,476: 09:59:29 | 7 of 91 OK created table model agency_data_pipeline.ga_conversions... [CREATE TABLE in 2.06s]
2018-04-18 09:59:29,477: 09:59:29 | 10 of 91 START table model agency_data_pipeline.adwords_conversions.. [RUN]
2018-04-18 09:59:29,477: Compiling model.agency_data_pipeline.adwords_conversions
2018-04-18 09:59:29,486: Writing injected SQL for node "model.agency_data_pipeline.adwords_conversions"
2018-04-18 09:59:29,488: Acquiring new bigquery connection "adwords_conversions".
2018-04-18 09:59:29,488: Re-using an available connection from the pool.
2018-04-18 09:59:30,157: Model SQL (carts_proc):
select 
client,
client_name,
account,
platform
from  ( 

SELECT  
client,
client_name,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.accounts`
WHERE platform in ('Shopify', 'Custom cart')

) 

WHERE lv = time_of_entry
2018-04-18 09:59:30,255: Model SQL (adwords_conversions):
select 
client,
client_name,
platform,
goal_name,
goal_type,
account,
time_of_entry
from  ( 

SELECT  
client,
client_name,
platform,
trim(lower(goal_name)) goal_name,
goal_type,
account,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform, goal_name ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.conversion_goals` 
WHERE platform = 'Adwords'

) 

WHERE lv = time_of_entry
2018-04-18 09:59:31,270: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104d42438>]}
2018-04-18 09:59:31,366: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e77630>]}
2018-04-18 09:59:31,439: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e06358>]}
2018-04-18 09:59:31,514: 09:59:31 | 9 of 91 OK created table model agency_data_pipeline.carts_proc....... [CREATE TABLE in 2.10s]
2018-04-18 09:59:31,514: 09:59:31 | 11 of 91 START table model agency_data_pipeline.all_dates............ [RUN]
2018-04-18 09:59:31,516: Compiling model.agency_data_pipeline.all_dates
2018-04-18 09:59:31,520: Writing injected SQL for node "model.agency_data_pipeline.all_dates"
2018-04-18 09:59:31,522: Acquiring new bigquery connection "all_dates".
2018-04-18 09:59:31,522: Re-using an available connection from the pool.
2018-04-18 09:59:31,761: 09:59:31 | 10 of 91 OK created table model agency_data_pipeline.adwords_conversions [CREATE TABLE in 1.89s]
2018-04-18 09:59:31,763: 09:59:31 | 12 of 91 START table model agency_data_pipeline.accounts_proc........ [RUN]
2018-04-18 09:59:31,764: Compiling model.agency_data_pipeline.accounts_proc
2018-04-18 09:59:31,784: Writing injected SQL for node "model.agency_data_pipeline.accounts_proc"
2018-04-18 09:59:31,787: Acquiring new bigquery connection "accounts_proc".
2018-04-18 09:59:31,787: Re-using an available connection from the pool.
2018-04-18 09:59:32,044: 09:59:32 | 8 of 91 OK created table model agency_data_pipeline.bing_ads_ads..... [CREATE TABLE in 4.16s]
2018-04-18 09:59:32,292: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e39240>]}
2018-04-18 09:59:32,315: Model SQL (all_dates):
SELECT 
date_in_range,
unix_date(date_in_range) unix_date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-04-18 09:59:32,561: 09:59:32 | 5 of 91 OK created table model agency_data_pipeline.adwords_campaigns [CREATE TABLE in 6.46s]
2018-04-18 09:59:32,580: Model SQL (accounts_proc):
select 
client,
account,
platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.accounts` 

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-04-18 09:59:33,432: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104d42438>]}
2018-04-18 09:59:33,666: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e77630>]}
2018-04-18 09:59:33,674: 09:59:33 | 11 of 91 OK created table model agency_data_pipeline.all_dates....... [CREATE TABLE in 1.92s]
2018-04-18 09:59:33,943: 09:59:33 | 12 of 91 OK created table model agency_data_pipeline.accounts_proc... [CREATE TABLE in 1.90s]
2018-04-18 09:59:33,944: 09:59:33 | 13 of 91 START table model agency_data_pipeline.adwords_ads.......... [RUN]
2018-04-18 09:59:33,946: Compiling model.agency_data_pipeline.adwords_ads
2018-04-18 09:59:33,945: 09:59:33 | 14 of 91 START table model agency_data_pipeline.mappings_ga_proc..... [RUN]
2018-04-18 09:59:33,953: Writing injected SQL for node "model.agency_data_pipeline.adwords_ads"
2018-04-18 09:59:33,953: Compiling model.agency_data_pipeline.mappings_ga_proc
2018-04-18 09:59:33,945: 09:59:33 | 15 of 91 START table model agency_data_pipeline.fb_ads_insights...... [RUN]
2018-04-18 09:59:33,945: 09:59:33 | 16 of 91 START table model agency_data_pipeline.shopify_refunds_proc. [RUN]
2018-04-18 09:59:33,959: Writing injected SQL for node "model.agency_data_pipeline.mappings_ga_proc"
2018-04-18 09:59:33,959: Compiling model.agency_data_pipeline.fb_ads_insights
2018-04-18 09:59:33,959: Compiling model.agency_data_pipeline.shopify_refunds_proc
2018-04-18 09:59:33,962: Acquiring new bigquery connection "adwords_ads".
2018-04-18 09:59:34,004: Re-using an available connection from the pool.
2018-04-18 09:59:34,004: Acquiring new bigquery connection "mappings_ga_proc".
2018-04-18 09:59:34,010: Re-using an available connection from the pool.
2018-04-18 09:59:33,979: Acquiring new bigquery connection "fb_ads_insights".
2018-04-18 09:59:34,023: Re-using an available connection from the pool.
2018-04-18 09:59:34,023: Fetching data for query fb_ads_insights:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 09:59:34,049: Acquiring new bigquery connection "shopify_refunds_proc".
2018-04-18 09:59:34,049: Re-using an available connection from the pool.
2018-04-18 09:59:34,052: Fetching data for query shopify_refunds_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 09:59:34,952: Model SQL (mappings_ga_proc):
select 
client,
account,
client_name,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
account,
client_name,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.mappings_ga` 

) 

WHERE lv = time_of_entry
and client in (select client from `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc` )
group by client, account, client_name, source, medium, platform_n, channel_n, time_of_entry
2018-04-18 09:59:34,952: Model SQL (adwords_ads):
SELECT  
day,
campaignid,
a.account as account,
utm_campaign,
sum( case when b.goal_type = 'Transaction' then conversions else 0 end ) as transactions
FROM (

	SELECT  
	day,
	adid,
	campaignid,
	account,
	lower(conversionname) conversionname,
	conversions,
	lower(campaign) utm_campaign,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY campaignid, day ORDER BY _sdc_sequence DESC) lv
	FROM
	`growth-engines-pipeline.adwords_2.AD_PERFORMANCE_REPORT`

) a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_conversions` b
ON ( a.conversionname = b.goal_name
	AND a.account = b.account )
WHERE lv = _sdc_sequence
group by day, campaignid, account, utm_campaign
2018-04-18 09:59:35,303: Writing injected SQL for node "model.agency_data_pipeline.shopify_refunds_proc"
2018-04-18 09:59:36,365: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_insights"
2018-04-18 09:59:36,635: Model SQL (shopify_refunds_proc):




with refunds as (

	
	SELECT
	order_number,
	checkout_id,
	financial_status,
	line_item_id,
	quantity,
	subtotal,
	line_item.variant_id variant_id,
	line_item.id refund_id,
 	_sdc_sequence
	FROM `growth-engines-pipeline.shopify_lucadanni.orders` 
	cross join unnest(refunds), unnest(refund_line_items)
  	where financial_status like '%refund%'
	
	

)

SELECT * 
FROM 
	(
    SELECT
	order_number,
	checkout_id,
	financial_status,
	line_item_id,
	quantity,
	subtotal refund_amount,
	variant_id,
	refund_id,
 	_sdc_sequence,
    first_value(_sdc_sequence) OVER (PARTITION BY order_number, line_item_id ORDER BY _sdc_sequence DESC) lv
    FROM refunds
   	) 
WHERE lv = _sdc_sequence


2018-04-18 09:59:37,158: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e41080>]}
2018-04-18 09:59:37,172: Model SQL (fb_ads_insights):




with fb_ads_insights as (

	    
		   	SELECT 
			date_start,
			campaign_id,
			campaign_name,
			ad_id,
			account_name,
			spend,
			reach,
			inline_link_clicks,
			_sdc_sequence,
			first_value(_sdc_sequence) OVER (PARTITION BY date_start, ad_id, campaign_id ORDER BY _sdc_sequence DESC) lv
			FROM `growth-engines-pipeline.fb_ads_luca_danni.ads_insights`
		    
	   

)

select
date_start date,
campaign_id,
campaign_name campaign,
ad_id,
account_name account,
max(spend) cost,
max(reach) impressions,
max(inline_link_clicks) clicks
from fb_ads_insights
where lv = _sdc_sequence
group by date, campaign_id, ad_id, account, campaign


2018-04-18 09:59:37,370: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e069e8>]}
2018-04-18 09:59:37,402: 09:59:37 | 14 of 91 OK created table model agency_data_pipeline.mappings_ga_proc [CREATE TABLE in 3.20s]
2018-04-18 09:59:37,403: 09:59:37 | 17 of 91 START table model agency_data_pipeline.fb_ads_insights_conversions [RUN]
2018-04-18 09:59:37,404: Compiling model.agency_data_pipeline.fb_ads_insights_conversions
2018-04-18 09:59:37,413: Acquiring new bigquery connection "fb_ads_insights_conversions".
2018-04-18 09:59:37,413: Re-using an available connection from the pool.
2018-04-18 09:59:37,414: Fetching data for query fb_ads_insights_conversions:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 09:59:37,658: 09:59:37 | 13 of 91 OK created table model agency_data_pipeline.adwords_ads..... [CREATE TABLE in 3.42s]
2018-04-18 09:59:37,659: 09:59:37 | 18 of 91 START table model agency_data_pipeline.bing_ads_conversions. [RUN]
2018-04-18 09:59:37,660: Compiling model.agency_data_pipeline.bing_ads_conversions
2018-04-18 09:59:37,665: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_conversions"
2018-04-18 09:59:37,667: Acquiring new bigquery connection "bing_ads_conversions".
2018-04-18 09:59:37,667: Re-using an available connection from the pool.
2018-04-18 09:59:37,815: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_insights_conversions"
2018-04-18 09:59:38,615: Model SQL (fb_ads_insights_conversions):




with fb_ads_insights_conversions as (

	    
		   	SELECT 
			date_start,
			campaign_id,
			campaign_name,
			ad_id,
			account_name,
			spend,
			reach,
			inline_link_clicks,
			_sdc_sequence,
			action_type,
			value
			FROM `growth-engines-pipeline.fb_ads_luca_danni.ads_insights`
			cross join unnest(actions)
		    
	   

)

SELECT * 
FROM 
	(
    SELECT
    date_start date,
    campaign_id,
    campaign_name campaign,
    ad_id,
    account_name account,
    action_type,
    value conversions,
    first_value(_sdc_sequence) OVER (PARTITION BY ad_id, date_start ORDER BY _sdc_sequence DESC) lv,
    _sdc_sequence
    FROM fb_ads_insights_conversions
   	)
where lv = _sdc_sequence
and action_type like '%purchase%'


2018-04-18 09:59:38,699: Model SQL (bing_ads_conversions):
SELECT
date, 
a.account account, 
a.channel channel,
a.platform platform,
campaignid,
campaignname,
sum( case when b.goal_type = 'Transactions' then conversions else 0 end ) as transactions
FROM

  ( 
SELECT  
cast(gregoriandate as date) date,
replace(accountname,',','') account,
'Paid' as channel,
'Bing Ads' as platform,
trim(replace(replace(lower(goal),',',''),' ','')) goal,
goalid,
campaignid,
campaignname,
conversions,
_sdc_sequence,
first_value(_sdc_sequence) OVER (PARTITION BY campaignid, goalid, gregoriandate ORDER BY _sdc_sequence DESC) lv
FROM `growth-engines-pipeline.bing_ads.goals_and_funnels_report` 

  ) a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`conversion_goals_proc` b
ON (
	a.account = b.account AND
	a.platform = b.platform AND
	a.goal = b.goal_name
)
where a.lv = a._sdc_sequence
group by date, account, channel, platform, campaignid, campaignname
2018-04-18 09:59:38,868: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x101853470>]}
2018-04-18 09:59:39,112: 09:59:39 | 16 of 91 OK created table model agency_data_pipeline.shopify_refunds_proc [CREATE TABLE in 4.91s]
2018-04-18 09:59:39,113: 09:59:39 | 19 of 91 START table model agency_data_pipeline.fb_adcreative........ [RUN]
2018-04-18 09:59:39,113: Compiling model.agency_data_pipeline.fb_adcreative
2018-04-18 09:59:39,119: Acquiring new bigquery connection "fb_adcreative".
2018-04-18 09:59:39,119: Re-using an available connection from the pool.
2018-04-18 09:59:39,120: Fetching data for query fb_adcreative:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 09:59:39,463: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x101853780>]}
2018-04-18 09:59:39,496: Writing injected SQL for node "model.agency_data_pipeline.fb_adcreative"
2018-04-18 09:59:39,749: 09:59:39 | 15 of 91 OK created table model agency_data_pipeline.fb_ads_insights. [CREATE TABLE in 5.50s]
2018-04-18 09:59:39,749: 09:59:39 | 20 of 91 START table model agency_data_pipeline.ga_mcf_proc.......... [RUN]
2018-04-18 09:59:39,750: Compiling model.agency_data_pipeline.ga_mcf_proc
2018-04-18 09:59:39,754: Writing injected SQL for node "model.agency_data_pipeline.ga_mcf_proc"
2018-04-18 09:59:39,755: Acquiring new bigquery connection "ga_mcf_proc".
2018-04-18 09:59:39,755: Re-using an available connection from the pool.
2018-04-18 09:59:40,315: Model SQL (fb_adcreative):




with fb_adcreative as (


	    
		   	SELECT 
			id,
			object_url,
			url_tags,
			_sdc_sequence
			FROM `growth-engines-pipeline.fb_ads_luca_danni.adcreative`
		    
	   
)

select creative_id, max(url) url
from (
  select
  id creative_id,
  lower(trim(regexp_replace(replace(replace(replace(replace(object_url,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
  first_value(_sdc_sequence) OVER (PARTITION BY id ORDER BY _sdc_sequence DESC) lv,
  _sdc_sequence
  from fb_adcreative
  )
where lv = _sdc_sequence
group by creative_id


2018-04-18 09:59:40,715: Model SQL (ga_mcf_proc):
SELECT 
date,
account,
'Google Analytics' as lookup_platform,
source_medium_path,
trim(lower(split(split(source_medium_path,'->')[SAFE_ORDINAL(1)],'/')[SAFE_ORDINAL(1)])) as source,
trim(lower(split(split(source_medium_path,'->')[SAFE_ORDINAL(1)],'/')[SAFE_ORDINAL(2)])) as medium,
first_interaction_campaign campaign,
cast(regexp_replace(transaction_id, r'#', '') as int64) transactionid,
max(first_interaction_conversions) transactions,
max(first_interaction_conversion_value) revenue
FROM `growth-engines-pipeline.agency_data_pipeline.ga_mcf`
where account in (select account from `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc` where platform = 'Google Analytics')
group by date, account, source, medium, campaign, source_medium_path, lookup_platform, transactionid
2018-04-18 09:59:40,898: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x101878588>]}
2018-04-18 09:59:41,150: 09:59:41 | 18 of 91 OK created table model agency_data_pipeline.bing_ads_conversions [CREATE TABLE in 3.24s]
2018-04-18 09:59:42,496: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1018d4898>]}
2018-04-18 09:59:42,782: 09:59:42 | 19 of 91 OK created table model agency_data_pipeline.fb_adcreative... [CREATE TABLE in 3.38s]
2018-04-18 09:59:42,989: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10189dbe0>]}
2018-04-18 09:59:43,237: 09:59:43 | 17 of 91 OK created table model agency_data_pipeline.fb_ads_insights_conversions [CREATE TABLE in 5.58s]
2018-04-18 09:59:46,252: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104d9d668>]}
2018-04-18 09:59:46,710: 09:59:46 | 20 of 91 OK created table model agency_data_pipeline.ga_mcf_proc..... [CREATE TABLE in 6.50s]
2018-04-18 09:59:46,711: 09:59:46 | 21 of 91 START table model agency_data_pipeline.fb_ads............... [RUN]
2018-04-18 09:59:46,711: Compiling model.agency_data_pipeline.fb_ads
2018-04-18 09:59:46,716: 09:59:46 | 22 of 91 START table model agency_data_pipeline.shopify_customers_proc [RUN]
2018-04-18 09:59:46,724: Acquiring new bigquery connection "fb_ads".
2018-04-18 09:59:46,724: Compiling model.agency_data_pipeline.shopify_customers_proc
2018-04-18 09:59:46,724: Re-using an available connection from the pool.
2018-04-18 09:59:46,736: Fetching data for query fb_ads:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 09:59:46,738: Acquiring new bigquery connection "shopify_customers_proc".
2018-04-18 09:59:46,747: Re-using an available connection from the pool.
2018-04-18 09:59:46,747: Fetching data for query shopify_customers_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 09:59:47,132: Writing injected SQL for node "model.agency_data_pipeline.fb_ads"
2018-04-18 09:59:47,148: Writing injected SQL for node "model.agency_data_pipeline.shopify_customers_proc"
2018-04-18 09:59:48,042: Model SQL (fb_ads):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`fb_adcreative`





with fb_ads as (

	    
		   	SELECT 
			id ad_id,
			creative.creative_id creative_id,
			_sdc_sequence
			FROM `growth-engines-pipeline.fb_ads_luca_danni.ads`
		     
	   

)

SELECT
a.ad_id,
b.creative_id,
b.url
FROM (
    SELECT
    ad_id,
    creative_id,
    first_value(_sdc_sequence) OVER (PARTITION BY ad_id ORDER BY _sdc_sequence DESC) lv,
    _sdc_sequence
    FROM fb_ads
    ) a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`fb_adcreative` b
ON (
	a.creative_id = b.creative_id 
)
WHERE a.lv = a._sdc_sequence


2018-04-18 09:59:48,092: Model SQL (shopify_customers_proc):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc`





with customers as (

	
	SELECT
	'lucadanni' client_name,
	'Shopify' as lookup_platform,
	cast(created_at as date) created_at,
	id,
	first_name,
	last_name,
	email,
	_sdc_sequence,
	first_value(_sdc_sequence) over (partition by id, _sdc_sequence order by _sdc_sequence desc) lv
	FROM `growth-engines-pipeline.shopify_lucadanni.customers` 
	
	

)

SELECT
account,
client,
platform,
id,
min(created_at) created_at,
max(first_name) first_name,
max(last_name) last_name,
max(email) email
FROM (
	SELECT
	b.account,
	b.client,
	b.platform,
	created_at,
	id,
	first_name,
	last_name,
	email
	FROM customers a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
	ON ( a.client_name = b.client_name
	  AND a.lookup_platform = b.platform )
	where a.lv = a._sdc_sequence
)
group by account, client, platform, id

2018-04-18 09:59:50,220: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x101897978>]}
2018-04-18 09:59:50,526: 09:59:50 | 21 of 91 OK created table model agency_data_pipeline.fb_ads.......... [CREATE TABLE in 3.51s]
2018-04-18 09:59:53,579: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x101897a20>]}
2018-04-18 09:59:53,818: 09:59:53 | 22 of 91 OK created table model agency_data_pipeline.shopify_customers_proc [CREATE TABLE in 6.86s]
2018-04-18 09:59:53,819: 09:59:53 | 23 of 91 START table model agency_data_pipeline.ga_mcf_stats......... [RUN]
2018-04-18 09:59:53,820: 09:59:53 | 24 of 91 START table model agency_data_pipeline.agg_customers_union.. [RUN]
2018-04-18 09:59:53,820: 09:59:53 | 25 of 91 START table model agency_data_pipeline.bing_ads_stats....... [RUN]
2018-04-18 09:59:53,820: Compiling model.agency_data_pipeline.ga_mcf_stats
2018-04-18 09:59:53,820: 09:59:53 | 26 of 91 START table model agency_data_pipeline.shopify_orders_proc.. [RUN]
2018-04-18 09:59:53,821: Compiling model.agency_data_pipeline.agg_customers_union
2018-04-18 09:59:53,821: Compiling model.agency_data_pipeline.bing_ads_stats
2018-04-18 09:59:53,834: Compiling model.agency_data_pipeline.shopify_orders_proc
2018-04-18 09:59:53,835: Writing injected SQL for node "model.agency_data_pipeline.ga_mcf_stats"
2018-04-18 09:59:53,843: Writing injected SQL for node "model.agency_data_pipeline.agg_customers_union"
2018-04-18 09:59:53,851: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_stats"
2018-04-18 09:59:53,877: Acquiring new bigquery connection "shopify_orders_proc".
2018-04-18 09:59:53,879: Acquiring new bigquery connection "bing_ads_stats".
2018-04-18 09:59:53,885: Re-using an available connection from the pool.
2018-04-18 09:59:53,880: Acquiring new bigquery connection "agg_customers_union".
2018-04-18 09:59:53,882: Acquiring new bigquery connection "ga_mcf_stats".
2018-04-18 09:59:53,886: Re-using an available connection from the pool.
2018-04-18 09:59:53,890: Fetching data for query shopify_orders_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 09:59:53,891: Re-using an available connection from the pool.
2018-04-18 09:59:53,894: Re-using an available connection from the pool.
2018-04-18 09:59:54,514: Writing injected SQL for node "model.agency_data_pipeline.shopify_orders_proc"
2018-04-18 09:59:54,869: Model SQL (bing_ads_stats):
select
a.date, 
a.account, 
a.channel,
a.platform,
url,
a.campaignname campaign,
utm_campaign,
cost,
clicks,
impressions,
transactions
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`bing_ads_ads` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`bing_ads_conversions` b
ON (
	a.date = b.date AND
	a.account = b.account AND
	a.campaignid = b.campaignid

)
2018-04-18 09:59:54,878: Model SQL (agg_customers_union):
SELECT *
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`shopify_customers_proc`
2018-04-18 09:59:54,887: Model SQL (ga_mcf_stats):
SELECT  
date,
a.account account,
b.client client,
case when c.platform is null then "Unmapped" else c.platform end as platform,
case when c.channel is null then "Unmapped" else c.channel end as channel,
lower(a.source) source,
lower(a.medium) medium,
lower(campaign) campaign,
transactionid,
sum(transactions) first_touch_transactions,
sum(revenue) first_touch_revenue
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`ga_mcf_proc` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc` b 
ON ( a.account = b.account and
	a.lookup_platform = b.platform )
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc` c
ON ( lower(a.source) = c.source
  AND lower(a.medium) = c.medium 
  and a.account = c.account )
group by date, account, client, source, medium, campaign, platform, channel, transactionid
2018-04-18 09:59:55,334: Model SQL (shopify_orders_proc):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc`, `growth-engines-pipeline`.`agency_data_pipeline`.`shopify_refunds_proc`





with orders as (

	
	SELECT
	'lucadanni' client_name,
	'Shopify' as lookup_platform,
	created_at,
	order_number,
	quantity,
	cast(pre_tax_price as float64) price, 
	total_line_items_price total_order_price_undiscounted,
	total_discounts,
	cast(discounted_price as float64) total_order_shipping_price,
	total_price_usd total_order_price_incl_shipping,
	checkout_id,
	product_id, 
	landing_site,
	sku, 
	variant_title, 
	variant_id,
	_id line_item_id,
	customer.id customer_id,
	customer.orders_count orders_count,
	customer.created_at customer_created_at,
	customer.last_order_id last_order_id,
	financial_status,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY order_number, _id ORDER BY _sdc_sequence DESC) lv
	FROM `growth-engines-pipeline.shopify_lucadanni.orders` 
	cross join unnest(line_items), unnest(shipping_lines)
	where source_name != 'shopify_draft_order'
	
	

)

SELECT
b.account,
b.client,
b.platform,
created_at,
a.order_number,
a.quantity,
c.quantity refund_quantity,
case when c.quantity is not null then a.quantity - c.quantity else a.quantity end as final_quantity,
price, 
total_order_price_undiscounted,
total_discounts,
total_order_shipping_price,
total_order_price_incl_shipping,
refund_amount,
case when refund_amount is not null then price - refund_amount else price end as final_price,
a.checkout_id,
a.product_id, 
landing_site,
sku, 
variant_title, 
a.variant_id,
a.line_item_id,	
customer_id,
orders_count,
customer_created_at,
last_order_id,
a.financial_status
FROM orders a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
ON ( a.client_name = b.client_name
  AND a.lookup_platform = b.platform )
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`shopify_refunds_proc` c
ON ( a.order_number = c.order_number
	AND a.line_item_id = c.line_item_id )   	
where a.lv = a._sdc_sequence


2018-04-18 09:59:57,084: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e06128>]}
2018-04-18 09:59:57,372: 09:59:57 | 25 of 91 OK created table model agency_data_pipeline.bing_ads_stats.. [CREATE TABLE in 3.26s]
2018-04-18 09:59:57,372: 09:59:57 | 27 of 91 START table model agency_data_pipeline.shopify_products_proc [RUN]
2018-04-18 09:59:57,372: Compiling model.agency_data_pipeline.shopify_products_proc
2018-04-18 09:59:57,388: Acquiring new bigquery connection "shopify_products_proc".
2018-04-18 09:59:57,388: Re-using an available connection from the pool.
2018-04-18 09:59:57,388: Fetching data for query shopify_products_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 09:59:57,762: Writing injected SQL for node "model.agency_data_pipeline.shopify_products_proc"
2018-04-18 09:59:58,465: Model SQL (shopify_products_proc):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc`, `growth-engines-pipeline`.`agency_data_pipeline`.`shopify_refunds_proc`





with products as (

	
	SELECT
	'lucadanni' client_name,
	'Shopify' as lookup_platform,
	product_type,
	product_id,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY product_id ORDER BY _sdc_sequence DESC) lv
	FROM `growth-engines-pipeline.shopify_lucadanni.products` 
	cross join unnest(variants)
	
	

)

SELECT
b.account,
b.client,
b.platform,
max(product_type) product_type,
product_id
FROM products a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
ON ( a.client_name = b.client_name
  AND a.lookup_platform = b.platform )
where a.lv = a._sdc_sequence
group by product_id, account, client, platform


2018-04-18 09:59:59,320: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e77a20>]}
2018-04-18 09:59:59,566: 09:59:59 | 24 of 91 OK created table model agency_data_pipeline.agg_customers_union [CREATE TABLE in 5.50s]
2018-04-18 10:00:00,389: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1018e1240>]}
2018-04-18 10:00:00,653: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e06128>]}
2018-04-18 10:00:01,015: 10:00:01 | 23 of 91 OK created table model agency_data_pipeline.ga_mcf_stats.... [CREATE TABLE in 6.57s]
2018-04-18 10:00:01,253: 10:00:01 | 27 of 91 OK created table model agency_data_pipeline.shopify_products_proc [CREATE TABLE in 3.28s]
2018-04-18 10:00:04,215: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x101898b70>]}
2018-04-18 10:00:04,486: 10:00:04 | 26 of 91 OK created table model agency_data_pipeline.shopify_orders_proc [CREATE TABLE in 10.38s]
2018-04-18 10:00:04,487: 10:00:04 | 28 of 91 START table model agency_data_pipeline.agg_products......... [RUN]
2018-04-18 10:00:04,487: Compiling model.agency_data_pipeline.agg_products
2018-04-18 10:00:04,492: 10:00:04 | 29 of 91 START table model agency_data_pipeline.ga_traffic........... [RUN]
2018-04-18 10:00:04,493: Compiling model.agency_data_pipeline.ga_traffic
2018-04-18 10:00:04,496: Writing injected SQL for node "model.agency_data_pipeline.agg_products"
2018-04-18 10:00:04,496: 10:00:04 | 30 of 91 START table model agency_data_pipeline.agg_orders_union..... [RUN]
2018-04-18 10:00:04,512: Compiling model.agency_data_pipeline.agg_orders_union
2018-04-18 10:00:04,497: 10:00:04 | 31 of 91 START table model agency_data_pipeline.ga_transactions...... [RUN]
2018-04-18 10:00:04,532: Compiling model.agency_data_pipeline.ga_transactions
2018-04-18 10:00:04,525: Writing injected SQL for node "model.agency_data_pipeline.agg_orders_union"
2018-04-18 10:00:04,544: Acquiring new bigquery connection "agg_products".
2018-04-18 10:00:04,544: Re-using an available connection from the pool.
2018-04-18 10:00:04,532: Acquiring new bigquery connection "ga_traffic".
2018-04-18 10:00:04,548: Re-using an available connection from the pool.
2018-04-18 10:00:04,548: Fetching data for query ga_traffic:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'GA Traffic'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 10:00:04,550: Acquiring new bigquery connection "agg_orders_union".
2018-04-18 10:00:04,550: Re-using an available connection from the pool.
2018-04-18 10:00:04,569: Acquiring new bigquery connection "ga_transactions".
2018-04-18 10:00:04,569: Re-using an available connection from the pool.
2018-04-18 10:00:04,570: Fetching data for query ga_transactions:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Google Analytics'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 10:00:05,435: Model SQL (agg_orders_union):
SELECT
account,
client,
platform,
created_at,
order_number,
quantity,
refund_quantity,
final_quantity,
price, 
total_order_price_undiscounted,
total_discounts,
total_order_shipping_price,
total_order_price_incl_shipping,
refund_amount,
final_price,
checkout_id,
product_id, 
landing_site,
sku, 
variant_title, 
variant_id,
line_item_id,	
customer_id,
orders_count,
customer_created_at,
last_order_id,
financial_status
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`shopify_orders_proc`
2018-04-18 10:00:05,604: Model SQL (agg_products):
SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`shopify_products_proc`
2018-04-18 10:00:05,808: Fetching data for query ga_traffic:


        select
            goal_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_conversions`

        
        ##where 1 = 1
        where goal_type = 'Conversion'
        
        
        
        ##and 2 = 2
        and client_name = 'lucadanni'
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 10:00:06,021: Fetching data for query ga_transactions:


        select
            goal_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_conversions`

        
        ##where 1 = 1
        where goal_type = 'Conversion'
        
        
        
        ##and 2 = 2
        and client_name = 'lucadanni'
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 10:00:06,690: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104dd2f98>]}
2018-04-18 10:00:06,944: 10:00:06 | 28 of 91 OK created table model agency_data_pipeline.agg_products.... [CREATE TABLE in 2.20s]
2018-04-18 10:00:06,944: 10:00:06 | 32 of 91 START table model agency_data_pipeline.adwords_join......... [RUN]
2018-04-18 10:00:06,945: Compiling model.agency_data_pipeline.adwords_join
2018-04-18 10:00:06,954: Writing injected SQL for node "model.agency_data_pipeline.adwords_join"
2018-04-18 10:00:06,954: Acquiring new bigquery connection "adwords_join".
2018-04-18 10:00:06,955: Re-using an available connection from the pool.
2018-04-18 10:00:07,027: Writing injected SQL for node "model.agency_data_pipeline.ga_traffic"
2018-04-18 10:00:07,443: Writing injected SQL for node "model.agency_data_pipeline.ga_transactions"
2018-04-18 10:00:07,761: Model SQL (adwords_join):
select
a.day,
a.campaignid, 
a.campaign,
a.account, 
channel,
platform,
url,
utm_campaign,
cost,
impressions,
clicks,
impression_share_num,
impression_share_den,
transactions
FROM ( 
	
	select
	day,
	a.campaign,
	a.campaignid, 
	account, 
	channel,
	platform,
	url,
	cost,
	impressions,
	clicks,
	impression_share_num,
	impression_share_den
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_campaigns` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_urls` b
	ON a.campaignid = b.campaignid

) a 
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_ads` b
ON ( a.campaignid = b.campaignid
	and a.day = b.day )
2018-04-18 10:00:07,919: Model SQL (ga_traffic):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc`, `growth-engines-pipeline`.`agency_data_pipeline`.`ga_conversions`


##`growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` 



with ga_report as (

	    

	    	
	    	
		   	SELECT
		   	'lucadanni' as client_name,
		   	'GA Traffic' as lookup_platform,
			lower(trim(regexp_replace(replace(replace(replace(replace(CONCAT(hostname,landingpagepath),'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
			date,
			lower(source) source,
			lower(medium) medium,
			lower(campaign) campaign,
			sessions,
			## goal completion columns
							
				goalcompletionsall as goal_completions,		
			
			_sdc_sequence,
			first_value(_sdc_sequence) OVER (PARTITION BY hostname, landingpagepath, date, source, medium, campaign ORDER BY _sdc_sequence DESC) lv
			FROM `growth-engines-pipeline.ga_lucadanni_traffic.report` 

		    
	   

)


SELECT  
cast(date as date) date,
b.account,
b.client client,
c.source source,
c.medium medium,
a.campaign campaign,
concat(a.source, ' / ', a.medium) source_medium,  
case when c.platform is null then "Unmapped" else c.platform end as platform,
case when c.channel is null then "Unmapped" else c.channel end as channel,
regexp_replace(url, r'offers.|offer.|get.|info.|pos.|go.|join.|pages.','') url,
max(sessions) sessions,
max(goal_completions) goal_completions
FROM ga_report a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
ON ( a.client_name = b.client_name 
	AND a.lookup_platform = b.platform )
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc` c
ON ( a.source = c.source
  AND a.medium = c.medium 
  AND a.client_name = c.client_name )
GROUP BY date, account, client, source, medium, campaign, source_medium, platform, channel, url


2018-04-18 10:00:08,181: Model SQL (ga_transactions):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc`, `growth-engines-pipeline`.`agency_data_pipeline`.`ga_conversions`


##`growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` 



with ga_report as (

	    

	    	
	    	
		   	SELECT
		   	'lucadanni' as client_name,
		   	'Google Analytics' as lookup_platform,
			lower(trim(regexp_replace(replace(replace(replace(replace(CONCAT(hostname,landingpagepath),'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
			date,
			lower(source) source,
			lower(medium) medium,
			lower(campaign) campaign,
			cast(regexp_replace(transactionid, r'#', '') as int64) transactionid,
			transactions last_touch_transactions,
			(transactionrevenue - transactionshipping - transactiontax) as last_touch_revenue,
			transactionshipping,
			transactiontax,
			_sdc_sequence,
			first_value(_sdc_sequence) OVER (PARTITION BY hostname, landingpagepath, date, source, medium, transactionid ORDER BY _sdc_sequence DESC) lv
			FROM `growth-engines-pipeline.ga_lucadanni.report` 

		    
	   

)


SELECT  
cast(date as date) date,
b.account,
b.client client,
c.source source,
c.medium medium,
a.campaign campaign,
concat(a.source, ' / ', a.medium) source_medium,  
case when c.platform is null then "Unmapped" else c.platform end as platform,
case when c.channel is null then "Unmapped" else c.channel end as channel,
regexp_replace(url, r'offers.|offer.|get.|info.|pos.|go.|join.|pages.','') url,
transactionid,
max(last_touch_transactions) last_touch_transactions,
max(last_touch_revenue) last_touch_revenue,
max(transactionshipping) last_touch_shipping,
max(transactiontax) last_touch_tax
FROM ga_report a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
ON ( a.client_name = b.client_name 
	AND a.lookup_platform = b.platform )
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc` c
ON ( a.source = c.source
  AND a.medium = c.medium 
  AND a.client_name = c.client_name )
GROUP BY date, account, client, source, medium, campaign, source_medium, platform, channel, url, transactionid


2018-04-18 10:00:13,224: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104dd2f98>]}
2018-04-18 10:00:13,234: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1018a3128>]}
2018-04-18 10:00:13,473: 10:00:13 | 32 of 91 OK created table model agency_data_pipeline.adwords_join.... [CREATE TABLE in 6.28s]
2018-04-18 10:00:13,692: 10:00:13 | 30 of 91 OK created table model agency_data_pipeline.agg_orders_union [CREATE TABLE in 8.72s]
2018-04-18 10:00:16,029: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1018905f8>]}
2018-04-18 10:00:16,272: 10:00:16 | 31 of 91 OK created table model agency_data_pipeline.ga_transactions. [CREATE TABLE in 11.50s]
2018-04-18 10:00:18,894: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1018fedd8>]}
2018-04-18 10:00:19,154: 10:00:19 | 29 of 91 OK created table model agency_data_pipeline.ga_traffic...... [CREATE TABLE in 14.40s]
2018-04-18 10:00:19,155: 10:00:19 | 33 of 91 START table model agency_data_pipeline.adwords_stats........ [RUN]
2018-04-18 10:00:19,156: Compiling model.agency_data_pipeline.adwords_stats
2018-04-18 10:00:19,155: 10:00:19 | 34 of 91 START table model agency_data_pipeline.adwords_impression_share [RUN]
2018-04-18 10:00:19,161: Compiling model.agency_data_pipeline.adwords_impression_share
2018-04-18 10:00:19,155: 10:00:19 | 35 of 91 START table model agency_data_pipeline.agg_transaction_order_number [RUN]
2018-04-18 10:00:19,168: Writing injected SQL for node "model.agency_data_pipeline.adwords_impression_share"
2018-04-18 10:00:19,169: Writing injected SQL for node "model.agency_data_pipeline.adwords_stats"
2018-04-18 10:00:19,156: 10:00:19 | 36 of 91 START table model agency_data_pipeline.agg_transaction_line_item [RUN]
2018-04-18 10:00:19,169: Compiling model.agency_data_pipeline.agg_transaction_order_number
2018-04-18 10:00:19,170: Compiling model.agency_data_pipeline.agg_transaction_line_item
2018-04-18 10:00:19,175: Writing injected SQL for node "model.agency_data_pipeline.agg_transaction_order_number"
2018-04-18 10:00:19,175: Acquiring new bigquery connection "adwords_impression_share".
2018-04-18 10:00:19,183: Writing injected SQL for node "model.agency_data_pipeline.agg_transaction_line_item"
2018-04-18 10:00:19,184: Acquiring new bigquery connection "adwords_stats".
2018-04-18 10:00:19,184: Re-using an available connection from the pool.
2018-04-18 10:00:19,185: Acquiring new bigquery connection "agg_transaction_order_number".
2018-04-18 10:00:19,188: Re-using an available connection from the pool.
2018-04-18 10:00:19,192: Re-using an available connection from the pool.
2018-04-18 10:00:19,200: Acquiring new bigquery connection "agg_transaction_line_item".
2018-04-18 10:00:19,201: Re-using an available connection from the pool.
2018-04-18 10:00:20,091: Model SQL (agg_transaction_order_number):
SELECT
client,
cast(created_at as date) date,
order_number,
customer_id,
sum(final_quantity) final_quantity,
sum(final_price) final_price,
max(total_order_shipping_price) shipping_price
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`agg_orders_union`
GROUP BY client, created_at, order_number, customer_id
2018-04-18 10:00:20,092: Model SQL (agg_transaction_line_item):
SELECT
client,
created_at,
order_number,
quantity,
refund_quantity,
final_quantity,
price, 
total_order_price_undiscounted,
total_discounts,
total_order_shipping_price,
total_order_price_incl_shipping,
refund_amount,
final_price,
checkout_id,
product_id, 
landing_site,
sku, 
variant_title, 
variant_id,
line_item_id,	
customer_id,
orders_count,
customer_created_at,
last_order_id,
financial_status
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`agg_orders_union`
2018-04-18 10:00:20,158: Model SQL (adwords_impression_share):
SELECT 
cast(day as date) date, 
account, 
channel,
platform,
sum(impression_share_num) impressions,
sum(impression_share_den) available_impressions
FROM 
  `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_join`
group by date, account, platform, channel
2018-04-18 10:00:20,161: Model SQL (adwords_stats):
SELECT 
cast(day as date) date, 
account, 
platform,
channel,
url,
utm_campaign,
campaign,
sum(cost) cost,
sum(impressions) impressions,
sum(clicks) clicks,
sum(transactions) transactions
FROM 
  `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_join`
group by date, account, platform, channel, url, campaign, utm_campaign
2018-04-18 10:00:22,393: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e06358>]}
2018-04-18 10:00:22,649: 10:00:22 | 34 of 91 OK created table model agency_data_pipeline.adwords_impression_share [CREATE TABLE in 3.23s]
2018-04-18 10:00:22,649: 10:00:22 | 37 of 91 START table model agency_data_pipeline.fb_ads_stats......... [RUN]
2018-04-18 10:00:22,650: Compiling model.agency_data_pipeline.fb_ads_stats
2018-04-18 10:00:22,660: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_stats"
2018-04-18 10:00:22,662: Acquiring new bigquery connection "fb_ads_stats".
2018-04-18 10:00:22,662: Re-using an available connection from the pool.
2018-04-18 10:00:23,380: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104dda588>]}
2018-04-18 10:00:23,407: Model SQL (fb_ads_stats):
with cost as (

    select 
        date, account, ad_id, campaign,
        cost, impressions, clicks, null as conversions
    from `growth-engines-pipeline`.`agency_data_pipeline`.`fb_ads_insights`
),

conversions as (

    select 
        date, account, ad_id, campaign,
        null as cost, null as impressions, null as clicks, conversions
    from `growth-engines-pipeline`.`agency_data_pipeline`.`fb_ads_insights_conversions`
),

urls as (

    select ad_id, url
    from `growth-engines-pipeline`.`agency_data_pipeline`.`fb_ads`
)


SELECT
    cast(date as date) date,
    'FB Ads' platform,
    'Paid' channel,
    account, 
    b.url url,
    campaign,
    lower(campaign) utm_campaign, 
    sum(cost) cost,
    sum(impressions) impressions,
    sum(clicks) clicks,
    sum(conversions) transactions
FROM
(
    SELECT *
    FROM 
      cost
    UNION ALL
    SELECT *
    FROM 
      conversions
) a
LEFT JOIN urls b
ON ( a.ad_id = b.ad_id )
group by date, platform, channel, account, url, campaign, utm_campaign
2018-04-18 10:00:23,654: 10:00:23 | 35 of 91 OK created table model agency_data_pipeline.agg_transaction_order_number [CREATE TABLE in 4.21s]
2018-04-18 10:00:25,622: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e06358>]}
2018-04-18 10:00:26,259: 10:00:26 | 37 of 91 OK created table model agency_data_pipeline.fb_ads_stats.... [CREATE TABLE in 2.97s]
2018-04-18 10:00:26,829: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e39828>]}
2018-04-18 10:00:27,097: 10:00:27 | 33 of 91 OK created table model agency_data_pipeline.adwords_stats... [CREATE TABLE in 7.67s]
2018-04-18 10:00:27,969: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x101898b70>]}
2018-04-18 10:00:28,262: 10:00:28 | 36 of 91 OK created table model agency_data_pipeline.agg_transaction_line_item [CREATE TABLE in 8.80s]
2018-04-18 10:00:28,263: 10:00:28 | 38 of 91 START table model agency_data_pipeline.customers_by_transaction [RUN]
2018-04-18 10:00:28,264: Compiling model.agency_data_pipeline.customers_by_transaction
2018-04-18 10:00:28,270: Writing injected SQL for node "model.agency_data_pipeline.customers_by_transaction"
2018-04-18 10:00:28,274: Acquiring new bigquery connection "customers_by_transaction".
2018-04-18 10:00:28,274: Re-using an available connection from the pool.
2018-04-18 10:00:29,227: Model SQL (customers_by_transaction):
SELECT
client,
customer_id,
order_number,
order_date,
first_order_date,
case when first_order_number = order_number then 'New' else 'Existing' end as order_type,
final_price,
first_order_revenue,
lifetime_revenue
FROM

(

	SELECT
	client,
	customer_id,
	order_number,
	date order_date,
	first_value(date) over w1 first_order_date,
	first_value(order_number) over w1 first_order_number,
	first_value(final_price) over w1 first_order_revenue,
    final_price,
	sum(final_price) over w2 lifetime_revenue
	FROM
    `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_order_number`
	WINDOW w1 as (PARTITION BY client, customer_id ORDER BY date desc),
	w2 as (PARTITION BY client, customer_id)
)
2018-04-18 10:00:32,512: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1018985f8>]}
2018-04-18 10:00:32,807: 10:00:32 | 38 of 91 OK created table model agency_data_pipeline.customers_by_transaction [CREATE TABLE in 4.25s]
2018-04-18 10:00:32,808: 10:00:32 | 39 of 91 START table model agency_data_pipeline.agg_ga_transaction_order_number [RUN]
2018-04-18 10:00:32,809: Compiling model.agency_data_pipeline.agg_ga_transaction_order_number
2018-04-18 10:00:32,808: 10:00:32 | 40 of 91 START table model agency_data_pipeline.frequency_proc....... [RUN]
2018-04-18 10:00:32,820: Compiling model.agency_data_pipeline.frequency_proc
2018-04-18 10:00:32,829: Writing injected SQL for node "model.agency_data_pipeline.agg_ga_transaction_order_number"
2018-04-18 10:00:32,832: Writing injected SQL for node "model.agency_data_pipeline.frequency_proc"
2018-04-18 10:00:32,836: Acquiring new bigquery connection "agg_ga_transaction_order_number".
2018-04-18 10:00:32,837: Acquiring new bigquery connection "frequency_proc".
2018-04-18 10:00:32,837: Re-using an available connection from the pool.
2018-04-18 10:00:32,838: Re-using an available connection from the pool.
2018-04-18 10:00:33,944: Model SQL (agg_ga_transaction_order_number):
with ga as (

    select 
        date, account, client, 
        channel as last_touch_channel, 
        platform as last_touch_platform, 
        url as last_touch_url, 
        campaign as last_touch_utm_campaign, 
        '' as first_touch_channel, 
        '' as first_touch_platform, 
        '' as first_touch_utm_campaign, 
        transactionid,
        last_touch_transactions, last_touch_revenue,
        last_touch_shipping, last_touch_tax,
        null as first_touch_transactions, null as first_touch_revenue
    from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_transactions`

),

ga_mcf as (

    select 
        date, account, client, 
        '' as last_touch_channel,
        '' as last_touch_platform,
        '' as last_touch_url,
        '' as last_touch_utm_campaign, 
        channel as first_touch_channel, 
        platform as first_touch_platform, 
        campaign as first_touch_utm_campaign, 
        transactionid, 
        null as last_touch_transactions, null as last_touch_revenue,
        null as last_touch_shipping, null as last_touch_tax,
        first_touch_transactions, first_touch_revenue
    from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_mcf_stats`

)


SELECT
    date, 
    client,
    transactionid,
    max(last_touch_channel) last_touch_channel, 
    max(last_touch_platform) last_touch_platform, 
    max(last_touch_url) last_touch_url, 
    max(last_touch_utm_campaign) last_touch_utm_campaign, 
    max(first_touch_channel) first_touch_channel, 
    max(first_touch_platform) first_touch_platform, 
    max(first_touch_utm_campaign) first_touch_utm_campaign,
    sum(last_touch_transactions) last_touch_transactions,
    sum(last_touch_revenue) last_touch_revenue,
    sum(last_touch_shipping) last_touch_shipping_revenue,
    sum(last_touch_tax) last_touch_tax_revenue,
    sum(first_touch_transactions) first_touch_transactions,
    sum(first_touch_revenue) - ifnull(sum(last_touch_shipping),0) - ifnull(sum(last_touch_tax),0) first_touch_revenue
FROM
(
    SELECT *
    FROM 
      ga
    UNION ALL
    SELECT *
    FROM 
      ga_mcf
) 
GROUP BY
    date, client, transactionid
2018-04-18 10:00:33,952: Model SQL (frequency_proc):
WITH transactions AS (

  	SELECT 
	client,
	customer_id,
	order_number,
	date,
	unix_date(date) d
	FROM
	`growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_order_number`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)

SELECT 
client,
'Rolling 365' as period,
date_in_range date,
unix_date_in_range, 
customer_id,
count(distinct(order_number)) frequency
FROM daterange
JOIN transactions
ON transactions.d > ( daterange.unix_date_in_range - 365 )
AND transactions.d <= daterange.unix_date_in_range
group by client, unix_date_in_range, customer_id, date
2018-04-18 10:00:38,609: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104d1de10>]}
2018-04-18 10:00:38,929: 10:00:38 | 39 of 91 OK created table model agency_data_pipeline.agg_ga_transaction_order_number [CREATE TABLE in 5.80s]
2018-04-18 10:00:48,948: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e41080>]}
2018-04-18 10:00:49,187: 10:00:49 | 40 of 91 OK created table model agency_data_pipeline.frequency_proc.. [CREATE TABLE in 16.13s]
2018-04-18 10:00:49,188: 10:00:49 | 41 of 91 START table model agency_data_pipeline.frequency_stats...... [RUN]
2018-04-18 10:00:49,188: 10:00:49 | 42 of 91 START table model agency_data_pipeline.agg_transaction_line_item_type [RUN]
2018-04-18 10:00:49,189: Compiling model.agency_data_pipeline.frequency_stats
2018-04-18 10:00:49,189: 10:00:49 | 43 of 91 START table model agency_data_pipeline.agg_ga_campaign...... [RUN]
2018-04-18 10:00:49,189: Compiling model.agency_data_pipeline.agg_transaction_line_item_type
2018-04-18 10:00:49,197: Writing injected SQL for node "model.agency_data_pipeline.frequency_stats"
2018-04-18 10:00:49,197: Compiling model.agency_data_pipeline.agg_ga_campaign
2018-04-18 10:00:49,203: Writing injected SQL for node "model.agency_data_pipeline.agg_transaction_line_item_type"
2018-04-18 10:00:49,208: Writing injected SQL for node "model.agency_data_pipeline.agg_ga_campaign"
2018-04-18 10:00:49,209: Acquiring new bigquery connection "frequency_stats".
2018-04-18 10:00:49,210: Acquiring new bigquery connection "agg_transaction_line_item_type".
2018-04-18 10:00:49,210: Re-using an available connection from the pool.
2018-04-18 10:00:49,211: Acquiring new bigquery connection "agg_ga_campaign".
2018-04-18 10:00:49,211: Re-using an available connection from the pool.
2018-04-18 10:00:49,212: Re-using an available connection from the pool.
2018-04-18 10:00:50,008: Model SQL (frequency_stats):
SELECT
client,
period,
date,
unix_date_in_range,
case when frequency = 1 then '1' 
	when frequency = 2 then '2'
	when frequency > 2 then '3+'
	else null end as frequency_segment,
sum(customers) customers,
sum(customers) over (partition by client, period, date) total_customers,
sum(customers)/( sum(customers) over (partition by client, period, date) ) pct_of_customers
FROM (

	SELECT 
	client,
	period,
	date,
	unix_date_in_range, 
	frequency,
	count(distinct(customer_id)) customers,
	count(distinct(customer_id)) over (partition by client, period, date) total_customers
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`frequency_proc`
	group by client, period, date, unix_date_in_range, frequency
)
group by client, period, date, unix_date_in_range, frequency_segment
2018-04-18 10:00:50,013: Bad request while running:
SELECT
client,
period,
date,
unix_date_in_range,
case when frequency = 1 then '1' 
	when frequency = 2 then '2'
	when frequency > 2 then '3+'
	else null end as frequency_segment,
sum(customers) customers,
sum(customers) over (partition by client, period, date) total_customers,
sum(customers)/( sum(customers) over (partition by client, period, date) ) pct_of_customers
FROM (

	SELECT 
	client,
	period,
	date,
	unix_date_in_range, 
	frequency,
	count(distinct(customer_id)) customers,
	count(distinct(customer_id)) over (partition by client, period, date) total_customers
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`frequency_proc`
	group by client, period, date, unix_date_in_range, frequency
)
group by client, period, date, unix_date_in_range, frequency_segment
2018-04-18 10:00:50,013: 400 SELECT list expression references column customer_id which is neither grouped nor aggregated at [22:24]
2018-04-18 10:00:50,014: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e1bf60>]}
2018-04-18 10:00:50,143: Model SQL (agg_transaction_line_item_type):
SELECT
client,
product_id,
product_type,
customer_id,
sku,
order_number,
created_at,
final_quantity,
final_price
FROM

( 
	SELECT 
	a.client, 
	a.product_id,
	product_type,
	customer_id,
	a.sku, 
	order_number,
	created_at,
	final_quantity,
	final_price
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_line_item` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`agg_products` b
	ON (
		a.product_id = b.product_id
	  and a.client = b.client
		)

)
2018-04-18 10:00:50,166: Model SQL (agg_ga_campaign):
with ga_transactions as (

	select 
		date, account, client, channel, platform, url, 
		campaign,
		null as sessions, null as goal_completions, last_touch_transactions, last_touch_revenue,
		last_touch_shipping, last_touch_tax,
		null as first_touch_transactions, null as first_touch_revenue
	from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_transactions`

),

ga_traffic as (

    select 
        date, account, client, channel, platform, url, 
        campaign,
        sessions, goal_completions, null as last_touch_transactions, null as last_touch_revenue,
        null as last_touch_shipping, null as last_touch_tax,
        null as first_touch_transactions, null as first_touch_revenue
    from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_traffic`

),

ga_mcf as (

	select 
		date, account, client, channel, platform, '' as url,
		campaign, 
		null as sessions, null as goal_completions, null as last_touch_transactions, null as last_touch_revenue,
		null as last_touch_shipping, null as last_touch_tax,
		first_touch_transactions, first_touch_revenue
	from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_mcf_stats`

)


SELECT
    date, 
    client,
    platform,
    channel, 
    url,
    campaign utm_campaign,
	sum(sessions) sessions,
	sum(goal_completions) goal_completions,
	sum(last_touch_transactions) last_touch_transactions,
	sum(last_touch_revenue) last_touch_revenue,
    sum(last_touch_shipping) last_touch_shipping_revenue,
    sum(last_touch_tax) last_touch_tax_revenue,
    sum(first_touch_transactions) first_touch_transactions,
    sum(first_touch_revenue) - sum(ifnull(last_touch_shipping,0)) - sum(ifnull(last_touch_tax,0)) first_touch_revenue

FROM
(
    SELECT *
    FROM 
      ga_transactions
    UNION ALL
    SELECT *
    FROM 
      ga_traffic
    UNION ALL
    SELECT *
    FROM 
      ga_mcf
) 
GROUP BY
    date, client, platform, channel, url, utm_campaign
2018-04-18 10:00:50,267: 10:00:50 | 41 of 91 ERROR creating table model agency_data_pipeline.frequency_stats [ERROR in 0.83s]
2018-04-18 10:00:54,517: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x101868a58>]}
2018-04-18 10:00:54,761: 10:00:54 | 42 of 91 OK created table model agency_data_pipeline.agg_transaction_line_item_type [CREATE TABLE in 5.33s]
2018-04-18 10:00:58,928: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x101898898>]}
2018-04-18 10:00:59,649: 10:00:59 | 43 of 91 OK created table model agency_data_pipeline.agg_ga_campaign. [CREATE TABLE in 9.73s]
2018-04-18 10:00:59,650: 10:00:59 | 44 of 91 START table model agency_data_pipeline.agg_transaction_product_type [RUN]
2018-04-18 10:00:59,650: 10:00:59 | 45 of 91 START table model agency_data_pipeline.customers_first_purchase_product_type_proc [RUN]
2018-04-18 10:00:59,650: Compiling model.agency_data_pipeline.agg_transaction_product_type
2018-04-18 10:00:59,651: Compiling model.agency_data_pipeline.customers_first_purchase_product_type_proc
2018-04-18 10:00:59,659: Writing injected SQL for node "model.agency_data_pipeline.agg_transaction_product_type"
2018-04-18 10:00:59,663: Writing injected SQL for node "model.agency_data_pipeline.customers_first_purchase_product_type_proc"
2018-04-18 10:00:59,668: Acquiring new bigquery connection "agg_transaction_product_type".
2018-04-18 10:00:59,669: Re-using an available connection from the pool.
2018-04-18 10:00:59,671: Acquiring new bigquery connection "customers_first_purchase_product_type_proc".
2018-04-18 10:00:59,672: Re-using an available connection from the pool.
2018-04-18 10:01:00,561: Model SQL (agg_transaction_product_type):
SELECT
client,
product_type,
customer_id,
order_number,
created_at,
first_value(product_type) over (PARTITION BY client, customer_id, order_number, created_at ORDER BY final_price desc) as top_order_product_type,
final_quantity,
final_price,
sum(final_quantity) over (PARTITION BY client, customer_id, order_number) as total_order_quantity,
sum(final_price) over (PARTITION BY client, customer_id, order_number) as total_order_value
FROM
	(
		SELECT
		client,
		product_type,
		customer_id,
		order_number,
		created_at,
		sum(final_quantity) final_quantity,
		sum(final_price) final_price
		FROM
		`growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_line_item_type`
		GROUP BY
		client,
		product_type,
		customer_id,
		order_number,
		created_at
	)
2018-04-18 10:01:00,561: Model SQL (customers_first_purchase_product_type_proc):
SELECT 
client, 
customer_id, 
product_type,
min(cast(created_at as date)) first_order_date,
unix_date( min(cast(created_at as date))) first_order_unix_date
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_line_item_type`
GROUP BY client, customer_id, product_type
2018-04-18 10:01:03,876: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10185ef28>]}
2018-04-18 10:01:04,127: 10:01:04 | 45 of 91 OK created table model agency_data_pipeline.customers_first_purchase_product_type_proc [CREATE TABLE in 4.23s]
2018-04-18 10:01:04,913: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1018689b0>]}
2018-04-18 10:01:05,144: 10:01:05 | 44 of 91 OK created table model agency_data_pipeline.agg_transaction_product_type [CREATE TABLE in 5.26s]
2018-04-18 10:01:05,145: 10:01:05 | 46 of 91 START table model agency_data_pipeline.order_paths_proc..... [RUN]
2018-04-18 10:01:05,145: 10:01:05 | 47 of 91 START table model agency_data_pipeline.customers_products_proc [RUN]
2018-04-18 10:01:05,145: Compiling model.agency_data_pipeline.order_paths_proc
2018-04-18 10:01:05,146: 10:01:05 | 48 of 91 START table model agency_data_pipeline.products_proc........ [RUN]
2018-04-18 10:01:05,146: Compiling model.agency_data_pipeline.customers_products_proc
2018-04-18 10:01:05,156: Writing injected SQL for node "model.agency_data_pipeline.order_paths_proc"
2018-04-18 10:01:05,156: Compiling model.agency_data_pipeline.products_proc
2018-04-18 10:01:05,162: Writing injected SQL for node "model.agency_data_pipeline.customers_products_proc"
2018-04-18 10:01:05,168: Writing injected SQL for node "model.agency_data_pipeline.products_proc"
2018-04-18 10:01:05,169: Acquiring new bigquery connection "order_paths_proc".
2018-04-18 10:01:05,169: Re-using an available connection from the pool.
2018-04-18 10:01:05,172: Acquiring new bigquery connection "customers_products_proc".
2018-04-18 10:01:05,172: Re-using an available connection from the pool.
2018-04-18 10:01:05,175: Acquiring new bigquery connection "products_proc".
2018-04-18 10:01:05,176: Re-using an available connection from the pool.
2018-04-18 10:01:05,905: Model SQL (order_paths_proc):
SELECT
client, 
customer_id, 
first_value(product_type) OVER w1 as first_product_type,
nth_value(product_type, 2) OVER w1 as second_product_type,
cast(first_value(created_at) OVER w1 as date) as first_purchase_date,
cast(nth_value(created_at, 2) OVER w1 as date) as second_purchase_date,
cast(nth_value(created_at, 3) OVER w1 as date) as third_purchase_date,
cast(nth_value(created_at, 4) OVER w1 as date) as fourth_purchase_date,
cast(nth_value(created_at, 5) OVER w1 as date) as fifth_purchase_date,
first_value(order_number) OVER w1 as first_order_number,
nth_value(order_number, 2) OVER w1 as second_order_number,
nth_value(order_number, 3) OVER w1 as third_order_number,
nth_value(order_number, 4) OVER w1 as fourth_order_number,
nth_value(order_number, 5) OVER w1 as fifth_order_number,
first_value(total_order_value) OVER w1 as first_order_value,
nth_value(total_order_value, 2) OVER w1 as second_order_value
FROM (
	  
	  SELECT 
	  client, 
	  product_type,
	  customer_id,
	  order_number,
	  created_at, 
	  total_order_value
	  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_product_type`
	  WHERE product_type = top_order_product_type

)
WINDOW w1 as (PARTITION BY client, customer_id ORDER BY created_at asc)
2018-04-18 10:01:05,964: Model SQL (customers_products_proc):
WITH customers AS (
  SELECT 
  client, 
  product_id,
  product_type,
  customer_id,
  sku, 
  order_number,
  cast(created_at as date) order_date,
  unix_date(cast(created_at as date)) unix_order_date, 
  final_quantity quantity,
  final_price revenue
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_line_item_type`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)

SELECT 
client,
period,
customer_id,
product_type,
date,
window_end_unix_date,
window_end_unix_date - 365 as window_start_unix_date,
window_end_unix_date - unix_date(recent_order) recency_days,
frequency,
quantity,
revenue,
case when frequency > 0 then revenue/frequency else 0 end as aov
FROM 
(  

  SELECT 
  client,
  'Rolling 365' as period,
  customer_id,
  product_type,
  date_in_range date,
  unix_date_in_range,
  unix_date_in_range window_end_unix_date, 
  max(order_date) recent_order,
  sum(quantity) as quantity,
  sum(revenue) as revenue,
  count(distinct(order_number)) as frequency
  FROM daterange
  JOIN customers
  ON customers.unix_order_date > ( daterange.unix_date_in_range - 365 )
  AND customers.unix_order_date <= daterange.unix_date_in_range
  GROUP BY client, customer_id, date, unix_date_in_range, product_type

  UNION ALL

  SELECT 
  client,
  'Rolling 365 (t-1mo)' as period,
  customer_id,
  product_type,
  date_in_range date,
  unix_date_in_range, 
  unix_date_in_range - 30 window_end_unix_date, 
  max(order_date) recent_order,
  sum(quantity) as quantity,
  sum(revenue) as revenue,
  count(distinct(order_number)) as frequency
  FROM daterange
  JOIN customers
  ON customers.unix_order_date > ( daterange.unix_date_in_range - 395 )
  AND customers.unix_order_date <= ( daterange.unix_date_in_range - 30 )
  GROUP BY client, customer_id, date, unix_date_in_range, product_type

  UNION ALL

  SELECT 
  client,
  'Rolling 365 (t-1yr)' as period,
  customer_id,
  product_type,
  date_in_range date,
  unix_date_in_range, 
  unix_date_in_range - 365 window_end_unix_date, 
  max(order_date) recent_order,
  sum(quantity) as quantity,
  sum(revenue) as revenue,
  count(distinct(order_number)) as frequency
  FROM daterange
  JOIN customers
  ON customers.unix_order_date > ( daterange.unix_date_in_range - 730 )
  AND customers.unix_order_date <= ( daterange.unix_date_in_range - 365 )
  GROUP BY client, customer_id, date, unix_date_in_range, product_type

)
2018-04-18 10:01:05,975: Model SQL (products_proc):
WITH transactions AS (
  SELECT 
  client, 
  product_id,
  product_type,
  customer_id,
  sku, 
  order_number,
  unix_date(cast(created_at as date)) d, 
  final_quantity,
  final_price,
  first_value(unix_date(cast(created_at as date))) over (partition by client, product_id, sku order by created_at asc) first_purchase_unix_date
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_line_item_type`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)

SELECT 
client,
'Last 30' as period,
sku,
product_type,
date_in_range date,
unix_date_in_range, 
case when 
  ( first_purchase_unix_date > ( daterange.unix_date_in_range - 365 ) and first_purchase_unix_date <= daterange.unix_date_in_range )
  then 'New' else 'Existing' end as newness,  
count(distinct(customer_id)) unique_customers,
count(distinct(order_number)) orders,
sum(final_quantity) quantity,
sum(final_price) revenue,
count(distinct(d)) days_sold
FROM daterange
JOIN transactions
ON transactions.d > ( daterange.unix_date_in_range - 30 )
AND transactions.d <= daterange.unix_date_in_range
group by date_in_range, unix_date_in_range, client, sku, product_type, newness

UNION ALL

SELECT 
client,
'Last 90' as period,
sku, 
product_type,
date_in_range date,
unix_date_in_range, 
case when 
  ( first_purchase_unix_date > ( daterange.unix_date_in_range - 365 ) and first_purchase_unix_date <= daterange.unix_date_in_range )
  then 'New' else 'Existing' end as newness,  
count(distinct(customer_id)) unique_customers,
count(distinct(order_number)) orders,
sum(final_quantity) quantity,
sum(final_price) revenue,
count(distinct(d)) days_sold
FROM daterange
JOIN transactions
ON transactions.d > ( daterange.unix_date_in_range - 90 )
AND transactions.d <= daterange.unix_date_in_range
group by date_in_range, unix_date_in_range, client, sku, product_type, newness

UNION ALL

SELECT 
client,
'YoY 30' as date_range,
sku, 
product_type,
date_in_range date,
unix_date_in_range,
case when 
  ( first_purchase_unix_date > ( daterange.unix_date_in_range - 730 ) and first_purchase_unix_date <= ( daterange.unix_date_in_range - 365 ))
  then 'New' else 'Existing' end as newness,   
count(distinct(customer_id)) unique_customers,
count(distinct(order_number)) orders,
sum(final_quantity) quantity,
sum(final_price) revenue,
count(distinct(d)) days_sold
FROM daterange
JOIN transactions
ON transactions.d > ( daterange.unix_date_in_range - 395 )
AND transactions.d <= ( daterange.unix_date_in_range - 365 )
group by date_in_range, unix_date_in_range, client, sku, product_type, newness
2018-04-18 10:01:09,173: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x101870eb8>]}
2018-04-18 10:01:09,426: 10:01:09 | 46 of 91 OK created table model agency_data_pipeline.order_paths_proc [CREATE TABLE in 4.03s]
2018-04-18 10:01:14,821: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x101868a58>]}
2018-04-18 10:01:15,087: 10:01:15 | 48 of 91 OK created table model agency_data_pipeline.products_proc... [CREATE TABLE in 9.66s]
2018-04-18 10:01:44,427: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e06128>]}
2018-04-18 10:01:44,696: 10:01:44 | 47 of 91 OK created table model agency_data_pipeline.customers_products_proc [CREATE TABLE in 39.28s]
2018-04-18 10:01:44,697: 10:01:44 | 49 of 91 START table model agency_data_pipeline.segment_proc_sku..... [RUN]
2018-04-18 10:01:44,697: Compiling model.agency_data_pipeline.segment_proc_sku
2018-04-18 10:01:44,704: 10:01:44 | 50 of 91 START table model agency_data_pipeline.order_paths_agg...... [RUN]
2018-04-18 10:01:44,704: Compiling model.agency_data_pipeline.order_paths_agg
2018-04-18 10:01:44,709: Writing injected SQL for node "model.agency_data_pipeline.order_paths_agg"
2018-04-18 10:01:44,710: Writing injected SQL for node "model.agency_data_pipeline.segment_proc_sku"
2018-04-18 10:01:44,711: Acquiring new bigquery connection "order_paths_agg".
2018-04-18 10:01:44,711: Re-using an available connection from the pool.
2018-04-18 10:01:44,712: Acquiring new bigquery connection "segment_proc_sku".
2018-04-18 10:01:44,712: Re-using an available connection from the pool.
2018-04-18 10:01:46,132: Model SQL (segment_proc_sku):
SELECT
client,
period,
sku, 
product_type,
date,
unique_customers,
orders,
quantity,
revenue,
case 
	when avg_daily_revenue >= avg_daily_revenue_90pct and avg_daily_quantity >= avg_daily_quantity_80pct then 'Best Seller'
	when avg_daily_revenue >= avg_daily_revenue_70pct and avg_daily_quantity >= avg_daily_quantity_40pct then 'Good'
	when avg_daily_revenue < avg_daily_revenue_70pct and avg_daily_revenue >= avg_daily_revenue_30pct and avg_daily_quantity < avg_daily_quantity_70pct then 'Average'
	when avg_daily_revenue < avg_daily_revenue_30pct and avg_daily_quantity < avg_daily_quantity_30pct then 'Poor'
	else 'Unbucketed' end as segment,
newness,	
avg_daily_revenue_90pct,
avg_daily_revenue_70pct,
avg_daily_revenue_30pct,
avg_daily_quantity_80pct,
avg_daily_quantity_70pct,
avg_daily_quantity_40pct,
avg_daily_quantity_30pct

FROM (

	SELECT
	client,
	period,
	sku, 
	product_type,
	newness,
	date,
	unique_customers,
	orders,
	quantity,
	revenue,
	days_sold,
	avg_daily_revenue,
	avg_daily_quantity,
	PERCENTILE_CONT(avg_daily_revenue, 0.90) OVER w1 AS avg_daily_revenue_90pct,
	PERCENTILE_CONT(avg_daily_revenue, 0.70) OVER w1 AS avg_daily_revenue_70pct,
	PERCENTILE_CONT(avg_daily_revenue, 0.3) OVER w1 AS avg_daily_revenue_30pct,
	PERCENTILE_CONT(avg_daily_quantity, 0.80) OVER w1 AS avg_daily_quantity_80pct,
	PERCENTILE_CONT(avg_daily_quantity, 0.70) OVER w1 AS avg_daily_quantity_70pct,
	PERCENTILE_CONT(avg_daily_quantity, 0.40) OVER w1 AS avg_daily_quantity_40pct,
	PERCENTILE_CONT(avg_daily_quantity, 0.3) OVER w1 AS avg_daily_quantity_30pct

	FROM
	(
		SELECT 
		client,
		period,
		sku, 
		product_type,
		newness,
		date,
		unique_customers,
		orders,
		quantity,
		revenue,
		days_sold,
		case when days_sold > 0 then revenue/days_sold else null end as avg_daily_revenue,
		case when days_sold > 0 then quantity/days_sold else null end as avg_daily_quantity
		FROM `growth-engines-pipeline`.`agency_data_pipeline`.`products_proc`
	)
	WINDOW w1 as (PARTITION BY client, period, date)
)
2018-04-18 10:01:46,141: Model SQL (order_paths_agg):
SELECT
client, 
first_product_type,
second_product_type,
first_purchase_date,
count(distinct(customer_id)) customer_count, 
count(distinct(second_order_number)) second_orders, 
count(distinct(third_order_number)) third_orders, 
count(distinct(fourth_order_number)) fourth_orders, 
count(distinct(fifth_order_number)) fifth_orders, 
sum(date_diff(second_purchase_date, first_purchase_date, DAY)) second_order_latency_days,
sum(date_diff(third_purchase_date, second_purchase_date, DAY)) third_order_latency_days,
sum(date_diff(fourth_purchase_date, third_purchase_date, DAY)) fourth_order_latency_days,
sum(date_diff(fifth_purchase_date, fourth_purchase_date, DAY)) fifth_order_latency_days,
sum(first_order_value) first_order_revenue,
sum(second_order_value) second_order_revenue
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`order_paths_proc`
where second_product_type is not null
GROUP BY client, first_product_type, second_product_type, first_purchase_date
2018-04-18 10:01:48,332: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1018689b0>]}
2018-04-18 10:01:48,354: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1018f9588>]}
2018-04-18 10:01:48,605: 10:01:48 | 49 of 91 OK created table model agency_data_pipeline.segment_proc_sku [CREATE TABLE in 3.63s]
2018-04-18 10:01:48,867: 10:01:48 | 50 of 91 OK created table model agency_data_pipeline.order_paths_agg. [CREATE TABLE in 3.65s]
2018-04-18 10:01:48,868: 10:01:48 | 51 of 91 START table model agency_data_pipeline.agg_ga_transaction... [RUN]
2018-04-18 10:01:48,869: 10:01:48 | 52 of 91 START table model agency_data_pipeline.segment_proc_customers_products [RUN]
2018-04-18 10:01:48,869: 10:01:48 | 53 of 91 START table model agency_data_pipeline.segment_stats_sku.... [RUN]
2018-04-18 10:01:48,869: 10:01:48 | 54 of 91 START table model agency_data_pipeline.agg_transaction...... [RUN]
2018-04-18 10:01:48,869: Compiling model.agency_data_pipeline.agg_ga_transaction
2018-04-18 10:01:48,870: Compiling model.agency_data_pipeline.segment_proc_customers_products
2018-04-18 10:01:48,870: Compiling model.agency_data_pipeline.segment_stats_sku
2018-04-18 10:01:48,870: Compiling model.agency_data_pipeline.agg_transaction
2018-04-18 10:01:48,883: Writing injected SQL for node "model.agency_data_pipeline.segment_proc_customers_products"
2018-04-18 10:01:48,891: Writing injected SQL for node "model.agency_data_pipeline.agg_ga_transaction"
2018-04-18 10:01:48,892: Writing injected SQL for node "model.agency_data_pipeline.segment_stats_sku"
2018-04-18 10:01:48,897: Writing injected SQL for node "model.agency_data_pipeline.agg_transaction"
2018-04-18 10:01:48,899: Acquiring new bigquery connection "agg_ga_transaction".
2018-04-18 10:01:48,899: Re-using an available connection from the pool.
2018-04-18 10:01:48,900: Acquiring new bigquery connection "segment_proc_customers_products".
2018-04-18 10:01:48,900: Re-using an available connection from the pool.
2018-04-18 10:01:48,902: Acquiring new bigquery connection "segment_stats_sku".
2018-04-18 10:01:48,903: Acquiring new bigquery connection "agg_transaction".
2018-04-18 10:01:48,903: Re-using an available connection from the pool.
2018-04-18 10:01:48,907: Re-using an available connection from the pool.
2018-04-18 10:01:49,717: Model SQL (segment_proc_customers_products):
SELECT
client,
period,
date,
customer_id,
first_order_date,
first_order_unix_date,
product_type,
recency_days,
frequency,
revenue,
quantity,
aov,
case when recency_days <= 30 and first_order_unix_date >= window_start_unix_date then 'New'
	when frequency = 1 and recency_days <= 90 and aov >= aov_40pct then 'Promising'
	when frequency = 1 then 'One-time Purchaser'
	when frequency >= frequency_90pct and recency_days <= 90 and aov > aov_40pct then 'Whale'
	when recency_days <= 240 and frequency > frequency_50pct then 'Loyal'
	when recency_days <= 90 and frequency > frequency_50pct then 'Potential Loyalists' 
	when recency_days > 240 and frequency > frequency_50pct then 'Defecting Good Customer'	
	when recency_days > recency_50pct and frequency > frequency_50pct then 'Frequent, not Recent'
	when recency_days < recency_50pct and frequency < frequency_50pct then 'Recent, not Frequent'
	else 'Unbucketed' end as segment,
aov_40pct,
frequency_90pct,
frequency_75pct,
frequency_50pct,
recency_50pct
FROM
(
	SELECT 
	a.client client,
	period,
	date,
	a.customer_id customer_id,
	a.product_type product_type,
	b.first_order_date first_order_date,
	b.first_order_unix_date first_order_unix_date,
	window_start_unix_date,
	window_end_unix_date,	
	recency_days,
	frequency,
	revenue,
	quantity,
	aov,
	PERCENTILE_CONT(aov, 0.40) OVER w1 AS aov_40pct,
	PERCENTILE_CONT(frequency, 0.90) OVER w1 AS frequency_90pct,
	PERCENTILE_CONT(frequency, 0.75) OVER w1 AS frequency_75pct,
	PERCENTILE_CONT(frequency, 0.50) OVER w1 AS frequency_50pct,
	PERCENTILE_CONT(recency_days, 0.5) OVER w1 AS recency_50pct
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`customers_products_proc` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`customers_first_purchase_product_type_proc` b
	ON (
		a.client = b.client and
		a.customer_id = b.customer_id and
		a.product_type = b.product_type
		)
	WINDOW w1 as (PARTITION BY a.client, period, date, a.product_type)
)
2018-04-18 10:01:49,725: Model SQL (agg_ga_transaction):
#done - lookup customer id from transaction id from orders
#done - tag an order as 'new' or 'existing' based on transaction id
#sum lifetime value of that customer id
#first order value for customer
#read from agg_ga_transaction into agg_ga_campaign instead of directly from ga_transactions and ga_mcf_stats


with ga as (

    select 
        date, 
        client, 
        'Last-touch' as attribution,
        channel, 
        platform, 
        url, 
        campaign, 
        transactionid,
        last_touch_transactions transactions, 
        last_touch_revenue + ifnull(last_touch_shipping, 0) + ifnull(last_touch_tax, 0) as revenue
    from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_transactions`

),

ga_mcf as (

    select 
        date, 
        client, 
        'First-touch' as attribution,
        channel, 
        platform, 
        '' as url,
        campaign, 
        transactionid, 
        first_touch_transactions as transactions,
        first_touch_revenue as revenue
    from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_mcf_stats`

)


SELECT
    date, 
    a.client client,
    attribution,
    transactionid,
    b.customer_id customer_id,
    b.order_type order_type,
    b.first_order_revenue first_order_revenue,
    b.lifetime_revenue lifetime_revenue,
    channel,
    platform,
    url,
    campaign,
    transactions,
    revenue
FROM (
    SELECT * FROM ga
    UNION ALL
    SELECT * FROM ga_mcf
) a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`customers_by_transaction` b
ON (
    a.client = b.client AND
    a.transactionid = b.order_number
)
2018-04-18 10:01:49,736: Model SQL (agg_transaction):
SELECT
client,
date,
customer_id,
order_number,
last_touch_channel,
last_touch_platform,
last_touch_url,
first_touch_channel, 
first_touch_platform, 
first_touch_utm_campaign,
ifnull( sum(last_touch_transactions), 0) last_touch_transactions, 
ifnull( sum(last_touch_revenue), 0) last_touch_revenue, 
ifnull( sum(first_touch_transactions), 0) first_touch_transactions, 
ifnull( sum(first_touch_revenue), 0) first_touch_revenue,
ifnull( sum(final_quantity), 0) quantity,
ifnull( sum(final_price), 0) revenue,
ifnull( sum(shipping_price), 0) shipping_revenue,
ROW_NUMBER() OVER (PARTITION BY client, customer_id, order_number ORDER BY date asc) AS order_sequence
FROM
(
	SELECT
	a.client,
	a.date date,
	b.date ga_date,
	a.customer_id,
	a.order_number,
	transactionid,
	b.last_touch_channel,
	b.last_touch_platform,
	b.last_touch_url,
	b.first_touch_channel, 
	b.first_touch_platform, 
	b.first_touch_utm_campaign, 
	last_touch_transactions, 
	last_touch_revenue, 
	first_touch_transactions, 
	first_touch_revenue,
	final_quantity,
	final_price,
	shipping_price
	FROM
	`growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_order_number` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`agg_ga_transaction_order_number` b
	ON (
		a.client = b.client and
		a.order_number = b.transactionid
	)

)
GROUP BY
client, 
date, 
customer_id,
order_number, 
last_touch_channel,
last_touch_platform,
last_touch_url,
first_touch_channel, 
first_touch_platform, 
first_touch_utm_campaign
2018-04-18 10:01:49,761: Model SQL (segment_stats_sku):
WITH last_30 as (

	SELECT
	client,
	sku, 
	product_type,
	date,
	unique_customers as customers_30,
	orders as orders_30,
	revenue as revenue_30,
	segment as segment_30,
	newness as newness_30,
	0 as customers_90,
	0 as orders_90,
	0 as revenue_90,
	'' as segment_90,
	0 as customers_yoy_30,
	0 as orders_yoy_30,
	0 as revenue_yoy_30,
	'' as segment_yoy_30
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_sku`
	WHERE period = 'Last 30'

),

last_90 as (

	SELECT
	client,
	sku, 
	product_type,
	date,
	0 as customers_30,
	0 as orders_30,
	0 as revenue_30,
	'' as segment_30,
	'' as newness_30,
	unique_customers as customers_90,
	orders as orders_90,
	revenue as revenue_90,
	segment as segment_90,
	0 as customers_yoy_30,
	0 as orders_yoy_30,
	0 as revenue_yoy_30,
	'' as segment_yoy_30
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_sku`
	WHERE period = 'Last 90'

),

yoy_30 as (

	SELECT
	client,
	sku, 
	product_type,
	date,
	0 as customers_30,
	0 as orders_30,
	0 as revenue_30,
	'' as segment_30,
	'' as newness_30,
	0 as customers_90,
	0 as orders_90,
	0 as revenue_90,
	'' as segment_90,
	unique_customers as customers_yoy_30,
	orders as orders_yoy_30,
	revenue as revenue_yoy_30,
	segment as segment_yoy_30
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_sku`
	WHERE period = 'YoY 30'

)

SELECT
client,
sku, 
product_type,
date,
ifnull(sum(customers_30), 0) customers_30,
ifnull(sum(orders_30), 0) orders_30,
ifnull(sum(revenue_30), 0) revenue_30,
ifnull(max(segment_30), '') segment_30,
ifnull(sum(customers_90), 0) customers_90,
ifnull(sum(orders_90), 0) orders_90,
ifnull(sum(revenue_90), 0) revenue_90,
ifnull(max(segment_90),'') segment_90,
ifnull(sum(customers_yoy_30), 0) customers_yoy_30,
ifnull(sum(orders_yoy_30), 0) orders_yoy_30,
ifnull(sum(revenue_yoy_30), 0) revenue_yoy_30,
case when max(newness_30) = 'New' then 'New'
	else ifnull(max(segment_yoy_30), '') end as segment_yoy_30
FROM
(
	SELECT * FROM last_30
	UNION ALL
	SELECT * FROM last_90
	UNION ALL
	SELECT * FROM yoy_30

)
GROUP BY client, sku, product_type, date
2018-04-18 10:01:53,061: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x101870dd8>]}
2018-04-18 10:01:53,302: 10:01:53 | 53 of 91 OK created table model agency_data_pipeline.segment_stats_sku [CREATE TABLE in 4.19s]
2018-04-18 10:01:55,253: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e22128>]}
2018-04-18 10:01:55,488: 10:01:55 | 54 of 91 OK created table model agency_data_pipeline.agg_transaction. [CREATE TABLE in 6.38s]
2018-04-18 10:01:56,347: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x101870b70>]}
2018-04-18 10:01:56,613: 10:01:56 | 51 of 91 OK created table model agency_data_pipeline.agg_ga_transaction [CREATE TABLE in 7.48s]
2018-04-18 10:02:19,523: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x101890400>]}
2018-04-18 10:02:20,126: 10:02:20 | 52 of 91 OK created table model agency_data_pipeline.segment_proc_customers_products [CREATE TABLE in 30.65s]
2018-04-18 10:02:20,131: 10:02:20 | 55 of 91 START table model agency_data_pipeline.segment_stats_category [RUN]
2018-04-18 10:02:20,132: Compiling model.agency_data_pipeline.segment_stats_category
2018-04-18 10:02:20,132: 10:02:20 | 56 of 91 START table model agency_data_pipeline.customers_first_purchase_proc [RUN]
2018-04-18 10:02:20,142: Compiling model.agency_data_pipeline.customers_first_purchase_proc
2018-04-18 10:02:20,132: 10:02:20 | 57 of 91 START table model agency_data_pipeline.agg_ga_campaign_by_type [RUN]
2018-04-18 10:02:20,132: 10:02:20 | 58 of 91 START table model agency_data_pipeline.order_paths_stats.... [RUN]
2018-04-18 10:02:20,141: Writing injected SQL for node "model.agency_data_pipeline.segment_stats_category"
2018-04-18 10:02:20,152: Writing injected SQL for node "model.agency_data_pipeline.customers_first_purchase_proc"
2018-04-18 10:02:20,152: Compiling model.agency_data_pipeline.agg_ga_campaign_by_type
2018-04-18 10:02:20,152: Compiling model.agency_data_pipeline.order_paths_stats
2018-04-18 10:02:20,162: Writing injected SQL for node "model.agency_data_pipeline.agg_ga_campaign_by_type"
2018-04-18 10:02:20,171: Acquiring new bigquery connection "segment_stats_category".
2018-04-18 10:02:20,172: Acquiring new bigquery connection "customers_first_purchase_proc".
2018-04-18 10:02:20,181: Re-using an available connection from the pool.
2018-04-18 10:02:20,179: Writing injected SQL for node "model.agency_data_pipeline.order_paths_stats"
2018-04-18 10:02:20,182: Re-using an available connection from the pool.
2018-04-18 10:02:20,184: Acquiring new bigquery connection "order_paths_stats".
2018-04-18 10:02:20,190: Re-using an available connection from the pool.
2018-04-18 10:02:20,185: Acquiring new bigquery connection "agg_ga_campaign_by_type".
2018-04-18 10:02:20,194: Re-using an available connection from the pool.
2018-04-18 10:02:21,033: Model SQL (agg_ga_campaign_by_type):
with orders_new as (
    select 
    date, 
    client, 
    attribution,
    channel, 
    platform, 
    url, 
    campaign,
    count(distinct(customer_id)) customers_new,
    sum(transactions) transactions_new,
    sum(revenue) revenue_new,
    sum(first_order_revenue) first_order_revenue_new,
    sum(lifetime_revenue) lifetime_revenue_new,
    null as customers_total,
    null as transactions_total,
    null as revenue_total
    from `growth-engines-pipeline`.`agency_data_pipeline`.`agg_ga_transaction`
    where order_type = 'New'
    group by date, client, attribution, channel, platform, url, campaign
),
    
orders_total as (
    select 
    date, 
    client, 
    attribution,
    channel, 
    platform, 
    url, 
    campaign,
    null as customers_new,
    null as transactions_new,
    null as revenue_new,
    null as first_order_revenue_new,
    null as lifetime_revenue_new,
    count(distinct(customer_id)) customers_total,
    sum(transactions) transactions_total,
    sum(revenue) revenue_total
    from `growth-engines-pipeline`.`agency_data_pipeline`.`agg_ga_transaction`
    group by date, client, attribution, channel, platform, url, campaign

)

SELECT 
date, 
client, 
attribution,
channel, 
platform, 
url, 
campaign,
sum(customers_new) customers_new,
sum(transactions_new) transactions_new,
sum(revenue_new) revenue_new,
sum(first_order_revenue_new) first_order_revenue_new,
sum(lifetime_revenue_new) lifetime_revenue_new,
sum(customers_total) customers_total,
sum(transactions_total) transactions_total,
sum(revenue_total) revenue_total
from
    ( 
        SELECT * FROM orders_new
        UNION ALL 
        SELECT * FROM orders_total
    )
group by date, client, attribution, channel, platform, url, campaign
2018-04-18 10:02:21,172: Model SQL (segment_stats_category):
SELECT
client,
product_type,
date,
segment_30,
segment_90,
segment_yoy_30,
ifnull(sum(customers_30), 0) customers_30,
ifnull(sum(orders_30), 0) orders_30,
ifnull(sum(revenue_30), 0) revenue_30,
ifnull(sum(customers_90), 0) customers_90,
ifnull(sum(orders_90), 0) orders_90,
ifnull(sum(revenue_90), 0) revenue_90,
ifnull(sum(customers_yoy_30), 0) customers_yoy_30,
ifnull(sum(orders_yoy_30), 0) orders_yoy_30,
ifnull(sum(revenue_yoy_30), 0) revenue_yoy_30
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`segment_stats_sku`
GROUP BY client, product_type, date, segment_30, segment_90, segment_yoy_30
2018-04-18 10:02:21,304: Model SQL (customers_first_purchase_proc):
SELECT 
client, 
customer_id, 
min(cast(date as date)) first_order_date,
unix_date( min(cast(date as date))) first_order_unix_date
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction`
GROUP BY client, customer_id
2018-04-18 10:02:21,588: Model SQL (order_paths_stats):
WITH transactions AS (
  SELECT 
  client, 
  first_product_type,
  second_product_type,
  first_purchase_date,
  customer_count,
  second_orders,
  third_orders,
  fourth_orders,
  fifth_orders,
  second_order_latency_days,
  third_order_latency_days,
  fourth_order_latency_days,
  fifth_order_latency_days,
  first_order_revenue,
  second_order_revenue,
  unix_date(cast(first_purchase_date as date)) d
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`order_paths_agg`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)

SELECT 
client,
'Rolling 365' as period,
first_product_type,
second_product_type,
date_in_range date,
unix_date_in_range, 
sum(customer_count) customer_count,
sum(second_orders) second_orders,
sum(third_orders) third_orders,
sum(fourth_orders) fourth_orders,
sum(fifth_orders) fifth_orders,
sum(second_order_latency_days) second_order_latency_days,
sum(third_order_latency_days) third_order_latency_days,
sum(fourth_order_latency_days) fourth_order_latency_days,
sum(fifth_order_latency_days) fifth_order_latency_days,
sum(first_order_revenue) first_order_revenue,
sum(second_order_revenue) second_order_revenue
FROM daterange
JOIN transactions
ON transactions.d > ( daterange.unix_date_in_range - 365 )
AND transactions.d <= daterange.unix_date_in_range
group by client, first_product_type, second_product_type, date_in_range, unix_date_in_range
2018-04-18 10:02:23,361: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1018d4160>]}
2018-04-18 10:02:23,510: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e39a20>]}
2018-04-18 10:02:23,599: 10:02:23 | 55 of 91 OK created table model agency_data_pipeline.segment_stats_category [CREATE TABLE in 3.23s]
2018-04-18 10:02:23,603: 10:02:23 | 59 of 91 START table model agency_data_pipeline.agg_transaction_daily [RUN]
2018-04-18 10:02:23,605: Compiling model.agency_data_pipeline.agg_transaction_daily
2018-04-18 10:02:23,617: Writing injected SQL for node "model.agency_data_pipeline.agg_transaction_daily"
2018-04-18 10:02:23,618: Acquiring new bigquery connection "agg_transaction_daily".
2018-04-18 10:02:23,619: Re-using an available connection from the pool.
2018-04-18 10:02:23,767: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x101870b38>]}
2018-04-18 10:02:23,936: 10:02:23 | 56 of 91 OK created table model agency_data_pipeline.customers_first_purchase_proc [CREATE TABLE in 3.37s]
2018-04-18 10:02:23,936: 10:02:23 | 60 of 91 START table model agency_data_pipeline.segment_stats_customers_products_agg [RUN]
2018-04-18 10:02:23,937: Compiling model.agency_data_pipeline.segment_stats_customers_products_agg
2018-04-18 10:02:23,963: Writing injected SQL for node "model.agency_data_pipeline.segment_stats_customers_products_agg"
2018-04-18 10:02:23,964: Acquiring new bigquery connection "segment_stats_customers_products_agg".
2018-04-18 10:02:23,964: Re-using an available connection from the pool.
2018-04-18 10:02:24,247: 10:02:24 | 58 of 91 OK created table model agency_data_pipeline.order_paths_stats [CREATE TABLE in 3.61s]
2018-04-18 10:02:24,621: Model SQL (agg_transaction_daily):
SELECT
client,
date,
customer_id,
sum(last_touch_transactions) last_touch_transactions, 
sum(last_touch_revenue) last_touch_revenue, 
sum(first_touch_transactions) first_touch_transactions, 
sum(first_touch_revenue) first_touch_revenue,
sum(quantity) quantity,
sum(revenue) revenue,
count(distinct(order_number)) order_count
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction`
GROUP BY
client, 
date, 
customer_id
2018-04-18 10:02:24,845: Model SQL (segment_stats_customers_products_agg):
WITH ty as (

	SELECT
	client,
	date,
	customer_id,
	product_type,
	segment as segment_365,
	recency_days as recency_365,
	frequency as frequency_365,
	revenue as revenue_365,
	aov as aov_365,
	'' as segment_mom,
	0 as recency_mom,
	0 as frequency_mom,
	0 as revenue_mom,
	0 as aov_mom,
	'' as segment_yoy,
	0 as recency_yoy,
	0 as frequency_yoy,
	0 as revenue_yoy,
	0 as aov_yoy
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers_products`
	WHERE period = 'Rolling 365'

),

last_month as (

	SELECT
	client,
	date,
	customer_id,
	product_type,
	'' as segment_365,
	0 as recency_365,
	0 as frequency_365,
	0 as revenue_365,
	0 as aov_365,
	segment as segment_mom,
	recency_days as recency_mom,
	frequency as frequency_mom,
	revenue as revenue_mom,
	aov as aov_mom,
	'' as segment_yoy,
	0 as recency_yoy,
	0 as frequency_yoy,
	0 as revenue_yoy,
	0 as aov_yoy
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers_products`
	WHERE period = 'Rolling 365 (t-1mo)'

),

this_month_1yr as (

	SELECT
	client,
	date,
	customer_id,
	product_type,
	'' as segment_365,
	0 as recency_365,
	0 as frequency_365,
	0 as revenue_365,
	0 as aov_365,
	'' as segment_mom,
	0 as recency_mom,
	0 as frequency_mom,
	0 as revenue_mom,
	0 as aov_mom,
	segment as segment_yoy,
	recency_days as recency_yoy,
	frequency as frequency_yoy,
	revenue as revenue_yoy,
	aov as aov_yoy
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers_products`
	WHERE period = 'Rolling 365 (t-1yr)'


)

SELECT
client,
date, 
customer_id,
product_type,
ifnull(max(segment_365), '') segment_365,
ifnull(max(segment_mom), '') segment_mom,
ifnull(max(segment_yoy), '') segment_yoy,
ifnull(sum(recency_365), 0) recency_365,
ifnull(sum(frequency_365), 0) frequency_365,
ifnull(sum(revenue_365), 0) revenue_365,
ifnull(sum(aov_365), 0) aov_365,
ifnull(sum(recency_mom), 0) recency_mom,
ifnull(sum(frequency_mom), 0) frequency_mom,
ifnull(sum(revenue_mom), 0) revenue_mom,
ifnull(sum(aov_mom), 0) aov_mom,	
ifnull(sum(recency_yoy), 0) recency_yoy,
ifnull(sum(frequency_yoy), 0) frequency_yoy,
ifnull(sum(revenue_yoy), 0) revenue_yoy,
ifnull(sum(aov_yoy), 0) aov_yoy
FROM
(
	SELECT * FROM ty
	UNION ALL
	SELECT * FROM last_month
	UNION ALL
	SELECT * FROM this_month_1yr

)
GROUP BY client, date, customer_id, product_type
2018-04-18 10:02:27,605: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x101870978>]}
2018-04-18 10:02:27,871: 10:02:27 | 57 of 91 OK created table model agency_data_pipeline.agg_ga_campaign_by_type [CREATE TABLE in 7.45s]
2018-04-18 10:02:32,270: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1018d4c88>]}
2018-04-18 10:02:32,507: 10:02:32 | 59 of 91 OK created table model agency_data_pipeline.agg_transaction_daily [CREATE TABLE in 8.67s]
2018-04-18 10:02:55,786: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e39a20>]}
2018-04-18 10:02:56,509: 10:02:56 | 60 of 91 OK created table model agency_data_pipeline.segment_stats_customers_products_agg [CREATE TABLE in 31.85s]
2018-04-18 10:02:56,510: 10:02:56 | 61 of 91 START table model agency_data_pipeline.customers_proc....... [RUN]
2018-04-18 10:02:56,511: Compiling model.agency_data_pipeline.customers_proc
2018-04-18 10:02:56,511: 10:02:56 | 62 of 91 START table model agency_data_pipeline.growth_customer_0_365 [RUN]
2018-04-18 10:02:56,522: Writing injected SQL for node "model.agency_data_pipeline.customers_proc"
2018-04-18 10:02:56,511: 10:02:56 | 63 of 91 START table model agency_data_pipeline.segment_stats_customers_products [RUN]
2018-04-18 10:02:56,522: Compiling model.agency_data_pipeline.growth_customer_0_365
2018-04-18 10:02:56,522: Compiling model.agency_data_pipeline.segment_stats_customers_products
2018-04-18 10:02:56,531: Writing injected SQL for node "model.agency_data_pipeline.growth_customer_0_365"
2018-04-18 10:02:56,537: Acquiring new bigquery connection "customers_proc".
2018-04-18 10:02:56,542: Writing injected SQL for node "model.agency_data_pipeline.segment_stats_customers_products"
2018-04-18 10:02:56,542: Re-using an available connection from the pool.
2018-04-18 10:02:56,544: Acquiring new bigquery connection "growth_customer_0_365".
2018-04-18 10:02:56,545: Re-using an available connection from the pool.
2018-04-18 10:02:56,550: Acquiring new bigquery connection "segment_stats_customers_products".
2018-04-18 10:02:56,555: Re-using an available connection from the pool.
2018-04-18 10:02:57,446: Model SQL (segment_stats_customers_products):
SELECT
client,
date,
product_type,
segment_365,
segment_mom,
segment_yoy,
count(distinct(customer_id)) customers,
avg(recency_365) recency_365,
sum(frequency_365) frequency_365,
sum(revenue_365) revenue_365,
case when sum(frequency_365) > 0 then sum(revenue_365)/sum(frequency_365) else null end as aov_365,
avg(recency_mom) recency_mom,
sum(frequency_mom) frequency_mom,
sum(revenue_mom) revenue_mom,
case when sum(frequency_mom) > 0 then sum(revenue_mom)/sum(frequency_mom) else null end as aov_mom,
avg(recency_yoy) recency_yoy,
sum(frequency_yoy) frequency_yoy,
sum(revenue_yoy) revenue_yoy,
case when sum(frequency_yoy) > 0 then sum(revenue_yoy)/sum(frequency_yoy) else null end as aov_yoy
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_stats_customers_products_agg`
GROUP BY client, date, product_type, segment_365, segment_mom, segment_yoy
2018-04-18 10:02:57,449: Model SQL (growth_customer_0_365):
WITH transactions AS (
  SELECT 
  client, 
  customer_id, 
  order_number,
  unix_date(cast(date as date)) d, 
  quantity,
  revenue,
  shipping_revenue
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)

SELECT 
date_in_range date,
unix_date_in_range, 
unix_date_in_range_yoy, 
client, 
customer_id,
count(distinct(order_number)) orders,
sum(quantity) quantity,
sum(revenue) revenue,
sum(shipping_revenue) shipping_revenue
FROM daterange
JOIN transactions
ON transactions.d >= ( daterange.unix_date_in_range - 365 ) 
AND transactions.d <= daterange.unix_date_in_range
GROUP BY date, unix_date_in_range, unix_date_in_range_yoy, client, customer_id
2018-04-18 10:02:57,519: Model SQL (customers_proc):
WITH customers AS (
  SELECT 
  client, 
  customer_id, 
  order_number,
  cast(date as date) order_date,
  unix_date(cast(date as date)) unix_order_date, 
  quantity,
  revenue 
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)
 
SELECT 
client,
period,
customer_id,
date,
window_end_unix_date,
window_end_unix_date - 365 as window_start_unix_date,
window_end_unix_date - unix_date(recent_order) recency_days,
frequency,
quantity,
revenue,
case when frequency > 0 then revenue/frequency else 0 end as aov
FROM 
(  

  SELECT 
  client,
  'Rolling 365' as period,
  customer_id,
  date_in_range date,
  unix_date_in_range,
  unix_date_in_range window_end_unix_date,
  max(order_date) recent_order,
  sum(quantity) as quantity,
  sum(revenue) as revenue,
  count(distinct(order_number)) as frequency
  FROM daterange
  JOIN customers
  ON customers.unix_order_date > ( daterange.unix_date_in_range - 365 )
  AND customers.unix_order_date <= daterange.unix_date_in_range
  GROUP BY client, customer_id, date, unix_date_in_range

  UNION ALL

  SELECT 
  client,
  'Rolling 365 (t-1mo)' as period,
  customer_id,
  date_in_range date,
  unix_date_in_range,
  unix_date_in_range - 30 window_end_unix_date, 
  max(order_date) recent_order,
  sum(quantity) as quantity,
  sum(revenue) as revenue,
  count(distinct(order_number)) as frequency
  FROM daterange
  JOIN customers
  ON customers.unix_order_date > ( daterange.unix_date_in_range - 395 )
  AND customers.unix_order_date <= ( daterange.unix_date_in_range - 30 )
  GROUP BY client, customer_id, date, unix_date_in_range

  UNION ALL

  SELECT 
  client,
  'Rolling 365 (t-1yr)' as period,
  customer_id,
  date_in_range date,
  unix_date_in_range, 
  unix_date_in_range - 365 window_end_unix_date, 
  max(order_date) recent_order,
  sum(quantity) as quantity,
  sum(revenue) as revenue,
  count(distinct(order_number)) as frequency
  FROM daterange
  JOIN customers
  ON customers.unix_order_date > ( daterange.unix_date_in_range - 730 )
  AND customers.unix_order_date <= ( daterange.unix_date_in_range - 365 )
  GROUP BY client, customer_id, date, unix_date_in_range

)
2018-04-18 10:03:07,514: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1018e1940>]}
2018-04-18 10:03:07,810: 10:03:07 | 63 of 91 OK created table model agency_data_pipeline.segment_stats_customers_products [CREATE TABLE in 10.99s]
2018-04-18 10:03:17,294: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x101868588>]}
2018-04-18 10:03:17,934: 10:03:17 | 62 of 91 OK created table model agency_data_pipeline.growth_customer_0_365 [CREATE TABLE in 20.77s]
2018-04-18 10:03:26,254: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e1bf60>]}
2018-04-18 10:03:26,498: 10:03:26 | 61 of 91 OK created table model agency_data_pipeline.customers_proc.. [CREATE TABLE in 29.74s]
2018-04-18 10:03:26,499: 10:03:26 | 64 of 91 START table model agency_data_pipeline.retention_60_plus.... [RUN]
2018-04-18 10:03:26,499: 10:03:26 | 65 of 91 START table model agency_data_pipeline.retention_365_730.... [RUN]
2018-04-18 10:03:26,500: 10:03:26 | 66 of 91 START table model agency_data_pipeline.segment_list_customers_products [RUN]
2018-04-18 10:03:26,500: 10:03:26 | 67 of 91 START table model agency_data_pipeline.retention_0_365...... [RUN]
2018-04-18 10:03:26,500: Compiling model.agency_data_pipeline.retention_60_plus
2018-04-18 10:03:26,500: Compiling model.agency_data_pipeline.retention_365_730
2018-04-18 10:03:26,501: Compiling model.agency_data_pipeline.segment_list_customers_products
2018-04-18 10:03:26,501: Compiling model.agency_data_pipeline.retention_0_365
2018-04-18 10:03:26,520: Writing injected SQL for node "model.agency_data_pipeline.retention_60_plus"
2018-04-18 10:03:26,524: Writing injected SQL for node "model.agency_data_pipeline.retention_365_730"
2018-04-18 10:03:26,532: Writing injected SQL for node "model.agency_data_pipeline.segment_list_customers_products"
2018-04-18 10:03:26,539: Writing injected SQL for node "model.agency_data_pipeline.retention_0_365"
2018-04-18 10:03:26,542: Acquiring new bigquery connection "retention_0_365".
2018-04-18 10:03:26,542: Re-using an available connection from the pool.
2018-04-18 10:03:26,544: Acquiring new bigquery connection "retention_60_plus".
2018-04-18 10:03:26,545: Re-using an available connection from the pool.
2018-04-18 10:03:26,546: Acquiring new bigquery connection "segment_list_customers_products".
2018-04-18 10:03:26,546: Re-using an available connection from the pool.
2018-04-18 10:03:26,548: Acquiring new bigquery connection "retention_365_730".
2018-04-18 10:03:26,548: Re-using an available connection from the pool.
2018-04-18 10:03:27,374: Model SQL (retention_365_730):
WITH transactions AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_daily`
),

daterange AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`  	
),

temp AS (
  SELECT 
  client, 
  customer_id, 
  unix_date(date) d, 
  quantity,
  revenue,
  order_count
  FROM transactions
)

SELECT 
date_in_range date, 
unix_date_in_range,
client, 
customer_id,
sum(quantity) quantity,
sum(revenue) revenue,
sum(order_count) order_count
FROM daterange
JOIN temp
ON ( temp.d >= ( daterange.unix_date_in_range - 730 ) 
AND temp.d < ( daterange.unix_date_in_range - 365 ) )
group by date_in_range, unix_date_in_range, client, customer_id
2018-04-18 10:03:27,380: Model SQL (segment_list_customers_products):
SELECT
a.client,
period,
date,
customer_id,
product_type,
b.first_name,
b.last_name,
b.email,
recency_days,
frequency,
revenue,
quantity,
aov,
segment
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers_products` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`agg_customers_union` b
ON (
	a.client = b.client AND
	a.customer_id = b.id
)
2018-04-18 10:03:27,489: Model SQL (retention_60_plus):
WITH transactions AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_daily`
),

daterange AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`  	
),

temp AS (
  SELECT 
  client, 
  customer_id, 
  unix_date(date) d, 
  quantity,
  revenue,
  order_count
  FROM transactions
)

SELECT 
date_in_range date, 
unix_date_in_range,
client, 
customer_id,
sum(quantity) quantity,
sum(revenue) revenue,
sum(order_count) order_count
FROM daterange
JOIN temp
ON temp.d < ( daterange.unix_date_in_range_bom_mom ) 
group by date_in_range, unix_date_in_range, client, customer_id
2018-04-18 10:03:27,511: Model SQL (retention_0_365):
WITH transactions AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_daily`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
),

temp AS (
  SELECT 
  client, 
  customer_id, 
  unix_date(date) d, 
  quantity,
  revenue,
  order_count
  FROM transactions
)

SELECT 
date_in_range date,
unix_date_in_range, 
client, 
customer_id,
sum(quantity) quantity,
sum(revenue) revenue,
sum(order_count) order_count
FROM daterange
JOIN temp
ON temp.d >= ( daterange.unix_date_in_range - 365 ) 
AND temp.d <= daterange.unix_date_in_range
group by date_in_range, unix_date_in_range, client, customer_id
2018-04-18 10:03:32,360: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e1bd30>]}
2018-04-18 10:03:33,005: 10:03:33 | 65 of 91 OK created table model agency_data_pipeline.retention_365_730 [CREATE TABLE in 5.86s]
2018-04-18 10:03:33,006: 10:03:33 | 68 of 91 START table model agency_data_pipeline.retention_730_plus... [RUN]
2018-04-18 10:03:33,006: Compiling model.agency_data_pipeline.retention_730_plus
2018-04-18 10:03:33,012: Writing injected SQL for node "model.agency_data_pipeline.retention_730_plus"
2018-04-18 10:03:33,013: Acquiring new bigquery connection "retention_730_plus".
2018-04-18 10:03:33,014: Re-using an available connection from the pool.
2018-04-18 10:03:33,865: Model SQL (retention_730_plus):
WITH transactions AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_daily`
),

daterange AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`  	
),

temp AS (
  SELECT 
  client, 
  customer_id, 
  unix_date(date) d, 
  quantity,
  revenue,
  order_count
  FROM transactions
)

SELECT 
date_in_range date, 
unix_date_in_range,
client, 
customer_id,
sum(quantity) quantity,
sum(revenue) revenue,
sum(order_count) order_count
FROM daterange
JOIN temp
ON temp.d <= ( daterange.unix_date_in_range - 730 ) 
group by date_in_range, unix_date_in_range, client, customer_id
2018-04-18 10:03:36,070: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e1bd30>]}
2018-04-18 10:03:36,326: 10:03:36 | 68 of 91 OK created table model agency_data_pipeline.retention_730_plus [CREATE TABLE in 3.06s]
2018-04-18 10:03:36,327: 10:03:36 | 69 of 91 START table model agency_data_pipeline.retention_0_30....... [RUN]
2018-04-18 10:03:36,327: Compiling model.agency_data_pipeline.retention_0_30
2018-04-18 10:03:36,339: Writing injected SQL for node "model.agency_data_pipeline.retention_0_30"
2018-04-18 10:03:36,340: Acquiring new bigquery connection "retention_0_30".
2018-04-18 10:03:36,340: Re-using an available connection from the pool.
2018-04-18 10:03:36,760: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e06128>]}
2018-04-18 10:03:37,037: 10:03:37 | 64 of 91 OK created table model agency_data_pipeline.retention_60_plus [CREATE TABLE in 10.26s]
2018-04-18 10:03:37,037: 10:03:37 | 70 of 91 START table model agency_data_pipeline.retention_30_60...... [RUN]
2018-04-18 10:03:37,038: Compiling model.agency_data_pipeline.retention_30_60
2018-04-18 10:03:37,046: Writing injected SQL for node "model.agency_data_pipeline.retention_30_60"
2018-04-18 10:03:37,047: Acquiring new bigquery connection "retention_30_60".
2018-04-18 10:03:37,047: Re-using an available connection from the pool.
2018-04-18 10:03:37,077: Model SQL (retention_0_30):
WITH transactions AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_daily`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
),

temp AS (
  SELECT 
  client, 
  customer_id, 
  unix_date(date) d, 
  quantity,
  revenue,
  order_count
  FROM transactions
)

SELECT 
date_in_range date,
unix_date_in_range, 
client, 
customer_id,
sum(quantity) quantity,
sum(revenue) revenue,
sum(order_count) order_count
FROM daterange
JOIN temp
ON temp.d >= ( daterange.unix_date_in_range_bom ) 
AND temp.d <= daterange.unix_date_in_range
group by date_in_range, unix_date_in_range, client, customer_id
2018-04-18 10:03:37,798: Model SQL (retention_30_60):
WITH transactions AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_daily`
),

daterange AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`  	
),

temp AS (
  SELECT 
  client, 
  customer_id, 
  unix_date(date) d, 
  quantity,
  revenue,
  order_count
  FROM transactions
)

SELECT 
date_in_range date, 
unix_date_in_range,
client, 
customer_id,
sum(quantity) quantity,
sum(revenue) revenue,
sum(order_count) order_count
FROM daterange
JOIN temp
ON ( temp.d >= ( daterange.unix_date_in_range_bom_mom ) 
AND temp.d < ( daterange.unix_date_in_range_bom ) )
group by date_in_range, unix_date_in_range, client, customer_id
2018-04-18 10:03:38,995: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x101853e10>]}
2018-04-18 10:03:39,713: 10:03:39 | 67 of 91 OK created table model agency_data_pipeline.retention_0_365. [CREATE TABLE in 12.49s]
2018-04-18 10:03:40,424: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e1bd30>]}
2018-04-18 10:03:40,694: 10:03:40 | 69 of 91 OK created table model agency_data_pipeline.retention_0_30.. [CREATE TABLE in 4.10s]
2018-04-18 10:03:42,210: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e06128>]}
2018-04-18 10:03:42,465: 10:03:42 | 70 of 91 OK created table model agency_data_pipeline.retention_30_60. [CREATE TABLE in 5.17s]
2018-04-18 10:04:06,834: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e39a20>]}
2018-04-18 10:04:07,128: 10:04:07 | 66 of 91 OK created table model agency_data_pipeline.segment_list_customers_products [CREATE TABLE in 40.33s]
2018-04-18 10:04:07,130: 10:04:07 | 71 of 91 START table model agency_data_pipeline.agg_platforms_union.. [RUN]
2018-04-18 10:04:07,131: Compiling model.agency_data_pipeline.agg_platforms_union
2018-04-18 10:04:07,131: 10:04:07 | 72 of 91 START table model agency_data_pipeline.segment_proc_customers [RUN]
2018-04-18 10:04:07,142: Compiling model.agency_data_pipeline.segment_proc_customers
2018-04-18 10:04:07,160: Writing injected SQL for node "model.agency_data_pipeline.agg_platforms_union"
2018-04-18 10:04:07,166: Writing injected SQL for node "model.agency_data_pipeline.segment_proc_customers"
2018-04-18 10:04:07,169: Acquiring new bigquery connection "segment_proc_customers".
2018-04-18 10:04:07,170: Re-using an available connection from the pool.
2018-04-18 10:04:07,172: Acquiring new bigquery connection "agg_platforms_union".
2018-04-18 10:04:07,172: Re-using an available connection from the pool.
2018-04-18 10:04:08,154: Model SQL (segment_proc_customers):
SELECT
client,
period,
date,
customer_id,
first_order_date,
first_order_unix_date,
recency_days,
frequency,
revenue,
quantity,
aov,
case when recency_days <= 30 and first_order_unix_date >= window_start_unix_date then 'New'
	when frequency = 1 and recency_days <= 90 and aov >= aov_40pct then 'Promising'
	when frequency = 1 then 'One-time Purchaser'
	when frequency >= frequency_90pct and recency_days <= 90 and aov > aov_40pct then 'Whale'
	when recency_days <= 240 and frequency > frequency_50pct then 'Loyal'
	when recency_days <= 90 and frequency > frequency_50pct then 'Potential Loyalists' 
	when recency_days > 240 and frequency > frequency_50pct then 'Defecting Good Customer'	
	when recency_days > recency_50pct and frequency > frequency_50pct then 'Frequent, not Recent'
	when recency_days < recency_50pct and frequency < frequency_50pct then 'Recent, not Frequent'
	else 'Unbucketed' end as segment,
aov_40pct,
frequency_90pct,
frequency_75pct,
frequency_50pct,
recency_50pct
FROM
(
	SELECT 
	a.client client,
	period,
	date,
	a.customer_id customer_id,
	b.first_order_date first_order_date,
	b.first_order_unix_date first_order_unix_date,
	window_start_unix_date,
	window_end_unix_date,
	recency_days,
	frequency,
	revenue,
	quantity,
	aov,
	PERCENTILE_CONT(aov, 0.40) OVER w1 AS aov_40pct,
	PERCENTILE_CONT(frequency, 0.90) OVER w1 AS frequency_90pct,
	PERCENTILE_CONT(frequency, 0.75) OVER w1 AS frequency_75pct,
	PERCENTILE_CONT(frequency, 0.50) OVER w1 AS frequency_50pct,
	PERCENTILE_CONT(recency_days, 0.5) OVER w1 AS recency_50pct
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`customers_proc` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`customers_first_purchase_proc` b
	ON (
		a.client = b.client and
		a.customer_id = b.customer_id
		)
	WINDOW w1 as (PARTITION BY a.client, period, date)
)
2018-04-18 10:04:09,188: Model SQL (agg_platforms_union):
SELECT 
date, 
account, 
channel,
platform,
url,
utm_campaign,
campaign,
cost,
impressions,
clicks,
transactions
FROM 
`growth-engines-pipeline`.`agency_data_pipeline`.`adwords_stats`

UNION ALL

SELECT 
date, 
account, 
channel,
platform,
url,
utm_campaign,
campaign,
cost,
impressions,
clicks,
transactions
FROM 
`growth-engines-pipeline`.`agency_data_pipeline`.`bing_ads_stats`

UNION ALL  

SELECT 
date, 
account, 
channel,
platform,
url,
utm_campaign,
campaign,
cost,
impressions,
clicks,
transactions
FROM 
`growth-engines-pipeline`.`agency_data_pipeline`.`fb_ads_stats`
2018-04-18 10:04:13,572: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e1bf60>]}
2018-04-18 10:04:14,254: 10:04:14 | 71 of 91 OK created table model agency_data_pipeline.agg_platforms_union [CREATE TABLE in 6.44s]
2018-04-18 10:04:37,556: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1018d4358>]}
2018-04-18 10:04:37,835: 10:04:37 | 72 of 91 OK created table model agency_data_pipeline.segment_proc_customers [CREATE TABLE in 30.41s]
2018-04-18 10:04:37,837: 10:04:37 | 73 of 91 START table model agency_data_pipeline.segment_stats_customers_agg [RUN]
2018-04-18 10:04:37,837: Compiling model.agency_data_pipeline.segment_stats_customers_agg
2018-04-18 10:04:37,837: 10:04:37 | 74 of 91 START table model agency_data_pipeline.retention_0_30_rebuy. [RUN]
2018-04-18 10:04:37,843: Compiling model.agency_data_pipeline.retention_0_30_rebuy
2018-04-18 10:04:37,855: Writing injected SQL for node "model.agency_data_pipeline.retention_0_30_rebuy"
2018-04-18 10:04:37,837: 10:04:37 | 75 of 91 START table model agency_data_pipeline.retention_0_365_rebuy [RUN]
2018-04-18 10:04:37,860: Compiling model.agency_data_pipeline.retention_0_365_rebuy
2018-04-18 10:04:37,858: Writing injected SQL for node "model.agency_data_pipeline.segment_stats_customers_agg"
2018-04-18 10:04:37,868: Writing injected SQL for node "model.agency_data_pipeline.retention_0_365_rebuy"
2018-04-18 10:04:37,871: Acquiring new bigquery connection "retention_0_30_rebuy".
2018-04-18 10:04:37,872: Re-using an available connection from the pool.
2018-04-18 10:04:37,875: Acquiring new bigquery connection "segment_stats_customers_agg".
2018-04-18 10:04:37,877: Acquiring new bigquery connection "retention_0_365_rebuy".
2018-04-18 10:04:37,877: Re-using an available connection from the pool.
2018-04-18 10:04:37,879: Re-using an available connection from the pool.
2018-04-18 10:04:41,034: Model SQL (retention_0_365_rebuy):
SELECT 
r2.client,
r2.date,
r2.customer_id, 
r2.quantity,
r2.revenue
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_365_730` r1 
left join `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365` r2 
  on ( r1.customer_id = r2.customer_id 
  and r1.date = r2.date )
2018-04-18 10:04:41,036: Model SQL (segment_stats_customers_agg):
WITH ty as (

	SELECT
	client,
	date,
	customer_id,
	segment as segment_365,
	recency_days as recency_365,
	frequency as frequency_365,
	revenue as revenue_365,
	aov as aov_365,
	'' as segment_mom,
	0 as recency_mom,
	0 as frequency_mom,
	0 as revenue_mom,
	0 as aov_mom,
	'' as segment_yoy,
	0 as recency_yoy,
	0 as frequency_yoy,
	0 as revenue_yoy,
	0 as aov_yoy
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers`
	WHERE period = 'Rolling 365'

),

last_month as (

	SELECT
	client,
	date,
	customer_id,
	'' as segment_365,
	0 as recency_365,
	0 as frequency_365,
	0 as revenue_365,
	0 as aov_365,
	segment as segment_mom,
	recency_days as recency_mom,
	frequency as frequency_mom,
	revenue as revenue_mom,
	aov as aov_mom,
	'' as segment_yoy,
	0 as recency_yoy,
	0 as frequency_yoy,
	0 as revenue_yoy,
	0 as aov_yoy
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers`
	WHERE period = 'Rolling 365 (t-1mo)'

),

this_month_1yr as (

	SELECT
	client,
	date,
	customer_id,
	'' as segment_365,
	0 as recency_365,
	0 as frequency_365,
	0 as revenue_365,
	0 as aov_365,
	'' as segment_mom,
	0 as recency_mom,
	0 as frequency_mom,
	0 as revenue_mom,
	0 as aov_mom,
	segment as segment_yoy,
	recency_days as recency_yoy,
	frequency as frequency_yoy,
	revenue as revenue_yoy,
	aov as aov_yoy
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers`
	WHERE period = 'Rolling 365 (t-1yr)'


)

SELECT
client,
date, 
customer_id,
ifnull(max(segment_365), '') segment_365,
ifnull(max(segment_mom), '') segment_mom,
ifnull(max(segment_yoy), '') segment_yoy,
ifnull(sum(recency_365), 0) recency_365,
ifnull(sum(frequency_365), 0) frequency_365,
ifnull(sum(revenue_365), 0) revenue_365,
ifnull(sum(aov_365), 0) aov_365,
ifnull(sum(recency_mom), 0) recency_mom,
ifnull(sum(frequency_mom), 0) frequency_mom,
ifnull(sum(revenue_mom), 0) revenue_mom,
ifnull(sum(aov_mom), 0) aov_mom,	
ifnull(sum(recency_yoy), 0) recency_yoy,
ifnull(sum(frequency_yoy), 0) frequency_yoy,
ifnull(sum(revenue_yoy), 0) revenue_yoy,
ifnull(sum(aov_yoy), 0) aov_yoy
FROM
(
	SELECT * FROM ty
	UNION ALL
	SELECT * FROM last_month
	UNION ALL
	SELECT * FROM this_month_1yr

)
GROUP BY client, date, customer_id
2018-04-18 10:04:41,037: Model SQL (retention_0_30_rebuy):
SELECT 
r2.client,
r2.date,
r2.customer_id, 
r2.quantity,
r2.revenue
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_30_60` r1 
left join `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30` r2 
  on ( r1.customer_id = r2.customer_id 
  and r1.date = r2.date )
2018-04-18 10:04:44,044: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x101870e48>]}
2018-04-18 10:04:44,296: 10:04:44 | 74 of 91 OK created table model agency_data_pipeline.retention_0_30_rebuy [CREATE TABLE in 6.20s]
2018-04-18 10:04:45,565: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104d9d1d0>]}
2018-04-18 10:04:45,819: 10:04:45 | 75 of 91 OK created table model agency_data_pipeline.retention_0_365_rebuy [CREATE TABLE in 7.71s]
2018-04-18 10:05:05,432: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x101897518>]}
2018-04-18 10:05:06,089: 10:05:06 | 73 of 91 OK created table model agency_data_pipeline.segment_stats_customers_agg [CREATE TABLE in 27.59s]
2018-04-18 10:05:06,091: 10:05:06 | 76 of 91 START table model agency_data_pipeline.retention_stats_rebuy_rate [RUN]
2018-04-18 10:05:06,091: Compiling model.agency_data_pipeline.retention_stats_rebuy_rate
2018-04-18 10:05:06,104: 10:05:06 | 77 of 91 START table model agency_data_pipeline.retention_stats_rebuy_rate_month [RUN]
2018-04-18 10:05:06,104: Compiling model.agency_data_pipeline.retention_stats_rebuy_rate_month
2018-04-18 10:05:06,120: Writing injected SQL for node "model.agency_data_pipeline.retention_stats_rebuy_rate"
2018-04-18 10:05:06,121: 10:05:06 | 78 of 91 START table model agency_data_pipeline.retention_0_30_reactivated [RUN]
2018-04-18 10:05:06,121: Compiling model.agency_data_pipeline.retention_0_30_reactivated
2018-04-18 10:05:06,130: 10:05:06 | 79 of 91 START table model agency_data_pipeline.retention_0_30_new... [RUN]
2018-04-18 10:05:06,131: Compiling model.agency_data_pipeline.retention_0_30_new
2018-04-18 10:05:06,142: Writing injected SQL for node "model.agency_data_pipeline.retention_0_30_new"
2018-04-18 10:05:06,144: Acquiring new bigquery connection "retention_0_30_new".
2018-04-18 10:05:06,145: Re-using an available connection from the pool.
2018-04-18 10:05:06,157: Writing injected SQL for node "model.agency_data_pipeline.retention_0_30_reactivated"
2018-04-18 10:05:06,159: Acquiring new bigquery connection "retention_0_30_reactivated".
2018-04-18 10:05:06,159: Re-using an available connection from the pool.
2018-04-18 10:05:06,164: Acquiring new bigquery connection "retention_stats_rebuy_rate".
2018-04-18 10:05:06,164: Re-using an available connection from the pool.
2018-04-18 10:05:06,184: Writing injected SQL for node "model.agency_data_pipeline.retention_stats_rebuy_rate_month"
2018-04-18 10:05:06,185: Acquiring new bigquery connection "retention_stats_rebuy_rate_month".
2018-04-18 10:05:06,185: Re-using an available connection from the pool.
2018-04-18 10:05:09,030: Model SQL (retention_0_30_new):
SELECT 
a.client,
a.date,
a.customer_id, 
a.quantity,
a.revenue,
a.order_count
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_60_plus` b
ON (
	a.client = b.client AND
	a.date = b.date AND
	a.customer_id = b.customer_id
)
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_30_60` c
ON (
	a.client = c.client AND
	a.date = c.date AND
	a.customer_id = c.customer_id
)
WHERE b.customer_id is null 
and c.customer_id is null
2018-04-18 10:05:09,030: Model SQL (retention_0_30_reactivated):
SELECT 
a.client,
a.date,
a.customer_id, 
a.quantity,
a.revenue
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_60_plus` b
ON (
	a.client = b.client AND
	a.date = b.date AND
	a.customer_id = b.customer_id
)
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_30_60` c
ON (
	a.client = c.client AND
	a.date = c.date AND
	a.customer_id = c.customer_id
)
WHERE b.customer_id is not null 
AND c.customer_id is null
2018-04-18 10:05:09,035: Model SQL (retention_stats_rebuy_rate):
WITH r1 AS (
	SELECT 
	date,
	client,
	count(distinct customer_id) customers_prior_year,
	0 as customers_current_year, 
	sum(quantity) quantity_prior_year,
	0 as quantity_current_year,
	sum(revenue) revenue_prior_year,
	0 as revenue_current_year,
	case when sum(quantity) > 0 then sum(revenue)/sum(quantity) else null end as aov_prior_year,
	null as aov_current_year
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_365_730`
	group by date, client
),

r2 AS (
	SELECT 
	date,
	client,
	0 as customers_prior_year,
	count(distinct customer_id) customers_current_year, 
	0 as quantity_prior_year,
	sum(quantity) quantity_current_year,
	0 as revenue_prior_year,
	sum(revenue) revenue_current_year,
	null as aov_prior_year,
	case when sum(quantity) > 0 then sum(revenue)/sum(quantity) else null end as aov_current_year
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365_rebuy`
	group by date, client
)

SELECT 
date,
client,
sum(customers_prior_year) customers_prior_year, 
sum(customers_current_year) customers_current_year,
sum(quantity_prior_year) quantity_prior_year,
sum(quantity_current_year) quantity_current_year,
sum(revenue_prior_year) revenue_prior_year,
sum(revenue_current_year) revenue_current_year,
sum(aov_prior_year) aov_prior_year,
sum(aov_current_year) aov_current_year,
case when sum(revenue_prior_year) > 0 then sum(revenue_current_year)/sum(revenue_prior_year) else null end as revenue_retention,
case when sum(customers_prior_year) > 0 then sum(customers_current_year)/sum(customers_prior_year) else null end as customer_retention
FROM
(
	SELECT
	date,
	client,
	customers_prior_year,
	customers_current_year,
	quantity_prior_year,
	quantity_current_year,
	revenue_prior_year,
	revenue_current_year,
	aov_prior_year,
	aov_current_year
	FROM r1

	UNION ALL

	SELECT
	date,
	client,
	customers_prior_year,
	customers_current_year,
	quantity_prior_year,
	quantity_current_year,
	revenue_prior_year,
	revenue_current_year,
	aov_prior_year,
	aov_current_year
	FROM r2

) 
GROUP BY date, client
2018-04-18 10:05:09,056: Model SQL (retention_stats_rebuy_rate_month):
WITH r1 AS (
	SELECT 
	date,
	client,
	count(distinct customer_id) customers_prior_year,
	0 as customers_current_year, 
	sum(quantity) quantity_prior_year,
	0 as quantity_current_year,
	sum(revenue) revenue_prior_year,
	0 as revenue_current_year,
	case when sum(quantity) > 0 then sum(revenue)/sum(quantity) else null end as aov_prior_year,
	null as aov_current_year
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_30_60`
	group by date, client
),

r2 AS (
	SELECT 
	date,
	client,
	0 as customers_prior_year,
	count(distinct customer_id) customers_current_year, 
	0 as quantity_prior_year,
	sum(quantity) quantity_current_year,
	0 as revenue_prior_year,
	sum(revenue) revenue_current_year,
	null as aov_prior_year,
	case when sum(quantity) > 0 then sum(revenue)/sum(quantity) else null end as aov_current_year
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30_rebuy`
	group by date, client
)

SELECT 
date,
client,
sum(customers_prior_year) customers_prior_year, 
sum(customers_current_year) customers_current_year,
sum(quantity_prior_year) quantity_prior_year,
sum(quantity_current_year) quantity_current_year,
sum(revenue_prior_year) revenue_prior_year,
sum(revenue_current_year) revenue_current_year,
sum(aov_prior_year) aov_prior_year,
sum(aov_current_year) aov_current_year,
case when sum(revenue_prior_year) > 0 then sum(revenue_current_year)/sum(revenue_prior_year) else null end as revenue_retention,
case when sum(customers_prior_year) > 0 then sum(customers_current_year)/sum(customers_prior_year) else null end as customer_retention
FROM
(
	SELECT
	date,
	client,
	customers_prior_year,
	customers_current_year,
	quantity_prior_year,
	quantity_current_year,
	revenue_prior_year,
	revenue_current_year,
	aov_prior_year,
	aov_current_year
	FROM r1

	UNION ALL

	SELECT
	date,
	client,
	customers_prior_year,
	customers_current_year,
	quantity_prior_year,
	quantity_current_year,
	revenue_prior_year,
	revenue_current_year,
	aov_prior_year,
	aov_current_year
	FROM r2

) 
GROUP BY date, client
2018-04-18 10:05:12,067: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e39828>]}
2018-04-18 10:05:12,084: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104d9da20>]}
2018-04-18 10:05:12,095: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x101870dd8>]}
2018-04-18 10:05:12,405: 10:05:12 | 76 of 91 OK created table model agency_data_pipeline.retention_stats_rebuy_rate [CREATE TABLE in 5.98s]
2018-04-18 10:05:12,406: 10:05:12 | 80 of 91 START table model agency_data_pipeline.retention_0_365_reactivated [RUN]
2018-04-18 10:05:12,406: Compiling model.agency_data_pipeline.retention_0_365_reactivated
2018-04-18 10:05:12,425: Writing injected SQL for node "model.agency_data_pipeline.retention_0_365_reactivated"
2018-04-18 10:05:12,434: Acquiring new bigquery connection "retention_0_365_reactivated".
2018-04-18 10:05:12,434: Re-using an available connection from the pool.
2018-04-18 10:05:12,704: 10:05:12 | 78 of 91 OK created table model agency_data_pipeline.retention_0_30_reactivated [CREATE TABLE in 5.96s]
2018-04-18 10:05:12,705: 10:05:12 | 81 of 91 START table model agency_data_pipeline.agg_platforms_client. [RUN]
2018-04-18 10:05:12,705: Compiling model.agency_data_pipeline.agg_platforms_client
2018-04-18 10:05:12,717: Writing injected SQL for node "model.agency_data_pipeline.agg_platforms_client"
2018-04-18 10:05:12,720: Acquiring new bigquery connection "agg_platforms_client".
2018-04-18 10:05:12,720: Re-using an available connection from the pool.
2018-04-18 10:05:12,982: 10:05:12 | 77 of 91 OK created table model agency_data_pipeline.retention_stats_rebuy_rate_month [CREATE TABLE in 5.99s]
2018-04-18 10:05:12,982: 10:05:12 | 82 of 91 START table model agency_data_pipeline.retention_0_365_new.. [RUN]
2018-04-18 10:05:12,982: Compiling model.agency_data_pipeline.retention_0_365_new
2018-04-18 10:05:12,988: Writing injected SQL for node "model.agency_data_pipeline.retention_0_365_new"
2018-04-18 10:05:12,989: Acquiring new bigquery connection "retention_0_365_new".
2018-04-18 10:05:12,989: Re-using an available connection from the pool.
2018-04-18 10:05:15,026: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10189d5f8>]}
2018-04-18 10:05:15,203: Model SQL (agg_platforms_client):
SELECT 
date, 
a.account account, 
b.client client,
a.platform platform,
a.channel channel,
url,
utm_campaign,
campaign,
cost,
impressions,
clicks,
transactions ad_platform_transactions
FROM 
  `growth-engines-pipeline`.`agency_data_pipeline`.`agg_platforms_union` a
LEFT JOIN 
  `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc` b
ON ( 
  a.account = b.account AND
  a.platform = b.platform
)
2018-04-18 10:05:15,234: Model SQL (retention_0_365_reactivated):
SELECT 
a.client,
a.date,
a.customer_id, 
a.quantity,
a.revenue
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_730_plus` b
ON (
	a.client = b.client AND
	a.date = b.date AND
	a.customer_id = b.customer_id
)
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_365_730` c
ON (
	a.client = c.client AND
	a.date = c.date AND
	a.customer_id = c.customer_id
)
WHERE b.customer_id is not null 
AND c.customer_id is null
2018-04-18 10:05:15,291: 10:05:15 | 79 of 91 OK created table model agency_data_pipeline.retention_0_30_new [CREATE TABLE in 8.89s]
2018-04-18 10:05:15,292: 10:05:15 | 83 of 91 START table model agency_data_pipeline.segment_stats_customers [RUN]
2018-04-18 10:05:15,292: Compiling model.agency_data_pipeline.segment_stats_customers
2018-04-18 10:05:15,303: Writing injected SQL for node "model.agency_data_pipeline.segment_stats_customers"
2018-04-18 10:05:15,306: Acquiring new bigquery connection "segment_stats_customers".
2018-04-18 10:05:15,306: Re-using an available connection from the pool.
2018-04-18 10:05:15,755: Model SQL (retention_0_365_new):
SELECT 
a.client,
a.date,
a.customer_id, 
a.quantity,
a.revenue,
a.order_count
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_730_plus` b
ON (
	a.client = b.client AND
	a.date = b.date AND
	a.customer_id = b.customer_id
)
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_365_730` c
ON (
	a.client = c.client AND
	a.date = c.date AND
	a.customer_id = c.customer_id
)
WHERE b.customer_id is null 
and c.customer_id is null
2018-04-18 10:05:17,061: Model SQL (segment_stats_customers):
SELECT
client,
date,
segment_365,
segment_mom,
segment_yoy,
count(distinct(customer_id)) customers,
avg(recency_365) recency_365,
sum(frequency_365) frequency_365,
sum(revenue_365) revenue_365,
case when sum(frequency_365) > 0 then sum(revenue_365)/sum(frequency_365) else null end as aov_365,
avg(recency_mom) recency_mom,
sum(frequency_mom) frequency_mom,
sum(revenue_mom) revenue_mom,
case when sum(frequency_mom) > 0 then sum(revenue_mom)/sum(frequency_mom) else null end as aov_mom,
avg(recency_yoy) recency_yoy,
sum(frequency_yoy) frequency_yoy,
sum(revenue_yoy) revenue_yoy,
case when sum(frequency_yoy) > 0 then sum(revenue_yoy)/sum(frequency_yoy) else null end as aov_yoy
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_stats_customers_agg`
GROUP BY client, date, segment_365, segment_mom, segment_yoy
2018-04-18 10:05:17,826: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e39828>]}
2018-04-18 10:05:18,518: 10:05:18 | 80 of 91 OK created table model agency_data_pipeline.retention_0_365_reactivated [CREATE TABLE in 5.42s]
2018-04-18 10:05:21,094: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x101870eb8>]}
2018-04-18 10:05:21,367: 10:05:21 | 81 of 91 OK created table model agency_data_pipeline.agg_platforms_client [CREATE TABLE in 8.39s]
2018-04-18 10:05:26,820: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e22da0>]}
2018-04-18 10:05:27,100: 10:05:27 | 82 of 91 OK created table model agency_data_pipeline.retention_0_365_new [CREATE TABLE in 13.84s]
2018-04-18 10:05:29,112: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e1bd30>]}
2018-04-18 10:05:29,379: 10:05:29 | 83 of 91 OK created table model agency_data_pipeline.segment_stats_customers [CREATE TABLE in 13.82s]
2018-04-18 10:05:29,381: 10:05:29 | 84 of 91 START table model agency_data_pipeline.segment_list_customers [RUN]
2018-04-18 10:05:29,381: Compiling model.agency_data_pipeline.segment_list_customers
2018-04-18 10:05:29,399: Writing injected SQL for node "model.agency_data_pipeline.segment_list_customers"
2018-04-18 10:05:29,405: Acquiring new bigquery connection "segment_list_customers".
2018-04-18 10:05:29,405: Re-using an available connection from the pool.
2018-04-18 10:05:30,301: Model SQL (segment_list_customers):
SELECT
a.client,
period,
date,
customer_id,
b.first_name,
b.last_name,
b.email,
recency_days,
frequency,
revenue,
quantity,
aov,
segment
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`agg_customers_union` b
ON (
	a.client = b.client AND
	a.customer_id = b.id
)
2018-04-18 10:06:03,552: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x101870f60>]}
2018-04-18 10:06:04,268: 10:06:04 | 84 of 91 OK created table model agency_data_pipeline.segment_list_customers [CREATE TABLE in 34.17s]
2018-04-18 10:06:04,270: 10:06:04 | 85 of 91 START table model agency_data_pipeline.growth_customer_0_365_segment [RUN]
2018-04-18 10:06:04,270: Compiling model.agency_data_pipeline.growth_customer_0_365_segment
2018-04-18 10:06:04,292: Writing injected SQL for node "model.agency_data_pipeline.growth_customer_0_365_segment"
2018-04-18 10:06:04,296: Acquiring new bigquery connection "growth_customer_0_365_segment".
2018-04-18 10:06:04,297: Re-using an available connection from the pool.
2018-04-18 10:06:07,354: Model SQL (growth_customer_0_365_segment):
with segment as (

	SELECT 
	a.date,
	unix_date_in_range,
	unix_date_in_range_yoy,
	a.client client,
	a.customer_id customer_id,
	case when b.customer_id is not null then 'New' else 'Existing' end as segment,
	a.orders,
	a.quantity,
	a.revenue,
	a.shipping_revenue
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_customer_0_365` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365_new` b
	ON (
	  a.customer_id = b.customer_id AND
	  a.date  = b.date AND
	  a.client = b.client
	)
),

total as (

	SELECT 
	date,
	unix_date_in_range,
	unix_date_in_range_yoy,
	client,
	customer_id,
	'Total' as segment,
	orders,
	quantity,
	revenue,
	shipping_revenue
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_customer_0_365`

)

SELECT 
date,
unix_date_in_range,
unix_date_in_range_yoy,
client,
segment,
count(distinct(customer_id)) customers,
sum(orders) orders,
sum(quantity) quantity,
sum(revenue) revenue,
sum(shipping_revenue) shipping_revenue
FROM
( 
	SELECT * FROM segment
	UNION ALL
	SELECT * FROM total
) 
GROUP BY date, unix_date_in_range, unix_date_in_range_yoy, client, segment
2018-04-18 10:06:18,656: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e22d30>]}
2018-04-18 10:06:19,431: 10:06:19 | 85 of 91 OK created table model agency_data_pipeline.growth_customer_0_365_segment [CREATE TABLE in 14.39s]
2018-04-18 10:06:19,432: 10:06:19 | 86 of 91 START table model agency_data_pipeline.growth_date_union.... [RUN]
2018-04-18 10:06:19,432: Compiling model.agency_data_pipeline.growth_date_union
2018-04-18 10:06:19,443: Writing injected SQL for node "model.agency_data_pipeline.growth_date_union"
2018-04-18 10:06:19,445: Acquiring new bigquery connection "growth_date_union".
2018-04-18 10:06:19,445: Re-using an available connection from the pool.
2018-04-18 10:06:20,357: Model SQL (growth_date_union):
with ty as (

  SELECT 
  date,
  unix_date_in_range, 
  unix_date_in_range_yoy, 
  client, 
  segment,
  customers customers_ty,
  orders orders_ty,
  quantity quantity_ty,
  revenue revenue_ty,
  shipping_revenue shipping_revenue_ty,
  null as customers_ly,
  null as orders_ly,
  null as quantity_ly,
  null as revenue_ly,
  null as shipping_revenue_ly
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_customer_0_365_segment`

),

ly as (

  SELECT 
  date,
  0 as unix_date_in_range, 
  unix_date_in_range unix_date_in_range_yoy, 
  client, 
  segment,
  null as customers_ty,
  null as orders_ty,
  null as quantity_ty,
  null as revenue_ty,
  null as shipping_revenue_ty,
  customers customers_ly,
  orders orders_ly,
  quantity quantity_ly,
  revenue revenue_ly,
  shipping_revenue shipping_revenue_ly
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_customer_0_365_segment`

)


SELECT
max(date) date,
max(unix_date_in_range) unix_date_in_range,
unix_date_in_range_yoy,
client,
segment,
ifnull(sum(customers_ty), 0) customers_ty,
ifnull(sum(orders_ty), 0) orders_ty,
ifnull(sum(quantity_ty), 0) quantity_ty,
ifnull(sum(revenue_ty), 0) revenue_ty,
ifnull(sum(shipping_revenue_ty), 0) shipping_revenue_ty,
case when sum(orders_ty) > 0 then sum(revenue_ty)/sum(orders_ty) else null end as aov_ty,
ifnull(sum(customers_ly), 0) customers_ly,
ifnull(sum(orders_ly), 0) orders_ly,
ifnull(sum(quantity_ly), 0) quantity_ly,
ifnull(sum(revenue_ly), 0) revenue_ly,
ifnull(sum(shipping_revenue_ly), 0) shipping_revenue_ly,
case when sum(orders_ly) > 0 then sum(revenue_ly)/sum(orders_ly) else null end as aov_ly,
case when sum(orders_ly) > 0 then ( sum(orders_ty) - sum(orders_ly) ) / sum(orders_ly) else null end as order_growth,
case when sum(revenue_ly) > 0 then ( sum(revenue_ty) - sum(revenue_ly) ) / sum(revenue_ly) else null end as revenue_growth,
case when sum(customers_ly) > 0 then ( sum(customers_ty) - sum(customers_ly) ) / sum(customers_ly) else null end as customer_growth,
case when sum(orders_ly) > 0 then ( sum(revenue_ty)/sum(orders_ty) - sum(revenue_ly)/sum(orders_ly) ) / ( sum(revenue_ly)/sum(orders_ly) ) else null end as aov_growth
FROM (

  SELECT * FROM ty
  UNION ALL
  SELECT * FROM ly

)
where unix_date_in_range is not null
group by unix_date_in_range_yoy, client, segment
2018-04-18 10:06:22,600: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x101870f60>]}
2018-04-18 10:06:22,882: 10:06:22 | 86 of 91 OK created table model agency_data_pipeline.growth_date_union [CREATE TABLE in 3.17s]
2018-04-18 10:06:22,883: 10:06:22 | 87 of 91 START table model agency_data_pipeline.retention_stats...... [RUN]
2018-04-18 10:06:22,884: Compiling model.agency_data_pipeline.retention_stats
2018-04-18 10:06:22,883: 10:06:22 | 88 of 91 START table model agency_data_pipeline.growth_stats......... [RUN]
2018-04-18 10:06:22,891: Compiling model.agency_data_pipeline.growth_stats
2018-04-18 10:06:22,911: Writing injected SQL for node "model.agency_data_pipeline.retention_stats"
2018-04-18 10:06:22,884: 10:06:22 | 89 of 91 START table model agency_data_pipeline.retention_stats_month [RUN]
2018-04-18 10:06:22,914: Writing injected SQL for node "model.agency_data_pipeline.growth_stats"
2018-04-18 10:06:22,915: Compiling model.agency_data_pipeline.retention_stats_month
2018-04-18 10:06:22,931: Writing injected SQL for node "model.agency_data_pipeline.retention_stats_month"
2018-04-18 10:06:22,934: Acquiring new bigquery connection "retention_stats".
2018-04-18 10:06:22,934: Re-using an available connection from the pool.
2018-04-18 10:06:22,941: Acquiring new bigquery connection "growth_stats".
2018-04-18 10:06:22,941: Re-using an available connection from the pool.
2018-04-18 10:06:22,946: Acquiring new bigquery connection "retention_stats_month".
2018-04-18 10:06:22,946: Re-using an available connection from the pool.
2018-04-18 10:06:23,826: Model SQL (retention_stats_month):
WITH last_month_buyers AS (
	SELECT 
	date,
	client,
	'Last month buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_30_60`
	group by date, client
),

rebuy_rate AS (
	SELECT 
	date,
	client,
	'Rebuy rate' as metric,
	customer_retention value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_stats_rebuy_rate_month`
),

repeat_buyers AS (
	SELECT 
	date,
	client,
	'Repeat buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30_rebuy`
	group by date, client
),

reactivated_buyers AS (
	SELECT 
	date,
	client,
	'Reactivated buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30_reactivated`
	group by date, client
),

new_buyers AS (
	SELECT 
	date,
	client,
	'New buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30_new`
	group by date, client
),

this_month_buyers AS (
	SELECT 
	date,
	client,
	'This month buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30`
	group by date, client
),

this_month_revenue AS (
	SELECT 
	date,
	client,
	'This month revenue' as metric,
	sum(revenue) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30`
	group by date, client
),

this_month_aov AS (
	SELECT 
	date,
	client,
	'This month AOV' as metric,
	case when sum(order_count) > 0 then sum(revenue)/sum(order_count) else 0 end as value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30`
	group by date, client
),

this_month_frequency AS (
	SELECT 
	date,
	client,
	'This month frequency' as metric,
	case when count(distinct customer_id) > 0 then sum(order_count)/count(distinct customer_id) else 0 end as value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30`
	group by date, client
)

SELECT 
date,
client,
metric,
ifnull(value, 0) value
FROM
(
	SELECT
	date,
	client,
	metric,
	value
	FROM last_month_buyers

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM rebuy_rate

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM repeat_buyers

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM reactivated_buyers	

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM new_buyers	

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_month_buyers	

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_month_revenue

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_month_aov

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_month_frequency

	UNION ALL

	SELECT
	a.date,
	a.client,
	'Dormant buyers' as metric,
	a.value - ifnull(b.value, 0) as value
	FROM last_month_buyers a
	LEFT JOIN repeat_buyers b
	ON ( a.date = b.date AND
		a.client = b.client )							

)
2018-04-18 10:06:23,864: Model SQL (retention_stats):
WITH last_year_buyers AS (
	SELECT 
	date,
	client,
	'Last year buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_365_730`
	group by date, client
),

rebuy_rate AS (
	SELECT 
	date,
	client,
	'Rebuy rate' as metric,
	customer_retention value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_stats_rebuy_rate`
),

repeat_buyers AS (
	SELECT 
	date,
	client,
	'Repeat buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365_rebuy`
	group by date, client
),

reactivated_buyers AS (
	SELECT 
	date,
	client,
	'Reactivated buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365_reactivated`
	group by date, client
),

new_buyers AS (
	SELECT 
	date,
	client,
	'New buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365_new`
	group by date, client
),

this_year_buyers AS (
	SELECT 
	date,
	client,
	'This year buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365`
	group by date, client
),

this_year_revenue AS (
	SELECT 
	date,
	client,
	'This year revenue' as metric,
	sum(revenue) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365`
	group by date, client
),

this_year_aov AS (
	SELECT 
	date,
	client,
	'This year AOV' as metric,
	case when sum(order_count) > 0 then sum(revenue)/sum(order_count) else 0 end as value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365`
	group by date, client
),

this_year_frequency AS (
	SELECT 
	date,
	client,
	'This year frequency' as metric,
	case when count(distinct customer_id) > 0 then sum(order_count)/count(distinct customer_id) else 0 end as value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365`
	group by date, client
)

SELECT 
date,
client,
metric,
ifnull(value, 0) value
FROM
(
	SELECT
	date,
	client,
	metric,
	value
	FROM last_year_buyers

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM rebuy_rate

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM repeat_buyers

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM reactivated_buyers	

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM new_buyers	

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_year_buyers	

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_year_revenue

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_year_aov

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_year_frequency

	UNION ALL

	SELECT
	a.date,
	a.client,
	'Dormant buyers' as metric,
	a.value - ifnull(b.value, 0) as value
	FROM last_year_buyers a
	LEFT JOIN repeat_buyers b
	ON ( a.date = b.date AND
		a.client = b.client )							

)
2018-04-18 10:06:23,872: Model SQL (growth_stats):
with orders as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'Orders' as metric,
  orders_ty as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`
),

order_growth as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'Order Growth' as metric,
  order_growth as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`
),

revenue as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'Revenue' as metric,
  revenue_ty as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`
),

revenue_growth as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'Revenue Growth' as metric,
  revenue_growth as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`
),

customers as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'Customers' as metric,
  customers_ty as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`
),

customer_growth as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'Customer Growth' as metric,
  customer_growth as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`

),

aov as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'AOV' as metric,
  aov_ty as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`

),

aov_growth as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'AOV Growth' as metric,
  aov_growth as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`

)

SELECT * FROM orders
UNION ALL 
SELECT * FROM order_growth
UNION ALL
SELECT * FROM revenue
UNION ALL 
SELECT * FROM revenue_growth
UNION ALL
SELECT * FROM customers
UNION ALL 
SELECT * FROM customer_growth
UNION ALL
SELECT * FROM aov
UNION ALL 
SELECT * FROM aov_growth
2018-04-18 10:06:24,973: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e1b400>]}
2018-04-18 10:06:25,310: 10:06:25 | 88 of 91 OK created table model agency_data_pipeline.growth_stats.... [CREATE TABLE in 2.08s]
2018-04-18 10:06:26,118: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1018f9e10>]}
2018-04-18 10:06:26,403: 10:06:26 | 89 of 91 OK created table model agency_data_pipeline.retention_stats_month [CREATE TABLE in 3.20s]
2018-04-18 10:06:33,773: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10188eb00>]}
2018-04-18 10:06:34,032: 10:06:34 | 87 of 91 OK created table model agency_data_pipeline.retention_stats. [CREATE TABLE in 10.89s]
2018-04-18 10:06:34,033: 10:06:34 | 90 of 91 START table model agency_data_pipeline.agg_campaign......... [RUN]
2018-04-18 10:06:34,033: Compiling model.agency_data_pipeline.agg_campaign
2018-04-18 10:06:34,039: Writing injected SQL for node "model.agency_data_pipeline.agg_campaign"
2018-04-18 10:06:34,042: Acquiring new bigquery connection "agg_campaign".
2018-04-18 10:06:34,042: Re-using an available connection from the pool.
2018-04-18 10:06:35,015: Model SQL (agg_campaign):
with ga as (

	select 
		date, client, attribution, channel, platform, url, campaign as utm_campaign, '' as campaign,
    	customers_new,
    	transactions_new,
    	revenue_new,
    	first_order_revenue_new,
    	lifetime_revenue_new,
    	customers_total,
    	transactions_total,
    	revenue_total,
		null as cost, null as impressions, null as clicks, null as ad_platform_transactions
	from `growth-engines-pipeline`.`agency_data_pipeline`.`agg_ga_campaign_by_type`

),

platforms_last_touch as (

	select 
		date, client, 'Last-touch' as attribution, channel, platform, url, utm_campaign, campaign,
		null as customers_new,
    	null as transactions_new,
    	null as revenue_new,
    	null as first_order_revenue_new,
    	null as lifetime_revenue_new,
    	null as customers_total,
    	null as transactions_total,
    	null as revenue_total,
		cost, impressions, clicks, ad_platform_transactions
	from `growth-engines-pipeline`.`agency_data_pipeline`.`agg_platforms_client`

),

platforms_first_touch as (

    select 
        date, client, 'First-touch' as attribution, channel, platform, url, utm_campaign, campaign,
        null as customers_new,
        null as transactions_new,
        null as revenue_new,
        null as first_order_revenue_new,
        null as lifetime_revenue_new,
        null as customers_total,
        null as transactions_total,
        null as revenue_total,
        cost, impressions, clicks, ad_platform_transactions
    from `growth-engines-pipeline`.`agency_data_pipeline`.`agg_platforms_client`

)


SELECT
    date, 
    client,
    attribution,
    platform,
    channel, 
    url,
    utm_campaign,
    max(campaign) campaign,
    ifnull( sum(cost), 0) cost,
	ifnull( sum(impressions), 0) impressions,
	ifnull( sum(clicks), 0) clicks,
	ifnull( sum(ad_platform_transactions), 0) ad_platform_transactions,
	ifnull( sum(customers_new), 0) customers_new,
	ifnull( sum(transactions_new), 0) transactions_new,
	ifnull( sum(revenue_new), 0) revenue_new,
	ifnull( sum(first_order_revenue_new), 0) first_order_revenue_new,
	ifnull( sum(lifetime_revenue_new), 0) lifetime_revenue_new,
	ifnull( sum(customers_total), 0) customers_total,
	ifnull( sum(transactions_total), 0) transactions_total,
	ifnull( sum(revenue_total), 0) revenue_total	
FROM 
(
    SELECT *
    FROM 
      ga
    UNION ALL
    SELECT *
    FROM 
      platforms_first_touch
    UNION ALL
    SELECT *
    FROM 
      platforms_last_touch      
) 
GROUP BY
    date, client, attribution, platform, channel, url, utm_campaign
2018-04-18 10:06:41,886: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x101870f60>]}
2018-04-18 10:06:42,538: 10:06:42 | 90 of 91 OK created table model agency_data_pipeline.agg_campaign.... [CREATE TABLE in 7.85s]
2018-04-18 10:06:42,539: 10:06:42 | 91 of 91 START table model agency_data_pipeline.agg_platform_monthly. [RUN]
2018-04-18 10:06:42,539: Compiling model.agency_data_pipeline.agg_platform_monthly
2018-04-18 10:06:42,545: Writing injected SQL for node "model.agency_data_pipeline.agg_platform_monthly"
2018-04-18 10:06:42,546: Acquiring new bigquery connection "agg_platform_monthly".
2018-04-18 10:06:42,546: Re-using an available connection from the pool.
2018-04-18 10:06:43,435: Model SQL (agg_platform_monthly):
SELECT
    FORMAT_DATE("%Y-%m", date) AS yyyymm,
    client,
    attribution,
    platform,
    channel, 
    sum(cost) cost,
	sum(clicks) clicks,
	sum(customers_new) customers_new,
	sum(first_order_revenue_new) first_order_revenue_new,
	sum(lifetime_revenue_new) lifetime_revenue_new,
	sum(transactions_new) transactions_new,
	sum(revenue_new) revenue_new,
    sum(customers_total) customers_total,
    sum(transactions_total) transactions_total,
    sum(revenue_total) revenue_total
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_campaign`
GROUP BY
    yyyymm, client, attribution, platform, channel
2018-04-18 10:06:45,622: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '169c46a7-c51c-4d07-834c-a4ada61ce9f9', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104e22d30>]}
2018-04-18 10:06:45,884: 10:06:45 | 91 of 91 OK created table model agency_data_pipeline.agg_platform_monthly [CREATE TABLE in 3.08s]
2018-04-18 10:06:45,894: 10:06:45 | 
2018-04-18 10:06:45,895: 10:06:45 | Finished running 91 table models in 443.63s.
2018-04-18 10:06:45,895: Connection 'master' was left open.
2018-04-18 10:06:45,896: 
2018-04-18 10:06:45,896: Completed with 1 errors:
2018-04-18 10:06:45,896: 
2018-04-18 10:06:45,896: Database Error in model frequency_stats (models/segmentation/frequency/frequency_stats.sql)
2018-04-18 10:06:45,897:   SELECT list expression references column customer_id which is neither grouped nor aggregated at [22:24]
2018-04-18 10:06:45,897:   compiled SQL at target/compiled/agency_data_pipeline/segmentation/frequency/frequency_stats.sql
2018-04-18 10:06:45,897: 
Done. PASS=90 ERROR=1 SKIP=0 TOTAL=91
2018-04-18 10:06:45,898: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104d50710>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104d1da90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104d1dcc0>]}
2018-04-18 10:06:46,201: Flushing usage events
2018-04-18 10:09:35,620: Tracking: tracking
2018-04-18 10:09:35,624: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a8b7f60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a8b7e80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a8b7dd8>]}
2018-04-18 10:09:36,483: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-04-18 10:09:36,507: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/growth-engines/dbt_modules
2018-04-18 10:09:36,513: Parsing get_column_values.sql
2018-04-18 10:09:36,531: Parsing get_url_parameter.sql
2018-04-18 10:09:36,538: Parsing split_part.sql
2018-04-18 10:09:36,547: Parsing table_exists.sql
2018-04-18 10:09:36,558: Parsing core.sql
2018-04-18 10:09:36,573: Parsing adapters/bigquery.sql
2018-04-18 10:09:36,586: Parsing adapters/common.sql
2018-04-18 10:09:36,607: Parsing adapters/postgres.sql
2018-04-18 10:09:36,613: Parsing adapters/redshift.sql
2018-04-18 10:09:36,633: Parsing etc/get_custom_schema.sql
2018-04-18 10:09:36,641: Parsing materializations/archive.sql
2018-04-18 10:09:36,675: Parsing materializations/bigquery.sql
2018-04-18 10:09:36,704: Parsing materializations/helpers.sql
2018-04-18 10:09:36,726: Parsing materializations/incremental.sql
2018-04-18 10:09:36,758: Parsing materializations/table.sql
2018-04-18 10:09:36,780: Parsing materializations/view.sql
2018-04-18 10:09:36,798: Parsing materializations/wrapper.sql
2018-04-18 10:09:36,804: Parsing schema_tests/accepted_values.sql
2018-04-18 10:09:36,813: Parsing schema_tests/not_null.sql
2018-04-18 10:09:36,819: Parsing schema_tests/relationships.sql
2018-04-18 10:09:36,826: Parsing schema_tests/unique.sql
2018-04-18 10:09:36,971: Parsing model.agency_data_pipeline.accounts_proc
2018-04-18 10:09:36,973: Parsing model.agency_data_pipeline.all_dates
2018-04-18 10:09:36,974: Parsing model.agency_data_pipeline.carts_proc
2018-04-18 10:09:36,976: Parsing model.agency_data_pipeline.clients_proc
2018-04-18 10:09:36,978: Parsing model.agency_data_pipeline.cogs_proc
2018-04-18 10:09:36,980: Parsing model.agency_data_pipeline.conversion_goals_proc
2018-04-18 10:09:36,981: Parsing model.agency_data_pipeline.mappings_ga_proc
2018-04-18 10:09:36,984: Acquiring new bigquery connection "master".
2018-04-18 10:09:36,984: Opening a new connection (0 currently allocated)
2018-04-18 10:09:36,988: Parsing model.agency_data_pipeline.monthend_dates
2018-04-18 10:09:36,990: Parsing model.agency_data_pipeline.adwords_ads
2018-04-18 10:09:36,992: Parsing model.agency_data_pipeline.adwords_campaigns
2018-04-18 10:09:36,993: Parsing model.agency_data_pipeline.adwords_conversions
2018-04-18 10:09:36,995: Parsing model.agency_data_pipeline.adwords_impression_share
2018-04-18 10:09:36,997: Parsing model.agency_data_pipeline.adwords_join
2018-04-18 10:09:37,000: Parsing model.agency_data_pipeline.adwords_stats
2018-04-18 10:09:37,001: Parsing model.agency_data_pipeline.adwords_urls
2018-04-18 10:09:37,003: Parsing model.agency_data_pipeline.bing_ads_ads
2018-04-18 10:09:37,006: Parsing model.agency_data_pipeline.bing_ads_conversions
2018-04-18 10:09:37,008: Parsing model.agency_data_pipeline.bing_ads_impression_share
2018-04-18 10:09:37,009: Parsing model.agency_data_pipeline.bing_ads_stats
2018-04-18 10:09:37,011: Parsing model.agency_data_pipeline.fb_adcreative
2018-04-18 10:09:37,017: Parsing model.agency_data_pipeline.fb_ads
2018-04-18 10:09:37,024: Parsing model.agency_data_pipeline.fb_ads_insights
2018-04-18 10:09:37,033: Parsing model.agency_data_pipeline.fb_ads_insights_conversions
2018-04-18 10:09:37,038: Parsing model.agency_data_pipeline.fb_ads_stats
2018-04-18 10:09:37,041: Parsing model.agency_data_pipeline.ga_conversions
2018-04-18 10:09:37,043: Parsing model.agency_data_pipeline.ga_traffic
2018-04-18 10:09:37,055: Parsing model.agency_data_pipeline.ga_transactions
2018-04-18 10:09:37,065: Parsing model.agency_data_pipeline.ga_mcf_proc
2018-04-18 10:09:37,067: Parsing model.agency_data_pipeline.ga_mcf_stats
2018-04-18 10:09:37,070: Parsing model.agency_data_pipeline.shopify_customers_proc
2018-04-18 10:09:37,077: Parsing model.agency_data_pipeline.shopify_orders_proc
2018-04-18 10:09:37,085: Parsing model.agency_data_pipeline.shopify_products_proc
2018-04-18 10:09:37,097: Parsing model.agency_data_pipeline.shopify_refunds_proc
2018-04-18 10:09:37,102: Parsing model.agency_data_pipeline.agg_campaign
2018-04-18 10:09:37,105: Parsing model.agency_data_pipeline.agg_customers_union
2018-04-18 10:09:37,107: Parsing model.agency_data_pipeline.agg_ga_campaign
2018-04-18 10:09:37,110: Parsing model.agency_data_pipeline.agg_ga_campaign_by_type
2018-04-18 10:09:37,112: Parsing model.agency_data_pipeline.agg_ga_transaction
2018-04-18 10:09:37,116: Parsing model.agency_data_pipeline.agg_ga_transaction_order_number
2018-04-18 10:09:37,120: Parsing model.agency_data_pipeline.agg_orders_union
2018-04-18 10:09:37,122: Parsing model.agency_data_pipeline.agg_platform_monthly
2018-04-18 10:09:37,124: Parsing model.agency_data_pipeline.agg_platforms_client
2018-04-18 10:09:37,126: Parsing model.agency_data_pipeline.agg_platforms_union
2018-04-18 10:09:37,128: Parsing model.agency_data_pipeline.agg_products
2018-04-18 10:09:37,130: Parsing model.agency_data_pipeline.agg_transaction
2018-04-18 10:09:37,132: Parsing model.agency_data_pipeline.agg_transaction_daily
2018-04-18 10:09:37,134: Parsing model.agency_data_pipeline.agg_transaction_line_item
2018-04-18 10:09:37,136: Parsing model.agency_data_pipeline.agg_transaction_line_item_type
2018-04-18 10:09:37,138: Parsing model.agency_data_pipeline.agg_transaction_order_number
2018-04-18 10:09:37,139: Parsing model.agency_data_pipeline.agg_transaction_product_type
2018-04-18 10:09:37,141: Parsing model.agency_data_pipeline.customers_by_transaction
2018-04-18 10:09:37,143: Parsing model.agency_data_pipeline.growth_customer_0_365
2018-04-18 10:09:37,145: Parsing model.agency_data_pipeline.growth_customer_0_365_segment
2018-04-18 10:09:37,148: Parsing model.agency_data_pipeline.growth_date_union
2018-04-18 10:09:37,150: Parsing model.agency_data_pipeline.growth_stats
2018-04-18 10:09:37,155: Parsing model.agency_data_pipeline.retention_0_365
2018-04-18 10:09:37,157: Parsing model.agency_data_pipeline.retention_0_365_new
2018-04-18 10:09:37,160: Parsing model.agency_data_pipeline.retention_0_365_reactivated
2018-04-18 10:09:37,163: Parsing model.agency_data_pipeline.retention_0_365_rebuy
2018-04-18 10:09:37,165: Parsing model.agency_data_pipeline.retention_365_730
2018-04-18 10:09:37,167: Parsing model.agency_data_pipeline.retention_730_plus
2018-04-18 10:09:37,169: Parsing model.agency_data_pipeline.retention_stats
2018-04-18 10:09:37,174: Parsing model.agency_data_pipeline.retention_stats_rebuy_rate
2018-04-18 10:09:37,176: Parsing model.agency_data_pipeline.retention_0_30
2018-04-18 10:09:37,179: Parsing model.agency_data_pipeline.retention_0_30_new
2018-04-18 10:09:37,184: Parsing model.agency_data_pipeline.retention_0_30_reactivated
2018-04-18 10:09:37,187: Parsing model.agency_data_pipeline.retention_0_30_rebuy
2018-04-18 10:09:37,189: Parsing model.agency_data_pipeline.retention_30_60
2018-04-18 10:09:37,191: Parsing model.agency_data_pipeline.retention_60_plus
2018-04-18 10:09:37,193: Parsing model.agency_data_pipeline.retention_stats_month
2018-04-18 10:09:37,198: Parsing model.agency_data_pipeline.retention_stats_rebuy_rate_month
2018-04-18 10:09:37,201: Parsing model.agency_data_pipeline.customers_first_purchase_proc
2018-04-18 10:09:37,202: Parsing model.agency_data_pipeline.customers_proc
2018-04-18 10:09:37,205: Parsing model.agency_data_pipeline.segment_list_customers
2018-04-18 10:09:37,207: Parsing model.agency_data_pipeline.segment_proc_customers
2018-04-18 10:09:37,209: Parsing model.agency_data_pipeline.segment_stats_customers
2018-04-18 10:09:37,211: Parsing model.agency_data_pipeline.segment_stats_customers_agg
2018-04-18 10:09:37,214: Parsing model.agency_data_pipeline.customers_first_purchase_product_type_proc
2018-04-18 10:09:37,216: Parsing model.agency_data_pipeline.customers_products_proc
2018-04-18 10:09:37,219: Parsing model.agency_data_pipeline.segment_list_customers_products
2018-04-18 10:09:37,221: Parsing model.agency_data_pipeline.segment_proc_customers_products
2018-04-18 10:09:37,224: Parsing model.agency_data_pipeline.segment_stats_customers_products
2018-04-18 10:09:37,225: Parsing model.agency_data_pipeline.segment_stats_customers_products_agg
2018-04-18 10:09:37,228: Parsing model.agency_data_pipeline.frequency_proc
2018-04-18 10:09:37,231: Parsing model.agency_data_pipeline.frequency_stats
2018-04-18 10:09:37,233: Parsing model.agency_data_pipeline.order_paths_agg
2018-04-18 10:09:37,234: Parsing model.agency_data_pipeline.order_paths_proc
2018-04-18 10:09:37,236: Parsing model.agency_data_pipeline.order_paths_stats
2018-04-18 10:09:37,239: Parsing model.agency_data_pipeline.products_proc
2018-04-18 10:09:37,241: Parsing model.agency_data_pipeline.segment_proc_sku
2018-04-18 10:09:37,243: Parsing model.agency_data_pipeline.segment_stats_category
2018-04-18 10:09:37,245: Parsing model.agency_data_pipeline.segment_stats_sku
2018-04-18 10:09:37,273: Found 92 models, 0 tests, 0 archives, 0 analyses, 46 macros, 0 operations
2018-04-18 10:09:37,337: 
2018-04-18 10:09:38,828: 10:09:38 | Concurrency: 4 threads (target='prod')
2018-04-18 10:09:38,829: 10:09:38 | 
2018-04-18 10:09:40,417: 10:09:40 | 1 of 92 START table model agency_data_pipeline.cogs_proc............. [RUN]
2018-04-18 10:09:40,418: Compiling model.agency_data_pipeline.cogs_proc
2018-04-18 10:09:40,417: 10:09:40 | 2 of 92 START table model agency_data_pipeline.bing_ads_ads.......... [RUN]
2018-04-18 10:09:40,426: Writing injected SQL for node "model.agency_data_pipeline.cogs_proc"
2018-04-18 10:09:40,418: 10:09:40 | 3 of 92 START table model agency_data_pipeline.all_dates............. [RUN]
2018-04-18 10:09:40,426: Compiling model.agency_data_pipeline.bing_ads_ads
2018-04-18 10:09:40,418: 10:09:40 | 4 of 92 START table model agency_data_pipeline.adwords_urls.......... [RUN]
2018-04-18 10:09:40,427: Compiling model.agency_data_pipeline.all_dates
2018-04-18 10:09:40,439: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_ads"
2018-04-18 10:09:40,440: Compiling model.agency_data_pipeline.adwords_urls
2018-04-18 10:09:40,441: Acquiring new bigquery connection "cogs_proc".
2018-04-18 10:09:40,449: Writing injected SQL for node "model.agency_data_pipeline.all_dates"
2018-04-18 10:09:40,457: Writing injected SQL for node "model.agency_data_pipeline.adwords_urls"
2018-04-18 10:09:40,457: Opening a new connection (1 currently allocated)
2018-04-18 10:09:40,458: Acquiring new bigquery connection "bing_ads_ads".
2018-04-18 10:09:40,463: Acquiring new bigquery connection "adwords_urls".
2018-04-18 10:09:40,466: Acquiring new bigquery connection "all_dates".
2018-04-18 10:09:40,467: Opening a new connection (2 currently allocated)
2018-04-18 10:09:40,469: Opening a new connection (3 currently allocated)
2018-04-18 10:09:40,601: Opening a new connection (4 currently allocated)
2018-04-18 10:09:41,642: Model SQL (cogs_proc):
select 
client,
sku,
cogs_dol,
cogs_pct,
from  ( 

SELECT  
client,
sku,
cogs_dol,
cogs_pct,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.cogs`
where client_name != ''
) 

WHERE lv = time_of_entry
2018-04-18 10:09:41,642: Bad request while running:
select 
client,
sku,
cogs_dol,
cogs_pct,
from  ( 

SELECT  
client,
sku,
cogs_dol,
cogs_pct,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.cogs`
where client_name != ''
) 

WHERE lv = time_of_entry
2018-04-18 10:09:41,642: 400 Syntax error: Trailing comma before the FROM clause is not allowed at [6:1]
2018-04-18 10:09:41,643: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1074f0860>]}
2018-04-18 10:09:41,858: Model SQL (all_dates):
SELECT 
date_in_range,
unix_date(date_in_range) unix_date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-04-18 10:09:41,864: Model SQL (adwords_urls):
SELECT
campaignid,
lower(trim(regexp_replace(replace(replace(replace(replace(finalurl,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url

FROM (

SELECT  
campaignid,
finalurl,
first_value(finalurl) OVER (PARTITION BY campaignid ORDER BY day DESC) lv
FROM `growth-engines-pipeline.adwords_2.FINAL_URL_REPORT`
)

WHERE lv = finalurl
group by campaignid, url
order by campaignid asc
2018-04-18 10:09:41,887: 10:09:41 | 1 of 92 ERROR creating table model agency_data_pipeline.cogs_proc.... [ERROR in 1.22s]
2018-04-18 10:09:41,887: 10:09:41 | 5 of 92 START table model agency_data_pipeline.bing_ads_impression_share [RUN]
2018-04-18 10:09:41,888: Compiling model.agency_data_pipeline.bing_ads_impression_share
2018-04-18 10:09:41,896: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_impression_share"
2018-04-18 10:09:41,897: Acquiring new bigquery connection "bing_ads_impression_share".
2018-04-18 10:09:41,897: Re-using an available connection from the pool.
2018-04-18 10:09:41,929: Model SQL (bing_ads_ads):
select
date, 
account, 
channel,
platform,
campaignid,
campaignname,
max(lower(trim(replace(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$','' ),'.html',''),'/'))) as url,
utm_campaign,
sum(cost) as cost,
sum(impressions) as impressions,
sum(clicks) as clicks,
sum(conversions) as conversions
from 
  ( 
SELECT  
cast(gregoriandate as date) date,
replace(accountname,',','') account,
'Paid' as channel,
'Bing Ads' as platform,
adid,
adtype,
campaignid, 
campaignname,
finalurl url,
case when regexp_contains(destinationurl, 'utm_campaign')
	then replace(lower(nullif(
  

    split(
        
  

    split(
        destinationurl,
        'utm_campaign='
        )[offset(1)]


,
        '&'
        )[offset(0)]


,'')),'+',' ') 
	else null end as utm_campaign,
spend cost, 
impressions, 
clicks, 
conversions,
_sdc_sequence,
first_value(_sdc_sequence) OVER (PARTITION BY adid, gregoriandate ORDER BY _sdc_sequence DESC) lv
FROM `growth-engines-pipeline.bing_ads.ad_performance_report` 
  )

where lv = _sdc_sequence
group by date, account, channel, platform, campaignid, campaignname, utm_campaign
2018-04-18 10:09:42,633: Model SQL (bing_ads_impression_share):
SELECT 
date, 
account,
channel,
platform,
sum(impressions) impressions,
sum(available_impressions) available_impressions
FROM

(

SELECT  
cast(gregoriandate as date) date,
replace(accountname,',','') account,  
'Paid' as channel,
'Bing Ads' as platform,
case when impressionsharepercent is null then 0 else impressions end as impressions,
cast(round(case when ( impressionsharepercent is not null and impressionsharepercent > 0 ) then (impressions*100)/impressionsharepercent else 0 end) as int64) as available_impressions,
_sdc_sequence,
first_value(_sdc_sequence) OVER (PARTITION BY campaignid, gregoriandate ORDER BY _sdc_sequence DESC) lv
FROM `growth-engines-pipeline.bing_ads.campaign_performance_report` 

)

where lv = _sdc_sequence
group by date, account, channel, platform
2018-04-18 10:09:42,966: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10aa55cc0>]}
2018-04-18 10:09:43,237: 10:09:43 | 3 of 92 OK created table model agency_data_pipeline.all_dates........ [CREATE TABLE in 2.54s]
2018-04-18 10:09:43,238: 10:09:43 | 6 of 92 START table model agency_data_pipeline.carts_proc............ [RUN]
2018-04-18 10:09:43,238: Compiling model.agency_data_pipeline.carts_proc
2018-04-18 10:09:43,246: Writing injected SQL for node "model.agency_data_pipeline.carts_proc"
2018-04-18 10:09:43,247: Acquiring new bigquery connection "carts_proc".
2018-04-18 10:09:43,247: Re-using an available connection from the pool.
2018-04-18 10:09:43,844: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a96aeb8>]}
2018-04-18 10:09:44,080: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1074b3be0>]}
2018-04-18 10:09:44,147: 10:09:44 | 5 of 92 OK created table model agency_data_pipeline.bing_ads_impression_share [CREATE TABLE in 1.96s]
2018-04-18 10:09:44,149: 10:09:44 | 7 of 92 START table model agency_data_pipeline.monthend_dates........ [RUN]
2018-04-18 10:09:44,150: Compiling model.agency_data_pipeline.monthend_dates
2018-04-18 10:09:44,160: Writing injected SQL for node "model.agency_data_pipeline.monthend_dates"
2018-04-18 10:09:44,163: Acquiring new bigquery connection "monthend_dates".
2018-04-18 10:09:44,163: Re-using an available connection from the pool.
2018-04-18 10:09:44,201: Model SQL (carts_proc):
select 
client,
client_name,
account,
platform
from  ( 

SELECT  
client,
client_name,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.accounts`
WHERE platform in ('Shopify', 'Custom cart')

) 

WHERE lv = time_of_entry
2018-04-18 10:09:44,402: 10:09:44 | 4 of 92 OK created table model agency_data_pipeline.adwords_urls..... [CREATE TABLE in 3.64s]
2018-04-18 10:09:44,403: 10:09:44 | 8 of 92 START table model agency_data_pipeline.accounts_proc......... [RUN]
2018-04-18 10:09:44,403: Compiling model.agency_data_pipeline.accounts_proc
2018-04-18 10:09:44,410: Writing injected SQL for node "model.agency_data_pipeline.accounts_proc"
2018-04-18 10:09:44,411: Acquiring new bigquery connection "accounts_proc".
2018-04-18 10:09:44,411: Re-using an available connection from the pool.
2018-04-18 10:09:45,042: Model SQL (monthend_dates):
SELECT
date_in_range,
date_in_range_bom,
date_in_range_bom_mom,
unix_date_in_range,
unix_date_in_range_bom,
unix_date(date_in_range_bom_mom) unix_date_in_range_bom_mom,
yyyymm,
date_in_range_yoy,
unix_date(date_in_range_yoy) unix_date_in_range_yoy

FROM
(
	SELECT 
	date_in_range,
	date_in_range_bom,
	date_sub(date_in_range_bom, INTERVAL 1 MONTH) date_in_range_bom_mom,
  date_sub(date_in_range, INTERVAL 1 YEAR) date_in_range_yoy,
	unix_date_in_range,
	unix_date(date_in_range_bom) unix_date_in_range_bom,
	yyyymm,
	first_value(date_in_range) over (partition by yyyymm order by date_in_range desc) monthend_date_in_range
	FROM
	( 
		SELECT 
		date_in_range,
		date_trunc( date_in_range, MONTH) date_in_range_bom,
		unix_date(date_in_range) unix_date_in_range,
		format_date("%Y-%m", date_in_range) AS yyyymm
		FROM UNNEST(
		    GENERATE_DATE_ARRAY(DATE('2016-01-31'), CURRENT_DATE(), INTERVAL 1 DAY)
		) AS date_in_range
	)
)
where date_in_range = monthend_date_in_range
2018-04-18 10:09:45,229: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10aa558d0>]}
2018-04-18 10:09:45,291: Model SQL (accounts_proc):
select 
client,
account,
platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.accounts` 

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-04-18 10:09:45,293: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1074b3f60>]}
2018-04-18 10:09:45,468: 10:09:45 | 2 of 92 OK created table model agency_data_pipeline.bing_ads_ads..... [CREATE TABLE in 4.80s]
2018-04-18 10:09:45,470: 10:09:45 | 9 of 92 START table model agency_data_pipeline.adwords_campaigns..... [RUN]
2018-04-18 10:09:45,472: Compiling model.agency_data_pipeline.adwords_campaigns
2018-04-18 10:09:45,481: Writing injected SQL for node "model.agency_data_pipeline.adwords_campaigns"
2018-04-18 10:09:45,482: Acquiring new bigquery connection "adwords_campaigns".
2018-04-18 10:09:45,482: Re-using an available connection from the pool.
2018-04-18 10:09:45,743: 10:09:45 | 6 of 92 OK created table model agency_data_pipeline.carts_proc....... [CREATE TABLE in 2.05s]
2018-04-18 10:09:45,744: 10:09:45 | 10 of 92 START table model agency_data_pipeline.conversion_goals_proc [RUN]
2018-04-18 10:09:45,744: Compiling model.agency_data_pipeline.conversion_goals_proc
2018-04-18 10:09:45,753: Writing injected SQL for node "model.agency_data_pipeline.conversion_goals_proc"
2018-04-18 10:09:45,754: Acquiring new bigquery connection "conversion_goals_proc".
2018-04-18 10:09:45,754: Re-using an available connection from the pool.
2018-04-18 10:09:46,205: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a96aeb8>]}
2018-04-18 10:09:46,518: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1074b3be0>]}
2018-04-18 10:09:46,524: 10:09:46 | 7 of 92 OK created table model agency_data_pipeline.monthend_dates... [CREATE TABLE in 2.06s]
2018-04-18 10:09:46,525: 10:09:46 | 11 of 92 START table model agency_data_pipeline.adwords_conversions.. [RUN]
2018-04-18 10:09:46,525: Compiling model.agency_data_pipeline.adwords_conversions
2018-04-18 10:09:46,534: Writing injected SQL for node "model.agency_data_pipeline.adwords_conversions"
2018-04-18 10:09:46,539: Acquiring new bigquery connection "adwords_conversions".
2018-04-18 10:09:46,540: Re-using an available connection from the pool.
2018-04-18 10:09:46,727: Model SQL (adwords_campaigns):
select
day,
campaignid, 
campaign,
account, 
channel,
platform,
sum(cost) cost,
sum(impressions) impressions,
sum(clicks) clicks,
sum(impression_share_num) impression_share_num,
sum(impression_share_den) impression_share_den
from 
  ( 
	SELECT  
	day,
	campaignid,
	campaign,
	account as account,
	'Paid' as channel,
	'Adwords' as platform,
	cost/1000000 cost, 
	impressions as impressions, 
	clicks, 
	case when searchimprshare is not null then impressions end as impression_share_num,
	case when searchimprshare is not null then impressions/(searchimprshare/100) end as impression_share_den,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY campaignid, day ORDER BY _sdc_sequence DESC) lv
	FROM `growth-engines-pipeline.adwords_2.CAMPAIGN_PERFORMANCE_REPORT`
  )
where lv = _sdc_sequence
group by day, campaignid, account, channel, platform, campaign
2018-04-18 10:09:46,813: 10:09:46 | 8 of 92 OK created table model agency_data_pipeline.accounts_proc.... [CREATE TABLE in 2.11s]
2018-04-18 10:09:46,814: 10:09:46 | 12 of 92 START table model agency_data_pipeline.clients_proc......... [RUN]
2018-04-18 10:09:46,815: Compiling model.agency_data_pipeline.clients_proc
2018-04-18 10:09:46,822: Writing injected SQL for node "model.agency_data_pipeline.clients_proc"
2018-04-18 10:09:46,824: Acquiring new bigquery connection "clients_proc".
2018-04-18 10:09:46,824: Re-using an available connection from the pool.
2018-04-18 10:09:47,080: Model SQL (conversion_goals_proc):
select 
client,
platform,
goal_name,
max(goal_type) goal_type,
account,
max(time_of_entry) time_of_entry
from  ( 

SELECT  
client,
platform,
trim(replace(replace(lower(goal_name),',',''),' ','')) goal_name,
goal_type,
account,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY platform ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.conversion_goals` 

) 

WHERE lv = time_of_entry
group by client, platform, account, goal_name
2018-04-18 10:09:47,477: Model SQL (adwords_conversions):
select 
client,
client_name,
platform,
goal_name,
goal_type,
account,
time_of_entry
from  ( 

SELECT  
client,
client_name,
platform,
trim(lower(goal_name)) goal_name,
goal_type,
account,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform, goal_name ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.conversion_goals` 
WHERE platform = 'Adwords'

) 

WHERE lv = time_of_entry
2018-04-18 10:09:47,786: Model SQL (clients_proc):
select 
client,
client_name,
account,
platform
from  ( 

SELECT  
client,
client_name,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.accounts`
where client_name != ''
) 

WHERE lv = time_of_entry
2018-04-18 10:09:49,038: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a96aeb8>]}
2018-04-18 10:09:49,288: 10:09:49 | 11 of 92 OK created table model agency_data_pipeline.adwords_conversions [CREATE TABLE in 2.51s]
2018-04-18 10:09:49,288: 10:09:49 | 13 of 92 START table model agency_data_pipeline.ga_conversions....... [RUN]
2018-04-18 10:09:49,289: Compiling model.agency_data_pipeline.ga_conversions
2018-04-18 10:09:49,298: Writing injected SQL for node "model.agency_data_pipeline.ga_conversions"
2018-04-18 10:09:49,301: Acquiring new bigquery connection "ga_conversions".
2018-04-18 10:09:49,302: Re-using an available connection from the pool.
2018-04-18 10:09:49,324: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1074ddc50>]}
2018-04-18 10:09:49,605: 10:09:49 | 10 of 92 OK created table model agency_data_pipeline.conversion_goals_proc [CREATE TABLE in 3.58s]
2018-04-18 10:09:50,080: Model SQL (ga_conversions):
select 
client,
client_name,
platform,
goal_name,
goal_type,
account,
time_of_entry
from  ( 

SELECT  
client,
client_name,
platform,
trim(goal_name) goal_name,
goal_type,
account,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform, goal_name ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.conversion_goals` 
WHERE platform = 'Google Analytics'

) 

WHERE lv = time_of_entry
2018-04-18 10:09:50,096: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107516eb8>]}
2018-04-18 10:09:50,360: 10:09:50 | 12 of 92 OK created table model agency_data_pipeline.clients_proc.... [CREATE TABLE in 3.28s]
2018-04-18 10:09:51,183: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a96aeb8>]}
2018-04-18 10:09:51,334: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1074b3278>]}
2018-04-18 10:09:51,441: 10:09:51 | 13 of 92 OK created table model agency_data_pipeline.ga_conversions.. [CREATE TABLE in 1.89s]
2018-04-18 10:09:51,932: 10:09:51 | 9 of 92 OK created table model agency_data_pipeline.adwords_campaigns [CREATE TABLE in 5.86s]
2018-04-18 10:09:51,933: 10:09:51 | 14 of 92 START table model agency_data_pipeline.fb_ads_insights...... [RUN]
2018-04-18 10:09:51,934: Compiling model.agency_data_pipeline.fb_ads_insights
2018-04-18 10:09:51,943: Acquiring new bigquery connection "fb_ads_insights".
2018-04-18 10:09:51,943: Re-using an available connection from the pool.
2018-04-18 10:09:51,943: Fetching data for query fb_ads_insights:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 10:09:51,934: 10:09:51 | 15 of 92 START table model agency_data_pipeline.adwords_ads.......... [RUN]
2018-04-18 10:09:51,944: Compiling model.agency_data_pipeline.adwords_ads
2018-04-18 10:09:51,950: Writing injected SQL for node "model.agency_data_pipeline.adwords_ads"
2018-04-18 10:09:51,934: 10:09:51 | 16 of 92 START table model agency_data_pipeline.ga_mcf_proc.......... [RUN]
2018-04-18 10:09:51,952: Compiling model.agency_data_pipeline.ga_mcf_proc
2018-04-18 10:09:51,934: 10:09:51 | 17 of 92 START table model agency_data_pipeline.fb_adcreative........ [RUN]
2018-04-18 10:09:51,957: Writing injected SQL for node "model.agency_data_pipeline.ga_mcf_proc"
2018-04-18 10:09:51,958: Compiling model.agency_data_pipeline.fb_adcreative
2018-04-18 10:09:51,958: Acquiring new bigquery connection "adwords_ads".
2018-04-18 10:09:51,968: Re-using an available connection from the pool.
2018-04-18 10:09:51,968: Acquiring new bigquery connection "fb_adcreative".
2018-04-18 10:09:51,969: Re-using an available connection from the pool.
2018-04-18 10:09:51,970: Fetching data for query fb_adcreative:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 10:09:51,971: Acquiring new bigquery connection "ga_mcf_proc".
2018-04-18 10:09:51,972: Re-using an available connection from the pool.
2018-04-18 10:09:52,839: Model SQL (adwords_ads):
SELECT  
day,
campaignid,
a.account as account,
utm_campaign,
sum( case when b.goal_type = 'Transaction' then conversions else 0 end ) as transactions
FROM (

	SELECT  
	day,
	adid,
	campaignid,
	account,
	lower(conversionname) conversionname,
	conversions,
	lower(campaign) utm_campaign,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY campaignid, day ORDER BY _sdc_sequence DESC) lv
	FROM
	`growth-engines-pipeline.adwords_2.AD_PERFORMANCE_REPORT`

) a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_conversions` b
ON ( a.conversionname = b.goal_name
	AND a.account = b.account )
WHERE lv = _sdc_sequence
group by day, campaignid, account, utm_campaign
2018-04-18 10:09:52,929: Model SQL (ga_mcf_proc):
SELECT 
date,
account,
'Google Analytics' as lookup_platform,
source_medium_path,
trim(lower(split(split(source_medium_path,'->')[SAFE_ORDINAL(1)],'/')[SAFE_ORDINAL(1)])) as source,
trim(lower(split(split(source_medium_path,'->')[SAFE_ORDINAL(1)],'/')[SAFE_ORDINAL(2)])) as medium,
first_interaction_campaign campaign,
cast(regexp_replace(transaction_id, r'#', '') as int64) transactionid,
max(first_interaction_conversions) transactions,
max(first_interaction_conversion_value) revenue
FROM `growth-engines-pipeline.agency_data_pipeline.ga_mcf`
where account in (select account from `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc` where platform = 'Google Analytics')
group by date, account, source, medium, campaign, source_medium_path, lookup_platform, transactionid
2018-04-18 10:09:53,060: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_insights"
2018-04-18 10:09:53,276: Writing injected SQL for node "model.agency_data_pipeline.fb_adcreative"
2018-04-18 10:09:53,873: Model SQL (fb_ads_insights):




with fb_ads_insights as (

	    
		   	SELECT 
			date_start,
			campaign_id,
			campaign_name,
			ad_id,
			account_name,
			spend,
			reach,
			inline_link_clicks,
			_sdc_sequence,
			first_value(_sdc_sequence) OVER (PARTITION BY date_start, ad_id, campaign_id ORDER BY _sdc_sequence DESC) lv
			FROM `growth-engines-pipeline.fb_ads_luca_danni.ads_insights`
		    
	   

)

select
date_start date,
campaign_id,
campaign_name campaign,
ad_id,
account_name account,
max(spend) cost,
max(reach) impressions,
max(inline_link_clicks) clicks
from fb_ads_insights
where lv = _sdc_sequence
group by date, campaign_id, ad_id, account, campaign


2018-04-18 10:09:54,136: Model SQL (fb_adcreative):




with fb_adcreative as (


	    
		   	SELECT 
			id,
			object_url,
			url_tags,
			_sdc_sequence
			FROM `growth-engines-pipeline.fb_ads_luca_danni.adcreative`
		    
	   
)

select creative_id, max(url) url
from (
  select
  id creative_id,
  lower(trim(regexp_replace(replace(replace(replace(replace(object_url,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
  first_value(_sdc_sequence) OVER (PARTITION BY id ORDER BY _sdc_sequence DESC) lv,
  _sdc_sequence
  from fb_adcreative
  )
where lv = _sdc_sequence
group by creative_id


2018-04-18 10:09:55,051: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a98e390>]}
2018-04-18 10:09:55,325: 10:09:55 | 15 of 92 OK created table model agency_data_pipeline.adwords_ads..... [CREATE TABLE in 3.11s]
2018-04-18 10:09:55,326: 10:09:55 | 18 of 92 START table model agency_data_pipeline.bing_ads_conversions. [RUN]
2018-04-18 10:09:55,326: Compiling model.agency_data_pipeline.bing_ads_conversions
2018-04-18 10:09:55,335: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_conversions"
2018-04-18 10:09:55,336: Acquiring new bigquery connection "bing_ads_conversions".
2018-04-18 10:09:55,336: Re-using an available connection from the pool.
2018-04-18 10:09:56,332: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1074b0828>]}
2018-04-18 10:09:56,440: Model SQL (bing_ads_conversions):
SELECT
date, 
a.account account, 
a.channel channel,
a.platform platform,
campaignid,
campaignname,
sum( case when b.goal_type = 'Transactions' then conversions else 0 end ) as transactions
FROM

  ( 
SELECT  
cast(gregoriandate as date) date,
replace(accountname,',','') account,
'Paid' as channel,
'Bing Ads' as platform,
trim(replace(replace(lower(goal),',',''),' ','')) goal,
goalid,
campaignid,
campaignname,
conversions,
_sdc_sequence,
first_value(_sdc_sequence) OVER (PARTITION BY campaignid, goalid, gregoriandate ORDER BY _sdc_sequence DESC) lv
FROM `growth-engines-pipeline.bing_ads.goals_and_funnels_report` 

  ) a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`conversion_goals_proc` b
ON (
	a.account = b.account AND
	a.platform = b.platform AND
	a.goal = b.goal_name
)
where a.lv = a._sdc_sequence
group by date, account, channel, platform, campaignid, campaignname
2018-04-18 10:09:56,613: 10:09:56 | 17 of 92 OK created table model agency_data_pipeline.fb_adcreative... [CREATE TABLE in 4.37s]
2018-04-18 10:09:56,614: 10:09:56 | 19 of 92 START table model agency_data_pipeline.fb_ads_insights_conversions [RUN]
2018-04-18 10:09:56,614: Compiling model.agency_data_pipeline.fb_ads_insights_conversions
2018-04-18 10:09:56,626: Acquiring new bigquery connection "fb_ads_insights_conversions".
2018-04-18 10:09:56,626: Re-using an available connection from the pool.
2018-04-18 10:09:56,626: Fetching data for query fb_ads_insights_conversions:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 10:09:57,033: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_insights_conversions"
2018-04-18 10:09:57,181: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10aa6a2b0>]}
2018-04-18 10:09:57,338: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1074f0208>]}
2018-04-18 10:09:57,430: 10:09:57 | 14 of 92 OK created table model agency_data_pipeline.fb_ads_insights. [CREATE TABLE in 5.25s]
2018-04-18 10:09:57,434: 10:09:57 | 20 of 92 START table model agency_data_pipeline.mappings_ga_proc..... [RUN]
2018-04-18 10:09:57,436: Compiling model.agency_data_pipeline.mappings_ga_proc
2018-04-18 10:09:57,447: Writing injected SQL for node "model.agency_data_pipeline.mappings_ga_proc"
2018-04-18 10:09:57,449: Acquiring new bigquery connection "mappings_ga_proc".
2018-04-18 10:09:57,449: Re-using an available connection from the pool.
2018-04-18 10:09:57,706: 10:09:57 | 16 of 92 OK created table model agency_data_pipeline.ga_mcf_proc..... [CREATE TABLE in 5.39s]
2018-04-18 10:09:57,706: 10:09:57 | 21 of 92 START table model agency_data_pipeline.shopify_refunds_proc. [RUN]
2018-04-18 10:09:57,706: Compiling model.agency_data_pipeline.shopify_refunds_proc
2018-04-18 10:09:57,714: Acquiring new bigquery connection "shopify_refunds_proc".
2018-04-18 10:09:57,714: Re-using an available connection from the pool.
2018-04-18 10:09:57,714: Fetching data for query shopify_refunds_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 10:09:57,850: Model SQL (fb_ads_insights_conversions):




with fb_ads_insights_conversions as (

	    
		   	SELECT 
			date_start,
			campaign_id,
			campaign_name,
			ad_id,
			account_name,
			spend,
			reach,
			inline_link_clicks,
			_sdc_sequence,
			action_type,
			value
			FROM `growth-engines-pipeline.fb_ads_luca_danni.ads_insights`
			cross join unnest(actions)
		    
	   

)

SELECT * 
FROM 
	(
    SELECT
    date_start date,
    campaign_id,
    campaign_name campaign,
    ad_id,
    account_name account,
    action_type,
    value conversions,
    first_value(_sdc_sequence) OVER (PARTITION BY ad_id, date_start ORDER BY _sdc_sequence DESC) lv,
    _sdc_sequence
    FROM fb_ads_insights_conversions
   	)
where lv = _sdc_sequence
and action_type like '%purchase%'


2018-04-18 10:09:58,279: Model SQL (mappings_ga_proc):
select 
client,
account,
client_name,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
account,
client_name,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.mappings_ga` 

) 

WHERE lv = time_of_entry
and client in (select client from `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc` )
group by client, account, client_name, source, medium, platform_n, channel_n, time_of_entry
2018-04-18 10:09:58,644: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a98e390>]}
2018-04-18 10:09:58,901: 10:09:58 | 18 of 92 OK created table model agency_data_pipeline.bing_ads_conversions [CREATE TABLE in 3.32s]
2018-04-18 10:09:59,098: Writing injected SQL for node "model.agency_data_pipeline.shopify_refunds_proc"
2018-04-18 10:10:00,070: Model SQL (shopify_refunds_proc):




with refunds as (

	
	SELECT
	order_number,
	checkout_id,
	financial_status,
	line_item_id,
	quantity,
	subtotal,
	line_item.variant_id variant_id,
	line_item.id refund_id,
 	_sdc_sequence
	FROM `growth-engines-pipeline.shopify_lucadanni.orders` 
	cross join unnest(refunds), unnest(refund_line_items)
  	where financial_status like '%refund%'
	
	

)

SELECT * 
FROM 
	(
    SELECT
	order_number,
	checkout_id,
	financial_status,
	line_item_id,
	quantity,
	subtotal refund_amount,
	variant_id,
	refund_id,
 	_sdc_sequence,
    first_value(_sdc_sequence) OVER (PARTITION BY order_number, line_item_id ORDER BY _sdc_sequence DESC) lv
    FROM refunds
   	) 
WHERE lv = _sdc_sequence


2018-04-18 10:10:00,505: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10aa6a2b0>]}
2018-04-18 10:10:00,795: 10:10:00 | 20 of 92 OK created table model agency_data_pipeline.mappings_ga_proc [CREATE TABLE in 3.07s]
2018-04-18 10:10:02,275: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1074b0828>]}
2018-04-18 10:10:02,441: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1074b0dd8>]}
2018-04-18 10:10:02,533: 10:10:02 | 19 of 92 OK created table model agency_data_pipeline.fb_ads_insights_conversions [CREATE TABLE in 5.66s]
2018-04-18 10:10:02,957: 10:10:02 | 21 of 92 OK created table model agency_data_pipeline.shopify_refunds_proc [CREATE TABLE in 4.73s]
2018-04-18 10:10:02,958: 10:10:02 | 22 of 92 START table model agency_data_pipeline.shopify_customers_proc [RUN]
2018-04-18 10:10:02,958: Compiling model.agency_data_pipeline.shopify_customers_proc
2018-04-18 10:10:02,958: 10:10:02 | 23 of 92 START table model agency_data_pipeline.fb_ads............... [RUN]
2018-04-18 10:10:02,965: Compiling model.agency_data_pipeline.fb_ads
2018-04-18 10:10:02,973: Acquiring new bigquery connection "shopify_customers_proc".
2018-04-18 10:10:02,973: Re-using an available connection from the pool.
2018-04-18 10:10:02,973: Fetching data for query shopify_customers_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 10:10:02,975: Acquiring new bigquery connection "fb_ads".
2018-04-18 10:10:02,975: Re-using an available connection from the pool.
2018-04-18 10:10:02,976: Fetching data for query fb_ads:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 10:10:03,393: Writing injected SQL for node "model.agency_data_pipeline.shopify_customers_proc"
2018-04-18 10:10:03,430: Writing injected SQL for node "model.agency_data_pipeline.fb_ads"
2018-04-18 10:10:04,217: Model SQL (shopify_customers_proc):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc`





with customers as (

	
	SELECT
	'lucadanni' client_name,
	'Shopify' as lookup_platform,
	cast(created_at as date) created_at,
	id,
	first_name,
	last_name,
	email,
	_sdc_sequence,
	first_value(_sdc_sequence) over (partition by id, _sdc_sequence order by _sdc_sequence desc) lv
	FROM `growth-engines-pipeline.shopify_lucadanni.customers` 
	
	

)

SELECT
account,
client,
platform,
id,
min(created_at) created_at,
max(first_name) first_name,
max(last_name) last_name,
max(email) email
FROM (
	SELECT
	b.account,
	b.client,
	b.platform,
	created_at,
	id,
	first_name,
	last_name,
	email
	FROM customers a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
	ON ( a.client_name = b.client_name
	  AND a.lookup_platform = b.platform )
	where a.lv = a._sdc_sequence
)
group by account, client, platform, id

2018-04-18 10:10:04,245: Model SQL (fb_ads):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`fb_adcreative`





with fb_ads as (

	    
		   	SELECT 
			id ad_id,
			creative.creative_id creative_id,
			_sdc_sequence
			FROM `growth-engines-pipeline.fb_ads_luca_danni.ads`
		     
	   

)

SELECT
a.ad_id,
b.creative_id,
b.url
FROM (
    SELECT
    ad_id,
    creative_id,
    first_value(_sdc_sequence) OVER (PARTITION BY ad_id ORDER BY _sdc_sequence DESC) lv,
    _sdc_sequence
    FROM fb_ads
    ) a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`fb_adcreative` b
ON (
	a.creative_id = b.creative_id 
)
WHERE a.lv = a._sdc_sequence


2018-04-18 10:10:06,445: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1074b0dd8>]}
2018-04-18 10:10:06,723: 10:10:06 | 23 of 92 OK created table model agency_data_pipeline.fb_ads.......... [CREATE TABLE in 3.48s]
2018-04-18 10:10:08,627: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1074b3278>]}
2018-04-18 10:10:08,983: 10:10:08 | 22 of 92 OK created table model agency_data_pipeline.shopify_customers_proc [CREATE TABLE in 5.67s]
2018-04-18 10:10:08,984: 10:10:08 | 24 of 92 START table model agency_data_pipeline.agg_customers_union.. [RUN]
2018-04-18 10:10:08,985: 10:10:08 | 25 of 92 START table model agency_data_pipeline.bing_ads_stats....... [RUN]
2018-04-18 10:10:08,985: Compiling model.agency_data_pipeline.agg_customers_union
2018-04-18 10:10:08,985: 10:10:08 | 26 of 92 START table model agency_data_pipeline.shopify_products_proc [RUN]
2018-04-18 10:10:08,986: Compiling model.agency_data_pipeline.bing_ads_stats
2018-04-18 10:10:08,985: 10:10:08 | 27 of 92 START table model agency_data_pipeline.ga_mcf_stats......... [RUN]
2018-04-18 10:10:08,993: Compiling model.agency_data_pipeline.shopify_products_proc
2018-04-18 10:10:08,993: Writing injected SQL for node "model.agency_data_pipeline.agg_customers_union"
2018-04-18 10:10:09,004: Compiling model.agency_data_pipeline.ga_mcf_stats
2018-04-18 10:10:09,006: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_stats"
2018-04-18 10:10:09,022: Acquiring new bigquery connection "shopify_products_proc".
2018-04-18 10:10:09,031: Writing injected SQL for node "model.agency_data_pipeline.ga_mcf_stats"
2018-04-18 10:10:09,031: Re-using an available connection from the pool.
2018-04-18 10:10:09,032: Acquiring new bigquery connection "agg_customers_union".
2018-04-18 10:10:09,033: Re-using an available connection from the pool.
2018-04-18 10:10:09,033: Acquiring new bigquery connection "bing_ads_stats".
2018-04-18 10:10:09,033: Fetching data for query shopify_products_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 10:10:09,036: Re-using an available connection from the pool.
2018-04-18 10:10:09,037: Acquiring new bigquery connection "ga_mcf_stats".
2018-04-18 10:10:09,042: Re-using an available connection from the pool.
2018-04-18 10:10:09,360: Writing injected SQL for node "model.agency_data_pipeline.shopify_products_proc"
2018-04-18 10:10:10,111: Model SQL (bing_ads_stats):
select
a.date, 
a.account, 
a.channel,
a.platform,
url,
a.campaignname campaign,
utm_campaign,
cost,
clicks,
impressions,
transactions
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`bing_ads_ads` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`bing_ads_conversions` b
ON (
	a.date = b.date AND
	a.account = b.account AND
	a.campaignid = b.campaignid

)
2018-04-18 10:10:10,197: Model SQL (agg_customers_union):
SELECT *
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`shopify_customers_proc`
2018-04-18 10:10:10,233: Model SQL (ga_mcf_stats):
SELECT  
date,
a.account account,
b.client client,
case when c.platform is null then "Unmapped" else c.platform end as platform,
case when c.channel is null then "Unmapped" else c.channel end as channel,
lower(a.source) source,
lower(a.medium) medium,
lower(campaign) campaign,
transactionid,
sum(transactions) first_touch_transactions,
sum(revenue) first_touch_revenue
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`ga_mcf_proc` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc` b 
ON ( a.account = b.account and
	a.lookup_platform = b.platform )
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc` c
ON ( lower(a.source) = c.source
  AND lower(a.medium) = c.medium 
  and a.account = c.account )
group by date, account, client, source, medium, campaign, platform, channel, transactionid
2018-04-18 10:10:10,341: Model SQL (shopify_products_proc):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc`, `growth-engines-pipeline`.`agency_data_pipeline`.`shopify_refunds_proc`





with products as (

	
	SELECT
	'lucadanni' client_name,
	'Shopify' as lookup_platform,
	product_type,
	product_id,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY product_id ORDER BY _sdc_sequence DESC) lv
	FROM `growth-engines-pipeline.shopify_lucadanni.products` 
	cross join unnest(variants)
	
	

)

SELECT
b.account,
b.client,
b.platform,
max(product_type) product_type,
product_id
FROM products a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
ON ( a.client_name = b.client_name
  AND a.lookup_platform = b.platform )
where a.lv = a._sdc_sequence
group by product_id, account, client, platform


2018-04-18 10:10:12,321: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10aa6aa20>]}
2018-04-18 10:10:12,518: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107556208>]}
2018-04-18 10:10:12,581: 10:10:12 | 25 of 92 OK created table model agency_data_pipeline.bing_ads_stats.. [CREATE TABLE in 3.33s]
2018-04-18 10:10:12,581: 10:10:12 | 28 of 92 START table model agency_data_pipeline.shopify_orders_proc.. [RUN]
2018-04-18 10:10:12,582: Compiling model.agency_data_pipeline.shopify_orders_proc
2018-04-18 10:10:12,598: Acquiring new bigquery connection "shopify_orders_proc".
2018-04-18 10:10:12,598: Re-using an available connection from the pool.
2018-04-18 10:10:12,599: Fetching data for query shopify_orders_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 10:10:12,879: 10:10:12 | 26 of 92 OK created table model agency_data_pipeline.shopify_products_proc [CREATE TABLE in 3.53s]
2018-04-18 10:10:12,956: Writing injected SQL for node "model.agency_data_pipeline.shopify_orders_proc"
2018-04-18 10:10:13,934: Model SQL (shopify_orders_proc):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc`, `growth-engines-pipeline`.`agency_data_pipeline`.`shopify_refunds_proc`





with orders as (

	
	SELECT
	'lucadanni' client_name,
	'Shopify' as lookup_platform,
	created_at,
	order_number,
	quantity,
	cast(pre_tax_price as float64) price, 
	total_line_items_price total_order_price_undiscounted,
	total_discounts,
	cast(discounted_price as float64) total_order_shipping_price,
	total_price_usd total_order_price_incl_shipping,
	checkout_id,
	product_id, 
	landing_site,
	sku, 
	variant_title, 
	variant_id,
	_id line_item_id,
	customer.id customer_id,
	customer.orders_count orders_count,
	customer.created_at customer_created_at,
	customer.last_order_id last_order_id,
	financial_status,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY order_number, _id ORDER BY _sdc_sequence DESC) lv
	FROM `growth-engines-pipeline.shopify_lucadanni.orders` 
	cross join unnest(line_items), unnest(shipping_lines)
	where source_name != 'shopify_draft_order'
	
	

)

SELECT
b.account,
b.client,
b.platform,
created_at,
a.order_number,
a.quantity,
c.quantity refund_quantity,
case when c.quantity is not null then a.quantity - c.quantity else a.quantity end as final_quantity,
price, 
total_order_price_undiscounted,
total_discounts,
total_order_shipping_price,
total_order_price_incl_shipping,
refund_amount,
case when refund_amount is not null then price - refund_amount else price end as final_price,
a.checkout_id,
a.product_id, 
landing_site,
sku, 
variant_title, 
a.variant_id,
a.line_item_id,	
customer_id,
orders_count,
customer_created_at,
last_order_id,
a.financial_status
FROM orders a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
ON ( a.client_name = b.client_name
  AND a.lookup_platform = b.platform )
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`shopify_refunds_proc` c
ON ( a.order_number = c.order_number
	AND a.line_item_id = c.line_item_id )   	
where a.lv = a._sdc_sequence


2018-04-18 10:10:14,613: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1074bfa90>]}
2018-04-18 10:10:14,866: 10:10:14 | 24 of 92 OK created table model agency_data_pipeline.agg_customers_union [CREATE TABLE in 5.63s]
2018-04-18 10:10:15,704: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1075569e8>]}
2018-04-18 10:10:15,958: 10:10:15 | 27 of 92 OK created table model agency_data_pipeline.ga_mcf_stats.... [CREATE TABLE in 6.70s]
2018-04-18 10:10:21,766: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10aa6aa20>]}
2018-04-18 10:10:22,461: 10:10:22 | 28 of 92 OK created table model agency_data_pipeline.shopify_orders_proc [CREATE TABLE in 9.18s]
2018-04-18 10:10:22,462: 10:10:22 | 29 of 92 START table model agency_data_pipeline.ga_transactions...... [RUN]
2018-04-18 10:10:22,463: Compiling model.agency_data_pipeline.ga_transactions
2018-04-18 10:10:22,462: 10:10:22 | 30 of 92 START table model agency_data_pipeline.agg_orders_union..... [RUN]
2018-04-18 10:10:22,463: 10:10:22 | 31 of 92 START table model agency_data_pipeline.adwords_join......... [RUN]
2018-04-18 10:10:22,476: Acquiring new bigquery connection "ga_transactions".
2018-04-18 10:10:22,476: Compiling model.agency_data_pipeline.agg_orders_union
2018-04-18 10:10:22,463: 10:10:22 | 32 of 92 START table model agency_data_pipeline.ga_traffic........... [RUN]
2018-04-18 10:10:22,477: Compiling model.agency_data_pipeline.adwords_join
2018-04-18 10:10:22,477: Re-using an available connection from the pool.
2018-04-18 10:10:22,481: Writing injected SQL for node "model.agency_data_pipeline.agg_orders_union"
2018-04-18 10:10:22,482: Compiling model.agency_data_pipeline.ga_traffic
2018-04-18 10:10:22,487: Writing injected SQL for node "model.agency_data_pipeline.adwords_join"
2018-04-18 10:10:22,487: Fetching data for query ga_transactions:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Google Analytics'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 10:10:22,506: Acquiring new bigquery connection "ga_traffic".
2018-04-18 10:10:22,508: Acquiring new bigquery connection "adwords_join".
2018-04-18 10:10:22,509: Acquiring new bigquery connection "agg_orders_union".
2018-04-18 10:10:22,509: Re-using an available connection from the pool.
2018-04-18 10:10:22,511: Fetching data for query ga_traffic:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'GA Traffic'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 10:10:22,512: Re-using an available connection from the pool.
2018-04-18 10:10:22,515: Re-using an available connection from the pool.
2018-04-18 10:10:23,402: Model SQL (agg_orders_union):
SELECT
account,
client,
platform,
created_at,
order_number,
quantity,
refund_quantity,
final_quantity,
price, 
total_order_price_undiscounted,
total_discounts,
total_order_shipping_price,
total_order_price_incl_shipping,
refund_amount,
final_price,
checkout_id,
product_id, 
landing_site,
sku, 
variant_title, 
variant_id,
line_item_id,	
customer_id,
orders_count,
customer_created_at,
last_order_id,
financial_status
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`shopify_orders_proc`
2018-04-18 10:10:23,444: Model SQL (adwords_join):
select
a.day,
a.campaignid, 
a.campaign,
a.account, 
channel,
platform,
url,
utm_campaign,
cost,
impressions,
clicks,
impression_share_num,
impression_share_den,
transactions
FROM ( 
	
	select
	day,
	a.campaign,
	a.campaignid, 
	account, 
	channel,
	platform,
	url,
	cost,
	impressions,
	clicks,
	impression_share_num,
	impression_share_den
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_campaigns` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_urls` b
	ON a.campaignid = b.campaignid

) a 
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_ads` b
ON ( a.campaignid = b.campaignid
	and a.day = b.day )
2018-04-18 10:10:23,768: Fetching data for query ga_transactions:


        select
            goal_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_conversions`

        
        ##where 1 = 1
        where goal_type = 'Conversion'
        
        
        
        ##and 2 = 2
        and client_name = 'lucadanni'
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 10:10:23,898: Fetching data for query ga_traffic:


        select
            goal_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_conversions`

        
        ##where 1 = 1
        where goal_type = 'Conversion'
        
        
        
        ##and 2 = 2
        and client_name = 'lucadanni'
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 10:10:25,026: Writing injected SQL for node "model.agency_data_pipeline.ga_transactions"
2018-04-18 10:10:25,373: Writing injected SQL for node "model.agency_data_pipeline.ga_traffic"
2018-04-18 10:10:26,120: Model SQL (ga_transactions):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc`, `growth-engines-pipeline`.`agency_data_pipeline`.`ga_conversions`


##`growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` 



with ga_report as (

	    

	    	
	    	
		   	SELECT
		   	'lucadanni' as client_name,
		   	'Google Analytics' as lookup_platform,
			lower(trim(regexp_replace(replace(replace(replace(replace(CONCAT(hostname,landingpagepath),'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
			date,
			lower(source) source,
			lower(medium) medium,
			lower(campaign) campaign,
			cast(regexp_replace(transactionid, r'#', '') as int64) transactionid,
			transactions last_touch_transactions,
			(transactionrevenue - transactionshipping - transactiontax) as last_touch_revenue,
			transactionshipping,
			transactiontax,
			_sdc_sequence,
			first_value(_sdc_sequence) OVER (PARTITION BY hostname, landingpagepath, date, source, medium, transactionid ORDER BY _sdc_sequence DESC) lv
			FROM `growth-engines-pipeline.ga_lucadanni.report` 

		    
	   

)


SELECT  
cast(date as date) date,
b.account,
b.client client,
c.source source,
c.medium medium,
a.campaign campaign,
concat(a.source, ' / ', a.medium) source_medium,  
case when c.platform is null then "Unmapped" else c.platform end as platform,
case when c.channel is null then "Unmapped" else c.channel end as channel,
regexp_replace(url, r'offers.|offer.|get.|info.|pos.|go.|join.|pages.','') url,
transactionid,
max(last_touch_transactions) last_touch_transactions,
max(last_touch_revenue) last_touch_revenue,
max(transactionshipping) last_touch_shipping,
max(transactiontax) last_touch_tax
FROM ga_report a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
ON ( a.client_name = b.client_name 
	AND a.lookup_platform = b.platform )
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc` c
ON ( a.source = c.source
  AND a.medium = c.medium 
  AND a.client_name = c.client_name )
GROUP BY date, account, client, source, medium, campaign, source_medium, platform, channel, url, transactionid


2018-04-18 10:10:26,168: Model SQL (ga_traffic):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc`, `growth-engines-pipeline`.`agency_data_pipeline`.`ga_conversions`


##`growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` 



with ga_report as (

	    

	    	
	    	
		   	SELECT
		   	'lucadanni' as client_name,
		   	'GA Traffic' as lookup_platform,
			lower(trim(regexp_replace(replace(replace(replace(replace(CONCAT(hostname,landingpagepath),'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
			date,
			lower(source) source,
			lower(medium) medium,
			lower(campaign) campaign,
			sessions,
			## goal completion columns
							
				goalcompletionsall as goal_completions,		
			
			_sdc_sequence,
			first_value(_sdc_sequence) OVER (PARTITION BY hostname, landingpagepath, date, source, medium, campaign ORDER BY _sdc_sequence DESC) lv
			FROM `growth-engines-pipeline.ga_lucadanni_traffic.report` 

		    
	   

)


SELECT  
cast(date as date) date,
b.account,
b.client client,
c.source source,
c.medium medium,
a.campaign campaign,
concat(a.source, ' / ', a.medium) source_medium,  
case when c.platform is null then "Unmapped" else c.platform end as platform,
case when c.channel is null then "Unmapped" else c.channel end as channel,
regexp_replace(url, r'offers.|offer.|get.|info.|pos.|go.|join.|pages.','') url,
max(sessions) sessions,
max(goal_completions) goal_completions
FROM ga_report a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
ON ( a.client_name = b.client_name 
	AND a.lookup_platform = b.platform )
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc` c
ON ( a.source = c.source
  AND a.medium = c.medium 
  AND a.client_name = c.client_name )
GROUP BY date, account, client, source, medium, campaign, source_medium, platform, channel, url


2018-04-18 10:10:30,079: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10755ed68>]}
2018-04-18 10:10:30,331: 10:10:30 | 31 of 92 OK created table model agency_data_pipeline.adwords_join.... [CREATE TABLE in 7.60s]
2018-04-18 10:10:30,332: 10:10:30 | 33 of 92 START table model agency_data_pipeline.agg_products......... [RUN]
2018-04-18 10:10:30,332: Compiling model.agency_data_pipeline.agg_products
2018-04-18 10:10:30,339: Writing injected SQL for node "model.agency_data_pipeline.agg_products"
2018-04-18 10:10:30,340: Acquiring new bigquery connection "agg_products".
2018-04-18 10:10:30,340: Re-using an available connection from the pool.
2018-04-18 10:10:31,070: Model SQL (agg_products):
SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`shopify_products_proc`
2018-04-18 10:10:31,722: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1074b3278>]}
2018-04-18 10:10:32,131: 10:10:32 | 29 of 92 OK created table model agency_data_pipeline.ga_transactions. [CREATE TABLE in 9.26s]
2018-04-18 10:10:32,168: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10755ed68>]}
2018-04-18 10:10:32,514: 10:10:32 | 33 of 92 OK created table model agency_data_pipeline.agg_products.... [CREATE TABLE in 1.84s]
2018-04-18 10:10:33,396: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107556780>]}
2018-04-18 10:10:33,703: 10:10:33 | 30 of 92 OK created table model agency_data_pipeline.agg_orders_union [CREATE TABLE in 10.92s]
2018-04-18 10:10:38,687: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10aa55400>]}
2018-04-18 10:10:38,951: 10:10:38 | 32 of 92 OK created table model agency_data_pipeline.ga_traffic...... [CREATE TABLE in 16.21s]
2018-04-18 10:10:38,952: 10:10:38 | 34 of 92 START table model agency_data_pipeline.adwords_stats........ [RUN]
2018-04-18 10:10:38,953: Compiling model.agency_data_pipeline.adwords_stats
2018-04-18 10:10:38,963: Writing injected SQL for node "model.agency_data_pipeline.adwords_stats"
2018-04-18 10:10:38,960: 10:10:38 | 35 of 92 START table model agency_data_pipeline.adwords_impression_share [RUN]
2018-04-18 10:10:38,960: 10:10:38 | 36 of 92 START table model agency_data_pipeline.agg_transaction_order_number [RUN]
2018-04-18 10:10:38,964: Compiling model.agency_data_pipeline.adwords_impression_share
2018-04-18 10:10:38,960: 10:10:38 | 37 of 92 START table model agency_data_pipeline.fb_ads_stats......... [RUN]
2018-04-18 10:10:38,964: Acquiring new bigquery connection "adwords_stats".
2018-04-18 10:10:38,964: Compiling model.agency_data_pipeline.agg_transaction_order_number
2018-04-18 10:10:38,975: Writing injected SQL for node "model.agency_data_pipeline.adwords_impression_share"
2018-04-18 10:10:38,975: Compiling model.agency_data_pipeline.fb_ads_stats
2018-04-18 10:10:38,975: Re-using an available connection from the pool.
2018-04-18 10:10:38,986: Writing injected SQL for node "model.agency_data_pipeline.agg_transaction_order_number"
2018-04-18 10:10:38,988: Acquiring new bigquery connection "adwords_impression_share".
2018-04-18 10:10:39,006: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_stats"
2018-04-18 10:10:39,014: Re-using an available connection from the pool.
2018-04-18 10:10:39,016: Acquiring new bigquery connection "fb_ads_stats".
2018-04-18 10:10:39,017: Re-using an available connection from the pool.
2018-04-18 10:10:39,041: Acquiring new bigquery connection "agg_transaction_order_number".
2018-04-18 10:10:39,041: Re-using an available connection from the pool.
2018-04-18 10:10:39,925: Model SQL (adwords_impression_share):
SELECT 
cast(day as date) date, 
account, 
channel,
platform,
sum(impression_share_num) impressions,
sum(impression_share_den) available_impressions
FROM 
  `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_join`
group by date, account, platform, channel
2018-04-18 10:10:39,947: Model SQL (agg_transaction_order_number):
SELECT
client,
cast(created_at as date) date,
order_number,
customer_id,
sum(final_quantity) final_quantity,
sum(final_price) final_price,
max(total_order_shipping_price) shipping_price
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`agg_orders_union`
GROUP BY client, created_at, order_number, customer_id
2018-04-18 10:10:39,994: Model SQL (adwords_stats):
SELECT 
cast(day as date) date, 
account, 
platform,
channel,
url,
utm_campaign,
campaign,
sum(cost) cost,
sum(impressions) impressions,
sum(clicks) clicks,
sum(transactions) transactions
FROM 
  `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_join`
group by date, account, platform, channel, url, campaign, utm_campaign
2018-04-18 10:10:40,042: Model SQL (fb_ads_stats):
with cost as (

    select 
        date, account, ad_id, campaign,
        cost, impressions, clicks, null as conversions
    from `growth-engines-pipeline`.`agency_data_pipeline`.`fb_ads_insights`
),

conversions as (

    select 
        date, account, ad_id, campaign,
        null as cost, null as impressions, null as clicks, conversions
    from `growth-engines-pipeline`.`agency_data_pipeline`.`fb_ads_insights_conversions`
),

urls as (

    select ad_id, url
    from `growth-engines-pipeline`.`agency_data_pipeline`.`fb_ads`
)


SELECT
    cast(date as date) date,
    'FB Ads' platform,
    'Paid' channel,
    account, 
    b.url url,
    campaign,
    lower(campaign) utm_campaign, 
    sum(cost) cost,
    sum(impressions) impressions,
    sum(clicks) clicks,
    sum(conversions) transactions
FROM
(
    SELECT *
    FROM 
      cost
    UNION ALL
    SELECT *
    FROM 
      conversions
) a
LEFT JOIN urls b
ON ( a.ad_id = b.ad_id )
group by date, platform, channel, account, url, campaign, utm_campaign
2018-04-18 10:10:42,174: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1074b0908>]}
2018-04-18 10:10:42,424: 10:10:42 | 35 of 92 OK created table model agency_data_pipeline.adwords_impression_share [CREATE TABLE in 3.21s]
2018-04-18 10:10:42,424: 10:10:42 | 38 of 92 START table model agency_data_pipeline.agg_transaction_line_item [RUN]
2018-04-18 10:10:42,425: Compiling model.agency_data_pipeline.agg_transaction_line_item
2018-04-18 10:10:42,432: Writing injected SQL for node "model.agency_data_pipeline.agg_transaction_line_item"
2018-04-18 10:10:42,433: Acquiring new bigquery connection "agg_transaction_line_item".
2018-04-18 10:10:42,433: Re-using an available connection from the pool.
2018-04-18 10:10:43,344: Model SQL (agg_transaction_line_item):
SELECT
client,
created_at,
order_number,
quantity,
refund_quantity,
final_quantity,
price, 
total_order_price_undiscounted,
total_discounts,
total_order_shipping_price,
total_order_price_incl_shipping,
refund_amount,
final_price,
checkout_id,
product_id, 
landing_site,
sku, 
variant_title, 
variant_id,
line_item_id,	
customer_id,
orders_count,
customer_created_at,
last_order_id,
financial_status
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`agg_orders_union`
2018-04-18 10:10:43,449: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107570a20>]}
2018-04-18 10:10:43,676: 10:10:43 | 37 of 92 OK created table model agency_data_pipeline.fb_ads_stats.... [CREATE TABLE in 4.47s]
2018-04-18 10:10:44,360: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1074b0a58>]}
2018-04-18 10:10:44,613: 10:10:44 | 36 of 92 OK created table model agency_data_pipeline.agg_transaction_order_number [CREATE TABLE in 5.40s]
2018-04-18 10:10:45,514: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10aa6aa20>]}
2018-04-18 10:10:45,782: 10:10:45 | 34 of 92 OK created table model agency_data_pipeline.adwords_stats... [CREATE TABLE in 6.56s]
2018-04-18 10:10:51,095: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1074b0908>]}
2018-04-18 10:10:51,334: 10:10:51 | 38 of 92 OK created table model agency_data_pipeline.agg_transaction_line_item [CREATE TABLE in 8.67s]
2018-04-18 10:10:51,335: 10:10:51 | 39 of 92 START table model agency_data_pipeline.customers_by_transaction [RUN]
2018-04-18 10:10:51,336: Compiling model.agency_data_pipeline.customers_by_transaction
2018-04-18 10:10:51,344: Writing injected SQL for node "model.agency_data_pipeline.customers_by_transaction"
2018-04-18 10:10:51,345: Acquiring new bigquery connection "customers_by_transaction".
2018-04-18 10:10:51,345: Re-using an available connection from the pool.
2018-04-18 10:10:52,257: Model SQL (customers_by_transaction):
SELECT
client,
customer_id,
order_number,
order_date,
first_order_date,
case when first_order_number = order_number then 'New' else 'Existing' end as order_type,
final_price,
first_order_revenue,
lifetime_revenue
FROM

(

	SELECT
	client,
	customer_id,
	order_number,
	date order_date,
	first_value(date) over w1 first_order_date,
	first_value(order_number) over w1 first_order_number,
	first_value(final_price) over w1 first_order_revenue,
    final_price,
	sum(final_price) over w2 lifetime_revenue
	FROM
    `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_order_number`
	WINDOW w1 as (PARTITION BY client, customer_id ORDER BY date desc),
	w2 as (PARTITION BY client, customer_id)
)
2018-04-18 10:10:55,584: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1075567f0>]}
2018-04-18 10:10:55,870: 10:10:55 | 39 of 92 OK created table model agency_data_pipeline.customers_by_transaction [CREATE TABLE in 4.25s]
2018-04-18 10:10:55,871: 10:10:55 | 40 of 92 START table model agency_data_pipeline.agg_ga_transaction_order_number [RUN]
2018-04-18 10:10:55,871: 10:10:55 | 41 of 92 START table model agency_data_pipeline.frequency_proc....... [RUN]
2018-04-18 10:10:55,871: Compiling model.agency_data_pipeline.agg_ga_transaction_order_number
2018-04-18 10:10:55,871: Compiling model.agency_data_pipeline.frequency_proc
2018-04-18 10:10:55,888: Writing injected SQL for node "model.agency_data_pipeline.agg_ga_transaction_order_number"
2018-04-18 10:10:55,891: Writing injected SQL for node "model.agency_data_pipeline.frequency_proc"
2018-04-18 10:10:55,895: Acquiring new bigquery connection "frequency_proc".
2018-04-18 10:10:55,896: Acquiring new bigquery connection "agg_ga_transaction_order_number".
2018-04-18 10:10:55,897: Re-using an available connection from the pool.
2018-04-18 10:10:55,898: Re-using an available connection from the pool.
2018-04-18 10:10:56,840: Model SQL (frequency_proc):
WITH transactions AS (

  	SELECT 
	client,
	customer_id,
	order_number,
	date,
	unix_date(date) d
	FROM
	`growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_order_number`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)

SELECT 
client,
'Rolling 365' as period,
date_in_range date,
unix_date_in_range, 
customer_id,
count(distinct(order_number)) frequency
FROM daterange
JOIN transactions
ON transactions.d > ( daterange.unix_date_in_range - 365 )
AND transactions.d <= daterange.unix_date_in_range
group by client, unix_date_in_range, customer_id, date
2018-04-18 10:10:56,853: Model SQL (agg_ga_transaction_order_number):
with ga as (

    select 
        date, account, client, 
        channel as last_touch_channel, 
        platform as last_touch_platform, 
        url as last_touch_url, 
        campaign as last_touch_utm_campaign, 
        '' as first_touch_channel, 
        '' as first_touch_platform, 
        '' as first_touch_utm_campaign, 
        transactionid,
        last_touch_transactions, last_touch_revenue,
        last_touch_shipping, last_touch_tax,
        null as first_touch_transactions, null as first_touch_revenue
    from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_transactions`

),

ga_mcf as (

    select 
        date, account, client, 
        '' as last_touch_channel,
        '' as last_touch_platform,
        '' as last_touch_url,
        '' as last_touch_utm_campaign, 
        channel as first_touch_channel, 
        platform as first_touch_platform, 
        campaign as first_touch_utm_campaign, 
        transactionid, 
        null as last_touch_transactions, null as last_touch_revenue,
        null as last_touch_shipping, null as last_touch_tax,
        first_touch_transactions, first_touch_revenue
    from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_mcf_stats`

)


SELECT
    date, 
    client,
    transactionid,
    max(last_touch_channel) last_touch_channel, 
    max(last_touch_platform) last_touch_platform, 
    max(last_touch_url) last_touch_url, 
    max(last_touch_utm_campaign) last_touch_utm_campaign, 
    max(first_touch_channel) first_touch_channel, 
    max(first_touch_platform) first_touch_platform, 
    max(first_touch_utm_campaign) first_touch_utm_campaign,
    sum(last_touch_transactions) last_touch_transactions,
    sum(last_touch_revenue) last_touch_revenue,
    sum(last_touch_shipping) last_touch_shipping_revenue,
    sum(last_touch_tax) last_touch_tax_revenue,
    sum(first_touch_transactions) first_touch_transactions,
    sum(first_touch_revenue) - ifnull(sum(last_touch_shipping),0) - ifnull(sum(last_touch_tax),0) first_touch_revenue
FROM
(
    SELECT *
    FROM 
      ga
    UNION ALL
    SELECT *
    FROM 
      ga_mcf
) 
GROUP BY
    date, client, transactionid
2018-04-18 10:11:01,373: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1074b0908>]}
2018-04-18 10:11:02,185: 10:11:02 | 40 of 92 OK created table model agency_data_pipeline.agg_ga_transaction_order_number [CREATE TABLE in 5.50s]
2018-04-18 10:11:11,686: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107570828>]}
2018-04-18 10:11:11,931: 10:11:11 | 41 of 92 OK created table model agency_data_pipeline.frequency_proc.. [CREATE TABLE in 15.81s]
2018-04-18 10:11:11,932: 10:11:11 | 42 of 92 START table model agency_data_pipeline.agg_ga_campaign...... [RUN]
2018-04-18 10:11:11,933: Compiling model.agency_data_pipeline.agg_ga_campaign
2018-04-18 10:11:11,932: 10:11:11 | 43 of 92 START table model agency_data_pipeline.frequency_stats...... [RUN]
2018-04-18 10:11:11,942: Writing injected SQL for node "model.agency_data_pipeline.agg_ga_campaign"
2018-04-18 10:11:11,932: 10:11:11 | 44 of 92 START table model agency_data_pipeline.agg_transaction_line_item_type [RUN]
2018-04-18 10:11:11,942: Compiling model.agency_data_pipeline.frequency_stats
2018-04-18 10:11:11,942: Compiling model.agency_data_pipeline.agg_transaction_line_item_type
2018-04-18 10:11:11,947: Writing injected SQL for node "model.agency_data_pipeline.frequency_stats"
2018-04-18 10:11:11,952: Writing injected SQL for node "model.agency_data_pipeline.agg_transaction_line_item_type"
2018-04-18 10:11:11,953: Acquiring new bigquery connection "agg_ga_campaign".
2018-04-18 10:11:11,954: Re-using an available connection from the pool.
2018-04-18 10:11:11,955: Acquiring new bigquery connection "frequency_stats".
2018-04-18 10:11:11,957: Re-using an available connection from the pool.
2018-04-18 10:11:11,958: Acquiring new bigquery connection "agg_transaction_line_item_type".
2018-04-18 10:11:11,959: Re-using an available connection from the pool.
2018-04-18 10:11:12,685: Model SQL (frequency_stats):
SELECT
client,
period,
date,
unix_date_in_range,
case when frequency = 1 then '1' 
	when frequency = 2 then '2'
	when frequency > 2 then '3+'
	else null end as frequency_segment,
sum(customers) customers,
sum(customers) over (partition by client, period, date) total_customers,
sum(customers)/( sum(customers) over (partition by client, period, date) ) pct_of_customers
FROM (

	SELECT 
	client,
	period,
	date,
	unix_date_in_range, 
	frequency,
	count(distinct(customer_id)) customers
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`frequency_proc`
	group by client, period, date, unix_date_in_range, frequency
)
group by client, period, date, unix_date_in_range, frequency_segment
2018-04-18 10:11:12,688: Bad request while running:
SELECT
client,
period,
date,
unix_date_in_range,
case when frequency = 1 then '1' 
	when frequency = 2 then '2'
	when frequency > 2 then '3+'
	else null end as frequency_segment,
sum(customers) customers,
sum(customers) over (partition by client, period, date) total_customers,
sum(customers)/( sum(customers) over (partition by client, period, date) ) pct_of_customers
FROM (

	SELECT 
	client,
	period,
	date,
	unix_date_in_range, 
	frequency,
	count(distinct(customer_id)) customers
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`frequency_proc`
	group by client, period, date, unix_date_in_range, frequency
)
group by client, period, date, unix_date_in_range, frequency_segment
2018-04-18 10:11:12,688: 400 SELECT list expression references column customers which is neither grouped nor aggregated at [11:5]
2018-04-18 10:11:12,688: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1074d7780>]}
2018-04-18 10:11:12,799: Model SQL (agg_ga_campaign):
with ga_transactions as (

	select 
		date, account, client, channel, platform, url, 
		campaign,
		null as sessions, null as goal_completions, last_touch_transactions, last_touch_revenue,
		last_touch_shipping, last_touch_tax,
		null as first_touch_transactions, null as first_touch_revenue
	from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_transactions`

),

ga_traffic as (

    select 
        date, account, client, channel, platform, url, 
        campaign,
        sessions, goal_completions, null as last_touch_transactions, null as last_touch_revenue,
        null as last_touch_shipping, null as last_touch_tax,
        null as first_touch_transactions, null as first_touch_revenue
    from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_traffic`

),

ga_mcf as (

	select 
		date, account, client, channel, platform, '' as url,
		campaign, 
		null as sessions, null as goal_completions, null as last_touch_transactions, null as last_touch_revenue,
		null as last_touch_shipping, null as last_touch_tax,
		first_touch_transactions, first_touch_revenue
	from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_mcf_stats`

)


SELECT
    date, 
    client,
    platform,
    channel, 
    url,
    campaign utm_campaign,
	sum(sessions) sessions,
	sum(goal_completions) goal_completions,
	sum(last_touch_transactions) last_touch_transactions,
	sum(last_touch_revenue) last_touch_revenue,
    sum(last_touch_shipping) last_touch_shipping_revenue,
    sum(last_touch_tax) last_touch_tax_revenue,
    sum(first_touch_transactions) first_touch_transactions,
    sum(first_touch_revenue) - sum(ifnull(last_touch_shipping,0)) - sum(ifnull(last_touch_tax,0)) first_touch_revenue

FROM
(
    SELECT *
    FROM 
      ga_transactions
    UNION ALL
    SELECT *
    FROM 
      ga_traffic
    UNION ALL
    SELECT *
    FROM 
      ga_mcf
) 
GROUP BY
    date, client, platform, channel, url, utm_campaign
2018-04-18 10:11:12,831: Model SQL (agg_transaction_line_item_type):
SELECT
client,
product_id,
product_type,
customer_id,
sku,
order_number,
created_at,
final_quantity,
final_price
FROM

( 
	SELECT 
	a.client, 
	a.product_id,
	product_type,
	customer_id,
	a.sku, 
	order_number,
	created_at,
	final_quantity,
	final_price
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_line_item` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`agg_products` b
	ON (
		a.product_id = b.product_id
	  and a.client = b.client
		)

)
2018-04-18 10:11:12,918: 10:11:12 | 43 of 92 ERROR creating table model agency_data_pipeline.frequency_stats [ERROR in 0.75s]
2018-04-18 10:11:17,258: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1074f05c0>]}
2018-04-18 10:11:17,503: 10:11:17 | 44 of 92 OK created table model agency_data_pipeline.agg_transaction_line_item_type [CREATE TABLE in 5.32s]
2018-04-18 10:11:22,697: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10aa55c88>]}
2018-04-18 10:11:23,383: 10:11:23 | 42 of 92 OK created table model agency_data_pipeline.agg_ga_campaign. [CREATE TABLE in 10.76s]
2018-04-18 10:11:23,384: 10:11:23 | 45 of 92 START table model agency_data_pipeline.customers_first_purchase_product_type_proc [RUN]
2018-04-18 10:11:23,385: 10:11:23 | 46 of 92 START table model agency_data_pipeline.agg_transaction_product_type [RUN]
2018-04-18 10:11:23,385: Compiling model.agency_data_pipeline.customers_first_purchase_product_type_proc
2018-04-18 10:11:23,385: Compiling model.agency_data_pipeline.agg_transaction_product_type
2018-04-18 10:11:23,402: Writing injected SQL for node "model.agency_data_pipeline.customers_first_purchase_product_type_proc"
2018-04-18 10:11:23,404: Writing injected SQL for node "model.agency_data_pipeline.agg_transaction_product_type"
2018-04-18 10:11:23,407: Acquiring new bigquery connection "customers_first_purchase_product_type_proc".
2018-04-18 10:11:23,407: Re-using an available connection from the pool.
2018-04-18 10:11:23,411: Acquiring new bigquery connection "agg_transaction_product_type".
2018-04-18 10:11:23,412: Re-using an available connection from the pool.
2018-04-18 10:11:24,347: Model SQL (agg_transaction_product_type):
SELECT
client,
product_type,
customer_id,
order_number,
created_at,
first_value(product_type) over (PARTITION BY client, customer_id, order_number, created_at ORDER BY final_price desc) as top_order_product_type,
final_quantity,
final_price,
sum(final_quantity) over (PARTITION BY client, customer_id, order_number) as total_order_quantity,
sum(final_price) over (PARTITION BY client, customer_id, order_number) as total_order_value
FROM
	(
		SELECT
		client,
		product_type,
		customer_id,
		order_number,
		created_at,
		sum(final_quantity) final_quantity,
		sum(final_price) final_price
		FROM
		`growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_line_item_type`
		GROUP BY
		client,
		product_type,
		customer_id,
		order_number,
		created_at
	)
2018-04-18 10:11:24,372: Model SQL (customers_first_purchase_product_type_proc):
SELECT 
client, 
customer_id, 
product_type,
min(cast(created_at as date)) first_order_date,
unix_date( min(cast(created_at as date))) first_order_unix_date
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_line_item_type`
GROUP BY client, customer_id, product_type
2018-04-18 10:11:27,717: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10aa550b8>]}
2018-04-18 10:11:28,065: 10:11:28 | 45 of 92 OK created table model agency_data_pipeline.customers_first_purchase_product_type_proc [CREATE TABLE in 4.33s]
2018-04-18 10:11:29,021: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1074dd3c8>]}
2018-04-18 10:11:29,325: 10:11:29 | 46 of 92 OK created table model agency_data_pipeline.agg_transaction_product_type [CREATE TABLE in 5.64s]
2018-04-18 10:11:29,326: 10:11:29 | 47 of 92 START table model agency_data_pipeline.order_paths_proc..... [RUN]
2018-04-18 10:11:29,326: 10:11:29 | 48 of 92 START table model agency_data_pipeline.products_proc........ [RUN]
2018-04-18 10:11:29,326: Compiling model.agency_data_pipeline.order_paths_proc
2018-04-18 10:11:29,327: 10:11:29 | 49 of 92 START table model agency_data_pipeline.customers_products_proc [RUN]
2018-04-18 10:11:29,327: Compiling model.agency_data_pipeline.products_proc
2018-04-18 10:11:29,336: Writing injected SQL for node "model.agency_data_pipeline.order_paths_proc"
2018-04-18 10:11:29,336: Compiling model.agency_data_pipeline.customers_products_proc
2018-04-18 10:11:29,343: Writing injected SQL for node "model.agency_data_pipeline.products_proc"
2018-04-18 10:11:29,349: Writing injected SQL for node "model.agency_data_pipeline.customers_products_proc"
2018-04-18 10:11:29,350: Acquiring new bigquery connection "order_paths_proc".
2018-04-18 10:11:29,350: Re-using an available connection from the pool.
2018-04-18 10:11:29,352: Acquiring new bigquery connection "customers_products_proc".
2018-04-18 10:11:29,353: Re-using an available connection from the pool.
2018-04-18 10:11:29,356: Acquiring new bigquery connection "products_proc".
2018-04-18 10:11:29,356: Re-using an available connection from the pool.
2018-04-18 10:11:30,164: Model SQL (order_paths_proc):
SELECT
client, 
customer_id, 
first_value(product_type) OVER w1 as first_product_type,
nth_value(product_type, 2) OVER w1 as second_product_type,
cast(first_value(created_at) OVER w1 as date) as first_purchase_date,
cast(nth_value(created_at, 2) OVER w1 as date) as second_purchase_date,
cast(nth_value(created_at, 3) OVER w1 as date) as third_purchase_date,
cast(nth_value(created_at, 4) OVER w1 as date) as fourth_purchase_date,
cast(nth_value(created_at, 5) OVER w1 as date) as fifth_purchase_date,
first_value(order_number) OVER w1 as first_order_number,
nth_value(order_number, 2) OVER w1 as second_order_number,
nth_value(order_number, 3) OVER w1 as third_order_number,
nth_value(order_number, 4) OVER w1 as fourth_order_number,
nth_value(order_number, 5) OVER w1 as fifth_order_number,
first_value(total_order_value) OVER w1 as first_order_value,
nth_value(total_order_value, 2) OVER w1 as second_order_value
FROM (
	  
	  SELECT 
	  client, 
	  product_type,
	  customer_id,
	  order_number,
	  created_at, 
	  total_order_value
	  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_product_type`
	  WHERE product_type = top_order_product_type

)
WINDOW w1 as (PARTITION BY client, customer_id ORDER BY created_at asc)
2018-04-18 10:11:30,283: Model SQL (products_proc):
WITH transactions AS (
  SELECT 
  client, 
  product_id,
  product_type,
  customer_id,
  sku, 
  order_number,
  unix_date(cast(created_at as date)) d, 
  final_quantity,
  final_price,
  first_value(unix_date(cast(created_at as date))) over (partition by client, product_id, sku order by created_at asc) first_purchase_unix_date
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_line_item_type`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)

SELECT 
client,
'Last 30' as period,
sku,
product_type,
date_in_range date,
unix_date_in_range, 
case when 
  ( first_purchase_unix_date > ( daterange.unix_date_in_range - 365 ) and first_purchase_unix_date <= daterange.unix_date_in_range )
  then 'New' else 'Existing' end as newness,  
count(distinct(customer_id)) unique_customers,
count(distinct(order_number)) orders,
sum(final_quantity) quantity,
sum(final_price) revenue,
count(distinct(d)) days_sold
FROM daterange
JOIN transactions
ON transactions.d > ( daterange.unix_date_in_range - 30 )
AND transactions.d <= daterange.unix_date_in_range
group by date_in_range, unix_date_in_range, client, sku, product_type, newness

UNION ALL

SELECT 
client,
'Last 90' as period,
sku, 
product_type,
date_in_range date,
unix_date_in_range, 
case when 
  ( first_purchase_unix_date > ( daterange.unix_date_in_range - 365 ) and first_purchase_unix_date <= daterange.unix_date_in_range )
  then 'New' else 'Existing' end as newness,  
count(distinct(customer_id)) unique_customers,
count(distinct(order_number)) orders,
sum(final_quantity) quantity,
sum(final_price) revenue,
count(distinct(d)) days_sold
FROM daterange
JOIN transactions
ON transactions.d > ( daterange.unix_date_in_range - 90 )
AND transactions.d <= daterange.unix_date_in_range
group by date_in_range, unix_date_in_range, client, sku, product_type, newness

UNION ALL

SELECT 
client,
'YoY 30' as date_range,
sku, 
product_type,
date_in_range date,
unix_date_in_range,
case when 
  ( first_purchase_unix_date > ( daterange.unix_date_in_range - 730 ) and first_purchase_unix_date <= ( daterange.unix_date_in_range - 365 ))
  then 'New' else 'Existing' end as newness,   
count(distinct(customer_id)) unique_customers,
count(distinct(order_number)) orders,
sum(final_quantity) quantity,
sum(final_price) revenue,
count(distinct(d)) days_sold
FROM daterange
JOIN transactions
ON transactions.d > ( daterange.unix_date_in_range - 395 )
AND transactions.d <= ( daterange.unix_date_in_range - 365 )
group by date_in_range, unix_date_in_range, client, sku, product_type, newness
2018-04-18 10:11:30,297: Model SQL (customers_products_proc):
WITH customers AS (
  SELECT 
  client, 
  product_id,
  product_type,
  customer_id,
  sku, 
  order_number,
  cast(created_at as date) order_date,
  unix_date(cast(created_at as date)) unix_order_date, 
  final_quantity quantity,
  final_price revenue
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_line_item_type`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)

SELECT 
client,
period,
customer_id,
product_type,
date,
window_end_unix_date,
window_end_unix_date - 365 as window_start_unix_date,
window_end_unix_date - unix_date(recent_order) recency_days,
frequency,
quantity,
revenue,
case when frequency > 0 then revenue/frequency else 0 end as aov
FROM 
(  

  SELECT 
  client,
  'Rolling 365' as period,
  customer_id,
  product_type,
  date_in_range date,
  unix_date_in_range,
  unix_date_in_range window_end_unix_date, 
  max(order_date) recent_order,
  sum(quantity) as quantity,
  sum(revenue) as revenue,
  count(distinct(order_number)) as frequency
  FROM daterange
  JOIN customers
  ON customers.unix_order_date > ( daterange.unix_date_in_range - 365 )
  AND customers.unix_order_date <= daterange.unix_date_in_range
  GROUP BY client, customer_id, date, unix_date_in_range, product_type

  UNION ALL

  SELECT 
  client,
  'Rolling 365 (t-1mo)' as period,
  customer_id,
  product_type,
  date_in_range date,
  unix_date_in_range, 
  unix_date_in_range - 30 window_end_unix_date, 
  max(order_date) recent_order,
  sum(quantity) as quantity,
  sum(revenue) as revenue,
  count(distinct(order_number)) as frequency
  FROM daterange
  JOIN customers
  ON customers.unix_order_date > ( daterange.unix_date_in_range - 395 )
  AND customers.unix_order_date <= ( daterange.unix_date_in_range - 30 )
  GROUP BY client, customer_id, date, unix_date_in_range, product_type

  UNION ALL

  SELECT 
  client,
  'Rolling 365 (t-1yr)' as period,
  customer_id,
  product_type,
  date_in_range date,
  unix_date_in_range, 
  unix_date_in_range - 365 window_end_unix_date, 
  max(order_date) recent_order,
  sum(quantity) as quantity,
  sum(revenue) as revenue,
  count(distinct(order_number)) as frequency
  FROM daterange
  JOIN customers
  ON customers.unix_order_date > ( daterange.unix_date_in_range - 730 )
  AND customers.unix_order_date <= ( daterange.unix_date_in_range - 365 )
  GROUP BY client, customer_id, date, unix_date_in_range, product_type

)
2018-04-18 10:11:33,510: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10aa55c88>]}
2018-04-18 10:11:33,810: 10:11:33 | 47 of 92 OK created table model agency_data_pipeline.order_paths_proc [CREATE TABLE in 4.18s]
2018-04-18 10:11:39,406: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10aa5b470>]}
2018-04-18 10:11:39,663: 10:11:39 | 48 of 92 OK created table model agency_data_pipeline.products_proc... [CREATE TABLE in 10.08s]
2018-04-18 10:12:09,616: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1075124a8>]}
2018-04-18 10:12:10,372: 10:12:10 | 49 of 92 OK created table model agency_data_pipeline.customers_products_proc [CREATE TABLE in 40.28s]
2018-04-18 10:12:10,373: 10:12:10 | 50 of 92 START table model agency_data_pipeline.segment_proc_sku..... [RUN]
2018-04-18 10:12:10,374: Compiling model.agency_data_pipeline.segment_proc_sku
2018-04-18 10:12:10,374: 10:12:10 | 51 of 92 START table model agency_data_pipeline.order_paths_agg...... [RUN]
2018-04-18 10:12:10,381: Compiling model.agency_data_pipeline.order_paths_agg
2018-04-18 10:12:10,394: Writing injected SQL for node "model.agency_data_pipeline.segment_proc_sku"
2018-04-18 10:12:10,396: Acquiring new bigquery connection "segment_proc_sku".
2018-04-18 10:12:10,397: Re-using an available connection from the pool.
2018-04-18 10:12:10,404: Writing injected SQL for node "model.agency_data_pipeline.order_paths_agg"
2018-04-18 10:12:10,418: Acquiring new bigquery connection "order_paths_agg".
2018-04-18 10:12:10,424: Re-using an available connection from the pool.
2018-04-18 10:12:11,672: Model SQL (segment_proc_sku):
SELECT
client,
period,
sku, 
product_type,
date,
unique_customers,
orders,
quantity,
revenue,
case 
	when avg_daily_revenue >= avg_daily_revenue_90pct and avg_daily_quantity >= avg_daily_quantity_80pct then 'Best Seller'
	when avg_daily_revenue >= avg_daily_revenue_70pct and avg_daily_quantity >= avg_daily_quantity_40pct then 'Good'
	when avg_daily_revenue < avg_daily_revenue_70pct and avg_daily_revenue >= avg_daily_revenue_30pct and avg_daily_quantity < avg_daily_quantity_70pct then 'Average'
	when avg_daily_revenue < avg_daily_revenue_30pct and avg_daily_quantity < avg_daily_quantity_30pct then 'Poor'
	else 'Unbucketed' end as segment,
newness,	
avg_daily_revenue_90pct,
avg_daily_revenue_70pct,
avg_daily_revenue_30pct,
avg_daily_quantity_80pct,
avg_daily_quantity_70pct,
avg_daily_quantity_40pct,
avg_daily_quantity_30pct

FROM (

	SELECT
	client,
	period,
	sku, 
	product_type,
	newness,
	date,
	unique_customers,
	orders,
	quantity,
	revenue,
	days_sold,
	avg_daily_revenue,
	avg_daily_quantity,
	PERCENTILE_CONT(avg_daily_revenue, 0.90) OVER w1 AS avg_daily_revenue_90pct,
	PERCENTILE_CONT(avg_daily_revenue, 0.70) OVER w1 AS avg_daily_revenue_70pct,
	PERCENTILE_CONT(avg_daily_revenue, 0.3) OVER w1 AS avg_daily_revenue_30pct,
	PERCENTILE_CONT(avg_daily_quantity, 0.80) OVER w1 AS avg_daily_quantity_80pct,
	PERCENTILE_CONT(avg_daily_quantity, 0.70) OVER w1 AS avg_daily_quantity_70pct,
	PERCENTILE_CONT(avg_daily_quantity, 0.40) OVER w1 AS avg_daily_quantity_40pct,
	PERCENTILE_CONT(avg_daily_quantity, 0.3) OVER w1 AS avg_daily_quantity_30pct

	FROM
	(
		SELECT 
		client,
		period,
		sku, 
		product_type,
		newness,
		date,
		unique_customers,
		orders,
		quantity,
		revenue,
		days_sold,
		case when days_sold > 0 then revenue/days_sold else null end as avg_daily_revenue,
		case when days_sold > 0 then quantity/days_sold else null end as avg_daily_quantity
		FROM `growth-engines-pipeline`.`agency_data_pipeline`.`products_proc`
	)
	WINDOW w1 as (PARTITION BY client, period, date)
)
2018-04-18 10:12:11,780: Model SQL (order_paths_agg):
SELECT
client, 
first_product_type,
second_product_type,
first_purchase_date,
count(distinct(customer_id)) customer_count, 
count(distinct(second_order_number)) second_orders, 
count(distinct(third_order_number)) third_orders, 
count(distinct(fourth_order_number)) fourth_orders, 
count(distinct(fifth_order_number)) fifth_orders, 
sum(date_diff(second_purchase_date, first_purchase_date, DAY)) second_order_latency_days,
sum(date_diff(third_purchase_date, second_purchase_date, DAY)) third_order_latency_days,
sum(date_diff(fourth_purchase_date, third_purchase_date, DAY)) fourth_order_latency_days,
sum(date_diff(fifth_purchase_date, fourth_purchase_date, DAY)) fifth_order_latency_days,
sum(first_order_value) first_order_revenue,
sum(second_order_value) second_order_revenue
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`order_paths_proc`
where second_product_type is not null
GROUP BY client, first_product_type, second_product_type, first_purchase_date
2018-04-18 10:12:13,898: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1074dd3c8>]}
2018-04-18 10:12:13,976: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1074c5080>]}
2018-04-18 10:12:14,149: 10:12:14 | 50 of 92 OK created table model agency_data_pipeline.segment_proc_sku [CREATE TABLE in 3.52s]
2018-04-18 10:12:14,401: 10:12:14 | 51 of 92 OK created table model agency_data_pipeline.order_paths_agg. [CREATE TABLE in 3.60s]
2018-04-18 10:12:14,402: 10:12:14 | 52 of 92 START table model agency_data_pipeline.segment_stats_sku.... [RUN]
2018-04-18 10:12:14,402: 10:12:14 | 53 of 92 START table model agency_data_pipeline.agg_ga_transaction... [RUN]
2018-04-18 10:12:14,402: 10:12:14 | 54 of 92 START table model agency_data_pipeline.segment_proc_customers_products [RUN]
2018-04-18 10:12:14,403: 10:12:14 | 55 of 92 START table model agency_data_pipeline.agg_transaction...... [RUN]
2018-04-18 10:12:14,403: Compiling model.agency_data_pipeline.segment_stats_sku
2018-04-18 10:12:14,403: Compiling model.agency_data_pipeline.agg_ga_transaction
2018-04-18 10:12:14,403: Compiling model.agency_data_pipeline.segment_proc_customers_products
2018-04-18 10:12:14,403: Compiling model.agency_data_pipeline.agg_transaction
2018-04-18 10:12:14,409: Writing injected SQL for node "model.agency_data_pipeline.segment_stats_sku"
2018-04-18 10:12:14,415: Writing injected SQL for node "model.agency_data_pipeline.agg_ga_transaction"
2018-04-18 10:12:14,420: Writing injected SQL for node "model.agency_data_pipeline.segment_proc_customers_products"
2018-04-18 10:12:14,426: Writing injected SQL for node "model.agency_data_pipeline.agg_transaction"
2018-04-18 10:12:14,430: Acquiring new bigquery connection "segment_stats_sku".
2018-04-18 10:12:14,431: Re-using an available connection from the pool.
2018-04-18 10:12:14,430: Acquiring new bigquery connection "agg_ga_transaction".
2018-04-18 10:12:14,431: Acquiring new bigquery connection "agg_transaction".
2018-04-18 10:12:14,432: Acquiring new bigquery connection "segment_proc_customers_products".
2018-04-18 10:12:14,432: Re-using an available connection from the pool.
2018-04-18 10:12:14,434: Re-using an available connection from the pool.
2018-04-18 10:12:14,437: Re-using an available connection from the pool.
2018-04-18 10:12:15,514: Model SQL (segment_stats_sku):
WITH last_30 as (

	SELECT
	client,
	sku, 
	product_type,
	date,
	unique_customers as customers_30,
	orders as orders_30,
	revenue as revenue_30,
	segment as segment_30,
	newness as newness_30,
	0 as customers_90,
	0 as orders_90,
	0 as revenue_90,
	'' as segment_90,
	0 as customers_yoy_30,
	0 as orders_yoy_30,
	0 as revenue_yoy_30,
	'' as segment_yoy_30
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_sku`
	WHERE period = 'Last 30'

),

last_90 as (

	SELECT
	client,
	sku, 
	product_type,
	date,
	0 as customers_30,
	0 as orders_30,
	0 as revenue_30,
	'' as segment_30,
	'' as newness_30,
	unique_customers as customers_90,
	orders as orders_90,
	revenue as revenue_90,
	segment as segment_90,
	0 as customers_yoy_30,
	0 as orders_yoy_30,
	0 as revenue_yoy_30,
	'' as segment_yoy_30
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_sku`
	WHERE period = 'Last 90'

),

yoy_30 as (

	SELECT
	client,
	sku, 
	product_type,
	date,
	0 as customers_30,
	0 as orders_30,
	0 as revenue_30,
	'' as segment_30,
	'' as newness_30,
	0 as customers_90,
	0 as orders_90,
	0 as revenue_90,
	'' as segment_90,
	unique_customers as customers_yoy_30,
	orders as orders_yoy_30,
	revenue as revenue_yoy_30,
	segment as segment_yoy_30
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_sku`
	WHERE period = 'YoY 30'

)

SELECT
client,
sku, 
product_type,
date,
ifnull(sum(customers_30), 0) customers_30,
ifnull(sum(orders_30), 0) orders_30,
ifnull(sum(revenue_30), 0) revenue_30,
ifnull(max(segment_30), '') segment_30,
ifnull(sum(customers_90), 0) customers_90,
ifnull(sum(orders_90), 0) orders_90,
ifnull(sum(revenue_90), 0) revenue_90,
ifnull(max(segment_90),'') segment_90,
ifnull(sum(customers_yoy_30), 0) customers_yoy_30,
ifnull(sum(orders_yoy_30), 0) orders_yoy_30,
ifnull(sum(revenue_yoy_30), 0) revenue_yoy_30,
case when max(newness_30) = 'New' then 'New'
	else ifnull(max(segment_yoy_30), '') end as segment_yoy_30
FROM
(
	SELECT * FROM last_30
	UNION ALL
	SELECT * FROM last_90
	UNION ALL
	SELECT * FROM yoy_30

)
GROUP BY client, sku, product_type, date
2018-04-18 10:12:15,539: Model SQL (agg_transaction):
SELECT
client,
date,
customer_id,
order_number,
last_touch_channel,
last_touch_platform,
last_touch_url,
first_touch_channel, 
first_touch_platform, 
first_touch_utm_campaign,
ifnull( sum(last_touch_transactions), 0) last_touch_transactions, 
ifnull( sum(last_touch_revenue), 0) last_touch_revenue, 
ifnull( sum(first_touch_transactions), 0) first_touch_transactions, 
ifnull( sum(first_touch_revenue), 0) first_touch_revenue,
ifnull( sum(final_quantity), 0) quantity,
ifnull( sum(final_price), 0) revenue,
ifnull( sum(shipping_price), 0) shipping_revenue,
ROW_NUMBER() OVER (PARTITION BY client, customer_id, order_number ORDER BY date asc) AS order_sequence
FROM
(
	SELECT
	a.client,
	a.date date,
	b.date ga_date,
	a.customer_id,
	a.order_number,
	transactionid,
	b.last_touch_channel,
	b.last_touch_platform,
	b.last_touch_url,
	b.first_touch_channel, 
	b.first_touch_platform, 
	b.first_touch_utm_campaign, 
	last_touch_transactions, 
	last_touch_revenue, 
	first_touch_transactions, 
	first_touch_revenue,
	final_quantity,
	final_price,
	shipping_price
	FROM
	`growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_order_number` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`agg_ga_transaction_order_number` b
	ON (
		a.client = b.client and
		a.order_number = b.transactionid
	)

)
GROUP BY
client, 
date, 
customer_id,
order_number, 
last_touch_channel,
last_touch_platform,
last_touch_url,
first_touch_channel, 
first_touch_platform, 
first_touch_utm_campaign
2018-04-18 10:12:15,558: Model SQL (agg_ga_transaction):
#done - lookup customer id from transaction id from orders
#done - tag an order as 'new' or 'existing' based on transaction id
#sum lifetime value of that customer id
#first order value for customer
#read from agg_ga_transaction into agg_ga_campaign instead of directly from ga_transactions and ga_mcf_stats


with ga as (

    select 
        date, 
        client, 
        'Last-touch' as attribution,
        channel, 
        platform, 
        url, 
        campaign, 
        transactionid,
        last_touch_transactions transactions, 
        last_touch_revenue + ifnull(last_touch_shipping, 0) + ifnull(last_touch_tax, 0) as revenue
    from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_transactions`

),

ga_mcf as (

    select 
        date, 
        client, 
        'First-touch' as attribution,
        channel, 
        platform, 
        '' as url,
        campaign, 
        transactionid, 
        first_touch_transactions as transactions,
        first_touch_revenue as revenue
    from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_mcf_stats`

)


SELECT
    date, 
    a.client client,
    attribution,
    transactionid,
    b.customer_id customer_id,
    b.order_type order_type,
    b.first_order_revenue first_order_revenue,
    b.lifetime_revenue lifetime_revenue,
    channel,
    platform,
    url,
    campaign,
    transactions,
    revenue
FROM (
    SELECT * FROM ga
    UNION ALL
    SELECT * FROM ga_mcf
) a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`customers_by_transaction` b
ON (
    a.client = b.client AND
    a.transactionid = b.order_number
)
2018-04-18 10:12:15,622: Model SQL (segment_proc_customers_products):
SELECT
client,
period,
date,
customer_id,
first_order_date,
first_order_unix_date,
product_type,
recency_days,
frequency,
revenue,
quantity,
aov,
case when recency_days <= 30 and first_order_unix_date >= window_start_unix_date then 'New'
	when frequency = 1 and recency_days <= 90 and aov >= aov_40pct then 'Promising'
	when frequency = 1 then 'One-time Purchaser'
	when frequency >= frequency_90pct and recency_days <= 90 and aov > aov_40pct then 'Whale'
	when recency_days <= 240 and frequency > frequency_50pct then 'Loyal'
	when recency_days <= 90 and frequency > frequency_50pct then 'Potential Loyalists' 
	when recency_days > 240 and frequency > frequency_50pct then 'Defecting Good Customer'	
	when recency_days > recency_50pct and frequency > frequency_50pct then 'Frequent, not Recent'
	when recency_days < recency_50pct and frequency < frequency_50pct then 'Recent, not Frequent'
	else 'Unbucketed' end as segment,
aov_40pct,
frequency_90pct,
frequency_75pct,
frequency_50pct,
recency_50pct
FROM
(
	SELECT 
	a.client client,
	period,
	date,
	a.customer_id customer_id,
	a.product_type product_type,
	b.first_order_date first_order_date,
	b.first_order_unix_date first_order_unix_date,
	window_start_unix_date,
	window_end_unix_date,	
	recency_days,
	frequency,
	revenue,
	quantity,
	aov,
	PERCENTILE_CONT(aov, 0.40) OVER w1 AS aov_40pct,
	PERCENTILE_CONT(frequency, 0.90) OVER w1 AS frequency_90pct,
	PERCENTILE_CONT(frequency, 0.75) OVER w1 AS frequency_75pct,
	PERCENTILE_CONT(frequency, 0.50) OVER w1 AS frequency_50pct,
	PERCENTILE_CONT(recency_days, 0.5) OVER w1 AS recency_50pct
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`customers_products_proc` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`customers_first_purchase_product_type_proc` b
	ON (
		a.client = b.client and
		a.customer_id = b.customer_id and
		a.product_type = b.product_type
		)
	WINDOW w1 as (PARTITION BY a.client, period, date, a.product_type)
)
2018-04-18 10:12:18,877: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1075124a8>]}
2018-04-18 10:12:19,125: 10:12:19 | 52 of 92 OK created table model agency_data_pipeline.segment_stats_sku [CREATE TABLE in 4.47s]
2018-04-18 10:12:21,043: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1074dd3c8>]}
2018-04-18 10:12:21,069: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107512f98>]}
2018-04-18 10:12:21,325: 10:12:21 | 53 of 92 OK created table model agency_data_pipeline.agg_ga_transaction [CREATE TABLE in 6.64s]
2018-04-18 10:12:21,551: 10:12:21 | 55 of 92 OK created table model agency_data_pipeline.agg_transaction. [CREATE TABLE in 6.67s]
2018-04-18 10:12:49,225: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1075617b8>]}
2018-04-18 10:12:49,522: 10:12:49 | 54 of 92 OK created table model agency_data_pipeline.segment_proc_customers_products [CREATE TABLE in 34.82s]
2018-04-18 10:12:49,523: 10:12:49 | 56 of 92 START table model agency_data_pipeline.order_paths_stats.... [RUN]
2018-04-18 10:12:49,524: 10:12:49 | 57 of 92 START table model agency_data_pipeline.segment_stats_category [RUN]
2018-04-18 10:12:49,524: Compiling model.agency_data_pipeline.order_paths_stats
2018-04-18 10:12:49,524: 10:12:49 | 58 of 92 START table model agency_data_pipeline.segment_stats_customers_products_agg [RUN]
2018-04-18 10:12:49,524: 10:12:49 | 59 of 92 START table model agency_data_pipeline.agg_ga_campaign_by_type [RUN]
2018-04-18 10:12:49,524: Compiling model.agency_data_pipeline.segment_stats_category
2018-04-18 10:12:49,532: Writing injected SQL for node "model.agency_data_pipeline.order_paths_stats"
2018-04-18 10:12:49,532: Compiling model.agency_data_pipeline.segment_stats_customers_products_agg
2018-04-18 10:12:49,532: Compiling model.agency_data_pipeline.agg_ga_campaign_by_type
2018-04-18 10:12:49,539: Writing injected SQL for node "model.agency_data_pipeline.segment_stats_category"
2018-04-18 10:12:49,554: Writing injected SQL for node "model.agency_data_pipeline.agg_ga_campaign_by_type"
2018-04-18 10:12:49,556: Writing injected SQL for node "model.agency_data_pipeline.segment_stats_customers_products_agg"
2018-04-18 10:12:49,558: Acquiring new bigquery connection "order_paths_stats".
2018-04-18 10:12:49,559: Acquiring new bigquery connection "segment_stats_category".
2018-04-18 10:12:49,560: Acquiring new bigquery connection "agg_ga_campaign_by_type".
2018-04-18 10:12:49,560: Re-using an available connection from the pool.
2018-04-18 10:12:49,561: Acquiring new bigquery connection "segment_stats_customers_products_agg".
2018-04-18 10:12:49,562: Re-using an available connection from the pool.
2018-04-18 10:12:49,565: Re-using an available connection from the pool.
2018-04-18 10:12:49,575: Re-using an available connection from the pool.
2018-04-18 10:12:50,635: Model SQL (segment_stats_category):
SELECT
client,
product_type,
date,
segment_30,
segment_90,
segment_yoy_30,
ifnull(sum(customers_30), 0) customers_30,
ifnull(sum(orders_30), 0) orders_30,
ifnull(sum(revenue_30), 0) revenue_30,
ifnull(sum(customers_90), 0) customers_90,
ifnull(sum(orders_90), 0) orders_90,
ifnull(sum(revenue_90), 0) revenue_90,
ifnull(sum(customers_yoy_30), 0) customers_yoy_30,
ifnull(sum(orders_yoy_30), 0) orders_yoy_30,
ifnull(sum(revenue_yoy_30), 0) revenue_yoy_30
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`segment_stats_sku`
GROUP BY client, product_type, date, segment_30, segment_90, segment_yoy_30
2018-04-18 10:12:50,639: Model SQL (agg_ga_campaign_by_type):
with orders_new as (
    select 
    date, 
    client, 
    attribution,
    channel, 
    platform, 
    url, 
    campaign,
    count(distinct(customer_id)) customers_new,
    sum(transactions) transactions_new,
    sum(revenue) revenue_new,
    sum(first_order_revenue) first_order_revenue_new,
    sum(lifetime_revenue) lifetime_revenue_new,
    null as customers_total,
    null as transactions_total,
    null as revenue_total
    from `growth-engines-pipeline`.`agency_data_pipeline`.`agg_ga_transaction`
    where order_type = 'New'
    group by date, client, attribution, channel, platform, url, campaign
),
    
orders_total as (
    select 
    date, 
    client, 
    attribution,
    channel, 
    platform, 
    url, 
    campaign,
    null as customers_new,
    null as transactions_new,
    null as revenue_new,
    null as first_order_revenue_new,
    null as lifetime_revenue_new,
    count(distinct(customer_id)) customers_total,
    sum(transactions) transactions_total,
    sum(revenue) revenue_total
    from `growth-engines-pipeline`.`agency_data_pipeline`.`agg_ga_transaction`
    group by date, client, attribution, channel, platform, url, campaign

)

SELECT 
date, 
client, 
attribution,
channel, 
platform, 
url, 
campaign,
sum(customers_new) customers_new,
sum(transactions_new) transactions_new,
sum(revenue_new) revenue_new,
sum(first_order_revenue_new) first_order_revenue_new,
sum(lifetime_revenue_new) lifetime_revenue_new,
sum(customers_total) customers_total,
sum(transactions_total) transactions_total,
sum(revenue_total) revenue_total
from
    ( 
        SELECT * FROM orders_new
        UNION ALL 
        SELECT * FROM orders_total
    )
group by date, client, attribution, channel, platform, url, campaign
2018-04-18 10:12:50,688: Model SQL (segment_stats_customers_products_agg):
WITH ty as (

	SELECT
	client,
	date,
	customer_id,
	product_type,
	segment as segment_365,
	recency_days as recency_365,
	frequency as frequency_365,
	revenue as revenue_365,
	aov as aov_365,
	'' as segment_mom,
	0 as recency_mom,
	0 as frequency_mom,
	0 as revenue_mom,
	0 as aov_mom,
	'' as segment_yoy,
	0 as recency_yoy,
	0 as frequency_yoy,
	0 as revenue_yoy,
	0 as aov_yoy
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers_products`
	WHERE period = 'Rolling 365'

),

last_month as (

	SELECT
	client,
	date,
	customer_id,
	product_type,
	'' as segment_365,
	0 as recency_365,
	0 as frequency_365,
	0 as revenue_365,
	0 as aov_365,
	segment as segment_mom,
	recency_days as recency_mom,
	frequency as frequency_mom,
	revenue as revenue_mom,
	aov as aov_mom,
	'' as segment_yoy,
	0 as recency_yoy,
	0 as frequency_yoy,
	0 as revenue_yoy,
	0 as aov_yoy
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers_products`
	WHERE period = 'Rolling 365 (t-1mo)'

),

this_month_1yr as (

	SELECT
	client,
	date,
	customer_id,
	product_type,
	'' as segment_365,
	0 as recency_365,
	0 as frequency_365,
	0 as revenue_365,
	0 as aov_365,
	'' as segment_mom,
	0 as recency_mom,
	0 as frequency_mom,
	0 as revenue_mom,
	0 as aov_mom,
	segment as segment_yoy,
	recency_days as recency_yoy,
	frequency as frequency_yoy,
	revenue as revenue_yoy,
	aov as aov_yoy
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers_products`
	WHERE period = 'Rolling 365 (t-1yr)'


)

SELECT
client,
date, 
customer_id,
product_type,
ifnull(max(segment_365), '') segment_365,
ifnull(max(segment_mom), '') segment_mom,
ifnull(max(segment_yoy), '') segment_yoy,
ifnull(sum(recency_365), 0) recency_365,
ifnull(sum(frequency_365), 0) frequency_365,
ifnull(sum(revenue_365), 0) revenue_365,
ifnull(sum(aov_365), 0) aov_365,
ifnull(sum(recency_mom), 0) recency_mom,
ifnull(sum(frequency_mom), 0) frequency_mom,
ifnull(sum(revenue_mom), 0) revenue_mom,
ifnull(sum(aov_mom), 0) aov_mom,	
ifnull(sum(recency_yoy), 0) recency_yoy,
ifnull(sum(frequency_yoy), 0) frequency_yoy,
ifnull(sum(revenue_yoy), 0) revenue_yoy,
ifnull(sum(aov_yoy), 0) aov_yoy
FROM
(
	SELECT * FROM ty
	UNION ALL
	SELECT * FROM last_month
	UNION ALL
	SELECT * FROM this_month_1yr

)
GROUP BY client, date, customer_id, product_type
2018-04-18 10:12:50,697: Model SQL (order_paths_stats):
WITH transactions AS (
  SELECT 
  client, 
  first_product_type,
  second_product_type,
  first_purchase_date,
  customer_count,
  second_orders,
  third_orders,
  fourth_orders,
  fifth_orders,
  second_order_latency_days,
  third_order_latency_days,
  fourth_order_latency_days,
  fifth_order_latency_days,
  first_order_revenue,
  second_order_revenue,
  unix_date(cast(first_purchase_date as date)) d
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`order_paths_agg`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)

SELECT 
client,
'Rolling 365' as period,
first_product_type,
second_product_type,
date_in_range date,
unix_date_in_range, 
sum(customer_count) customer_count,
sum(second_orders) second_orders,
sum(third_orders) third_orders,
sum(fourth_orders) fourth_orders,
sum(fifth_orders) fifth_orders,
sum(second_order_latency_days) second_order_latency_days,
sum(third_order_latency_days) third_order_latency_days,
sum(fourth_order_latency_days) fourth_order_latency_days,
sum(fifth_order_latency_days) fifth_order_latency_days,
sum(first_order_revenue) first_order_revenue,
sum(second_order_revenue) second_order_revenue
FROM daterange
JOIN transactions
ON transactions.d > ( daterange.unix_date_in_range - 365 )
AND transactions.d <= daterange.unix_date_in_range
group by client, first_product_type, second_product_type, date_in_range, unix_date_in_range
2018-04-18 10:12:51,758: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107512be0>]}
2018-04-18 10:12:52,022: 10:12:52 | 57 of 92 OK created table model agency_data_pipeline.segment_stats_category [CREATE TABLE in 2.23s]
2018-04-18 10:12:52,022: 10:12:52 | 60 of 92 START table model agency_data_pipeline.agg_transaction_daily [RUN]
2018-04-18 10:12:52,023: Compiling model.agency_data_pipeline.agg_transaction_daily
2018-04-18 10:12:52,027: Writing injected SQL for node "model.agency_data_pipeline.agg_transaction_daily"
2018-04-18 10:12:52,028: Acquiring new bigquery connection "agg_transaction_daily".
2018-04-18 10:12:52,028: Re-using an available connection from the pool.
2018-04-18 10:12:52,891: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1074b0dd8>]}
2018-04-18 10:12:52,902: Model SQL (agg_transaction_daily):
SELECT
client,
date,
customer_id,
sum(last_touch_transactions) last_touch_transactions, 
sum(last_touch_revenue) last_touch_revenue, 
sum(first_touch_transactions) first_touch_transactions, 
sum(first_touch_revenue) first_touch_revenue,
sum(quantity) quantity,
sum(revenue) revenue,
count(distinct(order_number)) order_count
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction`
GROUP BY
client, 
date, 
customer_id
2018-04-18 10:12:53,152: 10:12:53 | 56 of 92 OK created table model agency_data_pipeline.order_paths_stats [CREATE TABLE in 3.37s]
2018-04-18 10:12:53,152: 10:12:53 | 61 of 92 START table model agency_data_pipeline.customers_first_purchase_proc [RUN]
2018-04-18 10:12:53,152: Compiling model.agency_data_pipeline.customers_first_purchase_proc
2018-04-18 10:12:53,157: Writing injected SQL for node "model.agency_data_pipeline.customers_first_purchase_proc"
2018-04-18 10:12:53,160: Acquiring new bigquery connection "customers_first_purchase_proc".
2018-04-18 10:12:53,161: Re-using an available connection from the pool.
2018-04-18 10:12:53,872: Model SQL (customers_first_purchase_proc):
SELECT 
client, 
customer_id, 
min(cast(date as date)) first_order_date,
unix_date( min(cast(date as date))) first_order_unix_date
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction`
GROUP BY client, customer_id
2018-04-18 10:12:56,075: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1074b0dd8>]}
2018-04-18 10:12:56,356: 10:12:56 | 61 of 92 OK created table model agency_data_pipeline.customers_first_purchase_proc [CREATE TABLE in 2.92s]
2018-04-18 10:12:57,223: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107561080>]}
2018-04-18 10:12:57,464: 10:12:57 | 59 of 92 OK created table model agency_data_pipeline.agg_ga_campaign_by_type [CREATE TABLE in 7.69s]
2018-04-18 10:13:00,686: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1074b0be0>]}
2018-04-18 10:13:00,933: 10:13:00 | 60 of 92 OK created table model agency_data_pipeline.agg_transaction_daily [CREATE TABLE in 8.66s]
2018-04-18 10:13:20,884: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107556f98>]}
2018-04-18 10:13:21,569: 10:13:21 | 58 of 92 OK created table model agency_data_pipeline.segment_stats_customers_products_agg [CREATE TABLE in 31.35s]
2018-04-18 10:13:21,571: 10:13:21 | 62 of 92 START table model agency_data_pipeline.growth_customer_0_365 [RUN]
2018-04-18 10:13:21,571: Compiling model.agency_data_pipeline.growth_customer_0_365
2018-04-18 10:13:21,571: 10:13:21 | 63 of 92 START table model agency_data_pipeline.customers_proc....... [RUN]
2018-04-18 10:13:21,571: 10:13:21 | 64 of 92 START table model agency_data_pipeline.segment_stats_customers_products [RUN]
2018-04-18 10:13:21,580: Writing injected SQL for node "model.agency_data_pipeline.growth_customer_0_365"
2018-04-18 10:13:21,580: Compiling model.agency_data_pipeline.customers_proc
2018-04-18 10:13:21,580: Compiling model.agency_data_pipeline.segment_stats_customers_products
2018-04-18 10:13:21,593: Writing injected SQL for node "model.agency_data_pipeline.customers_proc"
2018-04-18 10:13:21,595: Writing injected SQL for node "model.agency_data_pipeline.segment_stats_customers_products"
2018-04-18 10:13:21,597: Acquiring new bigquery connection "customers_proc".
2018-04-18 10:13:21,597: Re-using an available connection from the pool.
2018-04-18 10:13:21,602: Acquiring new bigquery connection "segment_stats_customers_products".
2018-04-18 10:13:21,603: Re-using an available connection from the pool.
2018-04-18 10:13:21,605: Acquiring new bigquery connection "growth_customer_0_365".
2018-04-18 10:13:21,605: Re-using an available connection from the pool.
2018-04-18 10:13:22,599: Model SQL (segment_stats_customers_products):
SELECT
client,
date,
product_type,
segment_365,
segment_mom,
segment_yoy,
count(distinct(customer_id)) customers,
avg(recency_365) recency_365,
sum(frequency_365) frequency_365,
sum(revenue_365) revenue_365,
case when sum(frequency_365) > 0 then sum(revenue_365)/sum(frequency_365) else null end as aov_365,
avg(recency_mom) recency_mom,
sum(frequency_mom) frequency_mom,
sum(revenue_mom) revenue_mom,
case when sum(frequency_mom) > 0 then sum(revenue_mom)/sum(frequency_mom) else null end as aov_mom,
avg(recency_yoy) recency_yoy,
sum(frequency_yoy) frequency_yoy,
sum(revenue_yoy) revenue_yoy,
case when sum(frequency_yoy) > 0 then sum(revenue_yoy)/sum(frequency_yoy) else null end as aov_yoy
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_stats_customers_products_agg`
GROUP BY client, date, product_type, segment_365, segment_mom, segment_yoy
2018-04-18 10:13:22,652: Model SQL (customers_proc):
WITH customers AS (
  SELECT 
  client, 
  customer_id, 
  order_number,
  cast(date as date) order_date,
  unix_date(cast(date as date)) unix_order_date, 
  quantity,
  revenue 
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)
 
SELECT 
client,
period,
customer_id,
date,
window_end_unix_date,
window_end_unix_date - 365 as window_start_unix_date,
window_end_unix_date - unix_date(recent_order) recency_days,
frequency,
quantity,
revenue,
case when frequency > 0 then revenue/frequency else 0 end as aov
FROM 
(  

  SELECT 
  client,
  'Rolling 365' as period,
  customer_id,
  date_in_range date,
  unix_date_in_range,
  unix_date_in_range window_end_unix_date,
  max(order_date) recent_order,
  sum(quantity) as quantity,
  sum(revenue) as revenue,
  count(distinct(order_number)) as frequency
  FROM daterange
  JOIN customers
  ON customers.unix_order_date > ( daterange.unix_date_in_range - 365 )
  AND customers.unix_order_date <= daterange.unix_date_in_range
  GROUP BY client, customer_id, date, unix_date_in_range

  UNION ALL

  SELECT 
  client,
  'Rolling 365 (t-1mo)' as period,
  customer_id,
  date_in_range date,
  unix_date_in_range,
  unix_date_in_range - 30 window_end_unix_date, 
  max(order_date) recent_order,
  sum(quantity) as quantity,
  sum(revenue) as revenue,
  count(distinct(order_number)) as frequency
  FROM daterange
  JOIN customers
  ON customers.unix_order_date > ( daterange.unix_date_in_range - 395 )
  AND customers.unix_order_date <= ( daterange.unix_date_in_range - 30 )
  GROUP BY client, customer_id, date, unix_date_in_range

  UNION ALL

  SELECT 
  client,
  'Rolling 365 (t-1yr)' as period,
  customer_id,
  date_in_range date,
  unix_date_in_range, 
  unix_date_in_range - 365 window_end_unix_date, 
  max(order_date) recent_order,
  sum(quantity) as quantity,
  sum(revenue) as revenue,
  count(distinct(order_number)) as frequency
  FROM daterange
  JOIN customers
  ON customers.unix_order_date > ( daterange.unix_date_in_range - 730 )
  AND customers.unix_order_date <= ( daterange.unix_date_in_range - 365 )
  GROUP BY client, customer_id, date, unix_date_in_range

)
2018-04-18 10:13:22,690: Model SQL (growth_customer_0_365):
WITH transactions AS (
  SELECT 
  client, 
  customer_id, 
  order_number,
  unix_date(cast(date as date)) d, 
  quantity,
  revenue,
  shipping_revenue
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)

SELECT 
date_in_range date,
unix_date_in_range, 
unix_date_in_range_yoy, 
client, 
customer_id,
count(distinct(order_number)) orders,
sum(quantity) quantity,
sum(revenue) revenue,
sum(shipping_revenue) shipping_revenue
FROM daterange
JOIN transactions
ON transactions.d >= ( daterange.unix_date_in_range - 365 ) 
AND transactions.d <= daterange.unix_date_in_range
GROUP BY date, unix_date_in_range, unix_date_in_range_yoy, client, customer_id
2018-04-18 10:13:36,156: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107512908>]}
2018-04-18 10:13:36,403: 10:13:36 | 64 of 92 OK created table model agency_data_pipeline.segment_stats_customers_products [CREATE TABLE in 14.58s]
2018-04-18 10:13:41,560: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10aa17940>]}
2018-04-18 10:13:41,779: 10:13:41 | 62 of 92 OK created table model agency_data_pipeline.growth_customer_0_365 [CREATE TABLE in 19.99s]
2018-04-18 10:13:52,868: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10754f828>]}
2018-04-18 10:13:56,216: 10:13:56 | 63 of 92 OK created table model agency_data_pipeline.customers_proc.. [CREATE TABLE in 31.29s]
2018-04-18 10:13:56,217: 10:13:56 | 65 of 92 START table model agency_data_pipeline.retention_365_730.... [RUN]
2018-04-18 10:13:56,217: 10:13:56 | 66 of 92 START table model agency_data_pipeline.retention_0_30....... [RUN]
2018-04-18 10:13:56,217: Compiling model.agency_data_pipeline.retention_365_730
2018-04-18 10:13:56,217: 10:13:56 | 67 of 92 START table model agency_data_pipeline.segment_list_customers_products [RUN]
2018-04-18 10:13:56,217: 10:13:56 | 68 of 92 START table model agency_data_pipeline.retention_0_365...... [RUN]
2018-04-18 10:13:56,218: Compiling model.agency_data_pipeline.retention_0_30
2018-04-18 10:13:56,225: Writing injected SQL for node "model.agency_data_pipeline.retention_365_730"
2018-04-18 10:13:56,225: Compiling model.agency_data_pipeline.segment_list_customers_products
2018-04-18 10:13:56,225: Compiling model.agency_data_pipeline.retention_0_365
2018-04-18 10:13:56,230: Writing injected SQL for node "model.agency_data_pipeline.retention_0_30"
2018-04-18 10:13:56,235: Writing injected SQL for node "model.agency_data_pipeline.segment_list_customers_products"
2018-04-18 10:13:56,242: Writing injected SQL for node "model.agency_data_pipeline.retention_0_365"
2018-04-18 10:13:56,246: Acquiring new bigquery connection "retention_365_730".
2018-04-18 10:13:56,246: Re-using an available connection from the pool.
2018-04-18 10:13:56,247: Acquiring new bigquery connection "retention_0_30".
2018-04-18 10:13:56,248: Acquiring new bigquery connection "retention_0_365".
2018-04-18 10:13:56,249: Re-using an available connection from the pool.
2018-04-18 10:13:56,250: Re-using an available connection from the pool.
2018-04-18 10:13:56,251: Acquiring new bigquery connection "segment_list_customers_products".
2018-04-18 10:13:56,255: Re-using an available connection from the pool.
2018-04-18 10:13:57,175: Model SQL (retention_0_365):
WITH transactions AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_daily`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
),

temp AS (
  SELECT 
  client, 
  customer_id, 
  unix_date(date) d, 
  quantity,
  revenue,
  order_count
  FROM transactions
)

SELECT 
date_in_range date,
unix_date_in_range, 
client, 
customer_id,
sum(quantity) quantity,
sum(revenue) revenue,
sum(order_count) order_count
FROM daterange
JOIN temp
ON temp.d >= ( daterange.unix_date_in_range - 365 ) 
AND temp.d <= daterange.unix_date_in_range
group by date_in_range, unix_date_in_range, client, customer_id
2018-04-18 10:13:57,189: Model SQL (retention_0_30):
WITH transactions AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_daily`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
),

temp AS (
  SELECT 
  client, 
  customer_id, 
  unix_date(date) d, 
  quantity,
  revenue,
  order_count
  FROM transactions
)

SELECT 
date_in_range date,
unix_date_in_range, 
client, 
customer_id,
sum(quantity) quantity,
sum(revenue) revenue,
sum(order_count) order_count
FROM daterange
JOIN temp
ON temp.d >= ( daterange.unix_date_in_range_bom ) 
AND temp.d <= daterange.unix_date_in_range
group by date_in_range, unix_date_in_range, client, customer_id
2018-04-18 10:13:57,192: Model SQL (retention_365_730):
WITH transactions AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_daily`
),

daterange AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`  	
),

temp AS (
  SELECT 
  client, 
  customer_id, 
  unix_date(date) d, 
  quantity,
  revenue,
  order_count
  FROM transactions
)

SELECT 
date_in_range date, 
unix_date_in_range,
client, 
customer_id,
sum(quantity) quantity,
sum(revenue) revenue,
sum(order_count) order_count
FROM daterange
JOIN temp
ON ( temp.d >= ( daterange.unix_date_in_range - 730 ) 
AND temp.d < ( daterange.unix_date_in_range - 365 ) )
group by date_in_range, unix_date_in_range, client, customer_id
2018-04-18 10:13:57,226: Model SQL (segment_list_customers_products):
SELECT
a.client,
period,
date,
customer_id,
product_type,
b.first_name,
b.last_name,
b.email,
recency_days,
frequency,
revenue,
quantity,
aov,
segment
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers_products` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`agg_customers_union` b
ON (
	a.client = b.client AND
	a.customer_id = b.id
)
2018-04-18 10:14:01,649: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10aa5b240>]}
2018-04-18 10:14:01,655: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ce04208>]}
2018-04-18 10:14:02,364: 10:14:02 | 65 of 92 OK created table model agency_data_pipeline.retention_365_730 [CREATE TABLE in 5.43s]
2018-04-18 10:14:02,366: 10:14:02 | 69 of 92 START table model agency_data_pipeline.retention_60_plus.... [RUN]
2018-04-18 10:14:02,367: Compiling model.agency_data_pipeline.retention_60_plus
2018-04-18 10:14:02,372: Writing injected SQL for node "model.agency_data_pipeline.retention_60_plus"
2018-04-18 10:14:02,374: Acquiring new bigquery connection "retention_60_plus".
2018-04-18 10:14:02,374: Re-using an available connection from the pool.
2018-04-18 10:14:02,628: 10:14:02 | 66 of 92 OK created table model agency_data_pipeline.retention_0_30.. [CREATE TABLE in 5.44s]
2018-04-18 10:14:02,629: 10:14:02 | 70 of 92 START table model agency_data_pipeline.retention_730_plus... [RUN]
2018-04-18 10:14:02,632: Compiling model.agency_data_pipeline.retention_730_plus
2018-04-18 10:14:02,643: Writing injected SQL for node "model.agency_data_pipeline.retention_730_plus"
2018-04-18 10:14:02,644: Acquiring new bigquery connection "retention_730_plus".
2018-04-18 10:14:02,644: Re-using an available connection from the pool.
2018-04-18 10:14:03,395: Model SQL (retention_60_plus):
WITH transactions AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_daily`
),

daterange AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`  	
),

temp AS (
  SELECT 
  client, 
  customer_id, 
  unix_date(date) d, 
  quantity,
  revenue,
  order_count
  FROM transactions
)

SELECT 
date_in_range date, 
unix_date_in_range,
client, 
customer_id,
sum(quantity) quantity,
sum(revenue) revenue,
sum(order_count) order_count
FROM daterange
JOIN temp
ON temp.d < ( daterange.unix_date_in_range_bom_mom ) 
group by date_in_range, unix_date_in_range, client, customer_id
2018-04-18 10:14:03,521: Model SQL (retention_730_plus):
WITH transactions AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_daily`
),

daterange AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`  	
),

temp AS (
  SELECT 
  client, 
  customer_id, 
  unix_date(date) d, 
  quantity,
  revenue,
  order_count
  FROM transactions
)

SELECT 
date_in_range date, 
unix_date_in_range,
client, 
customer_id,
sum(quantity) quantity,
sum(revenue) revenue,
sum(order_count) order_count
FROM daterange
JOIN temp
ON temp.d <= ( daterange.unix_date_in_range - 730 ) 
group by date_in_range, unix_date_in_range, client, customer_id
2018-04-18 10:14:05,730: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1074b01d0>]}
2018-04-18 10:14:06,126: 10:14:06 | 70 of 92 OK created table model agency_data_pipeline.retention_730_plus [CREATE TABLE in 3.10s]
2018-04-18 10:14:06,127: 10:14:06 | 71 of 92 START table model agency_data_pipeline.retention_30_60...... [RUN]
2018-04-18 10:14:06,128: Compiling model.agency_data_pipeline.retention_30_60
2018-04-18 10:14:06,135: Writing injected SQL for node "model.agency_data_pipeline.retention_30_60"
2018-04-18 10:14:06,136: Acquiring new bigquery connection "retention_30_60".
2018-04-18 10:14:06,136: Re-using an available connection from the pool.
2018-04-18 10:14:06,831: Model SQL (retention_30_60):
WITH transactions AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_daily`
),

daterange AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`  	
),

temp AS (
  SELECT 
  client, 
  customer_id, 
  unix_date(date) d, 
  quantity,
  revenue,
  order_count
  FROM transactions
)

SELECT 
date_in_range date, 
unix_date_in_range,
client, 
customer_id,
sum(quantity) quantity,
sum(revenue) revenue,
sum(order_count) order_count
FROM daterange
JOIN temp
ON ( temp.d >= ( daterange.unix_date_in_range_bom_mom ) 
AND temp.d < ( daterange.unix_date_in_range_bom ) )
group by date_in_range, unix_date_in_range, client, customer_id
2018-04-18 10:14:09,409: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107512630>]}
2018-04-18 10:14:09,705: 10:14:09 | 68 of 92 OK created table model agency_data_pipeline.retention_0_365. [CREATE TABLE in 13.18s]
2018-04-18 10:14:10,377: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1074b01d0>]}
2018-04-18 10:14:10,626: 10:14:10 | 71 of 92 OK created table model agency_data_pipeline.retention_30_60. [CREATE TABLE in 4.25s]
2018-04-18 10:14:14,594: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10aa5b240>]}
2018-04-18 10:14:14,846: 10:14:14 | 69 of 92 OK created table model agency_data_pipeline.retention_60_plus [CREATE TABLE in 12.23s]
2018-04-18 10:14:42,029: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1074c4780>]}
2018-04-18 10:14:43,149: 10:14:43 | 67 of 92 OK created table model agency_data_pipeline.segment_list_customers_products [CREATE TABLE in 45.80s]
2018-04-18 10:14:43,150: 10:14:43 | 72 of 92 START table model agency_data_pipeline.segment_proc_customers [RUN]
2018-04-18 10:14:43,150: 10:14:43 | 73 of 92 START table model agency_data_pipeline.agg_platforms_union.. [RUN]
2018-04-18 10:14:43,150: Compiling model.agency_data_pipeline.segment_proc_customers
2018-04-18 10:14:43,150: Compiling model.agency_data_pipeline.agg_platforms_union
2018-04-18 10:14:43,162: Writing injected SQL for node "model.agency_data_pipeline.segment_proc_customers"
2018-04-18 10:14:43,163: Writing injected SQL for node "model.agency_data_pipeline.agg_platforms_union"
2018-04-18 10:14:43,166: Acquiring new bigquery connection "segment_proc_customers".
2018-04-18 10:14:43,166: Re-using an available connection from the pool.
2018-04-18 10:14:43,167: Acquiring new bigquery connection "agg_platforms_union".
2018-04-18 10:14:43,167: Re-using an available connection from the pool.
2018-04-18 10:14:46,033: Model SQL (segment_proc_customers):
SELECT
client,
period,
date,
customer_id,
first_order_date,
first_order_unix_date,
recency_days,
frequency,
revenue,
quantity,
aov,
case when recency_days <= 30 and first_order_unix_date >= window_start_unix_date then 'New'
	when frequency = 1 and recency_days <= 90 and aov >= aov_40pct then 'Promising'
	when frequency = 1 then 'One-time Purchaser'
	when frequency >= frequency_90pct and recency_days <= 90 and aov > aov_40pct then 'Whale'
	when recency_days <= 240 and frequency > frequency_50pct then 'Loyal'
	when recency_days <= 90 and frequency > frequency_50pct then 'Potential Loyalists' 
	when recency_days > 240 and frequency > frequency_50pct then 'Defecting Good Customer'	
	when recency_days > recency_50pct and frequency > frequency_50pct then 'Frequent, not Recent'
	when recency_days < recency_50pct and frequency < frequency_50pct then 'Recent, not Frequent'
	else 'Unbucketed' end as segment,
aov_40pct,
frequency_90pct,
frequency_75pct,
frequency_50pct,
recency_50pct
FROM
(
	SELECT 
	a.client client,
	period,
	date,
	a.customer_id customer_id,
	b.first_order_date first_order_date,
	b.first_order_unix_date first_order_unix_date,
	window_start_unix_date,
	window_end_unix_date,
	recency_days,
	frequency,
	revenue,
	quantity,
	aov,
	PERCENTILE_CONT(aov, 0.40) OVER w1 AS aov_40pct,
	PERCENTILE_CONT(frequency, 0.90) OVER w1 AS frequency_90pct,
	PERCENTILE_CONT(frequency, 0.75) OVER w1 AS frequency_75pct,
	PERCENTILE_CONT(frequency, 0.50) OVER w1 AS frequency_50pct,
	PERCENTILE_CONT(recency_days, 0.5) OVER w1 AS recency_50pct
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`customers_proc` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`customers_first_purchase_proc` b
	ON (
		a.client = b.client and
		a.customer_id = b.customer_id
		)
	WINDOW w1 as (PARTITION BY a.client, period, date)
)
2018-04-18 10:14:46,042: Model SQL (agg_platforms_union):
SELECT 
date, 
account, 
channel,
platform,
url,
utm_campaign,
campaign,
cost,
impressions,
clicks,
transactions
FROM 
`growth-engines-pipeline`.`agency_data_pipeline`.`adwords_stats`

UNION ALL

SELECT 
date, 
account, 
channel,
platform,
url,
utm_campaign,
campaign,
cost,
impressions,
clicks,
transactions
FROM 
`growth-engines-pipeline`.`agency_data_pipeline`.`bing_ads_stats`

UNION ALL  

SELECT 
date, 
account, 
channel,
platform,
url,
utm_campaign,
campaign,
cost,
impressions,
clicks,
transactions
FROM 
`growth-engines-pipeline`.`agency_data_pipeline`.`fb_ads_stats`
2018-04-18 10:14:50,593: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107512630>]}
2018-04-18 10:14:50,843: 10:14:50 | 73 of 92 OK created table model agency_data_pipeline.agg_platforms_union [CREATE TABLE in 7.44s]
2018-04-18 10:15:15,122: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1074ddac8>]}
2018-04-18 10:15:15,744: 10:15:15 | 72 of 92 OK created table model agency_data_pipeline.segment_proc_customers [CREATE TABLE in 31.97s]
2018-04-18 10:15:15,746: 10:15:15 | 74 of 92 START table model agency_data_pipeline.retention_0_365_rebuy [RUN]
2018-04-18 10:15:15,747: 10:15:15 | 75 of 92 START table model agency_data_pipeline.segment_stats_customers_agg [RUN]
2018-04-18 10:15:15,747: Compiling model.agency_data_pipeline.retention_0_365_rebuy
2018-04-18 10:15:15,747: 10:15:15 | 76 of 92 START table model agency_data_pipeline.retention_0_30_rebuy. [RUN]
2018-04-18 10:15:15,748: Compiling model.agency_data_pipeline.segment_stats_customers_agg
2018-04-18 10:15:15,755: Compiling model.agency_data_pipeline.retention_0_30_rebuy
2018-04-18 10:15:15,768: Writing injected SQL for node "model.agency_data_pipeline.retention_0_365_rebuy"
2018-04-18 10:15:15,790: Writing injected SQL for node "model.agency_data_pipeline.segment_stats_customers_agg"
2018-04-18 10:15:15,797: Writing injected SQL for node "model.agency_data_pipeline.retention_0_30_rebuy"
2018-04-18 10:15:15,801: Acquiring new bigquery connection "retention_0_365_rebuy".
2018-04-18 10:15:15,801: Re-using an available connection from the pool.
2018-04-18 10:15:15,802: Acquiring new bigquery connection "retention_0_30_rebuy".
2018-04-18 10:15:15,803: Acquiring new bigquery connection "segment_stats_customers_agg".
2018-04-18 10:15:15,805: Re-using an available connection from the pool.
2018-04-18 10:15:15,807: Re-using an available connection from the pool.
2018-04-18 10:15:18,969: Model SQL (segment_stats_customers_agg):
WITH ty as (

	SELECT
	client,
	date,
	customer_id,
	segment as segment_365,
	recency_days as recency_365,
	frequency as frequency_365,
	revenue as revenue_365,
	aov as aov_365,
	'' as segment_mom,
	0 as recency_mom,
	0 as frequency_mom,
	0 as revenue_mom,
	0 as aov_mom,
	'' as segment_yoy,
	0 as recency_yoy,
	0 as frequency_yoy,
	0 as revenue_yoy,
	0 as aov_yoy
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers`
	WHERE period = 'Rolling 365'

),

last_month as (

	SELECT
	client,
	date,
	customer_id,
	'' as segment_365,
	0 as recency_365,
	0 as frequency_365,
	0 as revenue_365,
	0 as aov_365,
	segment as segment_mom,
	recency_days as recency_mom,
	frequency as frequency_mom,
	revenue as revenue_mom,
	aov as aov_mom,
	'' as segment_yoy,
	0 as recency_yoy,
	0 as frequency_yoy,
	0 as revenue_yoy,
	0 as aov_yoy
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers`
	WHERE period = 'Rolling 365 (t-1mo)'

),

this_month_1yr as (

	SELECT
	client,
	date,
	customer_id,
	'' as segment_365,
	0 as recency_365,
	0 as frequency_365,
	0 as revenue_365,
	0 as aov_365,
	'' as segment_mom,
	0 as recency_mom,
	0 as frequency_mom,
	0 as revenue_mom,
	0 as aov_mom,
	segment as segment_yoy,
	recency_days as recency_yoy,
	frequency as frequency_yoy,
	revenue as revenue_yoy,
	aov as aov_yoy
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers`
	WHERE period = 'Rolling 365 (t-1yr)'


)

SELECT
client,
date, 
customer_id,
ifnull(max(segment_365), '') segment_365,
ifnull(max(segment_mom), '') segment_mom,
ifnull(max(segment_yoy), '') segment_yoy,
ifnull(sum(recency_365), 0) recency_365,
ifnull(sum(frequency_365), 0) frequency_365,
ifnull(sum(revenue_365), 0) revenue_365,
ifnull(sum(aov_365), 0) aov_365,
ifnull(sum(recency_mom), 0) recency_mom,
ifnull(sum(frequency_mom), 0) frequency_mom,
ifnull(sum(revenue_mom), 0) revenue_mom,
ifnull(sum(aov_mom), 0) aov_mom,	
ifnull(sum(recency_yoy), 0) recency_yoy,
ifnull(sum(frequency_yoy), 0) frequency_yoy,
ifnull(sum(revenue_yoy), 0) revenue_yoy,
ifnull(sum(aov_yoy), 0) aov_yoy
FROM
(
	SELECT * FROM ty
	UNION ALL
	SELECT * FROM last_month
	UNION ALL
	SELECT * FROM this_month_1yr

)
GROUP BY client, date, customer_id
2018-04-18 10:15:18,972: Model SQL (retention_0_30_rebuy):
SELECT 
r2.client,
r2.date,
r2.customer_id, 
r2.quantity,
r2.revenue
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_30_60` r1 
left join `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30` r2 
  on ( r1.customer_id = r2.customer_id 
  and r1.date = r2.date )
2018-04-18 10:15:19,000: Model SQL (retention_0_365_rebuy):
SELECT 
r2.client,
r2.date,
r2.customer_id, 
r2.quantity,
r2.revenue
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_365_730` r1 
left join `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365` r2 
  on ( r1.customer_id = r2.customer_id 
  and r1.date = r2.date )
2018-04-18 10:15:22,112: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10aa5b828>]}
2018-04-18 10:15:22,384: 10:15:22 | 76 of 92 OK created table model agency_data_pipeline.retention_0_30_rebuy [CREATE TABLE in 6.36s]
2018-04-18 10:15:25,085: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1074f0358>]}
2018-04-18 10:15:25,328: 10:15:25 | 74 of 92 OK created table model agency_data_pipeline.retention_0_365_rebuy [CREATE TABLE in 9.34s]
2018-04-18 10:15:43,386: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1074efa20>]}
2018-04-18 10:15:43,676: 10:15:43 | 75 of 92 OK created table model agency_data_pipeline.segment_stats_customers_agg [CREATE TABLE in 27.64s]
2018-04-18 10:15:43,678: 10:15:43 | 77 of 92 START table model agency_data_pipeline.retention_stats_rebuy_rate_month [RUN]
2018-04-18 10:15:43,678: Compiling model.agency_data_pipeline.retention_stats_rebuy_rate_month
2018-04-18 10:15:43,692: Writing injected SQL for node "model.agency_data_pipeline.retention_stats_rebuy_rate_month"
2018-04-18 10:15:43,692: 10:15:43 | 78 of 92 START table model agency_data_pipeline.retention_0_365_new.. [RUN]
2018-04-18 10:15:43,693: Compiling model.agency_data_pipeline.retention_0_365_new
2018-04-18 10:15:43,693: 10:15:43 | 79 of 92 START table model agency_data_pipeline.agg_platforms_client. [RUN]
2018-04-18 10:15:43,701: Compiling model.agency_data_pipeline.agg_platforms_client
2018-04-18 10:15:43,716: Writing injected SQL for node "model.agency_data_pipeline.agg_platforms_client"
2018-04-18 10:15:43,701: 10:15:43 | 80 of 92 START table model agency_data_pipeline.retention_stats_rebuy_rate [RUN]
2018-04-18 10:15:43,718: Compiling model.agency_data_pipeline.retention_stats_rebuy_rate
2018-04-18 10:15:43,740: Acquiring new bigquery connection "agg_platforms_client".
2018-04-18 10:15:43,740: Re-using an available connection from the pool.
2018-04-18 10:15:43,746: Writing injected SQL for node "model.agency_data_pipeline.retention_0_365_new"
2018-04-18 10:15:43,751: Acquiring new bigquery connection "retention_0_365_new".
2018-04-18 10:15:43,751: Re-using an available connection from the pool.
2018-04-18 10:15:43,779: Acquiring new bigquery connection "retention_stats_rebuy_rate_month".
2018-04-18 10:15:43,786: Re-using an available connection from the pool.
2018-04-18 10:15:43,791: Writing injected SQL for node "model.agency_data_pipeline.retention_stats_rebuy_rate"
2018-04-18 10:15:43,793: Acquiring new bigquery connection "retention_stats_rebuy_rate".
2018-04-18 10:15:43,793: Re-using an available connection from the pool.
2018-04-18 10:15:46,814: Model SQL (retention_0_365_new):
SELECT 
a.client,
a.date,
a.customer_id, 
a.quantity,
a.revenue,
a.order_count
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_730_plus` b
ON (
	a.client = b.client AND
	a.date = b.date AND
	a.customer_id = b.customer_id
)
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_365_730` c
ON (
	a.client = c.client AND
	a.date = c.date AND
	a.customer_id = c.customer_id
)
WHERE b.customer_id is null 
and c.customer_id is null
2018-04-18 10:15:46,815: Model SQL (agg_platforms_client):
SELECT 
date, 
a.account account, 
b.client client,
a.platform platform,
a.channel channel,
url,
utm_campaign,
campaign,
cost,
impressions,
clicks,
transactions ad_platform_transactions
FROM 
  `growth-engines-pipeline`.`agency_data_pipeline`.`agg_platforms_union` a
LEFT JOIN 
  `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc` b
ON ( 
  a.account = b.account AND
  a.platform = b.platform
)
2018-04-18 10:15:46,827: Model SQL (retention_stats_rebuy_rate):
WITH r1 AS (
	SELECT 
	date,
	client,
	count(distinct customer_id) customers_prior_year,
	0 as customers_current_year, 
	sum(quantity) quantity_prior_year,
	0 as quantity_current_year,
	sum(revenue) revenue_prior_year,
	0 as revenue_current_year,
	case when sum(quantity) > 0 then sum(revenue)/sum(quantity) else null end as aov_prior_year,
	null as aov_current_year
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_365_730`
	group by date, client
),

r2 AS (
	SELECT 
	date,
	client,
	0 as customers_prior_year,
	count(distinct customer_id) customers_current_year, 
	0 as quantity_prior_year,
	sum(quantity) quantity_current_year,
	0 as revenue_prior_year,
	sum(revenue) revenue_current_year,
	null as aov_prior_year,
	case when sum(quantity) > 0 then sum(revenue)/sum(quantity) else null end as aov_current_year
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365_rebuy`
	group by date, client
)

SELECT 
date,
client,
sum(customers_prior_year) customers_prior_year, 
sum(customers_current_year) customers_current_year,
sum(quantity_prior_year) quantity_prior_year,
sum(quantity_current_year) quantity_current_year,
sum(revenue_prior_year) revenue_prior_year,
sum(revenue_current_year) revenue_current_year,
sum(aov_prior_year) aov_prior_year,
sum(aov_current_year) aov_current_year,
case when sum(revenue_prior_year) > 0 then sum(revenue_current_year)/sum(revenue_prior_year) else null end as revenue_retention,
case when sum(customers_prior_year) > 0 then sum(customers_current_year)/sum(customers_prior_year) else null end as customer_retention
FROM
(
	SELECT
	date,
	client,
	customers_prior_year,
	customers_current_year,
	quantity_prior_year,
	quantity_current_year,
	revenue_prior_year,
	revenue_current_year,
	aov_prior_year,
	aov_current_year
	FROM r1

	UNION ALL

	SELECT
	date,
	client,
	customers_prior_year,
	customers_current_year,
	quantity_prior_year,
	quantity_current_year,
	revenue_prior_year,
	revenue_current_year,
	aov_prior_year,
	aov_current_year
	FROM r2

) 
GROUP BY date, client
2018-04-18 10:15:46,946: Model SQL (retention_stats_rebuy_rate_month):
WITH r1 AS (
	SELECT 
	date,
	client,
	count(distinct customer_id) customers_prior_year,
	0 as customers_current_year, 
	sum(quantity) quantity_prior_year,
	0 as quantity_current_year,
	sum(revenue) revenue_prior_year,
	0 as revenue_current_year,
	case when sum(quantity) > 0 then sum(revenue)/sum(quantity) else null end as aov_prior_year,
	null as aov_current_year
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_30_60`
	group by date, client
),

r2 AS (
	SELECT 
	date,
	client,
	0 as customers_prior_year,
	count(distinct customer_id) customers_current_year, 
	0 as quantity_prior_year,
	sum(quantity) quantity_current_year,
	0 as revenue_prior_year,
	sum(revenue) revenue_current_year,
	null as aov_prior_year,
	case when sum(quantity) > 0 then sum(revenue)/sum(quantity) else null end as aov_current_year
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30_rebuy`
	group by date, client
)

SELECT 
date,
client,
sum(customers_prior_year) customers_prior_year, 
sum(customers_current_year) customers_current_year,
sum(quantity_prior_year) quantity_prior_year,
sum(quantity_current_year) quantity_current_year,
sum(revenue_prior_year) revenue_prior_year,
sum(revenue_current_year) revenue_current_year,
sum(aov_prior_year) aov_prior_year,
sum(aov_current_year) aov_current_year,
case when sum(revenue_prior_year) > 0 then sum(revenue_current_year)/sum(revenue_prior_year) else null end as revenue_retention,
case when sum(customers_prior_year) > 0 then sum(customers_current_year)/sum(customers_prior_year) else null end as customer_retention
FROM
(
	SELECT
	date,
	client,
	customers_prior_year,
	customers_current_year,
	quantity_prior_year,
	quantity_current_year,
	revenue_prior_year,
	revenue_current_year,
	aov_prior_year,
	aov_current_year
	FROM r1

	UNION ALL

	SELECT
	date,
	client,
	customers_prior_year,
	customers_current_year,
	quantity_prior_year,
	quantity_current_year,
	revenue_prior_year,
	revenue_current_year,
	aov_prior_year,
	aov_current_year
	FROM r2

) 
GROUP BY date, client
2018-04-18 10:15:49,739: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1074efcf8>]}
2018-04-18 10:15:49,757: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1074d7da0>]}
2018-04-18 10:15:50,470: 10:15:50 | 77 of 92 OK created table model agency_data_pipeline.retention_stats_rebuy_rate_month [CREATE TABLE in 6.06s]
2018-04-18 10:15:50,471: 10:15:50 | 81 of 92 START table model agency_data_pipeline.retention_0_365_reactivated [RUN]
2018-04-18 10:15:50,472: Compiling model.agency_data_pipeline.retention_0_365_reactivated
2018-04-18 10:15:50,484: Writing injected SQL for node "model.agency_data_pipeline.retention_0_365_reactivated"
2018-04-18 10:15:50,490: Acquiring new bigquery connection "retention_0_365_reactivated".
2018-04-18 10:15:50,490: Re-using an available connection from the pool.
2018-04-18 10:15:50,733: 10:15:50 | 80 of 92 OK created table model agency_data_pipeline.retention_stats_rebuy_rate [CREATE TABLE in 6.04s]
2018-04-18 10:15:50,734: 10:15:50 | 82 of 92 START table model agency_data_pipeline.retention_0_30_new... [RUN]
2018-04-18 10:15:50,734: Compiling model.agency_data_pipeline.retention_0_30_new
2018-04-18 10:15:50,768: Writing injected SQL for node "model.agency_data_pipeline.retention_0_30_new"
2018-04-18 10:15:50,770: Acquiring new bigquery connection "retention_0_30_new".
2018-04-18 10:15:50,771: Re-using an available connection from the pool.
2018-04-18 10:15:50,969: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1074b39b0>]}
2018-04-18 10:15:51,242: 10:15:51 | 79 of 92 OK created table model agency_data_pipeline.agg_platforms_client [CREATE TABLE in 7.27s]
2018-04-18 10:15:51,243: 10:15:51 | 83 of 92 START table model agency_data_pipeline.retention_0_30_reactivated [RUN]
2018-04-18 10:15:51,243: Compiling model.agency_data_pipeline.retention_0_30_reactivated
2018-04-18 10:15:51,249: Writing injected SQL for node "model.agency_data_pipeline.retention_0_30_reactivated"
2018-04-18 10:15:51,250: Acquiring new bigquery connection "retention_0_30_reactivated".
2018-04-18 10:15:51,251: Re-using an available connection from the pool.
2018-04-18 10:15:54,016: Model SQL (retention_0_365_reactivated):
SELECT 
a.client,
a.date,
a.customer_id, 
a.quantity,
a.revenue
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_730_plus` b
ON (
	a.client = b.client AND
	a.date = b.date AND
	a.customer_id = b.customer_id
)
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_365_730` c
ON (
	a.client = c.client AND
	a.date = c.date AND
	a.customer_id = c.customer_id
)
WHERE b.customer_id is not null 
AND c.customer_id is null
2018-04-18 10:15:54,019: Model SQL (retention_0_30_new):
SELECT 
a.client,
a.date,
a.customer_id, 
a.quantity,
a.revenue,
a.order_count
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_60_plus` b
ON (
	a.client = b.client AND
	a.date = b.date AND
	a.customer_id = b.customer_id
)
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_30_60` c
ON (
	a.client = c.client AND
	a.date = c.date AND
	a.customer_id = c.customer_id
)
WHERE b.customer_id is null 
and c.customer_id is null
2018-04-18 10:15:54,157: Model SQL (retention_0_30_reactivated):
SELECT 
a.client,
a.date,
a.customer_id, 
a.quantity,
a.revenue
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_60_plus` b
ON (
	a.client = b.client AND
	a.date = b.date AND
	a.customer_id = b.customer_id
)
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_30_60` c
ON (
	a.client = c.client AND
	a.date = c.date AND
	a.customer_id = c.customer_id
)
WHERE b.customer_id is not null 
AND c.customer_id is null
2018-04-18 10:15:55,852: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1074bf748>]}
2018-04-18 10:15:56,118: 10:15:56 | 78 of 92 OK created table model agency_data_pipeline.retention_0_365_new [CREATE TABLE in 12.16s]
2018-04-18 10:15:56,118: 10:15:56 | 84 of 92 START table model agency_data_pipeline.segment_stats_customers [RUN]
2018-04-18 10:15:56,119: Compiling model.agency_data_pipeline.segment_stats_customers
2018-04-18 10:15:56,124: Writing injected SQL for node "model.agency_data_pipeline.segment_stats_customers"
2018-04-18 10:15:56,125: Acquiring new bigquery connection "segment_stats_customers".
2018-04-18 10:15:56,125: Re-using an available connection from the pool.
2018-04-18 10:15:56,840: Model SQL (segment_stats_customers):
SELECT
client,
date,
segment_365,
segment_mom,
segment_yoy,
count(distinct(customer_id)) customers,
avg(recency_365) recency_365,
sum(frequency_365) frequency_365,
sum(revenue_365) revenue_365,
case when sum(frequency_365) > 0 then sum(revenue_365)/sum(frequency_365) else null end as aov_365,
avg(recency_mom) recency_mom,
sum(frequency_mom) frequency_mom,
sum(revenue_mom) revenue_mom,
case when sum(frequency_mom) > 0 then sum(revenue_mom)/sum(frequency_mom) else null end as aov_mom,
avg(recency_yoy) recency_yoy,
sum(frequency_yoy) frequency_yoy,
sum(revenue_yoy) revenue_yoy,
case when sum(frequency_yoy) > 0 then sum(revenue_yoy)/sum(frequency_yoy) else null end as aov_yoy
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_stats_customers_agg`
GROUP BY client, date, segment_365, segment_mom, segment_yoy
2018-04-18 10:15:57,372: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10aa5b828>]}
2018-04-18 10:15:57,758: 10:15:57 | 81 of 92 OK created table model agency_data_pipeline.retention_0_365_reactivated [CREATE TABLE in 6.90s]
2018-04-18 10:15:58,693: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1074b39b0>]}
2018-04-18 10:15:58,940: 10:15:58 | 83 of 92 OK created table model agency_data_pipeline.retention_0_30_reactivated [CREATE TABLE in 7.45s]
2018-04-18 10:15:59,618: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107512748>]}
2018-04-18 10:15:59,878: 10:15:59 | 82 of 92 OK created table model agency_data_pipeline.retention_0_30_new [CREATE TABLE in 8.88s]
2018-04-18 10:16:10,213: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107556940>]}
2018-04-18 10:16:10,547: 10:16:10 | 84 of 92 OK created table model agency_data_pipeline.segment_stats_customers [CREATE TABLE in 14.09s]
2018-04-18 10:16:10,548: 10:16:10 | 85 of 92 START table model agency_data_pipeline.segment_list_customers [RUN]
2018-04-18 10:16:10,549: Compiling model.agency_data_pipeline.segment_list_customers
2018-04-18 10:16:10,562: Writing injected SQL for node "model.agency_data_pipeline.segment_list_customers"
2018-04-18 10:16:10,563: Acquiring new bigquery connection "segment_list_customers".
2018-04-18 10:16:10,564: Re-using an available connection from the pool.
2018-04-18 10:16:11,618: Model SQL (segment_list_customers):
SELECT
a.client,
period,
date,
customer_id,
b.first_name,
b.last_name,
b.email,
recency_days,
frequency,
revenue,
quantity,
aov,
segment
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`agg_customers_union` b
ON (
	a.client = b.client AND
	a.customer_id = b.id
)
2018-04-18 10:16:43,958: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1074c4ba8>]}
2018-04-18 10:16:44,219: 10:16:44 | 85 of 92 OK created table model agency_data_pipeline.segment_list_customers [CREATE TABLE in 33.41s]
2018-04-18 10:16:44,221: 10:16:44 | 86 of 92 START table model agency_data_pipeline.growth_customer_0_365_segment [RUN]
2018-04-18 10:16:44,221: Compiling model.agency_data_pipeline.growth_customer_0_365_segment
2018-04-18 10:16:44,236: Writing injected SQL for node "model.agency_data_pipeline.growth_customer_0_365_segment"
2018-04-18 10:16:44,240: Acquiring new bigquery connection "growth_customer_0_365_segment".
2018-04-18 10:16:44,240: Re-using an available connection from the pool.
2018-04-18 10:16:45,315: Model SQL (growth_customer_0_365_segment):
with segment as (

	SELECT 
	a.date,
	unix_date_in_range,
	unix_date_in_range_yoy,
	a.client client,
	a.customer_id customer_id,
	case when b.customer_id is not null then 'New' else 'Existing' end as segment,
	a.orders,
	a.quantity,
	a.revenue,
	a.shipping_revenue
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_customer_0_365` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365_new` b
	ON (
	  a.customer_id = b.customer_id AND
	  a.date  = b.date AND
	  a.client = b.client
	)
),

total as (

	SELECT 
	date,
	unix_date_in_range,
	unix_date_in_range_yoy,
	client,
	customer_id,
	'Total' as segment,
	orders,
	quantity,
	revenue,
	shipping_revenue
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_customer_0_365`

)

SELECT 
date,
unix_date_in_range,
unix_date_in_range_yoy,
client,
segment,
count(distinct(customer_id)) customers,
sum(orders) orders,
sum(quantity) quantity,
sum(revenue) revenue,
sum(shipping_revenue) shipping_revenue
FROM
( 
	SELECT * FROM segment
	UNION ALL
	SELECT * FROM total
) 
GROUP BY date, unix_date_in_range, unix_date_in_range_yoy, client, segment
2018-04-18 10:16:56,360: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1074efeb8>]}
2018-04-18 10:16:57,039: 10:16:57 | 86 of 92 OK created table model agency_data_pipeline.growth_customer_0_365_segment [CREATE TABLE in 12.14s]
2018-04-18 10:16:57,040: 10:16:57 | 87 of 92 START table model agency_data_pipeline.growth_date_union.... [RUN]
2018-04-18 10:16:57,041: Compiling model.agency_data_pipeline.growth_date_union
2018-04-18 10:16:57,052: Writing injected SQL for node "model.agency_data_pipeline.growth_date_union"
2018-04-18 10:16:57,053: Acquiring new bigquery connection "growth_date_union".
2018-04-18 10:16:57,053: Re-using an available connection from the pool.
2018-04-18 10:16:57,917: Model SQL (growth_date_union):
with ty as (

  SELECT 
  date,
  unix_date_in_range, 
  unix_date_in_range_yoy, 
  client, 
  segment,
  customers customers_ty,
  orders orders_ty,
  quantity quantity_ty,
  revenue revenue_ty,
  shipping_revenue shipping_revenue_ty,
  null as customers_ly,
  null as orders_ly,
  null as quantity_ly,
  null as revenue_ly,
  null as shipping_revenue_ly
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_customer_0_365_segment`

),

ly as (

  SELECT 
  date,
  0 as unix_date_in_range, 
  unix_date_in_range unix_date_in_range_yoy, 
  client, 
  segment,
  null as customers_ty,
  null as orders_ty,
  null as quantity_ty,
  null as revenue_ty,
  null as shipping_revenue_ty,
  customers customers_ly,
  orders orders_ly,
  quantity quantity_ly,
  revenue revenue_ly,
  shipping_revenue shipping_revenue_ly
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_customer_0_365_segment`

)


SELECT
max(date) date,
max(unix_date_in_range) unix_date_in_range,
unix_date_in_range_yoy,
client,
segment,
ifnull(sum(customers_ty), 0) customers_ty,
ifnull(sum(orders_ty), 0) orders_ty,
ifnull(sum(quantity_ty), 0) quantity_ty,
ifnull(sum(revenue_ty), 0) revenue_ty,
ifnull(sum(shipping_revenue_ty), 0) shipping_revenue_ty,
case when sum(orders_ty) > 0 then sum(revenue_ty)/sum(orders_ty) else null end as aov_ty,
ifnull(sum(customers_ly), 0) customers_ly,
ifnull(sum(orders_ly), 0) orders_ly,
ifnull(sum(quantity_ly), 0) quantity_ly,
ifnull(sum(revenue_ly), 0) revenue_ly,
ifnull(sum(shipping_revenue_ly), 0) shipping_revenue_ly,
case when sum(orders_ly) > 0 then sum(revenue_ly)/sum(orders_ly) else null end as aov_ly,
case when sum(orders_ly) > 0 then ( sum(orders_ty) - sum(orders_ly) ) / sum(orders_ly) else null end as order_growth,
case when sum(revenue_ly) > 0 then ( sum(revenue_ty) - sum(revenue_ly) ) / sum(revenue_ly) else null end as revenue_growth,
case when sum(customers_ly) > 0 then ( sum(customers_ty) - sum(customers_ly) ) / sum(customers_ly) else null end as customer_growth,
case when sum(orders_ly) > 0 then ( sum(revenue_ty)/sum(orders_ty) - sum(revenue_ly)/sum(orders_ly) ) / ( sum(revenue_ly)/sum(orders_ly) ) else null end as aov_growth
FROM (

  SELECT * FROM ty
  UNION ALL
  SELECT * FROM ly

)
where unix_date_in_range is not null
group by unix_date_in_range_yoy, client, segment
2018-04-18 10:16:59,023: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1074b3d68>]}
2018-04-18 10:16:59,274: 10:16:59 | 87 of 92 OK created table model agency_data_pipeline.growth_date_union [CREATE TABLE in 1.98s]
2018-04-18 10:16:59,275: 10:16:59 | 88 of 92 START table model agency_data_pipeline.retention_stats...... [RUN]
2018-04-18 10:16:59,276: 10:16:59 | 89 of 92 START table model agency_data_pipeline.retention_stats_month [RUN]
2018-04-18 10:16:59,276: Compiling model.agency_data_pipeline.retention_stats
2018-04-18 10:16:59,276: 10:16:59 | 90 of 92 START table model agency_data_pipeline.growth_stats......... [RUN]
2018-04-18 10:16:59,277: Compiling model.agency_data_pipeline.retention_stats_month
2018-04-18 10:16:59,284: Compiling model.agency_data_pipeline.growth_stats
2018-04-18 10:16:59,293: Writing injected SQL for node "model.agency_data_pipeline.retention_stats"
2018-04-18 10:16:59,311: Writing injected SQL for node "model.agency_data_pipeline.retention_stats_month"
2018-04-18 10:16:59,318: Writing injected SQL for node "model.agency_data_pipeline.growth_stats"
2018-04-18 10:16:59,322: Acquiring new bigquery connection "retention_stats".
2018-04-18 10:16:59,322: Re-using an available connection from the pool.
2018-04-18 10:16:59,324: Acquiring new bigquery connection "retention_stats_month".
2018-04-18 10:16:59,324: Re-using an available connection from the pool.
2018-04-18 10:16:59,329: Acquiring new bigquery connection "growth_stats".
2018-04-18 10:16:59,329: Re-using an available connection from the pool.
2018-04-18 10:17:00,263: Model SQL (growth_stats):
with orders as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'Orders' as metric,
  orders_ty as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`
),

order_growth as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'Order Growth' as metric,
  order_growth as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`
),

revenue as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'Revenue' as metric,
  revenue_ty as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`
),

revenue_growth as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'Revenue Growth' as metric,
  revenue_growth as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`
),

customers as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'Customers' as metric,
  customers_ty as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`
),

customer_growth as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'Customer Growth' as metric,
  customer_growth as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`

),

aov as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'AOV' as metric,
  aov_ty as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`

),

aov_growth as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'AOV Growth' as metric,
  aov_growth as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`

)

SELECT * FROM orders
UNION ALL 
SELECT * FROM order_growth
UNION ALL
SELECT * FROM revenue
UNION ALL 
SELECT * FROM revenue_growth
UNION ALL
SELECT * FROM customers
UNION ALL 
SELECT * FROM customer_growth
UNION ALL
SELECT * FROM aov
UNION ALL 
SELECT * FROM aov_growth
2018-04-18 10:17:00,277: Model SQL (retention_stats):
WITH last_year_buyers AS (
	SELECT 
	date,
	client,
	'Last year buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_365_730`
	group by date, client
),

rebuy_rate AS (
	SELECT 
	date,
	client,
	'Rebuy rate' as metric,
	customer_retention value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_stats_rebuy_rate`
),

repeat_buyers AS (
	SELECT 
	date,
	client,
	'Repeat buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365_rebuy`
	group by date, client
),

reactivated_buyers AS (
	SELECT 
	date,
	client,
	'Reactivated buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365_reactivated`
	group by date, client
),

new_buyers AS (
	SELECT 
	date,
	client,
	'New buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365_new`
	group by date, client
),

this_year_buyers AS (
	SELECT 
	date,
	client,
	'This year buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365`
	group by date, client
),

this_year_revenue AS (
	SELECT 
	date,
	client,
	'This year revenue' as metric,
	sum(revenue) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365`
	group by date, client
),

this_year_aov AS (
	SELECT 
	date,
	client,
	'This year AOV' as metric,
	case when sum(order_count) > 0 then sum(revenue)/sum(order_count) else 0 end as value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365`
	group by date, client
),

this_year_frequency AS (
	SELECT 
	date,
	client,
	'This year frequency' as metric,
	case when count(distinct customer_id) > 0 then sum(order_count)/count(distinct customer_id) else 0 end as value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365`
	group by date, client
)

SELECT 
date,
client,
metric,
ifnull(value, 0) value
FROM
(
	SELECT
	date,
	client,
	metric,
	value
	FROM last_year_buyers

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM rebuy_rate

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM repeat_buyers

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM reactivated_buyers	

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM new_buyers	

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_year_buyers	

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_year_revenue

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_year_aov

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_year_frequency

	UNION ALL

	SELECT
	a.date,
	a.client,
	'Dormant buyers' as metric,
	a.value - ifnull(b.value, 0) as value
	FROM last_year_buyers a
	LEFT JOIN repeat_buyers b
	ON ( a.date = b.date AND
		a.client = b.client )							

)
2018-04-18 10:17:00,379: Model SQL (retention_stats_month):
WITH last_month_buyers AS (
	SELECT 
	date,
	client,
	'Last month buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_30_60`
	group by date, client
),

rebuy_rate AS (
	SELECT 
	date,
	client,
	'Rebuy rate' as metric,
	customer_retention value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_stats_rebuy_rate_month`
),

repeat_buyers AS (
	SELECT 
	date,
	client,
	'Repeat buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30_rebuy`
	group by date, client
),

reactivated_buyers AS (
	SELECT 
	date,
	client,
	'Reactivated buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30_reactivated`
	group by date, client
),

new_buyers AS (
	SELECT 
	date,
	client,
	'New buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30_new`
	group by date, client
),

this_month_buyers AS (
	SELECT 
	date,
	client,
	'This month buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30`
	group by date, client
),

this_month_revenue AS (
	SELECT 
	date,
	client,
	'This month revenue' as metric,
	sum(revenue) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30`
	group by date, client
),

this_month_aov AS (
	SELECT 
	date,
	client,
	'This month AOV' as metric,
	case when sum(order_count) > 0 then sum(revenue)/sum(order_count) else 0 end as value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30`
	group by date, client
),

this_month_frequency AS (
	SELECT 
	date,
	client,
	'This month frequency' as metric,
	case when count(distinct customer_id) > 0 then sum(order_count)/count(distinct customer_id) else 0 end as value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30`
	group by date, client
)

SELECT 
date,
client,
metric,
ifnull(value, 0) value
FROM
(
	SELECT
	date,
	client,
	metric,
	value
	FROM last_month_buyers

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM rebuy_rate

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM repeat_buyers

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM reactivated_buyers	

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM new_buyers	

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_month_buyers	

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_month_revenue

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_month_aov

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_month_frequency

	UNION ALL

	SELECT
	a.date,
	a.client,
	'Dormant buyers' as metric,
	a.value - ifnull(b.value, 0) as value
	FROM last_month_buyers a
	LEFT JOIN repeat_buyers b
	ON ( a.date = b.date AND
		a.client = b.client )							

)
2018-04-18 10:17:01,366: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107570e10>]}
2018-04-18 10:17:01,621: 10:17:01 | 90 of 92 OK created table model agency_data_pipeline.growth_stats.... [CREATE TABLE in 2.08s]
2018-04-18 10:17:02,607: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1074c4780>]}
2018-04-18 10:17:02,883: 10:17:02 | 89 of 92 OK created table model agency_data_pipeline.retention_stats_month [CREATE TABLE in 3.33s]
2018-04-18 10:17:09,180: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1074efeb8>]}
2018-04-18 10:17:09,427: 10:17:09 | 88 of 92 OK created table model agency_data_pipeline.retention_stats. [CREATE TABLE in 9.90s]
2018-04-18 10:17:09,430: 10:17:09 | 91 of 92 START table model agency_data_pipeline.agg_campaign......... [RUN]
2018-04-18 10:17:09,430: Compiling model.agency_data_pipeline.agg_campaign
2018-04-18 10:17:09,438: Writing injected SQL for node "model.agency_data_pipeline.agg_campaign"
2018-04-18 10:17:09,444: Acquiring new bigquery connection "agg_campaign".
2018-04-18 10:17:09,444: Re-using an available connection from the pool.
2018-04-18 10:17:10,305: Model SQL (agg_campaign):
with ga as (

	select 
		date, client, attribution, channel, platform, url, campaign as utm_campaign, '' as campaign,
    	customers_new,
    	transactions_new,
    	revenue_new,
    	first_order_revenue_new,
    	lifetime_revenue_new,
    	customers_total,
    	transactions_total,
    	revenue_total,
		null as cost, null as impressions, null as clicks, null as ad_platform_transactions
	from `growth-engines-pipeline`.`agency_data_pipeline`.`agg_ga_campaign_by_type`

),

platforms_last_touch as (

	select 
		date, client, 'Last-touch' as attribution, channel, platform, url, utm_campaign, campaign,
		null as customers_new,
    	null as transactions_new,
    	null as revenue_new,
    	null as first_order_revenue_new,
    	null as lifetime_revenue_new,
    	null as customers_total,
    	null as transactions_total,
    	null as revenue_total,
		cost, impressions, clicks, ad_platform_transactions
	from `growth-engines-pipeline`.`agency_data_pipeline`.`agg_platforms_client`

),

platforms_first_touch as (

    select 
        date, client, 'First-touch' as attribution, channel, platform, url, utm_campaign, campaign,
        null as customers_new,
        null as transactions_new,
        null as revenue_new,
        null as first_order_revenue_new,
        null as lifetime_revenue_new,
        null as customers_total,
        null as transactions_total,
        null as revenue_total,
        cost, impressions, clicks, ad_platform_transactions
    from `growth-engines-pipeline`.`agency_data_pipeline`.`agg_platforms_client`

)


SELECT
    date, 
    client,
    attribution,
    platform,
    channel, 
    url,
    utm_campaign,
    max(campaign) campaign,
    ifnull( sum(cost), 0) cost,
	ifnull( sum(impressions), 0) impressions,
	ifnull( sum(clicks), 0) clicks,
	ifnull( sum(ad_platform_transactions), 0) ad_platform_transactions,
	ifnull( sum(customers_new), 0) customers_new,
	ifnull( sum(transactions_new), 0) transactions_new,
	ifnull( sum(revenue_new), 0) revenue_new,
	ifnull( sum(first_order_revenue_new), 0) first_order_revenue_new,
	ifnull( sum(lifetime_revenue_new), 0) lifetime_revenue_new,
	ifnull( sum(customers_total), 0) customers_total,
	ifnull( sum(transactions_total), 0) transactions_total,
	ifnull( sum(revenue_total), 0) revenue_total	
FROM 
(
    SELECT *
    FROM 
      ga
    UNION ALL
    SELECT *
    FROM 
      platforms_first_touch
    UNION ALL
    SELECT *
    FROM 
      platforms_last_touch      
) 
GROUP BY
    date, client, attribution, platform, channel, url, utm_campaign
2018-04-18 10:17:17,977: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1074b3d68>]}
2018-04-18 10:17:18,303: 10:17:18 | 91 of 92 OK created table model agency_data_pipeline.agg_campaign.... [CREATE TABLE in 8.55s]
2018-04-18 10:17:18,304: 10:17:18 | 92 of 92 START table model agency_data_pipeline.agg_platform_monthly. [RUN]
2018-04-18 10:17:18,304: Compiling model.agency_data_pipeline.agg_platform_monthly
2018-04-18 10:17:18,313: Writing injected SQL for node "model.agency_data_pipeline.agg_platform_monthly"
2018-04-18 10:17:18,316: Acquiring new bigquery connection "agg_platform_monthly".
2018-04-18 10:17:18,316: Re-using an available connection from the pool.
2018-04-18 10:17:19,217: Model SQL (agg_platform_monthly):
SELECT
    FORMAT_DATE("%Y-%m", date) AS yyyymm,
    client,
    attribution,
    platform,
    channel, 
    sum(cost) cost,
	sum(clicks) clicks,
	sum(customers_new) customers_new,
	sum(first_order_revenue_new) first_order_revenue_new,
	sum(lifetime_revenue_new) lifetime_revenue_new,
	sum(transactions_new) transactions_new,
	sum(revenue_new) revenue_new,
    sum(customers_total) customers_total,
    sum(transactions_total) transactions_total,
    sum(revenue_total) revenue_total
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_campaign`
GROUP BY
    yyyymm, client, attribution, platform, channel
2018-04-18 10:17:21,442: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b05f128f-b99a-42ec-8979-446b43cd3984', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1074efeb8>]}
2018-04-18 10:17:21,751: 10:17:21 | 92 of 92 OK created table model agency_data_pipeline.agg_platform_monthly [CREATE TABLE in 3.14s]
2018-04-18 10:17:21,849: 10:17:21 | 
2018-04-18 10:17:21,849: 10:17:21 | Finished running 92 table models in 463.02s.
2018-04-18 10:17:21,849: Connection 'master' was left open.
2018-04-18 10:17:21,850: 
2018-04-18 10:17:21,850: Completed with 2 errors:
2018-04-18 10:17:21,851: 
2018-04-18 10:17:21,851: Database Error in model cogs_proc (models/admin/cogs_proc.sql)
2018-04-18 10:17:21,851:   Syntax error: Trailing comma before the FROM clause is not allowed at [6:1]
2018-04-18 10:17:21,851:   compiled SQL at target/compiled/agency_data_pipeline/admin/cogs_proc.sql
2018-04-18 10:17:21,851: 
2018-04-18 10:17:21,851: Database Error in model frequency_stats (models/segmentation/frequency/frequency_stats.sql)
2018-04-18 10:17:21,851:   SELECT list expression references column customers which is neither grouped nor aggregated at [11:5]
2018-04-18 10:17:21,852:   compiled SQL at target/compiled/agency_data_pipeline/segmentation/frequency/frequency_stats.sql
2018-04-18 10:17:21,852: 
Done. PASS=90 ERROR=2 SKIP=0 TOTAL=92
2018-04-18 10:17:21,853: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a9a1780>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a96ab38>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a96ad68>]}
2018-04-18 10:17:22,103: Flushing usage events
2018-04-18 10:23:37,785: Tracking: tracking
2018-04-18 10:23:37,789: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cb72cc0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cb72eb8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cb72f60>]}
2018-04-18 10:23:38,520: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-04-18 10:23:38,545: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/growth-engines/dbt_modules
2018-04-18 10:23:38,552: Parsing get_column_values.sql
2018-04-18 10:23:38,579: Parsing get_url_parameter.sql
2018-04-18 10:23:38,586: Parsing split_part.sql
2018-04-18 10:23:38,594: Parsing table_exists.sql
2018-04-18 10:23:38,607: Parsing core.sql
2018-04-18 10:23:38,625: Parsing adapters/bigquery.sql
2018-04-18 10:23:38,633: Parsing adapters/common.sql
2018-04-18 10:23:38,653: Parsing adapters/postgres.sql
2018-04-18 10:23:38,660: Parsing adapters/redshift.sql
2018-04-18 10:23:38,687: Parsing etc/get_custom_schema.sql
2018-04-18 10:23:38,698: Parsing materializations/archive.sql
2018-04-18 10:23:38,740: Parsing materializations/bigquery.sql
2018-04-18 10:23:38,762: Parsing materializations/helpers.sql
2018-04-18 10:23:38,784: Parsing materializations/incremental.sql
2018-04-18 10:23:38,818: Parsing materializations/table.sql
2018-04-18 10:23:38,846: Parsing materializations/view.sql
2018-04-18 10:23:38,872: Parsing materializations/wrapper.sql
2018-04-18 10:23:38,878: Parsing schema_tests/accepted_values.sql
2018-04-18 10:23:38,884: Parsing schema_tests/not_null.sql
2018-04-18 10:23:38,890: Parsing schema_tests/relationships.sql
2018-04-18 10:23:38,897: Parsing schema_tests/unique.sql
2018-04-18 10:23:39,109: Parsing model.agency_data_pipeline.accounts_proc
2018-04-18 10:23:39,112: Parsing model.agency_data_pipeline.all_dates
2018-04-18 10:23:39,114: Parsing model.agency_data_pipeline.carts_proc
2018-04-18 10:23:39,116: Parsing model.agency_data_pipeline.clients_proc
2018-04-18 10:23:39,118: Parsing model.agency_data_pipeline.cogs_proc
2018-04-18 10:23:39,120: Parsing model.agency_data_pipeline.conversion_goals_proc
2018-04-18 10:23:39,122: Parsing model.agency_data_pipeline.mappings_ga_proc
2018-04-18 10:23:39,124: Acquiring new bigquery connection "master".
2018-04-18 10:23:39,125: Opening a new connection (0 currently allocated)
2018-04-18 10:23:39,135: Parsing model.agency_data_pipeline.monthend_dates
2018-04-18 10:23:39,137: Parsing model.agency_data_pipeline.adwords_ads
2018-04-18 10:23:39,141: Parsing model.agency_data_pipeline.adwords_campaigns
2018-04-18 10:23:39,143: Parsing model.agency_data_pipeline.adwords_conversions
2018-04-18 10:23:39,145: Parsing model.agency_data_pipeline.adwords_impression_share
2018-04-18 10:23:39,146: Parsing model.agency_data_pipeline.adwords_join
2018-04-18 10:23:39,150: Parsing model.agency_data_pipeline.adwords_stats
2018-04-18 10:23:39,152: Parsing model.agency_data_pipeline.adwords_urls
2018-04-18 10:23:39,154: Parsing model.agency_data_pipeline.bing_ads_ads
2018-04-18 10:23:39,158: Parsing model.agency_data_pipeline.bing_ads_conversions
2018-04-18 10:23:39,160: Parsing model.agency_data_pipeline.bing_ads_impression_share
2018-04-18 10:23:39,161: Parsing model.agency_data_pipeline.bing_ads_stats
2018-04-18 10:23:39,164: Parsing model.agency_data_pipeline.fb_adcreative
2018-04-18 10:23:39,171: Parsing model.agency_data_pipeline.fb_ads
2018-04-18 10:23:39,177: Parsing model.agency_data_pipeline.fb_ads_insights
2018-04-18 10:23:39,184: Parsing model.agency_data_pipeline.fb_ads_insights_conversions
2018-04-18 10:23:39,191: Parsing model.agency_data_pipeline.fb_ads_stats
2018-04-18 10:23:39,194: Parsing model.agency_data_pipeline.ga_conversions
2018-04-18 10:23:39,197: Parsing model.agency_data_pipeline.ga_traffic
2018-04-18 10:23:39,215: Parsing model.agency_data_pipeline.ga_transactions
2018-04-18 10:23:39,230: Parsing model.agency_data_pipeline.ga_mcf_proc
2018-04-18 10:23:39,232: Parsing model.agency_data_pipeline.ga_mcf_stats
2018-04-18 10:23:39,235: Parsing model.agency_data_pipeline.shopify_customers_proc
2018-04-18 10:23:39,245: Parsing model.agency_data_pipeline.shopify_orders_proc
2018-04-18 10:23:39,255: Parsing model.agency_data_pipeline.shopify_products_proc
2018-04-18 10:23:39,263: Parsing model.agency_data_pipeline.shopify_refunds_proc
2018-04-18 10:23:39,269: Parsing model.agency_data_pipeline.agg_campaign
2018-04-18 10:23:39,273: Parsing model.agency_data_pipeline.agg_customers_union
2018-04-18 10:23:39,277: Parsing model.agency_data_pipeline.agg_ga_campaign
2018-04-18 10:23:39,282: Parsing model.agency_data_pipeline.agg_ga_campaign_by_type
2018-04-18 10:23:39,286: Parsing model.agency_data_pipeline.agg_ga_transaction
2018-04-18 10:23:39,291: Parsing model.agency_data_pipeline.agg_ga_transaction_order_number
2018-04-18 10:23:39,295: Parsing model.agency_data_pipeline.agg_orders_union
2018-04-18 10:23:39,296: Parsing model.agency_data_pipeline.agg_platform_monthly
2018-04-18 10:23:39,298: Parsing model.agency_data_pipeline.agg_platforms_client
2018-04-18 10:23:39,301: Parsing model.agency_data_pipeline.agg_platforms_union
2018-04-18 10:23:39,305: Parsing model.agency_data_pipeline.agg_products
2018-04-18 10:23:39,308: Parsing model.agency_data_pipeline.agg_transaction
2018-04-18 10:23:39,311: Parsing model.agency_data_pipeline.agg_transaction_daily
2018-04-18 10:23:39,313: Parsing model.agency_data_pipeline.agg_transaction_line_item
2018-04-18 10:23:39,315: Parsing model.agency_data_pipeline.agg_transaction_line_item_type
2018-04-18 10:23:39,317: Parsing model.agency_data_pipeline.agg_transaction_order_number
2018-04-18 10:23:39,318: Parsing model.agency_data_pipeline.agg_transaction_product_type
2018-04-18 10:23:39,321: Parsing model.agency_data_pipeline.customers_by_transaction
2018-04-18 10:23:39,322: Parsing model.agency_data_pipeline.growth_customer_0_365
2018-04-18 10:23:39,325: Parsing model.agency_data_pipeline.growth_customer_0_365_segment
2018-04-18 10:23:39,327: Parsing model.agency_data_pipeline.growth_date_union
2018-04-18 10:23:39,330: Parsing model.agency_data_pipeline.growth_stats
2018-04-18 10:23:39,336: Parsing model.agency_data_pipeline.retention_0_365
2018-04-18 10:23:39,339: Parsing model.agency_data_pipeline.retention_0_365_new
2018-04-18 10:23:39,342: Parsing model.agency_data_pipeline.retention_0_365_reactivated
2018-04-18 10:23:39,344: Parsing model.agency_data_pipeline.retention_0_365_rebuy
2018-04-18 10:23:39,346: Parsing model.agency_data_pipeline.retention_365_730
2018-04-18 10:23:39,348: Parsing model.agency_data_pipeline.retention_730_plus
2018-04-18 10:23:39,350: Parsing model.agency_data_pipeline.retention_stats
2018-04-18 10:23:39,356: Parsing model.agency_data_pipeline.retention_stats_rebuy_rate
2018-04-18 10:23:39,358: Parsing model.agency_data_pipeline.retention_0_30
2018-04-18 10:23:39,361: Parsing model.agency_data_pipeline.retention_0_30_new
2018-04-18 10:23:39,363: Parsing model.agency_data_pipeline.retention_0_30_reactivated
2018-04-18 10:23:39,365: Parsing model.agency_data_pipeline.retention_0_30_rebuy
2018-04-18 10:23:39,369: Parsing model.agency_data_pipeline.retention_30_60
2018-04-18 10:23:39,371: Parsing model.agency_data_pipeline.retention_60_plus
2018-04-18 10:23:39,374: Parsing model.agency_data_pipeline.retention_stats_month
2018-04-18 10:23:39,379: Parsing model.agency_data_pipeline.retention_stats_rebuy_rate_month
2018-04-18 10:23:39,381: Parsing model.agency_data_pipeline.customers_first_purchase_proc
2018-04-18 10:23:39,383: Parsing model.agency_data_pipeline.customers_proc
2018-04-18 10:23:39,388: Parsing model.agency_data_pipeline.segment_list_customers
2018-04-18 10:23:39,392: Parsing model.agency_data_pipeline.segment_proc_customers
2018-04-18 10:23:39,396: Parsing model.agency_data_pipeline.segment_stats_customers
2018-04-18 10:23:39,398: Parsing model.agency_data_pipeline.segment_stats_customers_agg
2018-04-18 10:23:39,401: Parsing model.agency_data_pipeline.customers_first_purchase_product_type_proc
2018-04-18 10:23:39,403: Parsing model.agency_data_pipeline.customers_products_proc
2018-04-18 10:23:39,408: Parsing model.agency_data_pipeline.segment_list_customers_products
2018-04-18 10:23:39,412: Parsing model.agency_data_pipeline.segment_proc_customers_products
2018-04-18 10:23:39,416: Parsing model.agency_data_pipeline.segment_stats_customers_products
2018-04-18 10:23:39,418: Parsing model.agency_data_pipeline.segment_stats_customers_products_agg
2018-04-18 10:23:39,422: Parsing model.agency_data_pipeline.frequency_proc
2018-04-18 10:23:39,424: Parsing model.agency_data_pipeline.frequency_stats
2018-04-18 10:23:39,426: Parsing model.agency_data_pipeline.order_paths_agg
2018-04-18 10:23:39,427: Parsing model.agency_data_pipeline.order_paths_proc
2018-04-18 10:23:39,429: Parsing model.agency_data_pipeline.order_paths_stats
2018-04-18 10:23:39,432: Parsing model.agency_data_pipeline.products_proc
2018-04-18 10:23:39,435: Parsing model.agency_data_pipeline.segment_proc_sku
2018-04-18 10:23:39,438: Parsing model.agency_data_pipeline.segment_stats_category
2018-04-18 10:23:39,439: Parsing model.agency_data_pipeline.segment_stats_sku
2018-04-18 10:23:39,478: Found 92 models, 0 tests, 0 archives, 0 analyses, 46 macros, 0 operations
2018-04-18 10:23:39,570: 
2018-04-18 10:23:40,965: 10:23:40 | Concurrency: 4 threads (target='prod')
2018-04-18 10:23:40,965: 10:23:40 | 
2018-04-18 10:23:41,751: 10:23:41 | 1 of 92 START table model agency_data_pipeline.bing_ads_ads.......... [RUN]
2018-04-18 10:23:41,752: Compiling model.agency_data_pipeline.bing_ads_ads
2018-04-18 10:23:41,751: 10:23:41 | 2 of 92 START table model agency_data_pipeline.monthend_dates........ [RUN]
2018-04-18 10:23:41,751: 10:23:41 | 3 of 92 START table model agency_data_pipeline.bing_ads_impression_share [RUN]
2018-04-18 10:23:41,758: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_ads"
2018-04-18 10:23:41,758: Compiling model.agency_data_pipeline.monthend_dates
2018-04-18 10:23:41,751: 10:23:41 | 4 of 92 START table model agency_data_pipeline.cogs_proc............. [RUN]
2018-04-18 10:23:41,759: Compiling model.agency_data_pipeline.bing_ads_impression_share
2018-04-18 10:23:41,763: Writing injected SQL for node "model.agency_data_pipeline.monthend_dates"
2018-04-18 10:23:41,763: Compiling model.agency_data_pipeline.cogs_proc
2018-04-18 10:23:41,770: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_impression_share"
2018-04-18 10:23:41,771: Acquiring new bigquery connection "bing_ads_ads".
2018-04-18 10:23:41,776: Writing injected SQL for node "model.agency_data_pipeline.cogs_proc"
2018-04-18 10:23:41,778: Acquiring new bigquery connection "monthend_dates".
2018-04-18 10:23:41,778: Opening a new connection (1 currently allocated)
2018-04-18 10:23:41,779: Acquiring new bigquery connection "bing_ads_impression_share".
2018-04-18 10:23:41,782: Acquiring new bigquery connection "cogs_proc".
2018-04-18 10:23:41,782: Opening a new connection (2 currently allocated)
2018-04-18 10:23:41,843: Opening a new connection (3 currently allocated)
2018-04-18 10:23:41,909: Opening a new connection (4 currently allocated)
2018-04-18 10:23:43,157: Model SQL (cogs_proc):
select 
client,
sku,
cogs_dol,
cogs_pct
from  ( 

SELECT  
client,
sku,
cogs_dol,
cogs_pct,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.cogs`
where client != ''
) 

WHERE lv = time_of_entry
2018-04-18 10:23:43,253: Model SQL (bing_ads_ads):
select
date, 
account, 
channel,
platform,
campaignid,
campaignname,
max(lower(trim(replace(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$','' ),'.html',''),'/'))) as url,
utm_campaign,
sum(cost) as cost,
sum(impressions) as impressions,
sum(clicks) as clicks,
sum(conversions) as conversions
from 
  ( 
SELECT  
cast(gregoriandate as date) date,
replace(accountname,',','') account,
'Paid' as channel,
'Bing Ads' as platform,
adid,
adtype,
campaignid, 
campaignname,
finalurl url,
case when regexp_contains(destinationurl, 'utm_campaign')
	then replace(lower(nullif(
  

    split(
        
  

    split(
        destinationurl,
        'utm_campaign='
        )[offset(1)]


,
        '&'
        )[offset(0)]


,'')),'+',' ') 
	else null end as utm_campaign,
spend cost, 
impressions, 
clicks, 
conversions,
_sdc_sequence,
first_value(_sdc_sequence) OVER (PARTITION BY adid, gregoriandate ORDER BY _sdc_sequence DESC) lv
FROM `growth-engines-pipeline.bing_ads.ad_performance_report` 
  )

where lv = _sdc_sequence
group by date, account, channel, platform, campaignid, campaignname, utm_campaign
2018-04-18 10:23:43,299: Model SQL (bing_ads_impression_share):
SELECT 
date, 
account,
channel,
platform,
sum(impressions) impressions,
sum(available_impressions) available_impressions
FROM

(

SELECT  
cast(gregoriandate as date) date,
replace(accountname,',','') account,  
'Paid' as channel,
'Bing Ads' as platform,
case when impressionsharepercent is null then 0 else impressions end as impressions,
cast(round(case when ( impressionsharepercent is not null and impressionsharepercent > 0 ) then (impressions*100)/impressionsharepercent else 0 end) as int64) as available_impressions,
_sdc_sequence,
first_value(_sdc_sequence) OVER (PARTITION BY campaignid, gregoriandate ORDER BY _sdc_sequence DESC) lv
FROM `growth-engines-pipeline.bing_ads.campaign_performance_report` 

)

where lv = _sdc_sequence
group by date, account, channel, platform
2018-04-18 10:23:43,457: Model SQL (monthend_dates):
SELECT
date_in_range,
date_in_range_bom,
date_in_range_bom_mom,
unix_date_in_range,
unix_date_in_range_bom,
unix_date(date_in_range_bom_mom) unix_date_in_range_bom_mom,
yyyymm,
date_in_range_yoy,
unix_date(date_in_range_yoy) unix_date_in_range_yoy

FROM
(
	SELECT 
	date_in_range,
	date_in_range_bom,
	date_sub(date_in_range_bom, INTERVAL 1 MONTH) date_in_range_bom_mom,
  date_sub(date_in_range, INTERVAL 1 YEAR) date_in_range_yoy,
	unix_date_in_range,
	unix_date(date_in_range_bom) unix_date_in_range_bom,
	yyyymm,
	first_value(date_in_range) over (partition by yyyymm order by date_in_range desc) monthend_date_in_range
	FROM
	( 
		SELECT 
		date_in_range,
		date_trunc( date_in_range, MONTH) date_in_range_bom,
		unix_date(date_in_range) unix_date_in_range,
		format_date("%Y-%m", date_in_range) AS yyyymm
		FROM UNNEST(
		    GENERATE_DATE_ARRAY(DATE('2016-01-31'), CURRENT_DATE(), INTERVAL 1 DAY)
		) AS date_in_range
	)
)
where date_in_range = monthend_date_in_range
2018-04-18 10:23:44,261: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cd88860>]}
2018-04-18 10:23:44,534: 10:23:44 | 4 of 92 OK created table model agency_data_pipeline.cogs_proc........ [CREATE TABLE in 2.50s]
2018-04-18 10:23:44,534: 10:23:44 | 5 of 92 START table model agency_data_pipeline.all_dates............. [RUN]
2018-04-18 10:23:44,534: Compiling model.agency_data_pipeline.all_dates
2018-04-18 10:23:44,539: Writing injected SQL for node "model.agency_data_pipeline.all_dates"
2018-04-18 10:23:44,541: Acquiring new bigquery connection "all_dates".
2018-04-18 10:23:44,541: Re-using an available connection from the pool.
2018-04-18 10:23:45,431: Model SQL (all_dates):
SELECT 
date_in_range,
unix_date(date_in_range) unix_date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-04-18 10:23:45,464: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cd7f5f8>]}
2018-04-18 10:23:45,475: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cd6b4a8>]}
2018-04-18 10:23:45,672: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10981e710>]}
2018-04-18 10:23:45,707: 10:23:45 | 1 of 92 OK created table model agency_data_pipeline.bing_ads_ads..... [CREATE TABLE in 3.71s]
2018-04-18 10:23:45,708: 10:23:45 | 6 of 92 START table model agency_data_pipeline.conversion_goals_proc. [RUN]
2018-04-18 10:23:45,709: Compiling model.agency_data_pipeline.conversion_goals_proc
2018-04-18 10:23:45,721: Writing injected SQL for node "model.agency_data_pipeline.conversion_goals_proc"
2018-04-18 10:23:45,724: Acquiring new bigquery connection "conversion_goals_proc".
2018-04-18 10:23:45,724: Re-using an available connection from the pool.
2018-04-18 10:23:46,006: 10:23:46 | 3 of 92 OK created table model agency_data_pipeline.bing_ads_impression_share [CREATE TABLE in 3.72s]
2018-04-18 10:23:46,008: 10:23:46 | 7 of 92 START table model agency_data_pipeline.ga_conversions........ [RUN]
2018-04-18 10:23:46,013: Compiling model.agency_data_pipeline.ga_conversions
2018-04-18 10:23:46,024: Writing injected SQL for node "model.agency_data_pipeline.ga_conversions"
2018-04-18 10:23:46,029: Acquiring new bigquery connection "ga_conversions".
2018-04-18 10:23:46,029: Re-using an available connection from the pool.
2018-04-18 10:23:46,322: 10:23:46 | 2 of 92 OK created table model agency_data_pipeline.monthend_dates... [CREATE TABLE in 3.91s]
2018-04-18 10:23:46,322: 10:23:46 | 8 of 92 START table model agency_data_pipeline.accounts_proc......... [RUN]
2018-04-18 10:23:46,323: Compiling model.agency_data_pipeline.accounts_proc
2018-04-18 10:23:46,329: Writing injected SQL for node "model.agency_data_pipeline.accounts_proc"
2018-04-18 10:23:46,331: Acquiring new bigquery connection "accounts_proc".
2018-04-18 10:23:46,331: Re-using an available connection from the pool.
2018-04-18 10:23:46,621: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cd88860>]}
2018-04-18 10:23:46,746: Model SQL (conversion_goals_proc):
select 
client,
platform,
goal_name,
max(goal_type) goal_type,
account,
max(time_of_entry) time_of_entry
from  ( 

SELECT  
client,
platform,
trim(replace(replace(lower(goal_name),',',''),' ','')) goal_name,
goal_type,
account,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY platform ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.conversion_goals` 

) 

WHERE lv = time_of_entry
group by client, platform, account, goal_name
2018-04-18 10:23:46,933: 10:23:46 | 5 of 92 OK created table model agency_data_pipeline.all_dates........ [CREATE TABLE in 2.09s]
2018-04-18 10:23:46,933: 10:23:46 | 9 of 92 START table model agency_data_pipeline.adwords_conversions... [RUN]
2018-04-18 10:23:46,934: Compiling model.agency_data_pipeline.adwords_conversions
2018-04-18 10:23:46,947: Writing injected SQL for node "model.agency_data_pipeline.adwords_conversions"
2018-04-18 10:23:46,951: Acquiring new bigquery connection "adwords_conversions".
2018-04-18 10:23:46,951: Re-using an available connection from the pool.
2018-04-18 10:23:46,994: Model SQL (ga_conversions):
select 
client,
client_name,
platform,
goal_name,
goal_type,
account,
time_of_entry
from  ( 

SELECT  
client,
client_name,
platform,
trim(goal_name) goal_name,
goal_type,
account,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform, goal_name ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.conversion_goals` 
WHERE platform = 'Google Analytics'

) 

WHERE lv = time_of_entry
2018-04-18 10:23:47,210: Model SQL (accounts_proc):
select 
client,
account,
platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.accounts` 

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-04-18 10:23:47,864: Model SQL (adwords_conversions):
select 
client,
client_name,
platform,
goal_name,
goal_type,
account,
time_of_entry
from  ( 

SELECT  
client,
client_name,
platform,
trim(lower(goal_name)) goal_name,
goal_type,
account,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform, goal_name ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.conversion_goals` 
WHERE platform = 'Adwords'

) 

WHERE lv = time_of_entry
2018-04-18 10:23:48,090: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1098a0e80>]}
2018-04-18 10:23:48,316: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10981e710>]}
2018-04-18 10:23:48,377: 10:23:48 | 7 of 92 OK created table model agency_data_pipeline.ga_conversions... [CREATE TABLE in 2.08s]
2018-04-18 10:23:48,382: 10:23:48 | 10 of 92 START table model agency_data_pipeline.adwords_urls......... [RUN]
2018-04-18 10:23:48,384: Compiling model.agency_data_pipeline.adwords_urls
2018-04-18 10:23:48,398: Writing injected SQL for node "model.agency_data_pipeline.adwords_urls"
2018-04-18 10:23:48,402: Acquiring new bigquery connection "adwords_urls".
2018-04-18 10:23:48,403: Re-using an available connection from the pool.
2018-04-18 10:23:48,760: 10:23:48 | 8 of 92 OK created table model agency_data_pipeline.accounts_proc.... [CREATE TABLE in 1.99s]
2018-04-18 10:23:48,761: 10:23:48 | 11 of 92 START table model agency_data_pipeline.clients_proc......... [RUN]
2018-04-18 10:23:48,761: Compiling model.agency_data_pipeline.clients_proc
2018-04-18 10:23:48,799: Writing injected SQL for node "model.agency_data_pipeline.clients_proc"
2018-04-18 10:23:48,800: Acquiring new bigquery connection "clients_proc".
2018-04-18 10:23:48,801: Re-using an available connection from the pool.
2018-04-18 10:23:48,934: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cd7f5f8>]}
2018-04-18 10:23:49,065: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cd88860>]}
2018-04-18 10:23:49,200: 10:23:49 | 6 of 92 OK created table model agency_data_pipeline.conversion_goals_proc [CREATE TABLE in 3.22s]
2018-04-18 10:23:49,201: 10:23:49 | 12 of 92 START table model agency_data_pipeline.carts_proc........... [RUN]
2018-04-18 10:23:49,201: Compiling model.agency_data_pipeline.carts_proc
2018-04-18 10:23:49,211: Writing injected SQL for node "model.agency_data_pipeline.carts_proc"
2018-04-18 10:23:49,215: Acquiring new bigquery connection "carts_proc".
2018-04-18 10:23:49,216: Re-using an available connection from the pool.
2018-04-18 10:23:49,389: Model SQL (adwords_urls):
SELECT
campaignid,
lower(trim(regexp_replace(replace(replace(replace(replace(finalurl,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url

FROM (

SELECT  
campaignid,
finalurl,
first_value(finalurl) OVER (PARTITION BY campaignid ORDER BY day DESC) lv
FROM `growth-engines-pipeline.adwords_2.FINAL_URL_REPORT`
)

WHERE lv = finalurl
group by campaignid, url
order by campaignid asc
2018-04-18 10:23:49,491: 10:23:49 | 9 of 92 OK created table model agency_data_pipeline.adwords_conversions [CREATE TABLE in 2.13s]
2018-04-18 10:23:49,493: 10:23:49 | 13 of 92 START table model agency_data_pipeline.adwords_campaigns.... [RUN]
2018-04-18 10:23:49,493: Compiling model.agency_data_pipeline.adwords_campaigns
2018-04-18 10:23:49,526: Writing injected SQL for node "model.agency_data_pipeline.adwords_campaigns"
2018-04-18 10:23:49,537: Acquiring new bigquery connection "adwords_campaigns".
2018-04-18 10:23:49,555: Re-using an available connection from the pool.
2018-04-18 10:23:49,653: Model SQL (clients_proc):
select 
client,
client_name,
account,
platform
from  ( 

SELECT  
client,
client_name,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.accounts`
where client_name != ''
) 

WHERE lv = time_of_entry
2018-04-18 10:23:50,061: Model SQL (carts_proc):
select 
client,
client_name,
account,
platform
from  ( 

SELECT  
client,
client_name,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.accounts`
WHERE platform in ('Shopify', 'Custom cart')

) 

WHERE lv = time_of_entry
2018-04-18 10:23:50,753: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10981e710>]}
2018-04-18 10:23:50,833: Model SQL (adwords_campaigns):
select
day,
campaignid, 
campaign,
account, 
channel,
platform,
sum(cost) cost,
sum(impressions) impressions,
sum(clicks) clicks,
sum(impression_share_num) impression_share_num,
sum(impression_share_den) impression_share_den
from 
  ( 
	SELECT  
	day,
	campaignid,
	campaign,
	account as account,
	'Paid' as channel,
	'Adwords' as platform,
	cost/1000000 cost, 
	impressions as impressions, 
	clicks, 
	case when searchimprshare is not null then impressions end as impression_share_num,
	case when searchimprshare is not null then impressions/(searchimprshare/100) end as impression_share_den,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY campaignid, day ORDER BY _sdc_sequence DESC) lv
	FROM `growth-engines-pipeline.adwords_2.CAMPAIGN_PERFORMANCE_REPORT`
  )
where lv = _sdc_sequence
group by day, campaignid, account, channel, platform, campaign
2018-04-18 10:23:51,035: 10:23:51 | 11 of 92 OK created table model agency_data_pipeline.clients_proc.... [CREATE TABLE in 1.99s]
2018-04-18 10:23:51,766: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cd6bba8>]}
2018-04-18 10:23:52,016: 10:23:52 | 10 of 92 OK created table model agency_data_pipeline.adwords_urls.... [CREATE TABLE in 3.38s]
2018-04-18 10:23:52,233: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cd7f5f8>]}
2018-04-18 10:23:52,588: 10:23:52 | 12 of 92 OK created table model agency_data_pipeline.carts_proc...... [CREATE TABLE in 3.03s]
2018-04-18 10:23:55,429: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1098e5d68>]}
2018-04-18 10:23:55,724: 10:23:55 | 13 of 92 OK created table model agency_data_pipeline.adwords_campaigns [CREATE TABLE in 5.94s]
2018-04-18 10:23:55,725: 10:23:55 | 14 of 92 START table model agency_data_pipeline.bing_ads_conversions. [RUN]
2018-04-18 10:23:55,726: Compiling model.agency_data_pipeline.bing_ads_conversions
2018-04-18 10:23:55,735: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_conversions"
2018-04-18 10:23:55,735: 10:23:55 | 15 of 92 START table model agency_data_pipeline.shopify_refunds_proc. [RUN]
2018-04-18 10:23:55,735: 10:23:55 | 16 of 92 START table model agency_data_pipeline.fb_ads_insights...... [RUN]
2018-04-18 10:23:55,736: Compiling model.agency_data_pipeline.shopify_refunds_proc
2018-04-18 10:23:55,737: Acquiring new bigquery connection "bing_ads_conversions".
2018-04-18 10:23:55,736: 10:23:55 | 17 of 92 START table model agency_data_pipeline.fb_adcreative........ [RUN]
2018-04-18 10:23:55,737: Compiling model.agency_data_pipeline.fb_ads_insights
2018-04-18 10:23:55,746: Acquiring new bigquery connection "shopify_refunds_proc".
2018-04-18 10:23:55,746: Re-using an available connection from the pool.
2018-04-18 10:23:55,746: Compiling model.agency_data_pipeline.fb_adcreative
2018-04-18 10:23:55,763: Acquiring new bigquery connection "fb_ads_insights".
2018-04-18 10:23:55,779: Re-using an available connection from the pool.
2018-04-18 10:23:55,805: Fetching data for query shopify_refunds_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 10:23:55,812: Re-using an available connection from the pool.
2018-04-18 10:23:55,820: Fetching data for query fb_ads_insights:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 10:23:55,823: Acquiring new bigquery connection "fb_adcreative".
2018-04-18 10:23:55,823: Re-using an available connection from the pool.
2018-04-18 10:23:55,823: Fetching data for query fb_adcreative:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 10:23:56,948: Model SQL (bing_ads_conversions):
SELECT
date, 
a.account account, 
a.channel channel,
a.platform platform,
campaignid,
campaignname,
sum( case when b.goal_type = 'Transactions' then conversions else 0 end ) as transactions
FROM

  ( 
SELECT  
cast(gregoriandate as date) date,
replace(accountname,',','') account,
'Paid' as channel,
'Bing Ads' as platform,
trim(replace(replace(lower(goal),',',''),' ','')) goal,
goalid,
campaignid,
campaignname,
conversions,
_sdc_sequence,
first_value(_sdc_sequence) OVER (PARTITION BY campaignid, goalid, gregoriandate ORDER BY _sdc_sequence DESC) lv
FROM `growth-engines-pipeline.bing_ads.goals_and_funnels_report` 

  ) a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`conversion_goals_proc` b
ON (
	a.account = b.account AND
	a.platform = b.platform AND
	a.goal = b.goal_name
)
where a.lv = a._sdc_sequence
group by date, account, channel, platform, campaignid, campaignname
2018-04-18 10:23:57,029: Writing injected SQL for node "model.agency_data_pipeline.shopify_refunds_proc"
2018-04-18 10:23:57,113: Writing injected SQL for node "model.agency_data_pipeline.fb_adcreative"
2018-04-18 10:23:57,282: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_insights"
2018-04-18 10:23:58,277: Model SQL (shopify_refunds_proc):




with refunds as (

	
	SELECT
	order_number,
	checkout_id,
	financial_status,
	line_item_id,
	quantity,
	subtotal,
	line_item.variant_id variant_id,
	line_item.id refund_id,
 	_sdc_sequence
	FROM `growth-engines-pipeline.shopify_lucadanni.orders` 
	cross join unnest(refunds), unnest(refund_line_items)
  	where financial_status like '%refund%'
	
	

)

SELECT * 
FROM 
	(
    SELECT
	order_number,
	checkout_id,
	financial_status,
	line_item_id,
	quantity,
	subtotal refund_amount,
	variant_id,
	refund_id,
 	_sdc_sequence,
    first_value(_sdc_sequence) OVER (PARTITION BY order_number, line_item_id ORDER BY _sdc_sequence DESC) lv
    FROM refunds
   	) 
WHERE lv = _sdc_sequence


2018-04-18 10:23:58,446: Model SQL (fb_adcreative):




with fb_adcreative as (


	    
		   	SELECT 
			id,
			object_url,
			url_tags,
			_sdc_sequence
			FROM `growth-engines-pipeline.fb_ads_luca_danni.adcreative`
		    
	   
)

select creative_id, max(url) url
from (
  select
  id creative_id,
  lower(trim(regexp_replace(replace(replace(replace(replace(object_url,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
  first_value(_sdc_sequence) OVER (PARTITION BY id ORDER BY _sdc_sequence DESC) lv,
  _sdc_sequence
  from fb_adcreative
  )
where lv = _sdc_sequence
group by creative_id


2018-04-18 10:23:58,515: Model SQL (fb_ads_insights):




with fb_ads_insights as (

	    
		   	SELECT 
			date_start,
			campaign_id,
			campaign_name,
			ad_id,
			account_name,
			spend,
			reach,
			inline_link_clicks,
			_sdc_sequence,
			first_value(_sdc_sequence) OVER (PARTITION BY date_start, ad_id, campaign_id ORDER BY _sdc_sequence DESC) lv
			FROM `growth-engines-pipeline.fb_ads_luca_danni.ads_insights`
		    
	   

)

select
date_start date,
campaign_id,
campaign_name campaign,
ad_id,
account_name account,
max(spend) cost,
max(reach) impressions,
max(inline_link_clicks) clicks
from fb_ads_insights
where lv = _sdc_sequence
group by date, campaign_id, ad_id, account, campaign


2018-04-18 10:23:59,202: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cd7f7f0>]}
2018-04-18 10:23:59,464: 10:23:59 | 14 of 92 OK created table model agency_data_pipeline.bing_ads_conversions [CREATE TABLE in 3.48s]
2018-04-18 10:23:59,465: 10:23:59 | 18 of 92 START table model agency_data_pipeline.mappings_ga_proc..... [RUN]
2018-04-18 10:23:59,465: Compiling model.agency_data_pipeline.mappings_ga_proc
2018-04-18 10:23:59,475: Writing injected SQL for node "model.agency_data_pipeline.mappings_ga_proc"
2018-04-18 10:23:59,476: Acquiring new bigquery connection "mappings_ga_proc".
2018-04-18 10:23:59,476: Re-using an available connection from the pool.
2018-04-18 10:24:00,469: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1098b62e8>]}
2018-04-18 10:24:00,511: Model SQL (mappings_ga_proc):
select 
client,
account,
client_name,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
account,
client_name,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.mappings_ga` 

) 

WHERE lv = time_of_entry
and client in (select client from `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc` )
group by client, account, client_name, source, medium, platform_n, channel_n, time_of_entry
2018-04-18 10:24:00,675: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cd88208>]}
2018-04-18 10:24:00,842: 10:24:00 | 15 of 92 OK created table model agency_data_pipeline.shopify_refunds_proc [CREATE TABLE in 4.73s]
2018-04-18 10:24:00,844: 10:24:00 | 19 of 92 START table model agency_data_pipeline.ga_mcf_proc.......... [RUN]
2018-04-18 10:24:00,844: Compiling model.agency_data_pipeline.ga_mcf_proc
2018-04-18 10:24:00,856: Writing injected SQL for node "model.agency_data_pipeline.ga_mcf_proc"
2018-04-18 10:24:00,860: Acquiring new bigquery connection "ga_mcf_proc".
2018-04-18 10:24:00,860: Re-using an available connection from the pool.
2018-04-18 10:24:01,007: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cce0860>]}
2018-04-18 10:24:01,251: 10:24:01 | 17 of 92 OK created table model agency_data_pipeline.fb_adcreative... [CREATE TABLE in 4.93s]
2018-04-18 10:24:01,252: 10:24:01 | 20 of 92 START table model agency_data_pipeline.fb_ads_insights_conversions [RUN]
2018-04-18 10:24:01,255: Compiling model.agency_data_pipeline.fb_ads_insights_conversions
2018-04-18 10:24:01,264: Acquiring new bigquery connection "fb_ads_insights_conversions".
2018-04-18 10:24:01,264: Re-using an available connection from the pool.
2018-04-18 10:24:01,264: Fetching data for query fb_ads_insights_conversions:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 10:24:01,714: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_insights_conversions"
2018-04-18 10:24:01,755: 10:24:01 | 16 of 92 OK created table model agency_data_pipeline.fb_ads_insights. [CREATE TABLE in 5.27s]
2018-04-18 10:24:01,756: 10:24:01 | 21 of 92 START table model agency_data_pipeline.adwords_ads.......... [RUN]
2018-04-18 10:24:01,756: Compiling model.agency_data_pipeline.adwords_ads
2018-04-18 10:24:01,770: Writing injected SQL for node "model.agency_data_pipeline.adwords_ads"
2018-04-18 10:24:01,772: Acquiring new bigquery connection "adwords_ads".
2018-04-18 10:24:01,773: Re-using an available connection from the pool.
2018-04-18 10:24:02,106: Model SQL (ga_mcf_proc):
SELECT 
date,
account,
'Google Analytics' as lookup_platform,
source_medium_path,
trim(lower(split(split(source_medium_path,'->')[SAFE_ORDINAL(1)],'/')[SAFE_ORDINAL(1)])) as source,
trim(lower(split(split(source_medium_path,'->')[SAFE_ORDINAL(1)],'/')[SAFE_ORDINAL(2)])) as medium,
first_interaction_campaign campaign,
cast(regexp_replace(transaction_id, r'#', '') as int64) transactionid,
max(first_interaction_conversions) transactions,
max(first_interaction_conversion_value) revenue
FROM `growth-engines-pipeline.agency_data_pipeline.ga_mcf`
where account in (select account from `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc` where platform = 'Google Analytics')
group by date, account, source, medium, campaign, source_medium_path, lookup_platform, transactionid
2018-04-18 10:24:02,532: Model SQL (fb_ads_insights_conversions):




with fb_ads_insights_conversions as (

	    
		   	SELECT 
			date_start,
			campaign_id,
			campaign_name,
			ad_id,
			account_name,
			spend,
			reach,
			inline_link_clicks,
			_sdc_sequence,
			action_type,
			value
			FROM `growth-engines-pipeline.fb_ads_luca_danni.ads_insights`
			cross join unnest(actions)
		    
	   

)

SELECT * 
FROM 
	(
    SELECT
    date_start date,
    campaign_id,
    campaign_name campaign,
    ad_id,
    account_name account,
    action_type,
    value conversions,
    first_value(_sdc_sequence) OVER (PARTITION BY ad_id, date_start ORDER BY _sdc_sequence DESC) lv,
    _sdc_sequence
    FROM fb_ads_insights_conversions
   	)
where lv = _sdc_sequence
and action_type like '%purchase%'


2018-04-18 10:24:02,674: Model SQL (adwords_ads):
SELECT  
day,
campaignid,
a.account as account,
utm_campaign,
sum( case when b.goal_type = 'Transaction' then conversions else 0 end ) as transactions
FROM (

	SELECT  
	day,
	adid,
	campaignid,
	account,
	lower(conversionname) conversionname,
	conversions,
	lower(campaign) utm_campaign,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY campaignid, day ORDER BY _sdc_sequence DESC) lv
	FROM
	`growth-engines-pipeline.adwords_2.AD_PERFORMANCE_REPORT`

) a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_conversions` b
ON ( a.conversionname = b.goal_name
	AND a.account = b.account )
WHERE lv = _sdc_sequence
group by day, campaignid, account, utm_campaign
2018-04-18 10:24:02,747: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cd7f7f0>]}
2018-04-18 10:24:02,999: 10:24:02 | 18 of 92 OK created table model agency_data_pipeline.mappings_ga_proc [CREATE TABLE in 3.28s]
2018-04-18 10:24:05,912: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cd88208>]}
2018-04-18 10:24:06,041: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cce0860>]}
2018-04-18 10:24:06,245: 10:24:06 | 20 of 92 OK created table model agency_data_pipeline.fb_ads_insights_conversions [CREATE TABLE in 4.66s]
2018-04-18 10:24:06,480: 10:24:06 | 21 of 92 OK created table model agency_data_pipeline.adwords_ads..... [CREATE TABLE in 4.29s]
2018-04-18 10:24:06,516: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109910e10>]}
2018-04-18 10:24:06,850: 10:24:06 | 19 of 92 OK created table model agency_data_pipeline.ga_mcf_proc..... [CREATE TABLE in 5.67s]
2018-04-18 10:24:06,851: 10:24:06 | 22 of 92 START table model agency_data_pipeline.shopify_customers_proc [RUN]
2018-04-18 10:24:06,852: Compiling model.agency_data_pipeline.shopify_customers_proc
2018-04-18 10:24:06,851: 10:24:06 | 23 of 92 START table model agency_data_pipeline.fb_ads............... [RUN]
2018-04-18 10:24:06,861: Acquiring new bigquery connection "shopify_customers_proc".
2018-04-18 10:24:06,861: Compiling model.agency_data_pipeline.fb_ads
2018-04-18 10:24:06,861: Re-using an available connection from the pool.
2018-04-18 10:24:06,869: Acquiring new bigquery connection "fb_ads".
2018-04-18 10:24:06,870: Fetching data for query shopify_customers_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 10:24:06,870: Re-using an available connection from the pool.
2018-04-18 10:24:06,870: Fetching data for query fb_ads:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 10:24:07,229: Writing injected SQL for node "model.agency_data_pipeline.shopify_customers_proc"
2018-04-18 10:24:07,282: Writing injected SQL for node "model.agency_data_pipeline.fb_ads"
2018-04-18 10:24:08,144: Model SQL (shopify_customers_proc):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc`





with customers as (

	
	SELECT
	'lucadanni' client_name,
	'Shopify' as lookup_platform,
	cast(created_at as date) created_at,
	id,
	first_name,
	last_name,
	email,
	_sdc_sequence,
	first_value(_sdc_sequence) over (partition by id, _sdc_sequence order by _sdc_sequence desc) lv
	FROM `growth-engines-pipeline.shopify_lucadanni.customers` 
	
	

)

SELECT
account,
client,
platform,
id,
min(created_at) created_at,
max(first_name) first_name,
max(last_name) last_name,
max(email) email
FROM (
	SELECT
	b.account,
	b.client,
	b.platform,
	created_at,
	id,
	first_name,
	last_name,
	email
	FROM customers a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
	ON ( a.client_name = b.client_name
	  AND a.lookup_platform = b.platform )
	where a.lv = a._sdc_sequence
)
group by account, client, platform, id

2018-04-18 10:24:08,250: Model SQL (fb_ads):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`fb_adcreative`





with fb_ads as (

	    
		   	SELECT 
			id ad_id,
			creative.creative_id creative_id,
			_sdc_sequence
			FROM `growth-engines-pipeline.fb_ads_luca_danni.ads`
		     
	   

)

SELECT
a.ad_id,
b.creative_id,
b.url
FROM (
    SELECT
    ad_id,
    creative_id,
    first_value(_sdc_sequence) OVER (PARTITION BY ad_id ORDER BY _sdc_sequence DESC) lv,
    _sdc_sequence
    FROM fb_ads
    ) a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`fb_adcreative` b
ON (
	a.creative_id = b.creative_id 
)
WHERE a.lv = a._sdc_sequence


2018-04-18 10:24:10,443: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cd01588>]}
2018-04-18 10:24:10,721: 10:24:10 | 23 of 92 OK created table model agency_data_pipeline.fb_ads.......... [CREATE TABLE in 3.58s]
2018-04-18 10:24:13,623: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10994bc18>]}
2018-04-18 10:24:13,877: 10:24:13 | 22 of 92 OK created table model agency_data_pipeline.shopify_customers_proc [CREATE TABLE in 6.77s]
2018-04-18 10:24:13,877: 10:24:13 | 24 of 92 START table model agency_data_pipeline.bing_ads_stats....... [RUN]
2018-04-18 10:24:13,878: Compiling model.agency_data_pipeline.bing_ads_stats
2018-04-18 10:24:13,892: 10:24:13 | 25 of 92 START table model agency_data_pipeline.shopify_orders_proc.. [RUN]
2018-04-18 10:24:13,892: Compiling model.agency_data_pipeline.shopify_orders_proc
2018-04-18 10:24:13,910: Acquiring new bigquery connection "shopify_orders_proc".
2018-04-18 10:24:13,911: Re-using an available connection from the pool.
2018-04-18 10:24:13,911: Fetching data for query shopify_orders_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 10:24:13,916: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_stats"
2018-04-18 10:24:13,917: Acquiring new bigquery connection "bing_ads_stats".
2018-04-18 10:24:13,918: Re-using an available connection from the pool.
2018-04-18 10:24:13,902: 10:24:13 | 26 of 92 START table model agency_data_pipeline.ga_mcf_stats......... [RUN]
2018-04-18 10:24:13,920: Compiling model.agency_data_pipeline.ga_mcf_stats
2018-04-18 10:24:13,934: Writing injected SQL for node "model.agency_data_pipeline.ga_mcf_stats"
2018-04-18 10:24:13,940: Acquiring new bigquery connection "ga_mcf_stats".
2018-04-18 10:24:13,940: Re-using an available connection from the pool.
2018-04-18 10:24:13,919: 10:24:13 | 27 of 92 START table model agency_data_pipeline.shopify_products_proc [RUN]
2018-04-18 10:24:13,944: Compiling model.agency_data_pipeline.shopify_products_proc
2018-04-18 10:24:13,966: Acquiring new bigquery connection "shopify_products_proc".
2018-04-18 10:24:13,966: Re-using an available connection from the pool.
2018-04-18 10:24:13,967: Fetching data for query shopify_products_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 10:24:14,350: Writing injected SQL for node "model.agency_data_pipeline.shopify_products_proc"
2018-04-18 10:24:14,370: Writing injected SQL for node "model.agency_data_pipeline.shopify_orders_proc"
2018-04-18 10:24:14,834: Model SQL (ga_mcf_stats):
SELECT  
date,
a.account account,
b.client client,
case when c.platform is null then "Unmapped" else c.platform end as platform,
case when c.channel is null then "Unmapped" else c.channel end as channel,
lower(a.source) source,
lower(a.medium) medium,
lower(campaign) campaign,
transactionid,
sum(transactions) first_touch_transactions,
sum(revenue) first_touch_revenue
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`ga_mcf_proc` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc` b 
ON ( a.account = b.account and
	a.lookup_platform = b.platform )
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc` c
ON ( lower(a.source) = c.source
  AND lower(a.medium) = c.medium 
  and a.account = c.account )
group by date, account, client, source, medium, campaign, platform, channel, transactionid
2018-04-18 10:24:14,880: Model SQL (bing_ads_stats):
select
a.date, 
a.account, 
a.channel,
a.platform,
url,
a.campaignname campaign,
utm_campaign,
cost,
clicks,
impressions,
transactions
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`bing_ads_ads` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`bing_ads_conversions` b
ON (
	a.date = b.date AND
	a.account = b.account AND
	a.campaignid = b.campaignid

)
2018-04-18 10:24:15,240: Model SQL (shopify_products_proc):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc`, `growth-engines-pipeline`.`agency_data_pipeline`.`shopify_refunds_proc`





with products as (

	
	SELECT
	'lucadanni' client_name,
	'Shopify' as lookup_platform,
	product_type,
	product_id,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY product_id ORDER BY _sdc_sequence DESC) lv
	FROM `growth-engines-pipeline.shopify_lucadanni.products` 
	cross join unnest(variants)
	
	

)

SELECT
b.account,
b.client,
b.platform,
max(product_type) product_type,
product_id
FROM products a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
ON ( a.client_name = b.client_name
  AND a.lookup_platform = b.platform )
where a.lv = a._sdc_sequence
group by product_id, account, client, platform


2018-04-18 10:24:15,275: Model SQL (shopify_orders_proc):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc`, `growth-engines-pipeline`.`agency_data_pipeline`.`shopify_refunds_proc`





with orders as (

	
	SELECT
	'lucadanni' client_name,
	'Shopify' as lookup_platform,
	created_at,
	order_number,
	quantity,
	cast(pre_tax_price as float64) price, 
	total_line_items_price total_order_price_undiscounted,
	total_discounts,
	cast(discounted_price as float64) total_order_shipping_price,
	total_price_usd total_order_price_incl_shipping,
	checkout_id,
	product_id, 
	landing_site,
	sku, 
	variant_title, 
	variant_id,
	_id line_item_id,
	customer.id customer_id,
	customer.orders_count orders_count,
	customer.created_at customer_created_at,
	customer.last_order_id last_order_id,
	financial_status,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY order_number, _id ORDER BY _sdc_sequence DESC) lv
	FROM `growth-engines-pipeline.shopify_lucadanni.orders` 
	cross join unnest(line_items), unnest(shipping_lines)
	where source_name != 'shopify_draft_order'
	
	

)

SELECT
b.account,
b.client,
b.platform,
created_at,
a.order_number,
a.quantity,
c.quantity refund_quantity,
case when c.quantity is not null then a.quantity - c.quantity else a.quantity end as final_quantity,
price, 
total_order_price_undiscounted,
total_discounts,
total_order_shipping_price,
total_order_price_incl_shipping,
refund_amount,
case when refund_amount is not null then price - refund_amount else price end as final_price,
a.checkout_id,
a.product_id, 
landing_site,
sku, 
variant_title, 
a.variant_id,
a.line_item_id,	
customer_id,
orders_count,
customer_created_at,
last_order_id,
a.financial_status
FROM orders a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
ON ( a.client_name = b.client_name
  AND a.lookup_platform = b.platform )
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`shopify_refunds_proc` c
ON ( a.order_number = c.order_number
	AND a.line_item_id = c.line_item_id )   	
where a.lv = a._sdc_sequence


2018-04-18 10:24:17,068: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109943c50>]}
2018-04-18 10:24:17,362: 10:24:17 | 24 of 92 OK created table model agency_data_pipeline.bing_ads_stats.. [CREATE TABLE in 3.19s]
2018-04-18 10:24:17,362: 10:24:17 | 28 of 92 START table model agency_data_pipeline.agg_customers_union.. [RUN]
2018-04-18 10:24:17,362: Compiling model.agency_data_pipeline.agg_customers_union
2018-04-18 10:24:17,370: Writing injected SQL for node "model.agency_data_pipeline.agg_customers_union"
2018-04-18 10:24:17,371: Acquiring new bigquery connection "agg_customers_union".
2018-04-18 10:24:17,372: Re-using an available connection from the pool.
2018-04-18 10:24:17,446: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1099107b8>]}
2018-04-18 10:24:17,705: 10:24:17 | 27 of 92 OK created table model agency_data_pipeline.shopify_products_proc [CREATE TABLE in 3.50s]
2018-04-18 10:24:18,289: Model SQL (agg_customers_union):
SELECT *
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`shopify_customers_proc`
2018-04-18 10:24:19,270: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1098cada0>]}
2018-04-18 10:24:19,528: 10:24:19 | 26 of 92 OK created table model agency_data_pipeline.ga_mcf_stats.... [CREATE TABLE in 5.35s]
2018-04-18 10:24:21,601: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109892cc0>]}
2018-04-18 10:24:21,850: 10:24:21 | 28 of 92 OK created table model agency_data_pipeline.agg_customers_union [CREATE TABLE in 4.24s]
2018-04-18 10:24:26,663: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10994cc88>]}
2018-04-18 10:24:27,295: 10:24:27 | 25 of 92 OK created table model agency_data_pipeline.shopify_orders_proc [CREATE TABLE in 12.77s]
2018-04-18 10:24:27,295: 10:24:27 | 29 of 92 START table model agency_data_pipeline.adwords_join......... [RUN]
2018-04-18 10:24:27,296: Compiling model.agency_data_pipeline.adwords_join
2018-04-18 10:24:27,296: 10:24:27 | 30 of 92 START table model agency_data_pipeline.agg_orders_union..... [RUN]
2018-04-18 10:24:27,304: Writing injected SQL for node "model.agency_data_pipeline.adwords_join"
2018-04-18 10:24:27,304: Compiling model.agency_data_pipeline.agg_orders_union
2018-04-18 10:24:27,296: 10:24:27 | 31 of 92 START table model agency_data_pipeline.ga_transactions...... [RUN]
2018-04-18 10:24:27,312: Compiling model.agency_data_pipeline.ga_transactions
2018-04-18 10:24:27,296: 10:24:27 | 32 of 92 START table model agency_data_pipeline.agg_products......... [RUN]
2018-04-18 10:24:27,351: Compiling model.agency_data_pipeline.agg_products
2018-04-18 10:24:27,312: Writing injected SQL for node "model.agency_data_pipeline.agg_orders_union"
2018-04-18 10:24:27,312: Acquiring new bigquery connection "adwords_join".
2018-04-18 10:24:27,374: Re-using an available connection from the pool.
2018-04-18 10:24:27,373: Acquiring new bigquery connection "agg_orders_union".
2018-04-18 10:24:27,378: Re-using an available connection from the pool.
2018-04-18 10:24:27,371: Writing injected SQL for node "model.agency_data_pipeline.agg_products"
2018-04-18 10:24:27,382: Acquiring new bigquery connection "ga_transactions".
2018-04-18 10:24:27,387: Re-using an available connection from the pool.
2018-04-18 10:24:27,388: Fetching data for query ga_transactions:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Google Analytics'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 10:24:27,397: Acquiring new bigquery connection "agg_products".
2018-04-18 10:24:27,398: Re-using an available connection from the pool.
2018-04-18 10:24:28,368: Model SQL (adwords_join):
select
a.day,
a.campaignid, 
a.campaign,
a.account, 
channel,
platform,
url,
utm_campaign,
cost,
impressions,
clicks,
impression_share_num,
impression_share_den,
transactions
FROM ( 
	
	select
	day,
	a.campaign,
	a.campaignid, 
	account, 
	channel,
	platform,
	url,
	cost,
	impressions,
	clicks,
	impression_share_num,
	impression_share_den
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_campaigns` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_urls` b
	ON a.campaignid = b.campaignid

) a 
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_ads` b
ON ( a.campaignid = b.campaignid
	and a.day = b.day )
2018-04-18 10:24:28,369: Model SQL (agg_products):
SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`shopify_products_proc`
2018-04-18 10:24:28,376: Model SQL (agg_orders_union):
SELECT
account,
client,
platform,
created_at,
order_number,
quantity,
refund_quantity,
final_quantity,
price, 
total_order_price_undiscounted,
total_discounts,
total_order_shipping_price,
total_order_price_incl_shipping,
refund_amount,
final_price,
checkout_id,
product_id, 
landing_site,
sku, 
variant_title, 
variant_id,
line_item_id,	
customer_id,
orders_count,
customer_created_at,
last_order_id,
financial_status
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`shopify_orders_proc`
2018-04-18 10:24:28,596: Fetching data for query ga_transactions:


        select
            goal_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_conversions`

        
        ##where 1 = 1
        where goal_type = 'Conversion'
        
        
        
        ##and 2 = 2
        and client_name = 'lucadanni'
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 10:24:29,467: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1098cada0>]}
2018-04-18 10:24:29,710: 10:24:29 | 32 of 92 OK created table model agency_data_pipeline.agg_products.... [CREATE TABLE in 2.12s]
2018-04-18 10:24:29,710: 10:24:29 | 33 of 92 START table model agency_data_pipeline.ga_traffic........... [RUN]
2018-04-18 10:24:29,710: Compiling model.agency_data_pipeline.ga_traffic
2018-04-18 10:24:29,726: Acquiring new bigquery connection "ga_traffic".
2018-04-18 10:24:29,726: Re-using an available connection from the pool.
2018-04-18 10:24:29,726: Fetching data for query ga_traffic:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'GA Traffic'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 10:24:30,320: Writing injected SQL for node "model.agency_data_pipeline.ga_transactions"
2018-04-18 10:24:31,040: Fetching data for query ga_traffic:


        select
            goal_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_conversions`

        
        ##where 1 = 1
        where goal_type = 'Conversion'
        
        
        
        ##and 2 = 2
        and client_name = 'lucadanni'
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 10:24:31,155: Model SQL (ga_transactions):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc`, `growth-engines-pipeline`.`agency_data_pipeline`.`ga_conversions`


##`growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` 



with ga_report as (

	    

	    	
	    	
		   	SELECT
		   	'lucadanni' as client_name,
		   	'Google Analytics' as lookup_platform,
			lower(trim(regexp_replace(replace(replace(replace(replace(CONCAT(hostname,landingpagepath),'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
			date,
			lower(source) source,
			lower(medium) medium,
			lower(campaign) campaign,
			cast(regexp_replace(transactionid, r'#', '') as int64) transactionid,
			transactions last_touch_transactions,
			(transactionrevenue - transactionshipping - transactiontax) as last_touch_revenue,
			transactionshipping,
			transactiontax,
			_sdc_sequence,
			first_value(_sdc_sequence) OVER (PARTITION BY hostname, landingpagepath, date, source, medium, transactionid ORDER BY _sdc_sequence DESC) lv
			FROM `growth-engines-pipeline.ga_lucadanni.report` 

		    
	   

)


SELECT  
cast(date as date) date,
b.account,
b.client client,
c.source source,
c.medium medium,
a.campaign campaign,
concat(a.source, ' / ', a.medium) source_medium,  
case when c.platform is null then "Unmapped" else c.platform end as platform,
case when c.channel is null then "Unmapped" else c.channel end as channel,
regexp_replace(url, r'offers.|offer.|get.|info.|pos.|go.|join.|pages.','') url,
transactionid,
max(last_touch_transactions) last_touch_transactions,
max(last_touch_revenue) last_touch_revenue,
max(transactionshipping) last_touch_shipping,
max(transactiontax) last_touch_tax
FROM ga_report a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
ON ( a.client_name = b.client_name 
	AND a.lookup_platform = b.platform )
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc` c
ON ( a.source = c.source
  AND a.medium = c.medium 
  AND a.client_name = c.client_name )
GROUP BY date, account, client, source, medium, campaign, source_medium, platform, channel, url, transactionid


2018-04-18 10:24:31,356: Writing injected SQL for node "model.agency_data_pipeline.ga_traffic"
2018-04-18 10:24:32,202: Model SQL (ga_traffic):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc`, `growth-engines-pipeline`.`agency_data_pipeline`.`ga_conversions`


##`growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` 



with ga_report as (

	    

	    	
	    	
		   	SELECT
		   	'lucadanni' as client_name,
		   	'GA Traffic' as lookup_platform,
			lower(trim(regexp_replace(replace(replace(replace(replace(CONCAT(hostname,landingpagepath),'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
			date,
			lower(source) source,
			lower(medium) medium,
			lower(campaign) campaign,
			sessions,
			## goal completion columns
							
				goalcompletionsall as goal_completions,		
			
			_sdc_sequence,
			first_value(_sdc_sequence) OVER (PARTITION BY hostname, landingpagepath, date, source, medium, campaign ORDER BY _sdc_sequence DESC) lv
			FROM `growth-engines-pipeline.ga_lucadanni_traffic.report` 

		    
	   

)


SELECT  
cast(date as date) date,
b.account,
b.client client,
c.source source,
c.medium medium,
a.campaign campaign,
concat(a.source, ' / ', a.medium) source_medium,  
case when c.platform is null then "Unmapped" else c.platform end as platform,
case when c.channel is null then "Unmapped" else c.channel end as channel,
regexp_replace(url, r'offers.|offer.|get.|info.|pos.|go.|join.|pages.','') url,
max(sessions) sessions,
max(goal_completions) goal_completions
FROM ga_report a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
ON ( a.client_name = b.client_name 
	AND a.lookup_platform = b.platform )
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc` c
ON ( a.source = c.source
  AND a.medium = c.medium 
  AND a.client_name = c.client_name )
GROUP BY date, account, client, source, medium, campaign, source_medium, platform, channel, url


2018-04-18 10:24:32,872: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cc41d68>]}
2018-04-18 10:24:33,440: 10:24:33 | 29 of 92 OK created table model agency_data_pipeline.adwords_join.... [CREATE TABLE in 5.58s]
2018-04-18 10:24:35,297: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cd7f7f0>]}
2018-04-18 10:24:35,551: 10:24:35 | 30 of 92 OK created table model agency_data_pipeline.agg_orders_union [CREATE TABLE in 7.99s]
2018-04-18 10:24:36,727: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1098865c0>]}
2018-04-18 10:24:36,993: 10:24:36 | 31 of 92 OK created table model agency_data_pipeline.ga_transactions. [CREATE TABLE in 9.42s]
2018-04-18 10:24:44,601: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1098e5d68>]}
2018-04-18 10:24:44,869: 10:24:44 | 33 of 92 OK created table model agency_data_pipeline.ga_traffic...... [CREATE TABLE in 14.89s]
2018-04-18 10:24:44,870: 10:24:44 | 34 of 92 START table model agency_data_pipeline.agg_transaction_line_item [RUN]
2018-04-18 10:24:44,870: 10:24:44 | 35 of 92 START table model agency_data_pipeline.adwords_impression_share [RUN]
2018-04-18 10:24:44,871: 10:24:44 | 36 of 92 START table model agency_data_pipeline.agg_transaction_order_number [RUN]
2018-04-18 10:24:44,871: 10:24:44 | 37 of 92 START table model agency_data_pipeline.fb_ads_stats......... [RUN]
2018-04-18 10:24:44,871: Compiling model.agency_data_pipeline.agg_transaction_line_item
2018-04-18 10:24:44,871: Compiling model.agency_data_pipeline.adwords_impression_share
2018-04-18 10:24:44,872: Compiling model.agency_data_pipeline.agg_transaction_order_number
2018-04-18 10:24:44,872: Compiling model.agency_data_pipeline.fb_ads_stats
2018-04-18 10:24:44,880: Writing injected SQL for node "model.agency_data_pipeline.agg_transaction_line_item"
2018-04-18 10:24:44,887: Writing injected SQL for node "model.agency_data_pipeline.adwords_impression_share"
2018-04-18 10:24:44,891: Writing injected SQL for node "model.agency_data_pipeline.agg_transaction_order_number"
2018-04-18 10:24:44,897: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_stats"
2018-04-18 10:24:44,899: Acquiring new bigquery connection "agg_transaction_line_item".
2018-04-18 10:24:44,899: Acquiring new bigquery connection "agg_transaction_order_number".
2018-04-18 10:24:44,899: Re-using an available connection from the pool.
2018-04-18 10:24:44,900: Re-using an available connection from the pool.
2018-04-18 10:24:44,902: Acquiring new bigquery connection "adwords_impression_share".
2018-04-18 10:24:44,902: Re-using an available connection from the pool.
2018-04-18 10:24:44,905: Acquiring new bigquery connection "fb_ads_stats".
2018-04-18 10:24:44,905: Re-using an available connection from the pool.
2018-04-18 10:24:45,879: Model SQL (agg_transaction_order_number):
SELECT
client,
cast(created_at as date) date,
order_number,
customer_id,
sum(final_quantity) final_quantity,
sum(final_price) final_price,
max(total_order_shipping_price) shipping_price
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`agg_orders_union`
GROUP BY client, created_at, order_number, customer_id
2018-04-18 10:24:45,884: Model SQL (fb_ads_stats):
with cost as (

    select 
        date, account, ad_id, campaign,
        cost, impressions, clicks, null as conversions
    from `growth-engines-pipeline`.`agency_data_pipeline`.`fb_ads_insights`
),

conversions as (

    select 
        date, account, ad_id, campaign,
        null as cost, null as impressions, null as clicks, conversions
    from `growth-engines-pipeline`.`agency_data_pipeline`.`fb_ads_insights_conversions`
),

urls as (

    select ad_id, url
    from `growth-engines-pipeline`.`agency_data_pipeline`.`fb_ads`
)


SELECT
    cast(date as date) date,
    'FB Ads' platform,
    'Paid' channel,
    account, 
    b.url url,
    campaign,
    lower(campaign) utm_campaign, 
    sum(cost) cost,
    sum(impressions) impressions,
    sum(clicks) clicks,
    sum(conversions) transactions
FROM
(
    SELECT *
    FROM 
      cost
    UNION ALL
    SELECT *
    FROM 
      conversions
) a
LEFT JOIN urls b
ON ( a.ad_id = b.ad_id )
group by date, platform, channel, account, url, campaign, utm_campaign
2018-04-18 10:24:45,885: Model SQL (adwords_impression_share):
SELECT 
cast(day as date) date, 
account, 
channel,
platform,
sum(impression_share_num) impressions,
sum(impression_share_den) available_impressions
FROM 
  `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_join`
group by date, account, platform, channel
2018-04-18 10:24:45,886: Model SQL (agg_transaction_line_item):
SELECT
client,
created_at,
order_number,
quantity,
refund_quantity,
final_quantity,
price, 
total_order_price_undiscounted,
total_discounts,
total_order_shipping_price,
total_order_price_incl_shipping,
refund_amount,
final_price,
checkout_id,
product_id, 
landing_site,
sku, 
variant_title, 
variant_id,
line_item_id,	
customer_id,
orders_count,
customer_created_at,
last_order_id,
financial_status
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`agg_orders_union`
2018-04-18 10:24:48,088: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cd88860>]}
2018-04-18 10:24:48,115: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cd65978>]}
2018-04-18 10:24:48,526: 10:24:48 | 37 of 92 OK created table model agency_data_pipeline.fb_ads_stats.... [CREATE TABLE in 3.22s]
2018-04-18 10:24:48,527: 10:24:48 | 38 of 92 START table model agency_data_pipeline.adwords_stats........ [RUN]
2018-04-18 10:24:48,528: Compiling model.agency_data_pipeline.adwords_stats
2018-04-18 10:24:48,537: Writing injected SQL for node "model.agency_data_pipeline.adwords_stats"
2018-04-18 10:24:48,539: Acquiring new bigquery connection "adwords_stats".
2018-04-18 10:24:48,540: Re-using an available connection from the pool.
2018-04-18 10:24:48,796: 10:24:48 | 35 of 92 OK created table model agency_data_pipeline.adwords_impression_share [CREATE TABLE in 3.24s]
2018-04-18 10:24:49,403: Model SQL (adwords_stats):
SELECT 
cast(day as date) date, 
account, 
platform,
channel,
url,
utm_campaign,
campaign,
sum(cost) cost,
sum(impressions) impressions,
sum(clicks) clicks,
sum(transactions) transactions
FROM 
  `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_join`
group by date, account, platform, channel, url, campaign, utm_campaign
2018-04-18 10:24:50,251: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1098866d8>]}
2018-04-18 10:24:50,518: 10:24:50 | 36 of 92 OK created table model agency_data_pipeline.agg_transaction_order_number [CREATE TABLE in 5.38s]
2018-04-18 10:24:53,583: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cc41d68>]}
2018-04-18 10:24:53,908: 10:24:53 | 34 of 92 OK created table model agency_data_pipeline.agg_transaction_line_item [CREATE TABLE in 8.71s]
2018-04-18 10:24:55,640: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cd88860>]}
2018-04-18 10:24:55,896: 10:24:55 | 38 of 92 OK created table model agency_data_pipeline.adwords_stats... [CREATE TABLE in 7.11s]
2018-04-18 10:24:55,896: 10:24:55 | 39 of 92 START table model agency_data_pipeline.customers_by_transaction [RUN]
2018-04-18 10:24:55,897: Compiling model.agency_data_pipeline.customers_by_transaction
2018-04-18 10:24:55,905: Writing injected SQL for node "model.agency_data_pipeline.customers_by_transaction"
2018-04-18 10:24:55,906: Acquiring new bigquery connection "customers_by_transaction".
2018-04-18 10:24:55,906: Re-using an available connection from the pool.
2018-04-18 10:24:57,140: Model SQL (customers_by_transaction):
SELECT
client,
customer_id,
order_number,
order_date,
first_order_date,
case when first_order_number = order_number then 'New' else 'Existing' end as order_type,
final_price,
first_order_revenue,
lifetime_revenue
FROM

(

	SELECT
	client,
	customer_id,
	order_number,
	date order_date,
	first_value(date) over w1 first_order_date,
	first_value(order_number) over w1 first_order_number,
	first_value(final_price) over w1 first_order_revenue,
    final_price,
	sum(final_price) over w2 lifetime_revenue
	FROM
    `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_order_number`
	WINDOW w1 as (PARTITION BY client, customer_id ORDER BY date desc),
	w2 as (PARTITION BY client, customer_id)
)
2018-04-18 10:25:00,441: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cd65978>]}
2018-04-18 10:25:00,694: 10:25:00 | 39 of 92 OK created table model agency_data_pipeline.customers_by_transaction [CREATE TABLE in 4.54s]
2018-04-18 10:25:00,695: 10:25:00 | 40 of 92 START table model agency_data_pipeline.agg_ga_transaction_order_number [RUN]
2018-04-18 10:25:00,695: 10:25:00 | 41 of 92 START table model agency_data_pipeline.frequency_proc....... [RUN]
2018-04-18 10:25:00,695: Compiling model.agency_data_pipeline.agg_ga_transaction_order_number
2018-04-18 10:25:00,696: Compiling model.agency_data_pipeline.frequency_proc
2018-04-18 10:25:00,704: Writing injected SQL for node "model.agency_data_pipeline.agg_ga_transaction_order_number"
2018-04-18 10:25:00,709: Writing injected SQL for node "model.agency_data_pipeline.frequency_proc"
2018-04-18 10:25:00,713: Acquiring new bigquery connection "agg_ga_transaction_order_number".
2018-04-18 10:25:00,713: Re-using an available connection from the pool.
2018-04-18 10:25:00,715: Acquiring new bigquery connection "frequency_proc".
2018-04-18 10:25:00,716: Re-using an available connection from the pool.
2018-04-18 10:25:01,520: Model SQL (frequency_proc):
WITH transactions AS (

  	SELECT 
	client,
	customer_id,
	order_number,
	date,
	unix_date(date) d
	FROM
	`growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_order_number`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)

SELECT 
client,
'Rolling 365' as period,
date_in_range date,
unix_date_in_range, 
customer_id,
count(distinct(order_number)) frequency
FROM daterange
JOIN transactions
ON transactions.d > ( daterange.unix_date_in_range - 365 )
AND transactions.d <= daterange.unix_date_in_range
group by client, unix_date_in_range, customer_id, date
2018-04-18 10:25:01,540: Model SQL (agg_ga_transaction_order_number):
with ga as (

    select 
        date, account, client, 
        channel as last_touch_channel, 
        platform as last_touch_platform, 
        url as last_touch_url, 
        campaign as last_touch_utm_campaign, 
        '' as first_touch_channel, 
        '' as first_touch_platform, 
        '' as first_touch_utm_campaign, 
        transactionid,
        last_touch_transactions, last_touch_revenue,
        last_touch_shipping, last_touch_tax,
        null as first_touch_transactions, null as first_touch_revenue
    from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_transactions`

),

ga_mcf as (

    select 
        date, account, client, 
        '' as last_touch_channel,
        '' as last_touch_platform,
        '' as last_touch_url,
        '' as last_touch_utm_campaign, 
        channel as first_touch_channel, 
        platform as first_touch_platform, 
        campaign as first_touch_utm_campaign, 
        transactionid, 
        null as last_touch_transactions, null as last_touch_revenue,
        null as last_touch_shipping, null as last_touch_tax,
        first_touch_transactions, first_touch_revenue
    from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_mcf_stats`

)


SELECT
    date, 
    client,
    transactionid,
    max(last_touch_channel) last_touch_channel, 
    max(last_touch_platform) last_touch_platform, 
    max(last_touch_url) last_touch_url, 
    max(last_touch_utm_campaign) last_touch_utm_campaign, 
    max(first_touch_channel) first_touch_channel, 
    max(first_touch_platform) first_touch_platform, 
    max(first_touch_utm_campaign) first_touch_utm_campaign,
    sum(last_touch_transactions) last_touch_transactions,
    sum(last_touch_revenue) last_touch_revenue,
    sum(last_touch_shipping) last_touch_shipping_revenue,
    sum(last_touch_tax) last_touch_tax_revenue,
    sum(first_touch_transactions) first_touch_transactions,
    sum(first_touch_revenue) - ifnull(sum(last_touch_shipping),0) - ifnull(sum(last_touch_tax),0) first_touch_revenue
FROM
(
    SELECT *
    FROM 
      ga
    UNION ALL
    SELECT *
    FROM 
      ga_mcf
) 
GROUP BY
    date, client, transactionid
2018-04-18 10:25:07,007: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cd88860>]}
2018-04-18 10:25:07,332: 10:25:07 | 40 of 92 OK created table model agency_data_pipeline.agg_ga_transaction_order_number [CREATE TABLE in 6.31s]
2018-04-18 10:25:14,733: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1098e56a0>]}
2018-04-18 10:25:14,993: 10:25:14 | 41 of 92 OK created table model agency_data_pipeline.frequency_proc.. [CREATE TABLE in 14.04s]
2018-04-18 10:25:14,994: 10:25:14 | 42 of 92 START table model agency_data_pipeline.frequency_stats...... [RUN]
2018-04-18 10:25:14,994: 10:25:14 | 43 of 92 START table model agency_data_pipeline.agg_ga_campaign...... [RUN]
2018-04-18 10:25:14,994: Compiling model.agency_data_pipeline.frequency_stats
2018-04-18 10:25:14,994: 10:25:14 | 44 of 92 START table model agency_data_pipeline.agg_transaction_line_item_type [RUN]
2018-04-18 10:25:14,994: Compiling model.agency_data_pipeline.agg_ga_campaign
2018-04-18 10:25:15,003: Writing injected SQL for node "model.agency_data_pipeline.frequency_stats"
2018-04-18 10:25:15,003: Compiling model.agency_data_pipeline.agg_transaction_line_item_type
2018-04-18 10:25:15,009: Writing injected SQL for node "model.agency_data_pipeline.agg_ga_campaign"
2018-04-18 10:25:15,015: Writing injected SQL for node "model.agency_data_pipeline.agg_transaction_line_item_type"
2018-04-18 10:25:15,016: Acquiring new bigquery connection "frequency_stats".
2018-04-18 10:25:15,016: Re-using an available connection from the pool.
2018-04-18 10:25:15,018: Acquiring new bigquery connection "agg_ga_campaign".
2018-04-18 10:25:15,018: Re-using an available connection from the pool.
2018-04-18 10:25:15,019: Acquiring new bigquery connection "agg_transaction_line_item_type".
2018-04-18 10:25:15,020: Re-using an available connection from the pool.
2018-04-18 10:25:15,781: Model SQL (frequency_stats):
SELECT
client,
period,
date,
unix_date_in_range,
frequency_segment,
customers,
sum(customers) over (partition by client, period, date) total_customers,
customers /( sum(customers) over (partition by client, period, date) ) pct_of_customers
FROM
( 
	SELECT
	client,
	period,
	date,
	unix_date_in_range,
	case when frequency = 1 then '1' 
		when frequency = 2 then '2'
		when frequency > 2 then '3+'
		else null end as frequency_segment,
	sum(customers) customers
	FROM (

		SELECT 
		client,
		period,
		date,
		unix_date_in_range, 
		frequency,
		count(distinct(customer_id)) customers
		FROM `growth-engines-pipeline`.`agency_data_pipeline`.`frequency_proc`
		group by client, period, date, unix_date_in_range, frequency
	)
	group by client, period, date, unix_date_in_range, frequency_segment
)
2018-04-18 10:25:15,850: Model SQL (agg_ga_campaign):
with ga_transactions as (

	select 
		date, account, client, channel, platform, url, 
		campaign,
		null as sessions, null as goal_completions, last_touch_transactions, last_touch_revenue,
		last_touch_shipping, last_touch_tax,
		null as first_touch_transactions, null as first_touch_revenue
	from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_transactions`

),

ga_traffic as (

    select 
        date, account, client, channel, platform, url, 
        campaign,
        sessions, goal_completions, null as last_touch_transactions, null as last_touch_revenue,
        null as last_touch_shipping, null as last_touch_tax,
        null as first_touch_transactions, null as first_touch_revenue
    from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_traffic`

),

ga_mcf as (

	select 
		date, account, client, channel, platform, '' as url,
		campaign, 
		null as sessions, null as goal_completions, null as last_touch_transactions, null as last_touch_revenue,
		null as last_touch_shipping, null as last_touch_tax,
		first_touch_transactions, first_touch_revenue
	from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_mcf_stats`

)


SELECT
    date, 
    client,
    platform,
    channel, 
    url,
    campaign utm_campaign,
	sum(sessions) sessions,
	sum(goal_completions) goal_completions,
	sum(last_touch_transactions) last_touch_transactions,
	sum(last_touch_revenue) last_touch_revenue,
    sum(last_touch_shipping) last_touch_shipping_revenue,
    sum(last_touch_tax) last_touch_tax_revenue,
    sum(first_touch_transactions) first_touch_transactions,
    sum(first_touch_revenue) - sum(ifnull(last_touch_shipping,0)) - sum(ifnull(last_touch_tax,0)) first_touch_revenue

FROM
(
    SELECT *
    FROM 
      ga_transactions
    UNION ALL
    SELECT *
    FROM 
      ga_traffic
    UNION ALL
    SELECT *
    FROM 
      ga_mcf
) 
GROUP BY
    date, client, platform, channel, url, utm_campaign
2018-04-18 10:25:15,924: Model SQL (agg_transaction_line_item_type):
SELECT
client,
product_id,
product_type,
customer_id,
sku,
order_number,
created_at,
final_quantity,
final_price
FROM

( 
	SELECT 
	a.client, 
	a.product_id,
	product_type,
	customer_id,
	a.sku, 
	order_number,
	created_at,
	final_quantity,
	final_price
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_line_item` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`agg_products` b
	ON (
		a.product_id = b.product_id
	  and a.client = b.client
		)

)
2018-04-18 10:25:21,334: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109905978>]}
2018-04-18 10:25:21,380: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1098e5048>]}
2018-04-18 10:25:21,599: 10:25:21 | 42 of 92 OK created table model agency_data_pipeline.frequency_stats. [CREATE TABLE in 6.34s]
2018-04-18 10:25:21,884: 10:25:21 | 44 of 92 OK created table model agency_data_pipeline.agg_transaction_line_item_type [CREATE TABLE in 6.38s]
2018-04-18 10:25:25,834: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1098e5048>]}
2018-04-18 10:25:26,521: 10:25:26 | 43 of 92 OK created table model agency_data_pipeline.agg_ga_campaign. [CREATE TABLE in 10.84s]
2018-04-18 10:25:26,522: 10:25:26 | 45 of 92 START table model agency_data_pipeline.customers_first_purchase_product_type_proc [RUN]
2018-04-18 10:25:26,522: 10:25:26 | 46 of 92 START table model agency_data_pipeline.agg_transaction_product_type [RUN]
2018-04-18 10:25:26,523: Compiling model.agency_data_pipeline.customers_first_purchase_product_type_proc
2018-04-18 10:25:26,523: Compiling model.agency_data_pipeline.agg_transaction_product_type
2018-04-18 10:25:26,538: Writing injected SQL for node "model.agency_data_pipeline.customers_first_purchase_product_type_proc"
2018-04-18 10:25:26,539: Writing injected SQL for node "model.agency_data_pipeline.agg_transaction_product_type"
2018-04-18 10:25:26,542: Acquiring new bigquery connection "agg_transaction_product_type".
2018-04-18 10:25:26,542: Re-using an available connection from the pool.
2018-04-18 10:25:26,544: Acquiring new bigquery connection "customers_first_purchase_product_type_proc".
2018-04-18 10:25:26,546: Re-using an available connection from the pool.
2018-04-18 10:25:27,365: Model SQL (customers_first_purchase_product_type_proc):
SELECT 
client, 
customer_id, 
product_type,
min(cast(created_at as date)) first_order_date,
unix_date( min(cast(created_at as date))) first_order_unix_date
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_line_item_type`
GROUP BY client, customer_id, product_type
2018-04-18 10:25:27,373: Model SQL (agg_transaction_product_type):
SELECT
client,
product_type,
customer_id,
order_number,
created_at,
first_value(product_type) over (PARTITION BY client, customer_id, order_number, created_at ORDER BY final_price desc) as top_order_product_type,
final_quantity,
final_price,
sum(final_quantity) over (PARTITION BY client, customer_id, order_number) as total_order_quantity,
sum(final_price) over (PARTITION BY client, customer_id, order_number) as total_order_value
FROM
	(
		SELECT
		client,
		product_type,
		customer_id,
		order_number,
		created_at,
		sum(final_quantity) final_quantity,
		sum(final_price) final_price
		FROM
		`growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_line_item_type`
		GROUP BY
		client,
		product_type,
		customer_id,
		order_number,
		created_at
	)
2018-04-18 10:25:30,625: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1098e56a0>]}
2018-04-18 10:25:30,872: 10:25:30 | 45 of 92 OK created table model agency_data_pipeline.customers_first_purchase_product_type_proc [CREATE TABLE in 4.10s]
2018-04-18 10:25:31,788: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10990def0>]}
2018-04-18 10:25:32,034: 10:25:32 | 46 of 92 OK created table model agency_data_pipeline.agg_transaction_product_type [CREATE TABLE in 5.27s]
2018-04-18 10:25:32,035: 10:25:32 | 47 of 92 START table model agency_data_pipeline.products_proc........ [RUN]
2018-04-18 10:25:32,036: 10:25:32 | 48 of 92 START table model agency_data_pipeline.order_paths_proc..... [RUN]
2018-04-18 10:25:32,036: Compiling model.agency_data_pipeline.products_proc
2018-04-18 10:25:32,036: 10:25:32 | 49 of 92 START table model agency_data_pipeline.customers_products_proc [RUN]
2018-04-18 10:25:32,036: Compiling model.agency_data_pipeline.order_paths_proc
2018-04-18 10:25:32,046: Writing injected SQL for node "model.agency_data_pipeline.products_proc"
2018-04-18 10:25:32,046: Compiling model.agency_data_pipeline.customers_products_proc
2018-04-18 10:25:32,051: Writing injected SQL for node "model.agency_data_pipeline.order_paths_proc"
2018-04-18 10:25:32,057: Writing injected SQL for node "model.agency_data_pipeline.customers_products_proc"
2018-04-18 10:25:32,058: Acquiring new bigquery connection "products_proc".
2018-04-18 10:25:32,058: Re-using an available connection from the pool.
2018-04-18 10:25:32,059: Acquiring new bigquery connection "order_paths_proc".
2018-04-18 10:25:32,060: Re-using an available connection from the pool.
2018-04-18 10:25:32,061: Acquiring new bigquery connection "customers_products_proc".
2018-04-18 10:25:32,063: Re-using an available connection from the pool.
2018-04-18 10:25:32,885: Model SQL (order_paths_proc):
SELECT
client, 
customer_id, 
first_value(product_type) OVER w1 as first_product_type,
nth_value(product_type, 2) OVER w1 as second_product_type,
cast(first_value(created_at) OVER w1 as date) as first_purchase_date,
cast(nth_value(created_at, 2) OVER w1 as date) as second_purchase_date,
cast(nth_value(created_at, 3) OVER w1 as date) as third_purchase_date,
cast(nth_value(created_at, 4) OVER w1 as date) as fourth_purchase_date,
cast(nth_value(created_at, 5) OVER w1 as date) as fifth_purchase_date,
first_value(order_number) OVER w1 as first_order_number,
nth_value(order_number, 2) OVER w1 as second_order_number,
nth_value(order_number, 3) OVER w1 as third_order_number,
nth_value(order_number, 4) OVER w1 as fourth_order_number,
nth_value(order_number, 5) OVER w1 as fifth_order_number,
first_value(total_order_value) OVER w1 as first_order_value,
nth_value(total_order_value, 2) OVER w1 as second_order_value
FROM (
	  
	  SELECT 
	  client, 
	  product_type,
	  customer_id,
	  order_number,
	  created_at, 
	  total_order_value
	  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_product_type`
	  WHERE product_type = top_order_product_type

)
WINDOW w1 as (PARTITION BY client, customer_id ORDER BY created_at asc)
2018-04-18 10:25:32,991: Model SQL (customers_products_proc):
WITH customers AS (
  SELECT 
  client, 
  product_id,
  product_type,
  customer_id,
  sku, 
  order_number,
  cast(created_at as date) order_date,
  unix_date(cast(created_at as date)) unix_order_date, 
  final_quantity quantity,
  final_price revenue
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_line_item_type`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)

SELECT 
client,
period,
customer_id,
product_type,
date,
window_end_unix_date,
window_end_unix_date - 365 as window_start_unix_date,
window_end_unix_date - unix_date(recent_order) recency_days,
frequency,
quantity,
revenue,
case when frequency > 0 then revenue/frequency else 0 end as aov
FROM 
(  

  SELECT 
  client,
  'Rolling 365' as period,
  customer_id,
  product_type,
  date_in_range date,
  unix_date_in_range,
  unix_date_in_range window_end_unix_date, 
  max(order_date) recent_order,
  sum(quantity) as quantity,
  sum(revenue) as revenue,
  count(distinct(order_number)) as frequency
  FROM daterange
  JOIN customers
  ON customers.unix_order_date > ( daterange.unix_date_in_range - 365 )
  AND customers.unix_order_date <= daterange.unix_date_in_range
  GROUP BY client, customer_id, date, unix_date_in_range, product_type

  UNION ALL

  SELECT 
  client,
  'Rolling 365 (t-1mo)' as period,
  customer_id,
  product_type,
  date_in_range date,
  unix_date_in_range, 
  unix_date_in_range - 30 window_end_unix_date, 
  max(order_date) recent_order,
  sum(quantity) as quantity,
  sum(revenue) as revenue,
  count(distinct(order_number)) as frequency
  FROM daterange
  JOIN customers
  ON customers.unix_order_date > ( daterange.unix_date_in_range - 395 )
  AND customers.unix_order_date <= ( daterange.unix_date_in_range - 30 )
  GROUP BY client, customer_id, date, unix_date_in_range, product_type

  UNION ALL

  SELECT 
  client,
  'Rolling 365 (t-1yr)' as period,
  customer_id,
  product_type,
  date_in_range date,
  unix_date_in_range, 
  unix_date_in_range - 365 window_end_unix_date, 
  max(order_date) recent_order,
  sum(quantity) as quantity,
  sum(revenue) as revenue,
  count(distinct(order_number)) as frequency
  FROM daterange
  JOIN customers
  ON customers.unix_order_date > ( daterange.unix_date_in_range - 730 )
  AND customers.unix_order_date <= ( daterange.unix_date_in_range - 365 )
  GROUP BY client, customer_id, date, unix_date_in_range, product_type

)
2018-04-18 10:25:33,003: Model SQL (products_proc):
WITH transactions AS (
  SELECT 
  client, 
  product_id,
  product_type,
  customer_id,
  sku, 
  order_number,
  unix_date(cast(created_at as date)) d, 
  final_quantity,
  final_price,
  first_value(unix_date(cast(created_at as date))) over (partition by client, product_id, sku order by created_at asc) first_purchase_unix_date
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_line_item_type`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)

SELECT 
client,
'Last 30' as period,
sku,
product_type,
date_in_range date,
unix_date_in_range, 
case when 
  ( first_purchase_unix_date > ( daterange.unix_date_in_range - 365 ) and first_purchase_unix_date <= daterange.unix_date_in_range )
  then 'New' else 'Existing' end as newness,  
count(distinct(customer_id)) unique_customers,
count(distinct(order_number)) orders,
sum(final_quantity) quantity,
sum(final_price) revenue,
count(distinct(d)) days_sold
FROM daterange
JOIN transactions
ON transactions.d > ( daterange.unix_date_in_range - 30 )
AND transactions.d <= daterange.unix_date_in_range
group by date_in_range, unix_date_in_range, client, sku, product_type, newness

UNION ALL

SELECT 
client,
'Last 90' as period,
sku, 
product_type,
date_in_range date,
unix_date_in_range, 
case when 
  ( first_purchase_unix_date > ( daterange.unix_date_in_range - 365 ) and first_purchase_unix_date <= daterange.unix_date_in_range )
  then 'New' else 'Existing' end as newness,  
count(distinct(customer_id)) unique_customers,
count(distinct(order_number)) orders,
sum(final_quantity) quantity,
sum(final_price) revenue,
count(distinct(d)) days_sold
FROM daterange
JOIN transactions
ON transactions.d > ( daterange.unix_date_in_range - 90 )
AND transactions.d <= daterange.unix_date_in_range
group by date_in_range, unix_date_in_range, client, sku, product_type, newness

UNION ALL

SELECT 
client,
'YoY 30' as date_range,
sku, 
product_type,
date_in_range date,
unix_date_in_range,
case when 
  ( first_purchase_unix_date > ( daterange.unix_date_in_range - 730 ) and first_purchase_unix_date <= ( daterange.unix_date_in_range - 365 ))
  then 'New' else 'Existing' end as newness,   
count(distinct(customer_id)) unique_customers,
count(distinct(order_number)) orders,
sum(final_quantity) quantity,
sum(final_price) revenue,
count(distinct(d)) days_sold
FROM daterange
JOIN transactions
ON transactions.d > ( daterange.unix_date_in_range - 395 )
AND transactions.d <= ( daterange.unix_date_in_range - 365 )
group by date_in_range, unix_date_in_range, client, sku, product_type, newness
2018-04-18 10:25:36,203: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cd65f60>]}
2018-04-18 10:25:36,456: 10:25:36 | 48 of 92 OK created table model agency_data_pipeline.order_paths_proc [CREATE TABLE in 4.17s]
2018-04-18 10:25:41,793: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1098e5048>]}
2018-04-18 10:25:42,044: 10:25:42 | 47 of 92 OK created table model agency_data_pipeline.products_proc... [CREATE TABLE in 9.76s]
2018-04-18 10:26:08,776: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1098a0748>]}
2018-04-18 10:26:09,062: 10:26:09 | 49 of 92 OK created table model agency_data_pipeline.customers_products_proc [CREATE TABLE in 36.73s]
2018-04-18 10:26:09,063: 10:26:09 | 50 of 92 START table model agency_data_pipeline.order_paths_agg...... [RUN]
2018-04-18 10:26:09,064: 10:26:09 | 51 of 92 START table model agency_data_pipeline.segment_proc_sku..... [RUN]
2018-04-18 10:26:09,064: Compiling model.agency_data_pipeline.order_paths_agg
2018-04-18 10:26:09,064: Compiling model.agency_data_pipeline.segment_proc_sku
2018-04-18 10:26:09,084: Writing injected SQL for node "model.agency_data_pipeline.order_paths_agg"
2018-04-18 10:26:09,088: Writing injected SQL for node "model.agency_data_pipeline.segment_proc_sku"
2018-04-18 10:26:09,092: Acquiring new bigquery connection "order_paths_agg".
2018-04-18 10:26:09,093: Acquiring new bigquery connection "segment_proc_sku".
2018-04-18 10:26:09,094: Re-using an available connection from the pool.
2018-04-18 10:26:09,094: Re-using an available connection from the pool.
2018-04-18 10:26:10,077: Model SQL (order_paths_agg):
SELECT
client, 
first_product_type,
second_product_type,
first_purchase_date,
count(distinct(customer_id)) customer_count, 
count(distinct(second_order_number)) second_orders, 
count(distinct(third_order_number)) third_orders, 
count(distinct(fourth_order_number)) fourth_orders, 
count(distinct(fifth_order_number)) fifth_orders, 
sum(date_diff(second_purchase_date, first_purchase_date, DAY)) second_order_latency_days,
sum(date_diff(third_purchase_date, second_purchase_date, DAY)) third_order_latency_days,
sum(date_diff(fourth_purchase_date, third_purchase_date, DAY)) fourth_order_latency_days,
sum(date_diff(fifth_purchase_date, fourth_purchase_date, DAY)) fifth_order_latency_days,
sum(first_order_value) first_order_revenue,
sum(second_order_value) second_order_revenue
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`order_paths_proc`
where second_product_type is not null
GROUP BY client, first_product_type, second_product_type, first_purchase_date
2018-04-18 10:26:10,183: Model SQL (segment_proc_sku):
SELECT
client,
period,
sku, 
product_type,
date,
unique_customers,
orders,
quantity,
revenue,
case 
	when avg_daily_revenue >= avg_daily_revenue_90pct and avg_daily_quantity >= avg_daily_quantity_80pct then 'Best Seller'
	when avg_daily_revenue >= avg_daily_revenue_70pct and avg_daily_quantity >= avg_daily_quantity_40pct then 'Good'
	when avg_daily_revenue < avg_daily_revenue_70pct and avg_daily_revenue >= avg_daily_revenue_30pct and avg_daily_quantity < avg_daily_quantity_70pct then 'Average'
	when avg_daily_revenue < avg_daily_revenue_30pct and avg_daily_quantity < avg_daily_quantity_30pct then 'Poor'
	else 'Unbucketed' end as segment,
newness,	
avg_daily_revenue_90pct,
avg_daily_revenue_70pct,
avg_daily_revenue_30pct,
avg_daily_quantity_80pct,
avg_daily_quantity_70pct,
avg_daily_quantity_40pct,
avg_daily_quantity_30pct

FROM (

	SELECT
	client,
	period,
	sku, 
	product_type,
	newness,
	date,
	unique_customers,
	orders,
	quantity,
	revenue,
	days_sold,
	avg_daily_revenue,
	avg_daily_quantity,
	PERCENTILE_CONT(avg_daily_revenue, 0.90) OVER w1 AS avg_daily_revenue_90pct,
	PERCENTILE_CONT(avg_daily_revenue, 0.70) OVER w1 AS avg_daily_revenue_70pct,
	PERCENTILE_CONT(avg_daily_revenue, 0.3) OVER w1 AS avg_daily_revenue_30pct,
	PERCENTILE_CONT(avg_daily_quantity, 0.80) OVER w1 AS avg_daily_quantity_80pct,
	PERCENTILE_CONT(avg_daily_quantity, 0.70) OVER w1 AS avg_daily_quantity_70pct,
	PERCENTILE_CONT(avg_daily_quantity, 0.40) OVER w1 AS avg_daily_quantity_40pct,
	PERCENTILE_CONT(avg_daily_quantity, 0.3) OVER w1 AS avg_daily_quantity_30pct

	FROM
	(
		SELECT 
		client,
		period,
		sku, 
		product_type,
		newness,
		date,
		unique_customers,
		orders,
		quantity,
		revenue,
		days_sold,
		case when days_sold > 0 then revenue/days_sold else null end as avg_daily_revenue,
		case when days_sold > 0 then quantity/days_sold else null end as avg_daily_quantity
		FROM `growth-engines-pipeline`.`agency_data_pipeline`.`products_proc`
	)
	WINDOW w1 as (PARTITION BY client, period, date)
)
2018-04-18 10:26:12,276: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10990def0>]}
2018-04-18 10:26:12,546: 10:26:12 | 50 of 92 OK created table model agency_data_pipeline.order_paths_agg. [CREATE TABLE in 3.21s]
2018-04-18 10:26:13,457: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109905978>]}
2018-04-18 10:26:13,774: 10:26:13 | 51 of 92 OK created table model agency_data_pipeline.segment_proc_sku [CREATE TABLE in 4.39s]
2018-04-18 10:26:13,775: 10:26:13 | 52 of 92 START table model agency_data_pipeline.agg_transaction...... [RUN]
2018-04-18 10:26:13,775: Compiling model.agency_data_pipeline.agg_transaction
2018-04-18 10:26:13,775: 10:26:13 | 53 of 92 START table model agency_data_pipeline.segment_proc_customers_products [RUN]
2018-04-18 10:26:13,782: Writing injected SQL for node "model.agency_data_pipeline.agg_transaction"
2018-04-18 10:26:13,775: 10:26:13 | 54 of 92 START table model agency_data_pipeline.agg_ga_transaction... [RUN]
2018-04-18 10:26:13,783: Compiling model.agency_data_pipeline.segment_proc_customers_products
2018-04-18 10:26:13,775: 10:26:13 | 55 of 92 START table model agency_data_pipeline.segment_stats_sku.... [RUN]
2018-04-18 10:26:13,783: Compiling model.agency_data_pipeline.agg_ga_transaction
2018-04-18 10:26:13,791: Writing injected SQL for node "model.agency_data_pipeline.segment_proc_customers_products"
2018-04-18 10:26:13,791: Compiling model.agency_data_pipeline.segment_stats_sku
2018-04-18 10:26:13,792: Acquiring new bigquery connection "agg_transaction".
2018-04-18 10:26:13,814: Re-using an available connection from the pool.
2018-04-18 10:26:13,799: Writing injected SQL for node "model.agency_data_pipeline.agg_ga_transaction"
2018-04-18 10:26:13,816: Writing injected SQL for node "model.agency_data_pipeline.segment_stats_sku"
2018-04-18 10:26:13,817: Acquiring new bigquery connection "segment_proc_customers_products".
2018-04-18 10:26:13,817: Re-using an available connection from the pool.
2018-04-18 10:26:13,821: Acquiring new bigquery connection "segment_stats_sku".
2018-04-18 10:26:13,821: Re-using an available connection from the pool.
2018-04-18 10:26:13,827: Acquiring new bigquery connection "agg_ga_transaction".
2018-04-18 10:26:13,831: Re-using an available connection from the pool.
2018-04-18 10:26:14,760: Model SQL (segment_stats_sku):
WITH last_30 as (

	SELECT
	client,
	sku, 
	product_type,
	date,
	unique_customers as customers_30,
	orders as orders_30,
	revenue as revenue_30,
	segment as segment_30,
	newness as newness_30,
	0 as customers_90,
	0 as orders_90,
	0 as revenue_90,
	'' as segment_90,
	0 as customers_yoy_30,
	0 as orders_yoy_30,
	0 as revenue_yoy_30,
	'' as segment_yoy_30
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_sku`
	WHERE period = 'Last 30'

),

last_90 as (

	SELECT
	client,
	sku, 
	product_type,
	date,
	0 as customers_30,
	0 as orders_30,
	0 as revenue_30,
	'' as segment_30,
	'' as newness_30,
	unique_customers as customers_90,
	orders as orders_90,
	revenue as revenue_90,
	segment as segment_90,
	0 as customers_yoy_30,
	0 as orders_yoy_30,
	0 as revenue_yoy_30,
	'' as segment_yoy_30
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_sku`
	WHERE period = 'Last 90'

),

yoy_30 as (

	SELECT
	client,
	sku, 
	product_type,
	date,
	0 as customers_30,
	0 as orders_30,
	0 as revenue_30,
	'' as segment_30,
	'' as newness_30,
	0 as customers_90,
	0 as orders_90,
	0 as revenue_90,
	'' as segment_90,
	unique_customers as customers_yoy_30,
	orders as orders_yoy_30,
	revenue as revenue_yoy_30,
	segment as segment_yoy_30
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_sku`
	WHERE period = 'YoY 30'

)

SELECT
client,
sku, 
product_type,
date,
ifnull(sum(customers_30), 0) customers_30,
ifnull(sum(orders_30), 0) orders_30,
ifnull(sum(revenue_30), 0) revenue_30,
ifnull(max(segment_30), '') segment_30,
ifnull(sum(customers_90), 0) customers_90,
ifnull(sum(orders_90), 0) orders_90,
ifnull(sum(revenue_90), 0) revenue_90,
ifnull(max(segment_90),'') segment_90,
ifnull(sum(customers_yoy_30), 0) customers_yoy_30,
ifnull(sum(orders_yoy_30), 0) orders_yoy_30,
ifnull(sum(revenue_yoy_30), 0) revenue_yoy_30,
case when max(newness_30) = 'New' then 'New'
	else ifnull(max(segment_yoy_30), '') end as segment_yoy_30
FROM
(
	SELECT * FROM last_30
	UNION ALL
	SELECT * FROM last_90
	UNION ALL
	SELECT * FROM yoy_30

)
GROUP BY client, sku, product_type, date
2018-04-18 10:26:14,763: Model SQL (agg_transaction):
SELECT
client,
date,
customer_id,
order_number,
last_touch_channel,
last_touch_platform,
last_touch_url,
first_touch_channel, 
first_touch_platform, 
first_touch_utm_campaign,
ifnull( sum(last_touch_transactions), 0) last_touch_transactions, 
ifnull( sum(last_touch_revenue), 0) last_touch_revenue, 
ifnull( sum(first_touch_transactions), 0) first_touch_transactions, 
ifnull( sum(first_touch_revenue), 0) first_touch_revenue,
ifnull( sum(final_quantity), 0) quantity,
ifnull( sum(final_price), 0) revenue,
ifnull( sum(shipping_price), 0) shipping_revenue,
ROW_NUMBER() OVER (PARTITION BY client, customer_id, order_number ORDER BY date asc) AS order_sequence
FROM
(
	SELECT
	a.client,
	a.date date,
	b.date ga_date,
	a.customer_id,
	a.order_number,
	transactionid,
	b.last_touch_channel,
	b.last_touch_platform,
	b.last_touch_url,
	b.first_touch_channel, 
	b.first_touch_platform, 
	b.first_touch_utm_campaign, 
	last_touch_transactions, 
	last_touch_revenue, 
	first_touch_transactions, 
	first_touch_revenue,
	final_quantity,
	final_price,
	shipping_price
	FROM
	`growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_order_number` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`agg_ga_transaction_order_number` b
	ON (
		a.client = b.client and
		a.order_number = b.transactionid
	)

)
GROUP BY
client, 
date, 
customer_id,
order_number, 
last_touch_channel,
last_touch_platform,
last_touch_url,
first_touch_channel, 
first_touch_platform, 
first_touch_utm_campaign
2018-04-18 10:26:14,763: Model SQL (segment_proc_customers_products):
SELECT
client,
period,
date,
customer_id,
first_order_date,
first_order_unix_date,
product_type,
recency_days,
frequency,
revenue,
quantity,
aov,
case when recency_days <= 30 and first_order_unix_date >= window_start_unix_date then 'New'
	when frequency = 1 and recency_days <= 90 and aov >= aov_40pct then 'Promising'
	when frequency = 1 then 'One-time Purchaser'
	when frequency >= frequency_90pct and recency_days <= 90 and aov > aov_40pct then 'Whale'
	when recency_days <= 240 and frequency > frequency_50pct then 'Loyal'
	when recency_days <= 90 and frequency > frequency_50pct then 'Potential Loyalists' 
	when recency_days > 240 and frequency > frequency_50pct then 'Defecting Good Customer'	
	when recency_days > recency_50pct and frequency > frequency_50pct then 'Frequent, not Recent'
	when recency_days < recency_50pct and frequency < frequency_50pct then 'Recent, not Frequent'
	else 'Unbucketed' end as segment,
aov_40pct,
frequency_90pct,
frequency_75pct,
frequency_50pct,
recency_50pct
FROM
(
	SELECT 
	a.client client,
	period,
	date,
	a.customer_id customer_id,
	a.product_type product_type,
	b.first_order_date first_order_date,
	b.first_order_unix_date first_order_unix_date,
	window_start_unix_date,
	window_end_unix_date,	
	recency_days,
	frequency,
	revenue,
	quantity,
	aov,
	PERCENTILE_CONT(aov, 0.40) OVER w1 AS aov_40pct,
	PERCENTILE_CONT(frequency, 0.90) OVER w1 AS frequency_90pct,
	PERCENTILE_CONT(frequency, 0.75) OVER w1 AS frequency_75pct,
	PERCENTILE_CONT(frequency, 0.50) OVER w1 AS frequency_50pct,
	PERCENTILE_CONT(recency_days, 0.5) OVER w1 AS recency_50pct
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`customers_products_proc` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`customers_first_purchase_product_type_proc` b
	ON (
		a.client = b.client and
		a.customer_id = b.customer_id and
		a.product_type = b.product_type
		)
	WINDOW w1 as (PARTITION BY a.client, period, date, a.product_type)
)
2018-04-18 10:26:14,768: Model SQL (agg_ga_transaction):
#done - lookup customer id from transaction id from orders
#done - tag an order as 'new' or 'existing' based on transaction id
#sum lifetime value of that customer id
#first order value for customer
#read from agg_ga_transaction into agg_ga_campaign instead of directly from ga_transactions and ga_mcf_stats


with ga as (

    select 
        date, 
        client, 
        'Last-touch' as attribution,
        channel, 
        platform, 
        url, 
        campaign, 
        transactionid,
        last_touch_transactions transactions, 
        last_touch_revenue + ifnull(last_touch_shipping, 0) + ifnull(last_touch_tax, 0) as revenue
    from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_transactions`

),

ga_mcf as (

    select 
        date, 
        client, 
        'First-touch' as attribution,
        channel, 
        platform, 
        '' as url,
        campaign, 
        transactionid, 
        first_touch_transactions as transactions,
        first_touch_revenue as revenue
    from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_mcf_stats`

)


SELECT
    date, 
    a.client client,
    attribution,
    transactionid,
    b.customer_id customer_id,
    b.order_type order_type,
    b.first_order_revenue first_order_revenue,
    b.lifetime_revenue lifetime_revenue,
    channel,
    platform,
    url,
    campaign,
    transactions,
    revenue
FROM (
    SELECT * FROM ga
    UNION ALL
    SELECT * FROM ga_mcf
) a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`customers_by_transaction` b
ON (
    a.client = b.client AND
    a.transactionid = b.order_number
)
2018-04-18 10:26:16,956: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1098cec88>]}
2018-04-18 10:26:17,195: 10:26:17 | 55 of 92 OK created table model agency_data_pipeline.segment_stats_sku [CREATE TABLE in 3.16s]
2018-04-18 10:26:20,215: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10994be80>]}
2018-04-18 10:26:20,448: 10:26:20 | 54 of 92 OK created table model agency_data_pipeline.agg_ga_transaction [CREATE TABLE in 6.43s]
2018-04-18 10:26:21,323: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cd88860>]}
2018-04-18 10:26:21,594: 10:26:21 | 52 of 92 OK created table model agency_data_pipeline.agg_transaction. [CREATE TABLE in 7.55s]
2018-04-18 10:26:45,630: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1098b6240>]}
2018-04-18 10:26:46,325: 10:26:46 | 53 of 92 OK created table model agency_data_pipeline.segment_proc_customers_products [CREATE TABLE in 31.85s]
2018-04-18 10:26:46,326: 10:26:46 | 56 of 92 START table model agency_data_pipeline.segment_stats_category [RUN]
2018-04-18 10:26:46,326: 10:26:46 | 57 of 92 START table model agency_data_pipeline.agg_transaction_daily [RUN]
2018-04-18 10:26:46,327: 10:26:46 | 58 of 92 START table model agency_data_pipeline.agg_ga_campaign_by_type [RUN]
2018-04-18 10:26:46,327: 10:26:46 | 59 of 92 START table model agency_data_pipeline.order_paths_stats.... [RUN]
2018-04-18 10:26:46,327: Compiling model.agency_data_pipeline.segment_stats_category
2018-04-18 10:26:46,327: Compiling model.agency_data_pipeline.agg_transaction_daily
2018-04-18 10:26:46,328: Compiling model.agency_data_pipeline.agg_ga_campaign_by_type
2018-04-18 10:26:46,328: Compiling model.agency_data_pipeline.order_paths_stats
2018-04-18 10:26:46,336: Writing injected SQL for node "model.agency_data_pipeline.segment_stats_category"
2018-04-18 10:26:46,343: Writing injected SQL for node "model.agency_data_pipeline.agg_transaction_daily"
2018-04-18 10:26:46,348: Writing injected SQL for node "model.agency_data_pipeline.agg_ga_campaign_by_type"
2018-04-18 10:26:46,354: Writing injected SQL for node "model.agency_data_pipeline.order_paths_stats"
2018-04-18 10:26:46,356: Acquiring new bigquery connection "agg_transaction_daily".
2018-04-18 10:26:46,357: Acquiring new bigquery connection "segment_stats_category".
2018-04-18 10:26:46,358: Acquiring new bigquery connection "agg_ga_campaign_by_type".
2018-04-18 10:26:46,358: Re-using an available connection from the pool.
2018-04-18 10:26:46,358: Re-using an available connection from the pool.
2018-04-18 10:26:46,359: Re-using an available connection from the pool.
2018-04-18 10:26:46,365: Acquiring new bigquery connection "order_paths_stats".
2018-04-18 10:26:46,367: Re-using an available connection from the pool.
2018-04-18 10:26:47,282: Model SQL (agg_transaction_daily):
SELECT
client,
date,
customer_id,
sum(last_touch_transactions) last_touch_transactions, 
sum(last_touch_revenue) last_touch_revenue, 
sum(first_touch_transactions) first_touch_transactions, 
sum(first_touch_revenue) first_touch_revenue,
sum(quantity) quantity,
sum(revenue) revenue,
count(distinct(order_number)) order_count
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction`
GROUP BY
client, 
date, 
customer_id
2018-04-18 10:26:47,289: Model SQL (segment_stats_category):
SELECT
client,
product_type,
date,
segment_30,
segment_90,
segment_yoy_30,
ifnull(sum(customers_30), 0) customers_30,
ifnull(sum(orders_30), 0) orders_30,
ifnull(sum(revenue_30), 0) revenue_30,
ifnull(sum(customers_90), 0) customers_90,
ifnull(sum(orders_90), 0) orders_90,
ifnull(sum(revenue_90), 0) revenue_90,
ifnull(sum(customers_yoy_30), 0) customers_yoy_30,
ifnull(sum(orders_yoy_30), 0) orders_yoy_30,
ifnull(sum(revenue_yoy_30), 0) revenue_yoy_30
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`segment_stats_sku`
GROUP BY client, product_type, date, segment_30, segment_90, segment_yoy_30
2018-04-18 10:26:47,290: Model SQL (agg_ga_campaign_by_type):
with orders_new as (
    select 
    date, 
    client, 
    attribution,
    channel, 
    platform, 
    url, 
    campaign,
    count(distinct(customer_id)) customers_new,
    sum(transactions) transactions_new,
    sum(revenue) revenue_new,
    sum(first_order_revenue) first_order_revenue_new,
    sum(lifetime_revenue) lifetime_revenue_new,
    null as customers_total,
    null as transactions_total,
    null as revenue_total
    from `growth-engines-pipeline`.`agency_data_pipeline`.`agg_ga_transaction`
    where order_type = 'New'
    group by date, client, attribution, channel, platform, url, campaign
),
    
orders_total as (
    select 
    date, 
    client, 
    attribution,
    channel, 
    platform, 
    url, 
    campaign,
    null as customers_new,
    null as transactions_new,
    null as revenue_new,
    null as first_order_revenue_new,
    null as lifetime_revenue_new,
    count(distinct(customer_id)) customers_total,
    sum(transactions) transactions_total,
    sum(revenue) revenue_total
    from `growth-engines-pipeline`.`agency_data_pipeline`.`agg_ga_transaction`
    group by date, client, attribution, channel, platform, url, campaign

)

SELECT 
date, 
client, 
attribution,
channel, 
platform, 
url, 
campaign,
sum(customers_new) customers_new,
sum(transactions_new) transactions_new,
sum(revenue_new) revenue_new,
sum(first_order_revenue_new) first_order_revenue_new,
sum(lifetime_revenue_new) lifetime_revenue_new,
sum(customers_total) customers_total,
sum(transactions_total) transactions_total,
sum(revenue_total) revenue_total
from
    ( 
        SELECT * FROM orders_new
        UNION ALL 
        SELECT * FROM orders_total
    )
group by date, client, attribution, channel, platform, url, campaign
2018-04-18 10:26:47,332: Model SQL (order_paths_stats):
WITH transactions AS (
  SELECT 
  client, 
  first_product_type,
  second_product_type,
  first_purchase_date,
  customer_count,
  second_orders,
  third_orders,
  fourth_orders,
  fifth_orders,
  second_order_latency_days,
  third_order_latency_days,
  fourth_order_latency_days,
  fifth_order_latency_days,
  first_order_revenue,
  second_order_revenue,
  unix_date(cast(first_purchase_date as date)) d
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`order_paths_agg`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)

SELECT 
client,
'Rolling 365' as period,
first_product_type,
second_product_type,
date_in_range date,
unix_date_in_range, 
sum(customer_count) customer_count,
sum(second_orders) second_orders,
sum(third_orders) third_orders,
sum(fourth_orders) fourth_orders,
sum(fifth_orders) fifth_orders,
sum(second_order_latency_days) second_order_latency_days,
sum(third_order_latency_days) third_order_latency_days,
sum(fourth_order_latency_days) fourth_order_latency_days,
sum(fifth_order_latency_days) fifth_order_latency_days,
sum(first_order_revenue) first_order_revenue,
sum(second_order_revenue) second_order_revenue
FROM daterange
JOIN transactions
ON transactions.d > ( daterange.unix_date_in_range - 365 )
AND transactions.d <= daterange.unix_date_in_range
group by client, first_product_type, second_product_type, date_in_range, unix_date_in_range
2018-04-18 10:26:49,490: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109905978>]}
2018-04-18 10:26:49,735: 10:26:49 | 56 of 92 OK created table model agency_data_pipeline.segment_stats_category [CREATE TABLE in 3.16s]
2018-04-18 10:26:49,735: 10:26:49 | 60 of 92 START table model agency_data_pipeline.customers_first_purchase_proc [RUN]
2018-04-18 10:26:49,736: Compiling model.agency_data_pipeline.customers_first_purchase_proc
2018-04-18 10:26:49,743: Writing injected SQL for node "model.agency_data_pipeline.customers_first_purchase_proc"
2018-04-18 10:26:49,746: Acquiring new bigquery connection "customers_first_purchase_proc".
2018-04-18 10:26:49,747: Re-using an available connection from the pool.
2018-04-18 10:26:50,633: Model SQL (customers_first_purchase_proc):
SELECT 
client, 
customer_id, 
min(cast(date as date)) first_order_date,
unix_date( min(cast(date as date))) first_order_unix_date
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction`
GROUP BY client, customer_id
2018-04-18 10:26:50,704: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1098e5b70>]}
2018-04-18 10:26:52,322: 10:26:52 | 59 of 92 OK created table model agency_data_pipeline.order_paths_stats [CREATE TABLE in 4.38s]
2018-04-18 10:26:52,322: 10:26:52 | 61 of 92 START table model agency_data_pipeline.segment_stats_customers_products_agg [RUN]
2018-04-18 10:26:52,323: Compiling model.agency_data_pipeline.segment_stats_customers_products_agg
2018-04-18 10:26:52,334: Writing injected SQL for node "model.agency_data_pipeline.segment_stats_customers_products_agg"
2018-04-18 10:26:52,336: Acquiring new bigquery connection "segment_stats_customers_products_agg".
2018-04-18 10:26:52,336: Re-using an available connection from the pool.
2018-04-18 10:26:52,860: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109905978>]}
2018-04-18 10:26:53,196: 10:26:53 | 60 of 92 OK created table model agency_data_pipeline.customers_first_purchase_proc [CREATE TABLE in 3.12s]
2018-04-18 10:26:53,198: Model SQL (segment_stats_customers_products_agg):
WITH ty as (

	SELECT
	client,
	date,
	customer_id,
	product_type,
	segment as segment_365,
	recency_days as recency_365,
	frequency as frequency_365,
	revenue as revenue_365,
	aov as aov_365,
	'' as segment_mom,
	0 as recency_mom,
	0 as frequency_mom,
	0 as revenue_mom,
	0 as aov_mom,
	'' as segment_yoy,
	0 as recency_yoy,
	0 as frequency_yoy,
	0 as revenue_yoy,
	0 as aov_yoy
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers_products`
	WHERE period = 'Rolling 365'

),

last_month as (

	SELECT
	client,
	date,
	customer_id,
	product_type,
	'' as segment_365,
	0 as recency_365,
	0 as frequency_365,
	0 as revenue_365,
	0 as aov_365,
	segment as segment_mom,
	recency_days as recency_mom,
	frequency as frequency_mom,
	revenue as revenue_mom,
	aov as aov_mom,
	'' as segment_yoy,
	0 as recency_yoy,
	0 as frequency_yoy,
	0 as revenue_yoy,
	0 as aov_yoy
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers_products`
	WHERE period = 'Rolling 365 (t-1mo)'

),

this_month_1yr as (

	SELECT
	client,
	date,
	customer_id,
	product_type,
	'' as segment_365,
	0 as recency_365,
	0 as frequency_365,
	0 as revenue_365,
	0 as aov_365,
	'' as segment_mom,
	0 as recency_mom,
	0 as frequency_mom,
	0 as revenue_mom,
	0 as aov_mom,
	segment as segment_yoy,
	recency_days as recency_yoy,
	frequency as frequency_yoy,
	revenue as revenue_yoy,
	aov as aov_yoy
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers_products`
	WHERE period = 'Rolling 365 (t-1yr)'


)

SELECT
client,
date, 
customer_id,
product_type,
ifnull(max(segment_365), '') segment_365,
ifnull(max(segment_mom), '') segment_mom,
ifnull(max(segment_yoy), '') segment_yoy,
ifnull(sum(recency_365), 0) recency_365,
ifnull(sum(frequency_365), 0) frequency_365,
ifnull(sum(revenue_365), 0) revenue_365,
ifnull(sum(aov_365), 0) aov_365,
ifnull(sum(recency_mom), 0) recency_mom,
ifnull(sum(frequency_mom), 0) frequency_mom,
ifnull(sum(revenue_mom), 0) revenue_mom,
ifnull(sum(aov_mom), 0) aov_mom,	
ifnull(sum(recency_yoy), 0) recency_yoy,
ifnull(sum(frequency_yoy), 0) frequency_yoy,
ifnull(sum(revenue_yoy), 0) revenue_yoy,
ifnull(sum(aov_yoy), 0) aov_yoy
FROM
(
	SELECT * FROM ty
	UNION ALL
	SELECT * FROM last_month
	UNION ALL
	SELECT * FROM this_month_1yr

)
GROUP BY client, date, customer_id, product_type
2018-04-18 10:26:53,334: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1098ce940>]}
2018-04-18 10:26:53,634: 10:26:53 | 58 of 92 OK created table model agency_data_pipeline.agg_ga_campaign_by_type [CREATE TABLE in 7.01s]
2018-04-18 10:26:55,082: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109905eb8>]}
2018-04-18 10:26:55,338: 10:26:55 | 57 of 92 OK created table model agency_data_pipeline.agg_transaction_daily [CREATE TABLE in 8.75s]
2018-04-18 10:27:21,909: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cd7f5f8>]}
2018-04-18 10:27:22,164: 10:27:22 | 61 of 92 OK created table model agency_data_pipeline.segment_stats_customers_products_agg [CREATE TABLE in 29.59s]
2018-04-18 10:27:22,165: 10:27:22 | 62 of 92 START table model agency_data_pipeline.segment_stats_customers_products [RUN]
2018-04-18 10:27:22,166: 10:27:22 | 63 of 92 START table model agency_data_pipeline.growth_customer_0_365 [RUN]
2018-04-18 10:27:22,166: Compiling model.agency_data_pipeline.segment_stats_customers_products
2018-04-18 10:27:22,166: 10:27:22 | 64 of 92 START table model agency_data_pipeline.customers_proc....... [RUN]
2018-04-18 10:27:22,166: Compiling model.agency_data_pipeline.growth_customer_0_365
2018-04-18 10:27:22,177: Writing injected SQL for node "model.agency_data_pipeline.segment_stats_customers_products"
2018-04-18 10:27:22,177: Compiling model.agency_data_pipeline.customers_proc
2018-04-18 10:27:22,184: Writing injected SQL for node "model.agency_data_pipeline.growth_customer_0_365"
2018-04-18 10:27:22,190: Writing injected SQL for node "model.agency_data_pipeline.customers_proc"
2018-04-18 10:27:22,193: Acquiring new bigquery connection "segment_stats_customers_products".
2018-04-18 10:27:22,193: Re-using an available connection from the pool.
2018-04-18 10:27:22,196: Acquiring new bigquery connection "customers_proc".
2018-04-18 10:27:22,196: Re-using an available connection from the pool.
2018-04-18 10:27:22,198: Acquiring new bigquery connection "growth_customer_0_365".
2018-04-18 10:27:22,199: Re-using an available connection from the pool.
2018-04-18 10:27:23,225: Model SQL (segment_stats_customers_products):
SELECT
client,
date,
product_type,
segment_365,
segment_mom,
segment_yoy,
count(distinct(customer_id)) customers,
avg(recency_365) recency_365,
sum(frequency_365) frequency_365,
sum(revenue_365) revenue_365,
case when sum(frequency_365) > 0 then sum(revenue_365)/sum(frequency_365) else null end as aov_365,
avg(recency_mom) recency_mom,
sum(frequency_mom) frequency_mom,
sum(revenue_mom) revenue_mom,
case when sum(frequency_mom) > 0 then sum(revenue_mom)/sum(frequency_mom) else null end as aov_mom,
avg(recency_yoy) recency_yoy,
sum(frequency_yoy) frequency_yoy,
sum(revenue_yoy) revenue_yoy,
case when sum(frequency_yoy) > 0 then sum(revenue_yoy)/sum(frequency_yoy) else null end as aov_yoy
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_stats_customers_products_agg`
GROUP BY client, date, product_type, segment_365, segment_mom, segment_yoy
2018-04-18 10:27:23,233: Model SQL (customers_proc):
WITH customers AS (
  SELECT 
  client, 
  customer_id, 
  order_number,
  cast(date as date) order_date,
  unix_date(cast(date as date)) unix_order_date, 
  quantity,
  revenue 
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)
 
SELECT 
client,
period,
customer_id,
date,
window_end_unix_date,
window_end_unix_date - 365 as window_start_unix_date,
window_end_unix_date - unix_date(recent_order) recency_days,
frequency,
quantity,
revenue,
case when frequency > 0 then revenue/frequency else 0 end as aov
FROM 
(  

  SELECT 
  client,
  'Rolling 365' as period,
  customer_id,
  date_in_range date,
  unix_date_in_range,
  unix_date_in_range window_end_unix_date,
  max(order_date) recent_order,
  sum(quantity) as quantity,
  sum(revenue) as revenue,
  count(distinct(order_number)) as frequency
  FROM daterange
  JOIN customers
  ON customers.unix_order_date > ( daterange.unix_date_in_range - 365 )
  AND customers.unix_order_date <= daterange.unix_date_in_range
  GROUP BY client, customer_id, date, unix_date_in_range

  UNION ALL

  SELECT 
  client,
  'Rolling 365 (t-1mo)' as period,
  customer_id,
  date_in_range date,
  unix_date_in_range,
  unix_date_in_range - 30 window_end_unix_date, 
  max(order_date) recent_order,
  sum(quantity) as quantity,
  sum(revenue) as revenue,
  count(distinct(order_number)) as frequency
  FROM daterange
  JOIN customers
  ON customers.unix_order_date > ( daterange.unix_date_in_range - 395 )
  AND customers.unix_order_date <= ( daterange.unix_date_in_range - 30 )
  GROUP BY client, customer_id, date, unix_date_in_range

  UNION ALL

  SELECT 
  client,
  'Rolling 365 (t-1yr)' as period,
  customer_id,
  date_in_range date,
  unix_date_in_range, 
  unix_date_in_range - 365 window_end_unix_date, 
  max(order_date) recent_order,
  sum(quantity) as quantity,
  sum(revenue) as revenue,
  count(distinct(order_number)) as frequency
  FROM daterange
  JOIN customers
  ON customers.unix_order_date > ( daterange.unix_date_in_range - 730 )
  AND customers.unix_order_date <= ( daterange.unix_date_in_range - 365 )
  GROUP BY client, customer_id, date, unix_date_in_range

)
2018-04-18 10:27:23,489: Model SQL (growth_customer_0_365):
WITH transactions AS (
  SELECT 
  client, 
  customer_id, 
  order_number,
  unix_date(cast(date as date)) d, 
  quantity,
  revenue,
  shipping_revenue
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)

SELECT 
date_in_range date,
unix_date_in_range, 
unix_date_in_range_yoy, 
client, 
customer_id,
count(distinct(order_number)) orders,
sum(quantity) quantity,
sum(revenue) revenue,
sum(shipping_revenue) shipping_revenue
FROM daterange
JOIN transactions
ON transactions.d >= ( daterange.unix_date_in_range - 365 ) 
AND transactions.d <= daterange.unix_date_in_range
GROUP BY date, unix_date_in_range, unix_date_in_range_yoy, client, customer_id
2018-04-18 10:27:36,476: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cd88860>]}
2018-04-18 10:27:37,124: 10:27:37 | 62 of 92 OK created table model agency_data_pipeline.segment_stats_customers_products [CREATE TABLE in 14.31s]
2018-04-18 10:27:43,186: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1098b61d0>]}
2018-04-18 10:27:43,487: 10:27:43 | 63 of 92 OK created table model agency_data_pipeline.growth_customer_0_365 [CREATE TABLE in 21.02s]
2018-04-18 10:27:53,471: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1098e5e80>]}
2018-04-18 10:27:53,729: 10:27:53 | 64 of 92 OK created table model agency_data_pipeline.customers_proc.. [CREATE TABLE in 31.29s]
2018-04-18 10:27:53,730: 10:27:53 | 65 of 92 START table model agency_data_pipeline.segment_list_customers_products [RUN]
2018-04-18 10:27:53,731: 10:27:53 | 66 of 92 START table model agency_data_pipeline.retention_730_plus... [RUN]
2018-04-18 10:27:53,731: Compiling model.agency_data_pipeline.segment_list_customers_products
2018-04-18 10:27:53,731: 10:27:53 | 67 of 92 START table model agency_data_pipeline.retention_60_plus.... [RUN]
2018-04-18 10:27:53,732: 10:27:53 | 68 of 92 START table model agency_data_pipeline.retention_0_30....... [RUN]
2018-04-18 10:27:53,732: Compiling model.agency_data_pipeline.retention_730_plus
2018-04-18 10:27:53,739: Compiling model.agency_data_pipeline.retention_60_plus
2018-04-18 10:27:53,748: Writing injected SQL for node "model.agency_data_pipeline.segment_list_customers_products"
2018-04-18 10:27:53,748: Compiling model.agency_data_pipeline.retention_0_30
2018-04-18 10:27:53,753: Writing injected SQL for node "model.agency_data_pipeline.retention_730_plus"
2018-04-18 10:27:53,758: Writing injected SQL for node "model.agency_data_pipeline.retention_60_plus"
2018-04-18 10:27:53,763: Writing injected SQL for node "model.agency_data_pipeline.retention_0_30"
2018-04-18 10:27:53,764: Acquiring new bigquery connection "segment_list_customers_products".
2018-04-18 10:27:53,765: Re-using an available connection from the pool.
2018-04-18 10:27:53,768: Acquiring new bigquery connection "retention_730_plus".
2018-04-18 10:27:53,771: Re-using an available connection from the pool.
2018-04-18 10:27:53,773: Acquiring new bigquery connection "retention_60_plus".
2018-04-18 10:27:53,773: Re-using an available connection from the pool.
2018-04-18 10:27:53,774: Acquiring new bigquery connection "retention_0_30".
2018-04-18 10:27:53,776: Re-using an available connection from the pool.
2018-04-18 10:27:54,706: Model SQL (retention_0_30):
WITH transactions AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_daily`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
),

temp AS (
  SELECT 
  client, 
  customer_id, 
  unix_date(date) d, 
  quantity,
  revenue,
  order_count
  FROM transactions
)

SELECT 
date_in_range date,
unix_date_in_range, 
client, 
customer_id,
sum(quantity) quantity,
sum(revenue) revenue,
sum(order_count) order_count
FROM daterange
JOIN temp
ON temp.d >= ( daterange.unix_date_in_range_bom ) 
AND temp.d <= daterange.unix_date_in_range
group by date_in_range, unix_date_in_range, client, customer_id
2018-04-18 10:27:54,706: Model SQL (segment_list_customers_products):
SELECT
a.client,
period,
date,
customer_id,
product_type,
b.first_name,
b.last_name,
b.email,
recency_days,
frequency,
revenue,
quantity,
aov,
segment
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers_products` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`agg_customers_union` b
ON (
	a.client = b.client AND
	a.customer_id = b.id
)
2018-04-18 10:27:54,707: Model SQL (retention_60_plus):
WITH transactions AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_daily`
),

daterange AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`  	
),

temp AS (
  SELECT 
  client, 
  customer_id, 
  unix_date(date) d, 
  quantity,
  revenue,
  order_count
  FROM transactions
)

SELECT 
date_in_range date, 
unix_date_in_range,
client, 
customer_id,
sum(quantity) quantity,
sum(revenue) revenue,
sum(order_count) order_count
FROM daterange
JOIN temp
ON temp.d < ( daterange.unix_date_in_range_bom_mom ) 
group by date_in_range, unix_date_in_range, client, customer_id
2018-04-18 10:27:54,707: Model SQL (retention_730_plus):
WITH transactions AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_daily`
),

daterange AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`  	
),

temp AS (
  SELECT 
  client, 
  customer_id, 
  unix_date(date) d, 
  quantity,
  revenue,
  order_count
  FROM transactions
)

SELECT 
date_in_range date, 
unix_date_in_range,
client, 
customer_id,
sum(quantity) quantity,
sum(revenue) revenue,
sum(order_count) order_count
FROM daterange
JOIN temp
ON temp.d <= ( daterange.unix_date_in_range - 730 ) 
group by date_in_range, unix_date_in_range, client, customer_id
2018-04-18 10:27:56,909: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10990def0>]}
2018-04-18 10:27:57,161: 10:27:57 | 66 of 92 OK created table model agency_data_pipeline.retention_730_plus [CREATE TABLE in 3.18s]
2018-04-18 10:27:57,161: 10:27:57 | 69 of 92 START table model agency_data_pipeline.retention_365_730.... [RUN]
2018-04-18 10:27:57,161: Compiling model.agency_data_pipeline.retention_365_730
2018-04-18 10:27:57,171: Writing injected SQL for node "model.agency_data_pipeline.retention_365_730"
2018-04-18 10:27:57,173: Acquiring new bigquery connection "retention_365_730".
2018-04-18 10:27:57,173: Re-using an available connection from the pool.
2018-04-18 10:27:57,934: Model SQL (retention_365_730):
WITH transactions AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_daily`
),

daterange AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`  	
),

temp AS (
  SELECT 
  client, 
  customer_id, 
  unix_date(date) d, 
  quantity,
  revenue,
  order_count
  FROM transactions
)

SELECT 
date_in_range date, 
unix_date_in_range,
client, 
customer_id,
sum(quantity) quantity,
sum(revenue) revenue,
sum(order_count) order_count
FROM daterange
JOIN temp
ON ( temp.d >= ( daterange.unix_date_in_range - 730 ) 
AND temp.d < ( daterange.unix_date_in_range - 365 ) )
group by date_in_range, unix_date_in_range, client, customer_id
2018-04-18 10:27:58,027: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1098cec88>]}
2018-04-18 10:27:58,738: 10:27:58 | 68 of 92 OK created table model agency_data_pipeline.retention_0_30.. [CREATE TABLE in 4.28s]
2018-04-18 10:27:58,739: 10:27:58 | 70 of 92 START table model agency_data_pipeline.retention_0_365...... [RUN]
2018-04-18 10:27:58,739: Compiling model.agency_data_pipeline.retention_0_365
2018-04-18 10:27:58,748: Writing injected SQL for node "model.agency_data_pipeline.retention_0_365"
2018-04-18 10:27:58,750: Acquiring new bigquery connection "retention_0_365".
2018-04-18 10:27:58,750: Re-using an available connection from the pool.
2018-04-18 10:27:59,818: Model SQL (retention_0_365):
WITH transactions AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_daily`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
),

temp AS (
  SELECT 
  client, 
  customer_id, 
  unix_date(date) d, 
  quantity,
  revenue,
  order_count
  FROM transactions
)

SELECT 
date_in_range date,
unix_date_in_range, 
client, 
customer_id,
sum(quantity) quantity,
sum(revenue) revenue,
sum(order_count) order_count
FROM daterange
JOIN temp
ON temp.d >= ( daterange.unix_date_in_range - 365 ) 
AND temp.d <= daterange.unix_date_in_range
group by date_in_range, unix_date_in_range, client, customer_id
2018-04-18 10:28:02,851: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10990def0>]}
2018-04-18 10:28:03,323: 10:28:03 | 69 of 92 OK created table model agency_data_pipeline.retention_365_730 [CREATE TABLE in 5.69s]
2018-04-18 10:28:03,323: 10:28:03 | 71 of 92 START table model agency_data_pipeline.retention_30_60...... [RUN]
2018-04-18 10:28:03,323: Compiling model.agency_data_pipeline.retention_30_60
2018-04-18 10:28:03,330: Writing injected SQL for node "model.agency_data_pipeline.retention_30_60"
2018-04-18 10:28:03,331: Acquiring new bigquery connection "retention_30_60".
2018-04-18 10:28:03,331: Re-using an available connection from the pool.
2018-04-18 10:28:04,239: Model SQL (retention_30_60):
WITH transactions AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_daily`
),

daterange AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`  	
),

temp AS (
  SELECT 
  client, 
  customer_id, 
  unix_date(date) d, 
  quantity,
  revenue,
  order_count
  FROM transactions
)

SELECT 
date_in_range date, 
unix_date_in_range,
client, 
customer_id,
sum(quantity) quantity,
sum(revenue) revenue,
sum(order_count) order_count
FROM daterange
JOIN temp
ON ( temp.d >= ( daterange.unix_date_in_range_bom_mom ) 
AND temp.d < ( daterange.unix_date_in_range_bom ) )
group by date_in_range, unix_date_in_range, client, customer_id
2018-04-18 10:28:06,125: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1098ca4a8>]}
2018-04-18 10:28:06,519: 10:28:06 | 67 of 92 OK created table model agency_data_pipeline.retention_60_plus [CREATE TABLE in 12.39s]
2018-04-18 10:28:08,721: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10990def0>]}
2018-04-18 10:28:08,987: 10:28:08 | 71 of 92 OK created table model agency_data_pipeline.retention_30_60. [CREATE TABLE in 5.40s]
2018-04-18 10:28:09,890: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cd65c50>]}
2018-04-18 10:28:10,363: 10:28:10 | 70 of 92 OK created table model agency_data_pipeline.retention_0_365. [CREATE TABLE in 11.15s]
2018-04-18 10:28:36,021: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cd7f5f8>]}
2018-04-18 10:28:36,696: 10:28:36 | 65 of 92 OK created table model agency_data_pipeline.segment_list_customers_products [CREATE TABLE in 42.29s]
2018-04-18 10:28:36,697: 10:28:36 | 72 of 92 START table model agency_data_pipeline.agg_platforms_union.. [RUN]
2018-04-18 10:28:36,697: Compiling model.agency_data_pipeline.agg_platforms_union
2018-04-18 10:28:36,703: 10:28:36 | 73 of 92 START table model agency_data_pipeline.segment_proc_customers [RUN]
2018-04-18 10:28:36,707: Writing injected SQL for node "model.agency_data_pipeline.agg_platforms_union"
2018-04-18 10:28:36,707: Compiling model.agency_data_pipeline.segment_proc_customers
2018-04-18 10:28:36,716: Writing injected SQL for node "model.agency_data_pipeline.segment_proc_customers"
2018-04-18 10:28:36,717: Acquiring new bigquery connection "agg_platforms_union".
2018-04-18 10:28:36,718: Re-using an available connection from the pool.
2018-04-18 10:28:36,718: Acquiring new bigquery connection "segment_proc_customers".
2018-04-18 10:28:36,719: Re-using an available connection from the pool.
2018-04-18 10:28:37,606: Model SQL (segment_proc_customers):
SELECT
client,
period,
date,
customer_id,
first_order_date,
first_order_unix_date,
recency_days,
frequency,
revenue,
quantity,
aov,
case when recency_days <= 30 and first_order_unix_date >= window_start_unix_date then 'New'
	when frequency = 1 and recency_days <= 90 and aov >= aov_40pct then 'Promising'
	when frequency = 1 then 'One-time Purchaser'
	when frequency >= frequency_90pct and recency_days <= 90 and aov > aov_40pct then 'Whale'
	when recency_days <= 240 and frequency > frequency_50pct then 'Loyal'
	when recency_days <= 90 and frequency > frequency_50pct then 'Potential Loyalists' 
	when recency_days > 240 and frequency > frequency_50pct then 'Defecting Good Customer'	
	when recency_days > recency_50pct and frequency > frequency_50pct then 'Frequent, not Recent'
	when recency_days < recency_50pct and frequency < frequency_50pct then 'Recent, not Frequent'
	else 'Unbucketed' end as segment,
aov_40pct,
frequency_90pct,
frequency_75pct,
frequency_50pct,
recency_50pct
FROM
(
	SELECT 
	a.client client,
	period,
	date,
	a.customer_id customer_id,
	b.first_order_date first_order_date,
	b.first_order_unix_date first_order_unix_date,
	window_start_unix_date,
	window_end_unix_date,
	recency_days,
	frequency,
	revenue,
	quantity,
	aov,
	PERCENTILE_CONT(aov, 0.40) OVER w1 AS aov_40pct,
	PERCENTILE_CONT(frequency, 0.90) OVER w1 AS frequency_90pct,
	PERCENTILE_CONT(frequency, 0.75) OVER w1 AS frequency_75pct,
	PERCENTILE_CONT(frequency, 0.50) OVER w1 AS frequency_50pct,
	PERCENTILE_CONT(recency_days, 0.5) OVER w1 AS recency_50pct
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`customers_proc` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`customers_first_purchase_proc` b
	ON (
		a.client = b.client and
		a.customer_id = b.customer_id
		)
	WINDOW w1 as (PARTITION BY a.client, period, date)
)
2018-04-18 10:28:37,607: Model SQL (agg_platforms_union):
SELECT 
date, 
account, 
channel,
platform,
url,
utm_campaign,
campaign,
cost,
impressions,
clicks,
transactions
FROM 
`growth-engines-pipeline`.`agency_data_pipeline`.`adwords_stats`

UNION ALL

SELECT 
date, 
account, 
channel,
platform,
url,
utm_campaign,
campaign,
cost,
impressions,
clicks,
transactions
FROM 
`growth-engines-pipeline`.`agency_data_pipeline`.`bing_ads_stats`

UNION ALL  

SELECT 
date, 
account, 
channel,
platform,
url,
utm_campaign,
campaign,
cost,
impressions,
clicks,
transactions
FROM 
`growth-engines-pipeline`.`agency_data_pipeline`.`fb_ads_stats`
2018-04-18 10:28:42,162: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1098b61d0>]}
2018-04-18 10:28:42,430: 10:28:42 | 72 of 92 OK created table model agency_data_pipeline.agg_platforms_union [CREATE TABLE in 5.46s]
2018-04-18 10:29:00,765: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1098b2160>]}
2018-04-18 10:29:00,996: 10:29:00 | 73 of 92 OK created table model agency_data_pipeline.segment_proc_customers [CREATE TABLE in 24.06s]
2018-04-18 10:29:00,997: 10:29:00 | 74 of 92 START table model agency_data_pipeline.retention_0_30_rebuy. [RUN]
2018-04-18 10:29:00,997: 10:29:00 | 75 of 92 START table model agency_data_pipeline.segment_stats_customers_agg [RUN]
2018-04-18 10:29:00,997: Compiling model.agency_data_pipeline.retention_0_30_rebuy
2018-04-18 10:29:00,998: 10:29:00 | 76 of 92 START table model agency_data_pipeline.retention_0_365_rebuy [RUN]
2018-04-18 10:29:00,998: Compiling model.agency_data_pipeline.segment_stats_customers_agg
2018-04-18 10:29:01,004: Compiling model.agency_data_pipeline.retention_0_365_rebuy
2018-04-18 10:29:01,008: Writing injected SQL for node "model.agency_data_pipeline.retention_0_30_rebuy"
2018-04-18 10:29:01,014: Writing injected SQL for node "model.agency_data_pipeline.segment_stats_customers_agg"
2018-04-18 10:29:01,020: Writing injected SQL for node "model.agency_data_pipeline.retention_0_365_rebuy"
2018-04-18 10:29:01,021: Acquiring new bigquery connection "segment_stats_customers_agg".
2018-04-18 10:29:01,022: Acquiring new bigquery connection "retention_0_365_rebuy".
2018-04-18 10:29:01,022: Re-using an available connection from the pool.
2018-04-18 10:29:01,023: Re-using an available connection from the pool.
2018-04-18 10:29:01,024: Acquiring new bigquery connection "retention_0_30_rebuy".
2018-04-18 10:29:01,024: Re-using an available connection from the pool.
2018-04-18 10:29:03,959: Model SQL (retention_0_30_rebuy):
SELECT 
r2.client,
r2.date,
r2.customer_id, 
r2.quantity,
r2.revenue
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_30_60` r1 
left join `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30` r2 
  on ( r1.customer_id = r2.customer_id 
  and r1.date = r2.date )
2018-04-18 10:29:03,967: Model SQL (retention_0_365_rebuy):
SELECT 
r2.client,
r2.date,
r2.customer_id, 
r2.quantity,
r2.revenue
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_365_730` r1 
left join `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365` r2 
  on ( r1.customer_id = r2.customer_id 
  and r1.date = r2.date )
2018-04-18 10:29:04,037: Model SQL (segment_stats_customers_agg):
WITH ty as (

	SELECT
	client,
	date,
	customer_id,
	segment as segment_365,
	recency_days as recency_365,
	frequency as frequency_365,
	revenue as revenue_365,
	aov as aov_365,
	'' as segment_mom,
	0 as recency_mom,
	0 as frequency_mom,
	0 as revenue_mom,
	0 as aov_mom,
	'' as segment_yoy,
	0 as recency_yoy,
	0 as frequency_yoy,
	0 as revenue_yoy,
	0 as aov_yoy
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers`
	WHERE period = 'Rolling 365'

),

last_month as (

	SELECT
	client,
	date,
	customer_id,
	'' as segment_365,
	0 as recency_365,
	0 as frequency_365,
	0 as revenue_365,
	0 as aov_365,
	segment as segment_mom,
	recency_days as recency_mom,
	frequency as frequency_mom,
	revenue as revenue_mom,
	aov as aov_mom,
	'' as segment_yoy,
	0 as recency_yoy,
	0 as frequency_yoy,
	0 as revenue_yoy,
	0 as aov_yoy
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers`
	WHERE period = 'Rolling 365 (t-1mo)'

),

this_month_1yr as (

	SELECT
	client,
	date,
	customer_id,
	'' as segment_365,
	0 as recency_365,
	0 as frequency_365,
	0 as revenue_365,
	0 as aov_365,
	'' as segment_mom,
	0 as recency_mom,
	0 as frequency_mom,
	0 as revenue_mom,
	0 as aov_mom,
	segment as segment_yoy,
	recency_days as recency_yoy,
	frequency as frequency_yoy,
	revenue as revenue_yoy,
	aov as aov_yoy
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers`
	WHERE period = 'Rolling 365 (t-1yr)'


)

SELECT
client,
date, 
customer_id,
ifnull(max(segment_365), '') segment_365,
ifnull(max(segment_mom), '') segment_mom,
ifnull(max(segment_yoy), '') segment_yoy,
ifnull(sum(recency_365), 0) recency_365,
ifnull(sum(frequency_365), 0) frequency_365,
ifnull(sum(revenue_365), 0) revenue_365,
ifnull(sum(aov_365), 0) aov_365,
ifnull(sum(recency_mom), 0) recency_mom,
ifnull(sum(frequency_mom), 0) frequency_mom,
ifnull(sum(revenue_mom), 0) revenue_mom,
ifnull(sum(aov_mom), 0) aov_mom,	
ifnull(sum(recency_yoy), 0) recency_yoy,
ifnull(sum(frequency_yoy), 0) frequency_yoy,
ifnull(sum(revenue_yoy), 0) revenue_yoy,
ifnull(sum(aov_yoy), 0) aov_yoy
FROM
(
	SELECT * FROM ty
	UNION ALL
	SELECT * FROM last_month
	UNION ALL
	SELECT * FROM this_month_1yr

)
GROUP BY client, date, customer_id
2018-04-18 10:29:06,907: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cd7f5f8>]}
2018-04-18 10:29:07,186: 10:29:07 | 74 of 92 OK created table model agency_data_pipeline.retention_0_30_rebuy [CREATE TABLE in 5.91s]
2018-04-18 10:29:08,489: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cd65978>]}
2018-04-18 10:29:08,755: 10:29:08 | 76 of 92 OK created table model agency_data_pipeline.retention_0_365_rebuy [CREATE TABLE in 7.48s]
2018-04-18 10:29:26,956: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1098e50f0>]}
2018-04-18 10:29:27,253: 10:29:27 | 75 of 92 OK created table model agency_data_pipeline.segment_stats_customers_agg [CREATE TABLE in 25.96s]
2018-04-18 10:29:27,255: 10:29:27 | 77 of 92 START table model agency_data_pipeline.retention_0_365_new.. [RUN]
2018-04-18 10:29:27,255: 10:29:27 | 78 of 92 START table model agency_data_pipeline.agg_platforms_client. [RUN]
2018-04-18 10:29:27,255: 10:29:27 | 79 of 92 START table model agency_data_pipeline.segment_stats_customers [RUN]
2018-04-18 10:29:27,256: Compiling model.agency_data_pipeline.retention_0_365_new
2018-04-18 10:29:27,256: 10:29:27 | 80 of 92 START table model agency_data_pipeline.retention_0_365_reactivated [RUN]
2018-04-18 10:29:27,256: Compiling model.agency_data_pipeline.agg_platforms_client
2018-04-18 10:29:27,256: Compiling model.agency_data_pipeline.segment_stats_customers
2018-04-18 10:29:27,262: Compiling model.agency_data_pipeline.retention_0_365_reactivated
2018-04-18 10:29:27,272: Writing injected SQL for node "model.agency_data_pipeline.retention_0_365_new"
2018-04-18 10:29:27,287: Writing injected SQL for node "model.agency_data_pipeline.segment_stats_customers"
2018-04-18 10:29:27,288: Writing injected SQL for node "model.agency_data_pipeline.agg_platforms_client"
2018-04-18 10:29:27,297: Writing injected SQL for node "model.agency_data_pipeline.retention_0_365_reactivated"
2018-04-18 10:29:27,302: Acquiring new bigquery connection "retention_0_365_new".
2018-04-18 10:29:27,303: Re-using an available connection from the pool.
2018-04-18 10:29:27,303: Acquiring new bigquery connection "segment_stats_customers".
2018-04-18 10:29:27,305: Acquiring new bigquery connection "retention_0_365_reactivated".
2018-04-18 10:29:27,306: Acquiring new bigquery connection "agg_platforms_client".
2018-04-18 10:29:27,308: Re-using an available connection from the pool.
2018-04-18 10:29:27,309: Re-using an available connection from the pool.
2018-04-18 10:29:27,312: Re-using an available connection from the pool.
2018-04-18 10:29:30,357: Model SQL (segment_stats_customers):
SELECT
client,
date,
segment_365,
segment_mom,
segment_yoy,
count(distinct(customer_id)) customers,
avg(recency_365) recency_365,
sum(frequency_365) frequency_365,
sum(revenue_365) revenue_365,
case when sum(frequency_365) > 0 then sum(revenue_365)/sum(frequency_365) else null end as aov_365,
avg(recency_mom) recency_mom,
sum(frequency_mom) frequency_mom,
sum(revenue_mom) revenue_mom,
case when sum(frequency_mom) > 0 then sum(revenue_mom)/sum(frequency_mom) else null end as aov_mom,
avg(recency_yoy) recency_yoy,
sum(frequency_yoy) frequency_yoy,
sum(revenue_yoy) revenue_yoy,
case when sum(frequency_yoy) > 0 then sum(revenue_yoy)/sum(frequency_yoy) else null end as aov_yoy
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_stats_customers_agg`
GROUP BY client, date, segment_365, segment_mom, segment_yoy
2018-04-18 10:29:30,357: Model SQL (retention_0_365_reactivated):
SELECT 
a.client,
a.date,
a.customer_id, 
a.quantity,
a.revenue
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_730_plus` b
ON (
	a.client = b.client AND
	a.date = b.date AND
	a.customer_id = b.customer_id
)
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_365_730` c
ON (
	a.client = c.client AND
	a.date = c.date AND
	a.customer_id = c.customer_id
)
WHERE b.customer_id is not null 
AND c.customer_id is null
2018-04-18 10:29:30,359: Model SQL (retention_0_365_new):
SELECT 
a.client,
a.date,
a.customer_id, 
a.quantity,
a.revenue,
a.order_count
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_730_plus` b
ON (
	a.client = b.client AND
	a.date = b.date AND
	a.customer_id = b.customer_id
)
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_365_730` c
ON (
	a.client = c.client AND
	a.date = c.date AND
	a.customer_id = c.customer_id
)
WHERE b.customer_id is null 
and c.customer_id is null
2018-04-18 10:29:30,359: Model SQL (agg_platforms_client):
SELECT 
date, 
a.account account, 
b.client client,
a.platform platform,
a.channel channel,
url,
utm_campaign,
campaign,
cost,
impressions,
clicks,
transactions ad_platform_transactions
FROM 
  `growth-engines-pipeline`.`agency_data_pipeline`.`agg_platforms_union` a
LEFT JOIN 
  `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc` b
ON ( 
  a.account = b.account AND
  a.platform = b.platform
)
2018-04-18 10:29:33,377: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cd7f5f8>]}
2018-04-18 10:29:33,626: 10:29:33 | 80 of 92 OK created table model agency_data_pipeline.retention_0_365_reactivated [CREATE TABLE in 6.12s]
2018-04-18 10:29:33,627: 10:29:33 | 81 of 92 START table model agency_data_pipeline.retention_0_30_new... [RUN]
2018-04-18 10:29:33,627: Compiling model.agency_data_pipeline.retention_0_30_new
2018-04-18 10:29:33,637: Writing injected SQL for node "model.agency_data_pipeline.retention_0_30_new"
2018-04-18 10:29:33,638: Acquiring new bigquery connection "retention_0_30_new".
2018-04-18 10:29:33,639: Re-using an available connection from the pool.
2018-04-18 10:29:35,058: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109905cf8>]}
2018-04-18 10:29:35,487: Model SQL (retention_0_30_new):
SELECT 
a.client,
a.date,
a.customer_id, 
a.quantity,
a.revenue,
a.order_count
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_60_plus` b
ON (
	a.client = b.client AND
	a.date = b.date AND
	a.customer_id = b.customer_id
)
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_30_60` c
ON (
	a.client = c.client AND
	a.date = c.date AND
	a.customer_id = c.customer_id
)
WHERE b.customer_id is null 
and c.customer_id is null
2018-04-18 10:29:35,706: 10:29:35 | 78 of 92 OK created table model agency_data_pipeline.agg_platforms_client [CREATE TABLE in 7.80s]
2018-04-18 10:29:35,706: 10:29:35 | 82 of 92 START table model agency_data_pipeline.retention_stats_rebuy_rate_month [RUN]
2018-04-18 10:29:35,707: Compiling model.agency_data_pipeline.retention_stats_rebuy_rate_month
2018-04-18 10:29:35,715: Writing injected SQL for node "model.agency_data_pipeline.retention_stats_rebuy_rate_month"
2018-04-18 10:29:35,717: Acquiring new bigquery connection "retention_stats_rebuy_rate_month".
2018-04-18 10:29:35,717: Re-using an available connection from the pool.
2018-04-18 10:29:36,610: Model SQL (retention_stats_rebuy_rate_month):
WITH r1 AS (
	SELECT 
	date,
	client,
	count(distinct customer_id) customers_prior_year,
	0 as customers_current_year, 
	sum(quantity) quantity_prior_year,
	0 as quantity_current_year,
	sum(revenue) revenue_prior_year,
	0 as revenue_current_year,
	case when sum(quantity) > 0 then sum(revenue)/sum(quantity) else null end as aov_prior_year,
	null as aov_current_year
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_30_60`
	group by date, client
),

r2 AS (
	SELECT 
	date,
	client,
	0 as customers_prior_year,
	count(distinct customer_id) customers_current_year, 
	0 as quantity_prior_year,
	sum(quantity) quantity_current_year,
	0 as revenue_prior_year,
	sum(revenue) revenue_current_year,
	null as aov_prior_year,
	case when sum(quantity) > 0 then sum(revenue)/sum(quantity) else null end as aov_current_year
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30_rebuy`
	group by date, client
)

SELECT 
date,
client,
sum(customers_prior_year) customers_prior_year, 
sum(customers_current_year) customers_current_year,
sum(quantity_prior_year) quantity_prior_year,
sum(quantity_current_year) quantity_current_year,
sum(revenue_prior_year) revenue_prior_year,
sum(revenue_current_year) revenue_current_year,
sum(aov_prior_year) aov_prior_year,
sum(aov_current_year) aov_current_year,
case when sum(revenue_prior_year) > 0 then sum(revenue_current_year)/sum(revenue_prior_year) else null end as revenue_retention,
case when sum(customers_prior_year) > 0 then sum(customers_current_year)/sum(customers_prior_year) else null end as customer_retention
FROM
(
	SELECT
	date,
	client,
	customers_prior_year,
	customers_current_year,
	quantity_prior_year,
	quantity_current_year,
	revenue_prior_year,
	revenue_current_year,
	aov_prior_year,
	aov_current_year
	FROM r1

	UNION ALL

	SELECT
	date,
	client,
	customers_prior_year,
	customers_current_year,
	quantity_prior_year,
	quantity_current_year,
	revenue_prior_year,
	revenue_current_year,
	aov_prior_year,
	aov_current_year
	FROM r2

) 
GROUP BY date, client
2018-04-18 10:29:38,930: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109905cf8>]}
2018-04-18 10:29:39,107: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1098b61d0>]}
2018-04-18 10:29:39,170: 10:29:39 | 82 of 92 OK created table model agency_data_pipeline.retention_stats_rebuy_rate_month [CREATE TABLE in 3.22s]
2018-04-18 10:29:39,171: 10:29:39 | 83 of 92 START table model agency_data_pipeline.retention_stats_rebuy_rate [RUN]
2018-04-18 10:29:39,172: Compiling model.agency_data_pipeline.retention_stats_rebuy_rate
2018-04-18 10:29:39,181: Writing injected SQL for node "model.agency_data_pipeline.retention_stats_rebuy_rate"
2018-04-18 10:29:39,184: Acquiring new bigquery connection "retention_stats_rebuy_rate".
2018-04-18 10:29:39,184: Re-using an available connection from the pool.
2018-04-18 10:29:39,435: 10:29:39 | 77 of 92 OK created table model agency_data_pipeline.retention_0_365_new [CREATE TABLE in 11.85s]
2018-04-18 10:29:39,435: 10:29:39 | 84 of 92 START table model agency_data_pipeline.retention_0_30_reactivated [RUN]
2018-04-18 10:29:39,436: Compiling model.agency_data_pipeline.retention_0_30_reactivated
2018-04-18 10:29:39,443: Writing injected SQL for node "model.agency_data_pipeline.retention_0_30_reactivated"
2018-04-18 10:29:39,444: Acquiring new bigquery connection "retention_0_30_reactivated".
2018-04-18 10:29:39,444: Re-using an available connection from the pool.
2018-04-18 10:29:40,119: Model SQL (retention_stats_rebuy_rate):
WITH r1 AS (
	SELECT 
	date,
	client,
	count(distinct customer_id) customers_prior_year,
	0 as customers_current_year, 
	sum(quantity) quantity_prior_year,
	0 as quantity_current_year,
	sum(revenue) revenue_prior_year,
	0 as revenue_current_year,
	case when sum(quantity) > 0 then sum(revenue)/sum(quantity) else null end as aov_prior_year,
	null as aov_current_year
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_365_730`
	group by date, client
),

r2 AS (
	SELECT 
	date,
	client,
	0 as customers_prior_year,
	count(distinct customer_id) customers_current_year, 
	0 as quantity_prior_year,
	sum(quantity) quantity_current_year,
	0 as revenue_prior_year,
	sum(revenue) revenue_current_year,
	null as aov_prior_year,
	case when sum(quantity) > 0 then sum(revenue)/sum(quantity) else null end as aov_current_year
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365_rebuy`
	group by date, client
)

SELECT 
date,
client,
sum(customers_prior_year) customers_prior_year, 
sum(customers_current_year) customers_current_year,
sum(quantity_prior_year) quantity_prior_year,
sum(quantity_current_year) quantity_current_year,
sum(revenue_prior_year) revenue_prior_year,
sum(revenue_current_year) revenue_current_year,
sum(aov_prior_year) aov_prior_year,
sum(aov_current_year) aov_current_year,
case when sum(revenue_prior_year) > 0 then sum(revenue_current_year)/sum(revenue_prior_year) else null end as revenue_retention,
case when sum(customers_prior_year) > 0 then sum(customers_current_year)/sum(customers_prior_year) else null end as customer_retention
FROM
(
	SELECT
	date,
	client,
	customers_prior_year,
	customers_current_year,
	quantity_prior_year,
	quantity_current_year,
	revenue_prior_year,
	revenue_current_year,
	aov_prior_year,
	aov_current_year
	FROM r1

	UNION ALL

	SELECT
	date,
	client,
	customers_prior_year,
	customers_current_year,
	quantity_prior_year,
	quantity_current_year,
	revenue_prior_year,
	revenue_current_year,
	aov_prior_year,
	aov_current_year
	FROM r2

) 
GROUP BY date, client
2018-04-18 10:29:40,581: Model SQL (retention_0_30_reactivated):
SELECT 
a.client,
a.date,
a.customer_id, 
a.quantity,
a.revenue
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_60_plus` b
ON (
	a.client = b.client AND
	a.date = b.date AND
	a.customer_id = b.customer_id
)
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_30_60` c
ON (
	a.client = c.client AND
	a.date = c.date AND
	a.customer_id = c.customer_id
)
WHERE b.customer_id is not null 
AND c.customer_id is null
2018-04-18 10:29:41,226: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cd7f5f8>]}
2018-04-18 10:29:41,872: 10:29:41 | 81 of 92 OK created table model agency_data_pipeline.retention_0_30_new [CREATE TABLE in 7.60s]
2018-04-18 10:29:42,327: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109905cf8>]}
2018-04-18 10:29:42,586: 10:29:42 | 83 of 92 OK created table model agency_data_pipeline.retention_stats_rebuy_rate [CREATE TABLE in 3.16s]
2018-04-18 10:29:43,856: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1098ca198>]}
2018-04-18 10:29:44,108: 10:29:44 | 84 of 92 OK created table model agency_data_pipeline.retention_0_30_reactivated [CREATE TABLE in 4.42s]
2018-04-18 10:29:44,499: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109886710>]}
2018-04-18 10:29:44,765: 10:29:44 | 79 of 92 OK created table model agency_data_pipeline.segment_stats_customers [CREATE TABLE in 17.24s]
2018-04-18 10:29:44,767: 10:29:44 | 85 of 92 START table model agency_data_pipeline.segment_list_customers [RUN]
2018-04-18 10:29:44,767: Compiling model.agency_data_pipeline.segment_list_customers
2018-04-18 10:29:44,774: Writing injected SQL for node "model.agency_data_pipeline.segment_list_customers"
2018-04-18 10:29:44,775: Acquiring new bigquery connection "segment_list_customers".
2018-04-18 10:29:44,775: Re-using an available connection from the pool.
2018-04-18 10:29:45,718: Model SQL (segment_list_customers):
SELECT
a.client,
period,
date,
customer_id,
b.first_name,
b.last_name,
b.email,
recency_days,
frequency,
revenue,
quantity,
aov,
segment
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`agg_customers_union` b
ON (
	a.client = b.client AND
	a.customer_id = b.id
)
2018-04-18 10:30:20,965: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1098e50f0>]}
2018-04-18 10:30:21,221: 10:30:21 | 85 of 92 OK created table model agency_data_pipeline.segment_list_customers [CREATE TABLE in 36.20s]
2018-04-18 10:30:21,221: 10:30:21 | 86 of 92 START table model agency_data_pipeline.growth_customer_0_365_segment [RUN]
2018-04-18 10:30:21,222: Compiling model.agency_data_pipeline.growth_customer_0_365_segment
2018-04-18 10:30:21,230: Writing injected SQL for node "model.agency_data_pipeline.growth_customer_0_365_segment"
2018-04-18 10:30:21,234: Acquiring new bigquery connection "growth_customer_0_365_segment".
2018-04-18 10:30:21,234: Re-using an available connection from the pool.
2018-04-18 10:30:22,262: Model SQL (growth_customer_0_365_segment):
with segment as (

	SELECT 
	a.date,
	unix_date_in_range,
	unix_date_in_range_yoy,
	a.client client,
	a.customer_id customer_id,
	case when b.customer_id is not null then 'New' else 'Existing' end as segment,
	a.orders,
	a.quantity,
	a.revenue,
	a.shipping_revenue
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_customer_0_365` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365_new` b
	ON (
	  a.customer_id = b.customer_id AND
	  a.date  = b.date AND
	  a.client = b.client
	)
),

total as (

	SELECT 
	date,
	unix_date_in_range,
	unix_date_in_range_yoy,
	client,
	customer_id,
	'Total' as segment,
	orders,
	quantity,
	revenue,
	shipping_revenue
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_customer_0_365`

)

SELECT 
date,
unix_date_in_range,
unix_date_in_range_yoy,
client,
segment,
count(distinct(customer_id)) customers,
sum(orders) orders,
sum(quantity) quantity,
sum(revenue) revenue,
sum(shipping_revenue) shipping_revenue
FROM
( 
	SELECT * FROM segment
	UNION ALL
	SELECT * FROM total
) 
GROUP BY date, unix_date_in_range, unix_date_in_range_yoy, client, segment
2018-04-18 10:30:34,403: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109905978>]}
2018-04-18 10:30:35,145: 10:30:35 | 86 of 92 OK created table model agency_data_pipeline.growth_customer_0_365_segment [CREATE TABLE in 13.18s]
2018-04-18 10:30:35,146: 10:30:35 | 87 of 92 START table model agency_data_pipeline.growth_date_union.... [RUN]
2018-04-18 10:30:35,146: Compiling model.agency_data_pipeline.growth_date_union
2018-04-18 10:30:35,154: Writing injected SQL for node "model.agency_data_pipeline.growth_date_union"
2018-04-18 10:30:35,155: Acquiring new bigquery connection "growth_date_union".
2018-04-18 10:30:35,155: Re-using an available connection from the pool.
2018-04-18 10:30:35,985: Model SQL (growth_date_union):
with ty as (

  SELECT 
  date,
  unix_date_in_range, 
  unix_date_in_range_yoy, 
  client, 
  segment,
  customers customers_ty,
  orders orders_ty,
  quantity quantity_ty,
  revenue revenue_ty,
  shipping_revenue shipping_revenue_ty,
  null as customers_ly,
  null as orders_ly,
  null as quantity_ly,
  null as revenue_ly,
  null as shipping_revenue_ly
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_customer_0_365_segment`

),

ly as (

  SELECT 
  date,
  0 as unix_date_in_range, 
  unix_date_in_range unix_date_in_range_yoy, 
  client, 
  segment,
  null as customers_ty,
  null as orders_ty,
  null as quantity_ty,
  null as revenue_ty,
  null as shipping_revenue_ty,
  customers customers_ly,
  orders orders_ly,
  quantity quantity_ly,
  revenue revenue_ly,
  shipping_revenue shipping_revenue_ly
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_customer_0_365_segment`

)


SELECT
max(date) date,
max(unix_date_in_range) unix_date_in_range,
unix_date_in_range_yoy,
client,
segment,
ifnull(sum(customers_ty), 0) customers_ty,
ifnull(sum(orders_ty), 0) orders_ty,
ifnull(sum(quantity_ty), 0) quantity_ty,
ifnull(sum(revenue_ty), 0) revenue_ty,
ifnull(sum(shipping_revenue_ty), 0) shipping_revenue_ty,
case when sum(orders_ty) > 0 then sum(revenue_ty)/sum(orders_ty) else null end as aov_ty,
ifnull(sum(customers_ly), 0) customers_ly,
ifnull(sum(orders_ly), 0) orders_ly,
ifnull(sum(quantity_ly), 0) quantity_ly,
ifnull(sum(revenue_ly), 0) revenue_ly,
ifnull(sum(shipping_revenue_ly), 0) shipping_revenue_ly,
case when sum(orders_ly) > 0 then sum(revenue_ly)/sum(orders_ly) else null end as aov_ly,
case when sum(orders_ly) > 0 then ( sum(orders_ty) - sum(orders_ly) ) / sum(orders_ly) else null end as order_growth,
case when sum(revenue_ly) > 0 then ( sum(revenue_ty) - sum(revenue_ly) ) / sum(revenue_ly) else null end as revenue_growth,
case when sum(customers_ly) > 0 then ( sum(customers_ty) - sum(customers_ly) ) / sum(customers_ly) else null end as customer_growth,
case when sum(orders_ly) > 0 then ( sum(revenue_ty)/sum(orders_ty) - sum(revenue_ly)/sum(orders_ly) ) / ( sum(revenue_ly)/sum(orders_ly) ) else null end as aov_growth
FROM (

  SELECT * FROM ty
  UNION ALL
  SELECT * FROM ly

)
where unix_date_in_range is not null
group by unix_date_in_range_yoy, client, segment
2018-04-18 10:30:37,239: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cd7f5f8>]}
2018-04-18 10:30:37,498: 10:30:37 | 87 of 92 OK created table model agency_data_pipeline.growth_date_union [CREATE TABLE in 2.09s]
2018-04-18 10:30:37,498: 10:30:37 | 88 of 92 START table model agency_data_pipeline.retention_stats...... [RUN]
2018-04-18 10:30:37,498: Compiling model.agency_data_pipeline.retention_stats
2018-04-18 10:30:37,504: 10:30:37 | 89 of 92 START table model agency_data_pipeline.retention_stats_month [RUN]
2018-04-18 10:30:37,508: Writing injected SQL for node "model.agency_data_pipeline.retention_stats"
2018-04-18 10:30:37,508: 10:30:37 | 90 of 92 START table model agency_data_pipeline.growth_stats......... [RUN]
2018-04-18 10:30:37,508: Compiling model.agency_data_pipeline.retention_stats_month
2018-04-18 10:30:37,509: Compiling model.agency_data_pipeline.growth_stats
2018-04-18 10:30:37,519: Writing injected SQL for node "model.agency_data_pipeline.retention_stats_month"
2018-04-18 10:30:37,532: Acquiring new bigquery connection "retention_stats".
2018-04-18 10:30:37,536: Writing injected SQL for node "model.agency_data_pipeline.growth_stats"
2018-04-18 10:30:37,536: Re-using an available connection from the pool.
2018-04-18 10:30:37,541: Acquiring new bigquery connection "growth_stats".
2018-04-18 10:30:37,542: Re-using an available connection from the pool.
2018-04-18 10:30:37,549: Acquiring new bigquery connection "retention_stats_month".
2018-04-18 10:30:37,550: Re-using an available connection from the pool.
2018-04-18 10:30:38,385: Model SQL (retention_stats):
WITH last_year_buyers AS (
	SELECT 
	date,
	client,
	'Last year buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_365_730`
	group by date, client
),

rebuy_rate AS (
	SELECT 
	date,
	client,
	'Rebuy rate' as metric,
	customer_retention value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_stats_rebuy_rate`
),

repeat_buyers AS (
	SELECT 
	date,
	client,
	'Repeat buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365_rebuy`
	group by date, client
),

reactivated_buyers AS (
	SELECT 
	date,
	client,
	'Reactivated buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365_reactivated`
	group by date, client
),

new_buyers AS (
	SELECT 
	date,
	client,
	'New buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365_new`
	group by date, client
),

this_year_buyers AS (
	SELECT 
	date,
	client,
	'This year buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365`
	group by date, client
),

this_year_revenue AS (
	SELECT 
	date,
	client,
	'This year revenue' as metric,
	sum(revenue) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365`
	group by date, client
),

this_year_aov AS (
	SELECT 
	date,
	client,
	'This year AOV' as metric,
	case when sum(order_count) > 0 then sum(revenue)/sum(order_count) else 0 end as value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365`
	group by date, client
),

this_year_frequency AS (
	SELECT 
	date,
	client,
	'This year frequency' as metric,
	case when count(distinct customer_id) > 0 then sum(order_count)/count(distinct customer_id) else 0 end as value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365`
	group by date, client
)

SELECT 
date,
client,
metric,
ifnull(value, 0) value
FROM
(
	SELECT
	date,
	client,
	metric,
	value
	FROM last_year_buyers

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM rebuy_rate

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM repeat_buyers

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM reactivated_buyers	

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM new_buyers	

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_year_buyers	

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_year_revenue

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_year_aov

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_year_frequency

	UNION ALL

	SELECT
	a.date,
	a.client,
	'Dormant buyers' as metric,
	a.value - ifnull(b.value, 0) as value
	FROM last_year_buyers a
	LEFT JOIN repeat_buyers b
	ON ( a.date = b.date AND
		a.client = b.client )							

)
2018-04-18 10:30:38,389: Model SQL (growth_stats):
with orders as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'Orders' as metric,
  orders_ty as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`
),

order_growth as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'Order Growth' as metric,
  order_growth as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`
),

revenue as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'Revenue' as metric,
  revenue_ty as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`
),

revenue_growth as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'Revenue Growth' as metric,
  revenue_growth as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`
),

customers as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'Customers' as metric,
  customers_ty as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`
),

customer_growth as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'Customer Growth' as metric,
  customer_growth as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`

),

aov as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'AOV' as metric,
  aov_ty as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`

),

aov_growth as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'AOV Growth' as metric,
  aov_growth as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`

)

SELECT * FROM orders
UNION ALL 
SELECT * FROM order_growth
UNION ALL
SELECT * FROM revenue
UNION ALL 
SELECT * FROM revenue_growth
UNION ALL
SELECT * FROM customers
UNION ALL 
SELECT * FROM customer_growth
UNION ALL
SELECT * FROM aov
UNION ALL 
SELECT * FROM aov_growth
2018-04-18 10:30:38,416: Model SQL (retention_stats_month):
WITH last_month_buyers AS (
	SELECT 
	date,
	client,
	'Last month buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_30_60`
	group by date, client
),

rebuy_rate AS (
	SELECT 
	date,
	client,
	'Rebuy rate' as metric,
	customer_retention value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_stats_rebuy_rate_month`
),

repeat_buyers AS (
	SELECT 
	date,
	client,
	'Repeat buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30_rebuy`
	group by date, client
),

reactivated_buyers AS (
	SELECT 
	date,
	client,
	'Reactivated buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30_reactivated`
	group by date, client
),

new_buyers AS (
	SELECT 
	date,
	client,
	'New buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30_new`
	group by date, client
),

this_month_buyers AS (
	SELECT 
	date,
	client,
	'This month buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30`
	group by date, client
),

this_month_revenue AS (
	SELECT 
	date,
	client,
	'This month revenue' as metric,
	sum(revenue) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30`
	group by date, client
),

this_month_aov AS (
	SELECT 
	date,
	client,
	'This month AOV' as metric,
	case when sum(order_count) > 0 then sum(revenue)/sum(order_count) else 0 end as value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30`
	group by date, client
),

this_month_frequency AS (
	SELECT 
	date,
	client,
	'This month frequency' as metric,
	case when count(distinct customer_id) > 0 then sum(order_count)/count(distinct customer_id) else 0 end as value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30`
	group by date, client
)

SELECT 
date,
client,
metric,
ifnull(value, 0) value
FROM
(
	SELECT
	date,
	client,
	metric,
	value
	FROM last_month_buyers

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM rebuy_rate

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM repeat_buyers

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM reactivated_buyers	

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM new_buyers	

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_month_buyers	

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_month_revenue

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_month_aov

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_month_frequency

	UNION ALL

	SELECT
	a.date,
	a.client,
	'Dormant buyers' as metric,
	a.value - ifnull(b.value, 0) as value
	FROM last_month_buyers a
	LEFT JOIN repeat_buyers b
	ON ( a.date = b.date AND
		a.client = b.client )							

)
2018-04-18 10:30:39,474: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1099330b8>]}
2018-04-18 10:30:39,716: 10:30:39 | 90 of 92 OK created table model agency_data_pipeline.growth_stats.... [CREATE TABLE in 1.97s]
2018-04-18 10:30:41,720: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109927eb8>]}
2018-04-18 10:30:41,952: 10:30:41 | 89 of 92 OK created table model agency_data_pipeline.retention_stats_month [CREATE TABLE in 4.21s]
2018-04-18 10:30:46,085: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10994b1d0>]}
2018-04-18 10:30:46,333: 10:30:46 | 88 of 92 OK created table model agency_data_pipeline.retention_stats. [CREATE TABLE in 8.59s]
2018-04-18 10:30:46,334: 10:30:46 | 91 of 92 START table model agency_data_pipeline.agg_campaign......... [RUN]
2018-04-18 10:30:46,334: Compiling model.agency_data_pipeline.agg_campaign
2018-04-18 10:30:46,343: Writing injected SQL for node "model.agency_data_pipeline.agg_campaign"
2018-04-18 10:30:46,347: Acquiring new bigquery connection "agg_campaign".
2018-04-18 10:30:46,347: Re-using an available connection from the pool.
2018-04-18 10:30:47,288: Model SQL (agg_campaign):
with ga as (

	select 
		date, client, attribution, channel, platform, url, campaign as utm_campaign, '' as campaign,
    	customers_new,
    	transactions_new,
    	revenue_new,
    	first_order_revenue_new,
    	lifetime_revenue_new,
    	customers_total,
    	transactions_total,
    	revenue_total,
		null as cost, null as impressions, null as clicks, null as ad_platform_transactions
	from `growth-engines-pipeline`.`agency_data_pipeline`.`agg_ga_campaign_by_type`

),

platforms_last_touch as (

	select 
		date, client, 'Last-touch' as attribution, channel, platform, url, utm_campaign, campaign,
		null as customers_new,
    	null as transactions_new,
    	null as revenue_new,
    	null as first_order_revenue_new,
    	null as lifetime_revenue_new,
    	null as customers_total,
    	null as transactions_total,
    	null as revenue_total,
		cost, impressions, clicks, ad_platform_transactions
	from `growth-engines-pipeline`.`agency_data_pipeline`.`agg_platforms_client`

),

platforms_first_touch as (

    select 
        date, client, 'First-touch' as attribution, channel, platform, url, utm_campaign, campaign,
        null as customers_new,
        null as transactions_new,
        null as revenue_new,
        null as first_order_revenue_new,
        null as lifetime_revenue_new,
        null as customers_total,
        null as transactions_total,
        null as revenue_total,
        cost, impressions, clicks, ad_platform_transactions
    from `growth-engines-pipeline`.`agency_data_pipeline`.`agg_platforms_client`

)


SELECT
    date, 
    client,
    attribution,
    platform,
    channel, 
    url,
    utm_campaign,
    max(campaign) campaign,
    ifnull( sum(cost), 0) cost,
	ifnull( sum(impressions), 0) impressions,
	ifnull( sum(clicks), 0) clicks,
	ifnull( sum(ad_platform_transactions), 0) ad_platform_transactions,
	ifnull( sum(customers_new), 0) customers_new,
	ifnull( sum(transactions_new), 0) transactions_new,
	ifnull( sum(revenue_new), 0) revenue_new,
	ifnull( sum(first_order_revenue_new), 0) first_order_revenue_new,
	ifnull( sum(lifetime_revenue_new), 0) lifetime_revenue_new,
	ifnull( sum(customers_total), 0) customers_total,
	ifnull( sum(transactions_total), 0) transactions_total,
	ifnull( sum(revenue_total), 0) revenue_total	
FROM 
(
    SELECT *
    FROM 
      ga
    UNION ALL
    SELECT *
    FROM 
      platforms_first_touch
    UNION ALL
    SELECT *
    FROM 
      platforms_last_touch      
) 
GROUP BY
    date, client, attribution, platform, channel, url, utm_campaign
2018-04-18 10:30:56,101: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cd7f5f8>]}
2018-04-18 10:30:56,346: 10:30:56 | 91 of 92 OK created table model agency_data_pipeline.agg_campaign.... [CREATE TABLE in 9.77s]
2018-04-18 10:30:56,347: 10:30:56 | 92 of 92 START table model agency_data_pipeline.agg_platform_monthly. [RUN]
2018-04-18 10:30:56,347: Compiling model.agency_data_pipeline.agg_platform_monthly
2018-04-18 10:30:56,357: Writing injected SQL for node "model.agency_data_pipeline.agg_platform_monthly"
2018-04-18 10:30:56,358: Acquiring new bigquery connection "agg_platform_monthly".
2018-04-18 10:30:56,358: Re-using an available connection from the pool.
2018-04-18 10:30:57,213: Model SQL (agg_platform_monthly):
SELECT
    FORMAT_DATE("%Y-%m", date) AS yyyymm,
    client,
    attribution,
    platform,
    channel, 
    sum(cost) cost,
	sum(clicks) clicks,
	sum(customers_new) customers_new,
	sum(first_order_revenue_new) first_order_revenue_new,
	sum(lifetime_revenue_new) lifetime_revenue_new,
	sum(transactions_new) transactions_new,
	sum(revenue_new) revenue_new,
    sum(customers_total) customers_total,
    sum(transactions_total) transactions_total,
    sum(revenue_total) revenue_total
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_campaign`
GROUP BY
    yyyymm, client, attribution, platform, channel
2018-04-18 10:30:59,405: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '0f12dc2b-3045-4ee4-8596-3dbaa450e105', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109905978>]}
2018-04-18 10:30:59,649: 10:30:59 | 92 of 92 OK created table model agency_data_pipeline.agg_platform_monthly [CREATE TABLE in 3.06s]
2018-04-18 10:30:59,668: 10:30:59 | 
2018-04-18 10:30:59,669: 10:30:59 | Finished running 92 table models in 438.71s.
2018-04-18 10:30:59,669: Connection 'master' was left open.
2018-04-18 10:30:59,669: 
2018-04-18 10:30:59,670: Completed successfully
2018-04-18 10:30:59,670: 
Done. PASS=92 ERROR=0 SKIP=0 TOTAL=92
2018-04-18 10:30:59,671: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cc76630>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cc419e8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10cc41c18>]}
2018-04-18 10:30:59,954: Flushing usage events
2018-04-18 11:09:35,199: Tracking: tracking
2018-04-18 11:09:35,203: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ae65588>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ae65828>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ae65ba8>]}
2018-04-18 11:09:35,997: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-04-18 11:09:36,019: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/growth-engines/dbt_modules
2018-04-18 11:09:36,025: Parsing get_column_values.sql
2018-04-18 11:09:36,048: Parsing get_url_parameter.sql
2018-04-18 11:09:36,057: Parsing split_part.sql
2018-04-18 11:09:36,065: Parsing table_exists.sql
2018-04-18 11:09:36,078: Parsing core.sql
2018-04-18 11:09:36,092: Parsing adapters/bigquery.sql
2018-04-18 11:09:36,100: Parsing adapters/common.sql
2018-04-18 11:09:36,127: Parsing adapters/postgres.sql
2018-04-18 11:09:36,135: Parsing adapters/redshift.sql
2018-04-18 11:09:36,162: Parsing etc/get_custom_schema.sql
2018-04-18 11:09:36,172: Parsing materializations/archive.sql
2018-04-18 11:09:36,208: Parsing materializations/bigquery.sql
2018-04-18 11:09:36,225: Parsing materializations/helpers.sql
2018-04-18 11:09:36,246: Parsing materializations/incremental.sql
2018-04-18 11:09:36,277: Parsing materializations/table.sql
2018-04-18 11:09:36,299: Parsing materializations/view.sql
2018-04-18 11:09:36,317: Parsing materializations/wrapper.sql
2018-04-18 11:09:36,323: Parsing schema_tests/accepted_values.sql
2018-04-18 11:09:36,330: Parsing schema_tests/not_null.sql
2018-04-18 11:09:36,335: Parsing schema_tests/relationships.sql
2018-04-18 11:09:36,341: Parsing schema_tests/unique.sql
2018-04-18 11:09:36,631: Parsing model.agency_data_pipeline.accounts_proc
2018-04-18 11:09:36,635: Parsing model.agency_data_pipeline.all_dates
2018-04-18 11:09:36,636: Parsing model.agency_data_pipeline.carts_proc
2018-04-18 11:09:36,639: Parsing model.agency_data_pipeline.clients_proc
2018-04-18 11:09:36,640: Parsing model.agency_data_pipeline.cogs_proc
2018-04-18 11:09:36,642: Parsing model.agency_data_pipeline.conversion_goals_proc
2018-04-18 11:09:36,643: Parsing model.agency_data_pipeline.mappings_ga_proc
2018-04-18 11:09:36,645: Acquiring new bigquery connection "master".
2018-04-18 11:09:36,645: Opening a new connection (0 currently allocated)
2018-04-18 11:09:36,650: Parsing model.agency_data_pipeline.monthend_dates
2018-04-18 11:09:36,652: Parsing model.agency_data_pipeline.adwords_ads
2018-04-18 11:09:36,654: Parsing model.agency_data_pipeline.adwords_campaigns
2018-04-18 11:09:36,656: Parsing model.agency_data_pipeline.adwords_conversions
2018-04-18 11:09:36,658: Parsing model.agency_data_pipeline.adwords_impression_share
2018-04-18 11:09:36,660: Parsing model.agency_data_pipeline.adwords_join
2018-04-18 11:09:36,662: Parsing model.agency_data_pipeline.adwords_stats
2018-04-18 11:09:36,664: Parsing model.agency_data_pipeline.adwords_urls
2018-04-18 11:09:36,666: Parsing model.agency_data_pipeline.bing_ads_ads
2018-04-18 11:09:36,669: Parsing model.agency_data_pipeline.bing_ads_conversions
2018-04-18 11:09:36,672: Parsing model.agency_data_pipeline.bing_ads_impression_share
2018-04-18 11:09:36,675: Parsing model.agency_data_pipeline.bing_ads_stats
2018-04-18 11:09:36,679: Parsing model.agency_data_pipeline.fb_adcreative
2018-04-18 11:09:36,685: Parsing model.agency_data_pipeline.fb_ads
2018-04-18 11:09:36,692: Parsing model.agency_data_pipeline.fb_ads_insights
2018-04-18 11:09:36,698: Parsing model.agency_data_pipeline.fb_ads_insights_conversions
2018-04-18 11:09:36,703: Parsing model.agency_data_pipeline.fb_ads_stats
2018-04-18 11:09:36,706: Parsing model.agency_data_pipeline.ga_conversions
2018-04-18 11:09:36,708: Parsing model.agency_data_pipeline.ga_traffic
2018-04-18 11:09:36,720: Parsing model.agency_data_pipeline.ga_transactions
2018-04-18 11:09:36,730: Parsing model.agency_data_pipeline.ga_mcf_proc
2018-04-18 11:09:36,732: Parsing model.agency_data_pipeline.ga_mcf_stats
2018-04-18 11:09:36,735: Parsing model.agency_data_pipeline.shopify_customers_proc
2018-04-18 11:09:36,742: Parsing model.agency_data_pipeline.shopify_orders_proc
2018-04-18 11:09:36,748: Parsing model.agency_data_pipeline.shopify_products_proc
2018-04-18 11:09:36,755: Parsing model.agency_data_pipeline.shopify_refunds_proc
2018-04-18 11:09:36,760: Parsing model.agency_data_pipeline.agg_campaign
2018-04-18 11:09:36,765: Parsing model.agency_data_pipeline.agg_customers_union
2018-04-18 11:09:36,768: Parsing model.agency_data_pipeline.agg_ga_campaign
2018-04-18 11:09:36,771: Parsing model.agency_data_pipeline.agg_ga_campaign_by_type
2018-04-18 11:09:36,775: Parsing model.agency_data_pipeline.agg_ga_transaction
2018-04-18 11:09:36,778: Parsing model.agency_data_pipeline.agg_ga_transaction_order_number
2018-04-18 11:09:36,780: Parsing model.agency_data_pipeline.agg_orders_union
2018-04-18 11:09:36,788: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10af32e10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10afe2860>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10afe2fd0>]}
2018-04-18 11:09:37,078: Encountered an error:
2018-04-18 11:09:37,079: Compilation Error in model agg_orders_union (models/join/agg_orders_union.sql)
  expected token ')', got 'string'
    line 75
      LEFT JOIN {{ (ref'aggs_products_cogs') }} b
2018-04-18 11:09:37,104: Traceback (most recent call last):
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/clients/jinja.py", line 148, in get_template
    return env.from_string(dbt.compat.to_string(string), globals=ctx)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/environment.py", line 880, in from_string
    return cls.from_code(self, self.compile(source), globals, None)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/environment.py", line 591, in compile
    self.handle_exception(exc_info, source_hint=source_hint)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/environment.py", line 780, in handle_exception
    reraise(exc_type, exc_value, tb)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/_compat.py", line 37, in reraise
    raise value.with_traceback(tb)
  File "<unknown>", line 75, in template
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/clients/jinja.py", line 37, in _parse
    jinja2._compat.encode_filename(filename)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/parser.py", line 896, in parse
    result = nodes.Template(self.subparse(), lineno=1)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/parser.py", line 870, in subparse
    add_data(self.parse_tuple(with_condexpr=True))
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/parser.py", line 615, in parse_tuple
    args.append(parse())
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/parser.py", line 427, in parse_expression
    return self.parse_condexpr()
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/parser.py", line 432, in parse_condexpr
    expr1 = self.parse_or()
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/parser.py", line 445, in parse_or
    left = self.parse_and()
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/parser.py", line 454, in parse_and
    left = self.parse_not()
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/parser.py", line 465, in parse_not
    return self.parse_compare()
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/parser.py", line 469, in parse_compare
    expr = self.parse_math1()
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/parser.py", line 491, in parse_math1
    left = self.parse_concat()
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/parser.py", line 502, in parse_concat
    args = [self.parse_math2()]
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/parser.py", line 512, in parse_math2
    left = self.parse_pow()
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/parser.py", line 523, in parse_pow
    left = self.parse_unary()
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/parser.py", line 541, in parse_unary
    node = self.parse_primary()
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/parser.py", line 572, in parse_primary
    self.stream.expect('rparen')
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/lexer.py", line 386, in expect
    self.name, self.filename)
jinja2.exceptions.TemplateSyntaxError: expected token ')', got 'string'
  line 75
    LEFT JOIN {{ (ref'aggs_products_cogs') }} b

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/main.py", line 40, in main
    results, succeeded = handle_and_check(args)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/main.py", line 84, in handle_and_check
    task, res = run_from_args(parsed)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/main.py", line 138, in run_from_args
    results = run_from_task(task, proj, parsed)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/main.py", line 146, in run_from_task
    result = task.run()
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/task/run.py", line 26, in run
    results = runner.run(query, ModelRunner)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/runner.py", line 221, in run
    return self.run_from_graph(Selector, Runner, query)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/runner.py", line 183, in run_from_graph
    flat_graph, linker = self.compile(self.project)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/runner.py", line 179, in compile
    (flat_graph, linker) = compiler.compile()
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/compilation.py", line 278, in compile
    root_project, all_projects)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/loader.py", line 23, in load_all
    loader.load_all(root_project, all_projects, macros))
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/loader.py", line 48, in load_all
    project, project_name, macros))
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/loader.py", line 85, in load_project
    macros=macros)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/parser.py", line 338, in load_and_parse_sql
    return parse_sql_nodes(result, root_project, all_projects, tags, macros)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/parser.py", line 282, in parse_sql_nodes
    macros=macros)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/parser.py", line 231, in parse_node
    capture_macros=True)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/clients/jinja.py", line 169, in get_rendered
    capture_macros=capture_macros)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/clients/jinja.py", line 153, in get_template
    dbt.exceptions.raise_compiler_error(str(e), node)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/exceptions.py", line 115, in raise_compiler_error
    raise CompilationException(msg, node)
dbt.exceptions.CompilationException: Compilation Error in model agg_orders_union (models/join/agg_orders_union.sql)
  expected token ')', got 'string'
    line 75
      LEFT JOIN {{ (ref'aggs_products_cogs') }} b

2018-04-18 11:14:16,696: Tracking: tracking
2018-04-18 11:14:16,699: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1084f0cc0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1084f0eb8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1084f0f60>]}
2018-04-18 11:14:17,435: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-04-18 11:14:17,461: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/growth-engines/dbt_modules
2018-04-18 11:14:17,468: Parsing get_column_values.sql
2018-04-18 11:14:17,485: Parsing get_url_parameter.sql
2018-04-18 11:14:17,491: Parsing split_part.sql
2018-04-18 11:14:17,499: Parsing table_exists.sql
2018-04-18 11:14:17,514: Parsing core.sql
2018-04-18 11:14:17,532: Parsing adapters/bigquery.sql
2018-04-18 11:14:17,542: Parsing adapters/common.sql
2018-04-18 11:14:17,563: Parsing adapters/postgres.sql
2018-04-18 11:14:17,570: Parsing adapters/redshift.sql
2018-04-18 11:14:17,593: Parsing etc/get_custom_schema.sql
2018-04-18 11:14:17,601: Parsing materializations/archive.sql
2018-04-18 11:14:17,641: Parsing materializations/bigquery.sql
2018-04-18 11:14:17,665: Parsing materializations/helpers.sql
2018-04-18 11:14:17,684: Parsing materializations/incremental.sql
2018-04-18 11:14:17,715: Parsing materializations/table.sql
2018-04-18 11:14:17,742: Parsing materializations/view.sql
2018-04-18 11:14:17,768: Parsing materializations/wrapper.sql
2018-04-18 11:14:17,775: Parsing schema_tests/accepted_values.sql
2018-04-18 11:14:17,782: Parsing schema_tests/not_null.sql
2018-04-18 11:14:17,788: Parsing schema_tests/relationships.sql
2018-04-18 11:14:17,793: Parsing schema_tests/unique.sql
2018-04-18 11:14:17,859: Parsing model.agency_data_pipeline.accounts_proc
2018-04-18 11:14:17,861: Parsing model.agency_data_pipeline.all_dates
2018-04-18 11:14:17,863: Parsing model.agency_data_pipeline.carts_proc
2018-04-18 11:14:17,866: Parsing model.agency_data_pipeline.clients_proc
2018-04-18 11:14:17,869: Parsing model.agency_data_pipeline.cogs_proc
2018-04-18 11:14:17,872: Parsing model.agency_data_pipeline.conversion_goals_proc
2018-04-18 11:14:17,874: Parsing model.agency_data_pipeline.mappings_ga_proc
2018-04-18 11:14:17,877: Acquiring new bigquery connection "master".
2018-04-18 11:14:17,877: Opening a new connection (0 currently allocated)
2018-04-18 11:14:17,881: Parsing model.agency_data_pipeline.monthend_dates
2018-04-18 11:14:17,883: Parsing model.agency_data_pipeline.adwords_ads
2018-04-18 11:14:17,885: Parsing model.agency_data_pipeline.adwords_campaigns
2018-04-18 11:14:17,889: Parsing model.agency_data_pipeline.adwords_conversions
2018-04-18 11:14:17,891: Parsing model.agency_data_pipeline.adwords_impression_share
2018-04-18 11:14:17,892: Parsing model.agency_data_pipeline.adwords_join
2018-04-18 11:14:17,895: Parsing model.agency_data_pipeline.adwords_stats
2018-04-18 11:14:17,898: Parsing model.agency_data_pipeline.adwords_urls
2018-04-18 11:14:17,900: Parsing model.agency_data_pipeline.bing_ads_ads
2018-04-18 11:14:17,904: Parsing model.agency_data_pipeline.bing_ads_conversions
2018-04-18 11:14:17,907: Parsing model.agency_data_pipeline.bing_ads_impression_share
2018-04-18 11:14:17,909: Parsing model.agency_data_pipeline.bing_ads_stats
2018-04-18 11:14:17,913: Parsing model.agency_data_pipeline.fb_adcreative
2018-04-18 11:14:17,919: Parsing model.agency_data_pipeline.fb_ads
2018-04-18 11:14:17,927: Parsing model.agency_data_pipeline.fb_ads_insights
2018-04-18 11:14:17,935: Parsing model.agency_data_pipeline.fb_ads_insights_conversions
2018-04-18 11:14:17,944: Parsing model.agency_data_pipeline.fb_ads_stats
2018-04-18 11:14:17,948: Parsing model.agency_data_pipeline.ga_conversions
2018-04-18 11:14:17,950: Parsing model.agency_data_pipeline.ga_traffic
2018-04-18 11:14:17,971: Parsing model.agency_data_pipeline.ga_transactions
2018-04-18 11:14:17,983: Parsing model.agency_data_pipeline.ga_mcf_proc
2018-04-18 11:14:17,986: Parsing model.agency_data_pipeline.ga_mcf_stats
2018-04-18 11:14:17,990: Parsing model.agency_data_pipeline.shopify_customers_proc
2018-04-18 11:14:17,998: Parsing model.agency_data_pipeline.shopify_orders_proc
2018-04-18 11:14:18,008: Parsing model.agency_data_pipeline.shopify_products_proc
2018-04-18 11:14:18,019: Parsing model.agency_data_pipeline.shopify_refunds_proc
2018-04-18 11:14:18,027: Parsing model.agency_data_pipeline.agg_campaign
2018-04-18 11:14:18,031: Parsing model.agency_data_pipeline.agg_customers_union
2018-04-18 11:14:18,033: Parsing model.agency_data_pipeline.agg_ga_campaign
2018-04-18 11:14:18,038: Parsing model.agency_data_pipeline.agg_ga_campaign_by_type
2018-04-18 11:14:18,041: Parsing model.agency_data_pipeline.agg_ga_transaction
2018-04-18 11:14:18,046: Parsing model.agency_data_pipeline.agg_ga_transaction_order_number
2018-04-18 11:14:18,049: Parsing model.agency_data_pipeline.agg_orders_union
2018-04-18 11:14:18,060: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108668390>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108668fd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108567668>]}
2018-04-18 11:14:18,704: Encountered an error:
2018-04-18 11:14:18,705: Compilation Error in model agg_orders_union (models/join/agg_orders_union.sql)
  unexpected '}', expected ')'
    line 75
      LEFT JOIN {{ (ref('aggs_products_cogs') }} b
2018-04-18 11:14:18,735: Traceback (most recent call last):
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/clients/jinja.py", line 148, in get_template
    return env.from_string(dbt.compat.to_string(string), globals=ctx)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/environment.py", line 880, in from_string
    return cls.from_code(self, self.compile(source), globals, None)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/environment.py", line 591, in compile
    self.handle_exception(exc_info, source_hint=source_hint)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/environment.py", line 780, in handle_exception
    reraise(exc_type, exc_value, tb)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/_compat.py", line 37, in reraise
    raise value.with_traceback(tb)
  File "<unknown>", line 75, in template
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/clients/jinja.py", line 37, in _parse
    jinja2._compat.encode_filename(filename)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/parser.py", line 896, in parse
    result = nodes.Template(self.subparse(), lineno=1)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/parser.py", line 870, in subparse
    add_data(self.parse_tuple(with_condexpr=True))
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/parser.py", line 615, in parse_tuple
    args.append(parse())
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/parser.py", line 427, in parse_expression
    return self.parse_condexpr()
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/parser.py", line 432, in parse_condexpr
    expr1 = self.parse_or()
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/parser.py", line 445, in parse_or
    left = self.parse_and()
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/parser.py", line 454, in parse_and
    left = self.parse_not()
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/parser.py", line 465, in parse_not
    return self.parse_compare()
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/parser.py", line 469, in parse_compare
    expr = self.parse_math1()
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/parser.py", line 491, in parse_math1
    left = self.parse_concat()
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/parser.py", line 502, in parse_concat
    args = [self.parse_math2()]
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/parser.py", line 512, in parse_math2
    left = self.parse_pow()
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/parser.py", line 523, in parse_pow
    left = self.parse_unary()
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/parser.py", line 541, in parse_unary
    node = self.parse_primary()
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/parser.py", line 571, in parse_primary
    node = self.parse_tuple(explicit_parentheses=True)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/parser.py", line 615, in parse_tuple
    args.append(parse())
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/parser.py", line 427, in parse_expression
    return self.parse_condexpr()
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/parser.py", line 432, in parse_condexpr
    expr1 = self.parse_or()
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/parser.py", line 445, in parse_or
    left = self.parse_and()
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/parser.py", line 454, in parse_and
    left = self.parse_not()
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/parser.py", line 465, in parse_not
    return self.parse_compare()
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/parser.py", line 469, in parse_compare
    expr = self.parse_math1()
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/parser.py", line 491, in parse_math1
    left = self.parse_concat()
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/parser.py", line 502, in parse_concat
    args = [self.parse_math2()]
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/parser.py", line 512, in parse_math2
    left = self.parse_pow()
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/parser.py", line 523, in parse_pow
    left = self.parse_unary()
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/parser.py", line 542, in parse_unary
    node = self.parse_postfix(node)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/parser.py", line 671, in parse_postfix
    node = self.parse_call(node)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/parser.py", line 788, in parse_call
    self.stream.expect('rparen')
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/lexer.py", line 390, in expect
    next(self)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/lexer.py", line 361, in __next__
    self.current = next(self._iter)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/lexer.py", line 564, in wrap
    for lineno, token, value in stream:
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/lexer.py", line 688, in tokeniter
    filename)
jinja2.exceptions.TemplateSyntaxError: unexpected '}', expected ')'
  line 75
    LEFT JOIN {{ (ref('aggs_products_cogs') }} b

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/main.py", line 40, in main
    results, succeeded = handle_and_check(args)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/main.py", line 84, in handle_and_check
    task, res = run_from_args(parsed)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/main.py", line 138, in run_from_args
    results = run_from_task(task, proj, parsed)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/main.py", line 146, in run_from_task
    result = task.run()
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/task/run.py", line 26, in run
    results = runner.run(query, ModelRunner)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/runner.py", line 221, in run
    return self.run_from_graph(Selector, Runner, query)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/runner.py", line 183, in run_from_graph
    flat_graph, linker = self.compile(self.project)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/runner.py", line 179, in compile
    (flat_graph, linker) = compiler.compile()
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/compilation.py", line 278, in compile
    root_project, all_projects)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/loader.py", line 23, in load_all
    loader.load_all(root_project, all_projects, macros))
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/loader.py", line 48, in load_all
    project, project_name, macros))
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/loader.py", line 85, in load_project
    macros=macros)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/parser.py", line 338, in load_and_parse_sql
    return parse_sql_nodes(result, root_project, all_projects, tags, macros)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/parser.py", line 282, in parse_sql_nodes
    macros=macros)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/parser.py", line 231, in parse_node
    capture_macros=True)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/clients/jinja.py", line 169, in get_rendered
    capture_macros=capture_macros)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/clients/jinja.py", line 153, in get_template
    dbt.exceptions.raise_compiler_error(str(e), node)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/exceptions.py", line 115, in raise_compiler_error
    raise CompilationException(msg, node)
dbt.exceptions.CompilationException: Compilation Error in model agg_orders_union (models/join/agg_orders_union.sql)
  unexpected '}', expected ')'
    line 75
      LEFT JOIN {{ (ref('aggs_products_cogs') }} b

2018-04-18 11:30:13,838: Tracking: tracking
2018-04-18 11:30:13,841: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b463fd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b463e48>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b463da0>]}
2018-04-18 11:30:14,663: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-04-18 11:30:14,694: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/growth-engines/dbt_modules
2018-04-18 11:30:14,700: Parsing get_column_values.sql
2018-04-18 11:30:14,722: Parsing get_url_parameter.sql
2018-04-18 11:30:14,728: Parsing split_part.sql
2018-04-18 11:30:14,737: Parsing table_exists.sql
2018-04-18 11:30:14,747: Parsing core.sql
2018-04-18 11:30:14,762: Parsing adapters/bigquery.sql
2018-04-18 11:30:14,770: Parsing adapters/common.sql
2018-04-18 11:30:14,788: Parsing adapters/postgres.sql
2018-04-18 11:30:14,795: Parsing adapters/redshift.sql
2018-04-18 11:30:14,823: Parsing etc/get_custom_schema.sql
2018-04-18 11:30:14,831: Parsing materializations/archive.sql
2018-04-18 11:30:14,870: Parsing materializations/bigquery.sql
2018-04-18 11:30:14,892: Parsing materializations/helpers.sql
2018-04-18 11:30:14,912: Parsing materializations/incremental.sql
2018-04-18 11:30:14,944: Parsing materializations/table.sql
2018-04-18 11:30:14,967: Parsing materializations/view.sql
2018-04-18 11:30:14,986: Parsing materializations/wrapper.sql
2018-04-18 11:30:14,993: Parsing schema_tests/accepted_values.sql
2018-04-18 11:30:14,999: Parsing schema_tests/not_null.sql
2018-04-18 11:30:15,004: Parsing schema_tests/relationships.sql
2018-04-18 11:30:15,010: Parsing schema_tests/unique.sql
2018-04-18 11:30:15,312: Parsing model.agency_data_pipeline.accounts_proc
2018-04-18 11:30:15,317: Parsing model.agency_data_pipeline.all_dates
2018-04-18 11:30:15,320: Parsing model.agency_data_pipeline.carts_proc
2018-04-18 11:30:15,324: Parsing model.agency_data_pipeline.clients_proc
2018-04-18 11:30:15,327: Parsing model.agency_data_pipeline.cogs_proc
2018-04-18 11:30:15,329: Parsing model.agency_data_pipeline.conversion_goals_proc
2018-04-18 11:30:15,332: Parsing model.agency_data_pipeline.mappings_ga_proc
2018-04-18 11:30:15,334: Acquiring new bigquery connection "master".
2018-04-18 11:30:15,334: Opening a new connection (0 currently allocated)
2018-04-18 11:30:15,338: Parsing model.agency_data_pipeline.monthend_dates
2018-04-18 11:30:15,340: Parsing model.agency_data_pipeline.adwords_ads
2018-04-18 11:30:15,343: Parsing model.agency_data_pipeline.adwords_campaigns
2018-04-18 11:30:15,345: Parsing model.agency_data_pipeline.adwords_conversions
2018-04-18 11:30:15,346: Parsing model.agency_data_pipeline.adwords_impression_share
2018-04-18 11:30:15,350: Parsing model.agency_data_pipeline.adwords_join
2018-04-18 11:30:15,353: Parsing model.agency_data_pipeline.adwords_stats
2018-04-18 11:30:15,355: Parsing model.agency_data_pipeline.adwords_urls
2018-04-18 11:30:15,356: Parsing model.agency_data_pipeline.bing_ads_ads
2018-04-18 11:30:15,359: Parsing model.agency_data_pipeline.bing_ads_conversions
2018-04-18 11:30:15,362: Parsing model.agency_data_pipeline.bing_ads_impression_share
2018-04-18 11:30:15,363: Parsing model.agency_data_pipeline.bing_ads_stats
2018-04-18 11:30:15,367: Parsing model.agency_data_pipeline.fb_adcreative
2018-04-18 11:30:15,376: Parsing model.agency_data_pipeline.fb_ads
2018-04-18 11:30:15,383: Parsing model.agency_data_pipeline.fb_ads_insights
2018-04-18 11:30:15,389: Parsing model.agency_data_pipeline.fb_ads_insights_conversions
2018-04-18 11:30:15,397: Parsing model.agency_data_pipeline.fb_ads_stats
2018-04-18 11:30:15,404: Parsing model.agency_data_pipeline.ga_conversions
2018-04-18 11:30:15,408: Parsing model.agency_data_pipeline.ga_traffic
2018-04-18 11:30:15,423: Parsing model.agency_data_pipeline.ga_transactions
2018-04-18 11:30:15,434: Parsing model.agency_data_pipeline.ga_mcf_proc
2018-04-18 11:30:15,436: Parsing model.agency_data_pipeline.ga_mcf_stats
2018-04-18 11:30:15,438: Parsing model.agency_data_pipeline.shopify_customers_proc
2018-04-18 11:30:15,445: Parsing model.agency_data_pipeline.shopify_orders_proc
2018-04-18 11:30:15,452: Parsing model.agency_data_pipeline.shopify_products_proc
2018-04-18 11:30:15,461: Parsing model.agency_data_pipeline.shopify_refunds_proc
2018-04-18 11:30:15,477: Parsing model.agency_data_pipeline.agg_campaign
2018-04-18 11:30:15,482: Parsing model.agency_data_pipeline.agg_customers_union
2018-04-18 11:30:15,484: Parsing model.agency_data_pipeline.agg_ga_campaign
2018-04-18 11:30:15,487: Parsing model.agency_data_pipeline.agg_ga_campaign_by_type
2018-04-18 11:30:15,490: Parsing model.agency_data_pipeline.agg_ga_transaction
2018-04-18 11:30:15,494: Parsing model.agency_data_pipeline.agg_ga_transaction_order_number
2018-04-18 11:30:15,497: Parsing model.agency_data_pipeline.agg_orders_union
2018-04-18 11:30:15,500: Parsing model.agency_data_pipeline.agg_platform_monthly
2018-04-18 11:30:15,502: Parsing model.agency_data_pipeline.agg_platforms_client
2018-04-18 11:30:15,504: Parsing model.agency_data_pipeline.agg_platforms_union
2018-04-18 11:30:15,507: Parsing model.agency_data_pipeline.agg_products
2018-04-18 11:30:15,508: Parsing model.agency_data_pipeline.agg_products_cogs
2018-04-18 11:30:15,512: Parsing model.agency_data_pipeline.agg_transaction
2018-04-18 11:30:15,516: Parsing model.agency_data_pipeline.agg_transaction_daily
2018-04-18 11:30:15,519: Parsing model.agency_data_pipeline.agg_transaction_line_item
2018-04-18 11:30:15,522: Parsing model.agency_data_pipeline.agg_transaction_line_item_type
2018-04-18 11:30:15,525: Parsing model.agency_data_pipeline.agg_transaction_order_number
2018-04-18 11:30:15,527: Parsing model.agency_data_pipeline.agg_transaction_product_type
2018-04-18 11:30:15,530: Parsing model.agency_data_pipeline.customers_by_transaction
2018-04-18 11:30:15,533: Parsing model.agency_data_pipeline.growth_customer_0_365
2018-04-18 11:30:15,537: Parsing model.agency_data_pipeline.growth_customer_0_365_segment
2018-04-18 11:30:15,542: Parsing model.agency_data_pipeline.growth_date_union
2018-04-18 11:30:15,545: Parsing model.agency_data_pipeline.growth_stats
2018-04-18 11:30:15,552: Parsing model.agency_data_pipeline.retention_0_365
2018-04-18 11:30:15,554: Parsing model.agency_data_pipeline.retention_0_365_new
2018-04-18 11:30:15,557: Parsing model.agency_data_pipeline.retention_0_365_reactivated
2018-04-18 11:30:15,559: Parsing model.agency_data_pipeline.retention_0_365_rebuy
2018-04-18 11:30:15,562: Parsing model.agency_data_pipeline.retention_365_730
2018-04-18 11:30:15,565: Parsing model.agency_data_pipeline.retention_730_plus
2018-04-18 11:30:15,568: Parsing model.agency_data_pipeline.retention_stats
2018-04-18 11:30:15,574: Parsing model.agency_data_pipeline.retention_stats_rebuy_rate
2018-04-18 11:30:15,577: Parsing model.agency_data_pipeline.retention_0_30
2018-04-18 11:30:15,579: Parsing model.agency_data_pipeline.retention_0_30_new
2018-04-18 11:30:15,582: Parsing model.agency_data_pipeline.retention_0_30_reactivated
2018-04-18 11:30:15,585: Parsing model.agency_data_pipeline.retention_0_30_rebuy
2018-04-18 11:30:15,587: Parsing model.agency_data_pipeline.retention_30_60
2018-04-18 11:30:15,589: Parsing model.agency_data_pipeline.retention_60_plus
2018-04-18 11:30:15,592: Parsing model.agency_data_pipeline.retention_stats_month
2018-04-18 11:30:15,598: Parsing model.agency_data_pipeline.retention_stats_rebuy_rate_month
2018-04-18 11:30:15,601: Parsing model.agency_data_pipeline.customers_first_purchase_proc
2018-04-18 11:30:15,603: Parsing model.agency_data_pipeline.customers_proc
2018-04-18 11:30:15,606: Parsing model.agency_data_pipeline.segment_list_customers
2018-04-18 11:30:15,608: Parsing model.agency_data_pipeline.segment_proc_customers
2018-04-18 11:30:15,611: Parsing model.agency_data_pipeline.segment_stats_customers
2018-04-18 11:30:15,615: Parsing model.agency_data_pipeline.segment_stats_customers_agg
2018-04-18 11:30:15,619: Parsing model.agency_data_pipeline.customers_first_purchase_product_type_proc
2018-04-18 11:30:15,621: Parsing model.agency_data_pipeline.customers_products_proc
2018-04-18 11:30:15,624: Parsing model.agency_data_pipeline.segment_list_customers_products
2018-04-18 11:30:15,628: Parsing model.agency_data_pipeline.segment_proc_customers_products
2018-04-18 11:30:15,630: Parsing model.agency_data_pipeline.segment_stats_customers_products
2018-04-18 11:30:15,633: Parsing model.agency_data_pipeline.segment_stats_customers_products_agg
2018-04-18 11:30:15,637: Parsing model.agency_data_pipeline.frequency_proc
2018-04-18 11:30:15,639: Parsing model.agency_data_pipeline.frequency_stats
2018-04-18 11:30:15,642: Parsing model.agency_data_pipeline.order_paths_agg
2018-04-18 11:30:15,643: Parsing model.agency_data_pipeline.order_paths_proc
2018-04-18 11:30:15,646: Parsing model.agency_data_pipeline.order_paths_stats
2018-04-18 11:30:15,649: Parsing model.agency_data_pipeline.products_proc
2018-04-18 11:30:15,652: Parsing model.agency_data_pipeline.segment_proc_sku
2018-04-18 11:30:15,655: Parsing model.agency_data_pipeline.segment_stats_category
2018-04-18 11:30:15,658: Parsing model.agency_data_pipeline.segment_stats_sku
2018-04-18 11:30:15,679: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b5b9a90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b516d30>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b5c14e0>]}
2018-04-18 11:30:15,946: Encountered an error:
2018-04-18 11:30:15,946: Compilation Error in model agg_orders_union (models/join/agg_orders_union.sql)
  Model 'model.agency_data_pipeline.agg_orders_union' depends on model 'aggs_products_cogs' which was not found.
2018-04-18 11:30:15,974: Traceback (most recent call last):
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/main.py", line 40, in main
    results, succeeded = handle_and_check(args)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/main.py", line 84, in handle_and_check
    task, res = run_from_args(parsed)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/main.py", line 138, in run_from_args
    results = run_from_task(task, proj, parsed)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/main.py", line 146, in run_from_task
    result = task.run()
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/task/run.py", line 26, in run
    results = runner.run(query, ModelRunner)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/runner.py", line 221, in run
    return self.run_from_graph(Selector, Runner, query)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/runner.py", line 183, in run_from_graph
    flat_graph, linker = self.compile(self.project)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/runner.py", line 179, in compile
    (flat_graph, linker) = compiler.compile()
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/compilation.py", line 281, in compile
    root_project.get('name'))
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/parser.py", line 97, in process_refs
    target_model_package)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/exceptions.py", line 160, in ref_target_not_found
    model)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/exceptions.py", line 115, in raise_compiler_error
    raise CompilationException(msg, node)
dbt.exceptions.CompilationException: Compilation Error in model agg_orders_union (models/join/agg_orders_union.sql)
  Model 'model.agency_data_pipeline.agg_orders_union' depends on model 'aggs_products_cogs' which was not found.

2018-04-18 11:33:15,679: Tracking: tracking
2018-04-18 11:33:15,685: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10be75588>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10be75828>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10be75ba8>]}
2018-04-18 11:33:16,463: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-04-18 11:33:16,483: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/growth-engines/dbt_modules
2018-04-18 11:33:16,489: Parsing get_column_values.sql
2018-04-18 11:33:16,506: Parsing get_url_parameter.sql
2018-04-18 11:33:16,513: Parsing split_part.sql
2018-04-18 11:33:16,522: Parsing table_exists.sql
2018-04-18 11:33:16,535: Parsing core.sql
2018-04-18 11:33:16,550: Parsing adapters/bigquery.sql
2018-04-18 11:33:16,558: Parsing adapters/common.sql
2018-04-18 11:33:16,576: Parsing adapters/postgres.sql
2018-04-18 11:33:16,581: Parsing adapters/redshift.sql
2018-04-18 11:33:16,607: Parsing etc/get_custom_schema.sql
2018-04-18 11:33:16,616: Parsing materializations/archive.sql
2018-04-18 11:33:16,656: Parsing materializations/bigquery.sql
2018-04-18 11:33:16,674: Parsing materializations/helpers.sql
2018-04-18 11:33:16,697: Parsing materializations/incremental.sql
2018-04-18 11:33:16,733: Parsing materializations/table.sql
2018-04-18 11:33:16,760: Parsing materializations/view.sql
2018-04-18 11:33:16,779: Parsing materializations/wrapper.sql
2018-04-18 11:33:16,787: Parsing schema_tests/accepted_values.sql
2018-04-18 11:33:16,792: Parsing schema_tests/not_null.sql
2018-04-18 11:33:16,797: Parsing schema_tests/relationships.sql
2018-04-18 11:33:16,803: Parsing schema_tests/unique.sql
2018-04-18 11:33:16,880: Parsing model.agency_data_pipeline.accounts_proc
2018-04-18 11:33:16,882: Parsing model.agency_data_pipeline.all_dates
2018-04-18 11:33:16,883: Parsing model.agency_data_pipeline.carts_proc
2018-04-18 11:33:16,887: Parsing model.agency_data_pipeline.clients_proc
2018-04-18 11:33:16,889: Parsing model.agency_data_pipeline.cogs_proc
2018-04-18 11:33:16,891: Parsing model.agency_data_pipeline.conversion_goals_proc
2018-04-18 11:33:16,893: Parsing model.agency_data_pipeline.mappings_ga_proc
2018-04-18 11:33:16,895: Acquiring new bigquery connection "master".
2018-04-18 11:33:16,896: Opening a new connection (0 currently allocated)
2018-04-18 11:33:16,899: Parsing model.agency_data_pipeline.monthend_dates
2018-04-18 11:33:16,902: Parsing model.agency_data_pipeline.adwords_ads
2018-04-18 11:33:16,905: Parsing model.agency_data_pipeline.adwords_campaigns
2018-04-18 11:33:16,907: Parsing model.agency_data_pipeline.adwords_conversions
2018-04-18 11:33:16,910: Parsing model.agency_data_pipeline.adwords_impression_share
2018-04-18 11:33:16,912: Parsing model.agency_data_pipeline.adwords_join
2018-04-18 11:33:16,915: Parsing model.agency_data_pipeline.adwords_stats
2018-04-18 11:33:16,916: Parsing model.agency_data_pipeline.adwords_urls
2018-04-18 11:33:16,920: Parsing model.agency_data_pipeline.bing_ads_ads
2018-04-18 11:33:16,925: Parsing model.agency_data_pipeline.bing_ads_conversions
2018-04-18 11:33:16,928: Parsing model.agency_data_pipeline.bing_ads_impression_share
2018-04-18 11:33:16,930: Parsing model.agency_data_pipeline.bing_ads_stats
2018-04-18 11:33:16,934: Parsing model.agency_data_pipeline.fb_adcreative
2018-04-18 11:33:16,942: Parsing model.agency_data_pipeline.fb_ads
2018-04-18 11:33:16,949: Parsing model.agency_data_pipeline.fb_ads_insights
2018-04-18 11:33:16,956: Parsing model.agency_data_pipeline.fb_ads_insights_conversions
2018-04-18 11:33:16,961: Parsing model.agency_data_pipeline.fb_ads_stats
2018-04-18 11:33:16,964: Parsing model.agency_data_pipeline.ga_conversions
2018-04-18 11:33:16,966: Parsing model.agency_data_pipeline.ga_traffic
2018-04-18 11:33:16,979: Parsing model.agency_data_pipeline.ga_transactions
2018-04-18 11:33:16,989: Parsing model.agency_data_pipeline.ga_mcf_proc
2018-04-18 11:33:16,991: Parsing model.agency_data_pipeline.ga_mcf_stats
2018-04-18 11:33:16,994: Parsing model.agency_data_pipeline.shopify_customers_proc
2018-04-18 11:33:17,002: Parsing model.agency_data_pipeline.shopify_orders_proc
2018-04-18 11:33:17,012: Parsing model.agency_data_pipeline.shopify_products_proc
2018-04-18 11:33:17,019: Parsing model.agency_data_pipeline.shopify_refunds_proc
2018-04-18 11:33:17,025: Parsing model.agency_data_pipeline.agg_campaign
2018-04-18 11:33:17,028: Parsing model.agency_data_pipeline.agg_customers_union
2018-04-18 11:33:17,030: Parsing model.agency_data_pipeline.agg_ga_campaign
2018-04-18 11:33:17,033: Parsing model.agency_data_pipeline.agg_ga_campaign_by_type
2018-04-18 11:33:17,038: Parsing model.agency_data_pipeline.agg_ga_transaction
2018-04-18 11:33:17,044: Parsing model.agency_data_pipeline.agg_ga_transaction_order_number
2018-04-18 11:33:17,049: Parsing model.agency_data_pipeline.agg_orders_union
2018-04-18 11:33:17,054: Parsing model.agency_data_pipeline.agg_platform_monthly
2018-04-18 11:33:17,056: Parsing model.agency_data_pipeline.agg_platforms_client
2018-04-18 11:33:17,058: Parsing model.agency_data_pipeline.agg_platforms_union
2018-04-18 11:33:17,061: Parsing model.agency_data_pipeline.agg_products
2018-04-18 11:33:17,063: Parsing model.agency_data_pipeline.agg_products_cogs
2018-04-18 11:33:17,067: Parsing model.agency_data_pipeline.agg_transaction
2018-04-18 11:33:17,071: Parsing model.agency_data_pipeline.agg_transaction_daily
2018-04-18 11:33:17,073: Parsing model.agency_data_pipeline.agg_transaction_line_item
2018-04-18 11:33:17,075: Parsing model.agency_data_pipeline.agg_transaction_line_item_type
2018-04-18 11:33:17,078: Parsing model.agency_data_pipeline.agg_transaction_order_number
2018-04-18 11:33:17,080: Parsing model.agency_data_pipeline.agg_transaction_product_type
2018-04-18 11:33:17,082: Parsing model.agency_data_pipeline.customers_by_transaction
2018-04-18 11:33:17,084: Parsing model.agency_data_pipeline.growth_customer_0_365
2018-04-18 11:33:17,088: Parsing model.agency_data_pipeline.growth_customer_0_365_segment
2018-04-18 11:33:17,090: Parsing model.agency_data_pipeline.growth_date_union
2018-04-18 11:33:17,094: Parsing model.agency_data_pipeline.growth_stats
2018-04-18 11:33:17,099: Parsing model.agency_data_pipeline.retention_0_365
2018-04-18 11:33:17,103: Parsing model.agency_data_pipeline.retention_0_365_new
2018-04-18 11:33:17,107: Parsing model.agency_data_pipeline.retention_0_365_reactivated
2018-04-18 11:33:17,110: Parsing model.agency_data_pipeline.retention_0_365_rebuy
2018-04-18 11:33:17,112: Parsing model.agency_data_pipeline.retention_365_730
2018-04-18 11:33:17,114: Parsing model.agency_data_pipeline.retention_730_plus
2018-04-18 11:33:17,116: Parsing model.agency_data_pipeline.retention_stats
2018-04-18 11:33:17,123: Parsing model.agency_data_pipeline.retention_stats_rebuy_rate
2018-04-18 11:33:17,126: Parsing model.agency_data_pipeline.retention_0_30
2018-04-18 11:33:17,130: Parsing model.agency_data_pipeline.retention_0_30_new
2018-04-18 11:33:17,134: Parsing model.agency_data_pipeline.retention_0_30_reactivated
2018-04-18 11:33:17,139: Parsing model.agency_data_pipeline.retention_0_30_rebuy
2018-04-18 11:33:17,143: Parsing model.agency_data_pipeline.retention_30_60
2018-04-18 11:33:17,147: Parsing model.agency_data_pipeline.retention_60_plus
2018-04-18 11:33:17,150: Parsing model.agency_data_pipeline.retention_stats_month
2018-04-18 11:33:17,157: Parsing model.agency_data_pipeline.retention_stats_rebuy_rate_month
2018-04-18 11:33:17,161: Parsing model.agency_data_pipeline.customers_first_purchase_proc
2018-04-18 11:33:17,163: Parsing model.agency_data_pipeline.customers_proc
2018-04-18 11:33:17,165: Parsing model.agency_data_pipeline.segment_list_customers
2018-04-18 11:33:17,168: Parsing model.agency_data_pipeline.segment_proc_customers
2018-04-18 11:33:17,171: Parsing model.agency_data_pipeline.segment_stats_customers
2018-04-18 11:33:17,175: Parsing model.agency_data_pipeline.segment_stats_customers_agg
2018-04-18 11:33:17,178: Parsing model.agency_data_pipeline.customers_first_purchase_product_type_proc
2018-04-18 11:33:17,180: Parsing model.agency_data_pipeline.customers_products_proc
2018-04-18 11:33:17,183: Parsing model.agency_data_pipeline.segment_list_customers_products
2018-04-18 11:33:17,186: Parsing model.agency_data_pipeline.segment_proc_customers_products
2018-04-18 11:33:17,189: Parsing model.agency_data_pipeline.segment_stats_customers_products
2018-04-18 11:33:17,190: Parsing model.agency_data_pipeline.segment_stats_customers_products_agg
2018-04-18 11:33:17,194: Parsing model.agency_data_pipeline.frequency_proc
2018-04-18 11:33:17,197: Parsing model.agency_data_pipeline.frequency_stats
2018-04-18 11:33:17,200: Parsing model.agency_data_pipeline.order_paths_agg
2018-04-18 11:33:17,203: Parsing model.agency_data_pipeline.order_paths_proc
2018-04-18 11:33:17,206: Parsing model.agency_data_pipeline.order_paths_stats
2018-04-18 11:33:17,208: Parsing model.agency_data_pipeline.products_proc
2018-04-18 11:33:17,212: Parsing model.agency_data_pipeline.segment_proc_sku
2018-04-18 11:33:17,215: Parsing model.agency_data_pipeline.segment_stats_category
2018-04-18 11:33:17,218: Parsing model.agency_data_pipeline.segment_stats_sku
2018-04-18 11:33:17,249: Found 93 models, 0 tests, 0 archives, 0 analyses, 46 macros, 0 operations
2018-04-18 11:33:17,323: 
2018-04-18 11:33:18,759: 11:33:18 | Concurrency: 4 threads (target='prod')
2018-04-18 11:33:18,759: 11:33:18 | 
2018-04-18 11:33:20,079: 11:33:20 | 1 of 93 START table model agency_data_pipeline.clients_proc.......... [RUN]
2018-04-18 11:33:20,079: Compiling model.agency_data_pipeline.clients_proc
2018-04-18 11:33:20,079: 11:33:20 | 2 of 93 START table model agency_data_pipeline.all_dates............. [RUN]
2018-04-18 11:33:20,079: 11:33:20 | 3 of 93 START table model agency_data_pipeline.cogs_proc............. [RUN]
2018-04-18 11:33:20,086: Writing injected SQL for node "model.agency_data_pipeline.clients_proc"
2018-04-18 11:33:20,086: Compiling model.agency_data_pipeline.all_dates
2018-04-18 11:33:20,087: Compiling model.agency_data_pipeline.cogs_proc
2018-04-18 11:33:20,079: 11:33:20 | 4 of 93 START table model agency_data_pipeline.monthend_dates........ [RUN]
2018-04-18 11:33:20,100: Compiling model.agency_data_pipeline.monthend_dates
2018-04-18 11:33:20,088: Acquiring new bigquery connection "clients_proc".
2018-04-18 11:33:20,126: Opening a new connection (1 currently allocated)
2018-04-18 11:33:20,122: Writing injected SQL for node "model.agency_data_pipeline.cogs_proc"
2018-04-18 11:33:20,124: Writing injected SQL for node "model.agency_data_pipeline.monthend_dates"
2018-04-18 11:33:20,094: Writing injected SQL for node "model.agency_data_pipeline.all_dates"
2018-04-18 11:33:20,212: Acquiring new bigquery connection "all_dates".
2018-04-18 11:33:20,213: Acquiring new bigquery connection "monthend_dates".
2018-04-18 11:33:20,213: Opening a new connection (2 currently allocated)
2018-04-18 11:33:20,214: Acquiring new bigquery connection "cogs_proc".
2018-04-18 11:33:20,217: Opening a new connection (3 currently allocated)
2018-04-18 11:33:20,338: Opening a new connection (4 currently allocated)
2018-04-18 11:33:21,727: Model SQL (all_dates):
SELECT 
date_in_range,
unix_date(date_in_range) unix_date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-04-18 11:33:21,763: Model SQL (cogs_proc):
select 
client,
sku,
cogs_dol,
cogs_pct
from  ( 

SELECT  
client,
sku,
cogs_dol,
cogs_pct,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.cogs`
where client != ''
) 

WHERE lv = time_of_entry
2018-04-18 11:33:21,795: Model SQL (clients_proc):
select 
client,
client_name,
account,
platform
from  ( 

SELECT  
client,
client_name,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.accounts`
where client_name != ''
) 

WHERE lv = time_of_entry
2018-04-18 11:33:21,813: Model SQL (monthend_dates):
SELECT
date_in_range,
date_in_range_bom,
date_in_range_bom_mom,
unix_date_in_range,
unix_date_in_range_bom,
unix_date(date_in_range_bom_mom) unix_date_in_range_bom_mom,
yyyymm,
date_in_range_yoy,
unix_date(date_in_range_yoy) unix_date_in_range_yoy

FROM
(
	SELECT 
	date_in_range,
	date_in_range_bom,
	date_sub(date_in_range_bom, INTERVAL 1 MONTH) date_in_range_bom_mom,
  date_sub(date_in_range, INTERVAL 1 YEAR) date_in_range_yoy,
	unix_date_in_range,
	unix_date(date_in_range_bom) unix_date_in_range_bom,
	yyyymm,
	first_value(date_in_range) over (partition by yyyymm order by date_in_range desc) monthend_date_in_range
	FROM
	( 
		SELECT 
		date_in_range,
		date_trunc( date_in_range, MONTH) date_in_range_bom,
		unix_date(date_in_range) unix_date_in_range,
		format_date("%Y-%m", date_in_range) AS yyyymm
		FROM UNNEST(
		    GENERATE_DATE_ARRAY(DATE('2016-01-31'), CURRENT_DATE(), INTERVAL 1 DAY)
		) AS date_in_range
	)
)
where date_in_range = monthend_date_in_range
2018-04-18 11:33:22,895: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '22194847-2847-42b7-8ba7-0d2bfaf0b4bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10bfebb38>]}
2018-04-18 11:33:23,157: 11:33:23 | 2 of 93 OK created table model agency_data_pipeline.all_dates........ [CREATE TABLE in 2.81s]
2018-04-18 11:33:23,158: 11:33:23 | 5 of 93 START table model agency_data_pipeline.bing_ads_ads.......... [RUN]
2018-04-18 11:33:23,158: Compiling model.agency_data_pipeline.bing_ads_ads
2018-04-18 11:33:23,164: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_ads"
2018-04-18 11:33:23,168: Acquiring new bigquery connection "bing_ads_ads".
2018-04-18 11:33:23,168: Re-using an available connection from the pool.
2018-04-18 11:33:24,035: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '22194847-2847-42b7-8ba7-0d2bfaf0b4bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c044828>]}
2018-04-18 11:33:24,143: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '22194847-2847-42b7-8ba7-0d2bfaf0b4bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c0444e0>]}
2018-04-18 11:33:24,343: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '22194847-2847-42b7-8ba7-0d2bfaf0b4bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108a8bb00>]}
2018-04-18 11:33:24,354: Model SQL (bing_ads_ads):
select
date, 
account, 
channel,
platform,
campaignid,
campaignname,
max(lower(trim(replace(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$','' ),'.html',''),'/'))) as url,
utm_campaign,
sum(cost) as cost,
sum(impressions) as impressions,
sum(clicks) as clicks,
sum(conversions) as conversions
from 
  ( 
SELECT  
cast(gregoriandate as date) date,
replace(accountname,',','') account,
'Paid' as channel,
'Bing Ads' as platform,
adid,
adtype,
campaignid, 
campaignname,
finalurl url,
case when regexp_contains(destinationurl, 'utm_campaign')
	then replace(lower(nullif(
  

    split(
        
  

    split(
        destinationurl,
        'utm_campaign='
        )[offset(1)]


,
        '&'
        )[offset(0)]


,'')),'+',' ') 
	else null end as utm_campaign,
spend cost, 
impressions, 
clicks, 
conversions,
_sdc_sequence,
first_value(_sdc_sequence) OVER (PARTITION BY adid, gregoriandate ORDER BY _sdc_sequence DESC) lv
FROM `growth-engines-pipeline.bing_ads.ad_performance_report` 
  )

where lv = _sdc_sequence
group by date, account, channel, platform, campaignid, campaignname, utm_campaign
2018-04-18 11:33:24,351: 11:33:24 | 1 of 93 OK created table model agency_data_pipeline.clients_proc..... [CREATE TABLE in 3.96s]
2018-04-18 11:33:24,357: 11:33:24 | 6 of 93 START table model agency_data_pipeline.bing_ads_impression_share [RUN]
2018-04-18 11:33:24,360: Compiling model.agency_data_pipeline.bing_ads_impression_share
2018-04-18 11:33:24,367: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_impression_share"
2018-04-18 11:33:24,370: Acquiring new bigquery connection "bing_ads_impression_share".
2018-04-18 11:33:24,370: Re-using an available connection from the pool.
2018-04-18 11:33:24,643: 11:33:24 | 4 of 93 OK created table model agency_data_pipeline.monthend_dates... [CREATE TABLE in 4.04s]
2018-04-18 11:33:24,644: 11:33:24 | 7 of 93 START table model agency_data_pipeline.carts_proc............ [RUN]
2018-04-18 11:33:24,644: Compiling model.agency_data_pipeline.carts_proc
2018-04-18 11:33:24,649: Writing injected SQL for node "model.agency_data_pipeline.carts_proc"
2018-04-18 11:33:24,654: Acquiring new bigquery connection "carts_proc".
2018-04-18 11:33:24,654: Re-using an available connection from the pool.
2018-04-18 11:33:24,919: 11:33:24 | 3 of 93 OK created table model agency_data_pipeline.cogs_proc........ [CREATE TABLE in 4.26s]
2018-04-18 11:33:24,919: 11:33:24 | 8 of 93 START table model agency_data_pipeline.conversion_goals_proc. [RUN]
2018-04-18 11:33:24,919: Compiling model.agency_data_pipeline.conversion_goals_proc
2018-04-18 11:33:24,925: Writing injected SQL for node "model.agency_data_pipeline.conversion_goals_proc"
2018-04-18 11:33:24,926: Acquiring new bigquery connection "conversion_goals_proc".
2018-04-18 11:33:24,926: Re-using an available connection from the pool.
2018-04-18 11:33:25,462: Model SQL (bing_ads_impression_share):
SELECT 
date, 
account,
channel,
platform,
sum(impressions) impressions,
sum(available_impressions) available_impressions
FROM

(

SELECT  
cast(gregoriandate as date) date,
replace(accountname,',','') account,  
'Paid' as channel,
'Bing Ads' as platform,
case when impressionsharepercent is null then 0 else impressions end as impressions,
cast(round(case when ( impressionsharepercent is not null and impressionsharepercent > 0 ) then (impressions*100)/impressionsharepercent else 0 end) as int64) as available_impressions,
_sdc_sequence,
first_value(_sdc_sequence) OVER (PARTITION BY campaignid, gregoriandate ORDER BY _sdc_sequence DESC) lv
FROM `growth-engines-pipeline.bing_ads.campaign_performance_report` 

)

where lv = _sdc_sequence
group by date, account, channel, platform
2018-04-18 11:33:25,577: Model SQL (carts_proc):
select 
client,
client_name,
account,
platform
from  ( 

SELECT  
client,
client_name,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.accounts`
WHERE platform in ('Shopify', 'Custom cart')

) 

WHERE lv = time_of_entry
2018-04-18 11:33:25,901: Model SQL (conversion_goals_proc):
select 
client,
platform,
goal_name,
max(goal_type) goal_type,
account,
max(time_of_entry) time_of_entry
from  ( 

SELECT  
client,
platform,
trim(replace(replace(lower(goal_name),',',''),' ','')) goal_name,
goal_type,
account,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY platform ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.conversion_goals` 

) 

WHERE lv = time_of_entry
group by client, platform, account, goal_name
2018-04-18 11:33:26,674: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '22194847-2847-42b7-8ba7-0d2bfaf0b4bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c0444e0>]}
2018-04-18 11:33:26,701: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '22194847-2847-42b7-8ba7-0d2bfaf0b4bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10bfebb38>]}
2018-04-18 11:33:27,040: 11:33:27 | 7 of 93 OK created table model agency_data_pipeline.carts_proc....... [CREATE TABLE in 2.03s]
2018-04-18 11:33:27,041: 11:33:27 | 9 of 93 START table model agency_data_pipeline.ga_conversions........ [RUN]
2018-04-18 11:33:27,042: Compiling model.agency_data_pipeline.ga_conversions
2018-04-18 11:33:27,052: Writing injected SQL for node "model.agency_data_pipeline.ga_conversions"
2018-04-18 11:33:27,057: Acquiring new bigquery connection "ga_conversions".
2018-04-18 11:33:27,059: Re-using an available connection from the pool.
2018-04-18 11:33:27,391: 11:33:27 | 5 of 93 OK created table model agency_data_pipeline.bing_ads_ads..... [CREATE TABLE in 3.54s]
2018-04-18 11:33:27,392: 11:33:27 | 10 of 93 START table model agency_data_pipeline.adwords_urls......... [RUN]
2018-04-18 11:33:27,392: Compiling model.agency_data_pipeline.adwords_urls
2018-04-18 11:33:27,398: Writing injected SQL for node "model.agency_data_pipeline.adwords_urls"
2018-04-18 11:33:27,403: Acquiring new bigquery connection "adwords_urls".
2018-04-18 11:33:27,404: Re-using an available connection from the pool.
2018-04-18 11:33:27,693: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '22194847-2847-42b7-8ba7-0d2bfaf0b4bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c044828>]}
2018-04-18 11:33:27,975: 11:33:27 | 6 of 93 OK created table model agency_data_pipeline.bing_ads_impression_share [CREATE TABLE in 3.33s]
2018-04-18 11:33:27,976: 11:33:27 | 11 of 93 START table model agency_data_pipeline.adwords_campaigns.... [RUN]
2018-04-18 11:33:27,977: Compiling model.agency_data_pipeline.adwords_campaigns
2018-04-18 11:33:27,991: Writing injected SQL for node "model.agency_data_pipeline.adwords_campaigns"
2018-04-18 11:33:27,996: Acquiring new bigquery connection "adwords_campaigns".
2018-04-18 11:33:27,997: Re-using an available connection from the pool.
2018-04-18 11:33:28,086: Model SQL (ga_conversions):
select 
client,
client_name,
platform,
goal_name,
goal_type,
account,
time_of_entry
from  ( 

SELECT  
client,
client_name,
platform,
trim(goal_name) goal_name,
goal_type,
account,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform, goal_name ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.conversion_goals` 
WHERE platform = 'Google Analytics'

) 

WHERE lv = time_of_entry
2018-04-18 11:33:28,324: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '22194847-2847-42b7-8ba7-0d2bfaf0b4bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c0216d8>]}
2018-04-18 11:33:28,364: Model SQL (adwords_urls):
SELECT
campaignid,
lower(trim(regexp_replace(replace(replace(replace(replace(finalurl,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url

FROM (

SELECT  
campaignid,
finalurl,
first_value(finalurl) OVER (PARTITION BY campaignid ORDER BY day DESC) lv
FROM `growth-engines-pipeline.adwords_2.FINAL_URL_REPORT`
)

WHERE lv = finalurl
group by campaignid, url
order by campaignid asc
2018-04-18 11:33:28,611: 11:33:28 | 8 of 93 OK created table model agency_data_pipeline.conversion_goals_proc [CREATE TABLE in 3.40s]
2018-04-18 11:33:28,612: 11:33:28 | 12 of 93 START table model agency_data_pipeline.accounts_proc........ [RUN]
2018-04-18 11:33:28,612: Compiling model.agency_data_pipeline.accounts_proc
2018-04-18 11:33:28,621: Writing injected SQL for node "model.agency_data_pipeline.accounts_proc"
2018-04-18 11:33:28,624: Acquiring new bigquery connection "accounts_proc".
2018-04-18 11:33:28,626: Re-using an available connection from the pool.
2018-04-18 11:33:29,114: Model SQL (adwords_campaigns):
select
day,
campaignid, 
campaign,
account, 
channel,
platform,
sum(cost) cost,
sum(impressions) impressions,
sum(clicks) clicks,
sum(impression_share_num) impression_share_num,
sum(impression_share_den) impression_share_den
from 
  ( 
	SELECT  
	day,
	campaignid,
	campaign,
	account as account,
	'Paid' as channel,
	'Adwords' as platform,
	cost/1000000 cost, 
	impressions as impressions, 
	clicks, 
	case when searchimprshare is not null then impressions end as impression_share_num,
	case when searchimprshare is not null then impressions/(searchimprshare/100) end as impression_share_den,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY campaignid, day ORDER BY _sdc_sequence DESC) lv
	FROM `growth-engines-pipeline.adwords_2.CAMPAIGN_PERFORMANCE_REPORT`
  )
where lv = _sdc_sequence
group by day, campaignid, account, channel, platform, campaign
2018-04-18 11:33:29,215: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '22194847-2847-42b7-8ba7-0d2bfaf0b4bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108b08240>]}
2018-04-18 11:33:29,513: 11:33:29 | 9 of 93 OK created table model agency_data_pipeline.ga_conversions... [CREATE TABLE in 2.17s]
2018-04-18 11:33:29,513: 11:33:29 | 13 of 93 START table model agency_data_pipeline.adwords_conversions.. [RUN]
2018-04-18 11:33:29,513: Compiling model.agency_data_pipeline.adwords_conversions
2018-04-18 11:33:29,522: Writing injected SQL for node "model.agency_data_pipeline.adwords_conversions"
2018-04-18 11:33:29,524: Acquiring new bigquery connection "adwords_conversions".
2018-04-18 11:33:29,524: Re-using an available connection from the pool.
2018-04-18 11:33:29,646: Model SQL (accounts_proc):
select 
client,
account,
platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.accounts` 

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-04-18 11:33:30,746: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '22194847-2847-42b7-8ba7-0d2bfaf0b4bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10bfebb38>]}
2018-04-18 11:33:30,892: Model SQL (adwords_conversions):
select 
client,
client_name,
platform,
goal_name,
goal_type,
account,
time_of_entry
from  ( 

SELECT  
client,
client_name,
platform,
trim(lower(goal_name)) goal_name,
goal_type,
account,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform, goal_name ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.conversion_goals` 
WHERE platform = 'Adwords'

) 

WHERE lv = time_of_entry
2018-04-18 11:33:31,080: 11:33:31 | 10 of 93 OK created table model agency_data_pipeline.adwords_urls.... [CREATE TABLE in 3.35s]
2018-04-18 11:33:32,000: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '22194847-2847-42b7-8ba7-0d2bfaf0b4bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108b08240>]}
2018-04-18 11:33:32,030: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '22194847-2847-42b7-8ba7-0d2bfaf0b4bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c040eb8>]}
2018-04-18 11:33:32,382: 11:33:32 | 13 of 93 OK created table model agency_data_pipeline.adwords_conversions [CREATE TABLE in 2.49s]
2018-04-18 11:33:32,713: 11:33:32 | 12 of 93 OK created table model agency_data_pipeline.accounts_proc... [CREATE TABLE in 3.42s]
2018-04-18 11:33:34,768: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '22194847-2847-42b7-8ba7-0d2bfaf0b4bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108abbd30>]}
2018-04-18 11:33:35,128: 11:33:35 | 11 of 93 OK created table model agency_data_pipeline.adwords_campaigns [CREATE TABLE in 6.79s]
2018-04-18 11:33:35,129: 11:33:35 | 14 of 93 START table model agency_data_pipeline.bing_ads_conversions. [RUN]
2018-04-18 11:33:35,129: 11:33:35 | 15 of 93 START table model agency_data_pipeline.mappings_ga_proc..... [RUN]
2018-04-18 11:33:35,130: Compiling model.agency_data_pipeline.bing_ads_conversions
2018-04-18 11:33:35,130: 11:33:35 | 16 of 93 START table model agency_data_pipeline.fb_adcreative........ [RUN]
2018-04-18 11:33:35,136: Compiling model.agency_data_pipeline.fb_adcreative
2018-04-18 11:33:35,130: Compiling model.agency_data_pipeline.mappings_ga_proc
2018-04-18 11:33:35,130: 11:33:35 | 17 of 93 START table model agency_data_pipeline.adwords_ads.......... [RUN]
2018-04-18 11:33:35,152: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_conversions"
2018-04-18 11:33:35,159: Acquiring new bigquery connection "fb_adcreative".
2018-04-18 11:33:35,164: Re-using an available connection from the pool.
2018-04-18 11:33:35,164: Fetching data for query fb_adcreative:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 11:33:35,163: Writing injected SQL for node "model.agency_data_pipeline.mappings_ga_proc"
2018-04-18 11:33:35,163: Compiling model.agency_data_pipeline.adwords_ads
2018-04-18 11:33:35,175: Acquiring new bigquery connection "mappings_ga_proc".
2018-04-18 11:33:35,188: Writing injected SQL for node "model.agency_data_pipeline.adwords_ads"
2018-04-18 11:33:35,188: Re-using an available connection from the pool.
2018-04-18 11:33:35,190: Acquiring new bigquery connection "bing_ads_conversions".
2018-04-18 11:33:35,192: Acquiring new bigquery connection "adwords_ads".
2018-04-18 11:33:35,192: Re-using an available connection from the pool.
2018-04-18 11:33:35,198: Re-using an available connection from the pool.
2018-04-18 11:33:36,254: Model SQL (mappings_ga_proc):
select 
client,
account,
client_name,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
account,
client_name,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.mappings_ga` 

) 

WHERE lv = time_of_entry
and client in (select client from `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc` )
group by client, account, client_name, source, medium, platform_n, channel_n, time_of_entry
2018-04-18 11:33:36,273: Model SQL (adwords_ads):
SELECT  
day,
campaignid,
a.account as account,
utm_campaign,
sum( case when b.goal_type = 'Transaction' then conversions else 0 end ) as transactions
FROM (

	SELECT  
	day,
	adid,
	campaignid,
	account,
	lower(conversionname) conversionname,
	conversions,
	lower(campaign) utm_campaign,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY campaignid, day ORDER BY _sdc_sequence DESC) lv
	FROM
	`growth-engines-pipeline.adwords_2.AD_PERFORMANCE_REPORT`

) a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_conversions` b
ON ( a.conversionname = b.goal_name
	AND a.account = b.account )
WHERE lv = _sdc_sequence
group by day, campaignid, account, utm_campaign
2018-04-18 11:33:36,414: Model SQL (bing_ads_conversions):
SELECT
date, 
a.account account, 
a.channel channel,
a.platform platform,
campaignid,
campaignname,
sum( case when b.goal_type = 'Transactions' then conversions else 0 end ) as transactions
FROM

  ( 
SELECT  
cast(gregoriandate as date) date,
replace(accountname,',','') account,
'Paid' as channel,
'Bing Ads' as platform,
trim(replace(replace(lower(goal),',',''),' ','')) goal,
goalid,
campaignid,
campaignname,
conversions,
_sdc_sequence,
first_value(_sdc_sequence) OVER (PARTITION BY campaignid, goalid, gregoriandate ORDER BY _sdc_sequence DESC) lv
FROM `growth-engines-pipeline.bing_ads.goals_and_funnels_report` 

  ) a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`conversion_goals_proc` b
ON (
	a.account = b.account AND
	a.platform = b.platform AND
	a.goal = b.goal_name
)
where a.lv = a._sdc_sequence
group by date, account, channel, platform, campaignid, campaignname
2018-04-18 11:33:36,552: Writing injected SQL for node "model.agency_data_pipeline.fb_adcreative"
2018-04-18 11:33:37,505: Model SQL (fb_adcreative):




with fb_adcreative as (


	    
		   	SELECT 
			id,
			object_url,
			url_tags,
			_sdc_sequence
			FROM `growth-engines-pipeline.fb_ads_luca_danni.adcreative`
		    
	   
)

select creative_id, max(url) url
from (
  select
  id creative_id,
  lower(trim(regexp_replace(replace(replace(replace(replace(object_url,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
  first_value(_sdc_sequence) OVER (PARTITION BY id ORDER BY _sdc_sequence DESC) lv,
  _sdc_sequence
  from fb_adcreative
  )
where lv = _sdc_sequence
group by creative_id


2018-04-18 11:33:38,559: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '22194847-2847-42b7-8ba7-0d2bfaf0b4bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10bf4f2b0>]}
2018-04-18 11:33:38,702: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '22194847-2847-42b7-8ba7-0d2bfaf0b4bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10bf66278>]}
2018-04-18 11:33:38,785: 11:33:38 | 15 of 93 OK created table model agency_data_pipeline.mappings_ga_proc [CREATE TABLE in 3.43s]
2018-04-18 11:33:38,786: 11:33:38 | 18 of 93 START table model agency_data_pipeline.shopify_refunds_proc. [RUN]
2018-04-18 11:33:38,786: Compiling model.agency_data_pipeline.shopify_refunds_proc
2018-04-18 11:33:38,793: Acquiring new bigquery connection "shopify_refunds_proc".
2018-04-18 11:33:38,793: Re-using an available connection from the pool.
2018-04-18 11:33:38,794: Fetching data for query shopify_refunds_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 11:33:39,062: 11:33:39 | 14 of 93 OK created table model agency_data_pipeline.bing_ads_conversions [CREATE TABLE in 3.57s]
2018-04-18 11:33:39,062: 11:33:39 | 19 of 93 START table model agency_data_pipeline.fb_ads_insights_conversions [RUN]
2018-04-18 11:33:39,062: Compiling model.agency_data_pipeline.fb_ads_insights_conversions
2018-04-18 11:33:39,068: Acquiring new bigquery connection "fb_ads_insights_conversions".
2018-04-18 11:33:39,068: Re-using an available connection from the pool.
2018-04-18 11:33:39,068: Fetching data for query fb_ads_insights_conversions:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 11:33:39,496: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_insights_conversions"
2018-04-18 11:33:39,759: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '22194847-2847-42b7-8ba7-0d2bfaf0b4bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c040eb8>]}
2018-04-18 11:33:40,021: Writing injected SQL for node "model.agency_data_pipeline.shopify_refunds_proc"
2018-04-18 11:33:40,306: 11:33:40 | 16 of 93 OK created table model agency_data_pipeline.fb_adcreative... [CREATE TABLE in 4.62s]
2018-04-18 11:33:40,306: 11:33:40 | 20 of 93 START table model agency_data_pipeline.ga_mcf_proc.......... [RUN]
2018-04-18 11:33:40,306: Compiling model.agency_data_pipeline.ga_mcf_proc
2018-04-18 11:33:40,311: Writing injected SQL for node "model.agency_data_pipeline.ga_mcf_proc"
2018-04-18 11:33:40,313: Acquiring new bigquery connection "ga_mcf_proc".
2018-04-18 11:33:40,313: Re-using an available connection from the pool.
2018-04-18 11:33:40,463: Model SQL (fb_ads_insights_conversions):




with fb_ads_insights_conversions as (

	    
		   	SELECT 
			date_start,
			campaign_id,
			campaign_name,
			ad_id,
			account_name,
			spend,
			reach,
			inline_link_clicks,
			_sdc_sequence,
			action_type,
			value
			FROM `growth-engines-pipeline.fb_ads_luca_danni.ads_insights`
			cross join unnest(actions)
		    
	   

)

SELECT * 
FROM 
	(
    SELECT
    date_start date,
    campaign_id,
    campaign_name campaign,
    ad_id,
    account_name account,
    action_type,
    value conversions,
    first_value(_sdc_sequence) OVER (PARTITION BY ad_id, date_start ORDER BY _sdc_sequence DESC) lv,
    _sdc_sequence
    FROM fb_ads_insights_conversions
   	)
where lv = _sdc_sequence
and action_type like '%purchase%'


2018-04-18 11:33:41,008: Model SQL (shopify_refunds_proc):




with refunds as (

	
	SELECT
	order_number,
	checkout_id,
	financial_status,
	line_item_id,
	quantity,
	subtotal,
	line_item.variant_id variant_id,
	line_item.id refund_id,
 	_sdc_sequence
	FROM `growth-engines-pipeline.shopify_lucadanni.orders` 
	cross join unnest(refunds), unnest(refund_line_items)
  	where financial_status like '%refund%'
	
	

)

SELECT * 
FROM 
	(
    SELECT
	order_number,
	checkout_id,
	financial_status,
	line_item_id,
	quantity,
	subtotal refund_amount,
	variant_id,
	refund_id,
 	_sdc_sequence,
    first_value(_sdc_sequence) OVER (PARTITION BY order_number, line_item_id ORDER BY _sdc_sequence DESC) lv
    FROM refunds
   	) 
WHERE lv = _sdc_sequence


2018-04-18 11:33:41,385: Model SQL (ga_mcf_proc):
SELECT 
date,
account,
'Google Analytics' as lookup_platform,
source_medium_path,
trim(lower(split(split(source_medium_path,'->')[SAFE_ORDINAL(1)],'/')[SAFE_ORDINAL(1)])) as source,
trim(lower(split(split(source_medium_path,'->')[SAFE_ORDINAL(1)],'/')[SAFE_ORDINAL(2)])) as medium,
first_interaction_campaign campaign,
cast(regexp_replace(transaction_id, r'#', '') as int64) transactionid,
max(first_interaction_conversions) transactions,
max(first_interaction_conversion_value) revenue
FROM `growth-engines-pipeline.agency_data_pipeline.ga_mcf`
where account in (select account from `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc` where platform = 'Google Analytics')
group by date, account, source, medium, campaign, source_medium_path, lookup_platform, transactionid
2018-04-18 11:33:42,161: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '22194847-2847-42b7-8ba7-0d2bfaf0b4bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c02b4e0>]}
2018-04-18 11:33:42,399: 11:33:42 | 17 of 93 OK created table model agency_data_pipeline.adwords_ads..... [CREATE TABLE in 7.00s]
2018-04-18 11:33:42,399: 11:33:42 | 21 of 93 START table model agency_data_pipeline.fb_ads_insights...... [RUN]
2018-04-18 11:33:42,399: Compiling model.agency_data_pipeline.fb_ads_insights
2018-04-18 11:33:42,406: Acquiring new bigquery connection "fb_ads_insights".
2018-04-18 11:33:42,406: Re-using an available connection from the pool.
2018-04-18 11:33:42,406: Fetching data for query fb_ads_insights:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 11:33:42,811: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_insights"
2018-04-18 11:33:43,386: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '22194847-2847-42b7-8ba7-0d2bfaf0b4bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10bf4f2b0>]}
2018-04-18 11:33:43,635: 11:33:43 | 18 of 93 OK created table model agency_data_pipeline.shopify_refunds_proc [CREATE TABLE in 4.60s]
2018-04-18 11:33:43,938: Model SQL (fb_ads_insights):




with fb_ads_insights as (

	    
		   	SELECT 
			date_start,
			campaign_id,
			campaign_name,
			ad_id,
			account_name,
			spend,
			reach,
			inline_link_clicks,
			_sdc_sequence,
			first_value(_sdc_sequence) OVER (PARTITION BY date_start, ad_id, campaign_id ORDER BY _sdc_sequence DESC) lv
			FROM `growth-engines-pipeline.fb_ads_luca_danni.ads_insights`
		    
	   

)

select
date_start date,
campaign_id,
campaign_name campaign,
ad_id,
account_name account,
max(spend) cost,
max(reach) impressions,
max(inline_link_clicks) clicks
from fb_ads_insights
where lv = _sdc_sequence
group by date, campaign_id, ad_id, account, campaign


2018-04-18 11:33:45,023: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '22194847-2847-42b7-8ba7-0d2bfaf0b4bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10bf66278>]}
2018-04-18 11:33:45,330: 11:33:45 | 19 of 93 OK created table model agency_data_pipeline.fb_ads_insights_conversions [CREATE TABLE in 5.96s]
2018-04-18 11:33:45,858: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '22194847-2847-42b7-8ba7-0d2bfaf0b4bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c040eb8>]}
2018-04-18 11:33:46,111: 11:33:46 | 20 of 93 OK created table model agency_data_pipeline.ga_mcf_proc..... [CREATE TABLE in 5.55s]
2018-04-18 11:33:46,180: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '22194847-2847-42b7-8ba7-0d2bfaf0b4bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c02b4e0>]}
2018-04-18 11:33:46,530: 11:33:46 | 21 of 93 OK created table model agency_data_pipeline.fb_ads_insights. [CREATE TABLE in 3.78s]
2018-04-18 11:33:46,531: 11:33:46 | 22 of 93 START table model agency_data_pipeline.fb_ads............... [RUN]
2018-04-18 11:33:46,531: 11:33:46 | 23 of 93 START table model agency_data_pipeline.shopify_customers_proc [RUN]
2018-04-18 11:33:46,531: Compiling model.agency_data_pipeline.fb_ads
2018-04-18 11:33:46,532: Compiling model.agency_data_pipeline.shopify_customers_proc
2018-04-18 11:33:46,546: Acquiring new bigquery connection "fb_ads".
2018-04-18 11:33:46,546: Re-using an available connection from the pool.
2018-04-18 11:33:46,546: Fetching data for query fb_ads:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 11:33:46,552: Acquiring new bigquery connection "shopify_customers_proc".
2018-04-18 11:33:46,552: Re-using an available connection from the pool.
2018-04-18 11:33:46,552: Fetching data for query shopify_customers_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 11:33:46,990: Writing injected SQL for node "model.agency_data_pipeline.fb_ads"
2018-04-18 11:33:47,026: Writing injected SQL for node "model.agency_data_pipeline.shopify_customers_proc"
2018-04-18 11:33:48,101: Model SQL (fb_ads):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`fb_adcreative`





with fb_ads as (

	    
		   	SELECT 
			id ad_id,
			creative.creative_id creative_id,
			_sdc_sequence
			FROM `growth-engines-pipeline.fb_ads_luca_danni.ads`
		     
	   

)

SELECT
a.ad_id,
b.creative_id,
b.url
FROM (
    SELECT
    ad_id,
    creative_id,
    first_value(_sdc_sequence) OVER (PARTITION BY ad_id ORDER BY _sdc_sequence DESC) lv,
    _sdc_sequence
    FROM fb_ads
    ) a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`fb_adcreative` b
ON (
	a.creative_id = b.creative_id 
)
WHERE a.lv = a._sdc_sequence


2018-04-18 11:33:48,175: Model SQL (shopify_customers_proc):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc`





with customers as (

	
	SELECT
	'lucadanni' client_name,
	'Shopify' as lookup_platform,
	cast(created_at as date) created_at,
	id,
	first_name,
	last_name,
	email,
	_sdc_sequence,
	first_value(_sdc_sequence) over (partition by id, _sdc_sequence order by _sdc_sequence desc) lv
	FROM `growth-engines-pipeline.shopify_lucadanni.customers` 
	
	

)

SELECT
account,
client,
platform,
id,
min(created_at) created_at,
max(first_name) first_name,
max(last_name) last_name,
max(email) email
FROM (
	SELECT
	b.account,
	b.client,
	b.platform,
	created_at,
	id,
	first_name,
	last_name,
	email
	FROM customers a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
	ON ( a.client_name = b.client_name
	  AND a.lookup_platform = b.platform )
	where a.lv = a._sdc_sequence
)
group by account, client, platform, id

2018-04-18 11:33:50,809: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '22194847-2847-42b7-8ba7-0d2bfaf0b4bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c021358>]}
2018-04-18 11:33:51,048: 11:33:51 | 22 of 93 OK created table model agency_data_pipeline.fb_ads.......... [CREATE TABLE in 4.28s]
2018-04-18 11:33:53,070: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '22194847-2847-42b7-8ba7-0d2bfaf0b4bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10bf4f2b0>]}
2018-04-18 11:33:53,336: 11:33:53 | 23 of 93 OK created table model agency_data_pipeline.shopify_customers_proc [CREATE TABLE in 6.54s]
2018-04-18 11:33:53,337: 11:33:53 | 24 of 93 START table model agency_data_pipeline.ga_mcf_stats......... [RUN]
2018-04-18 11:33:53,337: Compiling model.agency_data_pipeline.ga_mcf_stats
2018-04-18 11:33:53,337: 11:33:53 | 25 of 93 START table model agency_data_pipeline.bing_ads_stats....... [RUN]
2018-04-18 11:33:53,345: Compiling model.agency_data_pipeline.bing_ads_stats
2018-04-18 11:33:53,351: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_stats"
2018-04-18 11:33:53,337: 11:33:53 | 26 of 93 START table model agency_data_pipeline.agg_customers_union.. [RUN]
2018-04-18 11:33:53,354: Writing injected SQL for node "model.agency_data_pipeline.ga_mcf_stats"
2018-04-18 11:33:53,354: Compiling model.agency_data_pipeline.agg_customers_union
2018-04-18 11:33:53,337: 11:33:53 | 27 of 93 START table model agency_data_pipeline.shopify_products_proc [RUN]
2018-04-18 11:33:53,367: Writing injected SQL for node "model.agency_data_pipeline.agg_customers_union"
2018-04-18 11:33:53,368: Acquiring new bigquery connection "ga_mcf_stats".
2018-04-18 11:33:53,369: Acquiring new bigquery connection "bing_ads_stats".
2018-04-18 11:33:53,370: Compiling model.agency_data_pipeline.shopify_products_proc
2018-04-18 11:33:53,370: Re-using an available connection from the pool.
2018-04-18 11:33:53,373: Acquiring new bigquery connection "agg_customers_union".
2018-04-18 11:33:53,400: Re-using an available connection from the pool.
2018-04-18 11:33:53,399: Acquiring new bigquery connection "shopify_products_proc".
2018-04-18 11:33:53,425: Re-using an available connection from the pool.
2018-04-18 11:33:53,431: Re-using an available connection from the pool.
2018-04-18 11:33:53,431: Fetching data for query shopify_products_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 11:33:53,895: Writing injected SQL for node "model.agency_data_pipeline.shopify_products_proc"
2018-04-18 11:33:54,454: Model SQL (agg_customers_union):
SELECT *
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`shopify_customers_proc`
2018-04-18 11:33:54,570: Model SQL (ga_mcf_stats):
SELECT  
date,
a.account account,
b.client client,
case when c.platform is null then "Unmapped" else c.platform end as platform,
case when c.channel is null then "Unmapped" else c.channel end as channel,
lower(a.source) source,
lower(a.medium) medium,
lower(campaign) campaign,
transactionid,
sum(transactions) first_touch_transactions,
sum(revenue) first_touch_revenue
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`ga_mcf_proc` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc` b 
ON ( a.account = b.account and
	a.lookup_platform = b.platform )
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc` c
ON ( lower(a.source) = c.source
  AND lower(a.medium) = c.medium 
  and a.account = c.account )
group by date, account, client, source, medium, campaign, platform, channel, transactionid
2018-04-18 11:33:54,744: Model SQL (bing_ads_stats):
select
a.date, 
a.account, 
a.channel,
a.platform,
url,
a.campaignname campaign,
utm_campaign,
cost,
clicks,
impressions,
transactions
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`bing_ads_ads` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`bing_ads_conversions` b
ON (
	a.date = b.date AND
	a.account = b.account AND
	a.campaignid = b.campaignid

)
2018-04-18 11:33:55,076: Model SQL (shopify_products_proc):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc`, `growth-engines-pipeline`.`agency_data_pipeline`.`shopify_refunds_proc`





with products as (

	
	SELECT
	'lucadanni' client_name,
	'Shopify' as lookup_platform,
	product_type,
	product_id,
	sku,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY product_id ORDER BY _sdc_sequence DESC) lv
	FROM `growth-engines-pipeline.shopify_lucadanni.products` 
	cross join unnest(variants)
	
	

)

SELECT
b.account,
b.client,
b.platform,
max(product_type) product_type,
product_id,
sku
FROM products a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
ON ( a.client_name = b.client_name
  AND a.lookup_platform = b.platform )
where a.lv = a._sdc_sequence
group by product_id, account, client, platform, sku


2018-04-18 11:33:56,976: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '22194847-2847-42b7-8ba7-0d2bfaf0b4bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c06e2b0>]}
2018-04-18 11:33:57,265: 11:33:57 | 25 of 93 OK created table model agency_data_pipeline.bing_ads_stats.. [CREATE TABLE in 3.63s]
2018-04-18 11:33:57,266: 11:33:57 | 28 of 93 START table model agency_data_pipeline.shopify_orders_proc.. [RUN]
2018-04-18 11:33:57,266: Compiling model.agency_data_pipeline.shopify_orders_proc
2018-04-18 11:33:57,280: Acquiring new bigquery connection "shopify_orders_proc".
2018-04-18 11:33:57,280: Re-using an available connection from the pool.
2018-04-18 11:33:57,281: Fetching data for query shopify_orders_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 11:33:57,333: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '22194847-2847-42b7-8ba7-0d2bfaf0b4bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c0447b8>]}
2018-04-18 11:33:57,654: Writing injected SQL for node "model.agency_data_pipeline.shopify_orders_proc"
2018-04-18 11:33:57,954: 11:33:57 | 27 of 93 OK created table model agency_data_pipeline.shopify_products_proc [CREATE TABLE in 3.96s]
2018-04-18 11:33:58,794: Model SQL (shopify_orders_proc):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc`, `growth-engines-pipeline`.`agency_data_pipeline`.`shopify_refunds_proc`





with orders as (

	
	SELECT
	'lucadanni' client_name,
	'Shopify' as lookup_platform,
	created_at,
	order_number,
	quantity,
	cast(pre_tax_price as float64) price, 
	total_line_items_price total_order_price_undiscounted,
	total_discounts,
	cast(discounted_price as float64) total_order_shipping_price,
	total_price_usd total_order_price_incl_shipping,
	checkout_id,
	product_id, 
	landing_site,
	sku, 
	variant_title, 
	variant_id,
	_id line_item_id,
	customer.id customer_id,
	customer.orders_count orders_count,
	customer.created_at customer_created_at,
	customer.last_order_id last_order_id,
	financial_status,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY order_number, _id ORDER BY _sdc_sequence DESC) lv
	FROM `growth-engines-pipeline.shopify_lucadanni.orders` 
	cross join unnest(line_items), unnest(shipping_lines)
	where source_name != 'shopify_draft_order'
	
	

)

SELECT
b.account,
b.client,
b.platform,
created_at,
a.order_number,
a.quantity,
c.quantity refund_quantity,
case when c.quantity is not null then a.quantity - c.quantity else a.quantity end as final_quantity,
price, 
total_order_price_undiscounted,
total_discounts,
total_order_shipping_price,
total_order_price_incl_shipping,
refund_amount,
case when refund_amount is not null then price - refund_amount else price end as final_price,
a.checkout_id,
a.product_id, 
landing_site,
sku, 
variant_title, 
a.variant_id,
a.line_item_id,	
customer_id,
orders_count,
customer_created_at,
last_order_id,
a.financial_status
FROM orders a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
ON ( a.client_name = b.client_name
  AND a.lookup_platform = b.platform )
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`shopify_refunds_proc` c
ON ( a.order_number = c.order_number
	AND a.line_item_id = c.line_item_id )   	
where a.lv = a._sdc_sequence


2018-04-18 11:33:58,964: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '22194847-2847-42b7-8ba7-0d2bfaf0b4bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c02bcc0>]}
2018-04-18 11:33:59,241: 11:33:59 | 26 of 93 OK created table model agency_data_pipeline.agg_customers_union [CREATE TABLE in 5.61s]
2018-04-18 11:34:00,226: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '22194847-2847-42b7-8ba7-0d2bfaf0b4bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c02b4e0>]}
2018-04-18 11:34:00,461: 11:34:00 | 24 of 93 OK created table model agency_data_pipeline.ga_mcf_stats.... [CREATE TABLE in 6.89s]
2018-04-18 11:34:07,848: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '22194847-2847-42b7-8ba7-0d2bfaf0b4bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c06e2b0>]}
2018-04-18 11:34:08,549: 11:34:08 | 28 of 93 OK created table model agency_data_pipeline.shopify_orders_proc [CREATE TABLE in 10.58s]
2018-04-18 11:34:08,550: 11:34:08 | 29 of 93 START table model agency_data_pipeline.adwords_join......... [RUN]
2018-04-18 11:34:08,550: 11:34:08 | 30 of 93 START table model agency_data_pipeline.ga_transactions...... [RUN]
2018-04-18 11:34:08,551: Compiling model.agency_data_pipeline.adwords_join
2018-04-18 11:34:08,551: 11:34:08 | 31 of 93 START table model agency_data_pipeline.agg_products......... [RUN]
2018-04-18 11:34:08,551: Compiling model.agency_data_pipeline.ga_transactions
2018-04-18 11:34:08,551: 11:34:08 | 32 of 93 START table model agency_data_pipeline.ga_traffic........... [RUN]
2018-04-18 11:34:08,562: Compiling model.agency_data_pipeline.agg_products
2018-04-18 11:34:08,563: Writing injected SQL for node "model.agency_data_pipeline.adwords_join"
2018-04-18 11:34:08,575: Compiling model.agency_data_pipeline.ga_traffic
2018-04-18 11:34:08,584: Acquiring new bigquery connection "ga_transactions".
2018-04-18 11:34:08,594: Writing injected SQL for node "model.agency_data_pipeline.agg_products"
2018-04-18 11:34:08,613: Re-using an available connection from the pool.
2018-04-18 11:34:08,614: Fetching data for query ga_transactions:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Google Analytics'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 11:34:08,615: Acquiring new bigquery connection "adwords_join".
2018-04-18 11:34:08,618: Re-using an available connection from the pool.
2018-04-18 11:34:08,636: Acquiring new bigquery connection "ga_traffic".
2018-04-18 11:34:08,638: Acquiring new bigquery connection "agg_products".
2018-04-18 11:34:08,638: Re-using an available connection from the pool.
2018-04-18 11:34:08,644: Fetching data for query ga_traffic:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'GA Traffic'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 11:34:08,645: Re-using an available connection from the pool.
2018-04-18 11:34:09,784: Model SQL (adwords_join):
select
a.day,
a.campaignid, 
a.campaign,
a.account, 
channel,
platform,
url,
utm_campaign,
cost,
impressions,
clicks,
impression_share_num,
impression_share_den,
transactions
FROM ( 
	
	select
	day,
	a.campaign,
	a.campaignid, 
	account, 
	channel,
	platform,
	url,
	cost,
	impressions,
	clicks,
	impression_share_num,
	impression_share_den
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_campaigns` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_urls` b
	ON a.campaignid = b.campaignid

) a 
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_ads` b
ON ( a.campaignid = b.campaignid
	and a.day = b.day )
2018-04-18 11:34:09,787: Model SQL (agg_products):
SELECT 
account,
client,
platform,
product_type,
product_id,
sku
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`shopify_products_proc`
2018-04-18 11:34:09,987: Fetching data for query ga_transactions:


        select
            goal_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_conversions`

        
        ##where 1 = 1
        where goal_type = 'Conversion'
        
        
        
        ##and 2 = 2
        and client_name = 'lucadanni'
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 11:34:10,060: Fetching data for query ga_traffic:


        select
            goal_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_conversions`

        
        ##where 1 = 1
        where goal_type = 'Conversion'
        
        
        
        ##and 2 = 2
        and client_name = 'lucadanni'
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 11:34:10,888: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '22194847-2847-42b7-8ba7-0d2bfaf0b4bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108a8b940>]}
2018-04-18 11:34:11,138: 11:34:11 | 31 of 93 OK created table model agency_data_pipeline.agg_products.... [CREATE TABLE in 2.33s]
2018-04-18 11:34:11,171: Writing injected SQL for node "model.agency_data_pipeline.ga_transactions"
2018-04-18 11:34:11,664: Writing injected SQL for node "model.agency_data_pipeline.ga_traffic"
2018-04-18 11:34:12,156: Model SQL (ga_transactions):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc`, `growth-engines-pipeline`.`agency_data_pipeline`.`ga_conversions`


##`growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` 



with ga_report as (

	    

	    	
	    	
		   	SELECT
		   	'lucadanni' as client_name,
		   	'Google Analytics' as lookup_platform,
			lower(trim(regexp_replace(replace(replace(replace(replace(CONCAT(hostname,landingpagepath),'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
			date,
			lower(source) source,
			lower(medium) medium,
			lower(campaign) campaign,
			cast(regexp_replace(transactionid, r'#', '') as int64) transactionid,
			transactions last_touch_transactions,
			(transactionrevenue - transactionshipping - transactiontax) as last_touch_revenue,
			transactionshipping,
			transactiontax,
			_sdc_sequence,
			first_value(_sdc_sequence) OVER (PARTITION BY hostname, landingpagepath, date, source, medium, transactionid ORDER BY _sdc_sequence DESC) lv
			FROM `growth-engines-pipeline.ga_lucadanni.report` 

		    
	   

)


SELECT  
cast(date as date) date,
b.account,
b.client client,
c.source source,
c.medium medium,
a.campaign campaign,
concat(a.source, ' / ', a.medium) source_medium,  
case when c.platform is null then "Unmapped" else c.platform end as platform,
case when c.channel is null then "Unmapped" else c.channel end as channel,
regexp_replace(url, r'offers.|offer.|get.|info.|pos.|go.|join.|pages.','') url,
transactionid,
max(last_touch_transactions) last_touch_transactions,
max(last_touch_revenue) last_touch_revenue,
max(transactionshipping) last_touch_shipping,
max(transactiontax) last_touch_tax
FROM ga_report a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
ON ( a.client_name = b.client_name 
	AND a.lookup_platform = b.platform )
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc` c
ON ( a.source = c.source
  AND a.medium = c.medium 
  AND a.client_name = c.client_name )
GROUP BY date, account, client, source, medium, campaign, source_medium, platform, channel, url, transactionid


2018-04-18 11:34:12,684: Model SQL (ga_traffic):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc`, `growth-engines-pipeline`.`agency_data_pipeline`.`ga_conversions`


##`growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` 



with ga_report as (

	    

	    	
	    	
		   	SELECT
		   	'lucadanni' as client_name,
		   	'GA Traffic' as lookup_platform,
			lower(trim(regexp_replace(replace(replace(replace(replace(CONCAT(hostname,landingpagepath),'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
			date,
			lower(source) source,
			lower(medium) medium,
			lower(campaign) campaign,
			sessions,
			## goal completion columns
							
				goalcompletionsall as goal_completions,		
			
			_sdc_sequence,
			first_value(_sdc_sequence) OVER (PARTITION BY hostname, landingpagepath, date, source, medium, campaign ORDER BY _sdc_sequence DESC) lv
			FROM `growth-engines-pipeline.ga_lucadanni_traffic.report` 

		    
	   

)


SELECT  
cast(date as date) date,
b.account,
b.client client,
c.source source,
c.medium medium,
a.campaign campaign,
concat(a.source, ' / ', a.medium) source_medium,  
case when c.platform is null then "Unmapped" else c.platform end as platform,
case when c.channel is null then "Unmapped" else c.channel end as channel,
regexp_replace(url, r'offers.|offer.|get.|info.|pos.|go.|join.|pages.','') url,
max(sessions) sessions,
max(goal_completions) goal_completions
FROM ga_report a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
ON ( a.client_name = b.client_name 
	AND a.lookup_platform = b.platform )
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc` c
ON ( a.source = c.source
  AND a.medium = c.medium 
  AND a.client_name = c.client_name )
GROUP BY date, account, client, source, medium, campaign, source_medium, platform, channel, url


2018-04-18 11:34:15,487: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '22194847-2847-42b7-8ba7-0d2bfaf0b4bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10bf4f2b0>]}
2018-04-18 11:34:15,714: 11:34:15 | 29 of 93 OK created table model agency_data_pipeline.adwords_join.... [CREATE TABLE in 6.94s]
2018-04-18 11:34:17,870: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '22194847-2847-42b7-8ba7-0d2bfaf0b4bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c0407f0>]}
2018-04-18 11:34:18,345: 11:34:18 | 30 of 93 OK created table model agency_data_pipeline.ga_transactions. [CREATE TABLE in 9.32s]
2018-04-18 11:34:24,010: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '22194847-2847-42b7-8ba7-0d2bfaf0b4bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108b43be0>]}
2018-04-18 11:34:24,273: 11:34:24 | 32 of 93 OK created table model agency_data_pipeline.ga_traffic...... [CREATE TABLE in 15.43s]
2018-04-18 11:34:24,274: 11:34:24 | 33 of 93 START table model agency_data_pipeline.adwords_impression_share [RUN]
2018-04-18 11:34:24,274: 11:34:24 | 34 of 93 START table model agency_data_pipeline.fb_ads_stats......... [RUN]
2018-04-18 11:34:24,274: Compiling model.agency_data_pipeline.adwords_impression_share
2018-04-18 11:34:24,274: 11:34:24 | 35 of 93 START table model agency_data_pipeline.adwords_stats........ [RUN]
2018-04-18 11:34:24,280: Compiling model.agency_data_pipeline.adwords_stats
2018-04-18 11:34:24,280: Writing injected SQL for node "model.agency_data_pipeline.adwords_impression_share"
2018-04-18 11:34:24,286: Writing injected SQL for node "model.agency_data_pipeline.adwords_stats"
2018-04-18 11:34:24,275: Compiling model.agency_data_pipeline.fb_ads_stats
2018-04-18 11:34:24,294: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_stats"
2018-04-18 11:34:24,299: Acquiring new bigquery connection "adwords_stats".
2018-04-18 11:34:24,299: Re-using an available connection from the pool.
2018-04-18 11:34:24,303: Acquiring new bigquery connection "adwords_impression_share".
2018-04-18 11:34:24,303: Re-using an available connection from the pool.
2018-04-18 11:34:24,306: Acquiring new bigquery connection "fb_ads_stats".
2018-04-18 11:34:24,307: Re-using an available connection from the pool.
2018-04-18 11:34:25,371: Model SQL (fb_ads_stats):
with cost as (

    select 
        date, account, ad_id, campaign,
        cost, impressions, clicks, null as conversions
    from `growth-engines-pipeline`.`agency_data_pipeline`.`fb_ads_insights`
),

conversions as (

    select 
        date, account, ad_id, campaign,
        null as cost, null as impressions, null as clicks, conversions
    from `growth-engines-pipeline`.`agency_data_pipeline`.`fb_ads_insights_conversions`
),

urls as (

    select ad_id, url
    from `growth-engines-pipeline`.`agency_data_pipeline`.`fb_ads`
)


SELECT
    cast(date as date) date,
    'FB Ads' platform,
    'Paid' channel,
    account, 
    b.url url,
    campaign,
    lower(campaign) utm_campaign, 
    sum(cost) cost,
    sum(impressions) impressions,
    sum(clicks) clicks,
    sum(conversions) transactions
FROM
(
    SELECT *
    FROM 
      cost
    UNION ALL
    SELECT *
    FROM 
      conversions
) a
LEFT JOIN urls b
ON ( a.ad_id = b.ad_id )
group by date, platform, channel, account, url, campaign, utm_campaign
2018-04-18 11:34:25,372: Model SQL (adwords_impression_share):
SELECT 
cast(day as date) date, 
account, 
channel,
platform,
sum(impression_share_num) impressions,
sum(impression_share_den) available_impressions
FROM 
  `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_join`
group by date, account, platform, channel
2018-04-18 11:34:25,372: Model SQL (adwords_stats):
SELECT 
cast(day as date) date, 
account, 
platform,
channel,
url,
utm_campaign,
campaign,
sum(cost) cost,
sum(impressions) impressions,
sum(clicks) clicks,
sum(transactions) transactions
FROM 
  `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_join`
group by date, account, platform, channel, url, campaign, utm_campaign
2018-04-18 11:34:26,483: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '22194847-2847-42b7-8ba7-0d2bfaf0b4bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108a8b6d8>]}
2018-04-18 11:34:26,729: 11:34:26 | 33 of 93 OK created table model agency_data_pipeline.adwords_impression_share [CREATE TABLE in 2.21s]
2018-04-18 11:34:27,610: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '22194847-2847-42b7-8ba7-0d2bfaf0b4bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108a80a90>]}
2018-04-18 11:34:27,900: 11:34:27 | 34 of 93 OK created table model agency_data_pipeline.fb_ads_stats.... [CREATE TABLE in 3.34s]
2018-04-18 11:34:30,870: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '22194847-2847-42b7-8ba7-0d2bfaf0b4bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108b22940>]}
2018-04-18 11:34:31,523: 11:34:31 | 35 of 93 OK created table model agency_data_pipeline.adwords_stats... [CREATE TABLE in 6.59s]
2018-04-18 11:34:31,524: 11:34:31 | 36 of 93 START table model agency_data_pipeline.agg_products_cogs.... [RUN]
2018-04-18 11:34:31,524: Compiling model.agency_data_pipeline.agg_products_cogs
2018-04-18 11:34:31,531: Writing injected SQL for node "model.agency_data_pipeline.agg_products_cogs"
2018-04-18 11:34:31,532: Acquiring new bigquery connection "agg_products_cogs".
2018-04-18 11:34:31,532: Re-using an available connection from the pool.
2018-04-18 11:34:32,397: Model SQL (agg_products_cogs):
with cogs_all as (

	SELECT 
	client,
	cogs_dol,
	cogs_pct
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`cogs_proc`
	WHERE sku = 'All'

),

cogs_sku as (

	SELECT 
	client,
	cogs_dol,
	cogs_pct
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`cogs_proc`
	WHERE sku != 'All'

),

products as (

	SELECT 
	client,
	product_type,
	product_id,
	sku
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_products`

)


SELECT 
a.client,
product_type,
product_id,
sku,
b.cogs_dol,
b.cogs_pct
FROM products a
LEFT JOIN cogs_all b
ON (
	a.client = b.client
)
WHERE b.cogs_dol > 0 or b.cogs_pct > 0

UNION ALL

SELECT 
c.client,
product_type,
product_id,
c.sku,
d.cogs_dol,
d.cogs_pct
FROM products c
LEFT JOIN cogs_sku d
ON (
	c.client = d.client and
	c.sku = d.sku
)
WHERE d.cogs_dol > 0 or d.cogs_pct > 0
2018-04-18 11:34:32,400: Bad request while running:
with cogs_all as (

	SELECT 
	client,
	cogs_dol,
	cogs_pct
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`cogs_proc`
	WHERE sku = 'All'

),

cogs_sku as (

	SELECT 
	client,
	cogs_dol,
	cogs_pct
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`cogs_proc`
	WHERE sku != 'All'

),

products as (

	SELECT 
	client,
	product_type,
	product_id,
	sku
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_products`

)


SELECT 
a.client,
product_type,
product_id,
sku,
b.cogs_dol,
b.cogs_pct
FROM products a
LEFT JOIN cogs_all b
ON (
	a.client = b.client
)
WHERE b.cogs_dol > 0 or b.cogs_pct > 0

UNION ALL

SELECT 
c.client,
product_type,
product_id,
c.sku,
d.cogs_dol,
d.cogs_pct
FROM products c
LEFT JOIN cogs_sku d
ON (
	c.client = d.client and
	c.sku = d.sku
)
WHERE d.cogs_dol > 0 or d.cogs_pct > 0
2018-04-18 11:34:32,400: 400 Name sku not found inside d at [62:19]
2018-04-18 11:34:32,402: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '22194847-2847-42b7-8ba7-0d2bfaf0b4bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c021f60>]}
2018-04-18 11:34:32,653: 11:34:32 | 36 of 93 ERROR creating table model agency_data_pipeline.agg_products_cogs [ERROR in 0.88s]
2018-04-18 11:34:32,656: 11:34:32 | 37 of 93 START table model agency_data_pipeline.agg_ga_transaction_order_number [RUN]
2018-04-18 11:34:32,656: Compiling model.agency_data_pipeline.agg_ga_transaction_order_number
2018-04-18 11:34:32,664: Writing injected SQL for node "model.agency_data_pipeline.agg_ga_transaction_order_number"
2018-04-18 11:34:32,670: Acquiring new bigquery connection "agg_ga_transaction_order_number".
2018-04-18 11:34:32,670: Re-using an available connection from the pool.
2018-04-18 11:34:33,551: Model SQL (agg_ga_transaction_order_number):
with ga as (

    select 
        date, account, client, 
        channel as last_touch_channel, 
        platform as last_touch_platform, 
        url as last_touch_url, 
        campaign as last_touch_utm_campaign, 
        '' as first_touch_channel, 
        '' as first_touch_platform, 
        '' as first_touch_utm_campaign, 
        transactionid,
        last_touch_transactions, last_touch_revenue,
        last_touch_shipping, last_touch_tax,
        null as first_touch_transactions, null as first_touch_revenue
    from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_transactions`

),

ga_mcf as (

    select 
        date, account, client, 
        '' as last_touch_channel,
        '' as last_touch_platform,
        '' as last_touch_url,
        '' as last_touch_utm_campaign, 
        channel as first_touch_channel, 
        platform as first_touch_platform, 
        campaign as first_touch_utm_campaign, 
        transactionid, 
        null as last_touch_transactions, null as last_touch_revenue,
        null as last_touch_shipping, null as last_touch_tax,
        first_touch_transactions, first_touch_revenue
    from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_mcf_stats`

)


SELECT
    date, 
    client,
    transactionid,
    max(last_touch_channel) last_touch_channel, 
    max(last_touch_platform) last_touch_platform, 
    max(last_touch_url) last_touch_url, 
    max(last_touch_utm_campaign) last_touch_utm_campaign, 
    max(first_touch_channel) first_touch_channel, 
    max(first_touch_platform) first_touch_platform, 
    max(first_touch_utm_campaign) first_touch_utm_campaign,
    sum(last_touch_transactions) last_touch_transactions,
    sum(last_touch_revenue) last_touch_revenue,
    sum(last_touch_shipping) last_touch_shipping_revenue,
    sum(last_touch_tax) last_touch_tax_revenue,
    sum(first_touch_transactions) first_touch_transactions,
    sum(first_touch_revenue) - ifnull(sum(last_touch_shipping),0) - ifnull(sum(last_touch_tax),0) first_touch_revenue
FROM
(
    SELECT *
    FROM 
      ga
    UNION ALL
    SELECT *
    FROM 
      ga_mcf
) 
GROUP BY
    date, client, transactionid
2018-04-18 11:34:38,017: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '22194847-2847-42b7-8ba7-0d2bfaf0b4bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108abb390>]}
2018-04-18 11:34:38,258: 11:34:38 | 37 of 93 OK created table model agency_data_pipeline.agg_ga_transaction_order_number [CREATE TABLE in 5.36s]
2018-04-18 11:34:38,260: 11:34:38 | 38 of 93 START table model agency_data_pipeline.agg_ga_campaign...... [RUN]
2018-04-18 11:34:38,260: Compiling model.agency_data_pipeline.agg_ga_campaign
2018-04-18 11:34:38,261: 11:34:38 | 39 of 93 SKIP relation agency_data_pipeline.agg_orders_union......... [SKIP]
2018-04-18 11:34:38,272: Writing injected SQL for node "model.agency_data_pipeline.agg_ga_campaign"
2018-04-18 11:34:38,273: Acquiring new bigquery connection "agg_ga_campaign".
2018-04-18 11:34:38,273: Re-using an available connection from the pool.
2018-04-18 11:34:39,209: Model SQL (agg_ga_campaign):
with ga_transactions as (

	select 
		date, account, client, channel, platform, url, 
		campaign,
		null as sessions, null as goal_completions, last_touch_transactions, last_touch_revenue,
		last_touch_shipping, last_touch_tax,
		null as first_touch_transactions, null as first_touch_revenue
	from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_transactions`

),

ga_traffic as (

    select 
        date, account, client, channel, platform, url, 
        campaign,
        sessions, goal_completions, null as last_touch_transactions, null as last_touch_revenue,
        null as last_touch_shipping, null as last_touch_tax,
        null as first_touch_transactions, null as first_touch_revenue
    from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_traffic`

),

ga_mcf as (

	select 
		date, account, client, channel, platform, '' as url,
		campaign, 
		null as sessions, null as goal_completions, null as last_touch_transactions, null as last_touch_revenue,
		null as last_touch_shipping, null as last_touch_tax,
		first_touch_transactions, first_touch_revenue
	from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_mcf_stats`

)


SELECT
    date, 
    client,
    platform,
    channel, 
    url,
    campaign utm_campaign,
	sum(sessions) sessions,
	sum(goal_completions) goal_completions,
	sum(last_touch_transactions) last_touch_transactions,
	sum(last_touch_revenue) last_touch_revenue,
    sum(last_touch_shipping) last_touch_shipping_revenue,
    sum(last_touch_tax) last_touch_tax_revenue,
    sum(first_touch_transactions) first_touch_transactions,
    sum(first_touch_revenue) - sum(ifnull(last_touch_shipping,0)) - sum(ifnull(last_touch_tax,0)) first_touch_revenue

FROM
(
    SELECT *
    FROM 
      ga_transactions
    UNION ALL
    SELECT *
    FROM 
      ga_traffic
    UNION ALL
    SELECT *
    FROM 
      ga_mcf
) 
GROUP BY
    date, client, platform, channel, url, utm_campaign
2018-04-18 11:34:47,272: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '22194847-2847-42b7-8ba7-0d2bfaf0b4bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108abb438>]}
2018-04-18 11:34:47,965: 11:34:47 | 38 of 93 OK created table model agency_data_pipeline.agg_ga_campaign. [CREATE TABLE in 9.01s]
2018-04-18 11:34:47,966: 11:34:47 | 40 of 93 SKIP relation agency_data_pipeline.agg_transaction_line_item [SKIP]
2018-04-18 11:34:47,967: 11:34:47 | 41 of 93 SKIP relation agency_data_pipeline.agg_transaction_order_number [SKIP]
2018-04-18 11:34:47,967: 11:34:47 | 42 of 93 SKIP relation agency_data_pipeline.customers_by_transaction. [SKIP]
2018-04-18 11:34:47,968: 11:34:47 | 43 of 93 SKIP relation agency_data_pipeline.agg_transaction_line_item_type [SKIP]
2018-04-18 11:34:47,969: 11:34:47 | 44 of 93 SKIP relation agency_data_pipeline.frequency_proc........... [SKIP]
2018-04-18 11:34:47,969: 11:34:47 | 45 of 93 SKIP relation agency_data_pipeline.agg_transaction_product_type [SKIP]
2018-04-18 11:34:47,969: 11:34:47 | 46 of 93 SKIP relation agency_data_pipeline.customers_first_purchase_product_type_proc [SKIP]
2018-04-18 11:34:47,970: 11:34:47 | 47 of 93 SKIP relation agency_data_pipeline.products_proc............ [SKIP]
2018-04-18 11:34:47,970: 11:34:47 | 48 of 93 SKIP relation agency_data_pipeline.customers_products_proc.. [SKIP]
2018-04-18 11:34:47,971: 11:34:47 | 49 of 93 SKIP relation agency_data_pipeline.order_paths_proc......... [SKIP]
2018-04-18 11:34:47,971: 11:34:47 | 50 of 93 SKIP relation agency_data_pipeline.frequency_stats.......... [SKIP]
2018-04-18 11:34:47,972: 11:34:47 | 51 of 93 SKIP relation agency_data_pipeline.order_paths_agg.......... [SKIP]
2018-04-18 11:34:47,972: 11:34:47 | 52 of 93 SKIP relation agency_data_pipeline.segment_proc_sku......... [SKIP]
2018-04-18 11:34:47,973: 11:34:47 | 53 of 93 SKIP relation agency_data_pipeline.segment_stats_sku........ [SKIP]
2018-04-18 11:34:47,973: 11:34:47 | 54 of 93 SKIP relation agency_data_pipeline.segment_proc_customers_products [SKIP]
2018-04-18 11:34:47,973: 11:34:47 | 55 of 93 SKIP relation agency_data_pipeline.order_paths_stats........ [SKIP]
2018-04-18 11:34:47,974: 11:34:47 | 56 of 93 SKIP relation agency_data_pipeline.segment_stats_customers_products_agg [SKIP]
2018-04-18 11:34:47,974: 11:34:47 | 57 of 93 SKIP relation agency_data_pipeline.segment_stats_category... [SKIP]
2018-04-18 11:34:47,975: 11:34:47 | 58 of 93 SKIP relation agency_data_pipeline.agg_transaction.......... [SKIP]
2018-04-18 11:34:47,975: 11:34:47 | 59 of 93 SKIP relation agency_data_pipeline.segment_stats_customers_products [SKIP]
2018-04-18 11:34:47,975: 11:34:47 | 60 of 93 START table model agency_data_pipeline.agg_platforms_union.. [RUN]
2018-04-18 11:34:47,976: Compiling model.agency_data_pipeline.agg_platforms_union
2018-04-18 11:34:47,975: 11:34:47 | 61 of 93 SKIP relation agency_data_pipeline.agg_ga_transaction....... [SKIP]
2018-04-18 11:34:48,000: Writing injected SQL for node "model.agency_data_pipeline.agg_platforms_union"
2018-04-18 11:34:48,002: Acquiring new bigquery connection "agg_platforms_union".
2018-04-18 11:34:48,002: Re-using an available connection from the pool.
2018-04-18 11:34:49,298: Model SQL (agg_platforms_union):
SELECT 
date, 
account, 
channel,
platform,
url,
utm_campaign,
campaign,
cost,
impressions,
clicks,
transactions
FROM 
`growth-engines-pipeline`.`agency_data_pipeline`.`adwords_stats`

UNION ALL

SELECT 
date, 
account, 
channel,
platform,
url,
utm_campaign,
campaign,
cost,
impressions,
clicks,
transactions
FROM 
`growth-engines-pipeline`.`agency_data_pipeline`.`bing_ads_stats`

UNION ALL  

SELECT 
date, 
account, 
channel,
platform,
url,
utm_campaign,
campaign,
cost,
impressions,
clicks,
transactions
FROM 
`growth-engines-pipeline`.`agency_data_pipeline`.`fb_ads_stats`
2018-04-18 11:34:53,825: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '22194847-2847-42b7-8ba7-0d2bfaf0b4bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c021080>]}
2018-04-18 11:34:54,059: 11:34:54 | 60 of 93 OK created table model agency_data_pipeline.agg_platforms_union [CREATE TABLE in 5.85s]
2018-04-18 11:34:54,059: 11:34:54 | 62 of 93 SKIP relation agency_data_pipeline.agg_transaction_daily.... [SKIP]
2018-04-18 11:34:54,060: 11:34:54 | 63 of 93 SKIP relation agency_data_pipeline.agg_ga_campaign_by_type.. [SKIP]
2018-04-18 11:34:54,060: 11:34:54 | 64 of 93 SKIP relation agency_data_pipeline.segment_list_customers_products [SKIP]
2018-04-18 11:34:54,060: 11:34:54 | 65 of 93 SKIP relation agency_data_pipeline.customers_first_purchase_proc [SKIP]
2018-04-18 11:34:54,061: 11:34:54 | 66 of 93 START table model agency_data_pipeline.agg_platforms_client. [RUN]
2018-04-18 11:34:54,061: Compiling model.agency_data_pipeline.agg_platforms_client
2018-04-18 11:34:54,061: 11:34:54 | 67 of 93 SKIP relation agency_data_pipeline.growth_customer_0_365.... [SKIP]
2018-04-18 11:34:54,069: Writing injected SQL for node "model.agency_data_pipeline.agg_platforms_client"
2018-04-18 11:34:54,061: 11:34:54 | 68 of 93 SKIP relation agency_data_pipeline.customers_proc........... [SKIP]
2018-04-18 11:34:54,070: Acquiring new bigquery connection "agg_platforms_client".
2018-04-18 11:34:54,070: Re-using an available connection from the pool.
2018-04-18 11:34:55,150: Model SQL (agg_platforms_client):
SELECT 
date, 
a.account account, 
b.client client,
a.platform platform,
a.channel channel,
url,
utm_campaign,
campaign,
cost,
impressions,
clicks,
transactions ad_platform_transactions
FROM 
  `growth-engines-pipeline`.`agency_data_pipeline`.`agg_platforms_union` a
LEFT JOIN 
  `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc` b
ON ( 
  a.account = b.account AND
  a.platform = b.platform
)
2018-04-18 11:35:00,886: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '22194847-2847-42b7-8ba7-0d2bfaf0b4bf', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108a8bd30>]}
2018-04-18 11:35:01,128: 11:35:01 | 66 of 93 OK created table model agency_data_pipeline.agg_platforms_client [CREATE TABLE in 6.82s]
2018-04-18 11:35:01,129: 11:35:01 | 69 of 93 SKIP relation agency_data_pipeline.retention_0_30........... [SKIP]
2018-04-18 11:35:01,130: 11:35:01 | 70 of 93 SKIP relation agency_data_pipeline.retention_730_plus....... [SKIP]
2018-04-18 11:35:01,130: 11:35:01 | 71 of 93 SKIP relation agency_data_pipeline.retention_30_60.......... [SKIP]
2018-04-18 11:35:01,130: 11:35:01 | 72 of 93 SKIP relation agency_data_pipeline.retention_365_730........ [SKIP]
2018-04-18 11:35:01,131: 11:35:01 | 73 of 93 SKIP relation agency_data_pipeline.retention_0_365.......... [SKIP]
2018-04-18 11:35:01,131: 11:35:01 | 74 of 93 SKIP relation agency_data_pipeline.retention_60_plus........ [SKIP]
2018-04-18 11:35:01,133: 11:35:01 | 75 of 93 SKIP relation agency_data_pipeline.segment_proc_customers... [SKIP]
2018-04-18 11:35:01,134: 11:35:01 | 76 of 93 SKIP relation agency_data_pipeline.segment_stats_customers_agg [SKIP]
2018-04-18 11:35:01,134: 11:35:01 | 77 of 93 SKIP relation agency_data_pipeline.retention_0_30_rebuy..... [SKIP]
2018-04-18 11:35:01,134: 11:35:01 | 78 of 93 SKIP relation agency_data_pipeline.retention_0_365_rebuy.... [SKIP]
2018-04-18 11:35:01,135: 11:35:01 | 79 of 93 SKIP relation agency_data_pipeline.retention_0_30_reactivated [SKIP]
2018-04-18 11:35:01,136: 11:35:01 | 80 of 93 SKIP relation agency_data_pipeline.retention_stats_rebuy_rate [SKIP]
2018-04-18 11:35:01,136: 11:35:01 | 81 of 93 SKIP relation agency_data_pipeline.retention_0_30_new....... [SKIP]
2018-04-18 11:35:01,136: 11:35:01 | 82 of 93 SKIP relation agency_data_pipeline.retention_0_365_new...... [SKIP]
2018-04-18 11:35:01,136: 11:35:01 | 83 of 93 SKIP relation agency_data_pipeline.segment_stats_customers.. [SKIP]
2018-04-18 11:35:01,136: 11:35:01 | 84 of 93 SKIP relation agency_data_pipeline.retention_0_365_reactivated [SKIP]
2018-04-18 11:35:01,137: 11:35:01 | 85 of 93 SKIP relation agency_data_pipeline.retention_stats_rebuy_rate_month [SKIP]
2018-04-18 11:35:01,138: 11:35:01 | 86 of 93 SKIP relation agency_data_pipeline.segment_list_customers... [SKIP]
2018-04-18 11:35:01,138: 11:35:01 | 87 of 93 SKIP relation agency_data_pipeline.growth_customer_0_365_segment [SKIP]
2018-04-18 11:35:01,139: 11:35:01 | 88 of 93 SKIP relation agency_data_pipeline.growth_date_union........ [SKIP]
2018-04-18 11:35:01,139: 11:35:01 | 89 of 93 SKIP relation agency_data_pipeline.retention_stats.......... [SKIP]
2018-04-18 11:35:01,140: 11:35:01 | 90 of 93 SKIP relation agency_data_pipeline.retention_stats_month.... [SKIP]
2018-04-18 11:35:01,140: 11:35:01 | 91 of 93 SKIP relation agency_data_pipeline.growth_stats............. [SKIP]
2018-04-18 11:35:01,141: 11:35:01 | 92 of 93 SKIP relation agency_data_pipeline.agg_campaign............. [SKIP]
2018-04-18 11:35:01,141: 11:35:01 | 93 of 93 SKIP relation agency_data_pipeline.agg_platform_monthly..... [SKIP]
2018-04-18 11:35:01,199: 11:35:01 | 
2018-04-18 11:35:01,200: 11:35:01 | Finished running 93 table models in 102.44s.
2018-04-18 11:35:01,200: Connection 'master' was left open.
2018-04-18 11:35:01,201: 
2018-04-18 11:35:01,201: Completed with 1 errors:
2018-04-18 11:35:01,202: 
2018-04-18 11:35:01,202: Database Error in model agg_products_cogs (models/join/agg_products_cogs.sql)
2018-04-18 11:35:01,202:   Name sku not found inside d at [62:19]
2018-04-18 11:35:01,202:   compiled SQL at target/compiled/agency_data_pipeline/join/agg_products_cogs.sql
2018-04-18 11:35:01,202: 
Done. PASS=39 ERROR=1 SKIP=53 TOTAL=93
2018-04-18 11:35:01,203: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10bf429e8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10bf42c18>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10be75ba8>]}
2018-04-18 11:35:01,452: Flushing usage events
2018-04-18 11:36:13,928: Tracking: tracking
2018-04-18 11:36:13,931: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f971588>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f971828>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f971ba8>]}
2018-04-18 11:36:14,873: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-04-18 11:36:14,894: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/growth-engines/dbt_modules
2018-04-18 11:36:14,900: Parsing get_column_values.sql
2018-04-18 11:36:14,917: Parsing get_url_parameter.sql
2018-04-18 11:36:14,925: Parsing split_part.sql
2018-04-18 11:36:14,936: Parsing table_exists.sql
2018-04-18 11:36:14,948: Parsing core.sql
2018-04-18 11:36:14,968: Parsing adapters/bigquery.sql
2018-04-18 11:36:14,978: Parsing adapters/common.sql
2018-04-18 11:36:15,000: Parsing adapters/postgres.sql
2018-04-18 11:36:15,006: Parsing adapters/redshift.sql
2018-04-18 11:36:15,026: Parsing etc/get_custom_schema.sql
2018-04-18 11:36:15,038: Parsing materializations/archive.sql
2018-04-18 11:36:15,074: Parsing materializations/bigquery.sql
2018-04-18 11:36:15,090: Parsing materializations/helpers.sql
2018-04-18 11:36:15,111: Parsing materializations/incremental.sql
2018-04-18 11:36:15,147: Parsing materializations/table.sql
2018-04-18 11:36:15,167: Parsing materializations/view.sql
2018-04-18 11:36:15,186: Parsing materializations/wrapper.sql
2018-04-18 11:36:15,192: Parsing schema_tests/accepted_values.sql
2018-04-18 11:36:15,203: Parsing schema_tests/not_null.sql
2018-04-18 11:36:15,211: Parsing schema_tests/relationships.sql
2018-04-18 11:36:15,219: Parsing schema_tests/unique.sql
2018-04-18 11:36:15,304: Parsing model.agency_data_pipeline.accounts_proc
2018-04-18 11:36:15,307: Parsing model.agency_data_pipeline.all_dates
2018-04-18 11:36:15,308: Parsing model.agency_data_pipeline.carts_proc
2018-04-18 11:36:15,309: Parsing model.agency_data_pipeline.clients_proc
2018-04-18 11:36:15,311: Parsing model.agency_data_pipeline.cogs_proc
2018-04-18 11:36:15,313: Parsing model.agency_data_pipeline.conversion_goals_proc
2018-04-18 11:36:15,314: Parsing model.agency_data_pipeline.mappings_ga_proc
2018-04-18 11:36:15,316: Acquiring new bigquery connection "master".
2018-04-18 11:36:15,317: Opening a new connection (0 currently allocated)
2018-04-18 11:36:15,324: Parsing model.agency_data_pipeline.monthend_dates
2018-04-18 11:36:15,325: Parsing model.agency_data_pipeline.adwords_ads
2018-04-18 11:36:15,328: Parsing model.agency_data_pipeline.adwords_campaigns
2018-04-18 11:36:15,331: Parsing model.agency_data_pipeline.adwords_conversions
2018-04-18 11:36:15,332: Parsing model.agency_data_pipeline.adwords_impression_share
2018-04-18 11:36:15,334: Parsing model.agency_data_pipeline.adwords_join
2018-04-18 11:36:15,337: Parsing model.agency_data_pipeline.adwords_stats
2018-04-18 11:36:15,339: Parsing model.agency_data_pipeline.adwords_urls
2018-04-18 11:36:15,341: Parsing model.agency_data_pipeline.bing_ads_ads
2018-04-18 11:36:15,344: Parsing model.agency_data_pipeline.bing_ads_conversions
2018-04-18 11:36:15,347: Parsing model.agency_data_pipeline.bing_ads_impression_share
2018-04-18 11:36:15,348: Parsing model.agency_data_pipeline.bing_ads_stats
2018-04-18 11:36:15,350: Parsing model.agency_data_pipeline.fb_adcreative
2018-04-18 11:36:15,356: Parsing model.agency_data_pipeline.fb_ads
2018-04-18 11:36:15,362: Parsing model.agency_data_pipeline.fb_ads_insights
2018-04-18 11:36:15,368: Parsing model.agency_data_pipeline.fb_ads_insights_conversions
2018-04-18 11:36:15,373: Parsing model.agency_data_pipeline.fb_ads_stats
2018-04-18 11:36:15,376: Parsing model.agency_data_pipeline.ga_conversions
2018-04-18 11:36:15,378: Parsing model.agency_data_pipeline.ga_traffic
2018-04-18 11:36:15,393: Parsing model.agency_data_pipeline.ga_transactions
2018-04-18 11:36:15,403: Parsing model.agency_data_pipeline.ga_mcf_proc
2018-04-18 11:36:15,405: Parsing model.agency_data_pipeline.ga_mcf_stats
2018-04-18 11:36:15,408: Parsing model.agency_data_pipeline.shopify_customers_proc
2018-04-18 11:36:15,415: Parsing model.agency_data_pipeline.shopify_orders_proc
2018-04-18 11:36:15,423: Parsing model.agency_data_pipeline.shopify_products_proc
2018-04-18 11:36:15,429: Parsing model.agency_data_pipeline.shopify_refunds_proc
2018-04-18 11:36:15,434: Parsing model.agency_data_pipeline.agg_campaign
2018-04-18 11:36:15,438: Parsing model.agency_data_pipeline.agg_customers_union
2018-04-18 11:36:15,441: Parsing model.agency_data_pipeline.agg_ga_campaign
2018-04-18 11:36:15,444: Parsing model.agency_data_pipeline.agg_ga_campaign_by_type
2018-04-18 11:36:15,446: Parsing model.agency_data_pipeline.agg_ga_transaction
2018-04-18 11:36:15,451: Parsing model.agency_data_pipeline.agg_ga_transaction_order_number
2018-04-18 11:36:15,457: Parsing model.agency_data_pipeline.agg_orders_union
2018-04-18 11:36:15,461: Parsing model.agency_data_pipeline.agg_platform_monthly
2018-04-18 11:36:15,464: Parsing model.agency_data_pipeline.agg_platforms_client
2018-04-18 11:36:15,467: Parsing model.agency_data_pipeline.agg_platforms_union
2018-04-18 11:36:15,469: Parsing model.agency_data_pipeline.agg_products
2018-04-18 11:36:15,471: Parsing model.agency_data_pipeline.agg_products_cogs
2018-04-18 11:36:15,474: Parsing model.agency_data_pipeline.agg_transaction
2018-04-18 11:36:15,476: Parsing model.agency_data_pipeline.agg_transaction_daily
2018-04-18 11:36:15,478: Parsing model.agency_data_pipeline.agg_transaction_line_item
2018-04-18 11:36:15,480: Parsing model.agency_data_pipeline.agg_transaction_line_item_type
2018-04-18 11:36:15,482: Parsing model.agency_data_pipeline.agg_transaction_order_number
2018-04-18 11:36:15,483: Parsing model.agency_data_pipeline.agg_transaction_product_type
2018-04-18 11:36:15,485: Parsing model.agency_data_pipeline.customers_by_transaction
2018-04-18 11:36:15,488: Parsing model.agency_data_pipeline.growth_customer_0_365
2018-04-18 11:36:15,491: Parsing model.agency_data_pipeline.growth_customer_0_365_segment
2018-04-18 11:36:15,495: Parsing model.agency_data_pipeline.growth_date_union
2018-04-18 11:36:15,500: Parsing model.agency_data_pipeline.growth_stats
2018-04-18 11:36:15,507: Parsing model.agency_data_pipeline.retention_0_365
2018-04-18 11:36:15,509: Parsing model.agency_data_pipeline.retention_0_365_new
2018-04-18 11:36:15,512: Parsing model.agency_data_pipeline.retention_0_365_reactivated
2018-04-18 11:36:15,514: Parsing model.agency_data_pipeline.retention_0_365_rebuy
2018-04-18 11:36:15,516: Parsing model.agency_data_pipeline.retention_365_730
2018-04-18 11:36:15,519: Parsing model.agency_data_pipeline.retention_730_plus
2018-04-18 11:36:15,521: Parsing model.agency_data_pipeline.retention_stats
2018-04-18 11:36:15,527: Parsing model.agency_data_pipeline.retention_stats_rebuy_rate
2018-04-18 11:36:15,530: Parsing model.agency_data_pipeline.retention_0_30
2018-04-18 11:36:15,532: Parsing model.agency_data_pipeline.retention_0_30_new
2018-04-18 11:36:15,536: Parsing model.agency_data_pipeline.retention_0_30_reactivated
2018-04-18 11:36:15,540: Parsing model.agency_data_pipeline.retention_0_30_rebuy
2018-04-18 11:36:15,543: Parsing model.agency_data_pipeline.retention_30_60
2018-04-18 11:36:15,545: Parsing model.agency_data_pipeline.retention_60_plus
2018-04-18 11:36:15,548: Parsing model.agency_data_pipeline.retention_stats_month
2018-04-18 11:36:15,553: Parsing model.agency_data_pipeline.retention_stats_rebuy_rate_month
2018-04-18 11:36:15,557: Parsing model.agency_data_pipeline.customers_first_purchase_proc
2018-04-18 11:36:15,558: Parsing model.agency_data_pipeline.customers_proc
2018-04-18 11:36:15,561: Parsing model.agency_data_pipeline.segment_list_customers
2018-04-18 11:36:15,563: Parsing model.agency_data_pipeline.segment_proc_customers
2018-04-18 11:36:15,566: Parsing model.agency_data_pipeline.segment_stats_customers
2018-04-18 11:36:15,568: Parsing model.agency_data_pipeline.segment_stats_customers_agg
2018-04-18 11:36:15,572: Parsing model.agency_data_pipeline.customers_first_purchase_product_type_proc
2018-04-18 11:36:15,574: Parsing model.agency_data_pipeline.customers_products_proc
2018-04-18 11:36:15,576: Parsing model.agency_data_pipeline.segment_list_customers_products
2018-04-18 11:36:15,579: Parsing model.agency_data_pipeline.segment_proc_customers_products
2018-04-18 11:36:15,582: Parsing model.agency_data_pipeline.segment_stats_customers_products
2018-04-18 11:36:15,584: Parsing model.agency_data_pipeline.segment_stats_customers_products_agg
2018-04-18 11:36:15,587: Parsing model.agency_data_pipeline.frequency_proc
2018-04-18 11:36:15,590: Parsing model.agency_data_pipeline.frequency_stats
2018-04-18 11:36:15,593: Parsing model.agency_data_pipeline.order_paths_agg
2018-04-18 11:36:15,595: Parsing model.agency_data_pipeline.order_paths_proc
2018-04-18 11:36:15,597: Parsing model.agency_data_pipeline.order_paths_stats
2018-04-18 11:36:15,600: Parsing model.agency_data_pipeline.products_proc
2018-04-18 11:36:15,603: Parsing model.agency_data_pipeline.segment_proc_sku
2018-04-18 11:36:15,605: Parsing model.agency_data_pipeline.segment_stats_category
2018-04-18 11:36:15,607: Parsing model.agency_data_pipeline.segment_stats_sku
2018-04-18 11:36:15,640: Found 93 models, 0 tests, 0 archives, 0 analyses, 46 macros, 0 operations
2018-04-18 11:36:15,726: 
2018-04-18 11:36:16,415: 11:36:16 | Concurrency: 4 threads (target='prod')
2018-04-18 11:36:16,416: 11:36:16 | 
2018-04-18 11:36:17,538: 11:36:17 | 1 of 93 START table model agency_data_pipeline.bing_ads_impression_share [RUN]
2018-04-18 11:36:17,539: Compiling model.agency_data_pipeline.bing_ads_impression_share
2018-04-18 11:36:17,546: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_impression_share"
2018-04-18 11:36:17,544: 11:36:17 | 2 of 93 START table model agency_data_pipeline.conversion_goals_proc. [RUN]
2018-04-18 11:36:17,544: 11:36:17 | 3 of 93 START table model agency_data_pipeline.adwords_campaigns..... [RUN]
2018-04-18 11:36:17,547: Compiling model.agency_data_pipeline.conversion_goals_proc
2018-04-18 11:36:17,544: 11:36:17 | 4 of 93 START table model agency_data_pipeline.carts_proc............ [RUN]
2018-04-18 11:36:17,547: Compiling model.agency_data_pipeline.adwords_campaigns
2018-04-18 11:36:17,551: Writing injected SQL for node "model.agency_data_pipeline.conversion_goals_proc"
2018-04-18 11:36:17,552: Compiling model.agency_data_pipeline.carts_proc
2018-04-18 11:36:17,558: Acquiring new bigquery connection "bing_ads_impression_share".
2018-04-18 11:36:17,559: Writing injected SQL for node "model.agency_data_pipeline.adwords_campaigns"
2018-04-18 11:36:17,565: Writing injected SQL for node "model.agency_data_pipeline.carts_proc"
2018-04-18 11:36:17,565: Opening a new connection (1 currently allocated)
2018-04-18 11:36:17,567: Acquiring new bigquery connection "carts_proc".
2018-04-18 11:36:17,569: Acquiring new bigquery connection "conversion_goals_proc".
2018-04-18 11:36:17,574: Acquiring new bigquery connection "adwords_campaigns".
2018-04-18 11:36:17,643: Opening a new connection (2 currently allocated)
2018-04-18 11:36:17,651: Opening a new connection (3 currently allocated)
2018-04-18 11:36:17,713: Opening a new connection (4 currently allocated)
2018-04-18 11:36:18,997: Model SQL (adwords_campaigns):
select
day,
campaignid, 
campaign,
account, 
channel,
platform,
sum(cost) cost,
sum(impressions) impressions,
sum(clicks) clicks,
sum(impression_share_num) impression_share_num,
sum(impression_share_den) impression_share_den
from 
  ( 
	SELECT  
	day,
	campaignid,
	campaign,
	account as account,
	'Paid' as channel,
	'Adwords' as platform,
	cost/1000000 cost, 
	impressions as impressions, 
	clicks, 
	case when searchimprshare is not null then impressions end as impression_share_num,
	case when searchimprshare is not null then impressions/(searchimprshare/100) end as impression_share_den,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY campaignid, day ORDER BY _sdc_sequence DESC) lv
	FROM `growth-engines-pipeline.adwords_2.CAMPAIGN_PERFORMANCE_REPORT`
  )
where lv = _sdc_sequence
group by day, campaignid, account, channel, platform, campaign
2018-04-18 11:36:19,000: Model SQL (carts_proc):
select 
client,
client_name,
account,
platform
from  ( 

SELECT  
client,
client_name,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.accounts`
WHERE platform in ('Shopify', 'Custom cart')

) 

WHERE lv = time_of_entry
2018-04-18 11:36:19,003: Model SQL (bing_ads_impression_share):
SELECT 
date, 
account,
channel,
platform,
sum(impressions) impressions,
sum(available_impressions) available_impressions
FROM

(

SELECT  
cast(gregoriandate as date) date,
replace(accountname,',','') account,  
'Paid' as channel,
'Bing Ads' as platform,
case when impressionsharepercent is null then 0 else impressions end as impressions,
cast(round(case when ( impressionsharepercent is not null and impressionsharepercent > 0 ) then (impressions*100)/impressionsharepercent else 0 end) as int64) as available_impressions,
_sdc_sequence,
first_value(_sdc_sequence) OVER (PARTITION BY campaignid, gregoriandate ORDER BY _sdc_sequence DESC) lv
FROM `growth-engines-pipeline.bing_ads.campaign_performance_report` 

)

where lv = _sdc_sequence
group by date, account, channel, platform
2018-04-18 11:36:19,021: Model SQL (conversion_goals_proc):
select 
client,
platform,
goal_name,
max(goal_type) goal_type,
account,
max(time_of_entry) time_of_entry
from  ( 

SELECT  
client,
platform,
trim(replace(replace(lower(goal_name),',',''),' ','')) goal_name,
goal_type,
account,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY platform ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.conversion_goals` 

) 

WHERE lv = time_of_entry
group by client, platform, account, goal_name
2018-04-18 11:36:20,166: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7ab49507-8ce8-4871-aec8-0dce4a32fc94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fa3fd68>]}
2018-04-18 11:36:20,218: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7ab49507-8ce8-4871-aec8-0dce4a32fc94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c5b2828>]}
2018-04-18 11:36:20,427: 11:36:20 | 1 of 93 OK created table model agency_data_pipeline.bing_ads_impression_share [CREATE TABLE in 2.63s]
2018-04-18 11:36:20,428: 11:36:20 | 5 of 93 START table model agency_data_pipeline.monthend_dates........ [RUN]
2018-04-18 11:36:20,428: Compiling model.agency_data_pipeline.monthend_dates
2018-04-18 11:36:20,436: Writing injected SQL for node "model.agency_data_pipeline.monthend_dates"
2018-04-18 11:36:20,441: Acquiring new bigquery connection "monthend_dates".
2018-04-18 11:36:20,442: Re-using an available connection from the pool.
2018-04-18 11:36:20,716: 11:36:20 | 4 of 93 OK created table model agency_data_pipeline.carts_proc....... [CREATE TABLE in 2.67s]
2018-04-18 11:36:20,718: 11:36:20 | 6 of 93 START table model agency_data_pipeline.accounts_proc......... [RUN]
2018-04-18 11:36:20,718: Compiling model.agency_data_pipeline.accounts_proc
2018-04-18 11:36:20,725: Writing injected SQL for node "model.agency_data_pipeline.accounts_proc"
2018-04-18 11:36:20,727: Acquiring new bigquery connection "accounts_proc".
2018-04-18 11:36:20,728: Re-using an available connection from the pool.
2018-04-18 11:36:21,308: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7ab49507-8ce8-4871-aec8-0dce4a32fc94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fb61630>]}
2018-04-18 11:36:21,316: Model SQL (monthend_dates):
SELECT
date_in_range,
date_in_range_bom,
date_in_range_bom_mom,
unix_date_in_range,
unix_date_in_range_bom,
unix_date(date_in_range_bom_mom) unix_date_in_range_bom_mom,
yyyymm,
date_in_range_yoy,
unix_date(date_in_range_yoy) unix_date_in_range_yoy

FROM
(
	SELECT 
	date_in_range,
	date_in_range_bom,
	date_sub(date_in_range_bom, INTERVAL 1 MONTH) date_in_range_bom_mom,
  date_sub(date_in_range, INTERVAL 1 YEAR) date_in_range_yoy,
	unix_date_in_range,
	unix_date(date_in_range_bom) unix_date_in_range_bom,
	yyyymm,
	first_value(date_in_range) over (partition by yyyymm order by date_in_range desc) monthend_date_in_range
	FROM
	( 
		SELECT 
		date_in_range,
		date_trunc( date_in_range, MONTH) date_in_range_bom,
		unix_date(date_in_range) unix_date_in_range,
		format_date("%Y-%m", date_in_range) AS yyyymm
		FROM UNNEST(
		    GENERATE_DATE_ARRAY(DATE('2016-01-31'), CURRENT_DATE(), INTERVAL 1 DAY)
		) AS date_in_range
	)
)
where date_in_range = monthend_date_in_range
2018-04-18 11:36:21,585: 11:36:21 | 2 of 93 OK created table model agency_data_pipeline.conversion_goals_proc [CREATE TABLE in 3.76s]
2018-04-18 11:36:21,586: 11:36:21 | 7 of 93 START table model agency_data_pipeline.adwords_conversions... [RUN]
2018-04-18 11:36:21,586: Compiling model.agency_data_pipeline.adwords_conversions
2018-04-18 11:36:21,593: Writing injected SQL for node "model.agency_data_pipeline.adwords_conversions"
2018-04-18 11:36:21,594: Acquiring new bigquery connection "adwords_conversions".
2018-04-18 11:36:21,594: Re-using an available connection from the pool.
2018-04-18 11:36:21,821: Model SQL (accounts_proc):
select 
client,
account,
platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.accounts` 

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-04-18 11:36:22,429: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7ab49507-8ce8-4871-aec8-0dce4a32fc94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fa3fd68>]}
2018-04-18 11:36:22,645: Model SQL (adwords_conversions):
select 
client,
client_name,
platform,
goal_name,
goal_type,
account,
time_of_entry
from  ( 

SELECT  
client,
client_name,
platform,
trim(lower(goal_name)) goal_name,
goal_type,
account,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform, goal_name ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.conversion_goals` 
WHERE platform = 'Adwords'

) 

WHERE lv = time_of_entry
2018-04-18 11:36:22,676: 11:36:22 | 5 of 93 OK created table model agency_data_pipeline.monthend_dates... [CREATE TABLE in 2.00s]
2018-04-18 11:36:22,676: 11:36:22 | 8 of 93 START table model agency_data_pipeline.clients_proc.......... [RUN]
2018-04-18 11:36:22,677: Compiling model.agency_data_pipeline.clients_proc
2018-04-18 11:36:22,684: Writing injected SQL for node "model.agency_data_pipeline.clients_proc"
2018-04-18 11:36:22,685: Acquiring new bigquery connection "clients_proc".
2018-04-18 11:36:22,685: Re-using an available connection from the pool.
2018-04-18 11:36:22,926: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7ab49507-8ce8-4871-aec8-0dce4a32fc94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fb617b8>]}
2018-04-18 11:36:23,157: 11:36:23 | 6 of 93 OK created table model agency_data_pipeline.accounts_proc.... [CREATE TABLE in 2.21s]
2018-04-18 11:36:23,157: 11:36:23 | 9 of 93 START table model agency_data_pipeline.all_dates............. [RUN]
2018-04-18 11:36:23,158: Compiling model.agency_data_pipeline.all_dates
2018-04-18 11:36:23,165: Writing injected SQL for node "model.agency_data_pipeline.all_dates"
2018-04-18 11:36:23,166: Acquiring new bigquery connection "all_dates".
2018-04-18 11:36:23,167: Re-using an available connection from the pool.
2018-04-18 11:36:23,647: Model SQL (clients_proc):
select 
client,
client_name,
account,
platform
from  ( 

SELECT  
client,
client_name,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.accounts`
where client_name != ''
) 

WHERE lv = time_of_entry
2018-04-18 11:36:23,768: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7ab49507-8ce8-4871-aec8-0dce4a32fc94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fb61630>]}
2018-04-18 11:36:24,025: Model SQL (all_dates):
SELECT 
date_in_range,
unix_date(date_in_range) unix_date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-04-18 11:36:24,058: 11:36:24 | 7 of 93 OK created table model agency_data_pipeline.adwords_conversions [CREATE TABLE in 2.18s]
2018-04-18 11:36:24,058: 11:36:24 | 10 of 93 START table model agency_data_pipeline.adwords_urls......... [RUN]
2018-04-18 11:36:24,059: Compiling model.agency_data_pipeline.adwords_urls
2018-04-18 11:36:24,067: Writing injected SQL for node "model.agency_data_pipeline.adwords_urls"
2018-04-18 11:36:24,068: Acquiring new bigquery connection "adwords_urls".
2018-04-18 11:36:24,069: Re-using an available connection from the pool.
2018-04-18 11:36:24,633: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7ab49507-8ce8-4871-aec8-0dce4a32fc94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fb34470>]}
2018-04-18 11:36:24,764: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7ab49507-8ce8-4871-aec8-0dce4a32fc94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fa3fd68>]}
2018-04-18 11:36:24,905: 11:36:24 | 3 of 93 OK created table model agency_data_pipeline.adwords_campaigns [CREATE TABLE in 7.09s]
2018-04-18 11:36:24,907: 11:36:24 | 11 of 93 START table model agency_data_pipeline.ga_conversions....... [RUN]
2018-04-18 11:36:24,909: Compiling model.agency_data_pipeline.ga_conversions
2018-04-18 11:36:24,917: Writing injected SQL for node "model.agency_data_pipeline.ga_conversions"
2018-04-18 11:36:24,921: Acquiring new bigquery connection "ga_conversions".
2018-04-18 11:36:24,921: Re-using an available connection from the pool.
2018-04-18 11:36:24,968: Model SQL (adwords_urls):
SELECT
campaignid,
lower(trim(regexp_replace(replace(replace(replace(replace(finalurl,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url

FROM (

SELECT  
campaignid,
finalurl,
first_value(finalurl) OVER (PARTITION BY campaignid ORDER BY day DESC) lv
FROM `growth-engines-pipeline.adwords_2.FINAL_URL_REPORT`
)

WHERE lv = finalurl
group by campaignid, url
order by campaignid asc
2018-04-18 11:36:25,130: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7ab49507-8ce8-4871-aec8-0dce4a32fc94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fb617b8>]}
2018-04-18 11:36:25,176: 11:36:25 | 8 of 93 OK created table model agency_data_pipeline.clients_proc..... [CREATE TABLE in 2.09s]
2018-04-18 11:36:25,177: 11:36:25 | 12 of 93 START table model agency_data_pipeline.bing_ads_ads......... [RUN]
2018-04-18 11:36:25,177: Compiling model.agency_data_pipeline.bing_ads_ads
2018-04-18 11:36:25,185: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_ads"
2018-04-18 11:36:25,188: Acquiring new bigquery connection "bing_ads_ads".
2018-04-18 11:36:25,188: Re-using an available connection from the pool.
2018-04-18 11:36:25,504: 11:36:25 | 9 of 93 OK created table model agency_data_pipeline.all_dates........ [CREATE TABLE in 1.97s]
2018-04-18 11:36:25,504: 11:36:25 | 13 of 93 START table model agency_data_pipeline.cogs_proc............ [RUN]
2018-04-18 11:36:25,505: Compiling model.agency_data_pipeline.cogs_proc
2018-04-18 11:36:25,514: Writing injected SQL for node "model.agency_data_pipeline.cogs_proc"
2018-04-18 11:36:25,520: Acquiring new bigquery connection "cogs_proc".
2018-04-18 11:36:25,520: Re-using an available connection from the pool.
2018-04-18 11:36:25,916: Model SQL (ga_conversions):
select 
client,
client_name,
platform,
goal_name,
goal_type,
account,
time_of_entry
from  ( 

SELECT  
client,
client_name,
platform,
trim(goal_name) goal_name,
goal_type,
account,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform, goal_name ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.conversion_goals` 
WHERE platform = 'Google Analytics'

) 

WHERE lv = time_of_entry
2018-04-18 11:36:26,104: Model SQL (bing_ads_ads):
select
date, 
account, 
channel,
platform,
campaignid,
campaignname,
max(lower(trim(replace(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$','' ),'.html',''),'/'))) as url,
utm_campaign,
sum(cost) as cost,
sum(impressions) as impressions,
sum(clicks) as clicks,
sum(conversions) as conversions
from 
  ( 
SELECT  
cast(gregoriandate as date) date,
replace(accountname,',','') account,
'Paid' as channel,
'Bing Ads' as platform,
adid,
adtype,
campaignid, 
campaignname,
finalurl url,
case when regexp_contains(destinationurl, 'utm_campaign')
	then replace(lower(nullif(
  

    split(
        
  

    split(
        destinationurl,
        'utm_campaign='
        )[offset(1)]


,
        '&'
        )[offset(0)]


,'')),'+',' ') 
	else null end as utm_campaign,
spend cost, 
impressions, 
clicks, 
conversions,
_sdc_sequence,
first_value(_sdc_sequence) OVER (PARTITION BY adid, gregoriandate ORDER BY _sdc_sequence DESC) lv
FROM `growth-engines-pipeline.bing_ads.ad_performance_report` 
  )

where lv = _sdc_sequence
group by date, account, channel, platform, campaignid, campaignname, utm_campaign
2018-04-18 11:36:26,452: Model SQL (cogs_proc):
select 
client,
sku,
cogs_dol,
cogs_pct
from  ( 

SELECT  
client,
sku,
cogs_dol,
cogs_pct,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.cogs`
where client != ''
) 

WHERE lv = time_of_entry
2018-04-18 11:36:27,031: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7ab49507-8ce8-4871-aec8-0dce4a32fc94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fb34470>]}
2018-04-18 11:36:27,302: 11:36:27 | 11 of 93 OK created table model agency_data_pipeline.ga_conversions.. [CREATE TABLE in 2.12s]
2018-04-18 11:36:27,385: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7ab49507-8ce8-4871-aec8-0dce4a32fc94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fb61630>]}
2018-04-18 11:36:27,574: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7ab49507-8ce8-4871-aec8-0dce4a32fc94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fb617b8>]}
2018-04-18 11:36:27,644: 11:36:27 | 10 of 93 OK created table model agency_data_pipeline.adwords_urls.... [CREATE TABLE in 3.33s]
2018-04-18 11:36:27,891: 11:36:27 | 13 of 93 OK created table model agency_data_pipeline.cogs_proc....... [CREATE TABLE in 2.07s]
2018-04-18 11:36:29,513: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7ab49507-8ce8-4871-aec8-0dce4a32fc94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fa3fd68>]}
2018-04-18 11:36:29,777: 11:36:29 | 12 of 93 OK created table model agency_data_pipeline.bing_ads_ads.... [CREATE TABLE in 4.34s]
2018-04-18 11:36:29,778: 11:36:29 | 14 of 93 START table model agency_data_pipeline.fb_ads_insights_conversions [RUN]
2018-04-18 11:36:29,779: Compiling model.agency_data_pipeline.fb_ads_insights_conversions
2018-04-18 11:36:29,778: 11:36:29 | 15 of 93 START table model agency_data_pipeline.shopify_refunds_proc. [RUN]
2018-04-18 11:36:29,786: Acquiring new bigquery connection "fb_ads_insights_conversions".
2018-04-18 11:36:29,778: 11:36:29 | 16 of 93 START table model agency_data_pipeline.fb_adcreative........ [RUN]
2018-04-18 11:36:29,787: Compiling model.agency_data_pipeline.shopify_refunds_proc
2018-04-18 11:36:29,779: 11:36:29 | 17 of 93 START table model agency_data_pipeline.ga_mcf_proc.......... [RUN]
2018-04-18 11:36:29,787: Re-using an available connection from the pool.
2018-04-18 11:36:29,787: Compiling model.agency_data_pipeline.fb_adcreative
2018-04-18 11:36:29,794: Acquiring new bigquery connection "shopify_refunds_proc".
2018-04-18 11:36:29,794: Compiling model.agency_data_pipeline.ga_mcf_proc
2018-04-18 11:36:29,795: Fetching data for query fb_ads_insights_conversions:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 11:36:29,801: Acquiring new bigquery connection "fb_adcreative".
2018-04-18 11:36:29,807: Re-using an available connection from the pool.
2018-04-18 11:36:29,807: Writing injected SQL for node "model.agency_data_pipeline.ga_mcf_proc"
2018-04-18 11:36:29,808: Fetching data for query shopify_refunds_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 11:36:29,808: Re-using an available connection from the pool.
2018-04-18 11:36:29,810: Fetching data for query fb_adcreative:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 11:36:29,816: Acquiring new bigquery connection "ga_mcf_proc".
2018-04-18 11:36:29,816: Re-using an available connection from the pool.
2018-04-18 11:36:31,008: Model SQL (ga_mcf_proc):
SELECT 
date,
account,
'Google Analytics' as lookup_platform,
source_medium_path,
trim(lower(split(split(source_medium_path,'->')[SAFE_ORDINAL(1)],'/')[SAFE_ORDINAL(1)])) as source,
trim(lower(split(split(source_medium_path,'->')[SAFE_ORDINAL(1)],'/')[SAFE_ORDINAL(2)])) as medium,
first_interaction_campaign campaign,
cast(regexp_replace(transaction_id, r'#', '') as int64) transactionid,
max(first_interaction_conversions) transactions,
max(first_interaction_conversion_value) revenue
FROM `growth-engines-pipeline.agency_data_pipeline.ga_mcf`
where account in (select account from `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc` where platform = 'Google Analytics')
group by date, account, source, medium, campaign, source_medium_path, lookup_platform, transactionid
2018-04-18 11:36:31,063: Writing injected SQL for node "model.agency_data_pipeline.fb_adcreative"
2018-04-18 11:36:31,211: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_insights_conversions"
2018-04-18 11:36:31,313: Writing injected SQL for node "model.agency_data_pipeline.shopify_refunds_proc"
2018-04-18 11:36:32,285: Model SQL (fb_adcreative):




with fb_adcreative as (


	    
		   	SELECT 
			id,
			object_url,
			url_tags,
			_sdc_sequence
			FROM `growth-engines-pipeline.fb_ads_luca_danni.adcreative`
		    
	   
)

select creative_id, max(url) url
from (
  select
  id creative_id,
  lower(trim(regexp_replace(replace(replace(replace(replace(object_url,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
  first_value(_sdc_sequence) OVER (PARTITION BY id ORDER BY _sdc_sequence DESC) lv,
  _sdc_sequence
  from fb_adcreative
  )
where lv = _sdc_sequence
group by creative_id


2018-04-18 11:36:32,292: Model SQL (fb_ads_insights_conversions):




with fb_ads_insights_conversions as (

	    
		   	SELECT 
			date_start,
			campaign_id,
			campaign_name,
			ad_id,
			account_name,
			spend,
			reach,
			inline_link_clicks,
			_sdc_sequence,
			action_type,
			value
			FROM `growth-engines-pipeline.fb_ads_luca_danni.ads_insights`
			cross join unnest(actions)
		    
	   

)

SELECT * 
FROM 
	(
    SELECT
    date_start date,
    campaign_id,
    campaign_name campaign,
    ad_id,
    account_name account,
    action_type,
    value conversions,
    first_value(_sdc_sequence) OVER (PARTITION BY ad_id, date_start ORDER BY _sdc_sequence DESC) lv,
    _sdc_sequence
    FROM fb_ads_insights_conversions
   	)
where lv = _sdc_sequence
and action_type like '%purchase%'


2018-04-18 11:36:32,511: Model SQL (shopify_refunds_proc):




with refunds as (

	
	SELECT
	order_number,
	checkout_id,
	financial_status,
	line_item_id,
	quantity,
	subtotal,
	line_item.variant_id variant_id,
	line_item.id refund_id,
 	_sdc_sequence
	FROM `growth-engines-pipeline.shopify_lucadanni.orders` 
	cross join unnest(refunds), unnest(refund_line_items)
  	where financial_status like '%refund%'
	
	

)

SELECT * 
FROM 
	(
    SELECT
	order_number,
	checkout_id,
	financial_status,
	line_item_id,
	quantity,
	subtotal refund_amount,
	variant_id,
	refund_id,
 	_sdc_sequence,
    first_value(_sdc_sequence) OVER (PARTITION BY order_number, line_item_id ORDER BY _sdc_sequence DESC) lv
    FROM refunds
   	) 
WHERE lv = _sdc_sequence


2018-04-18 11:36:34,523: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7ab49507-8ce8-4871-aec8-0dce4a32fc94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c591cf8>]}
2018-04-18 11:36:34,724: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7ab49507-8ce8-4871-aec8-0dce4a32fc94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c57c128>]}
2018-04-18 11:36:34,771: 11:36:34 | 16 of 93 OK created table model agency_data_pipeline.fb_adcreative... [CREATE TABLE in 4.74s]
2018-04-18 11:36:34,773: 11:36:34 | 18 of 93 START table model agency_data_pipeline.adwords_ads.......... [RUN]
2018-04-18 11:36:34,776: Compiling model.agency_data_pipeline.adwords_ads
2018-04-18 11:36:34,783: Writing injected SQL for node "model.agency_data_pipeline.adwords_ads"
2018-04-18 11:36:34,785: Acquiring new bigquery connection "adwords_ads".
2018-04-18 11:36:34,785: Re-using an available connection from the pool.
2018-04-18 11:36:35,032: 11:36:35 | 15 of 93 OK created table model agency_data_pipeline.shopify_refunds_proc [CREATE TABLE in 4.94s]
2018-04-18 11:36:35,033: 11:36:35 | 19 of 93 START table model agency_data_pipeline.fb_ads_insights...... [RUN]
2018-04-18 11:36:35,033: Compiling model.agency_data_pipeline.fb_ads_insights
2018-04-18 11:36:35,044: Acquiring new bigquery connection "fb_ads_insights".
2018-04-18 11:36:35,044: Re-using an available connection from the pool.
2018-04-18 11:36:35,044: Fetching data for query fb_ads_insights:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 11:36:35,400: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_insights"
2018-04-18 11:36:35,734: Model SQL (adwords_ads):
SELECT  
day,
campaignid,
a.account as account,
utm_campaign,
sum( case when b.goal_type = 'Transaction' then conversions else 0 end ) as transactions
FROM (

	SELECT  
	day,
	adid,
	campaignid,
	account,
	lower(conversionname) conversionname,
	conversions,
	lower(campaign) utm_campaign,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY campaignid, day ORDER BY _sdc_sequence DESC) lv
	FROM
	`growth-engines-pipeline.adwords_2.AD_PERFORMANCE_REPORT`

) a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_conversions` b
ON ( a.conversionname = b.goal_name
	AND a.account = b.account )
WHERE lv = _sdc_sequence
group by day, campaignid, account, utm_campaign
2018-04-18 11:36:36,347: Model SQL (fb_ads_insights):




with fb_ads_insights as (

	    
		   	SELECT 
			date_start,
			campaign_id,
			campaign_name,
			ad_id,
			account_name,
			spend,
			reach,
			inline_link_clicks,
			_sdc_sequence,
			first_value(_sdc_sequence) OVER (PARTITION BY date_start, ad_id, campaign_id ORDER BY _sdc_sequence DESC) lv
			FROM `growth-engines-pipeline.fb_ads_luca_danni.ads_insights`
		    
	   

)

select
date_start date,
campaign_id,
campaign_name campaign,
ad_id,
account_name account,
max(spend) cost,
max(reach) impressions,
max(inline_link_clicks) clicks
from fb_ads_insights
where lv = _sdc_sequence
group by date, campaign_id, ad_id, account, campaign


2018-04-18 11:36:36,715: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7ab49507-8ce8-4871-aec8-0dce4a32fc94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c57cbe0>]}
2018-04-18 11:36:36,858: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7ab49507-8ce8-4871-aec8-0dce4a32fc94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fb69d30>]}
2018-04-18 11:36:37,009: 11:36:37 | 17 of 93 OK created table model agency_data_pipeline.ga_mcf_proc..... [CREATE TABLE in 6.92s]
2018-04-18 11:36:37,011: 11:36:37 | 20 of 93 START table model agency_data_pipeline.bing_ads_conversions. [RUN]
2018-04-18 11:36:37,014: Compiling model.agency_data_pipeline.bing_ads_conversions
2018-04-18 11:36:37,026: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_conversions"
2018-04-18 11:36:37,029: Acquiring new bigquery connection "bing_ads_conversions".
2018-04-18 11:36:37,029: Re-using an available connection from the pool.
2018-04-18 11:36:37,311: 11:36:37 | 14 of 93 OK created table model agency_data_pipeline.fb_ads_insights_conversions [CREATE TABLE in 7.08s]
2018-04-18 11:36:37,314: 11:36:37 | 21 of 93 START table model agency_data_pipeline.mappings_ga_proc..... [RUN]
2018-04-18 11:36:37,314: Compiling model.agency_data_pipeline.mappings_ga_proc
2018-04-18 11:36:37,320: Writing injected SQL for node "model.agency_data_pipeline.mappings_ga_proc"
2018-04-18 11:36:37,321: Acquiring new bigquery connection "mappings_ga_proc".
2018-04-18 11:36:37,321: Re-using an available connection from the pool.
2018-04-18 11:36:37,952: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7ab49507-8ce8-4871-aec8-0dce4a32fc94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fb61f28>]}
2018-04-18 11:36:37,978: Model SQL (bing_ads_conversions):
SELECT
date, 
a.account account, 
a.channel channel,
a.platform platform,
campaignid,
campaignname,
sum( case when b.goal_type = 'Transactions' then conversions else 0 end ) as transactions
FROM

  ( 
SELECT  
cast(gregoriandate as date) date,
replace(accountname,',','') account,
'Paid' as channel,
'Bing Ads' as platform,
trim(replace(replace(lower(goal),',',''),' ','')) goal,
goalid,
campaignid,
campaignname,
conversions,
_sdc_sequence,
first_value(_sdc_sequence) OVER (PARTITION BY campaignid, goalid, gregoriandate ORDER BY _sdc_sequence DESC) lv
FROM `growth-engines-pipeline.bing_ads.goals_and_funnels_report` 

  ) a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`conversion_goals_proc` b
ON (
	a.account = b.account AND
	a.platform = b.platform AND
	a.goal = b.goal_name
)
where a.lv = a._sdc_sequence
group by date, account, channel, platform, campaignid, campaignname
2018-04-18 11:36:38,191: Model SQL (mappings_ga_proc):
select 
client,
account,
client_name,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
account,
client_name,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.mappings_ga` 

) 

WHERE lv = time_of_entry
and client in (select client from `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc` )
group by client, account, client_name, source, medium, platform_n, channel_n, time_of_entry
2018-04-18 11:36:38,256: 11:36:38 | 18 of 93 OK created table model agency_data_pipeline.adwords_ads..... [CREATE TABLE in 3.18s]
2018-04-18 11:36:38,573: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7ab49507-8ce8-4871-aec8-0dce4a32fc94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c591b00>]}
2018-04-18 11:36:39,258: 11:36:39 | 19 of 93 OK created table model agency_data_pipeline.fb_ads_insights. [CREATE TABLE in 3.54s]
2018-04-18 11:36:40,442: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7ab49507-8ce8-4871-aec8-0dce4a32fc94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c5be668>]}
2018-04-18 11:36:40,592: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7ab49507-8ce8-4871-aec8-0dce4a32fc94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fb69d30>]}
2018-04-18 11:36:40,724: 11:36:40 | 20 of 93 OK created table model agency_data_pipeline.bing_ads_conversions [CREATE TABLE in 3.43s]
2018-04-18 11:36:41,038: 11:36:41 | 21 of 93 OK created table model agency_data_pipeline.mappings_ga_proc [CREATE TABLE in 3.28s]
2018-04-18 11:36:41,039: 11:36:41 | 22 of 93 START table model agency_data_pipeline.fb_ads............... [RUN]
2018-04-18 11:36:41,039: Compiling model.agency_data_pipeline.fb_ads
2018-04-18 11:36:41,046: 11:36:41 | 23 of 93 START table model agency_data_pipeline.shopify_customers_proc [RUN]
2018-04-18 11:36:41,046: Compiling model.agency_data_pipeline.shopify_customers_proc
2018-04-18 11:36:41,067: Acquiring new bigquery connection "fb_ads".
2018-04-18 11:36:41,067: Re-using an available connection from the pool.
2018-04-18 11:36:41,067: Fetching data for query fb_ads:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 11:36:41,066: Acquiring new bigquery connection "shopify_customers_proc".
2018-04-18 11:36:41,068: Re-using an available connection from the pool.
2018-04-18 11:36:41,068: Fetching data for query shopify_customers_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 11:36:41,475: Writing injected SQL for node "model.agency_data_pipeline.fb_ads"
2018-04-18 11:36:41,505: Writing injected SQL for node "model.agency_data_pipeline.shopify_customers_proc"
2018-04-18 11:36:42,467: Model SQL (fb_ads):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`fb_adcreative`





with fb_ads as (

	    
		   	SELECT 
			id ad_id,
			creative.creative_id creative_id,
			_sdc_sequence
			FROM `growth-engines-pipeline.fb_ads_luca_danni.ads`
		     
	   

)

SELECT
a.ad_id,
b.creative_id,
b.url
FROM (
    SELECT
    ad_id,
    creative_id,
    first_value(_sdc_sequence) OVER (PARTITION BY ad_id ORDER BY _sdc_sequence DESC) lv,
    _sdc_sequence
    FROM fb_ads
    ) a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`fb_adcreative` b
ON (
	a.creative_id = b.creative_id 
)
WHERE a.lv = a._sdc_sequence


2018-04-18 11:36:42,510: Model SQL (shopify_customers_proc):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc`





with customers as (

	
	SELECT
	'lucadanni' client_name,
	'Shopify' as lookup_platform,
	cast(created_at as date) created_at,
	id,
	first_name,
	last_name,
	email,
	_sdc_sequence,
	first_value(_sdc_sequence) over (partition by id, _sdc_sequence order by _sdc_sequence desc) lv
	FROM `growth-engines-pipeline.shopify_lucadanni.customers` 
	
	

)

SELECT
account,
client,
platform,
id,
min(created_at) created_at,
max(first_name) first_name,
max(last_name) last_name,
max(email) email
FROM (
	SELECT
	b.account,
	b.client,
	b.platform,
	created_at,
	id,
	first_name,
	last_name,
	email
	FROM customers a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
	ON ( a.client_name = b.client_name
	  AND a.lookup_platform = b.platform )
	where a.lv = a._sdc_sequence
)
group by account, client, platform, id

2018-04-18 11:36:44,680: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7ab49507-8ce8-4871-aec8-0dce4a32fc94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fa3fd68>]}
2018-04-18 11:36:44,927: 11:36:44 | 22 of 93 OK created table model agency_data_pipeline.fb_ads.......... [CREATE TABLE in 3.64s]
2018-04-18 11:36:48,260: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7ab49507-8ce8-4871-aec8-0dce4a32fc94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fb904e0>]}
2018-04-18 11:36:48,520: 11:36:48 | 23 of 93 OK created table model agency_data_pipeline.shopify_customers_proc [CREATE TABLE in 7.21s]
2018-04-18 11:36:48,521: 11:36:48 | 24 of 93 START table model agency_data_pipeline.ga_mcf_stats......... [RUN]
2018-04-18 11:36:48,521: 11:36:48 | 25 of 93 START table model agency_data_pipeline.shopify_orders_proc.. [RUN]
2018-04-18 11:36:48,521: Compiling model.agency_data_pipeline.ga_mcf_stats
2018-04-18 11:36:48,521: 11:36:48 | 26 of 93 START table model agency_data_pipeline.agg_customers_union.. [RUN]
2018-04-18 11:36:48,522: Compiling model.agency_data_pipeline.shopify_orders_proc
2018-04-18 11:36:48,521: 11:36:48 | 27 of 93 START table model agency_data_pipeline.bing_ads_stats....... [RUN]
2018-04-18 11:36:48,533: Writing injected SQL for node "model.agency_data_pipeline.ga_mcf_stats"
2018-04-18 11:36:48,533: Compiling model.agency_data_pipeline.agg_customers_union
2018-04-18 11:36:48,549: Compiling model.agency_data_pipeline.bing_ads_stats
2018-04-18 11:36:48,556: Acquiring new bigquery connection "shopify_orders_proc".
2018-04-18 11:36:48,560: Writing injected SQL for node "model.agency_data_pipeline.agg_customers_union"
2018-04-18 11:36:48,562: Acquiring new bigquery connection "ga_mcf_stats".
2018-04-18 11:36:48,573: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_stats"
2018-04-18 11:36:48,573: Re-using an available connection from the pool.
2018-04-18 11:36:48,577: Acquiring new bigquery connection "agg_customers_union".
2018-04-18 11:36:48,578: Fetching data for query shopify_orders_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 11:36:48,578: Re-using an available connection from the pool.
2018-04-18 11:36:48,583: Re-using an available connection from the pool.
2018-04-18 11:36:48,597: Acquiring new bigquery connection "bing_ads_stats".
2018-04-18 11:36:48,598: Re-using an available connection from the pool.
2018-04-18 11:36:48,994: Writing injected SQL for node "model.agency_data_pipeline.shopify_orders_proc"
2018-04-18 11:36:49,635: Model SQL (bing_ads_stats):
select
a.date, 
a.account, 
a.channel,
a.platform,
url,
a.campaignname campaign,
utm_campaign,
cost,
clicks,
impressions,
transactions
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`bing_ads_ads` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`bing_ads_conversions` b
ON (
	a.date = b.date AND
	a.account = b.account AND
	a.campaignid = b.campaignid

)
2018-04-18 11:36:49,671: Model SQL (agg_customers_union):
SELECT *
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`shopify_customers_proc`
2018-04-18 11:36:49,721: Model SQL (ga_mcf_stats):
SELECT  
date,
a.account account,
b.client client,
case when c.platform is null then "Unmapped" else c.platform end as platform,
case when c.channel is null then "Unmapped" else c.channel end as channel,
lower(a.source) source,
lower(a.medium) medium,
lower(campaign) campaign,
transactionid,
sum(transactions) first_touch_transactions,
sum(revenue) first_touch_revenue
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`ga_mcf_proc` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc` b 
ON ( a.account = b.account and
	a.lookup_platform = b.platform )
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc` c
ON ( lower(a.source) = c.source
  AND lower(a.medium) = c.medium 
  and a.account = c.account )
group by date, account, client, source, medium, campaign, platform, channel, transactionid
2018-04-18 11:36:50,029: Model SQL (shopify_orders_proc):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc`, `growth-engines-pipeline`.`agency_data_pipeline`.`shopify_refunds_proc`





with orders as (

	
	SELECT
	'lucadanni' client_name,
	'Shopify' as lookup_platform,
	created_at,
	order_number,
	quantity,
	cast(pre_tax_price as float64) price, 
	total_line_items_price total_order_price_undiscounted,
	total_discounts,
	cast(discounted_price as float64) total_order_shipping_price,
	total_price_usd total_order_price_incl_shipping,
	checkout_id,
	product_id, 
	landing_site,
	sku, 
	variant_title, 
	variant_id,
	_id line_item_id,
	customer.id customer_id,
	customer.orders_count orders_count,
	customer.created_at customer_created_at,
	customer.last_order_id last_order_id,
	financial_status,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY order_number, _id ORDER BY _sdc_sequence DESC) lv
	FROM `growth-engines-pipeline.shopify_lucadanni.orders` 
	cross join unnest(line_items), unnest(shipping_lines)
	where source_name != 'shopify_draft_order'
	
	

)

SELECT
b.account,
b.client,
b.platform,
created_at,
a.order_number,
a.quantity,
c.quantity refund_quantity,
case when c.quantity is not null then a.quantity - c.quantity else a.quantity end as final_quantity,
price, 
total_order_price_undiscounted,
total_discounts,
total_order_shipping_price,
total_order_price_incl_shipping,
refund_amount,
case when refund_amount is not null then price - refund_amount else price end as final_price,
a.checkout_id,
a.product_id, 
landing_site,
sku, 
variant_title, 
a.variant_id,
a.line_item_id,	
customer_id,
orders_count,
customer_created_at,
last_order_id,
a.financial_status
FROM orders a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
ON ( a.client_name = b.client_name
  AND a.lookup_platform = b.platform )
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`shopify_refunds_proc` c
ON ( a.order_number = c.order_number
	AND a.line_item_id = c.line_item_id )   	
where a.lv = a._sdc_sequence


2018-04-18 11:36:51,862: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7ab49507-8ce8-4871-aec8-0dce4a32fc94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c5ae5f8>]}
2018-04-18 11:36:52,108: 11:36:52 | 27 of 93 OK created table model agency_data_pipeline.bing_ads_stats.. [CREATE TABLE in 3.31s]
2018-04-18 11:36:52,109: 11:36:52 | 28 of 93 START table model agency_data_pipeline.shopify_products_proc [RUN]
2018-04-18 11:36:52,110: Compiling model.agency_data_pipeline.shopify_products_proc
2018-04-18 11:36:52,121: Acquiring new bigquery connection "shopify_products_proc".
2018-04-18 11:36:52,121: Re-using an available connection from the pool.
2018-04-18 11:36:52,121: Fetching data for query shopify_products_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 11:36:52,631: Writing injected SQL for node "model.agency_data_pipeline.shopify_products_proc"
2018-04-18 11:36:53,785: Model SQL (shopify_products_proc):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc`, `growth-engines-pipeline`.`agency_data_pipeline`.`shopify_refunds_proc`





with products as (

	
	SELECT
	'lucadanni' client_name,
	'Shopify' as lookup_platform,
	product_type,
	product_id,
	sku,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY product_id ORDER BY _sdc_sequence DESC) lv
	FROM `growth-engines-pipeline.shopify_lucadanni.products` 
	cross join unnest(variants)
	
	

)

SELECT
b.account,
b.client,
b.platform,
max(product_type) product_type,
product_id,
sku
FROM products a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
ON ( a.client_name = b.client_name
  AND a.lookup_platform = b.platform )
where a.lv = a._sdc_sequence
group by product_id, account, client, platform, sku


2018-04-18 11:36:54,145: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7ab49507-8ce8-4871-aec8-0dce4a32fc94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c5842b0>]}
2018-04-18 11:36:54,159: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7ab49507-8ce8-4871-aec8-0dce4a32fc94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fb69d30>]}
2018-04-18 11:36:54,413: 11:36:54 | 26 of 93 OK created table model agency_data_pipeline.agg_customers_union [CREATE TABLE in 5.61s]
2018-04-18 11:36:54,672: 11:36:54 | 24 of 93 OK created table model agency_data_pipeline.ga_mcf_stats.... [CREATE TABLE in 5.64s]
2018-04-18 11:36:57,115: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7ab49507-8ce8-4871-aec8-0dce4a32fc94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fa3fd68>]}
2018-04-18 11:36:57,369: 11:36:57 | 28 of 93 OK created table model agency_data_pipeline.shopify_products_proc [CREATE TABLE in 5.00s]
2018-04-18 11:36:57,959: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7ab49507-8ce8-4871-aec8-0dce4a32fc94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fb7f048>]}
2018-04-18 11:36:58,206: 11:36:58 | 25 of 93 OK created table model agency_data_pipeline.shopify_orders_proc [CREATE TABLE in 9.44s]
2018-04-18 11:36:58,207: 11:36:58 | 29 of 93 START table model agency_data_pipeline.agg_products......... [RUN]
2018-04-18 11:36:58,208: 11:36:58 | 30 of 93 START table model agency_data_pipeline.ga_transactions...... [RUN]
2018-04-18 11:36:58,209: Compiling model.agency_data_pipeline.ga_transactions
2018-04-18 11:36:58,208: Compiling model.agency_data_pipeline.agg_products
2018-04-18 11:36:58,208: 11:36:58 | 31 of 93 START table model agency_data_pipeline.adwords_join......... [RUN]
2018-04-18 11:36:58,227: Compiling model.agency_data_pipeline.adwords_join
2018-04-18 11:36:58,209: 11:36:58 | 32 of 93 START table model agency_data_pipeline.ga_traffic........... [RUN]
2018-04-18 11:36:58,241: Writing injected SQL for node "model.agency_data_pipeline.agg_products"
2018-04-18 11:36:58,241: Compiling model.agency_data_pipeline.ga_traffic
2018-04-18 11:36:58,244: Writing injected SQL for node "model.agency_data_pipeline.adwords_join"
2018-04-18 11:36:58,245: Acquiring new bigquery connection "ga_transactions".
2018-04-18 11:36:58,258: Re-using an available connection from the pool.
2018-04-18 11:36:58,260: Acquiring new bigquery connection "ga_traffic".
2018-04-18 11:36:58,261: Fetching data for query ga_transactions:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Google Analytics'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 11:36:58,261: Re-using an available connection from the pool.
2018-04-18 11:36:58,262: Fetching data for query ga_traffic:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'GA Traffic'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 11:36:58,261: Acquiring new bigquery connection "agg_products".
2018-04-18 11:36:58,263: Re-using an available connection from the pool.
2018-04-18 11:36:58,264: Acquiring new bigquery connection "adwords_join".
2018-04-18 11:36:58,264: Re-using an available connection from the pool.
2018-04-18 11:36:59,220: Model SQL (adwords_join):
select
a.day,
a.campaignid, 
a.campaign,
a.account, 
channel,
platform,
url,
utm_campaign,
cost,
impressions,
clicks,
impression_share_num,
impression_share_den,
transactions
FROM ( 
	
	select
	day,
	a.campaign,
	a.campaignid, 
	account, 
	channel,
	platform,
	url,
	cost,
	impressions,
	clicks,
	impression_share_num,
	impression_share_den
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_campaigns` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_urls` b
	ON a.campaignid = b.campaignid

) a 
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_ads` b
ON ( a.campaignid = b.campaignid
	and a.day = b.day )
2018-04-18 11:36:59,230: Model SQL (agg_products):
SELECT 
account,
client,
platform,
product_type,
product_id,
sku
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`shopify_products_proc`
2018-04-18 11:36:59,581: Fetching data for query ga_transactions:


        select
            goal_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_conversions`

        
        ##where 1 = 1
        where goal_type = 'Conversion'
        
        
        
        ##and 2 = 2
        and client_name = 'lucadanni'
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 11:36:59,798: Fetching data for query ga_traffic:


        select
            goal_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_conversions`

        
        ##where 1 = 1
        where goal_type = 'Conversion'
        
        
        
        ##and 2 = 2
        and client_name = 'lucadanni'
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 11:37:00,327: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7ab49507-8ce8-4871-aec8-0dce4a32fc94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fb69d30>]}
2018-04-18 11:37:00,570: 11:37:00 | 29 of 93 OK created table model agency_data_pipeline.agg_products.... [CREATE TABLE in 2.12s]
2018-04-18 11:37:00,775: Writing injected SQL for node "model.agency_data_pipeline.ga_transactions"
2018-04-18 11:37:00,990: Writing injected SQL for node "model.agency_data_pipeline.ga_traffic"
2018-04-18 11:37:01,734: Model SQL (ga_transactions):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc`, `growth-engines-pipeline`.`agency_data_pipeline`.`ga_conversions`


##`growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` 



with ga_report as (

	    

	    	
	    	
		   	SELECT
		   	'lucadanni' as client_name,
		   	'Google Analytics' as lookup_platform,
			lower(trim(regexp_replace(replace(replace(replace(replace(CONCAT(hostname,landingpagepath),'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
			date,
			lower(source) source,
			lower(medium) medium,
			lower(campaign) campaign,
			cast(regexp_replace(transactionid, r'#', '') as int64) transactionid,
			transactions last_touch_transactions,
			(transactionrevenue - transactionshipping - transactiontax) as last_touch_revenue,
			transactionshipping,
			transactiontax,
			_sdc_sequence,
			first_value(_sdc_sequence) OVER (PARTITION BY hostname, landingpagepath, date, source, medium, transactionid ORDER BY _sdc_sequence DESC) lv
			FROM `growth-engines-pipeline.ga_lucadanni.report` 

		    
	   

)


SELECT  
cast(date as date) date,
b.account,
b.client client,
c.source source,
c.medium medium,
a.campaign campaign,
concat(a.source, ' / ', a.medium) source_medium,  
case when c.platform is null then "Unmapped" else c.platform end as platform,
case when c.channel is null then "Unmapped" else c.channel end as channel,
regexp_replace(url, r'offers.|offer.|get.|info.|pos.|go.|join.|pages.','') url,
transactionid,
max(last_touch_transactions) last_touch_transactions,
max(last_touch_revenue) last_touch_revenue,
max(transactionshipping) last_touch_shipping,
max(transactiontax) last_touch_tax
FROM ga_report a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
ON ( a.client_name = b.client_name 
	AND a.lookup_platform = b.platform )
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc` c
ON ( a.source = c.source
  AND a.medium = c.medium 
  AND a.client_name = c.client_name )
GROUP BY date, account, client, source, medium, campaign, source_medium, platform, channel, url, transactionid


2018-04-18 11:37:01,908: Model SQL (ga_traffic):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc`, `growth-engines-pipeline`.`agency_data_pipeline`.`ga_conversions`


##`growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` 



with ga_report as (

	    

	    	
	    	
		   	SELECT
		   	'lucadanni' as client_name,
		   	'GA Traffic' as lookup_platform,
			lower(trim(regexp_replace(replace(replace(replace(replace(CONCAT(hostname,landingpagepath),'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
			date,
			lower(source) source,
			lower(medium) medium,
			lower(campaign) campaign,
			sessions,
			## goal completion columns
							
				goalcompletionsall as goal_completions,		
			
			_sdc_sequence,
			first_value(_sdc_sequence) OVER (PARTITION BY hostname, landingpagepath, date, source, medium, campaign ORDER BY _sdc_sequence DESC) lv
			FROM `growth-engines-pipeline.ga_lucadanni_traffic.report` 

		    
	   

)


SELECT  
cast(date as date) date,
b.account,
b.client client,
c.source source,
c.medium medium,
a.campaign campaign,
concat(a.source, ' / ', a.medium) source_medium,  
case when c.platform is null then "Unmapped" else c.platform end as platform,
case when c.channel is null then "Unmapped" else c.channel end as channel,
regexp_replace(url, r'offers.|offer.|get.|info.|pos.|go.|join.|pages.','') url,
max(sessions) sessions,
max(goal_completions) goal_completions
FROM ga_report a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
ON ( a.client_name = b.client_name 
	AND a.lookup_platform = b.platform )
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc` c
ON ( a.source = c.source
  AND a.medium = c.medium 
  AND a.client_name = c.client_name )
GROUP BY date, account, client, source, medium, campaign, source_medium, platform, channel, url


2018-04-18 11:37:03,663: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7ab49507-8ce8-4871-aec8-0dce4a32fc94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fb7f978>]}
2018-04-18 11:37:03,927: 11:37:03 | 31 of 93 OK created table model agency_data_pipeline.adwords_join.... [CREATE TABLE in 5.44s]
2018-04-18 11:37:08,834: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7ab49507-8ce8-4871-aec8-0dce4a32fc94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c591be0>]}
2018-04-18 11:37:09,090: 11:37:09 | 30 of 93 OK created table model agency_data_pipeline.ga_transactions. [CREATE TABLE in 10.63s]
2018-04-18 11:37:14,382: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7ab49507-8ce8-4871-aec8-0dce4a32fc94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fb90da0>]}
2018-04-18 11:37:15,135: 11:37:15 | 32 of 93 OK created table model agency_data_pipeline.ga_traffic...... [CREATE TABLE in 16.14s]
2018-04-18 11:37:15,135: 11:37:15 | 33 of 93 START table model agency_data_pipeline.adwords_impression_share [RUN]
2018-04-18 11:37:15,136: 11:37:15 | 34 of 93 START table model agency_data_pipeline.fb_ads_stats......... [RUN]
2018-04-18 11:37:15,136: Compiling model.agency_data_pipeline.adwords_impression_share
2018-04-18 11:37:15,136: 11:37:15 | 35 of 93 START table model agency_data_pipeline.adwords_stats........ [RUN]
2018-04-18 11:37:15,136: Compiling model.agency_data_pipeline.fb_ads_stats
2018-04-18 11:37:15,142: Writing injected SQL for node "model.agency_data_pipeline.adwords_impression_share"
2018-04-18 11:37:15,143: Compiling model.agency_data_pipeline.adwords_stats
2018-04-18 11:37:15,149: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_stats"
2018-04-18 11:37:15,153: Writing injected SQL for node "model.agency_data_pipeline.adwords_stats"
2018-04-18 11:37:15,154: Acquiring new bigquery connection "adwords_impression_share".
2018-04-18 11:37:15,155: Re-using an available connection from the pool.
2018-04-18 11:37:15,157: Acquiring new bigquery connection "adwords_stats".
2018-04-18 11:37:15,157: Re-using an available connection from the pool.
2018-04-18 11:37:15,159: Acquiring new bigquery connection "fb_ads_stats".
2018-04-18 11:37:15,159: Re-using an available connection from the pool.
2018-04-18 11:37:16,655: Model SQL (fb_ads_stats):
with cost as (

    select 
        date, account, ad_id, campaign,
        cost, impressions, clicks, null as conversions
    from `growth-engines-pipeline`.`agency_data_pipeline`.`fb_ads_insights`
),

conversions as (

    select 
        date, account, ad_id, campaign,
        null as cost, null as impressions, null as clicks, conversions
    from `growth-engines-pipeline`.`agency_data_pipeline`.`fb_ads_insights_conversions`
),

urls as (

    select ad_id, url
    from `growth-engines-pipeline`.`agency_data_pipeline`.`fb_ads`
)


SELECT
    cast(date as date) date,
    'FB Ads' platform,
    'Paid' channel,
    account, 
    b.url url,
    campaign,
    lower(campaign) utm_campaign, 
    sum(cost) cost,
    sum(impressions) impressions,
    sum(clicks) clicks,
    sum(conversions) transactions
FROM
(
    SELECT *
    FROM 
      cost
    UNION ALL
    SELECT *
    FROM 
      conversions
) a
LEFT JOIN urls b
ON ( a.ad_id = b.ad_id )
group by date, platform, channel, account, url, campaign, utm_campaign
2018-04-18 11:37:16,655: Model SQL (adwords_impression_share):
SELECT 
cast(day as date) date, 
account, 
channel,
platform,
sum(impression_share_num) impressions,
sum(impression_share_den) available_impressions
FROM 
  `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_join`
group by date, account, platform, channel
2018-04-18 11:37:16,800: Model SQL (adwords_stats):
SELECT 
cast(day as date) date, 
account, 
platform,
channel,
url,
utm_campaign,
campaign,
sum(cost) cost,
sum(impressions) impressions,
sum(clicks) clicks,
sum(transactions) transactions
FROM 
  `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_join`
group by date, account, platform, channel, url, campaign, utm_campaign
2018-04-18 11:37:18,157: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7ab49507-8ce8-4871-aec8-0dce4a32fc94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fa3fd68>]}
2018-04-18 11:37:18,160: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7ab49507-8ce8-4871-aec8-0dce4a32fc94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fb40c50>]}
2018-04-18 11:37:19,338: 11:37:19 | 33 of 93 OK created table model agency_data_pipeline.adwords_impression_share [CREATE TABLE in 3.02s]
2018-04-18 11:37:19,743: 11:37:19 | 34 of 93 OK created table model agency_data_pipeline.fb_ads_stats.... [CREATE TABLE in 3.02s]
2018-04-18 11:37:21,550: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7ab49507-8ce8-4871-aec8-0dce4a32fc94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fb7f048>]}
2018-04-18 11:37:22,107: 11:37:22 | 35 of 93 OK created table model agency_data_pipeline.adwords_stats... [CREATE TABLE in 6.41s]
2018-04-18 11:37:22,124: 11:37:22 | 36 of 93 START table model agency_data_pipeline.agg_products_cogs.... [RUN]
2018-04-18 11:37:22,124: Compiling model.agency_data_pipeline.agg_products_cogs
2018-04-18 11:37:22,234: Writing injected SQL for node "model.agency_data_pipeline.agg_products_cogs"
2018-04-18 11:37:22,236: Acquiring new bigquery connection "agg_products_cogs".
2018-04-18 11:37:22,237: Re-using an available connection from the pool.
2018-04-18 11:37:23,403: Model SQL (agg_products_cogs):
with cogs_all as (

	SELECT 
	client,
	cogs_dol,
	cogs_pct
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`cogs_proc`
	WHERE sku = 'All'

),

cogs_sku as (

	SELECT 
	client,
	sku,
	cogs_dol,
	cogs_pct
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`cogs_proc`
	WHERE sku != 'All'

),

products as (

	SELECT 
	client,
	product_type,
	product_id,
	sku
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_products`

)


SELECT 
a.client,
product_type,
product_id,
sku,
b.cogs_dol,
b.cogs_pct
FROM products a
LEFT JOIN cogs_all b
ON (
	a.client = b.client
)
WHERE b.cogs_dol > 0 or b.cogs_pct > 0

UNION ALL

SELECT 
c.client,
product_type,
product_id,
c.sku,
d.cogs_dol,
d.cogs_pct
FROM products c
LEFT JOIN cogs_sku d
ON (
	c.client = d.client and
	c.sku = d.sku
)
WHERE d.cogs_dol > 0 or d.cogs_pct > 0
2018-04-18 11:37:25,649: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7ab49507-8ce8-4871-aec8-0dce4a32fc94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c5c35c0>]}
2018-04-18 11:37:26,056: 11:37:26 | 36 of 93 OK created table model agency_data_pipeline.agg_products_cogs [CREATE TABLE in 3.52s]
2018-04-18 11:37:26,057: 11:37:26 | 37 of 93 START table model agency_data_pipeline.agg_ga_transaction_order_number [RUN]
2018-04-18 11:37:26,057: Compiling model.agency_data_pipeline.agg_ga_transaction_order_number
2018-04-18 11:37:26,067: Writing injected SQL for node "model.agency_data_pipeline.agg_ga_transaction_order_number"
2018-04-18 11:37:26,071: Acquiring new bigquery connection "agg_ga_transaction_order_number".
2018-04-18 11:37:26,072: Re-using an available connection from the pool.
2018-04-18 11:37:27,473: Model SQL (agg_ga_transaction_order_number):
with ga as (

    select 
        date, account, client, 
        channel as last_touch_channel, 
        platform as last_touch_platform, 
        url as last_touch_url, 
        campaign as last_touch_utm_campaign, 
        '' as first_touch_channel, 
        '' as first_touch_platform, 
        '' as first_touch_utm_campaign, 
        transactionid,
        last_touch_transactions, last_touch_revenue,
        last_touch_shipping, last_touch_tax,
        null as first_touch_transactions, null as first_touch_revenue
    from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_transactions`

),

ga_mcf as (

    select 
        date, account, client, 
        '' as last_touch_channel,
        '' as last_touch_platform,
        '' as last_touch_url,
        '' as last_touch_utm_campaign, 
        channel as first_touch_channel, 
        platform as first_touch_platform, 
        campaign as first_touch_utm_campaign, 
        transactionid, 
        null as last_touch_transactions, null as last_touch_revenue,
        null as last_touch_shipping, null as last_touch_tax,
        first_touch_transactions, first_touch_revenue
    from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_mcf_stats`

)


SELECT
    date, 
    client,
    transactionid,
    max(last_touch_channel) last_touch_channel, 
    max(last_touch_platform) last_touch_platform, 
    max(last_touch_url) last_touch_url, 
    max(last_touch_utm_campaign) last_touch_utm_campaign, 
    max(first_touch_channel) first_touch_channel, 
    max(first_touch_platform) first_touch_platform, 
    max(first_touch_utm_campaign) first_touch_utm_campaign,
    sum(last_touch_transactions) last_touch_transactions,
    sum(last_touch_revenue) last_touch_revenue,
    sum(last_touch_shipping) last_touch_shipping_revenue,
    sum(last_touch_tax) last_touch_tax_revenue,
    sum(first_touch_transactions) first_touch_transactions,
    sum(first_touch_revenue) - ifnull(sum(last_touch_shipping),0) - ifnull(sum(last_touch_tax),0) first_touch_revenue
FROM
(
    SELECT *
    FROM 
      ga
    UNION ALL
    SELECT *
    FROM 
      ga_mcf
) 
GROUP BY
    date, client, transactionid
2018-04-18 11:37:31,992: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7ab49507-8ce8-4871-aec8-0dce4a32fc94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fb7f048>]}
2018-04-18 11:37:32,273: 11:37:32 | 37 of 93 OK created table model agency_data_pipeline.agg_ga_transaction_order_number [CREATE TABLE in 5.93s]
2018-04-18 11:37:32,274: 11:37:32 | 38 of 93 START table model agency_data_pipeline.agg_ga_campaign...... [RUN]
2018-04-18 11:37:32,275: Compiling model.agency_data_pipeline.agg_ga_campaign
2018-04-18 11:37:32,275: 11:37:32 | 39 of 93 START table model agency_data_pipeline.agg_orders_union..... [RUN]
2018-04-18 11:37:32,282: Compiling model.agency_data_pipeline.agg_orders_union
2018-04-18 11:37:32,291: Writing injected SQL for node "model.agency_data_pipeline.agg_ga_campaign"
2018-04-18 11:37:32,293: Writing injected SQL for node "model.agency_data_pipeline.agg_orders_union"
2018-04-18 11:37:32,296: Acquiring new bigquery connection "agg_ga_campaign".
2018-04-18 11:37:32,296: Re-using an available connection from the pool.
2018-04-18 11:37:32,298: Acquiring new bigquery connection "agg_orders_union".
2018-04-18 11:37:32,298: Re-using an available connection from the pool.
2018-04-18 11:37:33,256: Model SQL (agg_ga_campaign):
with ga_transactions as (

	select 
		date, account, client, channel, platform, url, 
		campaign,
		null as sessions, null as goal_completions, last_touch_transactions, last_touch_revenue,
		last_touch_shipping, last_touch_tax,
		null as first_touch_transactions, null as first_touch_revenue
	from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_transactions`

),

ga_traffic as (

    select 
        date, account, client, channel, platform, url, 
        campaign,
        sessions, goal_completions, null as last_touch_transactions, null as last_touch_revenue,
        null as last_touch_shipping, null as last_touch_tax,
        null as first_touch_transactions, null as first_touch_revenue
    from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_traffic`

),

ga_mcf as (

	select 
		date, account, client, channel, platform, '' as url,
		campaign, 
		null as sessions, null as goal_completions, null as last_touch_transactions, null as last_touch_revenue,
		null as last_touch_shipping, null as last_touch_tax,
		first_touch_transactions, first_touch_revenue
	from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_mcf_stats`

)


SELECT
    date, 
    client,
    platform,
    channel, 
    url,
    campaign utm_campaign,
	sum(sessions) sessions,
	sum(goal_completions) goal_completions,
	sum(last_touch_transactions) last_touch_transactions,
	sum(last_touch_revenue) last_touch_revenue,
    sum(last_touch_shipping) last_touch_shipping_revenue,
    sum(last_touch_tax) last_touch_tax_revenue,
    sum(first_touch_transactions) first_touch_transactions,
    sum(first_touch_revenue) - sum(ifnull(last_touch_shipping,0)) - sum(ifnull(last_touch_tax,0)) first_touch_revenue

FROM
(
    SELECT *
    FROM 
      ga_transactions
    UNION ALL
    SELECT *
    FROM 
      ga_traffic
    UNION ALL
    SELECT *
    FROM 
      ga_mcf
) 
GROUP BY
    date, client, platform, channel, url, utm_campaign
2018-04-18 11:37:33,289: Model SQL (agg_orders_union):
with shopify as (
	SELECT
	account,
	client,
	platform,
	created_at,
	order_number,
	quantity,
	refund_quantity,
	final_quantity,
	price, 
	total_order_price_undiscounted,
	total_discounts,
	total_order_shipping_price,
	total_order_price_incl_shipping,
	refund_amount,
	final_price,
	checkout_id,
	product_id, 
	landing_site,
	sku, 
	variant_title, 
	variant_id,
	line_item_id,	
	customer_id,
	orders_count,
	customer_created_at,
	last_order_id,
	financial_status
	FROM
	`growth-engines-pipeline`.`agency_data_pipeline`.`shopify_orders_proc`
)

SELECT 
account,
a.client,
platform,
created_at,
order_number,
quantity,
refund_quantity,
final_quantity,
price, 
total_order_price_undiscounted,
total_discounts,
total_order_shipping_price,
total_order_price_incl_shipping,
refund_amount,
final_price,
case when b.cogs_dol > 0 then b.cogs_dol
	when b.cogs_pct > 0 then final_price * b.cogs_pct
	else null end as cogs,
case when b.cogs_dol > 0 then final_price - b.cogs_dol
	when b.cogs_pct > 0 then final_price * (1 - b.cogs_pct) 
	else final_price end as net_price, 
checkout_id,
product_id, 
landing_site,
a.sku, 
variant_title, 
variant_id,
line_item_id,	
customer_id,
orders_count,
customer_created_at,
last_order_id,
financial_status,
b.cogs_dol,
b.cogs_pct
FROM (

	SELECT * FROM shopify

) a 
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`agg_products_cogs` b
ON ( 
	a.client = b.client
	and a.sku = b.sku
)
2018-04-18 11:37:33,290: Bad request while running:
with shopify as (
	SELECT
	account,
	client,
	platform,
	created_at,
	order_number,
	quantity,
	refund_quantity,
	final_quantity,
	price, 
	total_order_price_undiscounted,
	total_discounts,
	total_order_shipping_price,
	total_order_price_incl_shipping,
	refund_amount,
	final_price,
	checkout_id,
	product_id, 
	landing_site,
	sku, 
	variant_title, 
	variant_id,
	line_item_id,	
	customer_id,
	orders_count,
	customer_created_at,
	last_order_id,
	financial_status
	FROM
	`growth-engines-pipeline`.`agency_data_pipeline`.`shopify_orders_proc`
)

SELECT 
account,
a.client,
platform,
created_at,
order_number,
quantity,
refund_quantity,
final_quantity,
price, 
total_order_price_undiscounted,
total_discounts,
total_order_shipping_price,
total_order_price_incl_shipping,
refund_amount,
final_price,
case when b.cogs_dol > 0 then b.cogs_dol
	when b.cogs_pct > 0 then final_price * b.cogs_pct
	else null end as cogs,
case when b.cogs_dol > 0 then final_price - b.cogs_dol
	when b.cogs_pct > 0 then final_price * (1 - b.cogs_pct) 
	else final_price end as net_price, 
checkout_id,
product_id, 
landing_site,
a.sku, 
variant_title, 
variant_id,
line_item_id,	
customer_id,
orders_count,
customer_created_at,
last_order_id,
financial_status,
b.cogs_dol,
b.cogs_pct
FROM (

	SELECT * FROM shopify

) a 
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`agg_products_cogs` b
ON ( 
	a.client = b.client
	and a.sku = b.sku
)
2018-04-18 11:37:33,290: 400 Column name product_id is ambiguous at [57:1]
2018-04-18 11:37:33,291: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7ab49507-8ce8-4871-aec8-0dce4a32fc94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ce02978>]}
2018-04-18 11:37:33,576: 11:37:33 | 39 of 93 ERROR creating table model agency_data_pipeline.agg_orders_union [ERROR in 1.01s]
2018-04-18 11:37:43,517: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7ab49507-8ce8-4871-aec8-0dce4a32fc94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fb40e48>]}
2018-04-18 11:37:45,168: 11:37:45 | 38 of 93 OK created table model agency_data_pipeline.agg_ga_campaign. [CREATE TABLE in 11.24s]
2018-04-18 11:37:45,170: 11:37:45 | 40 of 93 SKIP relation agency_data_pipeline.agg_transaction_order_number [SKIP]
2018-04-18 11:37:45,170: 11:37:45 | 41 of 93 SKIP relation agency_data_pipeline.agg_transaction_line_item [SKIP]
2018-04-18 11:37:45,171: 11:37:45 | 42 of 93 SKIP relation agency_data_pipeline.agg_transaction_line_item_type [SKIP]
2018-04-18 11:37:45,171: 11:37:45 | 43 of 93 SKIP relation agency_data_pipeline.customers_by_transaction. [SKIP]
2018-04-18 11:37:45,172: 11:37:45 | 44 of 93 SKIP relation agency_data_pipeline.customers_first_purchase_product_type_proc [SKIP]
2018-04-18 11:37:45,172: 11:37:45 | 45 of 93 SKIP relation agency_data_pipeline.agg_transaction_product_type [SKIP]
2018-04-18 11:37:45,172: 11:37:45 | 46 of 93 SKIP relation agency_data_pipeline.frequency_proc........... [SKIP]
2018-04-18 11:37:45,173: 11:37:45 | 47 of 93 SKIP relation agency_data_pipeline.order_paths_proc......... [SKIP]
2018-04-18 11:37:45,173: 11:37:45 | 48 of 93 SKIP relation agency_data_pipeline.frequency_stats.......... [SKIP]
2018-04-18 11:37:45,173: 11:37:45 | 49 of 93 SKIP relation agency_data_pipeline.customers_products_proc.. [SKIP]
2018-04-18 11:37:45,173: 11:37:45 | 50 of 93 SKIP relation agency_data_pipeline.products_proc............ [SKIP]
2018-04-18 11:37:45,174: 11:37:45 | 51 of 93 SKIP relation agency_data_pipeline.order_paths_agg.......... [SKIP]
2018-04-18 11:37:45,175: 11:37:45 | 52 of 93 SKIP relation agency_data_pipeline.segment_proc_sku......... [SKIP]
2018-04-18 11:37:45,175: 11:37:45 | 53 of 93 SKIP relation agency_data_pipeline.segment_stats_sku........ [SKIP]
2018-04-18 11:37:45,175: 11:37:45 | 54 of 93 SKIP relation agency_data_pipeline.segment_proc_customers_products [SKIP]
2018-04-18 11:37:45,176: 11:37:45 | 55 of 93 SKIP relation agency_data_pipeline.segment_stats_category... [SKIP]
2018-04-18 11:37:45,176: 11:37:45 | 56 of 93 SKIP relation agency_data_pipeline.segment_stats_customers_products_agg [SKIP]
2018-04-18 11:37:45,176: 11:37:45 | 57 of 93 SKIP relation agency_data_pipeline.order_paths_stats........ [SKIP]
2018-04-18 11:37:45,177: 11:37:45 | 58 of 93 START table model agency_data_pipeline.agg_platforms_union.. [RUN]
2018-04-18 11:37:45,178: 11:37:45 | 59 of 93 SKIP relation agency_data_pipeline.segment_stats_customers_products [SKIP]
2018-04-18 11:37:45,178: Compiling model.agency_data_pipeline.agg_platforms_union
2018-04-18 11:37:45,178: 11:37:45 | 60 of 93 SKIP relation agency_data_pipeline.agg_transaction.......... [SKIP]
2018-04-18 11:37:45,178: 11:37:45 | 61 of 93 SKIP relation agency_data_pipeline.agg_ga_transaction....... [SKIP]
2018-04-18 11:37:45,194: Writing injected SQL for node "model.agency_data_pipeline.agg_platforms_union"
2018-04-18 11:37:45,195: Acquiring new bigquery connection "agg_platforms_union".
2018-04-18 11:37:45,196: Re-using an available connection from the pool.
2018-04-18 11:37:47,062: Model SQL (agg_platforms_union):
SELECT 
date, 
account, 
channel,
platform,
url,
utm_campaign,
campaign,
cost,
impressions,
clicks,
transactions
FROM 
`growth-engines-pipeline`.`agency_data_pipeline`.`adwords_stats`

UNION ALL

SELECT 
date, 
account, 
channel,
platform,
url,
utm_campaign,
campaign,
cost,
impressions,
clicks,
transactions
FROM 
`growth-engines-pipeline`.`agency_data_pipeline`.`bing_ads_stats`

UNION ALL  

SELECT 
date, 
account, 
channel,
platform,
url,
utm_campaign,
campaign,
cost,
impressions,
clicks,
transactions
FROM 
`growth-engines-pipeline`.`agency_data_pipeline`.`fb_ads_stats`
2018-04-18 11:37:52,148: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7ab49507-8ce8-4871-aec8-0dce4a32fc94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fb405f8>]}
2018-04-18 11:37:53,887: 11:37:53 | 58 of 93 OK created table model agency_data_pipeline.agg_platforms_union [CREATE TABLE in 6.97s]
2018-04-18 11:37:53,889: 11:37:53 | 62 of 93 SKIP relation agency_data_pipeline.agg_ga_campaign_by_type.. [SKIP]
2018-04-18 11:37:53,890: 11:37:53 | 63 of 93 SKIP relation agency_data_pipeline.agg_transaction_daily.... [SKIP]
2018-04-18 11:37:53,890: 11:37:53 | 64 of 93 SKIP relation agency_data_pipeline.customers_first_purchase_proc [SKIP]
2018-04-18 11:37:53,890: 11:37:53 | 65 of 93 SKIP relation agency_data_pipeline.segment_list_customers_products [SKIP]
2018-04-18 11:37:53,892: 11:37:53 | 66 of 93 SKIP relation agency_data_pipeline.growth_customer_0_365.... [SKIP]
2018-04-18 11:37:53,892: 11:37:53 | 67 of 93 START table model agency_data_pipeline.agg_platforms_client. [RUN]
2018-04-18 11:37:53,892: 11:37:53 | 68 of 93 SKIP relation agency_data_pipeline.customers_proc........... [SKIP]
2018-04-18 11:37:53,893: Compiling model.agency_data_pipeline.agg_platforms_client
2018-04-18 11:37:53,916: Writing injected SQL for node "model.agency_data_pipeline.agg_platforms_client"
2018-04-18 11:37:53,919: Acquiring new bigquery connection "agg_platforms_client".
2018-04-18 11:37:53,919: Re-using an available connection from the pool.
2018-04-18 11:37:56,629: Model SQL (agg_platforms_client):
SELECT 
date, 
a.account account, 
b.client client,
a.platform platform,
a.channel channel,
url,
utm_campaign,
campaign,
cost,
impressions,
clicks,
transactions ad_platform_transactions
FROM 
  `growth-engines-pipeline`.`agency_data_pipeline`.`agg_platforms_union` a
LEFT JOIN 
  `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc` b
ON ( 
  a.account = b.account AND
  a.platform = b.platform
)
2018-04-18 11:38:00,557: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7ab49507-8ce8-4871-aec8-0dce4a32fc94', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c5ae3c8>]}
2018-04-18 11:38:01,709: 11:38:01 | 67 of 93 OK created table model agency_data_pipeline.agg_platforms_client [CREATE TABLE in 6.66s]
2018-04-18 11:38:01,710: 11:38:01 | 69 of 93 SKIP relation agency_data_pipeline.retention_365_730........ [SKIP]
2018-04-18 11:38:01,710: 11:38:01 | 70 of 93 SKIP relation agency_data_pipeline.retention_730_plus....... [SKIP]
2018-04-18 11:38:01,710: 11:38:01 | 71 of 93 SKIP relation agency_data_pipeline.retention_30_60.......... [SKIP]
2018-04-18 11:38:01,710: 11:38:01 | 72 of 93 SKIP relation agency_data_pipeline.retention_0_365.......... [SKIP]
2018-04-18 11:38:01,711: 11:38:01 | 73 of 93 SKIP relation agency_data_pipeline.retention_60_plus........ [SKIP]
2018-04-18 11:38:01,711: 11:38:01 | 74 of 93 SKIP relation agency_data_pipeline.retention_0_30........... [SKIP]
2018-04-18 11:38:01,713: 11:38:01 | 75 of 93 SKIP relation agency_data_pipeline.segment_proc_customers... [SKIP]
2018-04-18 11:38:01,713: 11:38:01 | 76 of 93 SKIP relation agency_data_pipeline.retention_0_365_rebuy.... [SKIP]
2018-04-18 11:38:01,714: 11:38:01 | 77 of 93 SKIP relation agency_data_pipeline.segment_stats_customers_agg [SKIP]
2018-04-18 11:38:01,714: 11:38:01 | 78 of 93 SKIP relation agency_data_pipeline.retention_0_30_rebuy..... [SKIP]
2018-04-18 11:38:01,715: 11:38:01 | 79 of 93 SKIP relation agency_data_pipeline.retention_stats_rebuy_rate_month [SKIP]
2018-04-18 11:38:01,715: 11:38:01 | 80 of 93 SKIP relation agency_data_pipeline.segment_stats_customers.. [SKIP]
2018-04-18 11:38:01,715: 11:38:01 | 81 of 93 SKIP relation agency_data_pipeline.retention_stats_rebuy_rate [SKIP]
2018-04-18 11:38:01,716: 11:38:01 | 82 of 93 SKIP relation agency_data_pipeline.retention_0_30_new....... [SKIP]
2018-04-18 11:38:01,716: 11:38:01 | 83 of 93 SKIP relation agency_data_pipeline.retention_0_365_new...... [SKIP]
2018-04-18 11:38:01,717: 11:38:01 | 84 of 93 SKIP relation agency_data_pipeline.retention_0_365_reactivated [SKIP]
2018-04-18 11:38:01,717: 11:38:01 | 85 of 93 SKIP relation agency_data_pipeline.retention_0_30_reactivated [SKIP]
2018-04-18 11:38:01,718: 11:38:01 | 86 of 93 SKIP relation agency_data_pipeline.segment_list_customers... [SKIP]
2018-04-18 11:38:01,719: 11:38:01 | 87 of 93 SKIP relation agency_data_pipeline.growth_customer_0_365_segment [SKIP]
2018-04-18 11:38:01,720: 11:38:01 | 88 of 93 SKIP relation agency_data_pipeline.growth_date_union........ [SKIP]
2018-04-18 11:38:01,720: 11:38:01 | 89 of 93 SKIP relation agency_data_pipeline.retention_stats.......... [SKIP]
2018-04-18 11:38:01,721: 11:38:01 | 90 of 93 SKIP relation agency_data_pipeline.retention_stats_month.... [SKIP]
2018-04-18 11:38:01,721: 11:38:01 | 91 of 93 SKIP relation agency_data_pipeline.growth_stats............. [SKIP]
2018-04-18 11:38:01,722: 11:38:01 | 92 of 93 SKIP relation agency_data_pipeline.agg_campaign............. [SKIP]
2018-04-18 11:38:01,723: 11:38:01 | 93 of 93 SKIP relation agency_data_pipeline.agg_platform_monthly..... [SKIP]
2018-04-18 11:38:01,814: 11:38:01 | 
2018-04-18 11:38:01,814: 11:38:01 | Finished running 93 table models in 105.40s.
2018-04-18 11:38:01,815: Connection 'master' was left open.
2018-04-18 11:38:01,816: 
2018-04-18 11:38:01,816: Completed with 1 errors:
2018-04-18 11:38:01,816: 
2018-04-18 11:38:01,816: Database Error in model agg_orders_union (models/join/agg_orders_union.sql)
2018-04-18 11:38:01,817:   Column name product_id is ambiguous at [57:1]
2018-04-18 11:38:01,817:   compiled SQL at target/compiled/agency_data_pipeline/join/agg_orders_union.sql
2018-04-18 11:38:01,817: 
Done. PASS=40 ERROR=1 SKIP=52 TOTAL=93
2018-04-18 11:38:01,818: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fa3f9e8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fa3fc18>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10f971ba8>]}
2018-04-18 11:38:03,836: Flushing usage events
2018-04-18 11:39:41,409: Tracking: tracking
2018-04-18 11:39:41,412: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fba4dd8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fba4c88>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fba46d8>]}
2018-04-18 11:39:42,202: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-04-18 11:39:42,223: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/growth-engines/dbt_modules
2018-04-18 11:39:42,229: Parsing get_column_values.sql
2018-04-18 11:39:42,246: Parsing get_url_parameter.sql
2018-04-18 11:39:42,252: Parsing split_part.sql
2018-04-18 11:39:42,259: Parsing table_exists.sql
2018-04-18 11:39:42,271: Parsing core.sql
2018-04-18 11:39:42,288: Parsing adapters/bigquery.sql
2018-04-18 11:39:42,297: Parsing adapters/common.sql
2018-04-18 11:39:42,318: Parsing adapters/postgres.sql
2018-04-18 11:39:42,324: Parsing adapters/redshift.sql
2018-04-18 11:39:42,347: Parsing etc/get_custom_schema.sql
2018-04-18 11:39:42,354: Parsing materializations/archive.sql
2018-04-18 11:39:42,392: Parsing materializations/bigquery.sql
2018-04-18 11:39:42,411: Parsing materializations/helpers.sql
2018-04-18 11:39:42,431: Parsing materializations/incremental.sql
2018-04-18 11:39:42,465: Parsing materializations/table.sql
2018-04-18 11:39:42,491: Parsing materializations/view.sql
2018-04-18 11:39:42,510: Parsing materializations/wrapper.sql
2018-04-18 11:39:42,517: Parsing schema_tests/accepted_values.sql
2018-04-18 11:39:42,523: Parsing schema_tests/not_null.sql
2018-04-18 11:39:42,528: Parsing schema_tests/relationships.sql
2018-04-18 11:39:42,535: Parsing schema_tests/unique.sql
2018-04-18 11:39:42,624: Parsing model.agency_data_pipeline.accounts_proc
2018-04-18 11:39:42,626: Parsing model.agency_data_pipeline.all_dates
2018-04-18 11:39:42,627: Parsing model.agency_data_pipeline.carts_proc
2018-04-18 11:39:42,629: Parsing model.agency_data_pipeline.clients_proc
2018-04-18 11:39:42,633: Parsing model.agency_data_pipeline.cogs_proc
2018-04-18 11:39:42,635: Parsing model.agency_data_pipeline.conversion_goals_proc
2018-04-18 11:39:42,637: Parsing model.agency_data_pipeline.mappings_ga_proc
2018-04-18 11:39:42,639: Acquiring new bigquery connection "master".
2018-04-18 11:39:42,639: Opening a new connection (0 currently allocated)
2018-04-18 11:39:42,643: Parsing model.agency_data_pipeline.monthend_dates
2018-04-18 11:39:42,646: Parsing model.agency_data_pipeline.adwords_ads
2018-04-18 11:39:42,648: Parsing model.agency_data_pipeline.adwords_campaigns
2018-04-18 11:39:42,650: Parsing model.agency_data_pipeline.adwords_conversions
2018-04-18 11:39:42,652: Parsing model.agency_data_pipeline.adwords_impression_share
2018-04-18 11:39:42,654: Parsing model.agency_data_pipeline.adwords_join
2018-04-18 11:39:42,657: Parsing model.agency_data_pipeline.adwords_stats
2018-04-18 11:39:42,658: Parsing model.agency_data_pipeline.adwords_urls
2018-04-18 11:39:42,660: Parsing model.agency_data_pipeline.bing_ads_ads
2018-04-18 11:39:42,664: Parsing model.agency_data_pipeline.bing_ads_conversions
2018-04-18 11:39:42,666: Parsing model.agency_data_pipeline.bing_ads_impression_share
2018-04-18 11:39:42,668: Parsing model.agency_data_pipeline.bing_ads_stats
2018-04-18 11:39:42,670: Parsing model.agency_data_pipeline.fb_adcreative
2018-04-18 11:39:42,677: Parsing model.agency_data_pipeline.fb_ads
2018-04-18 11:39:42,685: Parsing model.agency_data_pipeline.fb_ads_insights
2018-04-18 11:39:42,690: Parsing model.agency_data_pipeline.fb_ads_insights_conversions
2018-04-18 11:39:42,697: Parsing model.agency_data_pipeline.fb_ads_stats
2018-04-18 11:39:42,700: Parsing model.agency_data_pipeline.ga_conversions
2018-04-18 11:39:42,702: Parsing model.agency_data_pipeline.ga_traffic
2018-04-18 11:39:42,715: Parsing model.agency_data_pipeline.ga_transactions
2018-04-18 11:39:42,727: Parsing model.agency_data_pipeline.ga_mcf_proc
2018-04-18 11:39:42,730: Parsing model.agency_data_pipeline.ga_mcf_stats
2018-04-18 11:39:42,733: Parsing model.agency_data_pipeline.shopify_customers_proc
2018-04-18 11:39:42,739: Parsing model.agency_data_pipeline.shopify_orders_proc
2018-04-18 11:39:42,747: Parsing model.agency_data_pipeline.shopify_products_proc
2018-04-18 11:39:42,754: Parsing model.agency_data_pipeline.shopify_refunds_proc
2018-04-18 11:39:42,761: Parsing model.agency_data_pipeline.agg_campaign
2018-04-18 11:39:42,765: Parsing model.agency_data_pipeline.agg_customers_union
2018-04-18 11:39:42,767: Parsing model.agency_data_pipeline.agg_ga_campaign
2018-04-18 11:39:42,770: Parsing model.agency_data_pipeline.agg_ga_campaign_by_type
2018-04-18 11:39:42,773: Parsing model.agency_data_pipeline.agg_ga_transaction
2018-04-18 11:39:42,776: Parsing model.agency_data_pipeline.agg_ga_transaction_order_number
2018-04-18 11:39:42,780: Parsing model.agency_data_pipeline.agg_orders_union
2018-04-18 11:39:42,782: Parsing model.agency_data_pipeline.agg_platform_monthly
2018-04-18 11:39:42,785: Parsing model.agency_data_pipeline.agg_platforms_client
2018-04-18 11:39:42,788: Parsing model.agency_data_pipeline.agg_platforms_union
2018-04-18 11:39:42,790: Parsing model.agency_data_pipeline.agg_products
2018-04-18 11:39:42,792: Parsing model.agency_data_pipeline.agg_products_cogs
2018-04-18 11:39:42,795: Parsing model.agency_data_pipeline.agg_transaction
2018-04-18 11:39:42,798: Parsing model.agency_data_pipeline.agg_transaction_daily
2018-04-18 11:39:42,800: Parsing model.agency_data_pipeline.agg_transaction_line_item
2018-04-18 11:39:42,801: Parsing model.agency_data_pipeline.agg_transaction_line_item_type
2018-04-18 11:39:42,804: Parsing model.agency_data_pipeline.agg_transaction_order_number
2018-04-18 11:39:42,806: Parsing model.agency_data_pipeline.agg_transaction_product_type
2018-04-18 11:39:42,808: Parsing model.agency_data_pipeline.customers_by_transaction
2018-04-18 11:39:42,811: Parsing model.agency_data_pipeline.growth_customer_0_365
2018-04-18 11:39:42,814: Parsing model.agency_data_pipeline.growth_customer_0_365_segment
2018-04-18 11:39:42,817: Parsing model.agency_data_pipeline.growth_date_union
2018-04-18 11:39:42,819: Parsing model.agency_data_pipeline.growth_stats
2018-04-18 11:39:42,828: Parsing model.agency_data_pipeline.retention_0_365
2018-04-18 11:39:42,832: Parsing model.agency_data_pipeline.retention_0_365_new
2018-04-18 11:39:42,835: Parsing model.agency_data_pipeline.retention_0_365_reactivated
2018-04-18 11:39:42,837: Parsing model.agency_data_pipeline.retention_0_365_rebuy
2018-04-18 11:39:42,841: Parsing model.agency_data_pipeline.retention_365_730
2018-04-18 11:39:42,844: Parsing model.agency_data_pipeline.retention_730_plus
2018-04-18 11:39:42,848: Parsing model.agency_data_pipeline.retention_stats
2018-04-18 11:39:42,853: Parsing model.agency_data_pipeline.retention_stats_rebuy_rate
2018-04-18 11:39:42,857: Parsing model.agency_data_pipeline.retention_0_30
2018-04-18 11:39:42,860: Parsing model.agency_data_pipeline.retention_0_30_new
2018-04-18 11:39:42,863: Parsing model.agency_data_pipeline.retention_0_30_reactivated
2018-04-18 11:39:42,865: Parsing model.agency_data_pipeline.retention_0_30_rebuy
2018-04-18 11:39:42,868: Parsing model.agency_data_pipeline.retention_30_60
2018-04-18 11:39:42,870: Parsing model.agency_data_pipeline.retention_60_plus
2018-04-18 11:39:42,872: Parsing model.agency_data_pipeline.retention_stats_month
2018-04-18 11:39:42,878: Parsing model.agency_data_pipeline.retention_stats_rebuy_rate_month
2018-04-18 11:39:42,881: Parsing model.agency_data_pipeline.customers_first_purchase_proc
2018-04-18 11:39:42,883: Parsing model.agency_data_pipeline.customers_proc
2018-04-18 11:39:42,887: Parsing model.agency_data_pipeline.segment_list_customers
2018-04-18 11:39:42,889: Parsing model.agency_data_pipeline.segment_proc_customers
2018-04-18 11:39:42,892: Parsing model.agency_data_pipeline.segment_stats_customers
2018-04-18 11:39:42,894: Parsing model.agency_data_pipeline.segment_stats_customers_agg
2018-04-18 11:39:42,901: Parsing model.agency_data_pipeline.customers_first_purchase_product_type_proc
2018-04-18 11:39:42,905: Parsing model.agency_data_pipeline.customers_products_proc
2018-04-18 11:39:42,912: Parsing model.agency_data_pipeline.segment_list_customers_products
2018-04-18 11:39:42,916: Parsing model.agency_data_pipeline.segment_proc_customers_products
2018-04-18 11:39:42,919: Parsing model.agency_data_pipeline.segment_stats_customers_products
2018-04-18 11:39:42,923: Parsing model.agency_data_pipeline.segment_stats_customers_products_agg
2018-04-18 11:39:42,927: Parsing model.agency_data_pipeline.frequency_proc
2018-04-18 11:39:42,931: Parsing model.agency_data_pipeline.frequency_stats
2018-04-18 11:39:42,933: Parsing model.agency_data_pipeline.order_paths_agg
2018-04-18 11:39:42,935: Parsing model.agency_data_pipeline.order_paths_proc
2018-04-18 11:39:42,938: Parsing model.agency_data_pipeline.order_paths_stats
2018-04-18 11:39:42,941: Parsing model.agency_data_pipeline.products_proc
2018-04-18 11:39:42,944: Parsing model.agency_data_pipeline.segment_proc_sku
2018-04-18 11:39:42,947: Parsing model.agency_data_pipeline.segment_stats_category
2018-04-18 11:39:42,949: Parsing model.agency_data_pipeline.segment_stats_sku
2018-04-18 11:39:42,989: Found 93 models, 0 tests, 0 archives, 0 analyses, 46 macros, 0 operations
2018-04-18 11:39:43,093: 
2018-04-18 11:39:44,709: 11:39:44 | Concurrency: 4 threads (target='prod')
2018-04-18 11:39:44,709: 11:39:44 | 
2018-04-18 11:39:45,485: 11:39:45 | 1 of 93 START table model agency_data_pipeline.cogs_proc............. [RUN]
2018-04-18 11:39:45,485: Compiling model.agency_data_pipeline.cogs_proc
2018-04-18 11:39:45,490: Writing injected SQL for node "model.agency_data_pipeline.cogs_proc"
2018-04-18 11:39:45,485: 11:39:45 | 2 of 93 START table model agency_data_pipeline.adwords_campaigns..... [RUN]
2018-04-18 11:39:45,490: Compiling model.agency_data_pipeline.adwords_campaigns
2018-04-18 11:39:45,494: Writing injected SQL for node "model.agency_data_pipeline.adwords_campaigns"
2018-04-18 11:39:45,485: 11:39:45 | 3 of 93 START table model agency_data_pipeline.adwords_urls.......... [RUN]
2018-04-18 11:39:45,496: Acquiring new bigquery connection "cogs_proc".
2018-04-18 11:39:45,485: 11:39:45 | 4 of 93 START table model agency_data_pipeline.clients_proc.......... [RUN]
2018-04-18 11:39:45,497: Compiling model.agency_data_pipeline.adwords_urls
2018-04-18 11:39:45,498: Acquiring new bigquery connection "adwords_campaigns".
2018-04-18 11:39:45,498: Opening a new connection (1 currently allocated)
2018-04-18 11:39:45,498: Compiling model.agency_data_pipeline.clients_proc
2018-04-18 11:39:45,503: Writing injected SQL for node "model.agency_data_pipeline.adwords_urls"
2018-04-18 11:39:45,510: Writing injected SQL for node "model.agency_data_pipeline.clients_proc"
2018-04-18 11:39:45,513: Opening a new connection (2 currently allocated)
2018-04-18 11:39:45,569: Acquiring new bigquery connection "clients_proc".
2018-04-18 11:39:45,573: Acquiring new bigquery connection "adwords_urls".
2018-04-18 11:39:45,576: Opening a new connection (3 currently allocated)
2018-04-18 11:39:45,635: Opening a new connection (4 currently allocated)
2018-04-18 11:39:47,009: Model SQL (adwords_campaigns):
select
day,
campaignid, 
campaign,
account, 
channel,
platform,
sum(cost) cost,
sum(impressions) impressions,
sum(clicks) clicks,
sum(impression_share_num) impression_share_num,
sum(impression_share_den) impression_share_den
from 
  ( 
	SELECT  
	day,
	campaignid,
	campaign,
	account as account,
	'Paid' as channel,
	'Adwords' as platform,
	cost/1000000 cost, 
	impressions as impressions, 
	clicks, 
	case when searchimprshare is not null then impressions end as impression_share_num,
	case when searchimprshare is not null then impressions/(searchimprshare/100) end as impression_share_den,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY campaignid, day ORDER BY _sdc_sequence DESC) lv
	FROM `growth-engines-pipeline.adwords_2.CAMPAIGN_PERFORMANCE_REPORT`
  )
where lv = _sdc_sequence
group by day, campaignid, account, channel, platform, campaign
2018-04-18 11:39:47,010: Model SQL (adwords_urls):
SELECT
campaignid,
lower(trim(regexp_replace(replace(replace(replace(replace(finalurl,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url

FROM (

SELECT  
campaignid,
finalurl,
first_value(finalurl) OVER (PARTITION BY campaignid ORDER BY day DESC) lv
FROM `growth-engines-pipeline.adwords_2.FINAL_URL_REPORT`
)

WHERE lv = finalurl
group by campaignid, url
order by campaignid asc
2018-04-18 11:39:47,010: Model SQL (cogs_proc):
select 
client,
sku,
cogs_dol,
cogs_pct
from  ( 

SELECT  
client,
sku,
cogs_dol,
cogs_pct,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.cogs`
where client != ''
) 

WHERE lv = time_of_entry
2018-04-18 11:39:47,117: Model SQL (clients_proc):
select 
client,
client_name,
account,
platform
from  ( 

SELECT  
client,
client_name,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.accounts`
where client_name != ''
) 

WHERE lv = time_of_entry
2018-04-18 11:39:48,104: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4cb17d75-232b-45e9-a49c-18c6e12b53fc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fd58978>]}
2018-04-18 11:39:48,338: 11:39:48 | 1 of 93 OK created table model agency_data_pipeline.cogs_proc........ [CREATE TABLE in 2.62s]
2018-04-18 11:39:48,338: 11:39:48 | 5 of 93 START table model agency_data_pipeline.bing_ads_ads.......... [RUN]
2018-04-18 11:39:48,338: Compiling model.agency_data_pipeline.bing_ads_ads
2018-04-18 11:39:48,345: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_ads"
2018-04-18 11:39:48,349: Acquiring new bigquery connection "bing_ads_ads".
2018-04-18 11:39:48,349: Re-using an available connection from the pool.
2018-04-18 11:39:49,157: Model SQL (bing_ads_ads):
select
date, 
account, 
channel,
platform,
campaignid,
campaignname,
max(lower(trim(replace(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$','' ),'.html',''),'/'))) as url,
utm_campaign,
sum(cost) as cost,
sum(impressions) as impressions,
sum(clicks) as clicks,
sum(conversions) as conversions
from 
  ( 
SELECT  
cast(gregoriandate as date) date,
replace(accountname,',','') account,
'Paid' as channel,
'Bing Ads' as platform,
adid,
adtype,
campaignid, 
campaignname,
finalurl url,
case when regexp_contains(destinationurl, 'utm_campaign')
	then replace(lower(nullif(
  

    split(
        
  

    split(
        destinationurl,
        'utm_campaign='
        )[offset(1)]


,
        '&'
        )[offset(0)]


,'')),'+',' ') 
	else null end as utm_campaign,
spend cost, 
impressions, 
clicks, 
conversions,
_sdc_sequence,
first_value(_sdc_sequence) OVER (PARTITION BY adid, gregoriandate ORDER BY _sdc_sequence DESC) lv
FROM `growth-engines-pipeline.bing_ads.ad_performance_report` 
  )

where lv = _sdc_sequence
group by date, account, channel, platform, campaignid, campaignname, utm_campaign
2018-04-18 11:39:49,216: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4cb17d75-232b-45e9-a49c-18c6e12b53fc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fd58588>]}
2018-04-18 11:39:49,354: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4cb17d75-232b-45e9-a49c-18c6e12b53fc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fda84e0>]}
2018-04-18 11:39:49,492: 11:39:49 | 3 of 93 OK created table model agency_data_pipeline.adwords_urls..... [CREATE TABLE in 3.72s]
2018-04-18 11:39:49,492: 11:39:49 | 6 of 93 START table model agency_data_pipeline.bing_ads_impression_share [RUN]
2018-04-18 11:39:49,492: Compiling model.agency_data_pipeline.bing_ads_impression_share
2018-04-18 11:39:49,499: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_impression_share"
2018-04-18 11:39:49,501: Acquiring new bigquery connection "bing_ads_impression_share".
2018-04-18 11:39:49,501: Re-using an available connection from the pool.
2018-04-18 11:39:49,775: 11:39:49 | 4 of 93 OK created table model agency_data_pipeline.clients_proc..... [CREATE TABLE in 3.86s]
2018-04-18 11:39:49,776: 11:39:49 | 7 of 93 START table model agency_data_pipeline.monthend_dates........ [RUN]
2018-04-18 11:39:49,776: Compiling model.agency_data_pipeline.monthend_dates
2018-04-18 11:39:49,782: Writing injected SQL for node "model.agency_data_pipeline.monthend_dates"
2018-04-18 11:39:49,783: Acquiring new bigquery connection "monthend_dates".
2018-04-18 11:39:49,783: Re-using an available connection from the pool.
2018-04-18 11:39:50,420: Model SQL (bing_ads_impression_share):
SELECT 
date, 
account,
channel,
platform,
sum(impressions) impressions,
sum(available_impressions) available_impressions
FROM

(

SELECT  
cast(gregoriandate as date) date,
replace(accountname,',','') account,  
'Paid' as channel,
'Bing Ads' as platform,
case when impressionsharepercent is null then 0 else impressions end as impressions,
cast(round(case when ( impressionsharepercent is not null and impressionsharepercent > 0 ) then (impressions*100)/impressionsharepercent else 0 end) as int64) as available_impressions,
_sdc_sequence,
first_value(_sdc_sequence) OVER (PARTITION BY campaignid, gregoriandate ORDER BY _sdc_sequence DESC) lv
FROM `growth-engines-pipeline.bing_ads.campaign_performance_report` 

)

where lv = _sdc_sequence
group by date, account, channel, platform
2018-04-18 11:39:50,853: Model SQL (monthend_dates):
SELECT
date_in_range,
date_in_range_bom,
date_in_range_bom_mom,
unix_date_in_range,
unix_date_in_range_bom,
unix_date(date_in_range_bom_mom) unix_date_in_range_bom_mom,
yyyymm,
date_in_range_yoy,
unix_date(date_in_range_yoy) unix_date_in_range_yoy

FROM
(
	SELECT 
	date_in_range,
	date_in_range_bom,
	date_sub(date_in_range_bom, INTERVAL 1 MONTH) date_in_range_bom_mom,
  date_sub(date_in_range, INTERVAL 1 YEAR) date_in_range_yoy,
	unix_date_in_range,
	unix_date(date_in_range_bom) unix_date_in_range_bom,
	yyyymm,
	first_value(date_in_range) over (partition by yyyymm order by date_in_range desc) monthend_date_in_range
	FROM
	( 
		SELECT 
		date_in_range,
		date_trunc( date_in_range, MONTH) date_in_range_bom,
		unix_date(date_in_range) unix_date_in_range,
		format_date("%Y-%m", date_in_range) AS yyyymm
		FROM UNNEST(
		    GENERATE_DATE_ARRAY(DATE('2016-01-31'), CURRENT_DATE(), INTERVAL 1 DAY)
		) AS date_in_range
	)
)
where date_in_range = monthend_date_in_range
2018-04-18 11:39:51,541: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4cb17d75-232b-45e9-a49c-18c6e12b53fc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fd58978>]}
2018-04-18 11:39:51,574: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4cb17d75-232b-45e9-a49c-18c6e12b53fc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fd58588>]}
2018-04-18 11:39:51,785: 11:39:51 | 5 of 93 OK created table model agency_data_pipeline.bing_ads_ads..... [CREATE TABLE in 3.20s]
2018-04-18 11:39:51,786: 11:39:51 | 8 of 93 START table model agency_data_pipeline.conversion_goals_proc. [RUN]
2018-04-18 11:39:51,786: Compiling model.agency_data_pipeline.conversion_goals_proc
2018-04-18 11:39:51,791: Writing injected SQL for node "model.agency_data_pipeline.conversion_goals_proc"
2018-04-18 11:39:51,793: Acquiring new bigquery connection "conversion_goals_proc".
2018-04-18 11:39:51,793: Re-using an available connection from the pool.
2018-04-18 11:39:52,110: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4cb17d75-232b-45e9-a49c-18c6e12b53fc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fda84e0>]}
2018-04-18 11:39:52,115: 11:39:52 | 6 of 93 OK created table model agency_data_pipeline.bing_ads_impression_share [CREATE TABLE in 2.08s]
2018-04-18 11:39:52,115: 11:39:52 | 9 of 93 START table model agency_data_pipeline.ga_conversions........ [RUN]
2018-04-18 11:39:52,116: Compiling model.agency_data_pipeline.ga_conversions
2018-04-18 11:39:52,120: Writing injected SQL for node "model.agency_data_pipeline.ga_conversions"
2018-04-18 11:39:52,125: Acquiring new bigquery connection "ga_conversions".
2018-04-18 11:39:52,125: Re-using an available connection from the pool.
2018-04-18 11:39:52,714: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4cb17d75-232b-45e9-a49c-18c6e12b53fc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fd589e8>]}
2018-04-18 11:39:52,717: 11:39:52 | 7 of 93 OK created table model agency_data_pipeline.monthend_dates... [CREATE TABLE in 2.33s]
2018-04-18 11:39:52,717: 11:39:52 | 10 of 93 START table model agency_data_pipeline.accounts_proc........ [RUN]
2018-04-18 11:39:52,718: Compiling model.agency_data_pipeline.accounts_proc
2018-04-18 11:39:52,722: Writing injected SQL for node "model.agency_data_pipeline.accounts_proc"
2018-04-18 11:39:52,725: Acquiring new bigquery connection "accounts_proc".
2018-04-18 11:39:52,726: Re-using an available connection from the pool.
2018-04-18 11:39:53,033: Model SQL (conversion_goals_proc):
select 
client,
platform,
goal_name,
max(goal_type) goal_type,
account,
max(time_of_entry) time_of_entry
from  ( 

SELECT  
client,
platform,
trim(replace(replace(lower(goal_name),',',''),' ','')) goal_name,
goal_type,
account,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY platform ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.conversion_goals` 

) 

WHERE lv = time_of_entry
group by client, platform, account, goal_name
2018-04-18 11:39:53,459: Unhandled error while executing None
404 GET https://www.googleapis.com/bigquery/v2/projects/growth-engines-pipeline/datasets/agency_data_pipeline/tables?pageToken=ga_conversions: Not found: Token ga_conversions
2018-04-18 11:39:53,459: 11:39:53 | 11 of 93 START table model agency_data_pipeline.all_dates............ [RUN]
2018-04-18 11:39:53,460: Compiling model.agency_data_pipeline.all_dates
2018-04-18 11:39:53,460: Connection 'master' was left open.
2018-04-18 11:39:53,465: Writing injected SQL for node "model.agency_data_pipeline.all_dates"
2018-04-18 11:39:53,465: Connection 'ga_conversions' was left open.
2018-04-18 11:39:53,466: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d071240>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d071208>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fd58940>]}
2018-04-18 11:39:53,467: Acquiring new bigquery connection "all_dates".
2018-04-18 11:39:53,467: Opening a new connection (0 currently allocated)
2018-04-18 11:39:53,885: Model SQL (ga_conversions):
select 
client,
client_name,
platform,
goal_name,
goal_type,
account,
time_of_entry
from  ( 

SELECT  
client,
client_name,
platform,
trim(goal_name) goal_name,
goal_type,
account,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform, goal_name ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.conversion_goals` 
WHERE platform = 'Google Analytics'

) 

WHERE lv = time_of_entry
2018-04-18 11:39:54,698: 11:39:54 | 2 of 93 OK created table model agency_data_pipeline.adwords_campaigns [CREATE TABLE in 7.22s]
2018-04-18 11:39:54,699: 11:39:54 | 12 of 93 START table model agency_data_pipeline.carts_proc........... [RUN]
2018-04-18 11:39:54,699: Compiling model.agency_data_pipeline.carts_proc
2018-04-18 11:39:54,704: Writing injected SQL for node "model.agency_data_pipeline.carts_proc"
2018-04-18 11:39:54,706: Acquiring new bigquery connection "carts_proc".
2018-04-18 11:39:54,706: Opening a new connection (1 currently allocated)
2018-04-18 11:39:54,932: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4cb17d75-232b-45e9-a49c-18c6e12b53fc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fd58978>]}
2018-04-18 11:39:55,172: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '4cb17d75-232b-45e9-a49c-18c6e12b53fc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fd58588>]}
2018-04-18 11:39:55,306: Encountered an error:
2018-04-18 11:39:55,306: 404 GET https://www.googleapis.com/bigquery/v2/projects/growth-engines-pipeline/datasets/agency_data_pipeline/tables?pageToken=ga_conversions: Not found: Token ga_conversions
2018-04-18 11:39:55,325: Traceback (most recent call last):
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/main.py", line 40, in main
    results, succeeded = handle_and_check(args)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/main.py", line 84, in handle_and_check
    task, res = run_from_args(parsed)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/main.py", line 138, in run_from_args
    results = run_from_task(task, proj, parsed)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/main.py", line 146, in run_from_task
    result = task.run()
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/task/run.py", line 26, in run
    results = runner.run(query, ModelRunner)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/runner.py", line 221, in run
    return self.run_from_graph(Selector, Runner, query)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/runner.py", line 208, in run_from_graph
    res = self.execute_nodes(linker, Runner, flat_graph, dep_list)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/runner.py", line 133, in execute_nodes
    for result in pool.imap_unordered(self.call_runner, args_list):
  File "/usr/local/opt/python3/Frameworks/Python.framework/Versions/3.6/lib/python3.6/multiprocessing/pool.py", line 735, in next
    raise value
  File "/usr/local/opt/python3/Frameworks/Python.framework/Versions/3.6/lib/python3.6/multiprocessing/pool.py", line 119, in worker
    result = (True, func(*args, **kwds))
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/runner.py", line 82, in call_runner
    result = runner.safe_run(flat_graph, existing)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/node_runners.py", line 139, in safe_run
    raise e
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/node_runners.py", line 108, in safe_run
    result = self.run(compiled_node, existing, flat_graph)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/node_runners.py", line 155, in run
    return self.execute(compiled_node, existing, flat_graph)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/node_runners.py", line 389, in execute
    materialization_macro.get('generator')(context)()
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/clients/jinja.py", line 51, in call
    return macro(*args, **kwargs)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/runtime.py", line 549, in __call__
    return self._invoke(arguments, autoescape)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/asyncsupport.py", line 110, in _invoke
    return original_invoke(self, arguments, autoescape)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/runtime.py", line 553, in _invoke
    rv = self._func(*arguments)
  File "<template>", line 55, in macro
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/sandbox.py", line 427, in call
    return __context.call(__obj, *args, **kwargs)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/jinja2/runtime.py", line 260, in call
    return __obj(*args, **kwargs)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/context/common.py", line 48, in wrapped
    return getattr(self.adapter, fn)(*args, **kwargs)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/adapters/bigquery.py", line 154, in query_for_existing
    all_tables.extend(dataset.list_tables())
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/google/cloud/iterator.py", line 218, in _items_iter
    for page in self._page_iter(increment=False):
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/google/cloud/iterator.py", line 254, in _page_iter
    page = self._next_page()
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/google/cloud/iterator.py", line 348, in _next_page
    response = self._get_next_page_response()
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/google/cloud/iterator.py", line 399, in _get_next_page_response
    query_params=params)
  File "/usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/google/cloud/_http.py", line 293, in api_request
    raise exceptions.from_http_response(response)
google.cloud.exceptions.NotFound: 404 GET https://www.googleapis.com/bigquery/v2/projects/growth-engines-pipeline/datasets/agency_data_pipeline/tables?pageToken=ga_conversions: Not found: Token ga_conversions

2018-04-18 11:44:26,837: Tracking: tracking
2018-04-18 11:44:26,840: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d5bf518>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d5bf7b8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d5bfb38>]}
2018-04-18 11:44:27,720: Loading dependency project from /usr/local/Cellar/dbt/0.9.0/libexec/lib/python3.6/site-packages/dbt/include
2018-04-18 11:44:27,748: Loading dependency project from /Users/davidkrevitt/Dropbox/CIFL/adp-models/growth-engines/dbt_modules
2018-04-18 11:44:27,754: Parsing get_column_values.sql
2018-04-18 11:44:27,777: Parsing get_url_parameter.sql
2018-04-18 11:44:27,784: Parsing split_part.sql
2018-04-18 11:44:27,795: Parsing table_exists.sql
2018-04-18 11:44:27,806: Parsing core.sql
2018-04-18 11:44:27,822: Parsing adapters/bigquery.sql
2018-04-18 11:44:27,829: Parsing adapters/common.sql
2018-04-18 11:44:27,846: Parsing adapters/postgres.sql
2018-04-18 11:44:27,852: Parsing adapters/redshift.sql
2018-04-18 11:44:27,873: Parsing etc/get_custom_schema.sql
2018-04-18 11:44:27,882: Parsing materializations/archive.sql
2018-04-18 11:44:27,916: Parsing materializations/bigquery.sql
2018-04-18 11:44:27,936: Parsing materializations/helpers.sql
2018-04-18 11:44:27,958: Parsing materializations/incremental.sql
2018-04-18 11:44:27,994: Parsing materializations/table.sql
2018-04-18 11:44:28,018: Parsing materializations/view.sql
2018-04-18 11:44:28,038: Parsing materializations/wrapper.sql
2018-04-18 11:44:28,044: Parsing schema_tests/accepted_values.sql
2018-04-18 11:44:28,052: Parsing schema_tests/not_null.sql
2018-04-18 11:44:28,056: Parsing schema_tests/relationships.sql
2018-04-18 11:44:28,061: Parsing schema_tests/unique.sql
2018-04-18 11:44:28,158: Parsing model.agency_data_pipeline.accounts_proc
2018-04-18 11:44:28,160: Parsing model.agency_data_pipeline.all_dates
2018-04-18 11:44:28,161: Parsing model.agency_data_pipeline.carts_proc
2018-04-18 11:44:28,164: Parsing model.agency_data_pipeline.clients_proc
2018-04-18 11:44:28,166: Parsing model.agency_data_pipeline.cogs_proc
2018-04-18 11:44:28,167: Parsing model.agency_data_pipeline.conversion_goals_proc
2018-04-18 11:44:28,169: Parsing model.agency_data_pipeline.mappings_ga_proc
2018-04-18 11:44:28,171: Acquiring new bigquery connection "master".
2018-04-18 11:44:28,171: Opening a new connection (0 currently allocated)
2018-04-18 11:44:28,178: Parsing model.agency_data_pipeline.monthend_dates
2018-04-18 11:44:28,182: Parsing model.agency_data_pipeline.adwords_ads
2018-04-18 11:44:28,185: Parsing model.agency_data_pipeline.adwords_campaigns
2018-04-18 11:44:28,187: Parsing model.agency_data_pipeline.adwords_conversions
2018-04-18 11:44:28,189: Parsing model.agency_data_pipeline.adwords_impression_share
2018-04-18 11:44:28,191: Parsing model.agency_data_pipeline.adwords_join
2018-04-18 11:44:28,193: Parsing model.agency_data_pipeline.adwords_stats
2018-04-18 11:44:28,196: Parsing model.agency_data_pipeline.adwords_urls
2018-04-18 11:44:28,198: Parsing model.agency_data_pipeline.bing_ads_ads
2018-04-18 11:44:28,201: Parsing model.agency_data_pipeline.bing_ads_conversions
2018-04-18 11:44:28,203: Parsing model.agency_data_pipeline.bing_ads_impression_share
2018-04-18 11:44:28,204: Parsing model.agency_data_pipeline.bing_ads_stats
2018-04-18 11:44:28,207: Parsing model.agency_data_pipeline.fb_adcreative
2018-04-18 11:44:28,212: Parsing model.agency_data_pipeline.fb_ads
2018-04-18 11:44:28,218: Parsing model.agency_data_pipeline.fb_ads_insights
2018-04-18 11:44:28,224: Parsing model.agency_data_pipeline.fb_ads_insights_conversions
2018-04-18 11:44:28,230: Parsing model.agency_data_pipeline.fb_ads_stats
2018-04-18 11:44:28,232: Parsing model.agency_data_pipeline.ga_conversions
2018-04-18 11:44:28,234: Parsing model.agency_data_pipeline.ga_traffic
2018-04-18 11:44:28,248: Parsing model.agency_data_pipeline.ga_transactions
2018-04-18 11:44:28,258: Parsing model.agency_data_pipeline.ga_mcf_proc
2018-04-18 11:44:28,260: Parsing model.agency_data_pipeline.ga_mcf_stats
2018-04-18 11:44:28,264: Parsing model.agency_data_pipeline.shopify_customers_proc
2018-04-18 11:44:28,272: Parsing model.agency_data_pipeline.shopify_orders_proc
2018-04-18 11:44:28,281: Parsing model.agency_data_pipeline.shopify_products_proc
2018-04-18 11:44:28,288: Parsing model.agency_data_pipeline.shopify_refunds_proc
2018-04-18 11:44:28,294: Parsing model.agency_data_pipeline.agg_campaign
2018-04-18 11:44:28,300: Parsing model.agency_data_pipeline.agg_customers_union
2018-04-18 11:44:28,302: Parsing model.agency_data_pipeline.agg_ga_campaign
2018-04-18 11:44:28,306: Parsing model.agency_data_pipeline.agg_ga_campaign_by_type
2018-04-18 11:44:28,308: Parsing model.agency_data_pipeline.agg_ga_transaction
2018-04-18 11:44:28,312: Parsing model.agency_data_pipeline.agg_ga_transaction_order_number
2018-04-18 11:44:28,316: Parsing model.agency_data_pipeline.agg_orders_union
2018-04-18 11:44:28,319: Parsing model.agency_data_pipeline.agg_platform_monthly
2018-04-18 11:44:28,321: Parsing model.agency_data_pipeline.agg_platforms_client
2018-04-18 11:44:28,324: Parsing model.agency_data_pipeline.agg_platforms_union
2018-04-18 11:44:28,326: Parsing model.agency_data_pipeline.agg_products
2018-04-18 11:44:28,329: Parsing model.agency_data_pipeline.agg_products_cogs
2018-04-18 11:44:28,332: Parsing model.agency_data_pipeline.agg_transaction
2018-04-18 11:44:28,335: Parsing model.agency_data_pipeline.agg_transaction_daily
2018-04-18 11:44:28,337: Parsing model.agency_data_pipeline.agg_transaction_line_item
2018-04-18 11:44:28,338: Parsing model.agency_data_pipeline.agg_transaction_line_item_type
2018-04-18 11:44:28,340: Parsing model.agency_data_pipeline.agg_transaction_order_number
2018-04-18 11:44:28,342: Parsing model.agency_data_pipeline.agg_transaction_product_type
2018-04-18 11:44:28,344: Parsing model.agency_data_pipeline.customers_by_transaction
2018-04-18 11:44:28,347: Parsing model.agency_data_pipeline.growth_customer_0_365
2018-04-18 11:44:28,350: Parsing model.agency_data_pipeline.growth_customer_0_365_segment
2018-04-18 11:44:28,354: Parsing model.agency_data_pipeline.growth_date_union
2018-04-18 11:44:28,357: Parsing model.agency_data_pipeline.growth_stats
2018-04-18 11:44:28,364: Parsing model.agency_data_pipeline.retention_0_365
2018-04-18 11:44:28,366: Parsing model.agency_data_pipeline.retention_0_365_new
2018-04-18 11:44:28,369: Parsing model.agency_data_pipeline.retention_0_365_reactivated
2018-04-18 11:44:28,371: Parsing model.agency_data_pipeline.retention_0_365_rebuy
2018-04-18 11:44:28,373: Parsing model.agency_data_pipeline.retention_365_730
2018-04-18 11:44:28,376: Parsing model.agency_data_pipeline.retention_730_plus
2018-04-18 11:44:28,379: Parsing model.agency_data_pipeline.retention_stats
2018-04-18 11:44:28,385: Parsing model.agency_data_pipeline.retention_stats_rebuy_rate
2018-04-18 11:44:28,387: Parsing model.agency_data_pipeline.retention_0_30
2018-04-18 11:44:28,389: Parsing model.agency_data_pipeline.retention_0_30_new
2018-04-18 11:44:28,392: Parsing model.agency_data_pipeline.retention_0_30_reactivated
2018-04-18 11:44:28,395: Parsing model.agency_data_pipeline.retention_0_30_rebuy
2018-04-18 11:44:28,398: Parsing model.agency_data_pipeline.retention_30_60
2018-04-18 11:44:28,400: Parsing model.agency_data_pipeline.retention_60_plus
2018-04-18 11:44:28,402: Parsing model.agency_data_pipeline.retention_stats_month
2018-04-18 11:44:28,407: Parsing model.agency_data_pipeline.retention_stats_rebuy_rate_month
2018-04-18 11:44:28,410: Parsing model.agency_data_pipeline.customers_first_purchase_proc
2018-04-18 11:44:28,412: Parsing model.agency_data_pipeline.customers_proc
2018-04-18 11:44:28,415: Parsing model.agency_data_pipeline.segment_list_customers
2018-04-18 11:44:28,417: Parsing model.agency_data_pipeline.segment_proc_customers
2018-04-18 11:44:28,420: Parsing model.agency_data_pipeline.segment_stats_customers
2018-04-18 11:44:28,422: Parsing model.agency_data_pipeline.segment_stats_customers_agg
2018-04-18 11:44:28,425: Parsing model.agency_data_pipeline.customers_first_purchase_product_type_proc
2018-04-18 11:44:28,427: Parsing model.agency_data_pipeline.customers_products_proc
2018-04-18 11:44:28,430: Parsing model.agency_data_pipeline.segment_list_customers_products
2018-04-18 11:44:28,432: Parsing model.agency_data_pipeline.segment_proc_customers_products
2018-04-18 11:44:28,435: Parsing model.agency_data_pipeline.segment_stats_customers_products
2018-04-18 11:44:28,437: Parsing model.agency_data_pipeline.segment_stats_customers_products_agg
2018-04-18 11:44:28,440: Parsing model.agency_data_pipeline.frequency_proc
2018-04-18 11:44:28,442: Parsing model.agency_data_pipeline.frequency_stats
2018-04-18 11:44:28,444: Parsing model.agency_data_pipeline.order_paths_agg
2018-04-18 11:44:28,446: Parsing model.agency_data_pipeline.order_paths_proc
2018-04-18 11:44:28,449: Parsing model.agency_data_pipeline.order_paths_stats
2018-04-18 11:44:28,451: Parsing model.agency_data_pipeline.products_proc
2018-04-18 11:44:28,456: Parsing model.agency_data_pipeline.segment_proc_sku
2018-04-18 11:44:28,458: Parsing model.agency_data_pipeline.segment_stats_category
2018-04-18 11:44:28,461: Parsing model.agency_data_pipeline.segment_stats_sku
2018-04-18 11:44:28,508: Found 93 models, 0 tests, 0 archives, 0 analyses, 46 macros, 0 operations
2018-04-18 11:44:28,590: 
2018-04-18 11:44:30,319: 11:44:30 | Concurrency: 4 threads (target='prod')
2018-04-18 11:44:30,319: 11:44:30 | 
2018-04-18 11:44:31,287: 11:44:31 | 1 of 93 START table model agency_data_pipeline.accounts_proc......... [RUN]
2018-04-18 11:44:31,288: Compiling model.agency_data_pipeline.accounts_proc
2018-04-18 11:44:31,292: Writing injected SQL for node "model.agency_data_pipeline.accounts_proc"
2018-04-18 11:44:31,288: 11:44:31 | 2 of 93 START table model agency_data_pipeline.adwords_urls.......... [RUN]
2018-04-18 11:44:31,293: Compiling model.agency_data_pipeline.adwords_urls
2018-04-18 11:44:31,298: Writing injected SQL for node "model.agency_data_pipeline.adwords_urls"
2018-04-18 11:44:31,288: 11:44:31 | 3 of 93 START table model agency_data_pipeline.monthend_dates........ [RUN]
2018-04-18 11:44:31,299: Compiling model.agency_data_pipeline.monthend_dates
2018-04-18 11:44:31,288: 11:44:31 | 4 of 93 START table model agency_data_pipeline.clients_proc.......... [RUN]
2018-04-18 11:44:31,304: Writing injected SQL for node "model.agency_data_pipeline.monthend_dates"
2018-04-18 11:44:31,304: Compiling model.agency_data_pipeline.clients_proc
2018-04-18 11:44:31,305: Acquiring new bigquery connection "accounts_proc".
2018-04-18 11:44:31,306: Acquiring new bigquery connection "adwords_urls".
2018-04-18 11:44:31,313: Writing injected SQL for node "model.agency_data_pipeline.clients_proc"
2018-04-18 11:44:31,315: Opening a new connection (1 currently allocated)
2018-04-18 11:44:31,316: Acquiring new bigquery connection "clients_proc".
2018-04-18 11:44:31,317: Acquiring new bigquery connection "monthend_dates".
2018-04-18 11:44:31,319: Opening a new connection (2 currently allocated)
2018-04-18 11:44:31,472: Opening a new connection (3 currently allocated)
2018-04-18 11:44:31,524: Opening a new connection (4 currently allocated)
2018-04-18 11:44:33,214: Model SQL (accounts_proc):
select 
client,
account,
platform,
max(time_of_entry)

from  ( 

SELECT  
client,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.accounts` 

) 

WHERE lv = time_of_entry
group by client, account, platform
order by client asc, account asc
2018-04-18 11:44:33,215: Model SQL (clients_proc):
select 
client,
client_name,
account,
platform
from  ( 

SELECT  
client,
client_name,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.accounts`
where client_name != ''
) 

WHERE lv = time_of_entry
2018-04-18 11:44:33,218: Model SQL (adwords_urls):
SELECT
campaignid,
lower(trim(regexp_replace(replace(replace(replace(replace(finalurl,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url

FROM (

SELECT  
campaignid,
finalurl,
first_value(finalurl) OVER (PARTITION BY campaignid ORDER BY day DESC) lv
FROM `growth-engines-pipeline.adwords_2.FINAL_URL_REPORT`
)

WHERE lv = finalurl
group by campaignid, url
order by campaignid asc
2018-04-18 11:44:33,302: Model SQL (monthend_dates):
SELECT
date_in_range,
date_in_range_bom,
date_in_range_bom_mom,
unix_date_in_range,
unix_date_in_range_bom,
unix_date(date_in_range_bom_mom) unix_date_in_range_bom_mom,
yyyymm,
date_in_range_yoy,
unix_date(date_in_range_yoy) unix_date_in_range_yoy

FROM
(
	SELECT 
	date_in_range,
	date_in_range_bom,
	date_sub(date_in_range_bom, INTERVAL 1 MONTH) date_in_range_bom_mom,
  date_sub(date_in_range, INTERVAL 1 YEAR) date_in_range_yoy,
	unix_date_in_range,
	unix_date(date_in_range_bom) unix_date_in_range_bom,
	yyyymm,
	first_value(date_in_range) over (partition by yyyymm order by date_in_range desc) monthend_date_in_range
	FROM
	( 
		SELECT 
		date_in_range,
		date_trunc( date_in_range, MONTH) date_in_range_bom,
		unix_date(date_in_range) unix_date_in_range,
		format_date("%Y-%m", date_in_range) AS yyyymm
		FROM UNNEST(
		    GENERATE_DATE_ARRAY(DATE('2016-01-31'), CURRENT_DATE(), INTERVAL 1 DAY)
		) AS date_in_range
	)
)
where date_in_range = monthend_date_in_range
2018-04-18 11:44:35,518: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d7afef0>]}
2018-04-18 11:44:35,526: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d7b6470>]}
2018-04-18 11:44:35,545: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d7af898>]}
2018-04-18 11:44:35,550: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d72d898>]}
2018-04-18 11:44:35,795: 11:44:35 | 2 of 93 OK created table model agency_data_pipeline.adwords_urls..... [CREATE TABLE in 4.23s]
2018-04-18 11:44:35,797: 11:44:35 | 5 of 93 START table model agency_data_pipeline.cogs_proc............. [RUN]
2018-04-18 11:44:35,797: Compiling model.agency_data_pipeline.cogs_proc
2018-04-18 11:44:35,807: Writing injected SQL for node "model.agency_data_pipeline.cogs_proc"
2018-04-18 11:44:35,812: Acquiring new bigquery connection "cogs_proc".
2018-04-18 11:44:35,814: Re-using an available connection from the pool.
2018-04-18 11:44:36,218: 11:44:36 | 3 of 93 OK created table model agency_data_pipeline.monthend_dates... [CREATE TABLE in 4.23s]
2018-04-18 11:44:36,228: 11:44:36 | 6 of 93 START table model agency_data_pipeline.conversion_goals_proc. [RUN]
2018-04-18 11:44:36,229: Compiling model.agency_data_pipeline.conversion_goals_proc
2018-04-18 11:44:36,254: Writing injected SQL for node "model.agency_data_pipeline.conversion_goals_proc"
2018-04-18 11:44:36,258: Acquiring new bigquery connection "conversion_goals_proc".
2018-04-18 11:44:36,259: Re-using an available connection from the pool.
2018-04-18 11:44:36,536: 11:44:36 | 1 of 93 OK created table model agency_data_pipeline.accounts_proc.... [CREATE TABLE in 4.26s]
2018-04-18 11:44:36,539: 11:44:36 | 7 of 93 START table model agency_data_pipeline.all_dates............. [RUN]
2018-04-18 11:44:36,554: Compiling model.agency_data_pipeline.all_dates
2018-04-18 11:44:36,566: Writing injected SQL for node "model.agency_data_pipeline.all_dates"
2018-04-18 11:44:36,569: Acquiring new bigquery connection "all_dates".
2018-04-18 11:44:36,569: Re-using an available connection from the pool.
2018-04-18 11:44:36,807: 11:44:36 | 4 of 93 OK created table model agency_data_pipeline.clients_proc..... [CREATE TABLE in 4.25s]
2018-04-18 11:44:36,807: 11:44:36 | 8 of 93 START table model agency_data_pipeline.adwords_campaigns..... [RUN]
2018-04-18 11:44:36,808: Compiling model.agency_data_pipeline.adwords_campaigns
2018-04-18 11:44:36,820: Writing injected SQL for node "model.agency_data_pipeline.adwords_campaigns"
2018-04-18 11:44:36,823: Acquiring new bigquery connection "adwords_campaigns".
2018-04-18 11:44:36,823: Re-using an available connection from the pool.
2018-04-18 11:44:36,880: Model SQL (cogs_proc):
select 
client,
sku,
cogs_dol,
cogs_pct
from  ( 

SELECT  
client,
sku,
cogs_dol,
cogs_pct,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.cogs`
where client != ''
) 

WHERE lv = time_of_entry
2018-04-18 11:44:37,345: Model SQL (conversion_goals_proc):
select 
client,
platform,
goal_name,
max(goal_type) goal_type,
account,
max(time_of_entry) time_of_entry
from  ( 

SELECT  
client,
platform,
trim(replace(replace(lower(goal_name),',',''),' ','')) goal_name,
goal_type,
account,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY platform ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.conversion_goals` 

) 

WHERE lv = time_of_entry
group by client, platform, account, goal_name
2018-04-18 11:44:37,668: Model SQL (all_dates):
SELECT 
date_in_range,
unix_date(date_in_range) unix_date_in_range
FROM UNNEST(
    GENERATE_DATE_ARRAY(DATE('2016-01-01'), CURRENT_DATE(), INTERVAL 1 DAY)
) AS date_in_range
2018-04-18 11:44:37,810: Model SQL (adwords_campaigns):
select
day,
campaignid, 
campaign,
account, 
channel,
platform,
sum(cost) cost,
sum(impressions) impressions,
sum(clicks) clicks,
sum(impression_share_num) impression_share_num,
sum(impression_share_den) impression_share_den
from 
  ( 
	SELECT  
	day,
	campaignid,
	campaign,
	account as account,
	'Paid' as channel,
	'Adwords' as platform,
	cost/1000000 cost, 
	impressions as impressions, 
	clicks, 
	case when searchimprshare is not null then impressions end as impression_share_num,
	case when searchimprshare is not null then impressions/(searchimprshare/100) end as impression_share_den,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY campaignid, day ORDER BY _sdc_sequence DESC) lv
	FROM `growth-engines-pipeline.adwords_2.CAMPAIGN_PERFORMANCE_REPORT`
  )
where lv = _sdc_sequence
group by day, campaignid, account, channel, platform, campaign
2018-04-18 11:44:37,976: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d7367b8>]}
2018-04-18 11:44:38,248: 11:44:38 | 5 of 93 OK created table model agency_data_pipeline.cogs_proc........ [CREATE TABLE in 2.18s]
2018-04-18 11:44:38,249: 11:44:38 | 9 of 93 START table model agency_data_pipeline.ga_conversions........ [RUN]
2018-04-18 11:44:38,249: Compiling model.agency_data_pipeline.ga_conversions
2018-04-18 11:44:38,260: Writing injected SQL for node "model.agency_data_pipeline.ga_conversions"
2018-04-18 11:44:38,264: Acquiring new bigquery connection "ga_conversions".
2018-04-18 11:44:38,264: Re-using an available connection from the pool.
2018-04-18 11:44:39,272: Model SQL (ga_conversions):
select 
client,
client_name,
platform,
goal_name,
goal_type,
account,
time_of_entry
from  ( 

SELECT  
client,
client_name,
platform,
trim(goal_name) goal_name,
goal_type,
account,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform, goal_name ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.conversion_goals` 
WHERE platform = 'Google Analytics'

) 

WHERE lv = time_of_entry
2018-04-18 11:44:39,606: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d6b1320>]}
2018-04-18 11:44:39,900: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d72d048>]}
2018-04-18 11:44:39,920: 11:44:39 | 6 of 93 OK created table model agency_data_pipeline.conversion_goals_proc [CREATE TABLE in 3.38s]
2018-04-18 11:44:39,924: 11:44:39 | 10 of 93 START table model agency_data_pipeline.bing_ads_impression_share [RUN]
2018-04-18 11:44:39,926: Compiling model.agency_data_pipeline.bing_ads_impression_share
2018-04-18 11:44:39,943: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_impression_share"
2018-04-18 11:44:39,947: Acquiring new bigquery connection "bing_ads_impression_share".
2018-04-18 11:44:39,947: Re-using an available connection from the pool.
2018-04-18 11:44:40,329: 11:44:40 | 7 of 93 OK created table model agency_data_pipeline.all_dates........ [CREATE TABLE in 3.35s]
2018-04-18 11:44:40,334: 11:44:40 | 11 of 93 START table model agency_data_pipeline.carts_proc........... [RUN]
2018-04-18 11:44:40,335: Compiling model.agency_data_pipeline.carts_proc
2018-04-18 11:44:40,347: Writing injected SQL for node "model.agency_data_pipeline.carts_proc"
2018-04-18 11:44:40,349: Acquiring new bigquery connection "carts_proc".
2018-04-18 11:44:40,349: Re-using an available connection from the pool.
2018-04-18 11:44:40,384: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d7367b8>]}
2018-04-18 11:44:40,657: 11:44:40 | 9 of 93 OK created table model agency_data_pipeline.ga_conversions... [CREATE TABLE in 2.13s]
2018-04-18 11:44:40,657: 11:44:40 | 12 of 93 START table model agency_data_pipeline.adwords_conversions.. [RUN]
2018-04-18 11:44:40,658: Compiling model.agency_data_pipeline.adwords_conversions
2018-04-18 11:44:40,666: Writing injected SQL for node "model.agency_data_pipeline.adwords_conversions"
2018-04-18 11:44:40,669: Acquiring new bigquery connection "adwords_conversions".
2018-04-18 11:44:40,669: Re-using an available connection from the pool.
2018-04-18 11:44:41,029: Model SQL (bing_ads_impression_share):
SELECT 
date, 
account,
channel,
platform,
sum(impressions) impressions,
sum(available_impressions) available_impressions
FROM

(

SELECT  
cast(gregoriandate as date) date,
replace(accountname,',','') account,  
'Paid' as channel,
'Bing Ads' as platform,
case when impressionsharepercent is null then 0 else impressions end as impressions,
cast(round(case when ( impressionsharepercent is not null and impressionsharepercent > 0 ) then (impressions*100)/impressionsharepercent else 0 end) as int64) as available_impressions,
_sdc_sequence,
first_value(_sdc_sequence) OVER (PARTITION BY campaignid, gregoriandate ORDER BY _sdc_sequence DESC) lv
FROM `growth-engines-pipeline.bing_ads.campaign_performance_report` 

)

where lv = _sdc_sequence
group by date, account, channel, platform
2018-04-18 11:44:41,842: Model SQL (carts_proc):
select 
client,
client_name,
account,
platform
from  ( 

SELECT  
client,
client_name,
account,
platform,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.accounts`
WHERE platform in ('Shopify', 'Custom cart')

) 

WHERE lv = time_of_entry
2018-04-18 11:44:42,236: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d74beb8>]}
2018-04-18 11:44:42,242: Model SQL (adwords_conversions):
select 
client,
client_name,
platform,
goal_name,
goal_type,
account,
time_of_entry
from  ( 

SELECT  
client,
client_name,
platform,
trim(lower(goal_name)) goal_name,
goal_type,
account,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, platform, goal_name ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.conversion_goals` 
WHERE platform = 'Adwords'

) 

WHERE lv = time_of_entry
2018-04-18 11:44:42,584: 11:44:42 | 10 of 93 OK created table model agency_data_pipeline.bing_ads_impression_share [CREATE TABLE in 2.31s]
2018-04-18 11:44:42,584: 11:44:42 | 13 of 93 START table model agency_data_pipeline.bing_ads_ads......... [RUN]
2018-04-18 11:44:42,584: Compiling model.agency_data_pipeline.bing_ads_ads
2018-04-18 11:44:42,595: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_ads"
2018-04-18 11:44:42,596: Acquiring new bigquery connection "bing_ads_ads".
2018-04-18 11:44:42,597: Re-using an available connection from the pool.
2018-04-18 11:44:42,944: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d72d048>]}
2018-04-18 11:44:43,000: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d72d898>]}
2018-04-18 11:44:43,255: 11:44:43 | 11 of 93 OK created table model agency_data_pipeline.carts_proc...... [CREATE TABLE in 2.61s]
2018-04-18 11:44:43,540: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d7367b8>]}
2018-04-18 11:44:43,651: 11:44:43 | 8 of 93 OK created table model agency_data_pipeline.adwords_campaigns [CREATE TABLE in 6.19s]
2018-04-18 11:44:43,793: Model SQL (bing_ads_ads):
select
date, 
account, 
channel,
platform,
campaignid,
campaignname,
max(lower(trim(replace(regexp_replace(replace(replace(replace(url,'www.',''),'http://',''),'https://',''),r'\?.*$','' ),'.html',''),'/'))) as url,
utm_campaign,
sum(cost) as cost,
sum(impressions) as impressions,
sum(clicks) as clicks,
sum(conversions) as conversions
from 
  ( 
SELECT  
cast(gregoriandate as date) date,
replace(accountname,',','') account,
'Paid' as channel,
'Bing Ads' as platform,
adid,
adtype,
campaignid, 
campaignname,
finalurl url,
case when regexp_contains(destinationurl, 'utm_campaign')
	then replace(lower(nullif(
  

    split(
        
  

    split(
        destinationurl,
        'utm_campaign='
        )[offset(1)]


,
        '&'
        )[offset(0)]


,'')),'+',' ') 
	else null end as utm_campaign,
spend cost, 
impressions, 
clicks, 
conversions,
_sdc_sequence,
first_value(_sdc_sequence) OVER (PARTITION BY adid, gregoriandate ORDER BY _sdc_sequence DESC) lv
FROM `growth-engines-pipeline.bing_ads.ad_performance_report` 
  )

where lv = _sdc_sequence
group by date, account, channel, platform, campaignid, campaignname, utm_campaign
2018-04-18 11:44:44,167: 11:44:44 | 12 of 93 OK created table model agency_data_pipeline.adwords_conversions [CREATE TABLE in 2.88s]
2018-04-18 11:44:46,085: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a337c50>]}
2018-04-18 11:44:46,391: 11:44:46 | 13 of 93 OK created table model agency_data_pipeline.bing_ads_ads.... [CREATE TABLE in 3.50s]
2018-04-18 11:44:46,393: 11:44:46 | 14 of 93 START table model agency_data_pipeline.ga_mcf_proc.......... [RUN]
2018-04-18 11:44:46,393: Compiling model.agency_data_pipeline.ga_mcf_proc
2018-04-18 11:44:46,393: 11:44:46 | 15 of 93 START table model agency_data_pipeline.adwords_ads.......... [RUN]
2018-04-18 11:44:46,400: Writing injected SQL for node "model.agency_data_pipeline.ga_mcf_proc"
2018-04-18 11:44:46,393: 11:44:46 | 16 of 93 START table model agency_data_pipeline.fb_ads_insights...... [RUN]
2018-04-18 11:44:46,400: Compiling model.agency_data_pipeline.adwords_ads
2018-04-18 11:44:46,393: 11:44:46 | 17 of 93 START table model agency_data_pipeline.bing_ads_conversions. [RUN]
2018-04-18 11:44:46,401: Compiling model.agency_data_pipeline.fb_ads_insights
2018-04-18 11:44:46,406: Writing injected SQL for node "model.agency_data_pipeline.adwords_ads"
2018-04-18 11:44:46,406: Compiling model.agency_data_pipeline.bing_ads_conversions
2018-04-18 11:44:46,413: Acquiring new bigquery connection "fb_ads_insights".
2018-04-18 11:44:46,413: Acquiring new bigquery connection "ga_mcf_proc".
2018-04-18 11:44:46,420: Re-using an available connection from the pool.
2018-04-18 11:44:46,424: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_conversions"
2018-04-18 11:44:46,424: Fetching data for query fb_ads_insights:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 11:44:46,424: Re-using an available connection from the pool.
2018-04-18 11:44:46,425: Acquiring new bigquery connection "adwords_ads".
2018-04-18 11:44:46,426: Re-using an available connection from the pool.
2018-04-18 11:44:46,429: Acquiring new bigquery connection "bing_ads_conversions".
2018-04-18 11:44:46,429: Re-using an available connection from the pool.
2018-04-18 11:44:47,373: Model SQL (bing_ads_conversions):
SELECT
date, 
a.account account, 
a.channel channel,
a.platform platform,
campaignid,
campaignname,
sum( case when b.goal_type = 'Transactions' then conversions else 0 end ) as transactions
FROM

  ( 
SELECT  
cast(gregoriandate as date) date,
replace(accountname,',','') account,
'Paid' as channel,
'Bing Ads' as platform,
trim(replace(replace(lower(goal),',',''),' ','')) goal,
goalid,
campaignid,
campaignname,
conversions,
_sdc_sequence,
first_value(_sdc_sequence) OVER (PARTITION BY campaignid, goalid, gregoriandate ORDER BY _sdc_sequence DESC) lv
FROM `growth-engines-pipeline.bing_ads.goals_and_funnels_report` 

  ) a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`conversion_goals_proc` b
ON (
	a.account = b.account AND
	a.platform = b.platform AND
	a.goal = b.goal_name
)
where a.lv = a._sdc_sequence
group by date, account, channel, platform, campaignid, campaignname
2018-04-18 11:44:47,472: Model SQL (ga_mcf_proc):
SELECT 
date,
account,
'Google Analytics' as lookup_platform,
source_medium_path,
trim(lower(split(split(source_medium_path,'->')[SAFE_ORDINAL(1)],'/')[SAFE_ORDINAL(1)])) as source,
trim(lower(split(split(source_medium_path,'->')[SAFE_ORDINAL(1)],'/')[SAFE_ORDINAL(2)])) as medium,
first_interaction_campaign campaign,
cast(regexp_replace(transaction_id, r'#', '') as int64) transactionid,
max(first_interaction_conversions) transactions,
max(first_interaction_conversion_value) revenue
FROM `growth-engines-pipeline.agency_data_pipeline.ga_mcf`
where account in (select account from `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc` where platform = 'Google Analytics')
group by date, account, source, medium, campaign, source_medium_path, lookup_platform, transactionid
2018-04-18 11:44:47,567: Model SQL (adwords_ads):
SELECT  
day,
campaignid,
a.account as account,
utm_campaign,
sum( case when b.goal_type = 'Transaction' then conversions else 0 end ) as transactions
FROM (

	SELECT  
	day,
	adid,
	campaignid,
	account,
	lower(conversionname) conversionname,
	conversions,
	lower(campaign) utm_campaign,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY campaignid, day ORDER BY _sdc_sequence DESC) lv
	FROM
	`growth-engines-pipeline.adwords_2.AD_PERFORMANCE_REPORT`

) a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_conversions` b
ON ( a.conversionname = b.goal_name
	AND a.account = b.account )
WHERE lv = _sdc_sequence
group by day, campaignid, account, utm_campaign
2018-04-18 11:44:47,608: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_insights"
2018-04-18 11:44:48,715: Model SQL (fb_ads_insights):




with fb_ads_insights as (

	    
		   	SELECT 
			date_start,
			campaign_id,
			campaign_name,
			ad_id,
			account_name,
			spend,
			reach,
			inline_link_clicks,
			_sdc_sequence,
			first_value(_sdc_sequence) OVER (PARTITION BY date_start, ad_id, campaign_id ORDER BY _sdc_sequence DESC) lv
			FROM `growth-engines-pipeline.fb_ads_luca_danni.ads_insights`
		    
	   

)

select
date_start date,
campaign_id,
campaign_name campaign,
ad_id,
account_name account,
max(spend) cost,
max(reach) impressions,
max(inline_link_clicks) clicks
from fb_ads_insights
where lv = _sdc_sequence
group by date, campaign_id, ad_id, account, campaign


2018-04-18 11:44:49,902: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d7cc668>]}
2018-04-18 11:44:49,911: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d74beb8>]}
2018-04-18 11:44:50,333: 11:44:50 | 15 of 93 OK created table model agency_data_pipeline.adwords_ads..... [CREATE TABLE in 3.50s]
2018-04-18 11:44:50,337: 11:44:50 | 18 of 93 START table model agency_data_pipeline.shopify_refunds_proc. [RUN]
2018-04-18 11:44:50,339: Compiling model.agency_data_pipeline.shopify_refunds_proc
2018-04-18 11:44:50,349: Acquiring new bigquery connection "shopify_refunds_proc".
2018-04-18 11:44:50,350: Re-using an available connection from the pool.
2018-04-18 11:44:50,350: Fetching data for query shopify_refunds_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 11:44:50,709: 11:44:50 | 17 of 93 OK created table model agency_data_pipeline.bing_ads_conversions [CREATE TABLE in 3.51s]
2018-04-18 11:44:50,709: 11:44:50 | 19 of 93 START table model agency_data_pipeline.fb_adcreative........ [RUN]
2018-04-18 11:44:50,709: Compiling model.agency_data_pipeline.fb_adcreative
2018-04-18 11:44:50,722: Acquiring new bigquery connection "fb_adcreative".
2018-04-18 11:44:50,722: Re-using an available connection from the pool.
2018-04-18 11:44:50,722: Fetching data for query fb_adcreative:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 11:44:51,102: Writing injected SQL for node "model.agency_data_pipeline.fb_adcreative"
2018-04-18 11:44:51,707: Writing injected SQL for node "model.agency_data_pipeline.shopify_refunds_proc"
2018-04-18 11:44:52,060: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d6c3eb8>]}
2018-04-18 11:44:52,178: Model SQL (fb_adcreative):




with fb_adcreative as (


	    
		   	SELECT 
			id,
			object_url,
			url_tags,
			_sdc_sequence
			FROM `growth-engines-pipeline.fb_ads_luca_danni.adcreative`
		    
	   
)

select creative_id, max(url) url
from (
  select
  id creative_id,
  lower(trim(regexp_replace(replace(replace(replace(replace(object_url,'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
  first_value(_sdc_sequence) OVER (PARTITION BY id ORDER BY _sdc_sequence DESC) lv,
  _sdc_sequence
  from fb_adcreative
  )
where lv = _sdc_sequence
group by creative_id


2018-04-18 11:44:52,336: 11:44:52 | 16 of 93 OK created table model agency_data_pipeline.fb_ads_insights. [CREATE TABLE in 5.66s]
2018-04-18 11:44:52,336: 11:44:52 | 20 of 93 START table model agency_data_pipeline.mappings_ga_proc..... [RUN]
2018-04-18 11:44:52,336: Compiling model.agency_data_pipeline.mappings_ga_proc
2018-04-18 11:44:52,341: Writing injected SQL for node "model.agency_data_pipeline.mappings_ga_proc"
2018-04-18 11:44:52,342: Acquiring new bigquery connection "mappings_ga_proc".
2018-04-18 11:44:52,342: Re-using an available connection from the pool.
2018-04-18 11:44:52,743: Model SQL (shopify_refunds_proc):




with refunds as (

	
	SELECT
	order_number,
	checkout_id,
	financial_status,
	line_item_id,
	quantity,
	subtotal,
	line_item.variant_id variant_id,
	line_item.id refund_id,
 	_sdc_sequence
	FROM `growth-engines-pipeline.shopify_lucadanni.orders` 
	cross join unnest(refunds), unnest(refund_line_items)
  	where financial_status like '%refund%'
	
	

)

SELECT * 
FROM 
	(
    SELECT
	order_number,
	checkout_id,
	financial_status,
	line_item_id,
	quantity,
	subtotal refund_amount,
	variant_id,
	refund_id,
 	_sdc_sequence,
    first_value(_sdc_sequence) OVER (PARTITION BY order_number, line_item_id ORDER BY _sdc_sequence DESC) lv
    FROM refunds
   	) 
WHERE lv = _sdc_sequence


2018-04-18 11:44:53,277: Model SQL (mappings_ga_proc):
select 
client,
account,
client_name,
source,
medium,
max(platform_n) platform,
max(channel_n) channel,
time_of_entry
from  ( 

SELECT  
client,
account,
client_name,
source,
medium,
platform as platform_n,
channel as channel_n,
time_of_entry,
first_value(time_of_entry) OVER (PARTITION BY client, source, medium ORDER BY time_of_entry DESC) lv
FROM `growth-engines-pipeline.agency_data_pipeline.mappings_ga` 

) 

WHERE lv = time_of_entry
and client in (select client from `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc` )
group by client, account, client_name, source, medium, platform_n, channel_n, time_of_entry
2018-04-18 11:44:53,287: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d7afcf8>]}
2018-04-18 11:44:53,571: 11:44:53 | 14 of 93 OK created table model agency_data_pipeline.ga_mcf_proc..... [CREATE TABLE in 6.89s]
2018-04-18 11:44:53,571: 11:44:53 | 21 of 93 START table model agency_data_pipeline.fb_ads_insights_conversions [RUN]
2018-04-18 11:44:53,571: Compiling model.agency_data_pipeline.fb_ads_insights_conversions
2018-04-18 11:44:53,581: Acquiring new bigquery connection "fb_ads_insights_conversions".
2018-04-18 11:44:53,581: Re-using an available connection from the pool.
2018-04-18 11:44:53,581: Fetching data for query fb_ads_insights_conversions:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 11:44:54,016: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_insights_conversions"
2018-04-18 11:44:54,502: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d74beb8>]}
2018-04-18 11:44:54,748: 11:44:54 | 19 of 93 OK created table model agency_data_pipeline.fb_adcreative... [CREATE TABLE in 3.79s]
2018-04-18 11:44:54,964: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d7cc668>]}
2018-04-18 11:44:54,989: Model SQL (fb_ads_insights_conversions):




with fb_ads_insights_conversions as (

	    
		   	SELECT 
			date_start,
			campaign_id,
			campaign_name,
			ad_id,
			account_name,
			spend,
			reach,
			inline_link_clicks,
			_sdc_sequence,
			action_type,
			value
			FROM `growth-engines-pipeline.fb_ads_luca_danni.ads_insights`
			cross join unnest(actions)
		    
	   

)

SELECT * 
FROM 
	(
    SELECT
    date_start date,
    campaign_id,
    campaign_name campaign,
    ad_id,
    account_name account,
    action_type,
    value conversions,
    first_value(_sdc_sequence) OVER (PARTITION BY ad_id, date_start ORDER BY _sdc_sequence DESC) lv,
    _sdc_sequence
    FROM fb_ads_insights_conversions
   	)
where lv = _sdc_sequence
and action_type like '%purchase%'


2018-04-18 11:44:55,242: 11:44:55 | 18 of 93 OK created table model agency_data_pipeline.shopify_refunds_proc [CREATE TABLE in 4.63s]
2018-04-18 11:44:56,789: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d6c3eb8>]}
2018-04-18 11:44:57,400: 11:44:57 | 20 of 93 OK created table model agency_data_pipeline.mappings_ga_proc [CREATE TABLE in 4.45s]
2018-04-18 11:44:59,974: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d7afcf8>]}
2018-04-18 11:45:00,255: 11:45:00 | 21 of 93 OK created table model agency_data_pipeline.fb_ads_insights_conversions [CREATE TABLE in 6.40s]
2018-04-18 11:45:00,256: 11:45:00 | 22 of 93 START table model agency_data_pipeline.shopify_customers_proc [RUN]
2018-04-18 11:45:00,257: Compiling model.agency_data_pipeline.shopify_customers_proc
2018-04-18 11:45:00,257: 11:45:00 | 23 of 93 START table model agency_data_pipeline.fb_ads............... [RUN]
2018-04-18 11:45:00,269: Acquiring new bigquery connection "shopify_customers_proc".
2018-04-18 11:45:00,269: Compiling model.agency_data_pipeline.fb_ads
2018-04-18 11:45:00,269: Re-using an available connection from the pool.
2018-04-18 11:45:00,279: Acquiring new bigquery connection "fb_ads".
2018-04-18 11:45:00,279: Fetching data for query shopify_customers_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 11:45:00,279: Re-using an available connection from the pool.
2018-04-18 11:45:00,280: Fetching data for query fb_ads:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'FB Ads'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 11:45:00,773: Writing injected SQL for node "model.agency_data_pipeline.shopify_customers_proc"
2018-04-18 11:45:00,778: Writing injected SQL for node "model.agency_data_pipeline.fb_ads"
2018-04-18 11:45:01,708: Model SQL (fb_ads):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`fb_adcreative`





with fb_ads as (

	    
		   	SELECT 
			id ad_id,
			creative.creative_id creative_id,
			_sdc_sequence
			FROM `growth-engines-pipeline.fb_ads_luca_danni.ads`
		     
	   

)

SELECT
a.ad_id,
b.creative_id,
b.url
FROM (
    SELECT
    ad_id,
    creative_id,
    first_value(_sdc_sequence) OVER (PARTITION BY ad_id ORDER BY _sdc_sequence DESC) lv,
    _sdc_sequence
    FROM fb_ads
    ) a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`fb_adcreative` b
ON (
	a.creative_id = b.creative_id 
)
WHERE a.lv = a._sdc_sequence


2018-04-18 11:45:01,742: Model SQL (shopify_customers_proc):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc`





with customers as (

	
	SELECT
	'lucadanni' client_name,
	'Shopify' as lookup_platform,
	cast(created_at as date) created_at,
	id,
	first_name,
	last_name,
	email,
	_sdc_sequence,
	first_value(_sdc_sequence) over (partition by id, _sdc_sequence order by _sdc_sequence desc) lv
	FROM `growth-engines-pipeline.shopify_lucadanni.customers` 
	
	

)

SELECT
account,
client,
platform,
id,
min(created_at) created_at,
max(first_name) first_name,
max(last_name) last_name,
max(email) email
FROM (
	SELECT
	b.account,
	b.client,
	b.platform,
	created_at,
	id,
	first_name,
	last_name,
	email
	FROM customers a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
	ON ( a.client_name = b.client_name
	  AND a.lookup_platform = b.platform )
	where a.lv = a._sdc_sequence
)
group by account, client, platform, id

2018-04-18 11:45:04,023: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a375dd8>]}
2018-04-18 11:45:04,312: 11:45:04 | 23 of 93 OK created table model agency_data_pipeline.fb_ads.......... [CREATE TABLE in 3.75s]
2018-04-18 11:45:07,316: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d6c3b00>]}
2018-04-18 11:45:07,600: 11:45:07 | 22 of 93 OK created table model agency_data_pipeline.shopify_customers_proc [CREATE TABLE in 7.06s]
2018-04-18 11:45:07,601: 11:45:07 | 24 of 93 START table model agency_data_pipeline.agg_customers_union.. [RUN]
2018-04-18 11:45:07,601: 11:45:07 | 25 of 93 START table model agency_data_pipeline.ga_mcf_stats......... [RUN]
2018-04-18 11:45:07,601: Compiling model.agency_data_pipeline.agg_customers_union
2018-04-18 11:45:07,601: 11:45:07 | 26 of 93 START table model agency_data_pipeline.bing_ads_stats....... [RUN]
2018-04-18 11:45:07,602: Compiling model.agency_data_pipeline.ga_mcf_stats
2018-04-18 11:45:07,601: 11:45:07 | 27 of 93 START table model agency_data_pipeline.shopify_orders_proc.. [RUN]
2018-04-18 11:45:07,607: Writing injected SQL for node "model.agency_data_pipeline.agg_customers_union"
2018-04-18 11:45:07,607: Compiling model.agency_data_pipeline.bing_ads_stats
2018-04-18 11:45:07,615: Writing injected SQL for node "model.agency_data_pipeline.ga_mcf_stats"
2018-04-18 11:45:07,615: Compiling model.agency_data_pipeline.shopify_orders_proc
2018-04-18 11:45:07,622: Writing injected SQL for node "model.agency_data_pipeline.bing_ads_stats"
2018-04-18 11:45:07,629: Acquiring new bigquery connection "agg_customers_union".
2018-04-18 11:45:07,644: Re-using an available connection from the pool.
2018-04-18 11:45:07,641: Acquiring new bigquery connection "shopify_orders_proc".
2018-04-18 11:45:07,648: Re-using an available connection from the pool.
2018-04-18 11:45:07,649: Fetching data for query shopify_orders_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 11:45:07,644: Acquiring new bigquery connection "bing_ads_stats".
2018-04-18 11:45:07,659: Re-using an available connection from the pool.
2018-04-18 11:45:07,663: Acquiring new bigquery connection "ga_mcf_stats".
2018-04-18 11:45:07,670: Re-using an available connection from the pool.
2018-04-18 11:45:08,228: Writing injected SQL for node "model.agency_data_pipeline.shopify_orders_proc"
2018-04-18 11:45:08,895: Model SQL (ga_mcf_stats):
SELECT  
date,
a.account account,
b.client client,
case when c.platform is null then "Unmapped" else c.platform end as platform,
case when c.channel is null then "Unmapped" else c.channel end as channel,
lower(a.source) source,
lower(a.medium) medium,
lower(campaign) campaign,
transactionid,
sum(transactions) first_touch_transactions,
sum(revenue) first_touch_revenue
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`ga_mcf_proc` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc` b 
ON ( a.account = b.account and
	a.lookup_platform = b.platform )
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc` c
ON ( lower(a.source) = c.source
  AND lower(a.medium) = c.medium 
  and a.account = c.account )
group by date, account, client, source, medium, campaign, platform, channel, transactionid
2018-04-18 11:45:08,898: Model SQL (bing_ads_stats):
select
a.date, 
a.account, 
a.channel,
a.platform,
url,
a.campaignname campaign,
utm_campaign,
cost,
clicks,
impressions,
transactions
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`bing_ads_ads` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`bing_ads_conversions` b
ON (
	a.date = b.date AND
	a.account = b.account AND
	a.campaignid = b.campaignid

)
2018-04-18 11:45:08,966: Model SQL (agg_customers_union):
SELECT *
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`shopify_customers_proc`
2018-04-18 11:45:09,280: Model SQL (shopify_orders_proc):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc`, `growth-engines-pipeline`.`agency_data_pipeline`.`shopify_refunds_proc`





with orders as (

	
	SELECT
	'lucadanni' client_name,
	'Shopify' as lookup_platform,
	created_at,
	order_number,
	quantity,
	cast(pre_tax_price as float64) price, 
	total_line_items_price total_order_price_undiscounted,
	total_discounts,
	cast(discounted_price as float64) total_order_shipping_price,
	total_price_usd total_order_price_incl_shipping,
	checkout_id,
	product_id, 
	landing_site,
	sku, 
	variant_title, 
	variant_id,
	_id line_item_id,
	customer.id customer_id,
	customer.orders_count orders_count,
	customer.created_at customer_created_at,
	customer.last_order_id last_order_id,
	financial_status,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY order_number, _id ORDER BY _sdc_sequence DESC) lv
	FROM `growth-engines-pipeline.shopify_lucadanni.orders` 
	cross join unnest(line_items), unnest(shipping_lines)
	where source_name != 'shopify_draft_order'
	
	

)

SELECT
b.account,
b.client,
b.platform,
created_at,
a.order_number,
a.quantity,
c.quantity refund_quantity,
case when c.quantity is not null then a.quantity - c.quantity else a.quantity end as final_quantity,
price, 
total_order_price_undiscounted,
total_discounts,
total_order_shipping_price,
total_order_price_incl_shipping,
refund_amount,
case when refund_amount is not null then price - refund_amount else price end as final_price,
a.checkout_id,
a.product_id, 
landing_site,
sku, 
variant_title, 
a.variant_id,
a.line_item_id,	
customer_id,
orders_count,
customer_created_at,
last_order_id,
a.financial_status
FROM orders a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
ON ( a.client_name = b.client_name
  AND a.lookup_platform = b.platform )
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`shopify_refunds_proc` c
ON ( a.order_number = c.order_number
	AND a.line_item_id = c.line_item_id )   	
where a.lv = a._sdc_sequence


2018-04-18 11:45:11,239: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a2efcf8>]}
2018-04-18 11:45:11,497: 11:45:11 | 26 of 93 OK created table model agency_data_pipeline.bing_ads_stats.. [CREATE TABLE in 3.63s]
2018-04-18 11:45:11,498: 11:45:11 | 28 of 93 START table model agency_data_pipeline.shopify_products_proc [RUN]
2018-04-18 11:45:11,498: Compiling model.agency_data_pipeline.shopify_products_proc
2018-04-18 11:45:11,508: Acquiring new bigquery connection "shopify_products_proc".
2018-04-18 11:45:11,508: Re-using an available connection from the pool.
2018-04-18 11:45:11,508: Fetching data for query shopify_products_proc:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Shopify'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 11:45:11,872: Writing injected SQL for node "model.agency_data_pipeline.shopify_products_proc"
2018-04-18 11:45:12,703: Model SQL (shopify_products_proc):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc`, `growth-engines-pipeline`.`agency_data_pipeline`.`shopify_refunds_proc`





with products as (

	
	SELECT
	'lucadanni' client_name,
	'Shopify' as lookup_platform,
	product_type,
	product_id,
	sku,
	_sdc_sequence,
	first_value(_sdc_sequence) OVER (PARTITION BY product_id ORDER BY _sdc_sequence DESC) lv
	FROM `growth-engines-pipeline.shopify_lucadanni.products` 
	cross join unnest(variants)
	
	

)

SELECT
b.account,
b.client,
b.platform,
max(product_type) product_type,
product_id,
sku
FROM products a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
ON ( a.client_name = b.client_name
  AND a.lookup_platform = b.platform )
where a.lv = a._sdc_sequence
group by product_id, account, client, platform, sku


2018-04-18 11:45:13,408: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a2c8a20>]}
2018-04-18 11:45:13,810: 11:45:13 | 24 of 93 OK created table model agency_data_pipeline.agg_customers_union [CREATE TABLE in 5.81s]
2018-04-18 11:45:14,979: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a2ed668>]}
2018-04-18 11:45:15,092: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a375cf8>]}
2018-04-18 11:45:15,207: 11:45:15 | 25 of 93 OK created table model agency_data_pipeline.ga_mcf_stats.... [CREATE TABLE in 7.38s]
2018-04-18 11:45:15,444: 11:45:15 | 28 of 93 OK created table model agency_data_pipeline.shopify_products_proc [CREATE TABLE in 3.59s]
2018-04-18 11:45:18,349: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a38cfd0>]}
2018-04-18 11:45:18,616: 11:45:18 | 27 of 93 OK created table model agency_data_pipeline.shopify_orders_proc [CREATE TABLE in 10.73s]
2018-04-18 11:45:18,618: 11:45:18 | 29 of 93 START table model agency_data_pipeline.ga_transactions...... [RUN]
2018-04-18 11:45:18,618: 11:45:18 | 30 of 93 START table model agency_data_pipeline.ga_traffic........... [RUN]
2018-04-18 11:45:18,618: 11:45:18 | 31 of 93 START table model agency_data_pipeline.adwords_join......... [RUN]
2018-04-18 11:45:18,618: 11:45:18 | 32 of 93 START table model agency_data_pipeline.agg_products......... [RUN]
2018-04-18 11:45:18,618: Compiling model.agency_data_pipeline.ga_transactions
2018-04-18 11:45:18,619: Compiling model.agency_data_pipeline.ga_traffic
2018-04-18 11:45:18,619: Compiling model.agency_data_pipeline.adwords_join
2018-04-18 11:45:18,619: Compiling model.agency_data_pipeline.agg_products
2018-04-18 11:45:18,646: Acquiring new bigquery connection "ga_traffic".
2018-04-18 11:45:18,653: Acquiring new bigquery connection "ga_transactions".
2018-04-18 11:45:18,655: Writing injected SQL for node "model.agency_data_pipeline.adwords_join"
2018-04-18 11:45:18,663: Writing injected SQL for node "model.agency_data_pipeline.agg_products"
2018-04-18 11:45:18,663: Re-using an available connection from the pool.
2018-04-18 11:45:18,664: Fetching data for query ga_traffic:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'GA Traffic'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 11:45:18,664: Re-using an available connection from the pool.
2018-04-18 11:45:18,664: Fetching data for query ga_transactions:


        select
            client_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc`

        
        ##where 1 = 1
        where platform = 'Google Analytics'
        
        
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 11:45:18,665: Acquiring new bigquery connection "adwords_join".
2018-04-18 11:45:18,667: Acquiring new bigquery connection "agg_products".
2018-04-18 11:45:18,667: Re-using an available connection from the pool.
2018-04-18 11:45:18,671: Re-using an available connection from the pool.
2018-04-18 11:45:19,800: Model SQL (adwords_join):
select
a.day,
a.campaignid, 
a.campaign,
a.account, 
channel,
platform,
url,
utm_campaign,
cost,
impressions,
clicks,
impression_share_num,
impression_share_den,
transactions
FROM ( 
	
	select
	day,
	a.campaign,
	a.campaignid, 
	account, 
	channel,
	platform,
	url,
	cost,
	impressions,
	clicks,
	impression_share_num,
	impression_share_den
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_campaigns` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_urls` b
	ON a.campaignid = b.campaignid

) a 
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_ads` b
ON ( a.campaignid = b.campaignid
	and a.day = b.day )
2018-04-18 11:45:19,801: Model SQL (agg_products):
SELECT 
account,
client,
platform,
product_type,
product_id,
sku
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`shopify_products_proc`
2018-04-18 11:45:19,901: Fetching data for query ga_transactions:


        select
            goal_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_conversions`

        
        ##where 1 = 1
        where goal_type = 'Conversion'
        
        
        
        ##and 2 = 2
        and client_name = 'lucadanni'
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 11:45:20,125: Fetching data for query ga_traffic:


        select
            goal_name as value

        from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_conversions`

        
        ##where 1 = 1
        where goal_type = 'Conversion'
        
        
        
        ##and 2 = 2
        and client_name = 'lucadanni'
        

        group by 1
        order by count(*) desc

        
        limit 50
        
2018-04-18 11:45:20,965: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d7afcf8>]}
2018-04-18 11:45:21,243: Writing injected SQL for node "model.agency_data_pipeline.ga_transactions"
2018-04-18 11:45:21,431: 11:45:21 | 32 of 93 OK created table model agency_data_pipeline.agg_products.... [CREATE TABLE in 2.35s]
2018-04-18 11:45:21,489: Writing injected SQL for node "model.agency_data_pipeline.ga_traffic"
2018-04-18 11:45:22,415: Model SQL (ga_transactions):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc`, `growth-engines-pipeline`.`agency_data_pipeline`.`ga_conversions`


##`growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` 



with ga_report as (

	    

	    	
	    	
		   	SELECT
		   	'lucadanni' as client_name,
		   	'Google Analytics' as lookup_platform,
			lower(trim(regexp_replace(replace(replace(replace(replace(CONCAT(hostname,landingpagepath),'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
			date,
			lower(source) source,
			lower(medium) medium,
			lower(campaign) campaign,
			cast(regexp_replace(transactionid, r'#', '') as int64) transactionid,
			transactions last_touch_transactions,
			(transactionrevenue - transactionshipping - transactiontax) as last_touch_revenue,
			transactionshipping,
			transactiontax,
			_sdc_sequence,
			first_value(_sdc_sequence) OVER (PARTITION BY hostname, landingpagepath, date, source, medium, transactionid ORDER BY _sdc_sequence DESC) lv
			FROM `growth-engines-pipeline.ga_lucadanni.report` 

		    
	   

)


SELECT  
cast(date as date) date,
b.account,
b.client client,
c.source source,
c.medium medium,
a.campaign campaign,
concat(a.source, ' / ', a.medium) source_medium,  
case when c.platform is null then "Unmapped" else c.platform end as platform,
case when c.channel is null then "Unmapped" else c.channel end as channel,
regexp_replace(url, r'offers.|offer.|get.|info.|pos.|go.|join.|pages.','') url,
transactionid,
max(last_touch_transactions) last_touch_transactions,
max(last_touch_revenue) last_touch_revenue,
max(transactionshipping) last_touch_shipping,
max(transactiontax) last_touch_tax
FROM ga_report a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
ON ( a.client_name = b.client_name 
	AND a.lookup_platform = b.platform )
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc` c
ON ( a.source = c.source
  AND a.medium = c.medium 
  AND a.client_name = c.client_name )
GROUP BY date, account, client, source, medium, campaign, source_medium, platform, channel, url, transactionid


2018-04-18 11:45:22,780: Model SQL (ga_traffic):
-- depends_on: `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc`, `growth-engines-pipeline`.`agency_data_pipeline`.`ga_conversions`


##`growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` 



with ga_report as (

	    

	    	
	    	
		   	SELECT
		   	'lucadanni' as client_name,
		   	'GA Traffic' as lookup_platform,
			lower(trim(regexp_replace(replace(replace(replace(replace(CONCAT(hostname,landingpagepath),'www.',''),'http://',''),'https://',''),'.html',''),r'\?.*$',''),'/')) as url,
			date,
			lower(source) source,
			lower(medium) medium,
			lower(campaign) campaign,
			sessions,
			## goal completion columns
							
				goalcompletionsall as goal_completions,		
			
			_sdc_sequence,
			first_value(_sdc_sequence) OVER (PARTITION BY hostname, landingpagepath, date, source, medium, campaign ORDER BY _sdc_sequence DESC) lv
			FROM `growth-engines-pipeline.ga_lucadanni_traffic.report` 

		    
	   

)


SELECT  
cast(date as date) date,
b.account,
b.client client,
c.source source,
c.medium medium,
a.campaign campaign,
concat(a.source, ' / ', a.medium) source_medium,  
case when c.platform is null then "Unmapped" else c.platform end as platform,
case when c.channel is null then "Unmapped" else c.channel end as channel,
regexp_replace(url, r'offers.|offer.|get.|info.|pos.|go.|join.|pages.','') url,
max(sessions) sessions,
max(goal_completions) goal_completions
FROM ga_report a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`clients_proc` b 
ON ( a.client_name = b.client_name 
	AND a.lookup_platform = b.platform )
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`mappings_ga_proc` c
ON ( a.source = c.source
  AND a.medium = c.medium 
  AND a.client_name = c.client_name )
GROUP BY date, account, client, source, medium, campaign, source_medium, platform, channel, url


2018-04-18 11:45:25,453: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a35db00>]}
2018-04-18 11:45:26,172: 11:45:26 | 31 of 93 OK created table model agency_data_pipeline.adwords_join.... [CREATE TABLE in 6.83s]
2018-04-18 11:45:27,940: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d6c3b00>]}
2018-04-18 11:45:28,232: 11:45:28 | 29 of 93 OK created table model agency_data_pipeline.ga_transactions. [CREATE TABLE in 9.32s]
2018-04-18 11:45:33,974: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d7cc780>]}
2018-04-18 11:45:34,213: 11:45:34 | 30 of 93 OK created table model agency_data_pipeline.ga_traffic...... [CREATE TABLE in 15.36s]
2018-04-18 11:45:34,214: 11:45:34 | 33 of 93 START table model agency_data_pipeline.adwords_impression_share [RUN]
2018-04-18 11:45:34,214: 11:45:34 | 34 of 93 START table model agency_data_pipeline.adwords_stats........ [RUN]
2018-04-18 11:45:34,215: Compiling model.agency_data_pipeline.adwords_stats
2018-04-18 11:45:34,215: 11:45:34 | 35 of 93 START table model agency_data_pipeline.fb_ads_stats......... [RUN]
2018-04-18 11:45:34,220: Writing injected SQL for node "model.agency_data_pipeline.adwords_stats"
2018-04-18 11:45:34,214: Compiling model.agency_data_pipeline.adwords_impression_share
2018-04-18 11:45:34,220: Compiling model.agency_data_pipeline.fb_ads_stats
2018-04-18 11:45:34,225: Writing injected SQL for node "model.agency_data_pipeline.adwords_impression_share"
2018-04-18 11:45:34,231: Writing injected SQL for node "model.agency_data_pipeline.fb_ads_stats"
2018-04-18 11:45:34,232: Acquiring new bigquery connection "adwords_stats".
2018-04-18 11:45:34,232: Re-using an available connection from the pool.
2018-04-18 11:45:34,233: Acquiring new bigquery connection "adwords_impression_share".
2018-04-18 11:45:34,235: Acquiring new bigquery connection "fb_ads_stats".
2018-04-18 11:45:34,235: Re-using an available connection from the pool.
2018-04-18 11:45:34,235: Re-using an available connection from the pool.
2018-04-18 11:45:35,259: Model SQL (adwords_impression_share):
SELECT 
cast(day as date) date, 
account, 
channel,
platform,
sum(impression_share_num) impressions,
sum(impression_share_den) available_impressions
FROM 
  `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_join`
group by date, account, platform, channel
2018-04-18 11:45:35,350: Model SQL (fb_ads_stats):
with cost as (

    select 
        date, account, ad_id, campaign,
        cost, impressions, clicks, null as conversions
    from `growth-engines-pipeline`.`agency_data_pipeline`.`fb_ads_insights`
),

conversions as (

    select 
        date, account, ad_id, campaign,
        null as cost, null as impressions, null as clicks, conversions
    from `growth-engines-pipeline`.`agency_data_pipeline`.`fb_ads_insights_conversions`
),

urls as (

    select ad_id, url
    from `growth-engines-pipeline`.`agency_data_pipeline`.`fb_ads`
)


SELECT
    cast(date as date) date,
    'FB Ads' platform,
    'Paid' channel,
    account, 
    b.url url,
    campaign,
    lower(campaign) utm_campaign, 
    sum(cost) cost,
    sum(impressions) impressions,
    sum(clicks) clicks,
    sum(conversions) transactions
FROM
(
    SELECT *
    FROM 
      cost
    UNION ALL
    SELECT *
    FROM 
      conversions
) a
LEFT JOIN urls b
ON ( a.ad_id = b.ad_id )
group by date, platform, channel, account, url, campaign, utm_campaign
2018-04-18 11:45:36,274: Model SQL (adwords_stats):
SELECT 
cast(day as date) date, 
account, 
platform,
channel,
url,
utm_campaign,
campaign,
sum(cost) cost,
sum(impressions) impressions,
sum(clicks) clicks,
sum(transactions) transactions
FROM 
  `growth-engines-pipeline`.`agency_data_pipeline`.`adwords_join`
group by date, account, platform, channel, url, campaign, utm_campaign
2018-04-18 11:45:37,484: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d7d0c50>]}
2018-04-18 11:45:38,281: 11:45:38 | 33 of 93 OK created table model agency_data_pipeline.adwords_impression_share [CREATE TABLE in 3.27s]
2018-04-18 11:45:38,789: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a35ddd8>]}
2018-04-18 11:45:39,091: 11:45:39 | 35 of 93 OK created table model agency_data_pipeline.fb_ads_stats.... [CREATE TABLE in 4.57s]
2018-04-18 11:45:41,786: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a375080>]}
2018-04-18 11:45:42,057: 11:45:42 | 34 of 93 OK created table model agency_data_pipeline.adwords_stats... [CREATE TABLE in 7.57s]
2018-04-18 11:45:42,058: 11:45:42 | 36 of 93 START table model agency_data_pipeline.agg_products_cogs.... [RUN]
2018-04-18 11:45:42,059: Compiling model.agency_data_pipeline.agg_products_cogs
2018-04-18 11:45:42,069: Writing injected SQL for node "model.agency_data_pipeline.agg_products_cogs"
2018-04-18 11:45:42,070: Acquiring new bigquery connection "agg_products_cogs".
2018-04-18 11:45:42,071: Re-using an available connection from the pool.
2018-04-18 11:45:43,030: Model SQL (agg_products_cogs):
with cogs_all as (

	SELECT 
	client,
	cogs_dol,
	cogs_pct
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`cogs_proc`
	WHERE sku = 'All'

),

cogs_sku as (

	SELECT 
	client,
	sku,
	cogs_dol,
	cogs_pct
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`cogs_proc`
	WHERE sku != 'All'

),

products as (

	SELECT 
	client,
	product_type,
	product_id,
	sku
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_products`

)


SELECT 
a.client,
product_type,
product_id,
sku,
b.cogs_dol,
b.cogs_pct
FROM products a
LEFT JOIN cogs_all b
ON (
	a.client = b.client
)
WHERE b.cogs_dol > 0 or b.cogs_pct > 0

UNION ALL

SELECT 
c.client,
product_type,
product_id,
c.sku,
d.cogs_dol,
d.cogs_pct
FROM products c
LEFT JOIN cogs_sku d
ON (
	c.client = d.client and
	c.sku = d.sku
)
WHERE d.cogs_dol > 0 or d.cogs_pct > 0
2018-04-18 11:45:45,234: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a369f60>]}
2018-04-18 11:45:45,509: 11:45:45 | 36 of 93 OK created table model agency_data_pipeline.agg_products_cogs [CREATE TABLE in 3.18s]
2018-04-18 11:45:45,512: 11:45:45 | 37 of 93 START table model agency_data_pipeline.agg_ga_transaction_order_number [RUN]
2018-04-18 11:45:45,513: Compiling model.agency_data_pipeline.agg_ga_transaction_order_number
2018-04-18 11:45:45,532: Writing injected SQL for node "model.agency_data_pipeline.agg_ga_transaction_order_number"
2018-04-18 11:45:45,539: Acquiring new bigquery connection "agg_ga_transaction_order_number".
2018-04-18 11:45:45,540: Re-using an available connection from the pool.
2018-04-18 11:45:46,545: Model SQL (agg_ga_transaction_order_number):
with ga as (

    select 
        date, account, client, 
        channel as last_touch_channel, 
        platform as last_touch_platform, 
        url as last_touch_url, 
        campaign as last_touch_utm_campaign, 
        '' as first_touch_channel, 
        '' as first_touch_platform, 
        '' as first_touch_utm_campaign, 
        transactionid,
        last_touch_transactions, last_touch_revenue,
        last_touch_shipping, last_touch_tax,
        null as first_touch_transactions, null as first_touch_revenue
    from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_transactions`

),

ga_mcf as (

    select 
        date, account, client, 
        '' as last_touch_channel,
        '' as last_touch_platform,
        '' as last_touch_url,
        '' as last_touch_utm_campaign, 
        channel as first_touch_channel, 
        platform as first_touch_platform, 
        campaign as first_touch_utm_campaign, 
        transactionid, 
        null as last_touch_transactions, null as last_touch_revenue,
        null as last_touch_shipping, null as last_touch_tax,
        first_touch_transactions, first_touch_revenue
    from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_mcf_stats`

)


SELECT
    date, 
    client,
    transactionid,
    max(last_touch_channel) last_touch_channel, 
    max(last_touch_platform) last_touch_platform, 
    max(last_touch_url) last_touch_url, 
    max(last_touch_utm_campaign) last_touch_utm_campaign, 
    max(first_touch_channel) first_touch_channel, 
    max(first_touch_platform) first_touch_platform, 
    max(first_touch_utm_campaign) first_touch_utm_campaign,
    sum(last_touch_transactions) last_touch_transactions,
    sum(last_touch_revenue) last_touch_revenue,
    sum(last_touch_shipping) last_touch_shipping_revenue,
    sum(last_touch_tax) last_touch_tax_revenue,
    sum(first_touch_transactions) first_touch_transactions,
    sum(first_touch_revenue) - ifnull(sum(last_touch_shipping),0) - ifnull(sum(last_touch_tax),0) first_touch_revenue
FROM
(
    SELECT *
    FROM 
      ga
    UNION ALL
    SELECT *
    FROM 
      ga_mcf
) 
GROUP BY
    date, client, transactionid
2018-04-18 11:45:51,020: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a2ef0f0>]}
2018-04-18 11:45:51,305: 11:45:51 | 37 of 93 OK created table model agency_data_pipeline.agg_ga_transaction_order_number [CREATE TABLE in 5.51s]
2018-04-18 11:45:51,306: 11:45:51 | 38 of 93 START table model agency_data_pipeline.agg_ga_campaign...... [RUN]
2018-04-18 11:45:51,307: Compiling model.agency_data_pipeline.agg_ga_campaign
2018-04-18 11:45:51,307: 11:45:51 | 39 of 93 START table model agency_data_pipeline.agg_orders_union..... [RUN]
2018-04-18 11:45:51,318: Writing injected SQL for node "model.agency_data_pipeline.agg_ga_campaign"
2018-04-18 11:45:51,319: Compiling model.agency_data_pipeline.agg_orders_union
2018-04-18 11:45:51,330: Writing injected SQL for node "model.agency_data_pipeline.agg_orders_union"
2018-04-18 11:45:51,332: Acquiring new bigquery connection "agg_ga_campaign".
2018-04-18 11:45:51,332: Re-using an available connection from the pool.
2018-04-18 11:45:51,333: Acquiring new bigquery connection "agg_orders_union".
2018-04-18 11:45:51,335: Re-using an available connection from the pool.
2018-04-18 11:45:52,150: Model SQL (agg_orders_union):
with shopify as (
	SELECT
	account,
	client,
	platform,
	created_at,
	order_number,
	quantity,
	refund_quantity,
	final_quantity,
	price, 
	total_order_price_undiscounted,
	total_discounts,
	total_order_shipping_price,
	total_order_price_incl_shipping,
	refund_amount,
	final_price,
	checkout_id,
	product_id, 
	landing_site,
	sku, 
	variant_title, 
	variant_id,
	line_item_id,	
	customer_id,
	orders_count,
	customer_created_at,
	last_order_id,
	financial_status
	FROM
	`growth-engines-pipeline`.`agency_data_pipeline`.`shopify_orders_proc`
)

SELECT 
account,
a.client,
platform,
created_at,
order_number,
quantity,
refund_quantity,
final_quantity,
price, 
total_order_price_undiscounted,
total_discounts,
total_order_shipping_price,
total_order_price_incl_shipping,
refund_amount,
final_price,
case when b.cogs_dol > 0 then b.cogs_dol
	when b.cogs_pct > 0 then final_price * b.cogs_pct
	else null end as cogs,
case when b.cogs_dol > 0 then final_price - b.cogs_dol
	when b.cogs_pct > 0 then final_price * (1 - b.cogs_pct) 
	else final_price end as net_price, 
checkout_id,
a.product_id, 
landing_site,
a.sku, 
variant_title, 
variant_id,
line_item_id,	
customer_id,
orders_count,
customer_created_at,
last_order_id,
financial_status,
b.cogs_dol,
b.cogs_pct
FROM (

	SELECT * FROM shopify

) a 
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`agg_products_cogs` b
ON ( 
	a.client = b.client
	and a.sku = b.sku
)
2018-04-18 11:45:52,289: Model SQL (agg_ga_campaign):
with ga_transactions as (

	select 
		date, account, client, channel, platform, url, 
		campaign,
		null as sessions, null as goal_completions, last_touch_transactions, last_touch_revenue,
		last_touch_shipping, last_touch_tax,
		null as first_touch_transactions, null as first_touch_revenue
	from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_transactions`

),

ga_traffic as (

    select 
        date, account, client, channel, platform, url, 
        campaign,
        sessions, goal_completions, null as last_touch_transactions, null as last_touch_revenue,
        null as last_touch_shipping, null as last_touch_tax,
        null as first_touch_transactions, null as first_touch_revenue
    from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_traffic`

),

ga_mcf as (

	select 
		date, account, client, channel, platform, '' as url,
		campaign, 
		null as sessions, null as goal_completions, null as last_touch_transactions, null as last_touch_revenue,
		null as last_touch_shipping, null as last_touch_tax,
		first_touch_transactions, first_touch_revenue
	from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_mcf_stats`

)


SELECT
    date, 
    client,
    platform,
    channel, 
    url,
    campaign utm_campaign,
	sum(sessions) sessions,
	sum(goal_completions) goal_completions,
	sum(last_touch_transactions) last_touch_transactions,
	sum(last_touch_revenue) last_touch_revenue,
    sum(last_touch_shipping) last_touch_shipping_revenue,
    sum(last_touch_tax) last_touch_tax_revenue,
    sum(first_touch_transactions) first_touch_transactions,
    sum(first_touch_revenue) - sum(ifnull(last_touch_shipping,0)) - sum(ifnull(last_touch_tax,0)) first_touch_revenue

FROM
(
    SELECT *
    FROM 
      ga_transactions
    UNION ALL
    SELECT *
    FROM 
      ga_traffic
    UNION ALL
    SELECT *
    FROM 
      ga_mcf
) 
GROUP BY
    date, client, platform, channel, url, utm_campaign
2018-04-18 11:45:59,944: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a2daf60>]}
2018-04-18 11:46:00,210: 11:46:00 | 39 of 93 OK created table model agency_data_pipeline.agg_orders_union [CREATE TABLE in 8.62s]
2018-04-18 11:46:01,133: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a35d278>]}
2018-04-18 11:46:01,377: 11:46:01 | 38 of 93 OK created table model agency_data_pipeline.agg_ga_campaign. [CREATE TABLE in 9.83s]
2018-04-18 11:46:01,378: 11:46:01 | 40 of 93 START table model agency_data_pipeline.agg_transaction_line_item [RUN]
2018-04-18 11:46:01,379: Compiling model.agency_data_pipeline.agg_transaction_line_item
2018-04-18 11:46:01,379: 11:46:01 | 41 of 93 START table model agency_data_pipeline.agg_transaction_order_number [RUN]
2018-04-18 11:46:01,387: Writing injected SQL for node "model.agency_data_pipeline.agg_transaction_line_item"
2018-04-18 11:46:01,387: Compiling model.agency_data_pipeline.agg_transaction_order_number
2018-04-18 11:46:01,394: Writing injected SQL for node "model.agency_data_pipeline.agg_transaction_order_number"
2018-04-18 11:46:01,396: Acquiring new bigquery connection "agg_transaction_order_number".
2018-04-18 11:46:01,396: Re-using an available connection from the pool.
2018-04-18 11:46:01,397: Acquiring new bigquery connection "agg_transaction_line_item".
2018-04-18 11:46:01,398: Re-using an available connection from the pool.
2018-04-18 11:46:02,395: Model SQL (agg_transaction_line_item):
SELECT
client,
created_at,
order_number,
quantity,
refund_quantity,
final_quantity,
price, 
total_order_price_undiscounted,
total_discounts,
total_order_shipping_price,
total_order_price_incl_shipping,
refund_amount,
final_price,
cogs,
net_price,
checkout_id,
product_id, 
landing_site,
sku, 
variant_title, 
variant_id,
line_item_id,	
customer_id,
orders_count,
customer_created_at,
last_order_id,
financial_status
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`agg_orders_union`
2018-04-18 11:46:02,408: Model SQL (agg_transaction_order_number):
SELECT
client,
cast(created_at as date) date,
order_number,
customer_id,
sum(final_quantity) final_quantity,
sum(final_price) final_price,
sum(cogs) cogs,
sum(net_price) net_price,
max(total_order_shipping_price) shipping_price
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`agg_orders_union`
GROUP BY client, created_at, order_number, customer_id
2018-04-18 11:46:06,834: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a2daf60>]}
2018-04-18 11:46:07,449: 11:46:07 | 41 of 93 OK created table model agency_data_pipeline.agg_transaction_order_number [CREATE TABLE in 5.45s]
2018-04-18 11:46:10,737: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a2ed048>]}
2018-04-18 11:46:11,131: 11:46:11 | 40 of 93 OK created table model agency_data_pipeline.agg_transaction_line_item [CREATE TABLE in 9.36s]
2018-04-18 11:46:11,132: 11:46:11 | 42 of 93 START table model agency_data_pipeline.customers_by_transaction [RUN]
2018-04-18 11:46:11,132: 11:46:11 | 43 of 93 START table model agency_data_pipeline.agg_transaction_line_item_type [RUN]
2018-04-18 11:46:11,133: Compiling model.agency_data_pipeline.customers_by_transaction
2018-04-18 11:46:11,133: Compiling model.agency_data_pipeline.agg_transaction_line_item_type
2018-04-18 11:46:11,151: Writing injected SQL for node "model.agency_data_pipeline.customers_by_transaction"
2018-04-18 11:46:11,159: Writing injected SQL for node "model.agency_data_pipeline.agg_transaction_line_item_type"
2018-04-18 11:46:11,159: Acquiring new bigquery connection "customers_by_transaction".
2018-04-18 11:46:11,160: Re-using an available connection from the pool.
2018-04-18 11:46:11,161: Acquiring new bigquery connection "agg_transaction_line_item_type".
2018-04-18 11:46:11,161: Re-using an available connection from the pool.
2018-04-18 11:46:12,475: Model SQL (customers_by_transaction):
SELECT
client,
customer_id,
order_number,
order_date,
first_order_date,
case when first_order_number = order_number then 'New' else 'Existing' end as order_type,
final_price,
cogs,
net_price,
first_order_revenue,
lifetime_revenue
FROM

(

	SELECT
	client,
	customer_id,
	order_number,
	date order_date,
	first_value(date) over w1 first_order_date,
	first_value(order_number) over w1 first_order_number,
	first_value(final_price) over w1 first_order_revenue,
    final_price,
    cogs,
    net_price,
	sum(final_price) over w2 lifetime_revenue
	FROM
    `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_order_number`
	WINDOW w1 as (PARTITION BY client, customer_id ORDER BY date desc),
	w2 as (PARTITION BY client, customer_id)
)
2018-04-18 11:46:12,520: Model SQL (agg_transaction_line_item_type):
SELECT
client,
product_id,
product_type,
customer_id,
sku,
order_number,
created_at,
final_quantity,
final_price,
net_price
FROM

( 
	SELECT 
	a.client, 
	a.product_id,
	product_type,
	customer_id,
	a.sku, 
	order_number,
	created_at,
	final_quantity,
	final_price,
	net_price
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_line_item` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`agg_products` b
	ON (
		a.product_id = b.product_id
	  and a.client = b.client
		)

)
2018-04-18 11:46:15,833: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a2c8a20>]}
2018-04-18 11:46:16,584: 11:46:16 | 42 of 93 OK created table model agency_data_pipeline.customers_by_transaction [CREATE TABLE in 4.70s]
2018-04-18 11:46:23,835: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a2ef4a8>]}
2018-04-18 11:46:24,378: 11:46:24 | 43 of 93 OK created table model agency_data_pipeline.agg_transaction_line_item_type [CREATE TABLE in 12.70s]
2018-04-18 11:46:24,379: 11:46:24 | 44 of 93 START table model agency_data_pipeline.customers_first_purchase_product_type_proc [RUN]
2018-04-18 11:46:24,380: Compiling model.agency_data_pipeline.customers_first_purchase_product_type_proc
2018-04-18 11:46:24,386: 11:46:24 | 45 of 93 START table model agency_data_pipeline.frequency_proc....... [RUN]
2018-04-18 11:46:24,390: Writing injected SQL for node "model.agency_data_pipeline.customers_first_purchase_product_type_proc"
2018-04-18 11:46:24,391: Compiling model.agency_data_pipeline.frequency_proc
2018-04-18 11:46:24,391: 11:46:24 | 46 of 93 START table model agency_data_pipeline.agg_transaction_product_type [RUN]
2018-04-18 11:46:24,400: Writing injected SQL for node "model.agency_data_pipeline.frequency_proc"
2018-04-18 11:46:24,400: Compiling model.agency_data_pipeline.agg_transaction_product_type
2018-04-18 11:46:24,401: Acquiring new bigquery connection "customers_first_purchase_product_type_proc".
2018-04-18 11:46:24,406: Writing injected SQL for node "model.agency_data_pipeline.agg_transaction_product_type"
2018-04-18 11:46:24,406: Re-using an available connection from the pool.
2018-04-18 11:46:24,409: Acquiring new bigquery connection "agg_transaction_product_type".
2018-04-18 11:46:24,409: Re-using an available connection from the pool.
2018-04-18 11:46:24,411: Acquiring new bigquery connection "frequency_proc".
2018-04-18 11:46:24,411: Re-using an available connection from the pool.
2018-04-18 11:46:25,524: Model SQL (agg_transaction_product_type):
SELECT
client,
product_type,
customer_id,
order_number,
created_at,
first_value(product_type) over (PARTITION BY client, customer_id, order_number, created_at ORDER BY final_price desc) as top_order_product_type,
final_quantity,
final_price,
net_price,
sum(final_quantity) over (PARTITION BY client, customer_id, order_number) as total_order_quantity,
sum(final_price) over (PARTITION BY client, customer_id, order_number) as total_order_value,
sum(net_price) over (PARTITION BY client, customer_id, order_number) as net_order_value
FROM
	(
		SELECT
		client,
		product_type,
		customer_id,
		order_number,
		created_at,
		sum(final_quantity) final_quantity,
		sum(final_price) final_price,
		sum(net_price) net_price
		FROM
		`growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_line_item_type`
		GROUP BY
		client,
		product_type,
		customer_id,
		order_number,
		created_at
	)
2018-04-18 11:46:26,794: Model SQL (frequency_proc):
WITH transactions AS (

  	SELECT 
	client,
	customer_id,
	order_number,
	date,
	unix_date(date) d
	FROM
	`growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_order_number`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)

SELECT 
client,
'Rolling 365' as period,
date_in_range date,
unix_date_in_range, 
customer_id,
count(distinct(order_number)) frequency
FROM daterange
JOIN transactions
ON transactions.d > ( daterange.unix_date_in_range - 365 )
AND transactions.d <= daterange.unix_date_in_range
group by client, unix_date_in_range, customer_id, date
2018-04-18 11:46:26,802: Model SQL (customers_first_purchase_product_type_proc):
SELECT 
client, 
customer_id, 
product_type,
min(cast(created_at as date)) first_order_date,
unix_date( min(cast(created_at as date))) first_order_unix_date
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_line_item_type`
GROUP BY client, customer_id, product_type
2018-04-18 11:46:29,267: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d7cc588>]}
2018-04-18 11:46:29,632: 11:46:29 | 44 of 93 OK created table model agency_data_pipeline.customers_first_purchase_product_type_proc [CREATE TABLE in 4.89s]
2018-04-18 11:46:30,349: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a308588>]}
2018-04-18 11:46:30,738: 11:46:30 | 46 of 93 OK created table model agency_data_pipeline.agg_transaction_product_type [CREATE TABLE in 5.95s]
2018-04-18 11:46:40,388: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a2da4a8>]}
2018-04-18 11:46:40,776: 11:46:40 | 45 of 93 OK created table model agency_data_pipeline.frequency_proc.. [CREATE TABLE in 16.00s]
2018-04-18 11:46:40,777: 11:46:40 | 47 of 93 START table model agency_data_pipeline.order_paths_proc..... [RUN]
2018-04-18 11:46:40,777: Compiling model.agency_data_pipeline.order_paths_proc
2018-04-18 11:46:40,784: Writing injected SQL for node "model.agency_data_pipeline.order_paths_proc"
2018-04-18 11:46:40,777: 11:46:40 | 48 of 93 START table model agency_data_pipeline.frequency_stats...... [RUN]
2018-04-18 11:46:40,784: Compiling model.agency_data_pipeline.frequency_stats
2018-04-18 11:46:40,789: Writing injected SQL for node "model.agency_data_pipeline.frequency_stats"
2018-04-18 11:46:40,777: 11:46:40 | 49 of 93 START table model agency_data_pipeline.products_proc........ [RUN]
2018-04-18 11:46:40,778: 11:46:40 | 50 of 93 START table model agency_data_pipeline.customers_products_proc [RUN]
2018-04-18 11:46:40,790: Compiling model.agency_data_pipeline.products_proc
2018-04-18 11:46:40,790: Compiling model.agency_data_pipeline.customers_products_proc
2018-04-18 11:46:40,797: Writing injected SQL for node "model.agency_data_pipeline.products_proc"
2018-04-18 11:46:40,804: Writing injected SQL for node "model.agency_data_pipeline.customers_products_proc"
2018-04-18 11:46:40,805: Acquiring new bigquery connection "order_paths_proc".
2018-04-18 11:46:40,806: Re-using an available connection from the pool.
2018-04-18 11:46:40,807: Acquiring new bigquery connection "frequency_stats".
2018-04-18 11:46:40,807: Re-using an available connection from the pool.
2018-04-18 11:46:40,809: Acquiring new bigquery connection "products_proc".
2018-04-18 11:46:40,809: Re-using an available connection from the pool.
2018-04-18 11:46:40,814: Acquiring new bigquery connection "customers_products_proc".
2018-04-18 11:46:40,814: Re-using an available connection from the pool.
2018-04-18 11:46:41,994: Model SQL (order_paths_proc):
SELECT
client, 
customer_id, 
first_value(product_type) OVER w1 as first_product_type,
nth_value(product_type, 2) OVER w1 as second_product_type,
cast(first_value(created_at) OVER w1 as date) as first_purchase_date,
cast(nth_value(created_at, 2) OVER w1 as date) as second_purchase_date,
cast(nth_value(created_at, 3) OVER w1 as date) as third_purchase_date,
cast(nth_value(created_at, 4) OVER w1 as date) as fourth_purchase_date,
cast(nth_value(created_at, 5) OVER w1 as date) as fifth_purchase_date,
first_value(order_number) OVER w1 as first_order_number,
nth_value(order_number, 2) OVER w1 as second_order_number,
nth_value(order_number, 3) OVER w1 as third_order_number,
nth_value(order_number, 4) OVER w1 as fourth_order_number,
nth_value(order_number, 5) OVER w1 as fifth_order_number,
first_value(total_order_value) OVER w1 as first_order_value,
nth_value(total_order_value, 2) OVER w1 as second_order_value
FROM (
	  
	  SELECT 
	  client, 
	  product_type,
	  customer_id,
	  order_number,
	  created_at, 
	  total_order_value
	  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_product_type`
	  WHERE product_type = top_order_product_type

)
WINDOW w1 as (PARTITION BY client, customer_id ORDER BY created_at asc)
2018-04-18 11:46:42,065: Model SQL (products_proc):
WITH transactions AS (
  SELECT 
  client, 
  product_id,
  product_type,
  customer_id,
  sku, 
  order_number,
  unix_date(cast(created_at as date)) d, 
  final_quantity,
  final_price,
  first_value(unix_date(cast(created_at as date))) over (partition by client, product_id, sku order by created_at asc) first_purchase_unix_date
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_line_item_type`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)

SELECT 
client,
'Last 30' as period,
sku,
product_type,
date_in_range date,
unix_date_in_range, 
case when 
  ( first_purchase_unix_date > ( daterange.unix_date_in_range - 365 ) and first_purchase_unix_date <= daterange.unix_date_in_range )
  then 'New' else 'Existing' end as newness,  
count(distinct(customer_id)) unique_customers,
count(distinct(order_number)) orders,
sum(final_quantity) quantity,
sum(final_price) revenue,
count(distinct(d)) days_sold
FROM daterange
JOIN transactions
ON transactions.d > ( daterange.unix_date_in_range - 30 )
AND transactions.d <= daterange.unix_date_in_range
group by date_in_range, unix_date_in_range, client, sku, product_type, newness

UNION ALL

SELECT 
client,
'Last 90' as period,
sku, 
product_type,
date_in_range date,
unix_date_in_range, 
case when 
  ( first_purchase_unix_date > ( daterange.unix_date_in_range - 365 ) and first_purchase_unix_date <= daterange.unix_date_in_range )
  then 'New' else 'Existing' end as newness,  
count(distinct(customer_id)) unique_customers,
count(distinct(order_number)) orders,
sum(final_quantity) quantity,
sum(final_price) revenue,
count(distinct(d)) days_sold
FROM daterange
JOIN transactions
ON transactions.d > ( daterange.unix_date_in_range - 90 )
AND transactions.d <= daterange.unix_date_in_range
group by date_in_range, unix_date_in_range, client, sku, product_type, newness

UNION ALL

SELECT 
client,
'YoY 30' as date_range,
sku, 
product_type,
date_in_range date,
unix_date_in_range,
case when 
  ( first_purchase_unix_date > ( daterange.unix_date_in_range - 730 ) and first_purchase_unix_date <= ( daterange.unix_date_in_range - 365 ))
  then 'New' else 'Existing' end as newness,   
count(distinct(customer_id)) unique_customers,
count(distinct(order_number)) orders,
sum(final_quantity) quantity,
sum(final_price) revenue,
count(distinct(d)) days_sold
FROM daterange
JOIN transactions
ON transactions.d > ( daterange.unix_date_in_range - 395 )
AND transactions.d <= ( daterange.unix_date_in_range - 365 )
group by date_in_range, unix_date_in_range, client, sku, product_type, newness
2018-04-18 11:46:42,188: Model SQL (customers_products_proc):
WITH customers AS (
  SELECT 
  client, 
  product_id,
  product_type,
  customer_id,
  sku, 
  order_number,
  cast(created_at as date) order_date,
  unix_date(cast(created_at as date)) unix_order_date, 
  final_quantity quantity,
  final_price revenue
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_line_item_type`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)

SELECT 
client,
period,
customer_id,
product_type,
date,
window_end_unix_date,
window_end_unix_date - 365 as window_start_unix_date,
window_end_unix_date - unix_date(recent_order) recency_days,
frequency,
quantity,
revenue,
case when frequency > 0 then revenue/frequency else 0 end as aov
FROM 
(  

  SELECT 
  client,
  'Rolling 365' as period,
  customer_id,
  product_type,
  date_in_range date,
  unix_date_in_range,
  unix_date_in_range window_end_unix_date, 
  max(order_date) recent_order,
  sum(quantity) as quantity,
  sum(revenue) as revenue,
  count(distinct(order_number)) as frequency
  FROM daterange
  JOIN customers
  ON customers.unix_order_date > ( daterange.unix_date_in_range - 365 )
  AND customers.unix_order_date <= daterange.unix_date_in_range
  GROUP BY client, customer_id, date, unix_date_in_range, product_type

  UNION ALL

  SELECT 
  client,
  'Rolling 365 (t-1mo)' as period,
  customer_id,
  product_type,
  date_in_range date,
  unix_date_in_range, 
  unix_date_in_range - 30 window_end_unix_date, 
  max(order_date) recent_order,
  sum(quantity) as quantity,
  sum(revenue) as revenue,
  count(distinct(order_number)) as frequency
  FROM daterange
  JOIN customers
  ON customers.unix_order_date > ( daterange.unix_date_in_range - 395 )
  AND customers.unix_order_date <= ( daterange.unix_date_in_range - 30 )
  GROUP BY client, customer_id, date, unix_date_in_range, product_type

  UNION ALL

  SELECT 
  client,
  'Rolling 365 (t-1yr)' as period,
  customer_id,
  product_type,
  date_in_range date,
  unix_date_in_range, 
  unix_date_in_range - 365 window_end_unix_date, 
  max(order_date) recent_order,
  sum(quantity) as quantity,
  sum(revenue) as revenue,
  count(distinct(order_number)) as frequency
  FROM daterange
  JOIN customers
  ON customers.unix_order_date > ( daterange.unix_date_in_range - 730 )
  AND customers.unix_order_date <= ( daterange.unix_date_in_range - 365 )
  GROUP BY client, customer_id, date, unix_date_in_range, product_type

)
2018-04-18 11:46:42,342: Model SQL (frequency_stats):
SELECT
client,
period,
date,
unix_date_in_range,
frequency_segment,
customers,
sum(customers) over (partition by client, period, date) total_customers,
customers /( sum(customers) over (partition by client, period, date) ) pct_of_customers
FROM
( 
	SELECT
	client,
	period,
	date,
	unix_date_in_range,
	case when frequency = 1 then '1' 
		when frequency = 2 then '2'
		when frequency > 2 then '3+'
		else null end as frequency_segment,
	sum(customers) customers
	FROM (

		SELECT 
		client,
		period,
		date,
		unix_date_in_range, 
		frequency,
		count(distinct(customer_id)) customers
		FROM `growth-engines-pipeline`.`agency_data_pipeline`.`frequency_proc`
		group by client, period, date, unix_date_in_range, frequency
	)
	group by client, period, date, unix_date_in_range, frequency_segment
)
2018-04-18 11:46:45,287: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a37cda0>]}
2018-04-18 11:46:45,553: 11:46:45 | 47 of 93 OK created table model agency_data_pipeline.order_paths_proc [CREATE TABLE in 4.51s]
2018-04-18 11:46:49,219: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a2ed780>]}
2018-04-18 11:46:50,025: 11:46:50 | 48 of 93 OK created table model agency_data_pipeline.frequency_stats. [CREATE TABLE in 8.43s]
2018-04-18 11:46:54,428: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a2dada0>]}
2018-04-18 11:46:54,690: 11:46:54 | 49 of 93 OK created table model agency_data_pipeline.products_proc... [CREATE TABLE in 13.64s]
2018-04-18 11:47:24,524: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fb03048>]}
2018-04-18 11:47:25,203: 11:47:25 | 50 of 93 OK created table model agency_data_pipeline.customers_products_proc [CREATE TABLE in 43.73s]
2018-04-18 11:47:25,204: 11:47:25 | 51 of 93 START table model agency_data_pipeline.order_paths_agg...... [RUN]
2018-04-18 11:47:25,205: Compiling model.agency_data_pipeline.order_paths_agg
2018-04-18 11:47:25,204: 11:47:25 | 52 of 93 START table model agency_data_pipeline.segment_proc_sku..... [RUN]
2018-04-18 11:47:25,217: Compiling model.agency_data_pipeline.segment_proc_sku
2018-04-18 11:47:25,219: Writing injected SQL for node "model.agency_data_pipeline.order_paths_agg"
2018-04-18 11:47:25,227: Acquiring new bigquery connection "order_paths_agg".
2018-04-18 11:47:25,239: Re-using an available connection from the pool.
2018-04-18 11:47:25,224: Writing injected SQL for node "model.agency_data_pipeline.segment_proc_sku"
2018-04-18 11:47:25,249: Acquiring new bigquery connection "segment_proc_sku".
2018-04-18 11:47:25,250: Re-using an available connection from the pool.
2018-04-18 11:47:26,307: Model SQL (order_paths_agg):
SELECT
client, 
first_product_type,
second_product_type,
first_purchase_date,
count(distinct(customer_id)) customer_count, 
count(distinct(second_order_number)) second_orders, 
count(distinct(third_order_number)) third_orders, 
count(distinct(fourth_order_number)) fourth_orders, 
count(distinct(fifth_order_number)) fifth_orders, 
sum(date_diff(second_purchase_date, first_purchase_date, DAY)) second_order_latency_days,
sum(date_diff(third_purchase_date, second_purchase_date, DAY)) third_order_latency_days,
sum(date_diff(fourth_purchase_date, third_purchase_date, DAY)) fourth_order_latency_days,
sum(date_diff(fifth_purchase_date, fourth_purchase_date, DAY)) fifth_order_latency_days,
sum(first_order_value) first_order_revenue,
sum(second_order_value) second_order_revenue
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`order_paths_proc`
where second_product_type is not null
GROUP BY client, first_product_type, second_product_type, first_purchase_date
2018-04-18 11:47:26,440: Model SQL (segment_proc_sku):
SELECT
client,
period,
sku, 
product_type,
date,
unique_customers,
orders,
quantity,
revenue,
case 
	when avg_daily_revenue >= avg_daily_revenue_90pct and avg_daily_quantity >= avg_daily_quantity_80pct then 'Best Seller'
	when avg_daily_revenue >= avg_daily_revenue_70pct and avg_daily_quantity >= avg_daily_quantity_40pct then 'Good'
	when avg_daily_revenue < avg_daily_revenue_70pct and avg_daily_revenue >= avg_daily_revenue_30pct and avg_daily_quantity < avg_daily_quantity_70pct then 'Average'
	when avg_daily_revenue < avg_daily_revenue_30pct and avg_daily_quantity < avg_daily_quantity_30pct then 'Poor'
	else 'Unbucketed' end as segment,
newness,	
avg_daily_revenue_90pct,
avg_daily_revenue_70pct,
avg_daily_revenue_30pct,
avg_daily_quantity_80pct,
avg_daily_quantity_70pct,
avg_daily_quantity_40pct,
avg_daily_quantity_30pct

FROM (

	SELECT
	client,
	period,
	sku, 
	product_type,
	newness,
	date,
	unique_customers,
	orders,
	quantity,
	revenue,
	days_sold,
	avg_daily_revenue,
	avg_daily_quantity,
	PERCENTILE_CONT(avg_daily_revenue, 0.90) OVER w1 AS avg_daily_revenue_90pct,
	PERCENTILE_CONT(avg_daily_revenue, 0.70) OVER w1 AS avg_daily_revenue_70pct,
	PERCENTILE_CONT(avg_daily_revenue, 0.3) OVER w1 AS avg_daily_revenue_30pct,
	PERCENTILE_CONT(avg_daily_quantity, 0.80) OVER w1 AS avg_daily_quantity_80pct,
	PERCENTILE_CONT(avg_daily_quantity, 0.70) OVER w1 AS avg_daily_quantity_70pct,
	PERCENTILE_CONT(avg_daily_quantity, 0.40) OVER w1 AS avg_daily_quantity_40pct,
	PERCENTILE_CONT(avg_daily_quantity, 0.3) OVER w1 AS avg_daily_quantity_30pct

	FROM
	(
		SELECT 
		client,
		period,
		sku, 
		product_type,
		newness,
		date,
		unique_customers,
		orders,
		quantity,
		revenue,
		days_sold,
		case when days_sold > 0 then revenue/days_sold else null end as avg_daily_revenue,
		case when days_sold > 0 then quantity/days_sold else null end as avg_daily_quantity
		FROM `growth-engines-pipeline`.`agency_data_pipeline`.`products_proc`
	)
	WINDOW w1 as (PARTITION BY client, period, date)
)
2018-04-18 11:47:28,674: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a2d98d0>]}
2018-04-18 11:47:28,738: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a38d160>]}
2018-04-18 11:47:28,952: 11:47:28 | 52 of 93 OK created table model agency_data_pipeline.segment_proc_sku [CREATE TABLE in 3.46s]
2018-04-18 11:47:29,210: 11:47:29 | 51 of 93 OK created table model agency_data_pipeline.order_paths_agg. [CREATE TABLE in 3.53s]
2018-04-18 11:47:29,211: 11:47:29 | 53 of 93 START table model agency_data_pipeline.segment_stats_sku.... [RUN]
2018-04-18 11:47:29,212: 11:47:29 | 54 of 93 START table model agency_data_pipeline.segment_proc_customers_products [RUN]
2018-04-18 11:47:29,212: Compiling model.agency_data_pipeline.segment_stats_sku
2018-04-18 11:47:29,212: Compiling model.agency_data_pipeline.segment_proc_customers_products
2018-04-18 11:47:29,227: Writing injected SQL for node "model.agency_data_pipeline.segment_proc_customers_products"
2018-04-18 11:47:29,229: Writing injected SQL for node "model.agency_data_pipeline.segment_stats_sku"
2018-04-18 11:47:29,230: Acquiring new bigquery connection "segment_proc_customers_products".
2018-04-18 11:47:29,230: Re-using an available connection from the pool.
2018-04-18 11:47:29,231: Acquiring new bigquery connection "segment_stats_sku".
2018-04-18 11:47:29,232: Re-using an available connection from the pool.
2018-04-18 11:47:30,290: Model SQL (segment_stats_sku):
WITH last_30 as (

	SELECT
	client,
	sku, 
	product_type,
	date,
	unique_customers as customers_30,
	orders as orders_30,
	revenue as revenue_30,
	segment as segment_30,
	newness as newness_30,
	0 as customers_90,
	0 as orders_90,
	0 as revenue_90,
	'' as segment_90,
	0 as customers_yoy_30,
	0 as orders_yoy_30,
	0 as revenue_yoy_30,
	'' as segment_yoy_30
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_sku`
	WHERE period = 'Last 30'

),

last_90 as (

	SELECT
	client,
	sku, 
	product_type,
	date,
	0 as customers_30,
	0 as orders_30,
	0 as revenue_30,
	'' as segment_30,
	'' as newness_30,
	unique_customers as customers_90,
	orders as orders_90,
	revenue as revenue_90,
	segment as segment_90,
	0 as customers_yoy_30,
	0 as orders_yoy_30,
	0 as revenue_yoy_30,
	'' as segment_yoy_30
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_sku`
	WHERE period = 'Last 90'

),

yoy_30 as (

	SELECT
	client,
	sku, 
	product_type,
	date,
	0 as customers_30,
	0 as orders_30,
	0 as revenue_30,
	'' as segment_30,
	'' as newness_30,
	0 as customers_90,
	0 as orders_90,
	0 as revenue_90,
	'' as segment_90,
	unique_customers as customers_yoy_30,
	orders as orders_yoy_30,
	revenue as revenue_yoy_30,
	segment as segment_yoy_30
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_sku`
	WHERE period = 'YoY 30'

)

SELECT
client,
sku, 
product_type,
date,
ifnull(sum(customers_30), 0) customers_30,
ifnull(sum(orders_30), 0) orders_30,
ifnull(sum(revenue_30), 0) revenue_30,
ifnull(max(segment_30), '') segment_30,
ifnull(sum(customers_90), 0) customers_90,
ifnull(sum(orders_90), 0) orders_90,
ifnull(sum(revenue_90), 0) revenue_90,
ifnull(max(segment_90),'') segment_90,
ifnull(sum(customers_yoy_30), 0) customers_yoy_30,
ifnull(sum(orders_yoy_30), 0) orders_yoy_30,
ifnull(sum(revenue_yoy_30), 0) revenue_yoy_30,
case when max(newness_30) = 'New' then 'New'
	else ifnull(max(segment_yoy_30), '') end as segment_yoy_30
FROM
(
	SELECT * FROM last_30
	UNION ALL
	SELECT * FROM last_90
	UNION ALL
	SELECT * FROM yoy_30

)
GROUP BY client, sku, product_type, date
2018-04-18 11:47:30,350: Model SQL (segment_proc_customers_products):
SELECT
client,
period,
date,
customer_id,
first_order_date,
first_order_unix_date,
product_type,
recency_days,
frequency,
revenue,
quantity,
aov,
case when recency_days <= 30 and first_order_unix_date >= window_start_unix_date then 'New'
	when frequency = 1 and recency_days <= 90 and aov >= aov_40pct then 'Promising'
	when frequency = 1 then 'One-time Purchaser'
	when frequency >= frequency_90pct and recency_days <= 90 and aov > aov_40pct then 'Whale'
	when recency_days <= 240 and frequency > frequency_50pct then 'Loyal'
	when recency_days <= 90 and frequency > frequency_50pct then 'Potential Loyalists' 
	when recency_days > 240 and frequency > frequency_50pct then 'Defecting Good Customer'	
	when recency_days > recency_50pct and frequency > frequency_50pct then 'Frequent, not Recent'
	when recency_days < recency_50pct and frequency < frequency_50pct then 'Recent, not Frequent'
	else 'Unbucketed' end as segment,
aov_40pct,
frequency_90pct,
frequency_75pct,
frequency_50pct,
recency_50pct
FROM
(
	SELECT 
	a.client client,
	period,
	date,
	a.customer_id customer_id,
	a.product_type product_type,
	b.first_order_date first_order_date,
	b.first_order_unix_date first_order_unix_date,
	window_start_unix_date,
	window_end_unix_date,	
	recency_days,
	frequency,
	revenue,
	quantity,
	aov,
	PERCENTILE_CONT(aov, 0.40) OVER w1 AS aov_40pct,
	PERCENTILE_CONT(frequency, 0.90) OVER w1 AS frequency_90pct,
	PERCENTILE_CONT(frequency, 0.75) OVER w1 AS frequency_75pct,
	PERCENTILE_CONT(frequency, 0.50) OVER w1 AS frequency_50pct,
	PERCENTILE_CONT(recency_days, 0.5) OVER w1 AS recency_50pct
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`customers_products_proc` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`customers_first_purchase_product_type_proc` b
	ON (
		a.client = b.client and
		a.customer_id = b.customer_id and
		a.product_type = b.product_type
		)
	WINDOW w1 as (PARTITION BY a.client, period, date, a.product_type)
)
2018-04-18 11:47:32,488: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a314080>]}
2018-04-18 11:47:32,798: 11:47:32 | 53 of 93 OK created table model agency_data_pipeline.segment_stats_sku [CREATE TABLE in 3.28s]
2018-04-18 11:48:03,797: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a2d93c8>]}
2018-04-18 11:48:04,095: 11:48:04 | 54 of 93 OK created table model agency_data_pipeline.segment_proc_customers_products [CREATE TABLE in 34.58s]
2018-04-18 11:48:04,096: 11:48:04 | 55 of 93 START table model agency_data_pipeline.order_paths_stats.... [RUN]
2018-04-18 11:48:04,097: 11:48:04 | 56 of 93 START table model agency_data_pipeline.segment_stats_category [RUN]
2018-04-18 11:48:04,097: Compiling model.agency_data_pipeline.order_paths_stats
2018-04-18 11:48:04,097: 11:48:04 | 57 of 93 START table model agency_data_pipeline.segment_stats_customers_products_agg [RUN]
2018-04-18 11:48:04,097: Compiling model.agency_data_pipeline.segment_stats_category
2018-04-18 11:48:04,110: Compiling model.agency_data_pipeline.segment_stats_customers_products_agg
2018-04-18 11:48:04,112: Writing injected SQL for node "model.agency_data_pipeline.order_paths_stats"
2018-04-18 11:48:04,117: Writing injected SQL for node "model.agency_data_pipeline.segment_stats_category"
2018-04-18 11:48:04,124: Writing injected SQL for node "model.agency_data_pipeline.segment_stats_customers_products_agg"
2018-04-18 11:48:04,125: Acquiring new bigquery connection "segment_stats_category".
2018-04-18 11:48:04,125: Re-using an available connection from the pool.
2018-04-18 11:48:04,128: Acquiring new bigquery connection "order_paths_stats".
2018-04-18 11:48:04,128: Re-using an available connection from the pool.
2018-04-18 11:48:04,130: Acquiring new bigquery connection "segment_stats_customers_products_agg".
2018-04-18 11:48:04,130: Re-using an available connection from the pool.
2018-04-18 11:48:05,161: Model SQL (order_paths_stats):
WITH transactions AS (
  SELECT 
  client, 
  first_product_type,
  second_product_type,
  first_purchase_date,
  customer_count,
  second_orders,
  third_orders,
  fourth_orders,
  fifth_orders,
  second_order_latency_days,
  third_order_latency_days,
  fourth_order_latency_days,
  fifth_order_latency_days,
  first_order_revenue,
  second_order_revenue,
  unix_date(cast(first_purchase_date as date)) d
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`order_paths_agg`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)

SELECT 
client,
'Rolling 365' as period,
first_product_type,
second_product_type,
date_in_range date,
unix_date_in_range, 
sum(customer_count) customer_count,
sum(second_orders) second_orders,
sum(third_orders) third_orders,
sum(fourth_orders) fourth_orders,
sum(fifth_orders) fifth_orders,
sum(second_order_latency_days) second_order_latency_days,
sum(third_order_latency_days) third_order_latency_days,
sum(fourth_order_latency_days) fourth_order_latency_days,
sum(fifth_order_latency_days) fifth_order_latency_days,
sum(first_order_revenue) first_order_revenue,
sum(second_order_revenue) second_order_revenue
FROM daterange
JOIN transactions
ON transactions.d > ( daterange.unix_date_in_range - 365 )
AND transactions.d <= daterange.unix_date_in_range
group by client, first_product_type, second_product_type, date_in_range, unix_date_in_range
2018-04-18 11:48:05,355: Model SQL (segment_stats_customers_products_agg):
WITH ty as (

	SELECT
	client,
	date,
	customer_id,
	product_type,
	segment as segment_365,
	recency_days as recency_365,
	frequency as frequency_365,
	revenue as revenue_365,
	aov as aov_365,
	'' as segment_mom,
	0 as recency_mom,
	0 as frequency_mom,
	0 as revenue_mom,
	0 as aov_mom,
	'' as segment_yoy,
	0 as recency_yoy,
	0 as frequency_yoy,
	0 as revenue_yoy,
	0 as aov_yoy
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers_products`
	WHERE period = 'Rolling 365'

),

last_month as (

	SELECT
	client,
	date,
	customer_id,
	product_type,
	'' as segment_365,
	0 as recency_365,
	0 as frequency_365,
	0 as revenue_365,
	0 as aov_365,
	segment as segment_mom,
	recency_days as recency_mom,
	frequency as frequency_mom,
	revenue as revenue_mom,
	aov as aov_mom,
	'' as segment_yoy,
	0 as recency_yoy,
	0 as frequency_yoy,
	0 as revenue_yoy,
	0 as aov_yoy
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers_products`
	WHERE period = 'Rolling 365 (t-1mo)'

),

this_month_1yr as (

	SELECT
	client,
	date,
	customer_id,
	product_type,
	'' as segment_365,
	0 as recency_365,
	0 as frequency_365,
	0 as revenue_365,
	0 as aov_365,
	'' as segment_mom,
	0 as recency_mom,
	0 as frequency_mom,
	0 as revenue_mom,
	0 as aov_mom,
	segment as segment_yoy,
	recency_days as recency_yoy,
	frequency as frequency_yoy,
	revenue as revenue_yoy,
	aov as aov_yoy
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers_products`
	WHERE period = 'Rolling 365 (t-1yr)'


)

SELECT
client,
date, 
customer_id,
product_type,
ifnull(max(segment_365), '') segment_365,
ifnull(max(segment_mom), '') segment_mom,
ifnull(max(segment_yoy), '') segment_yoy,
ifnull(sum(recency_365), 0) recency_365,
ifnull(sum(frequency_365), 0) frequency_365,
ifnull(sum(revenue_365), 0) revenue_365,
ifnull(sum(aov_365), 0) aov_365,
ifnull(sum(recency_mom), 0) recency_mom,
ifnull(sum(frequency_mom), 0) frequency_mom,
ifnull(sum(revenue_mom), 0) revenue_mom,
ifnull(sum(aov_mom), 0) aov_mom,	
ifnull(sum(recency_yoy), 0) recency_yoy,
ifnull(sum(frequency_yoy), 0) frequency_yoy,
ifnull(sum(revenue_yoy), 0) revenue_yoy,
ifnull(sum(aov_yoy), 0) aov_yoy
FROM
(
	SELECT * FROM ty
	UNION ALL
	SELECT * FROM last_month
	UNION ALL
	SELECT * FROM this_month_1yr

)
GROUP BY client, date, customer_id, product_type
2018-04-18 11:48:05,396: Model SQL (segment_stats_category):
SELECT
client,
product_type,
date,
segment_30,
segment_90,
segment_yoy_30,
ifnull(sum(customers_30), 0) customers_30,
ifnull(sum(orders_30), 0) orders_30,
ifnull(sum(revenue_30), 0) revenue_30,
ifnull(sum(customers_90), 0) customers_90,
ifnull(sum(orders_90), 0) orders_90,
ifnull(sum(revenue_90), 0) revenue_90,
ifnull(sum(customers_yoy_30), 0) customers_yoy_30,
ifnull(sum(orders_yoy_30), 0) orders_yoy_30,
ifnull(sum(revenue_yoy_30), 0) revenue_yoy_30
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`segment_stats_sku`
GROUP BY client, product_type, date, segment_30, segment_90, segment_yoy_30
2018-04-18 11:48:06,630: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d7cc5c0>]}
2018-04-18 11:48:06,674: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fb03940>]}
2018-04-18 11:48:07,172: 11:48:07 | 55 of 93 OK created table model agency_data_pipeline.order_paths_stats [CREATE TABLE in 2.53s]
2018-04-18 11:48:07,481: 11:48:07 | 56 of 93 OK created table model agency_data_pipeline.segment_stats_category [CREATE TABLE in 2.58s]
2018-04-18 11:48:33,749: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a2d9668>]}
2018-04-18 11:48:34,575: 11:48:34 | 57 of 93 OK created table model agency_data_pipeline.segment_stats_customers_products_agg [CREATE TABLE in 29.64s]
2018-04-18 11:48:34,576: 11:48:34 | 58 of 93 START table model agency_data_pipeline.agg_platforms_union.. [RUN]
2018-04-18 11:48:34,576: Compiling model.agency_data_pipeline.agg_platforms_union
2018-04-18 11:48:34,582: 11:48:34 | 59 of 93 START table model agency_data_pipeline.segment_stats_customers_products [RUN]
2018-04-18 11:48:34,582: 11:48:34 | 60 of 93 START table model agency_data_pipeline.agg_transaction...... [RUN]
2018-04-18 11:48:34,582: 11:48:34 | 61 of 93 START table model agency_data_pipeline.agg_ga_transaction... [RUN]
2018-04-18 11:48:34,586: Writing injected SQL for node "model.agency_data_pipeline.agg_platforms_union"
2018-04-18 11:48:34,586: Compiling model.agency_data_pipeline.segment_stats_customers_products
2018-04-18 11:48:34,586: Compiling model.agency_data_pipeline.agg_transaction
2018-04-18 11:48:34,586: Compiling model.agency_data_pipeline.agg_ga_transaction
2018-04-18 11:48:34,592: Writing injected SQL for node "model.agency_data_pipeline.segment_stats_customers_products"
2018-04-18 11:48:34,599: Writing injected SQL for node "model.agency_data_pipeline.agg_transaction"
2018-04-18 11:48:34,606: Acquiring new bigquery connection "agg_platforms_union".
2018-04-18 11:48:34,612: Writing injected SQL for node "model.agency_data_pipeline.agg_ga_transaction"
2018-04-18 11:48:34,613: Re-using an available connection from the pool.
2018-04-18 11:48:34,626: Acquiring new bigquery connection "agg_ga_transaction".
2018-04-18 11:48:34,626: Re-using an available connection from the pool.
2018-04-18 11:48:34,629: Acquiring new bigquery connection "agg_transaction".
2018-04-18 11:48:34,631: Acquiring new bigquery connection "segment_stats_customers_products".
2018-04-18 11:48:34,632: Re-using an available connection from the pool.
2018-04-18 11:48:34,636: Re-using an available connection from the pool.
2018-04-18 11:48:35,581: Model SQL (agg_platforms_union):
SELECT 
date, 
account, 
channel,
platform,
url,
utm_campaign,
campaign,
cost,
impressions,
clicks,
transactions
FROM 
`growth-engines-pipeline`.`agency_data_pipeline`.`adwords_stats`

UNION ALL

SELECT 
date, 
account, 
channel,
platform,
url,
utm_campaign,
campaign,
cost,
impressions,
clicks,
transactions
FROM 
`growth-engines-pipeline`.`agency_data_pipeline`.`bing_ads_stats`

UNION ALL  

SELECT 
date, 
account, 
channel,
platform,
url,
utm_campaign,
campaign,
cost,
impressions,
clicks,
transactions
FROM 
`growth-engines-pipeline`.`agency_data_pipeline`.`fb_ads_stats`
2018-04-18 11:48:35,597: Model SQL (segment_stats_customers_products):
SELECT
client,
date,
product_type,
segment_365,
segment_mom,
segment_yoy,
count(distinct(customer_id)) customers,
avg(recency_365) recency_365,
sum(frequency_365) frequency_365,
sum(revenue_365) revenue_365,
case when sum(frequency_365) > 0 then sum(revenue_365)/sum(frequency_365) else null end as aov_365,
avg(recency_mom) recency_mom,
sum(frequency_mom) frequency_mom,
sum(revenue_mom) revenue_mom,
case when sum(frequency_mom) > 0 then sum(revenue_mom)/sum(frequency_mom) else null end as aov_mom,
avg(recency_yoy) recency_yoy,
sum(frequency_yoy) frequency_yoy,
sum(revenue_yoy) revenue_yoy,
case when sum(frequency_yoy) > 0 then sum(revenue_yoy)/sum(frequency_yoy) else null end as aov_yoy
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_stats_customers_products_agg`
GROUP BY client, date, product_type, segment_365, segment_mom, segment_yoy
2018-04-18 11:48:35,613: Model SQL (agg_transaction):
SELECT
client,
date,
customer_id,
order_number,
last_touch_channel,
last_touch_platform,
last_touch_url,
first_touch_channel, 
first_touch_platform, 
first_touch_utm_campaign,
ifnull( sum(last_touch_transactions), 0) last_touch_transactions, 
ifnull( sum(last_touch_revenue), 0) last_touch_revenue, 
ifnull( sum(first_touch_transactions), 0) first_touch_transactions, 
ifnull( sum(first_touch_revenue), 0) first_touch_revenue,
ifnull( sum(final_quantity), 0) quantity,
ifnull( sum(final_price), 0) revenue,
ifnull( sum(cogs), 0) cogs,
ifnull( sum(net_price), 0) net_revenue,
ifnull( sum(shipping_price), 0) shipping_revenue,
ROW_NUMBER() OVER (PARTITION BY client, customer_id, order_number ORDER BY date asc) AS order_sequence
FROM
(
	SELECT
	a.client,
	a.date date,
	b.date ga_date,
	a.customer_id,
	a.order_number,
	transactionid,
	b.last_touch_channel,
	b.last_touch_platform,
	b.last_touch_url,
	b.first_touch_channel, 
	b.first_touch_platform, 
	b.first_touch_utm_campaign, 
	last_touch_transactions, 
	last_touch_revenue, 
	first_touch_transactions, 
	first_touch_revenue,
	final_quantity,
	final_price,
	cogs,
	net_price,
	shipping_price
	FROM
	`growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_order_number` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`agg_ga_transaction_order_number` b
	ON (
		a.client = b.client and
		a.order_number = b.transactionid
	)

)
GROUP BY
client, 
date, 
customer_id,
order_number, 
last_touch_channel,
last_touch_platform,
last_touch_url,
first_touch_channel, 
first_touch_platform, 
first_touch_utm_campaign
2018-04-18 11:48:35,715: Model SQL (agg_ga_transaction):
#done - lookup customer id from transaction id from orders
#done - tag an order as 'new' or 'existing' based on transaction id
#sum lifetime value of that customer id
#first order value for customer
#read from agg_ga_transaction into agg_ga_campaign instead of directly from ga_transactions and ga_mcf_stats


with ga as (

    select 
        date, 
        client, 
        'Last-touch' as attribution,
        channel, 
        platform, 
        url, 
        campaign, 
        transactionid,
        last_touch_transactions transactions, 
        last_touch_revenue + ifnull(last_touch_shipping, 0) + ifnull(last_touch_tax, 0) as revenue
    from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_transactions`

),

ga_mcf as (

    select 
        date, 
        client, 
        'First-touch' as attribution,
        channel, 
        platform, 
        '' as url,
        campaign, 
        transactionid, 
        first_touch_transactions as transactions,
        first_touch_revenue as revenue
    from `growth-engines-pipeline`.`agency_data_pipeline`.`ga_mcf_stats`

)


SELECT
    date, 
    a.client client,
    attribution,
    transactionid,
    b.customer_id customer_id,
    b.order_type order_type,
    b.first_order_revenue first_order_revenue,
    b.lifetime_revenue lifetime_revenue,
    channel,
    platform,
    url,
    campaign,
    transactions,
    b.final_price revenue,
    b.cogs cogs,
    b.net_price net_revenue
FROM (
    SELECT * FROM ga
    UNION ALL
    SELECT * FROM ga_mcf
) a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`customers_by_transaction` b
ON (
    a.client = b.client AND
    a.transactionid = b.order_number
)
2018-04-18 11:48:41,458: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d7367b8>]}
2018-04-18 11:48:41,459: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a375748>]}
2018-04-18 11:48:41,749: 11:48:41 | 58 of 93 OK created table model agency_data_pipeline.agg_platforms_union [CREATE TABLE in 6.88s]
2018-04-18 11:48:42,015: 11:48:42 | 60 of 93 OK created table model agency_data_pipeline.agg_transaction. [CREATE TABLE in 6.87s]
2018-04-18 11:48:42,570: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a2ef470>]}
2018-04-18 11:48:42,857: 11:48:42 | 61 of 93 OK created table model agency_data_pipeline.agg_ga_transaction [CREATE TABLE in 7.98s]
2018-04-18 11:48:47,630: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a375f28>]}
2018-04-18 11:48:47,902: 11:48:47 | 59 of 93 OK created table model agency_data_pipeline.segment_stats_customers_products [CREATE TABLE in 13.04s]
2018-04-18 11:48:47,902: 11:48:47 | 62 of 93 START table model agency_data_pipeline.customers_first_purchase_proc [RUN]
2018-04-18 11:48:47,904: Compiling model.agency_data_pipeline.customers_first_purchase_proc
2018-04-18 11:48:47,914: Writing injected SQL for node "model.agency_data_pipeline.customers_first_purchase_proc"
2018-04-18 11:48:47,912: 11:48:47 | 63 of 93 START table model agency_data_pipeline.segment_list_customers_products [RUN]
2018-04-18 11:48:47,914: Compiling model.agency_data_pipeline.segment_list_customers_products
2018-04-18 11:48:47,912: 11:48:47 | 64 of 93 START table model agency_data_pipeline.agg_transaction_daily [RUN]
2018-04-18 11:48:47,912: 11:48:47 | 65 of 93 START table model agency_data_pipeline.agg_ga_campaign_by_type [RUN]
2018-04-18 11:48:47,926: Writing injected SQL for node "model.agency_data_pipeline.segment_list_customers_products"
2018-04-18 11:48:47,926: Compiling model.agency_data_pipeline.agg_transaction_daily
2018-04-18 11:48:47,927: Compiling model.agency_data_pipeline.agg_ga_campaign_by_type
2018-04-18 11:48:47,928: Acquiring new bigquery connection "customers_first_purchase_proc".
2018-04-18 11:48:47,974: Re-using an available connection from the pool.
2018-04-18 11:48:47,941: Writing injected SQL for node "model.agency_data_pipeline.agg_transaction_daily"
2018-04-18 11:48:47,985: Acquiring new bigquery connection "agg_transaction_daily".
2018-04-18 11:48:47,985: Re-using an available connection from the pool.
2018-04-18 11:48:47,973: Acquiring new bigquery connection "segment_list_customers_products".
2018-04-18 11:48:47,990: Re-using an available connection from the pool.
2018-04-18 11:48:47,972: Writing injected SQL for node "model.agency_data_pipeline.agg_ga_campaign_by_type"
2018-04-18 11:48:48,006: Acquiring new bigquery connection "agg_ga_campaign_by_type".
2018-04-18 11:48:48,006: Re-using an available connection from the pool.
2018-04-18 11:48:48,862: Model SQL (customers_first_purchase_proc):
SELECT 
client, 
customer_id, 
min(cast(date as date)) first_order_date,
unix_date( min(cast(date as date))) first_order_unix_date
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction`
GROUP BY client, customer_id
2018-04-18 11:48:48,952: Model SQL (agg_transaction_daily):
SELECT
client,
date,
customer_id,
sum(last_touch_transactions) last_touch_transactions, 
sum(last_touch_revenue) last_touch_revenue, 
sum(first_touch_transactions) first_touch_transactions, 
sum(first_touch_revenue) first_touch_revenue,
sum(quantity) quantity,
sum(revenue) revenue,
sum(cogs) cogs,
sum(net_revenue) net_revenue,
count(distinct(order_number)) order_count
FROM
`growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction`
GROUP BY
client, 
date, 
customer_id
2018-04-18 11:48:48,991: Model SQL (agg_ga_campaign_by_type):
with orders_new as (
    select 
    date, 
    client, 
    attribution,
    channel, 
    platform, 
    url, 
    campaign,
    count(distinct(customer_id)) customers_new,
    sum(transactions) transactions_new,
    sum(revenue) revenue_new,
    sum(cogs) cogs_new,
    sum(net_revenue) net_revenue_new,
    sum(first_order_revenue) first_order_revenue_new,
    sum(lifetime_revenue) lifetime_revenue_new,
    null as customers_total,
    null as transactions_total,
    null as revenue_total
    from `growth-engines-pipeline`.`agency_data_pipeline`.`agg_ga_transaction`
    where order_type = 'New'
    group by date, client, attribution, channel, platform, url, campaign
),
    
orders_total as (
    select 
    date, 
    client, 
    attribution,
    channel, 
    platform, 
    url, 
    campaign,
    null as customers_new,
    null as transactions_new,
    null as revenue_new,
    null as cogs_new,
    null as net_revenue_new,
    null as first_order_revenue_new,
    null as lifetime_revenue_new,
    count(distinct(customer_id)) customers_total,
    sum(transactions) transactions_total,
    sum(revenue) revenue_total,
    sum(cogs) cogs_total,
    sum(net_revenue) net_revenue_total
    from `growth-engines-pipeline`.`agency_data_pipeline`.`agg_ga_transaction`
    group by date, client, attribution, channel, platform, url, campaign

)

SELECT 
date, 
client, 
attribution,
channel, 
platform, 
url, 
campaign,
sum(customers_new) customers_new,
sum(transactions_new) transactions_new,
sum(revenue_new) revenue_new,
sum(cogs_new) cogs_new,
sum(net_revenue_new) net_revenue_new,
sum(first_order_revenue_new) first_order_revenue_new,
sum(lifetime_revenue_new) lifetime_revenue_new,
sum(customers_total) customers_total,
sum(transactions_total) transactions_total,
sum(revenue_total) revenue_total,
sum(cogs_total) cogs_total,
sum(net_revenue_total) net_revenue_total
from
    ( 
        SELECT * FROM orders_new
        UNION ALL 
        SELECT * FROM orders_total
    )
group by date, client, attribution, channel, platform, url, campaign
2018-04-18 11:48:48,992: Bad request while running:
with orders_new as (
    select 
    date, 
    client, 
    attribution,
    channel, 
    platform, 
    url, 
    campaign,
    count(distinct(customer_id)) customers_new,
    sum(transactions) transactions_new,
    sum(revenue) revenue_new,
    sum(cogs) cogs_new,
    sum(net_revenue) net_revenue_new,
    sum(first_order_revenue) first_order_revenue_new,
    sum(lifetime_revenue) lifetime_revenue_new,
    null as customers_total,
    null as transactions_total,
    null as revenue_total
    from `growth-engines-pipeline`.`agency_data_pipeline`.`agg_ga_transaction`
    where order_type = 'New'
    group by date, client, attribution, channel, platform, url, campaign
),
    
orders_total as (
    select 
    date, 
    client, 
    attribution,
    channel, 
    platform, 
    url, 
    campaign,
    null as customers_new,
    null as transactions_new,
    null as revenue_new,
    null as cogs_new,
    null as net_revenue_new,
    null as first_order_revenue_new,
    null as lifetime_revenue_new,
    count(distinct(customer_id)) customers_total,
    sum(transactions) transactions_total,
    sum(revenue) revenue_total,
    sum(cogs) cogs_total,
    sum(net_revenue) net_revenue_total
    from `growth-engines-pipeline`.`agency_data_pipeline`.`agg_ga_transaction`
    group by date, client, attribution, channel, platform, url, campaign

)

SELECT 
date, 
client, 
attribution,
channel, 
platform, 
url, 
campaign,
sum(customers_new) customers_new,
sum(transactions_new) transactions_new,
sum(revenue_new) revenue_new,
sum(cogs_new) cogs_new,
sum(net_revenue_new) net_revenue_new,
sum(first_order_revenue_new) first_order_revenue_new,
sum(lifetime_revenue_new) lifetime_revenue_new,
sum(customers_total) customers_total,
sum(transactions_total) transactions_total,
sum(revenue_total) revenue_total,
sum(cogs_total) cogs_total,
sum(net_revenue_total) net_revenue_total
from
    ( 
        SELECT * FROM orders_new
        UNION ALL 
        SELECT * FROM orders_total
    )
group by date, client, attribution, channel, platform, url, campaign
2018-04-18 11:48:48,992: 400 Queries in UNION ALL have mismatched column count; query 1 has 17 columns, query 2 has 19 columns at [75:9]
2018-04-18 11:48:48,994: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a2d9f28>]}
2018-04-18 11:48:49,065: Model SQL (segment_list_customers_products):
SELECT
a.client,
period,
date,
customer_id,
product_type,
b.first_name,
b.last_name,
b.email,
recency_days,
frequency,
revenue,
quantity,
aov,
segment
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers_products` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`agg_customers_union` b
ON (
	a.client = b.client AND
	a.customer_id = b.id
)
2018-04-18 11:48:49,344: 11:48:49 | 65 of 93 ERROR creating table model agency_data_pipeline.agg_ga_campaign_by_type [ERROR in 1.07s]
2018-04-18 11:48:51,044: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a30d9e8>]}
2018-04-18 11:48:51,289: 11:48:51 | 62 of 93 OK created table model agency_data_pipeline.customers_first_purchase_proc [CREATE TABLE in 3.14s]
2018-04-18 11:48:56,633: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a369240>]}
2018-04-18 11:48:56,935: 11:48:56 | 64 of 93 OK created table model agency_data_pipeline.agg_transaction_daily [CREATE TABLE in 8.71s]
2018-04-18 11:49:38,361: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a2d9da0>]}
2018-04-18 11:49:39,251: 11:49:39 | 63 of 93 OK created table model agency_data_pipeline.segment_list_customers_products [CREATE TABLE in 50.45s]
2018-04-18 11:49:39,253: 11:49:39 | 66 of 93 START table model agency_data_pipeline.agg_platforms_client. [RUN]
2018-04-18 11:49:39,254: Compiling model.agency_data_pipeline.agg_platforms_client
2018-04-18 11:49:39,263: 11:49:39 | 67 of 93 START table model agency_data_pipeline.growth_customer_0_365 [RUN]
2018-04-18 11:49:39,263: Compiling model.agency_data_pipeline.growth_customer_0_365
2018-04-18 11:49:39,271: 11:49:39 | 68 of 93 START table model agency_data_pipeline.customers_proc....... [RUN]
2018-04-18 11:49:39,271: Compiling model.agency_data_pipeline.customers_proc
2018-04-18 11:49:39,290: Writing injected SQL for node "model.agency_data_pipeline.growth_customer_0_365"
2018-04-18 11:49:39,294: Writing injected SQL for node "model.agency_data_pipeline.customers_proc"
2018-04-18 11:49:39,298: Writing injected SQL for node "model.agency_data_pipeline.agg_platforms_client"
2018-04-18 11:49:39,301: Acquiring new bigquery connection "customers_proc".
2018-04-18 11:49:39,302: Re-using an available connection from the pool.
2018-04-18 11:49:39,307: Acquiring new bigquery connection "growth_customer_0_365".
2018-04-18 11:49:39,307: Re-using an available connection from the pool.
2018-04-18 11:49:39,313: Acquiring new bigquery connection "agg_platforms_client".
2018-04-18 11:49:39,313: Re-using an available connection from the pool.
2018-04-18 11:49:42,570: Model SQL (growth_customer_0_365):
WITH transactions AS (
  SELECT 
  client, 
  customer_id, 
  order_number,
  unix_date(cast(date as date)) d, 
  quantity,
  revenue,
  shipping_revenue
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)

SELECT 
date_in_range date,
unix_date_in_range, 
unix_date_in_range_yoy, 
client, 
customer_id,
count(distinct(order_number)) orders,
sum(quantity) quantity,
sum(revenue) revenue,
sum(shipping_revenue) shipping_revenue
FROM daterange
JOIN transactions
ON transactions.d >= ( daterange.unix_date_in_range - 365 ) 
AND transactions.d <= daterange.unix_date_in_range
GROUP BY date, unix_date_in_range, unix_date_in_range_yoy, client, customer_id
2018-04-18 11:49:42,583: Model SQL (agg_platforms_client):
SELECT 
date, 
a.account account, 
b.client client,
a.platform platform,
a.channel channel,
url,
utm_campaign,
campaign,
cost,
impressions,
clicks,
transactions ad_platform_transactions
FROM 
  `growth-engines-pipeline`.`agency_data_pipeline`.`agg_platforms_union` a
LEFT JOIN 
  `growth-engines-pipeline`.`agency_data_pipeline`.`accounts_proc` b
ON ( 
  a.account = b.account AND
  a.platform = b.platform
)
2018-04-18 11:49:42,593: Model SQL (customers_proc):
WITH customers AS (
  SELECT 
  client, 
  customer_id, 
  order_number,
  cast(date as date) order_date,
  unix_date(cast(date as date)) unix_order_date, 
  quantity,
  revenue 
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
)
 
SELECT 
client,
period,
customer_id,
date,
window_end_unix_date,
window_end_unix_date - 365 as window_start_unix_date,
window_end_unix_date - unix_date(recent_order) recency_days,
frequency,
quantity,
revenue,
case when frequency > 0 then revenue/frequency else 0 end as aov
FROM 
(  

  SELECT 
  client,
  'Rolling 365' as period,
  customer_id,
  date_in_range date,
  unix_date_in_range,
  unix_date_in_range window_end_unix_date,
  max(order_date) recent_order,
  sum(quantity) as quantity,
  sum(revenue) as revenue,
  count(distinct(order_number)) as frequency
  FROM daterange
  JOIN customers
  ON customers.unix_order_date > ( daterange.unix_date_in_range - 365 )
  AND customers.unix_order_date <= daterange.unix_date_in_range
  GROUP BY client, customer_id, date, unix_date_in_range

  UNION ALL

  SELECT 
  client,
  'Rolling 365 (t-1mo)' as period,
  customer_id,
  date_in_range date,
  unix_date_in_range,
  unix_date_in_range - 30 window_end_unix_date, 
  max(order_date) recent_order,
  sum(quantity) as quantity,
  sum(revenue) as revenue,
  count(distinct(order_number)) as frequency
  FROM daterange
  JOIN customers
  ON customers.unix_order_date > ( daterange.unix_date_in_range - 395 )
  AND customers.unix_order_date <= ( daterange.unix_date_in_range - 30 )
  GROUP BY client, customer_id, date, unix_date_in_range

  UNION ALL

  SELECT 
  client,
  'Rolling 365 (t-1yr)' as period,
  customer_id,
  date_in_range date,
  unix_date_in_range, 
  unix_date_in_range - 365 window_end_unix_date, 
  max(order_date) recent_order,
  sum(quantity) as quantity,
  sum(revenue) as revenue,
  count(distinct(order_number)) as frequency
  FROM daterange
  JOIN customers
  ON customers.unix_order_date > ( daterange.unix_date_in_range - 730 )
  AND customers.unix_order_date <= ( daterange.unix_date_in_range - 365 )
  GROUP BY client, customer_id, date, unix_date_in_range

)
2018-04-18 11:49:48,711: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a2dada0>]}
2018-04-18 11:49:49,037: 11:49:49 | 66 of 93 OK created table model agency_data_pipeline.agg_platforms_client [CREATE TABLE in 9.46s]
2018-04-18 11:50:00,893: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a308550>]}
2018-04-18 11:50:01,625: 11:50:01 | 67 of 93 OK created table model agency_data_pipeline.growth_customer_0_365 [CREATE TABLE in 21.63s]
2018-04-18 11:50:11,874: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a3698d0>]}
2018-04-18 11:50:12,359: 11:50:12 | 68 of 93 OK created table model agency_data_pipeline.customers_proc.. [CREATE TABLE in 32.60s]
2018-04-18 11:50:12,360: 11:50:12 | 69 of 93 START table model agency_data_pipeline.retention_0_365...... [RUN]
2018-04-18 11:50:12,361: Compiling model.agency_data_pipeline.retention_0_365
2018-04-18 11:50:12,360: 11:50:12 | 70 of 93 START table model agency_data_pipeline.retention_30_60...... [RUN]
2018-04-18 11:50:12,367: Compiling model.agency_data_pipeline.retention_30_60
2018-04-18 11:50:12,360: 11:50:12 | 71 of 93 START table model agency_data_pipeline.retention_730_plus... [RUN]
2018-04-18 11:50:12,386: Compiling model.agency_data_pipeline.retention_730_plus
2018-04-18 11:50:12,386: Writing injected SQL for node "model.agency_data_pipeline.retention_0_365"
2018-04-18 11:50:12,360: 11:50:12 | 72 of 93 START table model agency_data_pipeline.retention_365_730.... [RUN]
2018-04-18 11:50:12,393: Compiling model.agency_data_pipeline.retention_365_730
2018-04-18 11:50:12,393: Writing injected SQL for node "model.agency_data_pipeline.retention_730_plus"
2018-04-18 11:50:12,402: Writing injected SQL for node "model.agency_data_pipeline.retention_30_60"
2018-04-18 11:50:12,410: Writing injected SQL for node "model.agency_data_pipeline.retention_365_730"
2018-04-18 11:50:12,416: Acquiring new bigquery connection "retention_0_365".
2018-04-18 11:50:12,416: Re-using an available connection from the pool.
2018-04-18 11:50:12,422: Acquiring new bigquery connection "retention_730_plus".
2018-04-18 11:50:12,423: Acquiring new bigquery connection "retention_30_60".
2018-04-18 11:50:12,423: Re-using an available connection from the pool.
2018-04-18 11:50:12,426: Acquiring new bigquery connection "retention_365_730".
2018-04-18 11:50:12,427: Re-using an available connection from the pool.
2018-04-18 11:50:12,433: Re-using an available connection from the pool.
2018-04-18 11:50:15,564: Model SQL (retention_730_plus):
WITH transactions AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_daily`
),

daterange AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`  	
),

temp AS (
  SELECT 
  client, 
  customer_id, 
  unix_date(date) d, 
  quantity,
  revenue,
  order_count
  FROM transactions
)

SELECT 
date_in_range date, 
unix_date_in_range,
client, 
customer_id,
sum(quantity) quantity,
sum(revenue) revenue,
sum(order_count) order_count
FROM daterange
JOIN temp
ON temp.d <= ( daterange.unix_date_in_range - 730 ) 
group by date_in_range, unix_date_in_range, client, customer_id
2018-04-18 11:50:15,567: Model SQL (retention_30_60):
WITH transactions AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_daily`
),

daterange AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`  	
),

temp AS (
  SELECT 
  client, 
  customer_id, 
  unix_date(date) d, 
  quantity,
  revenue,
  order_count
  FROM transactions
)

SELECT 
date_in_range date, 
unix_date_in_range,
client, 
customer_id,
sum(quantity) quantity,
sum(revenue) revenue,
sum(order_count) order_count
FROM daterange
JOIN temp
ON ( temp.d >= ( daterange.unix_date_in_range_bom_mom ) 
AND temp.d < ( daterange.unix_date_in_range_bom ) )
group by date_in_range, unix_date_in_range, client, customer_id
2018-04-18 11:50:15,573: Model SQL (retention_0_365):
WITH transactions AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_daily`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
),

temp AS (
  SELECT 
  client, 
  customer_id, 
  unix_date(date) d, 
  quantity,
  revenue,
  order_count
  FROM transactions
)

SELECT 
date_in_range date,
unix_date_in_range, 
client, 
customer_id,
sum(quantity) quantity,
sum(revenue) revenue,
sum(order_count) order_count
FROM daterange
JOIN temp
ON temp.d >= ( daterange.unix_date_in_range - 365 ) 
AND temp.d <= daterange.unix_date_in_range
group by date_in_range, unix_date_in_range, client, customer_id
2018-04-18 11:50:15,579: Model SQL (retention_365_730):
WITH transactions AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_daily`
),

daterange AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`  	
),

temp AS (
  SELECT 
  client, 
  customer_id, 
  unix_date(date) d, 
  quantity,
  revenue,
  order_count
  FROM transactions
)

SELECT 
date_in_range date, 
unix_date_in_range,
client, 
customer_id,
sum(quantity) quantity,
sum(revenue) revenue,
sum(order_count) order_count
FROM daterange
JOIN temp
ON ( temp.d >= ( daterange.unix_date_in_range - 730 ) 
AND temp.d < ( daterange.unix_date_in_range - 365 ) )
group by date_in_range, unix_date_in_range, client, customer_id
2018-04-18 11:50:18,700: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a337cf8>]}
2018-04-18 11:50:18,708: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a2efcf8>]}
2018-04-18 11:50:18,957: 11:50:18 | 71 of 93 OK created table model agency_data_pipeline.retention_730_plus [CREATE TABLE in 6.31s]
2018-04-18 11:50:18,958: 11:50:18 | 73 of 93 START table model agency_data_pipeline.retention_60_plus.... [RUN]
2018-04-18 11:50:18,963: Compiling model.agency_data_pipeline.retention_60_plus
2018-04-18 11:50:18,981: Writing injected SQL for node "model.agency_data_pipeline.retention_60_plus"
2018-04-18 11:50:18,984: Acquiring new bigquery connection "retention_60_plus".
2018-04-18 11:50:18,984: Re-using an available connection from the pool.
2018-04-18 11:50:19,254: 11:50:19 | 70 of 93 OK created table model agency_data_pipeline.retention_30_60. [CREATE TABLE in 6.34s]
2018-04-18 11:50:19,254: 11:50:19 | 74 of 93 START table model agency_data_pipeline.retention_0_30....... [RUN]
2018-04-18 11:50:19,255: Compiling model.agency_data_pipeline.retention_0_30
2018-04-18 11:50:19,266: Writing injected SQL for node "model.agency_data_pipeline.retention_0_30"
2018-04-18 11:50:19,268: Acquiring new bigquery connection "retention_0_30".
2018-04-18 11:50:19,268: Re-using an available connection from the pool.
2018-04-18 11:50:20,524: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a2ed9b0>]}
2018-04-18 11:50:20,805: 11:50:20 | 72 of 93 OK created table model agency_data_pipeline.retention_365_730 [CREATE TABLE in 8.13s]
2018-04-18 11:50:20,924: Model SQL (retention_60_plus):
WITH transactions AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_daily`
),

daterange AS (
	SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`  	
),

temp AS (
  SELECT 
  client, 
  customer_id, 
  unix_date(date) d, 
  quantity,
  revenue,
  order_count
  FROM transactions
)

SELECT 
date_in_range date, 
unix_date_in_range,
client, 
customer_id,
sum(quantity) quantity,
sum(revenue) revenue,
sum(order_count) order_count
FROM daterange
JOIN temp
ON temp.d < ( daterange.unix_date_in_range_bom_mom ) 
group by date_in_range, unix_date_in_range, client, customer_id
2018-04-18 11:50:20,997: Model SQL (retention_0_30):
WITH transactions AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`agg_transaction_daily`
),

daterange AS (
  SELECT * FROM `growth-engines-pipeline`.`agency_data_pipeline`.`monthend_dates`    
),

temp AS (
  SELECT 
  client, 
  customer_id, 
  unix_date(date) d, 
  quantity,
  revenue,
  order_count
  FROM transactions
)

SELECT 
date_in_range date,
unix_date_in_range, 
client, 
customer_id,
sum(quantity) quantity,
sum(revenue) revenue,
sum(order_count) order_count
FROM daterange
JOIN temp
ON temp.d >= ( daterange.unix_date_in_range_bom ) 
AND temp.d <= daterange.unix_date_in_range
group by date_in_range, unix_date_in_range, client, customer_id
2018-04-18 11:50:24,367: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d7cc940>]}
2018-04-18 11:50:24,690: 11:50:24 | 74 of 93 OK created table model agency_data_pipeline.retention_0_30.. [CREATE TABLE in 5.11s]
2018-04-18 11:50:27,111: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a2ef470>]}
2018-04-18 11:50:27,359: 11:50:27 | 69 of 93 OK created table model agency_data_pipeline.retention_0_365. [CREATE TABLE in 14.75s]
2018-04-18 11:50:31,995: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fb28d68>]}
2018-04-18 11:50:32,253: 11:50:32 | 73 of 93 OK created table model agency_data_pipeline.retention_60_plus [CREATE TABLE in 13.03s]
2018-04-18 11:50:32,254: 11:50:32 | 75 of 93 START table model agency_data_pipeline.segment_proc_customers [RUN]
2018-04-18 11:50:32,255: Compiling model.agency_data_pipeline.segment_proc_customers
2018-04-18 11:50:32,323: Writing injected SQL for node "model.agency_data_pipeline.segment_proc_customers"
2018-04-18 11:50:32,327: Acquiring new bigquery connection "segment_proc_customers".
2018-04-18 11:50:32,327: Re-using an available connection from the pool.
2018-04-18 11:50:33,283: Model SQL (segment_proc_customers):
SELECT
client,
period,
date,
customer_id,
first_order_date,
first_order_unix_date,
recency_days,
frequency,
revenue,
quantity,
aov,
case when recency_days <= 30 and first_order_unix_date >= window_start_unix_date then 'New'
	when frequency = 1 and recency_days <= 90 and aov >= aov_40pct then 'Promising'
	when frequency = 1 then 'One-time Purchaser'
	when frequency >= frequency_90pct and recency_days <= 90 and aov > aov_40pct then 'Whale'
	when recency_days <= 240 and frequency > frequency_50pct then 'Loyal'
	when recency_days <= 90 and frequency > frequency_50pct then 'Potential Loyalists' 
	when recency_days > 240 and frequency > frequency_50pct then 'Defecting Good Customer'	
	when recency_days > recency_50pct and frequency > frequency_50pct then 'Frequent, not Recent'
	when recency_days < recency_50pct and frequency < frequency_50pct then 'Recent, not Frequent'
	else 'Unbucketed' end as segment,
aov_40pct,
frequency_90pct,
frequency_75pct,
frequency_50pct,
recency_50pct
FROM
(
	SELECT 
	a.client client,
	period,
	date,
	a.customer_id customer_id,
	b.first_order_date first_order_date,
	b.first_order_unix_date first_order_unix_date,
	window_start_unix_date,
	window_end_unix_date,
	recency_days,
	frequency,
	revenue,
	quantity,
	aov,
	PERCENTILE_CONT(aov, 0.40) OVER w1 AS aov_40pct,
	PERCENTILE_CONT(frequency, 0.90) OVER w1 AS frequency_90pct,
	PERCENTILE_CONT(frequency, 0.75) OVER w1 AS frequency_75pct,
	PERCENTILE_CONT(frequency, 0.50) OVER w1 AS frequency_50pct,
	PERCENTILE_CONT(recency_days, 0.5) OVER w1 AS recency_50pct
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`customers_proc` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`customers_first_purchase_proc` b
	ON (
		a.client = b.client and
		a.customer_id = b.customer_id
		)
	WINDOW w1 as (PARTITION BY a.client, period, date)
)
2018-04-18 11:50:58,715: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a2ef5c0>]}
2018-04-18 11:50:59,805: 11:50:59 | 75 of 93 OK created table model agency_data_pipeline.segment_proc_customers [CREATE TABLE in 26.46s]
2018-04-18 11:50:59,806: 11:50:59 | 76 of 93 START table model agency_data_pipeline.retention_0_30_rebuy. [RUN]
2018-04-18 11:50:59,808: Compiling model.agency_data_pipeline.retention_0_30_rebuy
2018-04-18 11:50:59,807: 11:50:59 | 77 of 93 START table model agency_data_pipeline.segment_stats_customers_agg [RUN]
2018-04-18 11:50:59,818: Writing injected SQL for node "model.agency_data_pipeline.retention_0_30_rebuy"
2018-04-18 11:50:59,807: 11:50:59 | 78 of 93 START table model agency_data_pipeline.retention_0_365_rebuy [RUN]
2018-04-18 11:50:59,819: Compiling model.agency_data_pipeline.segment_stats_customers_agg
2018-04-18 11:50:59,819: Compiling model.agency_data_pipeline.retention_0_365_rebuy
2018-04-18 11:50:59,825: Writing injected SQL for node "model.agency_data_pipeline.segment_stats_customers_agg"
2018-04-18 11:50:59,832: Writing injected SQL for node "model.agency_data_pipeline.retention_0_365_rebuy"
2018-04-18 11:50:59,833: Acquiring new bigquery connection "retention_0_30_rebuy".
2018-04-18 11:50:59,833: Re-using an available connection from the pool.
2018-04-18 11:50:59,837: Acquiring new bigquery connection "segment_stats_customers_agg".
2018-04-18 11:50:59,838: Acquiring new bigquery connection "retention_0_365_rebuy".
2018-04-18 11:50:59,839: Re-using an available connection from the pool.
2018-04-18 11:50:59,845: Re-using an available connection from the pool.
2018-04-18 11:51:01,230: Model SQL (retention_0_30_rebuy):
SELECT 
r2.client,
r2.date,
r2.customer_id, 
r2.quantity,
r2.revenue
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_30_60` r1 
left join `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30` r2 
  on ( r1.customer_id = r2.customer_id 
  and r1.date = r2.date )
2018-04-18 11:51:01,288: Model SQL (segment_stats_customers_agg):
WITH ty as (

	SELECT
	client,
	date,
	customer_id,
	segment as segment_365,
	recency_days as recency_365,
	frequency as frequency_365,
	revenue as revenue_365,
	aov as aov_365,
	'' as segment_mom,
	0 as recency_mom,
	0 as frequency_mom,
	0 as revenue_mom,
	0 as aov_mom,
	'' as segment_yoy,
	0 as recency_yoy,
	0 as frequency_yoy,
	0 as revenue_yoy,
	0 as aov_yoy
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers`
	WHERE period = 'Rolling 365'

),

last_month as (

	SELECT
	client,
	date,
	customer_id,
	'' as segment_365,
	0 as recency_365,
	0 as frequency_365,
	0 as revenue_365,
	0 as aov_365,
	segment as segment_mom,
	recency_days as recency_mom,
	frequency as frequency_mom,
	revenue as revenue_mom,
	aov as aov_mom,
	'' as segment_yoy,
	0 as recency_yoy,
	0 as frequency_yoy,
	0 as revenue_yoy,
	0 as aov_yoy
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers`
	WHERE period = 'Rolling 365 (t-1mo)'

),

this_month_1yr as (

	SELECT
	client,
	date,
	customer_id,
	'' as segment_365,
	0 as recency_365,
	0 as frequency_365,
	0 as revenue_365,
	0 as aov_365,
	'' as segment_mom,
	0 as recency_mom,
	0 as frequency_mom,
	0 as revenue_mom,
	0 as aov_mom,
	segment as segment_yoy,
	recency_days as recency_yoy,
	frequency as frequency_yoy,
	revenue as revenue_yoy,
	aov as aov_yoy
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers`
	WHERE period = 'Rolling 365 (t-1yr)'


)

SELECT
client,
date, 
customer_id,
ifnull(max(segment_365), '') segment_365,
ifnull(max(segment_mom), '') segment_mom,
ifnull(max(segment_yoy), '') segment_yoy,
ifnull(sum(recency_365), 0) recency_365,
ifnull(sum(frequency_365), 0) frequency_365,
ifnull(sum(revenue_365), 0) revenue_365,
ifnull(sum(aov_365), 0) aov_365,
ifnull(sum(recency_mom), 0) recency_mom,
ifnull(sum(frequency_mom), 0) frequency_mom,
ifnull(sum(revenue_mom), 0) revenue_mom,
ifnull(sum(aov_mom), 0) aov_mom,	
ifnull(sum(recency_yoy), 0) recency_yoy,
ifnull(sum(frequency_yoy), 0) frequency_yoy,
ifnull(sum(revenue_yoy), 0) revenue_yoy,
ifnull(sum(aov_yoy), 0) aov_yoy
FROM
(
	SELECT * FROM ty
	UNION ALL
	SELECT * FROM last_month
	UNION ALL
	SELECT * FROM this_month_1yr

)
GROUP BY client, date, customer_id
2018-04-18 11:51:01,289: Model SQL (retention_0_365_rebuy):
SELECT 
r2.client,
r2.date,
r2.customer_id, 
r2.quantity,
r2.revenue
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_365_730` r1 
left join `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365` r2 
  on ( r1.customer_id = r2.customer_id 
  and r1.date = r2.date )
2018-04-18 11:51:03,487: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fb28eb8>]}
2018-04-18 11:51:03,751: 11:51:03 | 76 of 93 OK created table model agency_data_pipeline.retention_0_30_rebuy [CREATE TABLE in 3.68s]
2018-04-18 11:51:06,911: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a2da438>]}
2018-04-18 11:51:07,366: 11:51:07 | 78 of 93 OK created table model agency_data_pipeline.retention_0_365_rebuy [CREATE TABLE in 7.09s]
2018-04-18 11:51:24,780: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a369be0>]}
2018-04-18 11:51:25,544: 11:51:25 | 77 of 93 OK created table model agency_data_pipeline.segment_stats_customers_agg [CREATE TABLE in 24.96s]
2018-04-18 11:51:25,545: 11:51:25 | 79 of 93 START table model agency_data_pipeline.retention_0_365_new.. [RUN]
2018-04-18 11:51:25,545: Compiling model.agency_data_pipeline.retention_0_365_new
2018-04-18 11:51:25,551: 11:51:25 | 80 of 93 START table model agency_data_pipeline.retention_0_30_new... [RUN]
2018-04-18 11:51:25,551: 11:51:25 | 81 of 93 START table model agency_data_pipeline.segment_stats_customers [RUN]
2018-04-18 11:51:25,551: 11:51:25 | 82 of 93 START table model agency_data_pipeline.retention_0_30_reactivated [RUN]
2018-04-18 11:51:25,551: Compiling model.agency_data_pipeline.retention_0_30_new
2018-04-18 11:51:25,553: Writing injected SQL for node "model.agency_data_pipeline.retention_0_365_new"
2018-04-18 11:51:25,553: Compiling model.agency_data_pipeline.segment_stats_customers
2018-04-18 11:51:25,553: Compiling model.agency_data_pipeline.retention_0_30_reactivated
2018-04-18 11:51:25,559: Writing injected SQL for node "model.agency_data_pipeline.retention_0_30_new"
2018-04-18 11:51:25,564: Writing injected SQL for node "model.agency_data_pipeline.segment_stats_customers"
2018-04-18 11:51:25,570: Writing injected SQL for node "model.agency_data_pipeline.retention_0_30_reactivated"
2018-04-18 11:51:25,572: Acquiring new bigquery connection "retention_0_30_new".
2018-04-18 11:51:25,574: Re-using an available connection from the pool.
2018-04-18 11:51:25,573: Acquiring new bigquery connection "segment_stats_customers".
2018-04-18 11:51:25,573: Acquiring new bigquery connection "retention_0_365_new".
2018-04-18 11:51:25,575: Re-using an available connection from the pool.
2018-04-18 11:51:25,579: Acquiring new bigquery connection "retention_0_30_reactivated".
2018-04-18 11:51:25,580: Re-using an available connection from the pool.
2018-04-18 11:51:25,584: Re-using an available connection from the pool.
2018-04-18 11:51:26,499: Model SQL (retention_0_365_new):
SELECT 
a.client,
a.date,
a.customer_id, 
a.quantity,
a.revenue,
a.order_count
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_730_plus` b
ON (
	a.client = b.client AND
	a.date = b.date AND
	a.customer_id = b.customer_id
)
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_365_730` c
ON (
	a.client = c.client AND
	a.date = c.date AND
	a.customer_id = c.customer_id
)
WHERE b.customer_id is null 
and c.customer_id is null
2018-04-18 11:51:26,516: Model SQL (segment_stats_customers):
SELECT
client,
date,
segment_365,
segment_mom,
segment_yoy,
count(distinct(customer_id)) customers,
avg(recency_365) recency_365,
sum(frequency_365) frequency_365,
sum(revenue_365) revenue_365,
case when sum(frequency_365) > 0 then sum(revenue_365)/sum(frequency_365) else null end as aov_365,
avg(recency_mom) recency_mom,
sum(frequency_mom) frequency_mom,
sum(revenue_mom) revenue_mom,
case when sum(frequency_mom) > 0 then sum(revenue_mom)/sum(frequency_mom) else null end as aov_mom,
avg(recency_yoy) recency_yoy,
sum(frequency_yoy) frequency_yoy,
sum(revenue_yoy) revenue_yoy,
case when sum(frequency_yoy) > 0 then sum(revenue_yoy)/sum(frequency_yoy) else null end as aov_yoy
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_stats_customers_agg`
GROUP BY client, date, segment_365, segment_mom, segment_yoy
2018-04-18 11:51:26,527: Model SQL (retention_0_30_new):
SELECT 
a.client,
a.date,
a.customer_id, 
a.quantity,
a.revenue,
a.order_count
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_60_plus` b
ON (
	a.client = b.client AND
	a.date = b.date AND
	a.customer_id = b.customer_id
)
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_30_60` c
ON (
	a.client = c.client AND
	a.date = c.date AND
	a.customer_id = c.customer_id
)
WHERE b.customer_id is null 
and c.customer_id is null
2018-04-18 11:51:26,560: Model SQL (retention_0_30_reactivated):
SELECT 
a.client,
a.date,
a.customer_id, 
a.quantity,
a.revenue
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_60_plus` b
ON (
	a.client = b.client AND
	a.date = b.date AND
	a.customer_id = b.customer_id
)
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_30_60` c
ON (
	a.client = c.client AND
	a.date = c.date AND
	a.customer_id = c.customer_id
)
WHERE b.customer_id is not null 
AND c.customer_id is null
2018-04-18 11:51:31,181: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a375630>]}
2018-04-18 11:51:31,572: 11:51:31 | 82 of 93 OK created table model agency_data_pipeline.retention_0_30_reactivated [CREATE TABLE in 5.63s]
2018-04-18 11:51:31,573: 11:51:31 | 83 of 93 START table model agency_data_pipeline.retention_0_365_reactivated [RUN]
2018-04-18 11:51:31,573: Compiling model.agency_data_pipeline.retention_0_365_reactivated
2018-04-18 11:51:31,579: Writing injected SQL for node "model.agency_data_pipeline.retention_0_365_reactivated"
2018-04-18 11:51:31,580: Acquiring new bigquery connection "retention_0_365_reactivated".
2018-04-18 11:51:31,580: Re-using an available connection from the pool.
2018-04-18 11:51:32,161: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a337320>]}
2018-04-18 11:51:32,719: Model SQL (retention_0_365_reactivated):
SELECT 
a.client,
a.date,
a.customer_id, 
a.quantity,
a.revenue
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_730_plus` b
ON (
	a.client = b.client AND
	a.date = b.date AND
	a.customer_id = b.customer_id
)
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_365_730` c
ON (
	a.client = c.client AND
	a.date = c.date AND
	a.customer_id = c.customer_id
)
WHERE b.customer_id is not null 
AND c.customer_id is null
2018-04-18 11:51:32,775: 11:51:32 | 80 of 93 OK created table model agency_data_pipeline.retention_0_30_new [CREATE TABLE in 6.61s]
2018-04-18 11:51:32,775: 11:51:32 | 84 of 93 START table model agency_data_pipeline.retention_stats_rebuy_rate [RUN]
2018-04-18 11:51:32,776: Compiling model.agency_data_pipeline.retention_stats_rebuy_rate
2018-04-18 11:51:32,783: Writing injected SQL for node "model.agency_data_pipeline.retention_stats_rebuy_rate"
2018-04-18 11:51:32,784: Acquiring new bigquery connection "retention_stats_rebuy_rate".
2018-04-18 11:51:32,784: Re-using an available connection from the pool.
2018-04-18 11:51:33,786: Model SQL (retention_stats_rebuy_rate):
WITH r1 AS (
	SELECT 
	date,
	client,
	count(distinct customer_id) customers_prior_year,
	0 as customers_current_year, 
	sum(quantity) quantity_prior_year,
	0 as quantity_current_year,
	sum(revenue) revenue_prior_year,
	0 as revenue_current_year,
	case when sum(quantity) > 0 then sum(revenue)/sum(quantity) else null end as aov_prior_year,
	null as aov_current_year
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_365_730`
	group by date, client
),

r2 AS (
	SELECT 
	date,
	client,
	0 as customers_prior_year,
	count(distinct customer_id) customers_current_year, 
	0 as quantity_prior_year,
	sum(quantity) quantity_current_year,
	0 as revenue_prior_year,
	sum(revenue) revenue_current_year,
	null as aov_prior_year,
	case when sum(quantity) > 0 then sum(revenue)/sum(quantity) else null end as aov_current_year
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365_rebuy`
	group by date, client
)

SELECT 
date,
client,
sum(customers_prior_year) customers_prior_year, 
sum(customers_current_year) customers_current_year,
sum(quantity_prior_year) quantity_prior_year,
sum(quantity_current_year) quantity_current_year,
sum(revenue_prior_year) revenue_prior_year,
sum(revenue_current_year) revenue_current_year,
sum(aov_prior_year) aov_prior_year,
sum(aov_current_year) aov_current_year,
case when sum(revenue_prior_year) > 0 then sum(revenue_current_year)/sum(revenue_prior_year) else null end as revenue_retention,
case when sum(customers_prior_year) > 0 then sum(customers_current_year)/sum(customers_prior_year) else null end as customer_retention
FROM
(
	SELECT
	date,
	client,
	customers_prior_year,
	customers_current_year,
	quantity_prior_year,
	quantity_current_year,
	revenue_prior_year,
	revenue_current_year,
	aov_prior_year,
	aov_current_year
	FROM r1

	UNION ALL

	SELECT
	date,
	client,
	customers_prior_year,
	customers_current_year,
	quantity_prior_year,
	quantity_current_year,
	revenue_prior_year,
	revenue_current_year,
	aov_prior_year,
	aov_current_year
	FROM r2

) 
GROUP BY date, client
2018-04-18 11:51:36,140: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a37c550>]}
2018-04-18 11:51:36,415: 11:51:36 | 83 of 93 OK created table model agency_data_pipeline.retention_0_365_reactivated [CREATE TABLE in 4.57s]
2018-04-18 11:51:36,415: 11:51:36 | 85 of 93 START table model agency_data_pipeline.retention_stats_rebuy_rate_month [RUN]
2018-04-18 11:51:36,416: Compiling model.agency_data_pipeline.retention_stats_rebuy_rate_month
2018-04-18 11:51:36,422: Writing injected SQL for node "model.agency_data_pipeline.retention_stats_rebuy_rate_month"
2018-04-18 11:51:36,423: Acquiring new bigquery connection "retention_stats_rebuy_rate_month".
2018-04-18 11:51:36,423: Re-using an available connection from the pool.
2018-04-18 11:51:36,634: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a38dcf8>]}
2018-04-18 11:51:37,064: 11:51:37 | 79 of 93 OK created table model agency_data_pipeline.retention_0_365_new [CREATE TABLE in 11.09s]
2018-04-18 11:51:37,154: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d7cc940>]}
2018-04-18 11:51:37,537: Model SQL (retention_stats_rebuy_rate_month):
WITH r1 AS (
	SELECT 
	date,
	client,
	count(distinct customer_id) customers_prior_year,
	0 as customers_current_year, 
	sum(quantity) quantity_prior_year,
	0 as quantity_current_year,
	sum(revenue) revenue_prior_year,
	0 as revenue_current_year,
	case when sum(quantity) > 0 then sum(revenue)/sum(quantity) else null end as aov_prior_year,
	null as aov_current_year
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_30_60`
	group by date, client
),

r2 AS (
	SELECT 
	date,
	client,
	0 as customers_prior_year,
	count(distinct customer_id) customers_current_year, 
	0 as quantity_prior_year,
	sum(quantity) quantity_current_year,
	0 as revenue_prior_year,
	sum(revenue) revenue_current_year,
	null as aov_prior_year,
	case when sum(quantity) > 0 then sum(revenue)/sum(quantity) else null end as aov_current_year
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30_rebuy`
	group by date, client
)

SELECT 
date,
client,
sum(customers_prior_year) customers_prior_year, 
sum(customers_current_year) customers_current_year,
sum(quantity_prior_year) quantity_prior_year,
sum(quantity_current_year) quantity_current_year,
sum(revenue_prior_year) revenue_prior_year,
sum(revenue_current_year) revenue_current_year,
sum(aov_prior_year) aov_prior_year,
sum(aov_current_year) aov_current_year,
case when sum(revenue_prior_year) > 0 then sum(revenue_current_year)/sum(revenue_prior_year) else null end as revenue_retention,
case when sum(customers_prior_year) > 0 then sum(customers_current_year)/sum(customers_prior_year) else null end as customer_retention
FROM
(
	SELECT
	date,
	client,
	customers_prior_year,
	customers_current_year,
	quantity_prior_year,
	quantity_current_year,
	revenue_prior_year,
	revenue_current_year,
	aov_prior_year,
	aov_current_year
	FROM r1

	UNION ALL

	SELECT
	date,
	client,
	customers_prior_year,
	customers_current_year,
	quantity_prior_year,
	quantity_current_year,
	revenue_prior_year,
	revenue_current_year,
	aov_prior_year,
	aov_current_year
	FROM r2

) 
GROUP BY date, client
2018-04-18 11:51:37,968: 11:51:37 | 84 of 93 OK created table model agency_data_pipeline.retention_stats_rebuy_rate [CREATE TABLE in 4.38s]
2018-04-18 11:51:39,772: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a37ca90>]}
2018-04-18 11:51:40,047: 11:51:40 | 85 of 93 OK created table model agency_data_pipeline.retention_stats_rebuy_rate_month [CREATE TABLE in 3.36s]
2018-04-18 11:51:42,164: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a314f28>]}
2018-04-18 11:51:42,432: 11:51:42 | 81 of 93 OK created table model agency_data_pipeline.segment_stats_customers [CREATE TABLE in 16.61s]
2018-04-18 11:51:42,433: 11:51:42 | 86 of 93 START table model agency_data_pipeline.segment_list_customers [RUN]
2018-04-18 11:51:42,433: Compiling model.agency_data_pipeline.segment_list_customers
2018-04-18 11:51:42,438: Writing injected SQL for node "model.agency_data_pipeline.segment_list_customers"
2018-04-18 11:51:42,439: Acquiring new bigquery connection "segment_list_customers".
2018-04-18 11:51:42,439: Re-using an available connection from the pool.
2018-04-18 11:51:43,478: Model SQL (segment_list_customers):
SELECT
a.client,
period,
date,
customer_id,
b.first_name,
b.last_name,
b.email,
recency_days,
frequency,
revenue,
quantity,
aov,
segment
FROM `growth-engines-pipeline`.`agency_data_pipeline`.`segment_proc_customers` a
LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`agg_customers_union` b
ON (
	a.client = b.client AND
	a.customer_id = b.id
)
2018-04-18 11:52:17,493: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a2d9e80>]}
2018-04-18 11:52:18,304: 11:52:18 | 86 of 93 OK created table model agency_data_pipeline.segment_list_customers [CREATE TABLE in 35.06s]
2018-04-18 11:52:18,308: 11:52:18 | 87 of 93 START table model agency_data_pipeline.growth_customer_0_365_segment [RUN]
2018-04-18 11:52:18,308: Compiling model.agency_data_pipeline.growth_customer_0_365_segment
2018-04-18 11:52:18,324: Writing injected SQL for node "model.agency_data_pipeline.growth_customer_0_365_segment"
2018-04-18 11:52:18,329: Acquiring new bigquery connection "growth_customer_0_365_segment".
2018-04-18 11:52:18,329: Re-using an available connection from the pool.
2018-04-18 11:52:19,665: Model SQL (growth_customer_0_365_segment):
with segment as (

	SELECT 
	a.date,
	unix_date_in_range,
	unix_date_in_range_yoy,
	a.client client,
	a.customer_id customer_id,
	case when b.customer_id is not null then 'New' else 'Existing' end as segment,
	a.orders,
	a.quantity,
	a.revenue,
	a.shipping_revenue
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_customer_0_365` a
	LEFT JOIN `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365_new` b
	ON (
	  a.customer_id = b.customer_id AND
	  a.date  = b.date AND
	  a.client = b.client
	)
),

total as (

	SELECT 
	date,
	unix_date_in_range,
	unix_date_in_range_yoy,
	client,
	customer_id,
	'Total' as segment,
	orders,
	quantity,
	revenue,
	shipping_revenue
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_customer_0_365`

)

SELECT 
date,
unix_date_in_range,
unix_date_in_range_yoy,
client,
segment,
count(distinct(customer_id)) customers,
sum(orders) orders,
sum(quantity) quantity,
sum(revenue) revenue,
sum(shipping_revenue) shipping_revenue
FROM
( 
	SELECT * FROM segment
	UNION ALL
	SELECT * FROM total
) 
GROUP BY date, unix_date_in_range, unix_date_in_range_yoy, client, segment
2018-04-18 11:52:31,882: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a3757b8>]}
2018-04-18 11:52:32,674: 11:52:32 | 87 of 93 OK created table model agency_data_pipeline.growth_customer_0_365_segment [CREATE TABLE in 13.57s]
2018-04-18 11:52:32,675: 11:52:32 | 88 of 93 START table model agency_data_pipeline.growth_date_union.... [RUN]
2018-04-18 11:52:32,676: Compiling model.agency_data_pipeline.growth_date_union
2018-04-18 11:52:32,684: Writing injected SQL for node "model.agency_data_pipeline.growth_date_union"
2018-04-18 11:52:32,685: Acquiring new bigquery connection "growth_date_union".
2018-04-18 11:52:32,685: Re-using an available connection from the pool.
2018-04-18 11:52:34,515: Model SQL (growth_date_union):
with ty as (

  SELECT 
  date,
  unix_date_in_range, 
  unix_date_in_range_yoy, 
  client, 
  segment,
  customers customers_ty,
  orders orders_ty,
  quantity quantity_ty,
  revenue revenue_ty,
  shipping_revenue shipping_revenue_ty,
  null as customers_ly,
  null as orders_ly,
  null as quantity_ly,
  null as revenue_ly,
  null as shipping_revenue_ly
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_customer_0_365_segment`

),

ly as (

  SELECT 
  date,
  0 as unix_date_in_range, 
  unix_date_in_range unix_date_in_range_yoy, 
  client, 
  segment,
  null as customers_ty,
  null as orders_ty,
  null as quantity_ty,
  null as revenue_ty,
  null as shipping_revenue_ty,
  customers customers_ly,
  orders orders_ly,
  quantity quantity_ly,
  revenue revenue_ly,
  shipping_revenue shipping_revenue_ly
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_customer_0_365_segment`

)


SELECT
max(date) date,
max(unix_date_in_range) unix_date_in_range,
unix_date_in_range_yoy,
client,
segment,
ifnull(sum(customers_ty), 0) customers_ty,
ifnull(sum(orders_ty), 0) orders_ty,
ifnull(sum(quantity_ty), 0) quantity_ty,
ifnull(sum(revenue_ty), 0) revenue_ty,
ifnull(sum(shipping_revenue_ty), 0) shipping_revenue_ty,
case when sum(orders_ty) > 0 then sum(revenue_ty)/sum(orders_ty) else null end as aov_ty,
ifnull(sum(customers_ly), 0) customers_ly,
ifnull(sum(orders_ly), 0) orders_ly,
ifnull(sum(quantity_ly), 0) quantity_ly,
ifnull(sum(revenue_ly), 0) revenue_ly,
ifnull(sum(shipping_revenue_ly), 0) shipping_revenue_ly,
case when sum(orders_ly) > 0 then sum(revenue_ly)/sum(orders_ly) else null end as aov_ly,
case when sum(orders_ly) > 0 then ( sum(orders_ty) - sum(orders_ly) ) / sum(orders_ly) else null end as order_growth,
case when sum(revenue_ly) > 0 then ( sum(revenue_ty) - sum(revenue_ly) ) / sum(revenue_ly) else null end as revenue_growth,
case when sum(customers_ly) > 0 then ( sum(customers_ty) - sum(customers_ly) ) / sum(customers_ly) else null end as customer_growth,
case when sum(orders_ly) > 0 then ( sum(revenue_ty)/sum(orders_ty) - sum(revenue_ly)/sum(orders_ly) ) / ( sum(revenue_ly)/sum(orders_ly) ) else null end as aov_growth
FROM (

  SELECT * FROM ty
  UNION ALL
  SELECT * FROM ly

)
where unix_date_in_range is not null
group by unix_date_in_range_yoy, client, segment
2018-04-18 11:52:35,649: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a2d9e80>]}
2018-04-18 11:52:36,354: 11:52:36 | 88 of 93 OK created table model agency_data_pipeline.growth_date_union [CREATE TABLE in 2.97s]
2018-04-18 11:52:36,354: 11:52:36 | 89 of 93 START table model agency_data_pipeline.retention_stats...... [RUN]
2018-04-18 11:52:36,355: 11:52:36 | 90 of 93 START table model agency_data_pipeline.retention_stats_month [RUN]
2018-04-18 11:52:36,355: Compiling model.agency_data_pipeline.retention_stats
2018-04-18 11:52:36,355: 11:52:36 | 91 of 93 START table model agency_data_pipeline.growth_stats......... [RUN]
2018-04-18 11:52:36,368: Compiling model.agency_data_pipeline.growth_stats
2018-04-18 11:52:36,375: Writing injected SQL for node "model.agency_data_pipeline.retention_stats"
2018-04-18 11:52:36,355: Compiling model.agency_data_pipeline.retention_stats_month
2018-04-18 11:52:36,381: Writing injected SQL for node "model.agency_data_pipeline.growth_stats"
2018-04-18 11:52:36,408: Acquiring new bigquery connection "growth_stats".
2018-04-18 11:52:36,408: Re-using an available connection from the pool.
2018-04-18 11:52:36,400: Writing injected SQL for node "model.agency_data_pipeline.retention_stats_month"
2018-04-18 11:52:36,440: Acquiring new bigquery connection "retention_stats".
2018-04-18 11:52:36,440: Re-using an available connection from the pool.
2018-04-18 11:52:36,453: Acquiring new bigquery connection "retention_stats_month".
2018-04-18 11:52:36,455: Re-using an available connection from the pool.
2018-04-18 11:52:37,693: Model SQL (growth_stats):
with orders as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'Orders' as metric,
  orders_ty as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`
),

order_growth as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'Order Growth' as metric,
  order_growth as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`
),

revenue as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'Revenue' as metric,
  revenue_ty as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`
),

revenue_growth as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'Revenue Growth' as metric,
  revenue_growth as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`
),

customers as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'Customers' as metric,
  customers_ty as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`
),

customer_growth as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'Customer Growth' as metric,
  customer_growth as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`

),

aov as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'AOV' as metric,
  aov_ty as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`

),

aov_growth as (

  SELECT
  date,
  unix_date_in_range,
  unix_date_in_range_yoy,
  client,
  segment,
  'AOV Growth' as metric,
  aov_growth as value
  FROM `growth-engines-pipeline`.`agency_data_pipeline`.`growth_date_union`

)

SELECT * FROM orders
UNION ALL 
SELECT * FROM order_growth
UNION ALL
SELECT * FROM revenue
UNION ALL 
SELECT * FROM revenue_growth
UNION ALL
SELECT * FROM customers
UNION ALL 
SELECT * FROM customer_growth
UNION ALL
SELECT * FROM aov
UNION ALL 
SELECT * FROM aov_growth
2018-04-18 11:52:37,863: Model SQL (retention_stats_month):
WITH last_month_buyers AS (
	SELECT 
	date,
	client,
	'Last month buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_30_60`
	group by date, client
),

rebuy_rate AS (
	SELECT 
	date,
	client,
	'Rebuy rate' as metric,
	customer_retention value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_stats_rebuy_rate_month`
),

repeat_buyers AS (
	SELECT 
	date,
	client,
	'Repeat buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30_rebuy`
	group by date, client
),

reactivated_buyers AS (
	SELECT 
	date,
	client,
	'Reactivated buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30_reactivated`
	group by date, client
),

new_buyers AS (
	SELECT 
	date,
	client,
	'New buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30_new`
	group by date, client
),

this_month_buyers AS (
	SELECT 
	date,
	client,
	'This month buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30`
	group by date, client
),

this_month_revenue AS (
	SELECT 
	date,
	client,
	'This month revenue' as metric,
	sum(revenue) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30`
	group by date, client
),

this_month_aov AS (
	SELECT 
	date,
	client,
	'This month AOV' as metric,
	case when sum(order_count) > 0 then sum(revenue)/sum(order_count) else 0 end as value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30`
	group by date, client
),

this_month_frequency AS (
	SELECT 
	date,
	client,
	'This month frequency' as metric,
	case when count(distinct customer_id) > 0 then sum(order_count)/count(distinct customer_id) else 0 end as value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_30`
	group by date, client
)

SELECT 
date,
client,
metric,
ifnull(value, 0) value
FROM
(
	SELECT
	date,
	client,
	metric,
	value
	FROM last_month_buyers

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM rebuy_rate

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM repeat_buyers

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM reactivated_buyers	

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM new_buyers	

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_month_buyers	

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_month_revenue

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_month_aov

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_month_frequency

	UNION ALL

	SELECT
	a.date,
	a.client,
	'Dormant buyers' as metric,
	a.value - ifnull(b.value, 0) as value
	FROM last_month_buyers a
	LEFT JOIN repeat_buyers b
	ON ( a.date = b.date AND
		a.client = b.client )							

)
2018-04-18 11:52:37,958: Model SQL (retention_stats):
WITH last_year_buyers AS (
	SELECT 
	date,
	client,
	'Last year buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_365_730`
	group by date, client
),

rebuy_rate AS (
	SELECT 
	date,
	client,
	'Rebuy rate' as metric,
	customer_retention value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_stats_rebuy_rate`
),

repeat_buyers AS (
	SELECT 
	date,
	client,
	'Repeat buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365_rebuy`
	group by date, client
),

reactivated_buyers AS (
	SELECT 
	date,
	client,
	'Reactivated buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365_reactivated`
	group by date, client
),

new_buyers AS (
	SELECT 
	date,
	client,
	'New buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365_new`
	group by date, client
),

this_year_buyers AS (
	SELECT 
	date,
	client,
	'This year buyers' as metric,
	count(distinct customer_id) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365`
	group by date, client
),

this_year_revenue AS (
	SELECT 
	date,
	client,
	'This year revenue' as metric,
	sum(revenue) value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365`
	group by date, client
),

this_year_aov AS (
	SELECT 
	date,
	client,
	'This year AOV' as metric,
	case when sum(order_count) > 0 then sum(revenue)/sum(order_count) else 0 end as value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365`
	group by date, client
),

this_year_frequency AS (
	SELECT 
	date,
	client,
	'This year frequency' as metric,
	case when count(distinct customer_id) > 0 then sum(order_count)/count(distinct customer_id) else 0 end as value
	FROM `growth-engines-pipeline`.`agency_data_pipeline`.`retention_0_365`
	group by date, client
)

SELECT 
date,
client,
metric,
ifnull(value, 0) value
FROM
(
	SELECT
	date,
	client,
	metric,
	value
	FROM last_year_buyers

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM rebuy_rate

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM repeat_buyers

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM reactivated_buyers	

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM new_buyers	

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_year_buyers	

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_year_revenue

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_year_aov

	UNION ALL

	SELECT
	date,
	client,
	metric,
	value
	FROM this_year_frequency

	UNION ALL

	SELECT
	a.date,
	a.client,
	'Dormant buyers' as metric,
	a.value - ifnull(b.value, 0) as value
	FROM last_year_buyers a
	LEFT JOIN repeat_buyers b
	ON ( a.date = b.date AND
		a.client = b.client )							

)
2018-04-18 11:52:38,870: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10fb454e0>]}
2018-04-18 11:52:39,329: 11:52:39 | 91 of 93 OK created table model agency_data_pipeline.growth_stats.... [CREATE TABLE in 2.50s]
2018-04-18 11:52:40,151: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a2dad68>]}
2018-04-18 11:52:40,631: 11:52:40 | 90 of 93 OK created table model agency_data_pipeline.retention_stats_month [CREATE TABLE in 3.80s]
2018-04-18 11:52:46,526: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b6c08eb1-537b-429f-a4ad-0e49d54edb1f', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d7cc940>]}
2018-04-18 11:52:47,968: 11:52:47 | 89 of 93 OK created table model agency_data_pipeline.retention_stats. [CREATE TABLE in 10.17s]
2018-04-18 11:52:47,969: 11:52:47 | 92 of 93 SKIP relation agency_data_pipeline.agg_campaign............. [SKIP]
2018-04-18 11:52:47,969: 11:52:47 | 93 of 93 SKIP relation agency_data_pipeline.agg_platform_monthly..... [SKIP]
2018-04-18 11:52:48,040: 11:52:48 | 
2018-04-18 11:52:48,041: 11:52:48 | Finished running 93 table models in 497.73s.
2018-04-18 11:52:48,041: Connection 'master' was left open.
2018-04-18 11:52:48,042: 
2018-04-18 11:52:48,042: Completed with 1 errors:
2018-04-18 11:52:48,042: 
2018-04-18 11:52:48,042: Database Error in model agg_ga_campaign_by_type (models/join/agg_ga_campaign_by_type.sql)
2018-04-18 11:52:48,043:   Queries in UNION ALL have mismatched column count; query 1 has 17 columns, query 2 has 19 columns at [75:9]
2018-04-18 11:52:48,043:   compiled SQL at target/compiled/agency_data_pipeline/join/agg_ga_campaign_by_type.sql
2018-04-18 11:52:48,043: 
Done. PASS=90 ERROR=1 SKIP=2 TOTAL=93
2018-04-18 11:52:48,044: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d68d978>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d68dba8>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10d5bfb38>]}
2018-04-18 11:52:48,430: Flushing usage events
